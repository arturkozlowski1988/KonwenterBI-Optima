<ReportsList xmlns="http://schemas.datacontract.org/2004/07/Comarch.Msp.ReportsBook.BusinessLogic" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"><Reports xmlns:a="http://schemas.datacontract.org/2004/07/Comarch.Msp.ReportsBook.BusinessInterface.Entities"><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-29T10:28:04.333</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
	   "Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
       "Kontrahent Opiekun" = CASE &#xD;
								WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	   "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       "Produkt Nazwa" = Twr_Nazwa, "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   25003 [Produkt Kod __PROCID__], Twr_twrId [Produkt Kod __ORGID__],	   &#xD;
	   "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
	   29056 [Magazyn Nazwa __PROCID__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
	   "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
	30392 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ''(PUSTA)'',&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ''(PUSTA)'',&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	"Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	"Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
	"Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Kontrahent Opiekun" = CASE &#xD;
							WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
							WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
							ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	"Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
	"Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	"Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
	"Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
	"Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
	"Produkt Kategoria" = ''(PUSTA)'',&#xD;
	"Produkt Nazwa" = ''Korekta zbiorcza'', "Produkt Kod" = ''Korekta zbiorcza'', &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
	30392 [Produkt Kod __PROCID__], TrN_TrNId [Produkt Kod __ORGID__],	   	&#xD;
	"Produkt Numer Katalogowy" = ''Korekta zbiorcza'', "Produkt Pełna Nazwa Grupy" = ''Korekta zbiorcza'', &#xD;
	"Produkt Kaucja" = ''NIE'', "Jednostka Miary" = ''(BRAK)'', "Magazyn Nazwa" = ''(BRAK)'', &#xD;
	30392 [Magazyn Nazwa __PROCID__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
	"Produkt Producent" = ''(BRAK)'', "Produkt Marka" = ''(BRAK)'',&#xD;
	"Produkt Typ" = ''Korekta zbiorcza'',&#xD;
	"Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' END,&#xD;
	"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
	"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
	"Sprzedaż Wartość" = TrN_RazemNetto, "Sprzedaż Wartość Brutto" = TrN_RazemBrutto, "Sprzedaż Wartość Waluta" = TrN_RazemNettoWal, &#xD;
	"Sprzedaż Ilość" = 0, "Koszt Zakupu" = TrN_WartoscZakupu, "Sprzedaż Marża" = TrN_RazemNetto - TrN_WartoscZakupu &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RAHzthJLfvu07T0UgNHd45wIF/KhvmW1ITcLfChsrjlhVKzbynP8Rvc0Pv1WfvD7mejwrzIohjvauoWjwfwS5N/M22SwnYlnFxSvFmPQah+Wvp9Yx6P/re014WvQrDVaWJRbBWxS3kHSpcGyONC6y/diMyv/LVhSik86rAclvKLJ+ZrdYpaw7m</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS" caption="Dokument Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Bar" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False" rotated="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="Top" zeroValues="False" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="2" spacingHorizontal="2" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Trend Sprzedaży" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="45" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="1" rangeMax="12" zeroLevel="True" margins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="0" rangeMax="492381,56" zeroLevel="True" margins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="265" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Data Operacji Miesiąc"&gt;&lt;header fontName="Tahoma" fontSize="8" width="137" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Data Operacji Miesiąc" index="0" expanded="True" width="137" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje zestawienie sprzedaży w roku obecnym i poprzednim w rozbiciu na miesiące.</a:description><a:id>37</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.01 Trend sprzedaży miesięcznie</a:mainLinkName><a:modifiedOn>2014-05-27T19:06:12.943</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-18T17:43:21.627</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g (&#xD;
    gid&#xD;
    ,gidTyp&#xD;
    ,kod&#xD;
    ,gidNumer&#xD;
    ,grONumer&#xD;
    ,poziom&#xD;
    ,sciezka&#xD;
    )&#xD;
AS (&#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,0 AS poziom&#xD;
        ,convert(NVARCHAR(1024), '') AS sciezka&#xD;
    FROM CDN.TwrGrupy&#xD;
    WHERE TwG_TwGID = 0&#xD;
    &#xD;
    UNION ALL&#xD;
    &#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,p.poziom + 1 AS poziom&#xD;
        ,convert(NVARCHAR(1024), p.sciezka + N'\' + c.TwG_Kod) AS sciezka&#xD;
    FROM g p&#xD;
    JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer&#xD;
    WHERE c.TwG_TwGID &lt;&gt; 0&#xD;
        AND c.TwG_GIDTyp = - 16&#xD;
    )&#xD;
SELECT *&#xD;
INTO #tmpTwrGr&#xD;
FROM g&#xD;
&#xD;
DECLARE @poziom INT&#xD;
DECLARE @poziom_max INT&#xD;
DECLARE @sql NVARCHAR(max)&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom)&#xD;
FROM #tmpTwrGr&#xD;
&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0&#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50), ONr' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50)'&#xD;
&#xD;
    EXEC (@sql)&#xD;
&#xD;
    IF @poziom = @poziom_max&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS NVARCHAR) + '= grONumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS NVARCHAR) + ' = kod'&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
    ELSE&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
DECLARE @select VARCHAR(max)&#xD;
DECLARE @select2 VARCHAR(max)&#xD;
DECLARE @select3 VARCHAR(max)&#xD;
DECLARE @kolumny VARCHAR(max)&#xD;
DECLARE @i INT&#xD;
&#xD;
SET @kolumny = ''&#xD;
SET @i = 0&#xD;
&#xD;
WHILE (@i &lt;= @poziom_max)&#xD;
BEGIN&#xD;
    SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' + LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    SET @i = @i + 1&#xD;
END&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id INT&#xD;
    ,@atrybut_kod NVARCHAR(50)&#xD;
    ,@atrybut_typ INT&#xD;
    ,@atrybut_format INT&#xD;
    ,@atrybuty VARCHAR(max)&#xD;
    ,@sqlA NVARCHAR(max);&#xD;
DECLARE @wersja FLOAT;&#xD;
&#xD;
SET @wersja = (&#xD;
        SELECT CONVERT(FLOAT, SYS_Wartosc)&#xD;
        FROM CDN.SystemCDN&#xD;
        WHERE SYS_ID = 3&#xD;
        )&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId&#xD;
    ,KnA_PodmiotTyp&#xD;
INTO #tmpKonAtr&#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId&#xD;
INTO #tmpDokAtr&#xD;
FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr VARCHAR(max)&#xD;
    ,@atrybutyTwr2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId&#xD;
INTO #tmpTwrAtr&#xD;
FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz VARCHAR(max)&#xD;
    ,@atrybutyPoz2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId&#xD;
INTO #tmpPozAtr&#xD;
FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID&#xD;
    ,CASE &#xD;
        WHEN DDf_Numeracja LIKE '@rejestr%'&#xD;
            THEN 5&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 1) = '@rejestr'&#xD;
            THEN 1&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 2) = '@rejestr'&#xD;
            THEN 2&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 3) = '@rejestr'&#xD;
            THEN 3&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 4) = '@rejestr'&#xD;
            THEN 4&#xD;
        END [seria]&#xD;
INTO #tmpSeria&#xD;
FROM CDN.DokDefinicje&#xD;
&#xD;
SELECT *  INTO #tmpKosztyGraniczne FROM (&#xD;
SELECT SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TNFS.TrN_TrNID TransId&#xD;
FROM cdn.tranag TNKG&#xD;
JOIN cdn.traelem TEKG ON TEKG.tre_trnid = TNKG.TrN_TrNID&#xD;
JOIN cdn.Tranag TNFZ ON TNFZ.Trn_trnid = TNKG.TrN_ZwrId&#xD;
JOIN cdn.TranagRelacje ON TNFZ.Trn_trnid = TrR_TrNId&#xD;
    AND TrR_FaTyp IN (&#xD;
        302&#xD;
        ,305&#xD;
        )&#xD;
JOIN cdn.Tranag TNFS ON TNFS.TrN_TrNID = TrR_FaId&#xD;
JOIN cdn.TraElem TEFS ON TNFS.trn_trnid = TEFS.TrE_TrNId&#xD;
    AND TEKG.TrE_Lp = TEFS.TrE_LpPow&#xD;
WHERE TNKG.trn_rodzaj IN (&#xD;
        301008&#xD;
        ,301009&#xD;
        ,301018&#xD;
        )&#xD;
GROUP BY TEFS.TrE_TrEID&#xD;
    ,TNFS.TrN_TrNID&#xD;
&#xD;
	UNION ALL&#xD;
	&#xD;
	 SELECT  SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TEFS.TrE_TrNId TransId&#xD;
    FROM CDN.TraElem TEFS&#xD;
    JOIN CDN.tranagrelacje tr on tr.TrR_TrNID = TEFS.TrE_TrNID&#xD;
    JOIN CDN.traelem TEWZ on tr.TrR_FaId = TEWZ.TrE_TrNID AND TEFS.TrE_Lppow = TEWZ.TrE_LpPow&#xD;
    JOIN CDN.TraSElemDost TraSElemDost on TEWZ.TrE_TrEID = TsD_TrEID&#xD;
	JOIN  CDN.TraSElem ON TsD_TrSIdDost = trs_trsid&#xD;
	JOIN CDN.TraElem TEPZ on TrS_TrEId = TEPZ.TrE_TrEID&#xD;
	JOIN CDN.TraNag  TNPZ on TEPZ.TrE_TrNId = TrN_TrNID&#xD;
	JOIN CDN.TraNagRelacje TRFZ ON TRFZ.TrR_TrNId = TNPZ.TRN_TRNID &#xD;
	JOIN CDN.TraNag  TNFZ ON TNFZ.TrN_TrNID = TRFZ.TrR_FaId&#xD;
	JOIN CDN.TraNag  TNKG ON TNFZ.TrN_TrNID = TNKG.TrN_ZwrId AND TNKG.TrN_Rodzaj = 301009 -- Korekty Graniczne&#xD;
	join CDN.TraElem TEKG ON TEKG.TrE_TrNId = TNKG.TrN_TrNID AND TEKG.TrE_Lp = TEPZ.TrE_LpPow&#xD;
	GROUP BY TEFS.TrE_TrNId,TEFS.TrE_TrEID&#xD;
&#xD;
	)X&#xD;
&#xD;
&#xD;
--Tworzenie tabelki pomocniczej do liczenia marży&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @select = &#xD;
    'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    Tre_Lp [Produkt Lp.],&#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/ISNULL(NULLIF([TrE_JMPrzelicznikL],0),1)*[TrE_JMPrzelicznikM])) * TrE_KursL / ISNULL(NULLIF(TrE_KursM,0),1) [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
	&#xD;
    ,CAST(TR.TrE_Ilosc/ ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS DECIMAL(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) [Waluta Koszt Zakupu]&#xD;
    ,ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1),TR.TrE_KosztUslugi)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],''' + &#xD;
    @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
SET @select2 = &#xD;
    ' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND trn.TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + &#xD;
    ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
						   	,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN #tmpKosztyGraniczne ON ElemId = TR.Tre_Treid&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy],&#xD;
    NULL [Produkt Lp.],&#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,NULL [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,KosztWyliczony.TRE_Waluta [Waluta Koszt Zakupu]&#xD;
    ,(CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0)) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + &#xD;
    ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
SET @select3 = &#xD;
    ' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     lEFT JOIN (SELECT  sum(KosztyGraniczne) AS KosztyGraniczne, TransID FROM #tmpKosztyGraniczne GROUP BY TransId)KosztyGran ON Trn_Trnid = TransID &#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
&#xD;
'&#xD;
&#xD;
PRINT (@select + @select2 + @select3)&#xD;
&#xD;
EXEC (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
DROP TABLE #tmpKonAtr&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
DROP TABLE #tmpSeria&#xD;
&#xD;
DROP TABLE #tmppozatr&#xD;
&#xD;
DROP TABLE #tmpKosztyGraniczne&#xD;
&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RAHzthJLfvu07T0UgNHd45wIF/KhvmW1ITcLfChsrjlhVKzbynP8Rvc0Pv1WfvD7mejwrzIohjvauoWjwfwS5N/M22SwnYlnFxSvFmPQah+Wvp9Yx6P/re014WvQrDVaWJRbBWxS3kHSpcGyONC6y/diMyv/LVhSik86rAclvKLJ+ZrdYpaw7m</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Waluta Koszt Zakupu" caption="Waluta Koszt Zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Waluta" caption="Koszt Zakupu Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Dzień" caption="Data Analizy Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Tydzień Roku" caption="Data Analizy Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Miesiąc" caption="Data Analizy Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Kwartał" caption="Data Analizy Kwartał" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Rok" caption="Data Analizy Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut TEST" caption="Kontrahent Pierwotny Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut TEST" caption="Kontrahent Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut TEST" caption="Odbiorca Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOLOR" caption="Dokument Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut CENA ATRYB" caption="Dokument Atrybut CENA ATRYB" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROWIZJA" caption="Dokument Atrybut PROWIZJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut MONTER KOSZT (K)" caption="Dokument Atrybut MONTER KOSZT (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut CENA2" caption="Produkt Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TESTZAS" caption="Produkt Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DIETA" caption="Produkt Atrybut DIETA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut CENA2" caption="Pozycja Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut TESTZAS" caption="Pozycja Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Bar" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False" rotated="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="Top" zeroValues="False" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="0" spacingHorizontal="0" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Trend Sprzedaży" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="[Data Operacji Kwartał].[1]" rangeMax="[Data Operacji Kwartał].[4]" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="0" rangeMax="621024,481" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="221" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Data Operacji Kwartał"&gt;&lt;header fontName="Tahoma" fontSize="8" width="140" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="90" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Data Operacji Kwartał" index="0" expanded="True" width="140" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" width="90" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje zestawienie sprzedaży w roku obecnym i poprzednim w rozbiciu na kwartały.</a:description><a:id>38</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.02 Trend sprzedaży kwartalnie</a:mainLinkName><a:modifiedOn>2025-05-30T15:47:02.887</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-04T09:54:07.737</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g (&#xD;
    gid&#xD;
    ,gidTyp&#xD;
    ,kod&#xD;
    ,gidNumer&#xD;
    ,grONumer&#xD;
    ,poziom&#xD;
    ,sciezka&#xD;
    )&#xD;
AS (&#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,0 AS poziom&#xD;
        ,convert(NVARCHAR(1024), '') AS sciezka&#xD;
    FROM CDN.TwrGrupy&#xD;
    WHERE TwG_TwGID = 0&#xD;
    &#xD;
    UNION ALL&#xD;
    &#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,p.poziom + 1 AS poziom&#xD;
        ,convert(NVARCHAR(1024), p.sciezka + N'\' + c.TwG_Kod) AS sciezka&#xD;
    FROM g p&#xD;
    JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer&#xD;
    WHERE c.TwG_TwGID &lt;&gt; 0&#xD;
        AND c.TwG_GIDTyp = - 16&#xD;
    )&#xD;
SELECT *&#xD;
INTO #tmpTwrGr&#xD;
FROM g&#xD;
&#xD;
DECLARE @poziom INT&#xD;
DECLARE @poziom_max INT&#xD;
DECLARE @sql NVARCHAR(max)&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom)&#xD;
FROM #tmpTwrGr&#xD;
&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0&#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50), ONr' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50)'&#xD;
&#xD;
    EXEC (@sql)&#xD;
&#xD;
    IF @poziom = @poziom_max&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS NVARCHAR) + '= grONumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS NVARCHAR) + ' = kod'&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
    ELSE&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
DECLARE @select VARCHAR(max)&#xD;
DECLARE @select2 VARCHAR(max)&#xD;
DECLARE @select3 VARCHAR(max)&#xD;
DECLARE @kolumny VARCHAR(max)&#xD;
DECLARE @i INT&#xD;
&#xD;
SET @kolumny = ''&#xD;
SET @i = 0&#xD;
&#xD;
WHILE (@i &lt;= @poziom_max)&#xD;
BEGIN&#xD;
    SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' + LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    SET @i = @i + 1&#xD;
END&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id INT&#xD;
    ,@atrybut_kod NVARCHAR(50)&#xD;
    ,@atrybut_typ INT&#xD;
    ,@atrybut_format INT&#xD;
    ,@atrybuty VARCHAR(max)&#xD;
    ,@sqlA NVARCHAR(max);&#xD;
DECLARE @wersja FLOAT;&#xD;
&#xD;
SET @wersja = (&#xD;
        SELECT CONVERT(FLOAT, SYS_Wartosc)&#xD;
        FROM CDN.SystemCDN&#xD;
        WHERE SYS_ID = 3&#xD;
        )&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId&#xD;
    ,KnA_PodmiotTyp&#xD;
INTO #tmpKonAtr&#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId&#xD;
INTO #tmpDokAtr&#xD;
FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr VARCHAR(max)&#xD;
    ,@atrybutyTwr2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId&#xD;
INTO #tmpTwrAtr&#xD;
FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz VARCHAR(max)&#xD;
    ,@atrybutyPoz2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId&#xD;
INTO #tmpPozAtr&#xD;
FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID&#xD;
    ,CASE &#xD;
        WHEN DDf_Numeracja LIKE '@rejestr%'&#xD;
            THEN 5&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 1) = '@rejestr'&#xD;
            THEN 1&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 2) = '@rejestr'&#xD;
            THEN 2&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 3) = '@rejestr'&#xD;
            THEN 3&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 4) = '@rejestr'&#xD;
            THEN 4&#xD;
        END [seria]&#xD;
INTO #tmpSeria&#xD;
FROM CDN.DokDefinicje&#xD;
&#xD;
SELECT *  INTO #tmpKosztyGraniczne FROM (&#xD;
SELECT SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TNFS.TrN_TrNID TransId&#xD;
FROM cdn.tranag TNKG&#xD;
JOIN cdn.traelem TEKG ON TEKG.tre_trnid = TNKG.TrN_TrNID&#xD;
JOIN cdn.Tranag TNFZ ON TNFZ.Trn_trnid = TNKG.TrN_ZwrId&#xD;
JOIN cdn.TranagRelacje ON TNFZ.Trn_trnid = TrR_TrNId&#xD;
    AND TrR_FaTyp IN (&#xD;
        302&#xD;
        ,305&#xD;
        )&#xD;
JOIN cdn.Tranag TNFS ON TNFS.TrN_TrNID = TrR_FaId&#xD;
JOIN cdn.TraElem TEFS ON TNFS.trn_trnid = TEFS.TrE_TrNId&#xD;
    AND TEKG.TrE_Lp = TEFS.TrE_LpPow&#xD;
WHERE TNKG.trn_rodzaj IN (&#xD;
        301008&#xD;
        ,301009&#xD;
        ,301018&#xD;
        )&#xD;
GROUP BY TEFS.TrE_TrEID&#xD;
    ,TNFS.TrN_TrNID&#xD;
&#xD;
	UNION ALL&#xD;
	&#xD;
	 SELECT  SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TEFS.TrE_TrNId TransId&#xD;
    FROM CDN.TraElem TEFS&#xD;
    JOIN CDN.tranagrelacje tr on tr.TrR_TrNID = TEFS.TrE_TrNID&#xD;
    JOIN CDN.traelem TEWZ on tr.TrR_FaId = TEWZ.TrE_TrNID AND TEFS.TrE_Lppow = TEWZ.TrE_LpPow&#xD;
    JOIN CDN.TraSElemDost TraSElemDost on TEWZ.TrE_TrEID = TsD_TrEID&#xD;
	JOIN  CDN.TraSElem ON TsD_TrSIdDost = trs_trsid&#xD;
	JOIN CDN.TraElem TEPZ on TrS_TrEId = TEPZ.TrE_TrEID&#xD;
	JOIN CDN.TraNag  TNPZ on TEPZ.TrE_TrNId = TrN_TrNID&#xD;
	JOIN CDN.TraNagRelacje TRFZ ON TRFZ.TrR_TrNId = TNPZ.TRN_TRNID &#xD;
	JOIN CDN.TraNag  TNFZ ON TNFZ.TrN_TrNID = TRFZ.TrR_FaId&#xD;
	JOIN CDN.TraNag  TNKG ON TNFZ.TrN_TrNID = TNKG.TrN_ZwrId AND TNKG.TrN_Rodzaj = 301009 -- Korekty Graniczne&#xD;
	join CDN.TraElem TEKG ON TEKG.TrE_TrNId = TNKG.TrN_TrNID AND TEKG.TrE_Lp = TEPZ.TrE_LpPow&#xD;
	GROUP BY TEFS.TrE_TrNId,TEFS.TrE_TrEID&#xD;
&#xD;
	)X&#xD;
&#xD;
&#xD;
--Tworzenie tabelki pomocniczej do liczenia marży&#xD;
SELECT TRE.TrE_TrEId treid, TRERel.TrE_TreId trerelid, TRERel.TrE_TypDokumentu trereltyp INTO #tmpMarza&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       LEFT JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId&#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @select = &#xD;
    'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    Tre_Lp [Produkt Lp.],&#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/ISNULL(NULLIF([TrE_JMPrzelicznikL],0),1)*[TrE_JMPrzelicznikM])) * TrE_KursL / ISNULL(NULLIF(TrE_KursM,0),1) [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
	&#xD;
    ,CAST(TR.TrE_Ilosc/ ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS DECIMAL(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) [Waluta Koszt Zakupu]&#xD;
    ,ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1),TR.TrE_KosztUslugi)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],''' + &#xD;
    @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
SET @select2 = &#xD;
    ' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND trn.TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + &#xD;
    ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
   LEFT OUTER JOIN (&#xD;
    SELECT ISNULL(SUM(CASE &#xD;
                    WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
        ,TRE.TrE_TrEID&#xD;
        ,TREWAL.TRE_Waluta&#xD;
        ,TREWAL.TrE_KursL KursZakL&#xD;
        ,TREWAL.Tre_KursM KursZakM&#xD;
    FROM CDN.TraElem TRE&#xD;
    JOIN (&#xD;
        SELECT TrE_TrEId AS IdElem&#xD;
            ,TrE_TrEId AS IdZwiaz&#xD;
        FROM CDN.TraElem&#xD;
        &#xD;
        UNION ALL&#xD;
        &#xD;
        SELECT treid, trerelid &#xD;
		FROM #tmpMarza&#xD;
        WHERE trereltyp NOT IN (&#xD;
                318&#xD;
                ,309&#xD;
                ,308&#xD;
                ,301&#xD;
                )&#xD;
				AND  trerelid is not null&#xD;
        ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
    JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
    JOIN CDN.TraElem TREWAL ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
    GROUP BY TRE.TrE_TrEID,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    ) KosztWyliczony ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN #tmpKosztyGraniczne ON ElemId = TR.Tre_Treid&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy],&#xD;
    NULL [Produkt Lp.],&#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], TrN_WartoscZakupu [Koszt Zakupu], TrN_RazemNetto - TrN_WartoscZakupu [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,NULL [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,KosztWyliczony.TRE_Waluta [Waluta Koszt Zakupu]&#xD;
    ,(CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0)) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + &#xD;
    ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
SET @select3 = &#xD;
    ' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     lEFT JOIN (SELECT  sum(KosztyGraniczne) AS KosztyGraniczne, TransID FROM #tmpKosztyGraniczne GROUP BY TransId)KosztyGran ON Trn_Trnid = TransID &#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
	  LEFT OUTER JOIN (&#xD;
    SELECT ISNULL(SUM(CASE &#xD;
                    WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
        ,TRE.TrE_TrNId&#xD;
        ,TREWAL.TRE_Waluta&#xD;
        ,TREWAL.TrE_KursL KursZakL&#xD;
        ,TREWAL.Tre_KursM KursZakM&#xD;
    FROM CDN.TraElem TRE&#xD;
    JOIN (&#xD;
        SELECT TrE_TrEId AS IdElem&#xD;
            ,TrE_TrEId AS IdZwiaz&#xD;
        FROM CDN.TraElem&#xD;
        &#xD;
        UNION ALL&#xD;
           &#xD;
        SELECT treid, trerelid &#xD;
		FROM #tmpMarza&#xD;
        WHERE trereltyp NOT IN (&#xD;
                318&#xD;
                ,309&#xD;
                ,308&#xD;
                ,301&#xD;
                )&#xD;
				AND  trerelid is not null&#xD;
        ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
    JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
    JOIN CDN.TraElem TREWAL ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
    GROUP BY TRE.TrE_TrNId,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
   ) KosztWyliczony ON KosztWyliczony.TrE_TrNId = Trn_trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
&#xD;
'&#xD;
&#xD;
PRINT (@select + @select2 + @select3)&#xD;
&#xD;
EXEC (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
DROP TABLE #tmpKonAtr&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
DROP TABLE #tmpSeria&#xD;
&#xD;
DROP TABLE #tmppozatr&#xD;
&#xD;
DROP TABLE #tmpKosztyGraniczne&#xD;
&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8sJ7a+Ib5ljeiB+o1CVa8K09VmwT3LHj3ChZA6BezNBwrS1BzJzaTn10QuwI3PMujIBT6U16yWR6Gt6rBj6xMh0cN/xE38i+czy1N+qeZhEJwbJdTVWZo7RtrWNzjM6tZzQ9zLMJBf27+HoUEnugUTGHfv8cmn1LqYI8l10yxoVu/5+89jLa2Ai</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Data" caption="Czas Aktualny Data" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Waluta Koszt Zakupu" caption="Waluta Koszt Zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Waluta" caption="Koszt Zakupu Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut EMAIL" caption="Kontrahent Pierwotny Atrybut EMAIL" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut EMAIL" caption="Kontrahent Atrybut EMAIL" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut EMAIL" caption="Odbiorca Atrybut EMAIL" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut NUMER SERYJNY" caption="Dokument Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut EMAIL (K)" caption="Dokument Atrybut EMAIL (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut WAGA" caption="Produkt Atrybut WAGA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NUMER SERYJNY" caption="Pozycja Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="False" type="Bar" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False" rotated="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="Top" zeroValues="False" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="2" spacingHorizontal="2" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="1.14 Trend sprzedaży miesięcznie w podziale na produkty" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="45" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="TUJE_3L" rangeMax="ROZDRABNIACZ" zeroLevel="True" margins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="0" rangeMax="77592,273" zeroLevel="True" margins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAKAAAABwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCH1tQcm9kdWt0IEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0HAhdbUHJvZHVrdCBLb2RdLltUVUpFXzNMXQcCGltQcm9kdWt0IEtvZF0uW0dSQUJJRV9PR1JdBwIXW1Byb2R1a3QgS29kXS5bU1pQQURFTF0HAhhbUHJvZHVrdCBLb2RdLltLT1JBX1M4MF0HAhxbUHJvZHVrdCBLb2RdLltST1pEUkFCTklBQ1pdBwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIcW1Byb2R1a3QgS29kXS5bUEnFgUFfRUxFS1RSXQcCF1tQcm9kdWt0IEtvZF0uW1NFS0FUT1Jd/////wAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;whatifMeasures&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" formula="( Sprzedaż Wartość= 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Sprzedaż Wartość)" description="" summaryType="Sum" /&gt;&#xD;
  &lt;/whatifMeasures&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions&gt;&#xD;
    &lt;format ref="Produkt Kod"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="130" top="10" topType="TopAbsolute" dataField="Sprzedaż Wartość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Sprzedaż Wartość"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Data Operacji Miesiąc"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="137" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Data Operacji Rok"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Grupa Poziom 0"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Grupa Poziom 1"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
  &lt;/formatOptions&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields&gt;&#xD;
    &lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
  &lt;/dataFields&gt;&#xD;
  &lt;rowFields&gt;&#xD;
    &lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="displayText" order="descending" width="130" top="10" topType="TopAbsolute" dataField="Sprzedaż Wartość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy dataFieldName="Sprzedaż Wartość" /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
    &lt;row fieldName="Data Operacji Miesiąc" index="1" expanded="True" sortMode="default" order="ascending" width="137" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
  &lt;/rowFields&gt;&#xD;
  &lt;columnFields&gt;&#xD;
    &lt;column fieldName="Data Operacji Rok" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/column&gt;&#xD;
  &lt;/columnFields&gt;&#xD;
  &lt;filterFields&gt;&#xD;
    &lt;filter fieldName="Produkt Grupa Poziom 0" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
    &lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
  &lt;/filterFields&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje zestawienie sprzedaży w roku obecnym i poprzednim w rozbiciu na miesiące dla 10 produktów z największą sprzedażą.</a:description><a:id>39</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.03 Trend sprzedaży miesięcznie w podziale na produkty</a:mainLinkName><a:modifiedOn>2025-04-14T10:02:50.887</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-29T10:52:43.107</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g (&#xD;
    gid&#xD;
    ,gidTyp&#xD;
    ,kod&#xD;
    ,gidNumer&#xD;
    ,grONumer&#xD;
    ,poziom&#xD;
    ,sciezka&#xD;
    )&#xD;
AS (&#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,0 AS poziom&#xD;
        ,convert(NVARCHAR(1024), '') AS sciezka&#xD;
    FROM CDN.TwrGrupy&#xD;
    WHERE TwG_TwGID = 0&#xD;
    &#xD;
    UNION ALL&#xD;
    &#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,p.poziom + 1 AS poziom&#xD;
        ,convert(NVARCHAR(1024), p.sciezka + N'\' + c.TwG_Kod) AS sciezka&#xD;
    FROM g p&#xD;
    JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer&#xD;
    WHERE c.TwG_TwGID &lt;&gt; 0&#xD;
        AND c.TwG_GIDTyp = - 16&#xD;
    )&#xD;
SELECT *&#xD;
INTO #tmpTwrGr&#xD;
FROM g&#xD;
&#xD;
DECLARE @poziom INT&#xD;
DECLARE @poziom_max INT&#xD;
DECLARE @sql NVARCHAR(max)&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom)&#xD;
FROM #tmpTwrGr&#xD;
&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0&#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50), ONr' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50)'&#xD;
&#xD;
    EXEC (@sql)&#xD;
&#xD;
    IF @poziom = @poziom_max&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS NVARCHAR) + '= grONumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS NVARCHAR) + ' = kod'&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
    ELSE&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
DECLARE @select VARCHAR(max)&#xD;
DECLARE @select2 VARCHAR(max)&#xD;
DECLARE @select3 VARCHAR(max)&#xD;
DECLARE @kolumny VARCHAR(max)&#xD;
DECLARE @i INT&#xD;
&#xD;
SET @kolumny = ''&#xD;
SET @i = 0&#xD;
&#xD;
WHILE (@i &lt;= @poziom_max)&#xD;
BEGIN&#xD;
    SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' + LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    SET @i = @i + 1&#xD;
END&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id INT&#xD;
    ,@atrybut_kod NVARCHAR(50)&#xD;
    ,@atrybut_typ INT&#xD;
    ,@atrybut_format INT&#xD;
    ,@atrybuty VARCHAR(max)&#xD;
    ,@sqlA NVARCHAR(max);&#xD;
DECLARE @wersja FLOAT;&#xD;
&#xD;
SET @wersja = (&#xD;
        SELECT CONVERT(FLOAT, SYS_Wartosc)&#xD;
        FROM CDN.SystemCDN&#xD;
        WHERE SYS_ID = 3&#xD;
        )&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId&#xD;
    ,KnA_PodmiotTyp&#xD;
INTO #tmpKonAtr&#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId&#xD;
INTO #tmpDokAtr&#xD;
FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr VARCHAR(max)&#xD;
    ,@atrybutyTwr2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId&#xD;
INTO #tmpTwrAtr&#xD;
FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz VARCHAR(max)&#xD;
    ,@atrybutyPoz2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId&#xD;
INTO #tmpPozAtr&#xD;
FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID&#xD;
    ,CASE &#xD;
        WHEN DDf_Numeracja LIKE '@rejestr%'&#xD;
            THEN 5&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 1) = '@rejestr'&#xD;
            THEN 1&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 2) = '@rejestr'&#xD;
            THEN 2&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 3) = '@rejestr'&#xD;
            THEN 3&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 4) = '@rejestr'&#xD;
            THEN 4&#xD;
        END [seria]&#xD;
INTO #tmpSeria&#xD;
FROM CDN.DokDefinicje&#xD;
&#xD;
SELECT *  INTO #tmpKosztyGraniczne FROM (&#xD;
SELECT SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TNFS.TrN_TrNID TransId&#xD;
FROM cdn.tranag TNKG&#xD;
JOIN cdn.traelem TEKG ON TEKG.tre_trnid = TNKG.TrN_TrNID&#xD;
JOIN cdn.Tranag TNFZ ON TNFZ.Trn_trnid = TNKG.TrN_ZwrId&#xD;
JOIN cdn.TranagRelacje ON TNFZ.Trn_trnid = TrR_TrNId&#xD;
    AND TrR_FaTyp IN (&#xD;
        302&#xD;
        ,305&#xD;
        )&#xD;
JOIN cdn.Tranag TNFS ON TNFS.TrN_TrNID = TrR_FaId&#xD;
JOIN cdn.TraElem TEFS ON TNFS.trn_trnid = TEFS.TrE_TrNId&#xD;
    AND TEKG.TrE_Lp = TEFS.TrE_LpPow&#xD;
WHERE TNKG.trn_rodzaj IN (&#xD;
        301008&#xD;
        ,301009&#xD;
        ,301018&#xD;
        )&#xD;
GROUP BY TEFS.TrE_TrEID&#xD;
    ,TNFS.TrN_TrNID&#xD;
&#xD;
	UNION ALL&#xD;
	&#xD;
	 SELECT  SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TEFS.TrE_TrNId TransId&#xD;
    FROM CDN.TraElem TEFS&#xD;
    JOIN CDN.tranagrelacje tr on tr.TrR_TrNID = TEFS.TrE_TrNID&#xD;
    JOIN CDN.traelem TEWZ on tr.TrR_FaId = TEWZ.TrE_TrNID AND TEFS.TrE_Lppow = TEWZ.TrE_LpPow&#xD;
    JOIN CDN.TraSElemDost TraSElemDost on TEWZ.TrE_TrEID = TsD_TrEID&#xD;
	JOIN  CDN.TraSElem ON TsD_TrSIdDost = trs_trsid&#xD;
	JOIN CDN.TraElem TEPZ on TrS_TrEId = TEPZ.TrE_TrEID&#xD;
	JOIN CDN.TraNag  TNPZ on TEPZ.TrE_TrNId = TrN_TrNID&#xD;
	JOIN CDN.TraNagRelacje TRFZ ON TRFZ.TrR_TrNId = TNPZ.TRN_TRNID &#xD;
	JOIN CDN.TraNag  TNFZ ON TNFZ.TrN_TrNID = TRFZ.TrR_FaId&#xD;
	JOIN CDN.TraNag  TNKG ON TNFZ.TrN_TrNID = TNKG.TrN_ZwrId AND TNKG.TrN_Rodzaj = 301009 -- Korekty Graniczne&#xD;
	join CDN.TraElem TEKG ON TEKG.TrE_TrNId = TNKG.TrN_TrNID AND TEKG.TrE_Lp = TEPZ.TrE_LpPow&#xD;
	GROUP BY TEFS.TrE_TrNId,TEFS.TrE_TrEID&#xD;
&#xD;
	)X&#xD;
&#xD;
&#xD;
--Tworzenie tabelki pomocniczej do liczenia marży&#xD;
SELECT TRE.TrE_TrEId treid, TRERel.TrE_TreId trerelid, TRERel.TrE_TypDokumentu trereltyp INTO #tmpMarza&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       LEFT JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId&#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @select = &#xD;
    'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    Tre_Lp [Produkt Lp.],&#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/ISNULL(NULLIF([TrE_JMPrzelicznikL],0),1)*[TrE_JMPrzelicznikM])) * TrE_KursL / ISNULL(NULLIF(TrE_KursM,0),1) [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
	&#xD;
    ,CAST(TR.TrE_Ilosc/ ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS DECIMAL(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) [Waluta Koszt Zakupu]&#xD;
    ,ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1),TR.TrE_KosztUslugi)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],''' + &#xD;
    @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
SET @select2 = &#xD;
    ' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND trn.TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + &#xD;
    ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
   LEFT OUTER JOIN (&#xD;
    SELECT ISNULL(SUM(CASE &#xD;
                    WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
        ,TRE.TrE_TrEID&#xD;
        ,TREWAL.TRE_Waluta&#xD;
        ,TREWAL.TrE_KursL KursZakL&#xD;
        ,TREWAL.Tre_KursM KursZakM&#xD;
    FROM CDN.TraElem TRE&#xD;
    JOIN (&#xD;
        SELECT TrE_TrEId AS IdElem&#xD;
            ,TrE_TrEId AS IdZwiaz&#xD;
        FROM CDN.TraElem&#xD;
        &#xD;
        UNION ALL&#xD;
        &#xD;
        SELECT treid, trerelid &#xD;
		FROM #tmpMarza&#xD;
        WHERE trereltyp NOT IN (&#xD;
                318&#xD;
                ,309&#xD;
                ,308&#xD;
                ,301&#xD;
                )&#xD;
				AND  trerelid is not null&#xD;
        ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
    JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
    JOIN CDN.TraElem TREWAL ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
    GROUP BY TRE.TrE_TrEID,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    ) KosztWyliczony ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN #tmpKosztyGraniczne ON ElemId = TR.Tre_Treid&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy],&#xD;
    NULL [Produkt Lp.],&#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], TrN_WartoscZakupu [Koszt Zakupu], TrN_RazemNetto - TrN_WartoscZakupu [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,NULL [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,KosztWyliczony.TRE_Waluta [Waluta Koszt Zakupu]&#xD;
    ,(CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0)) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + &#xD;
    ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
SET @select3 = &#xD;
    ' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     lEFT JOIN (SELECT  sum(KosztyGraniczne) AS KosztyGraniczne, TransID FROM #tmpKosztyGraniczne GROUP BY TransId)KosztyGran ON Trn_Trnid = TransID &#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
	  LEFT OUTER JOIN (&#xD;
    SELECT ISNULL(SUM(CASE &#xD;
                    WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
        ,TRE.TrE_TrNId&#xD;
        ,TREWAL.TRE_Waluta&#xD;
        ,TREWAL.TrE_KursL KursZakL&#xD;
        ,TREWAL.Tre_KursM KursZakM&#xD;
    FROM CDN.TraElem TRE&#xD;
    JOIN (&#xD;
        SELECT TrE_TrEId AS IdElem&#xD;
            ,TrE_TrEId AS IdZwiaz&#xD;
        FROM CDN.TraElem&#xD;
        &#xD;
        UNION ALL&#xD;
           &#xD;
        SELECT treid, trerelid &#xD;
		FROM #tmpMarza&#xD;
        WHERE trereltyp NOT IN (&#xD;
                318&#xD;
                ,309&#xD;
                ,308&#xD;
                ,301&#xD;
                )&#xD;
				AND  trerelid is not null&#xD;
        ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
    JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
    JOIN CDN.TraElem TREWAL ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
    GROUP BY TRE.TrE_TrNId,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
   ) KosztWyliczony ON KosztWyliczony.TrE_TrNId = Trn_trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
&#xD;
'&#xD;
&#xD;
PRINT (@select + @select2 + @select3)&#xD;
&#xD;
EXEC (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
DROP TABLE #tmpKonAtr&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
DROP TABLE #tmpSeria&#xD;
&#xD;
DROP TABLE #tmppozatr&#xD;
&#xD;
DROP TABLE #tmpKosztyGraniczne&#xD;
&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM3AIWZU/6OpQkKyN+6B1FNMEH/FHa55V/ecPXpX/BUjHjBX5lsAN2DEi1FztfFdymyQACbKc14AwHmvSXJWRlxmOlGUvVkuw7emTarqvqrboa47FkCfwjTI6S+1FbEFI6t6m3o8+TRbbJagg+OTYcvaOVbsvP9cNGs+Xn1fkmizPY57zUZAfsIeMmmWf+gLHzA==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Waluta Koszt Zakupu" caption="Waluta Koszt Zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Waluta" caption="Koszt Zakupu Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Dzień" caption="Data Analizy Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Tydzień Roku" caption="Data Analizy Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Miesiąc" caption="Data Analizy Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Kwartał" caption="Data Analizy Kwartał" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Rok" caption="Data Analizy Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut TEST" caption="Kontrahent Pierwotny Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut TEST" caption="Kontrahent Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut TEST" caption="Odbiorca Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOLOR" caption="Dokument Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut CENA ATRYB" caption="Dokument Atrybut CENA ATRYB" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROWIZJA" caption="Dokument Atrybut PROWIZJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut MONTER KOSZT (K)" caption="Dokument Atrybut MONTER KOSZT (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut CENA2" caption="Produkt Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TESTZAS" caption="Produkt Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DIETA" caption="Produkt Atrybut DIETA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut CENA2" caption="Pozycja Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut TESTZAS" caption="Pozycja Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAAAAAAAAAAAP////8aAAAABwIiW0tvbnRyYWhlbnQgS29kXS5bIU5JRU9LUkXFmkxPTlkhXQcCFltLb250cmFoZW50IEtvZF0uW0FETV0HAhpbS29udHJhaGVudCBLb2RdLltBTF9LT01QXQcCIltLb250cmFoZW50IEtvZF0uW0FMX0tPTVBfR0xJV0lDRV0HAhhbS29udHJhaGVudCBLb2RdLltBTE9aQV0HAhlbS29udHJhaGVudCBLb2RdLltCSUdHVU5dBwIcW0tvbnRyYWhlbnQgS29kXS5bQklVUk9XSUVDXQcCJFtLb250cmFoZW50IEtvZF0uW0JJVVJPV0lFQ19TS0FXSU5BXQcCGFtLb250cmFoZW50IEtvZF0uW0JMRUlNXQcCFltLb250cmFoZW50IEtvZF0uW0NQTl0HAh5bS29udHJhaGVudCBLb2RdLltFTEVLVFJPV05JQV0HAhlbS29udHJhaGVudCBLb2RdLltLT0xBU0FdBwIbW0tvbnRyYWhlbnQgS29kXS5bS09XQUxTS0ldBwIWW0tvbnRyYWhlbnQgS29kXS5bTEFTXQcCGVtLb250cmFoZW50IEtvZF0uW01BUklaQV0HAhlbS29udHJhaGVudCBLb2RdLltNQVJLVVNdBwIcW0tvbnRyYWhlbnQgS29kXS5bTUFSU1pBTElLXQcCGVtLb250cmFoZW50IEtvZF0uW1BVQ1XFml0HAhtbS29udHJhaGVudCBLb2RdLltTT0ZUTEFORF0HAhhbS29udHJhaGVudCBLb2RdLltTVElMTF0HAhhbS29udHJhaGVudCBLb2RdLltURVJSQV0HAhdbS29udHJhaGVudCBLb2RdLltURVNUXQcCGFtLb250cmFoZW50IEtvZF0uW1RFU1QyXQcCGFtLb250cmFoZW50IEtvZF0uW1RFU1QzXQcCF1tLb250cmFoZW50IEtvZF0uW1RQU0FdBwIeW0tvbnRyYWhlbnQgS29kXS5bVFfDk0pPR1LDk0RdAAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="135" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Grupa"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="145" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Jednostka Miary"&gt;&lt;header fontName="Tahoma" fontSize="8" width="112" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Koszt Zakupu"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="0" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 0"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="p2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Koszt Zakupu" index="4" expanded="True" sortMode="default" order="ascending" width="0" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="2" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" index="3" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="default" order="ascending" width="135" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="default" order="ascending" width="145" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Jednostka Miary" index="2" expanded="True" sortMode="default" order="ascending" width="112" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent Grupa" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 0" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 1" index="2" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę kontrahentów z produktami, które zostały im sprzedane.</a:description><a:id>40</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.04 Sprzedaż produktów dla kontrahenta</a:mainLinkName><a:modifiedOn>2025-04-14T10:02:41.337</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-29T11:21:33.953</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g (&#xD;
    gid&#xD;
    ,gidTyp&#xD;
    ,kod&#xD;
    ,gidNumer&#xD;
    ,grONumer&#xD;
    ,poziom&#xD;
    ,sciezka&#xD;
    )&#xD;
AS (&#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,0 AS poziom&#xD;
        ,convert(NVARCHAR(1024), '') AS sciezka&#xD;
    FROM CDN.TwrGrupy&#xD;
    WHERE TwG_TwGID = 0&#xD;
    &#xD;
    UNION ALL&#xD;
    &#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,p.poziom + 1 AS poziom&#xD;
        ,convert(NVARCHAR(1024), p.sciezka + N'\' + c.TwG_Kod) AS sciezka&#xD;
    FROM g p&#xD;
    JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer&#xD;
    WHERE c.TwG_TwGID &lt;&gt; 0&#xD;
        AND c.TwG_GIDTyp = - 16&#xD;
    )&#xD;
SELECT *&#xD;
INTO #tmpTwrGr&#xD;
FROM g&#xD;
&#xD;
DECLARE @poziom INT&#xD;
DECLARE @poziom_max INT&#xD;
DECLARE @sql NVARCHAR(max)&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom)&#xD;
FROM #tmpTwrGr&#xD;
&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0&#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50), ONr' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50)'&#xD;
&#xD;
    EXEC (@sql)&#xD;
&#xD;
    IF @poziom = @poziom_max&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS NVARCHAR) + '= grONumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS NVARCHAR) + ' = kod'&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
    ELSE&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
DECLARE @select VARCHAR(max)&#xD;
DECLARE @select2 VARCHAR(max)&#xD;
DECLARE @select3 VARCHAR(max)&#xD;
DECLARE @kolumny VARCHAR(max)&#xD;
DECLARE @i INT&#xD;
&#xD;
SET @kolumny = ''&#xD;
SET @i = 0&#xD;
&#xD;
WHILE (@i &lt;= @poziom_max)&#xD;
BEGIN&#xD;
    SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' + LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    SET @i = @i + 1&#xD;
END&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id INT&#xD;
    ,@atrybut_kod NVARCHAR(50)&#xD;
    ,@atrybut_typ INT&#xD;
    ,@atrybut_format INT&#xD;
    ,@atrybuty VARCHAR(max)&#xD;
    ,@sqlA NVARCHAR(max);&#xD;
DECLARE @wersja FLOAT;&#xD;
&#xD;
SET @wersja = (&#xD;
        SELECT CONVERT(FLOAT, SYS_Wartosc)&#xD;
        FROM CDN.SystemCDN&#xD;
        WHERE SYS_ID = 3&#xD;
        )&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId&#xD;
    ,KnA_PodmiotTyp&#xD;
INTO #tmpKonAtr&#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId&#xD;
INTO #tmpDokAtr&#xD;
FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr VARCHAR(max)&#xD;
    ,@atrybutyTwr2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId&#xD;
INTO #tmpTwrAtr&#xD;
FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz VARCHAR(max)&#xD;
    ,@atrybutyPoz2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId&#xD;
INTO #tmpPozAtr&#xD;
FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID&#xD;
    ,CASE &#xD;
        WHEN DDf_Numeracja LIKE '@rejestr%'&#xD;
            THEN 5&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 1) = '@rejestr'&#xD;
            THEN 1&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 2) = '@rejestr'&#xD;
            THEN 2&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 3) = '@rejestr'&#xD;
            THEN 3&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 4) = '@rejestr'&#xD;
            THEN 4&#xD;
        END [seria]&#xD;
INTO #tmpSeria&#xD;
FROM CDN.DokDefinicje&#xD;
&#xD;
SELECT *  INTO #tmpKosztyGraniczne FROM (&#xD;
SELECT SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TNFS.TrN_TrNID TransId&#xD;
FROM cdn.tranag TNKG&#xD;
JOIN cdn.traelem TEKG ON TEKG.tre_trnid = TNKG.TrN_TrNID&#xD;
JOIN cdn.Tranag TNFZ ON TNFZ.Trn_trnid = TNKG.TrN_ZwrId&#xD;
JOIN cdn.TranagRelacje ON TNFZ.Trn_trnid = TrR_TrNId&#xD;
    AND TrR_FaTyp IN (&#xD;
        302&#xD;
        ,305&#xD;
        )&#xD;
JOIN cdn.Tranag TNFS ON TNFS.TrN_TrNID = TrR_FaId&#xD;
JOIN cdn.TraElem TEFS ON TNFS.trn_trnid = TEFS.TrE_TrNId&#xD;
    AND TEKG.TrE_Lp = TEFS.TrE_LpPow&#xD;
WHERE TNKG.trn_rodzaj IN (&#xD;
        301008&#xD;
        ,301009&#xD;
        ,301018&#xD;
        )&#xD;
GROUP BY TEFS.TrE_TrEID&#xD;
    ,TNFS.TrN_TrNID&#xD;
&#xD;
	UNION ALL&#xD;
	&#xD;
	 SELECT  SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TEFS.TrE_TrNId TransId&#xD;
    FROM CDN.TraElem TEFS&#xD;
    JOIN CDN.tranagrelacje tr on tr.TrR_TrNID = TEFS.TrE_TrNID&#xD;
    JOIN CDN.traelem TEWZ on tr.TrR_FaId = TEWZ.TrE_TrNID AND TEFS.TrE_Lppow = TEWZ.TrE_LpPow&#xD;
    JOIN CDN.TraSElemDost TraSElemDost on TEWZ.TrE_TrEID = TsD_TrEID&#xD;
	JOIN  CDN.TraSElem ON TsD_TrSIdDost = trs_trsid&#xD;
	JOIN CDN.TraElem TEPZ on TrS_TrEId = TEPZ.TrE_TrEID&#xD;
	JOIN CDN.TraNag  TNPZ on TEPZ.TrE_TrNId = TrN_TrNID&#xD;
	JOIN CDN.TraNagRelacje TRFZ ON TRFZ.TrR_TrNId = TNPZ.TRN_TRNID &#xD;
	JOIN CDN.TraNag  TNFZ ON TNFZ.TrN_TrNID = TRFZ.TrR_FaId&#xD;
	JOIN CDN.TraNag  TNKG ON TNFZ.TrN_TrNID = TNKG.TrN_ZwrId AND TNKG.TrN_Rodzaj = 301009 -- Korekty Graniczne&#xD;
	join CDN.TraElem TEKG ON TEKG.TrE_TrNId = TNKG.TrN_TrNID AND TEKG.TrE_Lp = TEPZ.TrE_LpPow&#xD;
	GROUP BY TEFS.TrE_TrNId,TEFS.TrE_TrEID&#xD;
&#xD;
	)X&#xD;
&#xD;
&#xD;
--Tworzenie tabelki pomocniczej do liczenia marży&#xD;
SELECT TRE.TrE_TrEId treid, TRERel.TrE_TreId trerelid, TRERel.TrE_TypDokumentu trereltyp INTO #tmpMarza&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       LEFT JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId&#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @select = &#xD;
    'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    Tre_Lp [Produkt Lp.],&#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/ISNULL(NULLIF([TrE_JMPrzelicznikL],0),1)*[TrE_JMPrzelicznikM])) * TrE_KursL / ISNULL(NULLIF(TrE_KursM,0),1) [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
	&#xD;
    ,CAST(TR.TrE_Ilosc/ ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS DECIMAL(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) [Waluta Koszt Zakupu]&#xD;
    ,ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1),TR.TrE_KosztUslugi)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],''' + &#xD;
    @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
SET @select2 = &#xD;
    ' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND trn.TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + &#xD;
    ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
   LEFT OUTER JOIN (&#xD;
    SELECT ISNULL(SUM(CASE &#xD;
                    WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
        ,TRE.TrE_TrEID&#xD;
        ,TREWAL.TRE_Waluta&#xD;
        ,TREWAL.TrE_KursL KursZakL&#xD;
        ,TREWAL.Tre_KursM KursZakM&#xD;
    FROM CDN.TraElem TRE&#xD;
    JOIN (&#xD;
        SELECT TrE_TrEId AS IdElem&#xD;
            ,TrE_TrEId AS IdZwiaz&#xD;
        FROM CDN.TraElem&#xD;
        &#xD;
        UNION ALL&#xD;
        &#xD;
        SELECT treid, trerelid &#xD;
		FROM #tmpMarza&#xD;
        WHERE trereltyp NOT IN (&#xD;
                318&#xD;
                ,309&#xD;
                ,308&#xD;
                ,301&#xD;
                )&#xD;
				AND  trerelid is not null&#xD;
        ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
    JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
    JOIN CDN.TraElem TREWAL ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
    GROUP BY TRE.TrE_TrEID,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    ) KosztWyliczony ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN #tmpKosztyGraniczne ON ElemId = TR.Tre_Treid&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy],&#xD;
    NULL [Produkt Lp.],&#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], TrN_WartoscZakupu [Koszt Zakupu], TrN_RazemNetto - TrN_WartoscZakupu [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,NULL [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,KosztWyliczony.TRE_Waluta [Waluta Koszt Zakupu]&#xD;
    ,(CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0)) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + &#xD;
    ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
SET @select3 = &#xD;
    ' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     lEFT JOIN (SELECT  sum(KosztyGraniczne) AS KosztyGraniczne, TransID FROM #tmpKosztyGraniczne GROUP BY TransId)KosztyGran ON Trn_Trnid = TransID &#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
	  LEFT OUTER JOIN (&#xD;
    SELECT ISNULL(SUM(CASE &#xD;
                    WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
        ,TRE.TrE_TrNId&#xD;
        ,TREWAL.TRE_Waluta&#xD;
        ,TREWAL.TrE_KursL KursZakL&#xD;
        ,TREWAL.Tre_KursM KursZakM&#xD;
    FROM CDN.TraElem TRE&#xD;
    JOIN (&#xD;
        SELECT TrE_TrEId AS IdElem&#xD;
            ,TrE_TrEId AS IdZwiaz&#xD;
        FROM CDN.TraElem&#xD;
        &#xD;
        UNION ALL&#xD;
           &#xD;
        SELECT treid, trerelid &#xD;
		FROM #tmpMarza&#xD;
        WHERE trereltyp NOT IN (&#xD;
                318&#xD;
                ,309&#xD;
                ,308&#xD;
                ,301&#xD;
                )&#xD;
				AND  trerelid is not null&#xD;
        ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
    JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
    JOIN CDN.TraElem TREWAL ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
    GROUP BY TRE.TrE_TrNId,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
   ) KosztWyliczony ON KosztWyliczony.TrE_TrNId = Trn_trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
&#xD;
'&#xD;
&#xD;
PRINT (@select + @select2 + @select3)&#xD;
&#xD;
EXEC (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
DROP TABLE #tmpKonAtr&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
DROP TABLE #tmpSeria&#xD;
&#xD;
DROP TABLE #tmppozatr&#xD;
&#xD;
DROP TABLE #tmpKosztyGraniczne&#xD;
&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RAHzthJLfvu07T0UgNHd45wIF/KhvmW1ITcLfChsrjlhVKzbynP8Rv0LbAC6CYe1tkXoYHJKP2yGAAZofqulfPF5mC7l/dXoJCWFvtaiu59NLGK+1i83zgqcZsrZvUKJl3KJkD8ByLvrf4x7qfJ5hzIVjCNYbzHnMTCEtE/nUTSVCH824ITs4BfebduY8AugJTcL+9QG1n11HdfCXN2P10</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Waluta Koszt Zakupu" caption="Waluta Koszt Zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Waluta" caption="Koszt Zakupu Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Dzień" caption="Data Analizy Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Tydzień Roku" caption="Data Analizy Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Miesiąc" caption="Data Analizy Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Kwartał" caption="Data Analizy Kwartał" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Rok" caption="Data Analizy Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut TEST" caption="Kontrahent Pierwotny Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut TEST" caption="Kontrahent Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut TEST" caption="Odbiorca Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOLOR" caption="Dokument Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut CENA ATRYB" caption="Dokument Atrybut CENA ATRYB" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROWIZJA" caption="Dokument Atrybut PROWIZJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut MONTER KOSZT (K)" caption="Dokument Atrybut MONTER KOSZT (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut CENA2" caption="Produkt Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TESTZAS" caption="Produkt Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DIETA" caption="Produkt Atrybut DIETA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut CENA2" caption="Pozycja Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut TESTZAS" caption="Pozycja Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////x4AAAAHAh5bUHJvZHVrdCBLb2RdLltHUkFCSUVfTEnFmkNJRV0HAhpbUHJvZHVrdCBLb2RdLltHUkFCSUVfT0dSXQcCHVtQcm9kdWt0IEtvZF0uW0lHTEFLSV9DWVBSWVNdBwIgW1Byb2R1a3QgS29kXS5bSUdMQUtJX0pBxYFPV0lFQ10HAhlbUHJvZHVrdCBLb2RdLltKQULFgU9OSUVdBwIYW1Byb2R1a3QgS29kXS5bS09SQV9TODBdBwIiW1Byb2R1a3QgS29kXS5bxYFBxYNDVUNIIERPIFBJxYFZXQcCGVtQcm9kdWt0IEtvZF0uW05PV1lUT1dBUl0HAhtbUHJvZHVrdCBLb2RdLltOT8W7WUNFX0VMLl0HAhpbUHJvZHVrdCBLb2RdLltPREtfTEnFmkNJXQcCFltQcm9kdWt0IEtvZF0uW1BBTEVUQV0HAhxbUHJvZHVrdCBLb2RdLltQSUVMxJhHTkFDSkFdBwIcW1Byb2R1a3QgS29kXS5bUEnFgUFfRUxFS1RSXQcCH1tQcm9kdWt0IEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0HAhpbUHJvZHVrdCBLb2RdLltQUk9KX0FSQ0hJXQcCHFtQcm9kdWt0IEtvZF0uW1BST0pfWklFTEVOSV0HAhxbUHJvZHVrdCBLb2RdLltST1pEUkFCTklBQ1pdBwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCGFtQcm9kdWt0IEtvZF0uW1NBRFpPTktJXQcCF1tQcm9kdWt0IEtvZF0uW1NFS0FUT1JdBwIYW1Byb2R1a3QgS29kXS5bU0tSWllOS0FdBwIWW1Byb2R1a3QgS29kXS5bU1RPSkFLXQcCF1tQcm9kdWt0IEtvZF0uW1NaUEFERUxdBwIaW1Byb2R1a3QgS29kXS5bVEVTVEtPUkVLVF0HAiBbUHJvZHVrdCBLb2RdLltUT1dBUldPUEFLT1dBTklVXQcCF1tQcm9kdWt0IEtvZF0uW1RVSkVfM0xdBwIhW1Byb2R1a3QgS29kXS5bVVPFgVVHQSBTRVJXSVNPV0FdBwIaW1Byb2R1a3QgS29kXS5bWkVTVEFXX09HUl0HAhdbUHJvZHVrdCBLb2RdLltaRVNUQVcyXQcCGFtQcm9kdWt0IEtvZF0uW1pJRU1JQV81XQ==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="122" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Grupa"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="130" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Koszt Zakupu"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 0"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="p2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="2" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Koszt Zakupu" index="4" expanded="True" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" index="3" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="1" expanded="True" width="122" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" width="130" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent Grupa" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 0" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 1" index="2" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę produktów z kontrahentami, którym zostały one sprzedane.</a:description><a:id>41</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.05 Sprzedaż produktu dla kontrahentów</a:mainLinkName><a:modifiedOn>2025-04-14T10:02:33.387</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-04T10:44:18.283</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
	   "Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
       "Kontrahent Opiekun" = CASE &#xD;
								WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	   "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       "Produkt Nazwa" = Twr_Nazwa, "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   25003 [Produkt Kod __PROCID__], Twr_twrId [Produkt Kod __ORGID__],	   &#xD;
	   "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
	   29056 [Magazyn Nazwa __PROCID__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
	   "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
	30392 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ''(PUSTA)'',&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ''(PUSTA)'',&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	"Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	"Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
	"Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Kontrahent Opiekun" = CASE &#xD;
							WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
							WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
							ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	"Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
	"Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	"Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
	"Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
	"Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
	"Produkt Kategoria" = ''(PUSTA)'',&#xD;
	"Produkt Nazwa" = ''Korekta zbiorcza'', "Produkt Kod" = ''Korekta zbiorcza'', &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
	30392 [Produkt Kod __PROCID__], TrN_TrNId [Produkt Kod __ORGID__],	   	&#xD;
	"Produkt Numer Katalogowy" = ''Korekta zbiorcza'', "Produkt Pełna Nazwa Grupy" = ''Korekta zbiorcza'', &#xD;
	"Produkt Kaucja" = ''NIE'', "Jednostka Miary" = ''(BRAK)'', "Magazyn Nazwa" = ''(BRAK)'', &#xD;
	30392 [Magazyn Nazwa __PROCID__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
	"Produkt Producent" = ''(BRAK)'', "Produkt Marka" = ''(BRAK)'',&#xD;
	"Produkt Typ" = ''Korekta zbiorcza'',&#xD;
	"Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' END,&#xD;
	"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
	"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
	"Sprzedaż Wartość" = TrN_RazemNetto, "Sprzedaż Wartość Brutto" = TrN_RazemBrutto, "Sprzedaż Wartość Waluta" = TrN_RazemNettoWal, &#xD;
	"Sprzedaż Ilość" = 0, "Koszt Zakupu" = TrN_WartoscZakupu, "Sprzedaż Marża" = TrN_RazemNetto - TrN_WartoscZakupu &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RAHzthJLfvu07T0UgNHd45wIF/KhvmW1ITcLfChsrjlhVKzbynP8Rvc0Pv1WfvD7mejwrzIohjvauoWjwfwS5N/M22SwnYlnFxSvFmPQah+Wvp9Yx6P/re014WvQrDVaWJRbBWxS3kHSpcGyONC6y/diMyv/LVhSik86rAclvKLJ+ZrdYpaw7m</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS" caption="Dokument Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[53633952-3cce-428f-b813-2db1917c357d]" caption="Średni Przychód" formula="(Sprzedaż Ilość = 0 ? 0 : Sprzedaż Wartość/Sprzedaż Ilość)" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[8a8c70a7-5003-4de6-b2fc-7f0479a426d6]" caption="Średnia Marża" formula="(Sprzedaż Ilość = 0 ? 0 : Sprzedaż Marża/Sprzedaż Ilość)" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="175" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Koszt Zakupu"&gt;&lt;cells format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 0"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[53633952-3cce-428f-b813-2db1917c357d]"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[8a8c70a7-5003-4de6-b2fc-7f0479a426d6]"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="4" expanded="True" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="2" expanded="True" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="3" expanded="True" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Koszt Zakupu" index="5" expanded="True" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[53633952-3cce-428f-b813-2db1917c357d]" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[8a8c70a7-5003-4de6-b2fc-7f0479a426d6]" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" width="175" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Produkt Grupa Poziom 0" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę produktów wraz ze średnim przychodem i marżą uzyskaną dla każdego produktu.</a:description><a:id>42</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.06 Średni przychód i marża na produkcie</a:mainLinkName><a:modifiedOn>2014-05-27T18:56:17.933</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-01T11:32:21.18</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
	   "Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
       "Kontrahent Opiekun" = CASE &#xD;
								WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	   "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       "Produkt Nazwa" = Twr_Nazwa, "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   25003 [Produkt Kod __PROCID__], Twr_twrId [Produkt Kod __ORGID__],	   &#xD;
	   "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
	   29056 [Magazyn Nazwa __PROCID__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
	   "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
	30392 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ''(PUSTA)'',&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ''(PUSTA)'',&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	"Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	"Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
	"Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Kontrahent Opiekun" = CASE &#xD;
							WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
							WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
							ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	"Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
	"Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	"Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
	"Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
	"Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
	"Produkt Kategoria" = ''(PUSTA)'',&#xD;
	"Produkt Nazwa" = ''Korekta zbiorcza'', "Produkt Kod" = ''Korekta zbiorcza'', &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
	30392 [Produkt Kod __PROCID__], TrN_TrNId [Produkt Kod __ORGID__],	   	&#xD;
	"Produkt Numer Katalogowy" = ''Korekta zbiorcza'', "Produkt Pełna Nazwa Grupy" = ''Korekta zbiorcza'', &#xD;
	"Produkt Kaucja" = ''NIE'', "Jednostka Miary" = ''(BRAK)'', "Magazyn Nazwa" = ''(BRAK)'', &#xD;
	30392 [Magazyn Nazwa __PROCID__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
	"Produkt Producent" = ''(BRAK)'', "Produkt Marka" = ''(BRAK)'',&#xD;
	"Produkt Typ" = ''Korekta zbiorcza'',&#xD;
	"Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' END,&#xD;
	"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
	"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
	"Sprzedaż Wartość" = TrN_RazemNetto, "Sprzedaż Wartość Brutto" = TrN_RazemBrutto, "Sprzedaż Wartość Waluta" = TrN_RazemNettoWal, &#xD;
	"Sprzedaż Ilość" = 0, "Koszt Zakupu" = TrN_WartoscZakupu, "Sprzedaż Marża" = TrN_RazemNetto - TrN_WartoscZakupu &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RAHzthJLfvu07T0UgNHd45wIF/KhvmW1ITcLfChsrjlhVKzbynP8Rvc0Pv1WfvD7mejwrzIohjvauoWjwfwS5N/M22SwnYlnFxSvFmPQah+Wvp9Yx6P/re014WvQrDVaWJRbBWxS3kHSpcGyONC6y/diMyv/LVhSik86rAclvKLJ+ZrdYpaw7m</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS" caption="Dokument Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Pie3D" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="True" position="Outside" columnIndent="0" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="2" spacingHorizontal="2" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Sprzedaż z podziałem na kategorie" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;diagram3D perspective="20" angleX="-60" angleY="0" angleZ="0" zoom="100" /&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX /&gt;&#xD;
    &lt;axisY /&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAAAAAAAAAAAP////8LAAAABwIgW0tvbnRyYWhlbnQgS2F0ZWdvcmlhXS5bKFBVU1RBKV0HAiBbS29udHJhaGVudCBLYXRlZ29yaWFdLltFTkVSR0lBXQcCJVtLb250cmFoZW50IEthdGVnb3JpYV0uW01BVC4gQklVUk9XRV0HAihbS29udHJhaGVudCBLYXRlZ29yaWFdLltNQVQuIFBPRFNUQVdPV0VdBwIrW0tvbnRyYWhlbnQgS2F0ZWdvcmlhXS5bUEFMSVdPLVNBTS5PU09CT1cuXQcCJFtLb250cmFoZW50IEthdGVnb3JpYV0uW1NQUlrEhFRBTklFXQcCKltLb250cmFoZW50IEthdGVnb3JpYV0uW1NQUlpFREHFuyBLUkFKT1dBXQcCJVtLb250cmFoZW50IEthdGVnb3JpYV0uW1NQUlpFREHFuyBVRV0HAilbS29udHJhaGVudCBLYXRlZ29yaWFdLltURUwuIFNUQUNKT05BUk5FXQcCJ1tLb250cmFoZW50IEthdGVnb3JpYV0uW1pBS1VQWSBLUkFKT1dFXQcCIltLb250cmFoZW50IEthdGVnb3JpYV0uW1pBS1VQWSBVRV0AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="135" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kategoria"&gt;&lt;header fontName="Tahoma" fontSize="8" width="141" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="117" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="132" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 0"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" width="132" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="1" expanded="True" width="135" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Kategoria" index="0" expanded="True" width="141" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="2" expanded="True" width="117" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Produkt Grupa Poziom 0" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż produktów dla kontrahentów pogrupowanych pod względem kategorii ogólnej.</a:description><a:id>43</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.07 Sprzedaż w podziale na kategorie kontrahentów</a:mainLinkName><a:modifiedOn>2014-05-27T19:06:39.85</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-18T12:25:52.01</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT DB_NAME() [Baza Firmowa], &#xD;
&#xD;
	TrN_NumerPelny [Dokument Numer], &#xD;
	CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
&#xD;
	SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)) [Dokument Symbol],&#xD;
	ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
	ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
	ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
	&#xD;
	pod1.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
	20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
&#xD;
	pod1.Pod_Kod [Kontrahent Kod], &#xD;
	20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
&#xD;
	ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
	ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
	CASE knt1.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Kontrahent Opiekun],&#xD;
	&#xD;
	pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
	20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	&#xD;
	pod3.Pod_Kod [Odbiorca Kod], &#xD;
	20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
&#xD;
	ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
	ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
	zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
	ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
	Twr_Nazwa [Produkt Nazwa], &#xD;
	25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
&#xD;
	Twr_Kod [Produkt Kod], &#xD;
	25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],&#xD;
	&#xD;
	Twr_NumerKat [Produkt Numer Katalogowy], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
	CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
	&#xD;
	Mag_Symbol [Magazyn Nazwa],&#xD;
	29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
&#xD;
	ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
	CASE &#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	END [Produkt Typ],&#xD;
	CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
	CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
	CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
		THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Tydzień],&#xD;
	CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
	CASE &#xD;
		WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
		WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Miesiąc Poprzedni],&#xD;
	REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień], &#xD;
	(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku], &#xD;
	MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok], &#xD;
	TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
	(CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
	TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT DB_NAME() [Baza Firmowa], &#xD;
&#xD;
	TrN_NumerPelny [Dokument Numer], &#xD;
	30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
&#xD;
	SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)) [Dokument Symbol],&#xD;
	ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
	ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
	ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
	&#xD;
	pod1.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
	20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	&#xD;
	pod1.Pod_Kod [Kontrahent Kod], &#xD;
	20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	&#xD;
	ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
	ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
	CASE knt1.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Kontrahent Opiekun],&#xD;
	&#xD;
	pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
	20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	&#xD;
	pod3.Pod_Kod [Odbiorca Kod], &#xD;
	20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
&#xD;
	ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
	ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
	zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
	''(PUSTA)'' [Produkt Kategoria],&#xD;
	&#xD;
	''Korekta zbiorcza'' [Produkt Nazwa], &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
&#xD;
	''Korekta zbiorcza'' [Produkt Kod], &#xD;
	30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],&#xD;
		   	&#xD;
	''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
	''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
	&#xD;
	''(BRAK)'' [Magazyn Nazwa], &#xD;
	30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
&#xD;
	''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
	CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
	CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
	CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
		THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Tydzień],&#xD;
	CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
	CASE &#xD;
		WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
		WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Miesiąc Poprzedni],&#xD;
	REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień], &#xD;
	(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku], &#xD;
	MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok], &#xD;
	TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
	0 [Sprzedaż Ilość], TrN_WartoscZakupu [Koszt Zakupu], TrN_RazemNetto - TrN_WartoscZakupu [Sprzedaż Marża]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKDhSAWKi1n1vIC6aYs3D/90/mh8ToH17VguNlqUK5BA5GNn+AmEyuQ8h/4w64ELevu9NzW6YwRfqeSkr1leW+5RABV/t7MQzsJU7vawcEyKBXJVrmS8SVFBoXUGYfY3JUhka0xwvR182Utbo9GUVp7IJr6zTyE/D7</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS" caption="Dokument Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Pie3D" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="True" position="Outside" columnIndent="0" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="0" spacingHorizontal="0" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Sprzedaż dla kategorii ogólnych i szczegółowych" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;diagram3D perspective="20" angleX="-60" angleY="0" angleZ="0" zoom="100" /&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX /&gt;&#xD;
    &lt;axisY /&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wgAAAAHAipbS2F0ZWdvcmlhIE9nw7NsbmEgeiBOYWfFgsOzd2thXS5bKFBVU1RBKV0HAi5bS2F0ZWdvcmlhIE9nw7NsbmEgeiBOYWfFgsOzd2thXS5bS09TWlRZIElOTkVdBwItW0thdGVnb3JpYSBPZ8OzbG5hIHogTmFnxYLDs3drYV0uW01BVEVSSUHFgVldBwI0W0thdGVnb3JpYSBPZ8OzbG5hIHogTmFnxYLDs3drYV0uW1NQUlpFREHFuyBLUkFKT1dBXQcCL1tLYXRlZ29yaWEgT2fDs2xuYSB6IE5hZ8WCw7N3a2FdLltTUFJaRURBxbsgVUVdBwIvW0thdGVnb3JpYSBPZ8OzbG5hIHogTmFnxYLDs3drYV0uW1VTxYFVR0kgT0JDRV0HAjFbS2F0ZWdvcmlhIE9nw7NsbmEgeiBOYWfFgsOzd2thXS5bWkFLVVBZIEtSQUpPV0VdBwIsW0thdGVnb3JpYSBPZ8OzbG5hIHogTmFnxYLDs3drYV0uW1pBS1VQWSBVRV0=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kategoria Szczegółowa z Nagłówka"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="203" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kategoria Szczegółowa z Pozycji"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kategoria Ogólna z Nagłówka"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="176" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kategoria Ogólna z Pozycji"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="143" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" width="143" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kategoria Szczegółowa z Nagłówka" index="1" expanded="True" width="203" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Kategoria Ogólna z Nagłówka" index="0" expanded="True" width="176" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Kategoria Szczegółowa z Pozycji" index="1" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;filter fieldName="Kategoria Ogólna z Pozycji" index="0" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż w rozbiciu na kategorie szczegółowe (z elementu) z możliwością filtrowania kategorii ogólnej (z dokumentu).</a:description><a:id>44</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.08 Sprzedaż w podziale na kategorie ogólne i szczegółowe</a:mainLinkName><a:modifiedOn>2014-05-30T16:41:27.833</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-29T11:22:37.357</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g (&#xD;
    gid&#xD;
    ,gidTyp&#xD;
    ,kod&#xD;
    ,gidNumer&#xD;
    ,grONumer&#xD;
    ,poziom&#xD;
    ,sciezka&#xD;
    )&#xD;
AS (&#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,0 AS poziom&#xD;
        ,convert(NVARCHAR(1024), '') AS sciezka&#xD;
    FROM CDN.TwrGrupy&#xD;
    WHERE TwG_TwGID = 0&#xD;
    &#xD;
    UNION ALL&#xD;
    &#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,p.poziom + 1 AS poziom&#xD;
        ,convert(NVARCHAR(1024), p.sciezka + N'\' + c.TwG_Kod) AS sciezka&#xD;
    FROM g p&#xD;
    JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer&#xD;
    WHERE c.TwG_TwGID &lt;&gt; 0&#xD;
        AND c.TwG_GIDTyp = - 16&#xD;
    )&#xD;
SELECT *&#xD;
INTO #tmpTwrGr&#xD;
FROM g&#xD;
&#xD;
DECLARE @poziom INT&#xD;
DECLARE @poziom_max INT&#xD;
DECLARE @sql NVARCHAR(max)&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom)&#xD;
FROM #tmpTwrGr&#xD;
&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0&#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50), ONr' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50)'&#xD;
&#xD;
    EXEC (@sql)&#xD;
&#xD;
    IF @poziom = @poziom_max&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS NVARCHAR) + '= grONumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS NVARCHAR) + ' = kod'&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
    ELSE&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
DECLARE @select VARCHAR(max)&#xD;
DECLARE @select2 VARCHAR(max)&#xD;
DECLARE @select3 VARCHAR(max)&#xD;
DECLARE @kolumny VARCHAR(max)&#xD;
DECLARE @i INT&#xD;
&#xD;
SET @kolumny = ''&#xD;
SET @i = 0&#xD;
&#xD;
WHILE (@i &lt;= @poziom_max)&#xD;
BEGIN&#xD;
    SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' + LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    SET @i = @i + 1&#xD;
END&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id INT&#xD;
    ,@atrybut_kod NVARCHAR(50)&#xD;
    ,@atrybut_typ INT&#xD;
    ,@atrybut_format INT&#xD;
    ,@atrybuty VARCHAR(max)&#xD;
    ,@sqlA NVARCHAR(max);&#xD;
DECLARE @wersja FLOAT;&#xD;
&#xD;
SET @wersja = (&#xD;
        SELECT CONVERT(FLOAT, SYS_Wartosc)&#xD;
        FROM CDN.SystemCDN&#xD;
        WHERE SYS_ID = 3&#xD;
        )&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId&#xD;
    ,KnA_PodmiotTyp&#xD;
INTO #tmpKonAtr&#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId&#xD;
INTO #tmpDokAtr&#xD;
FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr VARCHAR(max)&#xD;
    ,@atrybutyTwr2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId&#xD;
INTO #tmpTwrAtr&#xD;
FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz VARCHAR(max)&#xD;
    ,@atrybutyPoz2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId&#xD;
INTO #tmpPozAtr&#xD;
FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID&#xD;
    ,CASE &#xD;
        WHEN DDf_Numeracja LIKE '@rejestr%'&#xD;
            THEN 5&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 1) = '@rejestr'&#xD;
            THEN 1&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 2) = '@rejestr'&#xD;
            THEN 2&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 3) = '@rejestr'&#xD;
            THEN 3&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 4) = '@rejestr'&#xD;
            THEN 4&#xD;
        END [seria]&#xD;
INTO #tmpSeria&#xD;
FROM CDN.DokDefinicje&#xD;
&#xD;
SELECT *  INTO #tmpKosztyGraniczne FROM (&#xD;
SELECT SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TNFS.TrN_TrNID TransId&#xD;
FROM cdn.tranag TNKG&#xD;
JOIN cdn.traelem TEKG ON TEKG.tre_trnid = TNKG.TrN_TrNID&#xD;
JOIN cdn.Tranag TNFZ ON TNFZ.Trn_trnid = TNKG.TrN_ZwrId&#xD;
JOIN cdn.TranagRelacje ON TNFZ.Trn_trnid = TrR_TrNId&#xD;
    AND TrR_FaTyp IN (&#xD;
        302&#xD;
        ,305&#xD;
        )&#xD;
JOIN cdn.Tranag TNFS ON TNFS.TrN_TrNID = TrR_FaId&#xD;
JOIN cdn.TraElem TEFS ON TNFS.trn_trnid = TEFS.TrE_TrNId&#xD;
    AND TEKG.TrE_Lp = TEFS.TrE_LpPow&#xD;
WHERE TNKG.trn_rodzaj IN (&#xD;
        301008&#xD;
        ,301009&#xD;
        ,301018&#xD;
        )&#xD;
GROUP BY TEFS.TrE_TrEID&#xD;
    ,TNFS.TrN_TrNID&#xD;
&#xD;
	UNION ALL&#xD;
	&#xD;
	 SELECT  SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TEFS.TrE_TrNId TransId&#xD;
    FROM CDN.TraElem TEFS&#xD;
    JOIN CDN.tranagrelacje tr on tr.TrR_TrNID = TEFS.TrE_TrNID&#xD;
    JOIN CDN.traelem TEWZ on tr.TrR_FaId = TEWZ.TrE_TrNID AND TEFS.TrE_Lppow = TEWZ.TrE_LpPow&#xD;
    JOIN CDN.TraSElemDost TraSElemDost on TEWZ.TrE_TrEID = TsD_TrEID&#xD;
	JOIN  CDN.TraSElem ON TsD_TrSIdDost = trs_trsid&#xD;
	JOIN CDN.TraElem TEPZ on TrS_TrEId = TEPZ.TrE_TrEID&#xD;
	JOIN CDN.TraNag  TNPZ on TEPZ.TrE_TrNId = TrN_TrNID&#xD;
	JOIN CDN.TraNagRelacje TRFZ ON TRFZ.TrR_TrNId = TNPZ.TRN_TRNID &#xD;
	JOIN CDN.TraNag  TNFZ ON TNFZ.TrN_TrNID = TRFZ.TrR_FaId&#xD;
	JOIN CDN.TraNag  TNKG ON TNFZ.TrN_TrNID = TNKG.TrN_ZwrId AND TNKG.TrN_Rodzaj = 301009 -- Korekty Graniczne&#xD;
	join CDN.TraElem TEKG ON TEKG.TrE_TrNId = TNKG.TrN_TrNID AND TEKG.TrE_Lp = TEPZ.TrE_LpPow&#xD;
	GROUP BY TEFS.TrE_TrNId,TEFS.TrE_TrEID&#xD;
&#xD;
	)X&#xD;
&#xD;
&#xD;
--Tworzenie tabelki pomocniczej do liczenia marży&#xD;
SELECT TRE.TrE_TrEId treid, TRERel.TrE_TreId trerelid, TRERel.TrE_TypDokumentu trereltyp INTO #tmpMarza&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       LEFT JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId&#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @select = &#xD;
    'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    Tre_Lp [Produkt Lp.],&#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/ISNULL(NULLIF([TrE_JMPrzelicznikL],0),1)*[TrE_JMPrzelicznikM])) * TrE_KursL / ISNULL(NULLIF(TrE_KursM,0),1) [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
	&#xD;
    ,CAST(TR.TrE_Ilosc/ ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS DECIMAL(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) [Waluta Koszt Zakupu]&#xD;
    ,ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1),TR.TrE_KosztUslugi)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],''' + &#xD;
    @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
SET @select2 = &#xD;
    ' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND trn.TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + &#xD;
    ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
   LEFT OUTER JOIN (&#xD;
    SELECT ISNULL(SUM(CASE &#xD;
                    WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
        ,TRE.TrE_TrEID&#xD;
        ,TREWAL.TRE_Waluta&#xD;
        ,TREWAL.TrE_KursL KursZakL&#xD;
        ,TREWAL.Tre_KursM KursZakM&#xD;
    FROM CDN.TraElem TRE&#xD;
    JOIN (&#xD;
        SELECT TrE_TrEId AS IdElem&#xD;
            ,TrE_TrEId AS IdZwiaz&#xD;
        FROM CDN.TraElem&#xD;
        &#xD;
        UNION ALL&#xD;
        &#xD;
        SELECT treid, trerelid &#xD;
		FROM #tmpMarza&#xD;
        WHERE trereltyp NOT IN (&#xD;
                318&#xD;
                ,309&#xD;
                ,308&#xD;
                ,301&#xD;
                )&#xD;
				AND  trerelid is not null&#xD;
        ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
    JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
    JOIN CDN.TraElem TREWAL ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
    GROUP BY TRE.TrE_TrEID,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    ) KosztWyliczony ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN #tmpKosztyGraniczne ON ElemId = TR.Tre_Treid&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy],&#xD;
    NULL [Produkt Lp.],&#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], TrN_WartoscZakupu [Koszt Zakupu], TrN_RazemNetto - TrN_WartoscZakupu [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,NULL [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,KosztWyliczony.TRE_Waluta [Waluta Koszt Zakupu]&#xD;
    ,(CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0)) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + &#xD;
    ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
SET @select3 = &#xD;
    ' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     lEFT JOIN (SELECT  sum(KosztyGraniczne) AS KosztyGraniczne, TransID FROM #tmpKosztyGraniczne GROUP BY TransId)KosztyGran ON Trn_Trnid = TransID &#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
	  LEFT OUTER JOIN (&#xD;
    SELECT ISNULL(SUM(CASE &#xD;
                    WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
        ,TRE.TrE_TrNId&#xD;
        ,TREWAL.TRE_Waluta&#xD;
        ,TREWAL.TrE_KursL KursZakL&#xD;
        ,TREWAL.Tre_KursM KursZakM&#xD;
    FROM CDN.TraElem TRE&#xD;
    JOIN (&#xD;
        SELECT TrE_TrEId AS IdElem&#xD;
            ,TrE_TrEId AS IdZwiaz&#xD;
        FROM CDN.TraElem&#xD;
        &#xD;
        UNION ALL&#xD;
           &#xD;
        SELECT treid, trerelid &#xD;
		FROM #tmpMarza&#xD;
        WHERE trereltyp NOT IN (&#xD;
                318&#xD;
                ,309&#xD;
                ,308&#xD;
                ,301&#xD;
                )&#xD;
				AND  trerelid is not null&#xD;
        ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
    JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
    JOIN CDN.TraElem TREWAL ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
    GROUP BY TRE.TrE_TrNId,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
   ) KosztWyliczony ON KosztWyliczony.TrE_TrNId = Trn_trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
&#xD;
'&#xD;
&#xD;
PRINT (@select + @select2 + @select3)&#xD;
&#xD;
EXEC (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
DROP TABLE #tmpKonAtr&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
DROP TABLE #tmpSeria&#xD;
&#xD;
DROP TABLE #tmppozatr&#xD;
&#xD;
DROP TABLE #tmpKosztyGraniczne&#xD;
&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+R9xVUaSNnhw1ovX8kGyRfvi+FPVVwm8BXQToPM2XXd7Cy6m9BIS7z9rkj5ZxeDjQlLF25RKynxgVYudBKTm+nNH+tY3QeNQiDsCUB+Hqk0Eksnh4TBVfSMDksKuAbEKPilR1bGKr1uBF/dAkpaRU5ONztqbbiiTHwsESnlxNSkbpASjxWmF+Id</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Waluta Koszt Zakupu" caption="Waluta Koszt Zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Waluta" caption="Koszt Zakupu Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Dzień" caption="Data Analizy Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Tydzień Roku" caption="Data Analizy Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Miesiąc" caption="Data Analizy Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Kwartał" caption="Data Analizy Kwartał" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Rok" caption="Data Analizy Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut TEST" caption="Kontrahent Pierwotny Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut TEST" caption="Kontrahent Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut TEST" caption="Odbiorca Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOLOR" caption="Dokument Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut CENA ATRYB" caption="Dokument Atrybut CENA ATRYB" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROWIZJA" caption="Dokument Atrybut PROWIZJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut MONTER KOSZT (K)" caption="Dokument Atrybut MONTER KOSZT (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut CENA2" caption="Produkt Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TESTZAS" caption="Produkt Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DIETA" caption="Produkt Atrybut DIETA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut CENA2" caption="Pozycja Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut TESTZAS" caption="Pozycja Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>BQAAAAAAAAAAAAAA/////wEAAAAHAhpbRGF0YSBPcGVyYWNqaSBSb2tdLlsyMDIyXQAAAAADAAAAAQAAAAcCGFtNYWdhenluIE5hendhXS5bU2Vyd2lzXf////8BAAAABwIZW01hZ2F6eW4gTmF6d2FdLltNQUdBWllOXQ==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="261" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" formula="( Sprzedaż Wartość= 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Sprzedaż Wartość)" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="175" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Magazyn Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Miesiąc"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Kwartał"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 0"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="default" order="ascending" width="175" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Magazyn Nazwa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Miesiąc" index="2" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/column&gt;&lt;column fieldName="Data Operacji Kwartał" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/column&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields&gt;&lt;filter fieldName="Produkt Grupa Poziom 0" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż produktów z podziałem na magazyny w rozbiciu na okresy czasu.</a:description><a:id>45</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.09 Sprzedaż w podziale na magazyny</a:mainLinkName><a:modifiedOn>2025-04-14T10:01:59.38</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>9</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-29T10:59:38.433</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT DB_NAME() [Baza Firmowa], &#xD;
&#xD;
	TrN_NumerPelny [Dokument Numer], &#xD;
	CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
&#xD;
	SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)) [Dokument Symbol],&#xD;
	ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
	ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
	ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
	&#xD;
	pod1.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
	20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
&#xD;
	pod1.Pod_Kod [Kontrahent Kod], &#xD;
	20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
&#xD;
	ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
	ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
	CASE knt1.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Kontrahent Opiekun],&#xD;
	&#xD;
	pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
	20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	&#xD;
	pod3.Pod_Kod [Odbiorca Kod], &#xD;
	20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
&#xD;
	ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
	ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
	zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
	ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
	Twr_Nazwa [Produkt Nazwa], &#xD;
	25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
&#xD;
	Twr_Kod [Produkt Kod], &#xD;
	25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],&#xD;
	&#xD;
	Twr_NumerKat [Produkt Numer Katalogowy], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
	CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
	&#xD;
	Mag_Symbol [Magazyn Nazwa],&#xD;
	29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
&#xD;
	ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
	CASE &#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	END [Produkt Typ],&#xD;
	CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
	CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
	CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
		THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Tydzień],&#xD;
	CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
	CASE &#xD;
		WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
		WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Miesiąc Poprzedni],&#xD;
	REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień], &#xD;
	(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku], &#xD;
	MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok], &#xD;
	TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
	(CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
	TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT DB_NAME() [Baza Firmowa], &#xD;
&#xD;
	TrN_NumerPelny [Dokument Numer], &#xD;
	30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
&#xD;
	SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)) [Dokument Symbol],&#xD;
	ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
	ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
	ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
	&#xD;
	pod1.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
	20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	&#xD;
	pod1.Pod_Kod [Kontrahent Kod], &#xD;
	20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	&#xD;
	ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
	ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
	CASE knt1.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Kontrahent Opiekun],&#xD;
	&#xD;
	pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
	20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	&#xD;
	pod3.Pod_Kod [Odbiorca Kod], &#xD;
	20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
&#xD;
	ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
	ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
	zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
	''(PUSTA)'' [Produkt Kategoria],&#xD;
	&#xD;
	''Korekta zbiorcza'' [Produkt Nazwa], &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
&#xD;
	''Korekta zbiorcza'' [Produkt Kod], &#xD;
	30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],&#xD;
		   	&#xD;
	''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
	''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
	&#xD;
	''(BRAK)'' [Magazyn Nazwa], &#xD;
	30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
&#xD;
	''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
	CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
	CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
	CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
		THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Tydzień],&#xD;
	CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
	CASE &#xD;
		WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
		WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Miesiąc Poprzedni],&#xD;
	REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień], &#xD;
	(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku], &#xD;
	MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok], &#xD;
	TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
	0 [Sprzedaż Ilość], TrN_WartoscZakupu [Koszt Zakupu], TrN_RazemNetto - TrN_WartoscZakupu [Sprzedaż Marża]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKDhSAWKi1n1vIC6aYs3D/90/mh8ToH17VguNlqUK5BA5GNn+AmEyuQ8h/4w64ELevu9NzW6YwRfqeSkr1leW+5RABV/t7MQzsJU7vawcEyKBXJVrmS8SVFBoXUGYfY3JUhka0xwvR182Utbo9GUVp7IJr6zTyE/D7</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS" caption="Dokument Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Bar" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False" rotated="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="Top" zeroValues="False" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="0" spacingHorizontal="0" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Sprzedaż w regionach" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="[Kontrahent Województwo].[(NIEPRZYPISANE)]" rangeMax="[Kontrahent Województwo].[śląskie]" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="0" rangeMax="541226,202" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAAAAAAAAAAAP////8DAAAABwIrW0tvbnRyYWhlbnQgV29qZXfDs2R6dHdvXS5bKE5JRVBSWllQSVNBTkUpXQcCKFtLb250cmFoZW50IFdvamV3w7NkenR3b10uW21hxYJvcG9sc2tpZV0HAiVbS29udHJhaGVudCBXb2pld8OzZHp0d29dLlvFm2zEhXNraWVdAAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="109" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Województwo"&gt;&lt;header fontName="Tahoma" fontSize="8" width="159" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Miasto"&gt;&lt;header fontName="Tahoma" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Grupa"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="99" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Koszt Zakupu"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="p2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="106" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" width="99" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Koszt Zakupu" index="3" expanded="True" width="0" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" index="2" expanded="True" width="106" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="2" expanded="True" width="109" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Województwo" index="0" expanded="True" width="159" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Miasto" index="1" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent Grupa" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż firmy w regionach (województwa i miasta) w rozbiciu na okresy czasu.</a:description><a:id>46</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.10 Sprzedaż w regionach</a:mainLinkName><a:modifiedOn>2014-05-30T16:41:50.443</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-28T17:35:40.58</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
	   "Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
       "Kontrahent Opiekun" = CASE &#xD;
								WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	   "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       "Produkt Nazwa" = Twr_Nazwa, "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   25003 [Produkt Kod __PROCID__], Twr_twrId [Produkt Kod __ORGID__],	   &#xD;
	   "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
	   29056 [Magazyn Nazwa __PROCID__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
	   "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
	30392 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ''(PUSTA)'',&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ''(PUSTA)'',&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	"Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	"Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
	"Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Kontrahent Opiekun" = CASE &#xD;
							WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
							WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
							ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	"Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
	"Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	"Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
	"Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
	"Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
	"Produkt Kategoria" = ''(PUSTA)'',&#xD;
	"Produkt Nazwa" = ''Korekta zbiorcza'', "Produkt Kod" = ''Korekta zbiorcza'', &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
	30392 [Produkt Kod __PROCID__], TrN_TrNId [Produkt Kod __ORGID__],	   	&#xD;
	"Produkt Numer Katalogowy" = ''Korekta zbiorcza'', "Produkt Pełna Nazwa Grupy" = ''Korekta zbiorcza'', &#xD;
	"Produkt Kaucja" = ''NIE'', "Jednostka Miary" = ''(BRAK)'', "Magazyn Nazwa" = ''(BRAK)'', &#xD;
	30392 [Magazyn Nazwa __PROCID__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
	"Produkt Producent" = ''(BRAK)'', "Produkt Marka" = ''(BRAK)'',&#xD;
	"Produkt Typ" = ''Korekta zbiorcza'',&#xD;
	"Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' END,&#xD;
	"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
	"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
	"Sprzedaż Wartość" = TrN_RazemNetto, "Sprzedaż Wartość Brutto" = TrN_RazemBrutto, "Sprzedaż Wartość Waluta" = TrN_RazemNettoWal, &#xD;
	"Sprzedaż Ilość" = 0, "Koszt Zakupu" = TrN_WartoscZakupu, "Sprzedaż Marża" = TrN_RazemNetto - TrN_WartoscZakupu &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM3AIWZU/6OpQkKyN+6B1FNMEH/FHa55V/ecPXpX/BUjHtJLSEPAoaOz0m4LtlIb+wpH5P043Oa+kgMAsaY0OKuST/EiWUayO8ZjAldU/1S0tOwWQAax0nx8tZHXMox//h5YSCOe+2kvO2hLcJRvXBfiUtToqa23oHf7grDsTti4f</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAKAAAABwIYW0tvbnRyYWhlbnQgS29kXS5bQUxPWkFdBwIYW0tvbnRyYWhlbnQgS29kXS5bVEVSUkFdBwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSSVpBXQcCG1tLb250cmFoZW50IEtvZF0uW1NPRlRMQU5EXQcCHltLb250cmFoZW50IEtvZF0uW1RXw5NKT0dSw5NEXQcCFltLb250cmFoZW50IEtvZF0uW0FETV0HAhlbS29udHJhaGVudCBLb2RdLltLT0xBU0FdBwIiW0tvbnRyYWhlbnQgS29kXS5bIU5JRU9LUkXFmkxPTlkhXQcCGVtLb250cmFoZW50IEtvZF0uW0JJR0dVTl0HAhhbS29udHJhaGVudCBLb2RdLltTVElMTF3/////AAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;whatifMeasures&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&#xD;
  &lt;/whatifMeasures&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions&gt;&#xD;
    &lt;format ref="Kontrahent Nazwa"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="200" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Kontrahent Kod"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="135" top="10" topType="TopAbsolute" dataField="Sprzedaż Wartość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Kontrahent Grupa"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Sprzedaż Wartość"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Koszt Zakupu"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="0" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Sprzedaż Marża"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Grupa Poziom 1"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="p2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="102" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
  &lt;/formatOptions&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields&gt;&#xD;
    &lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
    &lt;data fieldName="Koszt Zakupu" index="3" expanded="True" sortMode="default" order="ascending" width="0" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
    &lt;data fieldName="Sprzedaż Marża" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
    &lt;data fieldName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" index="2" expanded="True" sortMode="default" order="ascending" width="102" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Object"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
  &lt;/dataFields&gt;&#xD;
  &lt;rowFields&gt;&#xD;
    &lt;row fieldName="Kontrahent Nazwa" index="1" expanded="True" sortMode="default" order="ascending" width="200" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
    &lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="displayText" order="descending" width="135" top="10" topType="TopAbsolute" dataField="Sprzedaż Wartość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy dataFieldName="Sprzedaż Wartość" /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
  &lt;/rowFields&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields&gt;&#xD;
    &lt;filter fieldName="Kontrahent Grupa" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
    &lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
  &lt;/filterFields&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę dziesięciu największych kontrahentów pod względem wartości sprzedaży.</a:description><a:id>47</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.11 Top 10 kontrahentów według wartości sprzedaży</a:mainLinkName><a:modifiedOn>2014-05-27T18:56:52.153</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-28T17:44:21.377</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
	   "Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
       "Kontrahent Opiekun" = CASE &#xD;
								WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	   "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       "Produkt Nazwa" = Twr_Nazwa, "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   25003 [Produkt Kod __PROCID__], Twr_twrId [Produkt Kod __ORGID__],	   &#xD;
	   "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
	   29056 [Magazyn Nazwa __PROCID__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
	   "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
	30392 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ''(PUSTA)'',&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ''(PUSTA)'',&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	"Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	"Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
	"Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Kontrahent Opiekun" = CASE &#xD;
							WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
							WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
							ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	"Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
	"Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	"Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
	"Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
	"Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
	"Produkt Kategoria" = ''(PUSTA)'',&#xD;
	"Produkt Nazwa" = ''Korekta zbiorcza'', "Produkt Kod" = ''Korekta zbiorcza'', &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
	30392 [Produkt Kod __PROCID__], TrN_TrNId [Produkt Kod __ORGID__],	   	&#xD;
	"Produkt Numer Katalogowy" = ''Korekta zbiorcza'', "Produkt Pełna Nazwa Grupy" = ''Korekta zbiorcza'', &#xD;
	"Produkt Kaucja" = ''NIE'', "Jednostka Miary" = ''(BRAK)'', "Magazyn Nazwa" = ''(BRAK)'', &#xD;
	30392 [Magazyn Nazwa __PROCID__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
	"Produkt Producent" = ''(BRAK)'', "Produkt Marka" = ''(BRAK)'',&#xD;
	"Produkt Typ" = ''Korekta zbiorcza'',&#xD;
	"Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' END,&#xD;
	"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
	"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
	"Sprzedaż Wartość" = TrN_RazemNetto, "Sprzedaż Wartość Brutto" = TrN_RazemBrutto, "Sprzedaż Wartość Waluta" = TrN_RazemNettoWal, &#xD;
	"Sprzedaż Ilość" = 0, "Koszt Zakupu" = TrN_WartoscZakupu, "Sprzedaż Marża" = TrN_RazemNetto - TrN_WartoscZakupu &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM3AIWZU/6OpQkKyN+6B1FNMEH/FHa55V/ecPXpX/BUjHtJLSEPAoaOz0m4LtlIb+wpH5P043Oa+kgMAsaY0OKuST/EiWUayO8ZjAldU/1S0tOwWQAax0nx8tZHXMox//h5YSCOe+2kvO2hLcJRvXBfiUtToqa23oHf7grDsTti4f</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAKAAAABwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCF1tQcm9kdWt0IEtvZF0uW1RVSkVfM0xdBwIYW1Byb2R1a3QgS29kXS5bS09SQV9TODBdBwIaW1Byb2R1a3QgS29kXS5bT0RLX0xJxZpDSV0HAhxbUHJvZHVrdCBLb2RdLltST1pEUkFCTklBQ1pdBwIfW1Byb2R1a3QgS29kXS5bUEnFgUFfU1BBTElOT1dBXQcCHltQcm9kdWt0IEtvZF0uW0dSQUJJRV9MScWaQ0lFXQcCGVtQcm9kdWt0IEtvZF0uW0pBQsWBT05JRV0HAhpbUHJvZHVrdCBLb2RdLltaRVNUQVdfT0dSXQcCG1tQcm9kdWt0IEtvZF0uW05PxbtZQ0VfRUwuXf////8AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;whatifMeasures&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&#xD;
  &lt;/whatifMeasures&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions&gt;&#xD;
    &lt;format ref="Produkt Nazwa"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="173" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Kod"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="188" top="10" topType="TopAbsolute" dataField="Sprzedaż Wartość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Sprzedaż Wartość"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Koszt Zakupu"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="0" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Sprzedaż Marża"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Grupa Poziom 1"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="p2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="102" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
  &lt;/formatOptions&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields&gt;&#xD;
    &lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
    &lt;data fieldName="Koszt Zakupu" index="3" expanded="True" sortMode="default" order="ascending" width="0" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
    &lt;data fieldName="Sprzedaż Marża" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
    &lt;data fieldName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" index="2" expanded="True" sortMode="default" order="ascending" width="102" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Object"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
  &lt;/dataFields&gt;&#xD;
  &lt;rowFields&gt;&#xD;
    &lt;row fieldName="Produkt Nazwa" index="1" expanded="True" sortMode="default" order="ascending" width="173" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
    &lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="displayText" order="descending" width="188" top="10" topType="TopAbsolute" dataField="Sprzedaż Wartość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy dataFieldName="Sprzedaż Wartość" /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
  &lt;/rowFields&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields&gt;&#xD;
    &lt;filter fieldName="Produkt Grupa Poziom 1" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
  &lt;/filterFields&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę dziesięciu produktów generujących największą wartość sprzedaży.</a:description><a:id>48</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.12 Top 10 produktów według wartości sprzedaży </a:mainLinkName><a:modifiedOn>2014-05-27T18:56:59.127</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-04T10:48:37.317</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
	   "Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
       "Kontrahent Opiekun" = CASE &#xD;
								WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	   "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       "Produkt Nazwa" = Twr_Nazwa, "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   25003 [Produkt Kod __PROCID__], Twr_twrId [Produkt Kod __ORGID__],	   &#xD;
	   "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
	   29056 [Magazyn Nazwa __PROCID__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
	   "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
	30392 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ''(PUSTA)'',&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ''(PUSTA)'',&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	"Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	"Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
	"Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Kontrahent Opiekun" = CASE &#xD;
							WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
							WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
							ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	"Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
	"Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	"Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
	"Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
	"Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
	"Produkt Kategoria" = ''(PUSTA)'',&#xD;
	"Produkt Nazwa" = ''Korekta zbiorcza'', "Produkt Kod" = ''Korekta zbiorcza'', &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
	30392 [Produkt Kod __PROCID__], TrN_TrNId [Produkt Kod __ORGID__],	   	&#xD;
	"Produkt Numer Katalogowy" = ''Korekta zbiorcza'', "Produkt Pełna Nazwa Grupy" = ''Korekta zbiorcza'', &#xD;
	"Produkt Kaucja" = ''NIE'', "Jednostka Miary" = ''(BRAK)'', "Magazyn Nazwa" = ''(BRAK)'', &#xD;
	30392 [Magazyn Nazwa __PROCID__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
	"Produkt Producent" = ''(BRAK)'', "Produkt Marka" = ''(BRAK)'',&#xD;
	"Produkt Typ" = ''Korekta zbiorcza'',&#xD;
	"Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' END,&#xD;
	"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
	"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
	"Sprzedaż Wartość" = TrN_RazemNetto, "Sprzedaż Wartość Brutto" = TrN_RazemBrutto, "Sprzedaż Wartość Waluta" = TrN_RazemNettoWal, &#xD;
	"Sprzedaż Ilość" = 0, "Koszt Zakupu" = TrN_WartoscZakupu, "Sprzedaż Marża" = TrN_RazemNetto - TrN_WartoscZakupu &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM3AIWZU/6OpQkKyN+6B1FNMEH/FHa55V/ecPXpX/BUjHtJLSEPAoaOz0m4LtlIb+wpH5P043Oa+kgMAsaY0OKuST/EiWUayO8ZjAldU/1S0tOwWQAax0nx8tZHXMox//h5YSCOe+2kvO2hLcJRvXBfiUtToqa23oHf7grDsTti4f</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAKAAAABwIhW1Byb2R1a3QgS29kXS5bVVPFgVVHQSBTRVJXSVNPV0FdBwIcW1Byb2R1a3QgS29kXS5bUElFTMSYR05BQ0pBXQcCGVtQcm9kdWt0IEtvZF0uW05PV1lUT1dBUl0HAhhbUHJvZHVrdCBLb2RdLltLT1JBX1M4MF0HAhdbUHJvZHVrdCBLb2RdLltUVUpFXzNMXQcCGVtQcm9kdWt0IEtvZF0uW1LDk8W7QV9QTl0HAh9bUHJvZHVrdCBLb2RdLltQScWBQV9TUEFMSU5PV0FdBwIXW1Byb2R1a3QgS29kXS5bU1pQQURFTF0HAhpbUHJvZHVrdCBLb2RdLltPREtfTEnFmkNJXQcCHFtQcm9kdWt0IEtvZF0uW1JPWkRSQUJOSUFDWl3/////AAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;whatifMeasures&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&#xD;
  &lt;/whatifMeasures&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions&gt;&#xD;
    &lt;format ref="Produkt Nazwa"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="157" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Kod"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="180" top="10" topType="TopAbsolute" dataField="Sprzedaż Marża" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Sprzedaż Wartość"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Sprzedaż Marża"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Grupa Poziom 0"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Grupa Poziom 1"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
  &lt;/formatOptions&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields&gt;&#xD;
    &lt;data fieldName="Sprzedaż Wartość" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
    &lt;data fieldName="Sprzedaż Marża" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
  &lt;/dataFields&gt;&#xD;
  &lt;rowFields&gt;&#xD;
    &lt;row fieldName="Produkt Nazwa" index="1" expanded="True" sortMode="default" order="ascending" width="157" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
    &lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="displayText" order="descending" width="180" top="10" topType="TopAbsolute" dataField="Sprzedaż Marża" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy dataFieldName="Sprzedaż Marża" /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
  &lt;/rowFields&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields&gt;&#xD;
    &lt;filter fieldName="Produkt Grupa Poziom 0" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
    &lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
  &lt;/filterFields&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę dziesięciu produktów, na których uzyskano największą wartość marży.</a:description><a:id>49</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.13 Top 10 produktów według marży</a:mainLinkName><a:modifiedOn>2014-05-27T18:57:07.617</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-18T16:04:53.08</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
	   "Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
       "Kontrahent Opiekun" = CASE &#xD;
								WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	   "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       "Produkt Nazwa" = Twr_Nazwa, "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   25003 [Produkt Kod __PROCID__], Twr_twrId [Produkt Kod __ORGID__],	   &#xD;
	   "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
	   29056 [Magazyn Nazwa __PROCID__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
	   "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
	30392 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ''(PUSTA)'',&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ''(PUSTA)'',&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	"Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	"Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
	"Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Kontrahent Opiekun" = CASE &#xD;
							WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
							WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
							ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	"Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
	"Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	"Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
	"Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
	"Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
	"Produkt Kategoria" = ''(PUSTA)'',&#xD;
	"Produkt Nazwa" = ''Korekta zbiorcza'', "Produkt Kod" = ''Korekta zbiorcza'', &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
	30392 [Produkt Kod __PROCID__], TrN_TrNId [Produkt Kod __ORGID__],	   	&#xD;
	"Produkt Numer Katalogowy" = ''Korekta zbiorcza'', "Produkt Pełna Nazwa Grupy" = ''Korekta zbiorcza'', &#xD;
	"Produkt Kaucja" = ''NIE'', "Jednostka Miary" = ''(BRAK)'', "Magazyn Nazwa" = ''(BRAK)'', &#xD;
	30392 [Magazyn Nazwa __PROCID__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
	"Produkt Producent" = ''(BRAK)'', "Produkt Marka" = ''(BRAK)'',&#xD;
	"Produkt Typ" = ''Korekta zbiorcza'',&#xD;
	"Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' END,&#xD;
	"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
	"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
	"Sprzedaż Wartość" = TrN_RazemNetto, "Sprzedaż Wartość Brutto" = TrN_RazemBrutto, "Sprzedaż Wartość Waluta" = TrN_RazemNettoWal, &#xD;
	"Sprzedaż Ilość" = 0, "Koszt Zakupu" = TrN_WartoscZakupu, "Sprzedaż Marża" = TrN_RazemNetto - TrN_WartoscZakupu &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RAHzthJLfvu07T0UgNHd45wIF/KhvmW1ITcLfChsrjlhVKzbynP8Rvc0Pv1WfvD7mejwrzIohjvauoWjwfwS5N/M22SwnYlnFxSvFmPQah+Wvp9Yx6P/re014WvQrDVaWJRbBWxS3kHSpcGyONC6y/diMyv/LVhSik86rAclvKLJ+ZrdYpaw7m</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS" caption="Dokument Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Spline" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False" rotated="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="" angle="45" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="0" spacingHorizontal="0" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Cykl życia" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;points kind="Circle" size="10" starPoints="5" borderVisible="True" borderColor="" visible="True" color=""&gt;&#xD;
    &lt;appearance color="" fillMode="Empty" /&gt;&#xD;
  &lt;/points&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="[Data Operacji Rok].[2008]|[Data Operacji Kwartał].[1]" rangeMax="[Data Operacji Rok].[2012]|[Data Operacji Kwartał].[2]" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="-28539,9502039202" rangeMax="220669,046382175" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAEAAAABwIaW0RhdGEgT3BlcmFjamkgUm9rXS5bMjAwOF0HAhpbRGF0YSBPcGVyYWNqaSBSb2tdLlsyMDA5XQcCGltEYXRhIE9wZXJhY2ppIFJva10uWzIwMTFdBwIaW0RhdGEgT3BlcmFjamkgUm9rXS5bMjAxMl3/////AAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Data Operacji Kwartał"&gt;&lt;header fontName="Tahoma" fontSize="8" width="140" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="140" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" isHidden="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="5" topType="TopAbsolute" dataField="Sprzedaż Wartość" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Data Operacji Kwartał" index="1" expanded="True" width="140" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Data Operacji Rok" index="0" expanded="True" width="140" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" isHidden="True"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Produkt Grupa Poziom 1" index="0" expanded="True" width="100" top="5" topType="TopAbsolute" dataField="Sprzedaż Wartość" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy dataFieldName="Sprzedaż Wartość" /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż najważniejszych grup produktów na przestrzeni czasu.</a:description><a:id>50</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.14 Cykl życia</a:mainLinkName><a:modifiedOn>2014-05-27T19:07:02.203</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-21T14:09:32.273</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
	   "Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
       "Kontrahent Opiekun" = CASE &#xD;
								WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	   "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       "Produkt Nazwa" = Twr_Nazwa, "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   25003 [Produkt Kod __PROCID__], Twr_twrId [Produkt Kod __ORGID__],	   &#xD;
	   "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
	   29056 [Magazyn Nazwa __PROCID__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
	   "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
	30392 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ''(PUSTA)'',&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ''(PUSTA)'',&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	"Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	"Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
	"Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Kontrahent Opiekun" = CASE &#xD;
							WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
							WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
							ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	"Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
	"Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	"Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
	"Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
	"Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
	"Produkt Kategoria" = ''(PUSTA)'',&#xD;
	"Produkt Nazwa" = ''Korekta zbiorcza'', "Produkt Kod" = ''Korekta zbiorcza'', &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
	30392 [Produkt Kod __PROCID__], TrN_TrNId [Produkt Kod __ORGID__],	   	&#xD;
	"Produkt Numer Katalogowy" = ''Korekta zbiorcza'', "Produkt Pełna Nazwa Grupy" = ''Korekta zbiorcza'', &#xD;
	"Produkt Kaucja" = ''NIE'', "Jednostka Miary" = ''(BRAK)'', "Magazyn Nazwa" = ''(BRAK)'', &#xD;
	30392 [Magazyn Nazwa __PROCID__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
	"Produkt Producent" = ''(BRAK)'', "Produkt Marka" = ''(BRAK)'',&#xD;
	"Produkt Typ" = ''Korekta zbiorcza'',&#xD;
	"Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' END,&#xD;
	"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
	"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
	"Sprzedaż Wartość" = TrN_RazemNetto, "Sprzedaż Wartość Brutto" = TrN_RazemBrutto, "Sprzedaż Wartość Waluta" = TrN_RazemNettoWal, &#xD;
	"Sprzedaż Ilość" = 0, "Koszt Zakupu" = TrN_WartoscZakupu, "Sprzedaż Marża" = TrN_RazemNetto - TrN_WartoscZakupu &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8sJ7a+Ib5ljeiB+o1CVa8K09VmwT3LHj3ChZA6BezNBwrS1BzJzaTn10QuwI3PMujIBT6U16yWR6Gt6rBj6xMh0cN/xE38i+czy1N+qeZhEJwbJdTVWZo7RtrWNzjM6tZzQ9zLMJBf27+HoUEnugUTGHfv8cmn1LqYI8l10yxoVu/5+89jLa2Ai</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Data" caption="Czas Aktualny Data" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Waluta Koszt Zakupu" caption="Waluta Koszt Zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Waluta" caption="Koszt Zakupu Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut EMAIL" caption="Kontrahent Pierwotny Atrybut EMAIL" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut EMAIL" caption="Kontrahent Atrybut EMAIL" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut EMAIL" caption="Odbiorca Atrybut EMAIL" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut NUMER SERYJNY" caption="Dokument Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut EMAIL (K)" caption="Dokument Atrybut EMAIL (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut WAGA" caption="Produkt Atrybut WAGA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NUMER SERYJNY" caption="Pozycja Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Pie3D" palette="In A Fog" paletteBaseColor="0" style="In A Fog" grandTotals="False" subTotals="False" onlySelected="False" showSeriesInSeparatePanes="False" fieldVisible="False" dataVertical="True" showParametersValues="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="True" position="Outside" columnIndent="0" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1" textOrientation="Horizontal"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="2" spacingHorizontal="2" limitsVertical="100" limitsHorizontal="100" location="{X=1351,Y=379}" isCustomLocation="False"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Udział grup produktów w sprzedaży" visible="True" dock="Top" alignment="Center" indent="0" location="{X=731,Y=6}" isCustomLocation="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="Black" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;pointOptions pointView="Values" pattern="{V}"&gt;&#xD;
    &lt;valueNumericOptions numericFormat="General" numericPrecision="2" /&gt;&#xD;
    &lt;valueDateTimeOptions dateTimeFormat="ShortDate" dateTimeFormatString="" /&gt;&#xD;
    &lt;argumentNumericOptions numericFormat="General" numericPrecision="2" /&gt;&#xD;
    &lt;argumentDateTimeOptions dateTimeFormat="ShortDate" dateTimeFormatString="" /&gt;&#xD;
    &lt;piePointOptions&gt;&#xD;
      &lt;percentOption valueAsPercent="True" percentageAccuracy="2" /&gt;&#xD;
    &lt;/piePointOptions&gt;&#xD;
    &lt;simplePointOptions&gt;&#xD;
      &lt;percentOption valueAsPercent="True" percentageAccuracy="2" /&gt;&#xD;
    &lt;/simplePointOptions&gt;&#xD;
  &lt;/pointOptions&gt;&#xD;
  &lt;diagram3D perspective="20" angleX="-60" angleY="0" angleZ="0" zoom="100" /&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX /&gt;&#xD;
    &lt;axisY /&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;whatifMeasures&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" formula="( Sprzedaż Wartość= 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Sprzedaż Wartość)" description="" summaryType="Sum" /&gt;&#xD;
  &lt;/whatifMeasures&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions&gt;&#xD;
    &lt;format ref="Sprzedaż Wartość"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" horzAlignment="Far" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" horzAlignment="Near" width="132" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8" horzAlignment="Near" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Grupa Poziom 1"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="169" top="10" topType="TopAbsolute" dataField="Sprzedaż Wartość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
  &lt;/formatOptions&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields&gt;&#xD;
    &lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="132" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
  &lt;/dataFields&gt;&#xD;
  &lt;rowFields&gt;&#xD;
    &lt;row fieldName="Produkt Grupa Poziom 1" index="0" expanded="True" sortMode="displayText" order="descending" width="169" top="10" topType="TopAbsolute" dataField="Sprzedaż Wartość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy dataFieldName="Sprzedaż Wartość" /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
  &lt;/rowFields&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields /&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje procentowy podział dziesięciu największych grup produktów w wartości sprzedaży.</a:description><a:id>51</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.15 Udział grup produktów w sprzedaży</a:mainLinkName><a:modifiedOn>2014-05-27T18:57:16.383</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-21T14:14:20.78</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
	   "Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
       "Kontrahent Opiekun" = CASE &#xD;
								WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	   "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       "Produkt Nazwa" = Twr_Nazwa, "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   25003 [Produkt Kod __PROCID__], Twr_twrId [Produkt Kod __ORGID__],	   &#xD;
	   "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
	   29056 [Magazyn Nazwa __PROCID__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
	   "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
	30392 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ''(PUSTA)'',&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ''(PUSTA)'',&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	"Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	"Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
	"Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Kontrahent Opiekun" = CASE &#xD;
							WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
							WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
							ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	"Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
	"Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	"Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
	"Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
	"Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
	"Produkt Kategoria" = ''(PUSTA)'',&#xD;
	"Produkt Nazwa" = ''Korekta zbiorcza'', "Produkt Kod" = ''Korekta zbiorcza'', &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
	30392 [Produkt Kod __PROCID__], TrN_TrNId [Produkt Kod __ORGID__],	   	&#xD;
	"Produkt Numer Katalogowy" = ''Korekta zbiorcza'', "Produkt Pełna Nazwa Grupy" = ''Korekta zbiorcza'', &#xD;
	"Produkt Kaucja" = ''NIE'', "Jednostka Miary" = ''(BRAK)'', "Magazyn Nazwa" = ''(BRAK)'', &#xD;
	30392 [Magazyn Nazwa __PROCID__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
	"Produkt Producent" = ''(BRAK)'', "Produkt Marka" = ''(BRAK)'',&#xD;
	"Produkt Typ" = ''Korekta zbiorcza'',&#xD;
	"Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' END,&#xD;
	"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
	"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
	"Sprzedaż Wartość" = TrN_RazemNetto, "Sprzedaż Wartość Brutto" = TrN_RazemBrutto, "Sprzedaż Wartość Waluta" = TrN_RazemNettoWal, &#xD;
	"Sprzedaż Ilość" = 0, "Koszt Zakupu" = TrN_WartoscZakupu, "Sprzedaż Marża" = TrN_RazemNetto - TrN_WartoscZakupu &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM3AIWZU/6OpQkKyN+6B1FNMEH/FHa55V/ecPXpX/BUjHtJLSEPAoaOz0m4LtlIb+wpH5P043Oa+kgMAsaY0OKuST/EiWUayO8ZjAldU/1S0tOwWQAax0nx8tZHXMox//h5YSCOe+2kvO2hLcJRvXBfiUtToqa23oHf7grDsTti4f</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Pie3D" palette="In A Fog" paletteBaseColor="0" style="In A Fog" grandTotals="False" subTotals="False" onlySelected="False" showSeriesInSeparatePanes="False" fieldVisible="False" dataVertical="True" showParametersValues="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="True" position="Outside" columnIndent="0" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1" textOrientation="Horizontal"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="2" spacingHorizontal="2" limitsVertical="100" limitsHorizontal="100" location="{X=1153,Y=375}" isCustomLocation="False"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Udział grup kontrahentów w sprzedaży" visible="True" dock="Top" alignment="Center" indent="0" location="{X=632,Y=6}" isCustomLocation="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="Black" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;pointOptions pointView="Values" pattern="{V}"&gt;&#xD;
    &lt;valueNumericOptions numericFormat="General" numericPrecision="2" /&gt;&#xD;
    &lt;valueDateTimeOptions dateTimeFormat="ShortDate" dateTimeFormatString="" /&gt;&#xD;
    &lt;argumentNumericOptions numericFormat="General" numericPrecision="2" /&gt;&#xD;
    &lt;argumentDateTimeOptions dateTimeFormat="ShortDate" dateTimeFormatString="" /&gt;&#xD;
    &lt;piePointOptions&gt;&#xD;
      &lt;percentOption valueAsPercent="True" percentageAccuracy="2" /&gt;&#xD;
    &lt;/piePointOptions&gt;&#xD;
    &lt;simplePointOptions&gt;&#xD;
      &lt;percentOption valueAsPercent="True" percentageAccuracy="2" /&gt;&#xD;
    &lt;/simplePointOptions&gt;&#xD;
  &lt;/pointOptions&gt;&#xD;
  &lt;diagram3D perspective="20" angleX="-60" angleY="0" angleZ="0" zoom="100" /&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX /&gt;&#xD;
    &lt;axisY /&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;whatifMeasures&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&#xD;
  &lt;/whatifMeasures&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions&gt;&#xD;
    &lt;format ref="Kontrahent Grupa"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="125" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Sprzedaż Wartość"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="132" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&#xD;
    &lt;/format&gt;&#xD;
  &lt;/formatOptions&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields&gt;&#xD;
    &lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="132" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
  &lt;/dataFields&gt;&#xD;
  &lt;rowFields&gt;&#xD;
    &lt;row fieldName="Kontrahent Grupa" index="0" expanded="True" sortMode="displayText" order="descending" width="125" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy dataFieldName="Sprzedaż Wartość" /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
  &lt;/rowFields&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields /&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje procentowy udział grup kontrahentów w wartości sprzedaży.</a:description><a:id>52</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.16 Udział grup kontrahentów w sprzedaży</a:mainLinkName><a:modifiedOn>2014-05-27T18:57:23.527</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-31T17:10:17.997</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży Rok Do Roku &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
;WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @kolumny2 varchar(max)&#xD;
declare @kolumny3 varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
set @kolumny3 = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = ISNULL(biezacy.Poziom' +LTRIM(@i) + ', ISNULL(poprzedni.Poziom' +LTRIM(@i) + ', ''(NIEPRZYPISANE)''))'&#xD;
    set @kolumny2 = @kolumny2 + ',Poz.Poziom' +LTRIM(@i) &#xD;
    set @kolumny3 = @kolumny3 + ',Poz.Poziom' +LTRIM(@i) + ' as Poziom' + +LTRIM(@i)&#xD;
    set @i = @i + 1&#xD;
end;&#xD;
&#xD;
--Właściwe Zapytanie&#xD;
set @select = &#xD;
'with BU as&#xD;
(&#xD;
select &#xD;
SUM(TR.TrE_WartoscNetto) as Wartosc, SUM(TR.TrE_Ilosc) as Ilosc, YEAR(TRN.TrN_DataOpe)*100+ MONTH(TRN.TrN_DataOpe) as MR, Twr_TwrId as Produkt, Twr_Kod as Kod, Twr_Nazwa as Nazwa ' + @kolumny3 +&#xD;
' from CDN.TraElem tr&#xD;
JOIN CDN.TraNag trn on trn.TrN_TrNID=TR.TrE_TrNId&#xD;
JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
LEFT OUTER JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = gidNumer&#xD;
WHERE&#xD;
(TrN_TypDokumentu=-1 OR CDN.TypSkojarzenia(TrN_TrNId)=302000 OR CDN.TypSkojarzenia(TrN_TrNId)=302306 OR CDN.TypSkojarzenia(TrN_TrNId)=305000 OR CDN.TypSkojarzenia(TrN_TrNId)=305302) &#xD;
AND TrN_Rodzaj NOT IN (302101,302102,302103)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TR.TrE_Aktywny&lt;&gt;0&#xD;
AND TR.TrE_UslugaZlozonaId = 0&#xD;
group by  YEAR(TRN.TrN_DataOpe)*100+ MONTH(TRN.TrN_DataOpe), Twr_TwrId, Twr_Kod, Twr_Nazwa' + @kolumny2 +&#xD;
') &#xD;
select &#xD;
"Baza Firmowa" = BAZ.Baz_Nazwa,&#xD;
"Data Operacji Rok" = ISNULL(Miesiace.Rok, SUBSTRING(convert(varchar,poprzedni.MR+100), 0, 5)),&#xD;
"Data Operacji Miesiąc" = ISNULL(Miesiace.Miesiac, SUBSTRING(convert(varchar,poprzedni.MR+100), 5,6)),&#xD;
"Data Analizy" = GETDATE(),&#xD;
"Sprzedaż Wartość Bieżący" = biezacy.Wartosc, "Sprzedaż Ilość Bieżący" = biezacy.Ilosc, "Sprzedaż Wartość Poprzedni" = poprzedni.Wartosc,   "Sprzedaż Ilość Poprzedni" = poprzedni.Ilosc, &#xD;
"Produkt Kod" = ISNULL(biezacy.Kod, ISNULL(poprzedni.Kod, ''(PUSTE)'')), &#xD;
"Produkt Nazwa" = ISNULL(biezacy.Nazwa, ISNULL(poprzedni.Nazwa, ''(PUSTE)''))&#xD;
----------KONTEKSTY&#xD;
,25003 [Produkt Kod __PROCID__Towary__], ISNULL(biezacy.Produkt,poprzedni.Produkt) [Produkt Kod __ORGID__], '''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
,25003 [Produkt Nazwa __PROCID__], ISNULL(biezacy.Produkt,poprzedni.Produkt) [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]'&#xD;
+ @kolumny +&#xD;
' from &#xD;
( &#xD;
    select &#xD;
            M.MR, SUBSTRING(convert(varchar,M.MR), 0, 5) as Rok, SUBSTRING(convert(varchar,M.MR), 5,6) as Miesiac&#xD;
    from&#xD;
            (&#xD;
                select distinct YEAR(TR.TrN_DataOpe)*100+ MONTH(TR.TrN_DataOpe) as MR  from CDN.TraNag tr&#xD;
                union&#xD;
                select distinct YEAR(TR.TrN_DataOpe)*100+ MONTH(TR.TrN_DataOpe)+100 as MR  from CDN.Tranag tr&#xD;
            )M&#xD;
            &#xD;
) as Miesiace&#xD;
left outer join bu as biezacy on biezacy.MR=Miesiace.MR&#xD;
full outer join bu as poprzedni on poprzedni.MR=Miesiace.MR-100 &#xD;
                and isNull(biezacy.Produkt,1) = case when biezacy.Produkt is null then 1 else poprzedni.Produkt end&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
&#xD;
'&#xD;
&#xD;
exec(@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RAHzthJLfvu07T0UgNHd45wIF/KhvmW1ITcLfChsrjlhVKzbynP8RvBxQXh8lbighUvDFEhOB7vSe4TruXOrElTac/ijhs9M/YF+BZoptWxsEKzvC2/ZqIOfAwcGQ4Tyz0B3FWmM7HzrfhdZnE4tsdvRFcbgDqlVz0w6x/EMhvutGOX8tVX/ww</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Bieżący" caption="Sprzedaż Wartość Bieżący" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Poprzedni" caption="Sprzedaż Wartość Poprzedni" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[b163b73c-dd7e-4bdb-b618-5a347803054c]" caption="Wzrost Sprzedaży" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cb7b40f8-c862-41db-9223-e7dcd41d9ad7]" caption="Wzrost Sprzedaży %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="304" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[b163b73c-dd7e-4bdb-b618-5a347803054c]" caption="Wzrost Sprzedaży" formula="Sprzedaż Wartość Bieżący-Sprzedaż Wartość Poprzedni" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[cb7b40f8-c862-41db-9223-e7dcd41d9ad7]" caption="Wzrost Sprzedaży %" formula="(Sprzedaż Wartość Poprzedni = 0 ? 1 : (Sprzedaż Wartość Bieżący-Sprzedaż Wartość Poprzedni)/Sprzedaż Wartość Poprzedni)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Miesiąc"&gt;&lt;header fontName="Tahoma" fontSize="8" width="137" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość Bieżący"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="139" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość Poprzedni"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="151" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[b163b73c-dd7e-4bdb-b618-5a347803054c]"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="99" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[cb7b40f8-c862-41db-9223-e7dcd41d9ad7]"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="p2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="113" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość Bieżący" index="1" expanded="True" width="139" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Wartość Poprzedni" index="0" expanded="True" width="151" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[b163b73c-dd7e-4bdb-b618-5a347803054c]" index="2" expanded="True" width="99" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[cb7b40f8-c862-41db-9223-e7dcd41d9ad7]" index="3" expanded="True" width="113" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Data Operacji Miesiąc" index="0" expanded="True" width="137" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Data Operacji Rok" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje wzrost sprzedaży w roku bieżącym w stosunku do sprzedaży w roku poprzednim w rozbiciu na miesiące.</a:description><a:id>53</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.17 Wzrost sprzedaży miesięcznie</a:mainLinkName><a:modifiedOn>2025-04-14T10:00:42.937</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>3</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-31T17:16:22.483</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży Rok Do Roku &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @kolumny2 varchar(max)&#xD;
declare @kolumny3 varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
set @kolumny3 = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = ISNULL(biezacy.Poziom' +LTRIM(@i) + ', ISNULL(poprzedni.Poziom' +LTRIM(@i) + ', ''(NIEPRZYPISANE)''))'&#xD;
	set @kolumny2 = @kolumny2 + ',Poz.Poziom' +LTRIM(@i) &#xD;
	set @kolumny3 = @kolumny3 + ',Poz.Poziom' +LTRIM(@i) + ' as Poziom' + +LTRIM(@i)&#xD;
	set @i = @i + 1&#xD;
end;&#xD;
&#xD;
--Właściwe Zapytanie&#xD;
set @select = &#xD;
'with BU as&#xD;
(&#xD;
select &#xD;
SUM(TR.TrE_WartoscNetto) as Wartosc, YEAR(TRN.TrN_DataOpe)*100+ MONTH(TRN.TrN_DataOpe) as MR, Twr_TwrId as Produkt, Twr_Kod as Kod, Twr_Nazwa as Nazwa' + @kolumny3 +&#xD;
' from CDN.TraElem tr&#xD;
JOIN CDN.TraNag trn on trn.TrN_TrNID=TR.TrE_TrNId&#xD;
JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
LEFT OUTER JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = gidNumer&#xD;
WHERE&#xD;
(TrN_TypDokumentu=-1 OR CDN.TypSkojarzenia(TrN_TrNId)=302000 OR CDN.TypSkojarzenia(TrN_TrNId)=302306 OR CDN.TypSkojarzenia(TrN_TrNId)=305000 OR CDN.TypSkojarzenia(TrN_TrNId)=305302) &#xD;
AND TrN_Rodzaj NOT IN (302101,302102,302103)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TR.TrE_Aktywny&lt;&gt;0&#xD;
group by  YEAR(TRN.TrN_DataOpe)*100+ MONTH(TRN.TrN_DataOpe), Twr_TwrId, Twr_Kod, Twr_Nazwa' + @kolumny2 +&#xD;
' ) &#xD;
select &#xD;
"Baza Firmowa" = DB_NAME(),&#xD;
"Data Operacji Rok" = ISNULL(Miesiace.Rok, SUBSTRING(convert(varchar,poprzedni.MR+100), 0, 5)),&#xD;
"Data Operacji Miesiąc" = ISNULL(Miesiace.Miesiac, SUBSTRING(convert(varchar,poprzedni.MR+100), 5,6)),&#xD;
"Sprzedaż Wartość Bieżący" = biezacy.Wartosc, "Sprzedaż Wartość Poprzedni" = poprzedni.Wartosc,  &#xD;
"Produkt Kod" = ISNULL(biezacy.Kod, ISNULL(poprzedni.Kod, ''(PUSTE)'')), "Produkt Nazwa" = ISNULL(biezacy.Nazwa, ISNULL(poprzedni.Nazwa, ''(PUSTE)''))' &#xD;
+ @kolumny +&#xD;
' from &#xD;
( &#xD;
	select &#xD;
			M.MR, SUBSTRING(convert(varchar,M.MR), 0, 5) as Rok, SUBSTRING(convert(varchar,M.MR), 5,6) as Miesiac&#xD;
	from&#xD;
			(&#xD;
				select distinct YEAR(TR.TrN_DataOpe)*100+ MONTH(TR.TrN_DataOpe) as MR  from CDN.TraNag tr&#xD;
				union&#xD;
				select distinct YEAR(TR.TrN_DataOpe)*100+ MONTH(TR.TrN_DataOpe)+100 as MR  from CDN.Tranag tr&#xD;
			)M&#xD;
			&#xD;
) as Miesiace&#xD;
left outer join bu as biezacy on biezacy.MR=Miesiace.MR&#xD;
full outer join bu as poprzedni on poprzedni.MR=Miesiace.MR-100 &#xD;
				and isNull(biezacy.Produkt,1) = case when biezacy.Produkt is null then 1 else poprzedni.Produkt end'&#xD;
&#xD;
exec(@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8sJ7a+Ib5ljeiB+o1CVa8K09VmwT3LHj3ChZA6BezNBwrS1BzJzaTn10QuwI3PMujIBT6U16yWR6Gt6rBj6xMh0cN/xE38i+czy1N+qeZhEJwbJdTVWZo7RtrWNzjM6tZzQ9zLMJBf27+HoUEnugUTGHfv8cmn1LqYI8l10yxoVu/5+89jLa2Ai</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy" caption="Data Analizy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Bieżący" caption="Sprzedaż Wartość Bieżący" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Bieżący" caption="Sprzedaż Ilość Bieżący" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Poprzedni" caption="Sprzedaż Wartość Poprzedni" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Poprzedni" caption="Sprzedaż Ilość Poprzedni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[b163b73c-dd7e-4bdb-b618-5a347803054c]" caption="Wzrost Sprzedaży" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cb7b40f8-c862-41db-9223-e7dcd41d9ad7]" caption="Wzrost Sprzedaży %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wYAAAAHAiRbUHJvZHVrdCBHcnVwYSBQb3ppb20gMV0uW0FLQ0VTT1JJQV0HAilbUHJvZHVrdCBHcnVwYSBQb3ppb20gMV0uW0dydXBhIEfFgsOzd25hXQcCHVtQcm9kdWt0IEdydXBhIFBvemlvbSAxXS5bTDFdBwIlW1Byb2R1a3QgR3J1cGEgUG96aW9tIDFdLltPUEFLT1dBTklBXQcCIltQcm9kdWt0IEdydXBhIFBvemlvbSAxXS5bU1BSWsSYVF0HAiJbUHJvZHVrdCBHcnVwYSBQb3ppb20gMV0uW1VTxYFVR0ld</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;whatifMeasures&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[b163b73c-dd7e-4bdb-b618-5a347803054c]" caption="Wzrost Sprzedaży" formula="Sprzedaż Wartość Bieżący-Sprzedaż Wartość Poprzedni" description="" summaryType="Sum" /&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[cb7b40f8-c862-41db-9223-e7dcd41d9ad7]" caption="Wzrost Sprzedaży %" formula="(Sprzedaż Wartość Poprzedni = 0 ? 1 : (Sprzedaż Wartość Bieżący-Sprzedaż Wartość Poprzedni)/Sprzedaż Wartość Poprzedni)" description="" summaryType="Default" /&gt;&#xD;
  &lt;/whatifMeasures&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions&gt;&#xD;
    &lt;format ref="Data Operacji Rok"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Sprzedaż Wartość Bieżący"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="139" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Sprzedaż Wartość Poprzedni"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="151" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Kod"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Grupa Poziom 1"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="[Measures].[b163b73c-dd7e-4bdb-b618-5a347803054c]"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="123" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="[Measures].[cb7b40f8-c862-41db-9223-e7dcd41d9ad7]"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="p2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="123" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
  &lt;/formatOptions&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields&gt;&#xD;
    &lt;data fieldName="Sprzedaż Wartość Bieżący" index="1" expanded="True" sortMode="default" order="ascending" width="139" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
    &lt;data fieldName="Sprzedaż Wartość Poprzedni" index="0" expanded="True" sortMode="default" order="ascending" width="151" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
    &lt;data fieldName="[Measures].[b163b73c-dd7e-4bdb-b618-5a347803054c]" index="2" expanded="True" sortMode="default" order="ascending" width="123" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Object"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
    &lt;data fieldName="[Measures].[cb7b40f8-c862-41db-9223-e7dcd41d9ad7]" index="3" expanded="True" sortMode="default" order="ascending" width="123" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Object"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
  &lt;/dataFields&gt;&#xD;
  &lt;rowFields&gt;&#xD;
    &lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
    &lt;row fieldName="Produkt Grupa Poziom 1" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
  &lt;/rowFields&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields&gt;&#xD;
    &lt;filter fieldName="Data Operacji Rok" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
  &lt;/filterFields&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje wzrost sprzedaży w roku bieżącym w stosunku do sprzedaży w roku poprzednim w rozbiciu na grupy produktów.</a:description><a:id>54</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.18 Wzrost sprzedaży dla grup produktów</a:mainLinkName><a:modifiedOn>2014-05-27T19:07:31.077</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>3</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-31T17:19:31.19</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
	   "Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
       "Kontrahent Opiekun" = CASE &#xD;
								WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	   "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       "Produkt Nazwa" = Twr_Nazwa, "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   25003 [Produkt Kod __PROCID__], Twr_twrId [Produkt Kod __ORGID__],	   &#xD;
	   "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
	   29056 [Magazyn Nazwa __PROCID__], Mag_MagId [Magazyn Nazwa __ORGID__],&#xD;
	   "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN ( &#xD;
			SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
			FROM CDN.TraElem TRE&#xD;
			JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
				   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
	)KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT "Baza Firmowa" = DB_NAME(), "Dokument Numer" = TrN_NumerPelny, &#xD;
	30392 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	"Dokument Symbol" = SUBSTRING(convert(varchar,TrN_NumerPelny), 0, CHARINDEX(''/'', TrN_NumerPelny)),&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ''(PUSTA)'',&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ''(PUSTA)'',&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, "Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	   20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	   20201 [Kontrahent Kod __PROCID__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
	"Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	"Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
	"Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Kontrahent Opiekun" = CASE &#xD;
							WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
							WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
							ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	"Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, &#xD;
	"Odbiorca Nazwa" = pod3.Pod_Nazwa1, "Odbiorca Kod" = pod3.Pod_Kod, &#xD;
	   20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],&#xD;
	   20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],&#xD;
	"Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
	"Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
	"Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
	"Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
	"Produkt Kategoria" = ''(PUSTA)'',&#xD;
	"Produkt Nazwa" = ''Korekta zbiorcza'', "Produkt Kod" = ''Korekta zbiorcza'', &#xD;
	30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],&#xD;
	30392 [Produkt Kod __PROCID__], TrN_TrNId [Produkt Kod __ORGID__],	   	&#xD;
	"Produkt Numer Katalogowy" = ''Korekta zbiorcza'', "Produkt Pełna Nazwa Grupy" = ''Korekta zbiorcza'', &#xD;
	"Produkt Kaucja" = ''NIE'', "Jednostka Miary" = ''(BRAK)'', "Magazyn Nazwa" = ''(BRAK)'', &#xD;
	30392 [Magazyn Nazwa __PROCID__], TrN_TrNId [Magazyn Nazwa __ORGID__],&#xD;
	"Produkt Producent" = ''(BRAK)'', "Produkt Marka" = ''(BRAK)'',&#xD;
	"Produkt Typ" = ''Korekta zbiorcza'',&#xD;
	"Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
	"Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' END,&#xD;
	"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
	"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
	"Sprzedaż Wartość" = TrN_RazemNetto, "Sprzedaż Wartość Brutto" = TrN_RazemBrutto, "Sprzedaż Wartość Waluta" = TrN_RazemNettoWal, &#xD;
	"Sprzedaż Ilość" = 0, "Koszt Zakupu" = TrN_WartoscZakupu, "Sprzedaż Marża" = TrN_RazemNetto - TrN_WartoscZakupu &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RAHzthJLfvu07T0UgNHd45wIF/KhvmW1ITcLfChsrjlhVKzbynP8Rvc0Pv1WfvD7mejwrzIohjvauoWjwfwS5N/M22SwnYlnFxSvFmPQah+Wvp9Yx6P/re014WvQrDVaWJRbBWxS3kHSpcGyONC6y/diMyv/LVhSik86rAclvKLJ+ZrdYpaw7m</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS" caption="Dokument Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAHAAAABwImW0tvbnRyYWhlbnQgT3BpZWt1bl0uWyhOSUVQUlpZUElTQU5FKV0HAiZbS29udHJhaGVudCBPcGlla3VuXS5bQUdBVEFfS1JBS09XU0tBXQcCIltLb250cmFoZW50IE9waWVrdW5dLltBTk5BX1NMT1dJS10HAidbS29udHJhaGVudCBPcGlla3VuXS5bSkFOVVNaX0tSQUtPV1NLSV0HAiZbS29udHJhaGVudCBPcGlla3VuXS5bSk9BTk5BX0JBQklOU0tBXQcCIltLb250cmFoZW50IE9waWVrdW5dLltST0JFUlRfWkFNQV0HAiRbS29udHJhaGVudCBPcGlla3VuXS5bUk9CRVJUX1pBTUFfMV3/////AAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="122" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Opiekun"&gt;&lt;header fontName="Tahoma" fontSize="8" width="130" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="136" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" width="136" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="1" expanded="True" width="122" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Opiekun" index="0" expanded="True" width="130" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż w podziale na opiekunów kontrahentów.</a:description><a:id>55</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.19 Sprzedaż dla opiekunów kontrahentów</a:mainLinkName><a:modifiedOn>2014-05-27T19:07:38.313</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-31T17:37:21.947</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Ranking produktów bez sprzedaży&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
	 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],&#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary],  &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0 - ([TrE_CenaW]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] &#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,CAST(REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', '''') AS INT) [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
   LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT DB_NAME() [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],   &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod],    &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU],&#xD;
    ''(BRAK)'' [Produkt Dostawca],  &#xD;
    ''Korekta zbiorcza'' [Produkt Kod],&#xD;
    ''(BRAK)'' [Produkt Aktywny],           &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary],     &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], TrN_WartoscZakupu [Koszt Zakupu], TrN_RazemNetto - TrN_WartoscZakupu [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,CAST(REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', '''') AS INT) [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/  &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
    &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
&#xD;
	 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="measure" formatString="" aggregate="Max" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAZAAAABwIdW1Byb2R1a3QgS29kXS5bVE9XQVJURVNGQUZaM10HAh1bUHJvZHVrdCBLb2RdLltUT1dBUlRFU1RGQUZaXQcCHltQcm9kdWt0IEtvZF0uW1RPV0FSVEVTVEZBRloyXQcCFltQcm9kdWt0IEtvZF0uW1NUT0pBS10HAhdbUHJvZHVrdCBLb2RdLltTWlBBREVMXQcCGltQcm9kdWt0IEtvZF0uW1RFU1RLT1JFS1RdBwIUW1Byb2R1a3QgS29kXS5bWkRQWl0HAhdbUHJvZHVrdCBLb2RdLltaRVNUQVcyXQcCGFtQcm9kdWt0IEtvZF0uW1pJRU1JQV81XQcCIFtQcm9kdWt0IEtvZF0uW1RPV0FSV09QQUtPV0FOSVVdBwIXW1Byb2R1a3QgS29kXS5bVFVKRV8zTF0HAiFbUHJvZHVrdCBLb2RdLltVU8WBVUdBIFNFUldJU09XQV0HAhdbUHJvZHVrdCBLb2RdLltTRUtBVE9SXQcCGVtQcm9kdWt0IEtvZF0uW05PV1lUT1dBUl0HAhtbUHJvZHVrdCBLb2RdLltOT8W7WUNFX0VMLl0HAhpbUHJvZHVrdCBLb2RdLltPREtfTEnFmkNJXQcCE1tQcm9kdWt0IEtvZF0uW0FBQV0HAh5bUHJvZHVrdCBLb2RdLltHUkFCSUVfTEnFmkNJRV0HAiBbUHJvZHVrdCBLb2RdLltLb3Jla3RhIHpiaW9yY3phXQcCHFtQcm9kdWt0IEtvZF0uW1BST0pfWklFTEVOSV0HAhlbUHJvZHVrdCBLb2RdLltSw5PFu0FfUE5dBwIYW1Byb2R1a3QgS29kXS5bU0FEWk9OS0ldBwIWW1Byb2R1a3QgS29kXS5bUEFMRVRBXQcCHFtQcm9kdWt0IEtvZF0uW1BJRUzEmEdOQUNKQV0HAhpbUHJvZHVrdCBLb2RdLltQUk9KX0FSQ0hJXf////8AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8" width="260" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="149" top="25" topType="BottomAbsolute" dataField="Data Operacji Dzień" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Dzień"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="155" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Data Operacji Dzień" index="0" expanded="True" sortMode="default" order="ascending" width="155" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Nazwa" index="1" expanded="True" sortMode="default" order="ascending" width="260" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="displayText" order="ascending" width="149" top="25" topType="BottomAbsolute" dataField="Data Operacji Dzień" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy dataFieldName="Data Operacji Dzień" /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę produktów posortowanych rosnąco po dacie ostatniej odnotowanej na nich transakcji.</a:description><a:id>56</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.20 Ranking produktów bez sprzedaży</a:mainLinkName><a:modifiedOn>2025-05-23T17:33:16.313</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-31T17:45:00.447</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Ranking kontrahentów bez sprzedaży&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],&#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary],  &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0 - ([TrE_CenaW]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] &#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,CAST(REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', '''') AS INT) [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj in (312000,312008) AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308,301 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],   &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod],    &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU],&#xD;
    ''(BRAK)'' [Produkt Dostawca],  &#xD;
    ''Korekta zbiorcza'' [Produkt Kod],&#xD;
    ''(BRAK)'' [Produkt Aktywny],           &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary],     &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], TrN_WartoscZakupu [Koszt Zakupu], TrN_RazemNetto - TrN_WartoscZakupu [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,CAST(REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', '''') AS INT) [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/  &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
    &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="measure" formatString="n2" aggregate="Max" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut WARUNKI DOSTAWY" caption="Kontrahent Pierwotny Atrybut WARUNKI DOSTAWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut WARUNKI DOSTAWY" caption="Kontrahent Atrybut WARUNKI DOSTAWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 2.WARUNKI DOSTAWY" caption="Dokument Atrybut 2.WARUNKI DOSTAWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut WARUNKI DOSTAWY (K)" caption="Dokument Atrybut WARUNKI DOSTAWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR FS" caption="Produkt Atrybut NR FS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut WILGOTNOSC" caption="Produkt Atrybut WILGOTNOSC" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR FS" caption="Pozycja Atrybut NR FS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut WILGOTNOSC" caption="Pozycja Atrybut WILGOTNOSC" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////xkAAAAHAhdbS29udHJhaGVudCBLb2RdLlswNDY5XQcCF1tLb250cmFoZW50IEtvZF0uWzA0OTJdBwIXW0tvbnRyYWhlbnQgS29kXS5bMDUwMl0HAhdbS29udHJhaGVudCBLb2RdLlswNDE5XQcCF1tLb250cmFoZW50IEtvZF0uWzA0MzBdBwIXW0tvbnRyYWhlbnQgS29kXS5bMDQzMl0HAhdbS29udHJhaGVudCBLb2RdLlswNTUwXQcCF1tLb250cmFoZW50IEtvZF0uWzA1NTddBwIXW0tvbnRyYWhlbnQgS29kXS5bMDU4MV0HAhdbS29udHJhaGVudCBLb2RdLlswNTIwXQcCF1tLb250cmFoZW50IEtvZF0uWzA1MjJdBwIXW0tvbnRyYWhlbnQgS29kXS5bMDU0NV0HAhdbS29udHJhaGVudCBLb2RdLlswNDE0XQcCF1tLb250cmFoZW50IEtvZF0uWzAzNTRdBwIXW0tvbnRyYWhlbnQgS29kXS5bMDM1OF0HAhdbS29udHJhaGVudCBLb2RdLlswMzYxXQcCF1tLb250cmFoZW50IEtvZF0uWzAxMzddBwIXW0tvbnRyYWhlbnQgS29kXS5bMDI1Ml0HAhdbS29udHJhaGVudCBLb2RdLlswMzUzXQcCF1tLb250cmFoZW50IEtvZF0uWzAzODVdBwIXW0tvbnRyYWhlbnQgS29kXS5bMDQwOF0HAhdbS29udHJhaGVudCBLb2RdLlswNDEzXQcCF1tLb250cmFoZW50IEtvZF0uWzAzNjVdBwIXW0tvbnRyYWhlbnQgS29kXS5bMDM2Nl0HAhdbS29udHJhaGVudCBLb2RdLlswMzc5XQ==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8" width="258" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="139" top="25" topType="BottomAbsolute" dataField="Data Operacji Dzień" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Dzień"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Data Operacji Dzień" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Nazwa" index="1" expanded="True" sortMode="default" order="ascending" width="258" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="displayText" order="ascending" width="139" top="25" topType="BottomAbsolute" dataField="Data Operacji Dzień" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy dataFieldName="Data Operacji Dzień" /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje ranking kontrahentów posortowanych po dacie ich ostatniego zakupu.</a:description><a:id>57</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.21 Ranking kontrahentów bez sprzedaży</a:mainLinkName><a:modifiedOn>2024-09-09T09:49:37.057</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-04-20T17:50:50.883</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Handlowy&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
declare @wartosc1 varchar(20);&#xD;
set @wartosc1 = case when @wartosc = 'Wartość Netto' then 'Tre_WartoscNetto' else 'Tre_WartoscZakupu' end;&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @kolumny2 varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @kolumny2 = @kolumny2 + ',Poz.Poziom' +LTRIM(@i)&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select =&#xD;
'SELECT &#xD;
	DB_NAME() [Baza Firmowa], &#xD;
	&#xD;
	MAX(Twr_Kod) [Produkt Kod], &#xD;
	25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],	'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__],&#xD;
	&#xD;
	MAX(Twr_Nazwa) [Produkt Nazwa],&#xD;
	CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
	ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
	CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
	25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__],&#xD;
	ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
	MAX(CASE&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
		ELSE ''(NIEOKREŚLONY)''&#xD;
	END) [Produkt Typ],&#xD;
	ISNULL(MAX(Kat_KodOgolny),''(NIEOKREŚLONA)'')  [Produkt Kategoria Ogólna], ISNULL(MAX(Kat_KodSzczegol),''(NIEOKREŚLONA)'') [Produkt Kategoria Szczegółowa], MAX(Twr_JM) [Jednostka Miary], &#xD;
	"Ilość Stan Początkowy H"=0, "Ilość Stan Początkowy M"=0, &#xD;
&#xD;
	"Ilość FZ"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Ilość FS"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Ilość PA"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Ilość PZ"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Ilość PKA"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Ilość PW"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM OL"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Ilość WZ"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Ilość WKA"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Ilość RW"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM LO"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	"Ilość MM"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
&#xD;
	"Ilość Stan Początkowy H Jednostka Pomocnicza"=0, "Ilość Stan Początkowy M Jednostka Pomocnicza"=0, &#xD;
	"Ilość FZ Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Ilość FS Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Ilość PA Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Ilość PZ Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Ilość PKA Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Ilość PW Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM OL Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Ilość WZ Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Ilość WKA Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Ilość RW Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM LO Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	"Ilość MM Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
&#xD;
	"Wartość Stan Początkowy H"=0, "Wartość Stan Początkowy M"=0, &#xD;
	"Wartość FZ"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Wartość FS"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Wartość PA"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Wartość PZ"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Wartość PKA"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Wartość PW"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Wartość MM OL"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Wartość WZ"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Wartość WKA"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Wartość RW"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Wartość MM LO"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	&#xD;
	"Wartość MM"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END)&#xD;
' + @kolumny + &#xD;
' FROM CDN.Towary&#xD;
	LEFT OUTER JOIN cdn.TraElem ON TrE_TwrID=Twr_TwrID&#xD;
	LEFT OUTER JOIN cdn.TraNag  ON TrN_TrNID=TrE_TrNID&#xD;
	LEFT OUTER JOIN cdn.Magazyny ON Mag_MagID=TrN_MagZrdID&#xD;
	LEFT OUTER JOIN cdn.Kategorie ON Kat_KatID=Twr_KatID&#xD;
	LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
	LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
WHERE (TrN_Bufor&lt;&gt;-1  &#xD;
--AND TrN_Korekta IN (0,1) &#xD;
OR TrN_TrNID IS NULL)&#xD;
	AND (((TrE_TypDokumentu IN (302,304,305,306,314,318) OR TrN_Rodzaj IN (312100)&#xD;
	OR ((TrE_TypDokumentu IN (301,310,303,307,313,317) OR TrN_Rodzaj IN (312010) OR TrN_Rodzaj IN (312000,312001,312008)) AND TrN_Bufor=0)) &#xD;
	AND TrE_Aktywny&lt;&gt;0)	OR TrE_TrEID IS NULL)&#xD;
	AND (TrN_DataOpe BETWEEN CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD,120) + ''',120) AND CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATADO,120) + ''',120) OR TrE_TrEID IS NULL)  &#xD;
GROUP BY Twr_TwrID, Twr_NieAktywny, TWR_SWW, knt4.Knt_Kod, Twr_JMZ' + @kolumny2 + '&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
	DB_NAME() [Baza Firmowa], &#xD;
	&#xD;
	MAX(Twr_Kod) [Produkt Kod], &#xD;
	25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],	'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__],&#xD;
	&#xD;
	MAX(Twr_Nazwa) [Produkt Nazwa],&#xD;
	CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
	ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
	CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
	25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],	'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__],&#xD;
	ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
	MAX(CASE&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
		ELSE ''(NIEOKREŚLONY)''&#xD;
	END) [Produkt Typ],&#xD;
	ISNULL(MAX(Kat_KodOgolny),''(NIEOKREŚLONA)'') [Produkt Kategoria Ogólna], ISNULL(MAX(Kat_KodSzczegol),''(NIEOKREŚLONA)'')  [Produkt Kategoria Szczegółowa], MAX(Twr_JM) [Jednostka Miary], &#xD;
	"Ilość Stan Początkowy H"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END), &#xD;
	"Ilość Stan Początkowy M"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END), &#xD;
	"Ilość FZ"=0, "Ilość FS"=0,	"Ilość PA"=0, "Ilość PZ"=0,	"Ilość PKA"=0, "Ilość PW"=0, "Ilość MM OL"=0, "Ilość WZ"=0,	"Ilość WKA"=0, "Ilość RW"=0, "Ilość MM LO"=0,&#xD;
	"Ilość MM" = 0,&#xD;
	"Ilość Stan Początkowy H Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END),&#xD;
	 "Ilość Stan Początkowy M Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END),  &#xD;
	"Ilość FZ Jednostka Pomocnicza"=0, "Ilość FS Jednostka Pomocnicza"=0,	"Ilość PA Jednostka Pomocnicza"=0, "Ilość PZ Jednostka Pomocnicza"=0,	"Ilość PKA Jednostka Pomocnicza"=0, "Ilość PW Jednostka Pomocnicza"=0, "Ilość MM OL Jednostka Pomocnicza"=0, &#xD;
	"Ilość WZ Jednostka Pomocnicza"=0,	"Ilość WKA Jednostka Pomocnicza"=0, "Ilość RW Jednostka Pomocnicza"=0, "Ilość MM LO Jednostka Pomocnicza"=0,&#xD;
	"Ilość MM Jednostka Pomocnicza" = 0,&#xD;
	"Wartość Stan Początkowy H"=SUM(IsNull(' + @wartosc1 + ',''0'')*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END), &#xD;
	"Wartość Stan Początkowy M"=SUM(IsNull(' + @wartosc1 + ',''0'')*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317,312) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END), &#xD;
	"Wartość FZ"=0, "Wartość FS"=0,	"Wartość PA"=0, "Wartość PZ"=0, "Wartość PKA"=0, "Wartość PW"=0, "Wartość MM OL"=0,	"Wartość WZ"=0,	"Wartość WKA"=0, "Wartość RW"=0, "Wartość MM LO"=0,&#xD;
	"Wartość MM"=0&#xD;
' + @kolumny + &#xD;
' FROM CDN.Towary&#xD;
	LEFT OUTER JOIN cdn.TraElem ON TrE_TwrID=Twr_TwrID&#xD;
	LEFT OUTER JOIN cdn.TraNag  ON TrN_TrNID=TrE_TrNID&#xD;
	LEFT OUTER JOIN cdn.Magazyny ON Mag_MagID=TrN_MagZrdID&#xD;
	LEFT OUTER JOIN cdn.Kategorie ON Kat_KatID=Twr_KatID&#xD;
	LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
	LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
WHERE (TrN_Bufor&lt;&gt;-1 &#xD;
--AND TrN_Korekta IN (0,1) &#xD;
OR TrN_TrNID IS NULL)&#xD;
	AND (((TrE_TypDokumentu IN (302,304,305,306,314,318) OR TrN_Rodzaj IN (312100)&#xD;
	OR ((TrE_TypDokumentu IN (301,310,303,307,313,317) OR TrN_Rodzaj IN (312010) OR TrN_Rodzaj IN (312000,312001,312008)) AND TrN_Bufor=0)) &#xD;
	AND TrE_Aktywny&lt;&gt;0)	OR TrE_TrEID IS NULL)&#xD;
	AND (TrN_DataOpe &lt; CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD, 120) + ''',120) OR TrE_TrEID IS NULL)  &#xD;
GROUP BY Twr_TwrID, Twr_NieAktywny, TWR_SWW, knt4.Knt_Kod, Twr_JMZ' + @kolumny2&#xD;
&#xD;
exec (@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QHRUwalZ8pMVJl4bnvAvbQJZcV6Wn+9eyurT5z7pvsx453uBpU8ZVZBU3sxojq0nr7SEb6pIcBltbZneCkQXihh2PJK4OnljQYqeZz6oFgeKpqUN1a0P8/X1EVgEjUyAynh2e+VUqmLaTxvo2adC1y/WjNl2Vo5HaL2i46mtibOu7HvVCLZ13K</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Ogólna" caption="Produkt Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Szczegółowa" caption="Produkt Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy H" caption="Ilość Stan Początkowy H" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy M" caption="Ilość Stan Początkowy M" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FZ" caption="Ilość FZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FS" caption="Ilość FS" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PA" caption="Ilość PA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PZ" caption="Ilość PZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PKA" caption="Ilość PKA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PW" caption="Ilość PW" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM OL" caption="Ilość MM OL" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WZ" caption="Ilość WZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WKA" caption="Ilość WKA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość RW" caption="Ilość RW" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM LO" caption="Ilość MM LO" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM" caption="Ilość MM" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy H Jednostka Pomocnicza" caption="Ilość Stan Początkowy H Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy M Jednostka Pomocnicza" caption="Ilość Stan Początkowy M Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FZ Jednostka Pomocnicza" caption="Ilość FZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FS Jednostka Pomocnicza" caption="Ilość FS Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PA Jednostka Pomocnicza" caption="Ilość PA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PZ Jednostka Pomocnicza" caption="Ilość PZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PKA Jednostka Pomocnicza" caption="Ilość PKA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PW Jednostka Pomocnicza" caption="Ilość PW Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM OL Jednostka Pomocnicza" caption="Ilość MM OL Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WZ Jednostka Pomocnicza" caption="Ilość WZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WKA Jednostka Pomocnicza" caption="Ilość WKA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość RW Jednostka Pomocnicza" caption="Ilość RW Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM LO Jednostka Pomocnicza" caption="Ilość MM LO Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM Jednostka Pomocnicza" caption="Ilość MM Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Stan Początkowy H" caption="Wartość Stan Początkowy H" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Stan Początkowy M" caption="Wartość Stan Początkowy M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość FZ" caption="Wartość FZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość FS" caption="Wartość FS" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PA" caption="Wartość PA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PZ" caption="Wartość PZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PKA" caption="Wartość PKA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PW" caption="Wartość PW" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM OL" caption="Wartość MM OL" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość WZ" caption="Wartość WZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość WKA" caption="Wartość WKA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość RW" caption="Wartość RW" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM LO" caption="Wartość MM LO" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM" caption="Wartość MM" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" caption="Ilość Stan Końcowy M" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" caption="Ilość Stan Końcowy H" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" caption="Wartość Stan Końcowy M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" caption="Wartość Stan Końcowy H" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[181be47b-ee11-4e2b-8156-9ec187b983f3]" caption="Przychód Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[e6485a6b-23c5-49c8-b320-480299d8f79a]" caption="Przychód Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[d4bad69d-ee14-4b67-82f4-be5b58801ce0]" caption="Rozchód Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[4e2d8baf-1300-45d7-b7f7-bbe999e66809]" caption="Rozchód Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[e0755fa4-408d-45d3-a3cc-c3fdd16114a0]" caption="Ilość Stan Końcowy H Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[756f4713-3261-4d56-85f3-4fd748ffefc3]" caption="Ilość Stan Końcowy M Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[6c5b0e50-b645-4138-85c5-9f68085ed4b2]" caption="Przychód Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[dcaef927-08f6-429b-9c3f-64c44a9ce98f]" caption="Rozchód Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Od dnia:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początkowa okresu analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-04-09&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Do dnia:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data końcowa okresu analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-05-09&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;WARTOSC&lt;/Name&gt;&#xD;
    &lt;Label&gt;Wartość&lt;/Label&gt;&#xD;
    &lt;Expression&gt;'Wartość Netto'; 'Wartość Zakupu'
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue /&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAeAAAABwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIaW1Byb2R1a3QgS29kXS5bR1JBQklFX09HUl0HAh1bUHJvZHVrdCBLb2RdLltJR0xBS0lfQ1lQUllTXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIZW1Byb2R1a3QgS29kXS5bSkFCxYFPTklFXQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCIltQcm9kdWt0IEtvZF0uW8WBQcWDQ1VDSCBETyBQScWBWV0HAhlbUHJvZHVrdCBLb2RdLltOT1dZVE9XQVJdBwIbW1Byb2R1a3QgS29kXS5bTk/Fu1lDRV9FTC5dBwIaW1Byb2R1a3QgS29kXS5bT0RLX0xJxZpDSV0HAhZbUHJvZHVrdCBLb2RdLltQQUxFVEFdBwIcW1Byb2R1a3QgS29kXS5bUElFTMSYR05BQ0pBXQcCHFtQcm9kdWt0IEtvZF0uW1BJxYFBX0VMRUtUUl0HAh9bUHJvZHVrdCBLb2RdLltQScWBQV9TUEFMSU5PV0FdBwIaW1Byb2R1a3QgS29kXS5bUFJPSl9BUkNISV0HAhxbUHJvZHVrdCBLb2RdLltQUk9KX1pJRUxFTkldBwIcW1Byb2R1a3QgS29kXS5bUk9aRFJBQk5JQUNaXQcCGVtQcm9kdWt0IEtvZF0uW1LDk8W7QV9QTl0HAhhbUHJvZHVrdCBLb2RdLltTQURaT05LSV0HAhdbUHJvZHVrdCBLb2RdLltTRUtBVE9SXQcCGFtQcm9kdWt0IEtvZF0uW1NLUlpZTktBXQcCFltQcm9kdWt0IEtvZF0uW1NUT0pBS10HAhdbUHJvZHVrdCBLb2RdLltTWlBBREVMXQcCGltQcm9kdWt0IEtvZF0uW1RFU1RLT1JFS1RdBwIgW1Byb2R1a3QgS29kXS5bVE9XQVJXT1BBS09XQU5JVV0HAhdbUHJvZHVrdCBLb2RdLltUVUpFXzNMXQcCIVtQcm9kdWt0IEtvZF0uW1VTxYFVR0EgU0VSV0lTT1dBXQcCGltQcm9kdWt0IEtvZF0uW1pFU1RBV19PR1JdBwIXW1Byb2R1a3QgS29kXS5bWkVTVEFXMl0HAhhbUHJvZHVrdCBLb2RdLltaSUVNSUFfNV3/////AAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="244" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" caption="Ilość Stan Końcowy M" formula="Ilość Stan Początkowy M + Ilość PZ + Ilość PKA + Ilość PW + Ilość MM OL - Ilość WZ - Ilość WKA - Ilość RW - Ilość MM LO" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" caption="Ilość Stan Końcowy H" formula="Ilość Stan Początkowy H + Ilość FZ - Ilość FS - Ilość PA" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" caption="Wartość Stan Końcowy M" formula="Wartość Stan Początkowy M + Wartość PZ + Wartość PKA + Wartość PW + Wartość MM OL - Wartość WZ - Wartość WKA - Wartość RW - Wartość MM LO" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" caption="Wartość Stan Końcowy H" formula="Wartość Stan Początkowy H + Wartość FZ - Wartość FS - Wartość PA" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="145" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="190" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość Stan Początkowy H"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="129" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość FZ"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość FS"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość PA"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="115" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Ilość Stan Początkowy H" index="0" expanded="True" width="129" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość FZ" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość FS" index="2" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość PA" index="3" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" index="4" expanded="True" width="115" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" width="145" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Nazwa" index="1" expanded="True" width="190" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje ilość kupionych i sprzedanych towarów na podstawie dokumentów handlowych</a:description><a:id>58</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.22 Raport handlowy towarów dla dokumentów handlowych ilościowo</a:mainLinkName><a:modifiedOn>2021-05-11T10:56:04.817</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>17</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>3</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-04-20T17:52:16.82</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Handlowy&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
declare @wartosc1 varchar(20);&#xD;
set @wartosc1 = case when @wartosc = 'Wartość Netto' then 'Tre_WartoscNetto' else 'Tre_WartoscZakupu' end;&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @kolumny2 varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @kolumny2 = @kolumny2 + ',Poz.Poziom' +LTRIM(@i)&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select =&#xD;
'SELECT &#xD;
	DB_NAME() [Baza Firmowa], &#xD;
	&#xD;
	MAX(Twr_Kod) [Produkt Kod], &#xD;
	25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],	'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__],&#xD;
	&#xD;
	MAX(Twr_Nazwa) [Produkt Nazwa],&#xD;
	CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
	ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
	CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
	25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__],&#xD;
	ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
	MAX(CASE&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
		ELSE ''(NIEOKREŚLONY)''&#xD;
	END) [Produkt Typ],&#xD;
	ISNULL(MAX(Kat_KodOgolny),''(NIEOKREŚLONA)'')  [Produkt Kategoria Ogólna], ISNULL(MAX(Kat_KodSzczegol),''(NIEOKREŚLONA)'') [Produkt Kategoria Szczegółowa], MAX(Twr_JM) [Jednostka Miary], &#xD;
	"Ilość Stan Początkowy H"=0, "Ilość Stan Początkowy M"=0, &#xD;
&#xD;
	"Ilość FZ"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Ilość FS"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Ilość PA"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Ilość PZ"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Ilość PKA"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Ilość PW"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM OL"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Ilość WZ"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Ilość WKA"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Ilość RW"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM LO"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	"Ilość MM"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
&#xD;
	"Ilość Stan Początkowy H Jednostka Pomocnicza"=0, "Ilość Stan Początkowy M Jednostka Pomocnicza"=0, &#xD;
	"Ilość FZ Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Ilość FS Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Ilość PA Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Ilość PZ Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Ilość PKA Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Ilość PW Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM OL Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Ilość WZ Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Ilość WKA Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Ilość RW Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM LO Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	"Ilość MM Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
&#xD;
	"Wartość Stan Początkowy H"=0, "Wartość Stan Początkowy M"=0, &#xD;
	"Wartość FZ"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Wartość FS"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Wartość PA"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Wartość PZ"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Wartość PKA"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Wartość PW"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Wartość MM OL"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Wartość WZ"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Wartość WKA"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Wartość RW"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Wartość MM LO"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	&#xD;
	"Wartość MM"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END)&#xD;
' + @kolumny + &#xD;
' FROM CDN.Towary&#xD;
	LEFT OUTER JOIN cdn.TraElem ON TrE_TwrID=Twr_TwrID&#xD;
	LEFT OUTER JOIN cdn.TraNag  ON TrN_TrNID=TrE_TrNID&#xD;
	LEFT OUTER JOIN cdn.Magazyny ON Mag_MagID=TrN_MagZrdID&#xD;
	LEFT OUTER JOIN cdn.Kategorie ON Kat_KatID=Twr_KatID&#xD;
	LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
	LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
WHERE (TrN_Bufor&lt;&gt;-1  &#xD;
--AND TrN_Korekta IN (0,1) &#xD;
OR TrN_TrNID IS NULL)&#xD;
	AND (((TrE_TypDokumentu IN (302,304,305,306,314,318) OR TrN_Rodzaj IN (312100)&#xD;
	OR ((TrE_TypDokumentu IN (301,310,303,307,313,317) OR TrN_Rodzaj IN (312010) OR TrN_Rodzaj IN (312000,312001,312008)) AND TrN_Bufor=0)) &#xD;
	AND TrE_Aktywny&lt;&gt;0)	OR TrE_TrEID IS NULL)&#xD;
	AND (TrN_DataOpe BETWEEN CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD,120) + ''',120) AND CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATADO,120) + ''',120) OR TrE_TrEID IS NULL)  &#xD;
GROUP BY Twr_TwrID, Twr_NieAktywny, TWR_SWW, knt4.Knt_Kod, Twr_JMZ' + @kolumny2 + '&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
	DB_NAME() [Baza Firmowa], &#xD;
	&#xD;
	MAX(Twr_Kod) [Produkt Kod], &#xD;
	25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],	'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__],&#xD;
	&#xD;
	MAX(Twr_Nazwa) [Produkt Nazwa],&#xD;
	CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
	ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
	CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
	25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],	'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__],&#xD;
	ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
	MAX(CASE&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
		ELSE ''(NIEOKREŚLONY)''&#xD;
	END) [Produkt Typ],&#xD;
	ISNULL(MAX(Kat_KodOgolny),''(NIEOKREŚLONA)'') [Produkt Kategoria Ogólna], ISNULL(MAX(Kat_KodSzczegol),''(NIEOKREŚLONA)'')  [Produkt Kategoria Szczegółowa], MAX(Twr_JM) [Jednostka Miary], &#xD;
	"Ilość Stan Początkowy H"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END), &#xD;
	"Ilość Stan Początkowy M"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END), &#xD;
	"Ilość FZ"=0, "Ilość FS"=0,	"Ilość PA"=0, "Ilość PZ"=0,	"Ilość PKA"=0, "Ilość PW"=0, "Ilość MM OL"=0, "Ilość WZ"=0,	"Ilość WKA"=0, "Ilość RW"=0, "Ilość MM LO"=0,&#xD;
	"Ilość MM" = 0,&#xD;
	"Ilość Stan Początkowy H Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END),&#xD;
	 "Ilość Stan Początkowy M Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END),  &#xD;
	"Ilość FZ Jednostka Pomocnicza"=0, "Ilość FS Jednostka Pomocnicza"=0,	"Ilość PA Jednostka Pomocnicza"=0, "Ilość PZ Jednostka Pomocnicza"=0,	"Ilość PKA Jednostka Pomocnicza"=0, "Ilość PW Jednostka Pomocnicza"=0, "Ilość MM OL Jednostka Pomocnicza"=0, &#xD;
	"Ilość WZ Jednostka Pomocnicza"=0,	"Ilość WKA Jednostka Pomocnicza"=0, "Ilość RW Jednostka Pomocnicza"=0, "Ilość MM LO Jednostka Pomocnicza"=0,&#xD;
	"Ilość MM Jednostka Pomocnicza" = 0,&#xD;
	"Wartość Stan Początkowy H"=SUM(IsNull(' + @wartosc1 + ',''0'')*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END), &#xD;
	"Wartość Stan Początkowy M"=SUM(IsNull(' + @wartosc1 + ',''0'')*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317,312) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END), &#xD;
	"Wartość FZ"=0, "Wartość FS"=0,	"Wartość PA"=0, "Wartość PZ"=0, "Wartość PKA"=0, "Wartość PW"=0, "Wartość MM OL"=0,	"Wartość WZ"=0,	"Wartość WKA"=0, "Wartość RW"=0, "Wartość MM LO"=0,&#xD;
	"Wartość MM"=0&#xD;
' + @kolumny + &#xD;
' FROM CDN.Towary&#xD;
	LEFT OUTER JOIN cdn.TraElem ON TrE_TwrID=Twr_TwrID&#xD;
	LEFT OUTER JOIN cdn.TraNag  ON TrN_TrNID=TrE_TrNID&#xD;
	LEFT OUTER JOIN cdn.Magazyny ON Mag_MagID=TrN_MagZrdID&#xD;
	LEFT OUTER JOIN cdn.Kategorie ON Kat_KatID=Twr_KatID&#xD;
	LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
	LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
WHERE (TrN_Bufor&lt;&gt;-1 &#xD;
--AND TrN_Korekta IN (0,1) &#xD;
OR TrN_TrNID IS NULL)&#xD;
	AND (((TrE_TypDokumentu IN (302,304,305,306,314,318) OR TrN_Rodzaj IN (312100)&#xD;
	OR ((TrE_TypDokumentu IN (301,310,303,307,313,317) OR TrN_Rodzaj IN (312010) OR TrN_Rodzaj IN (312000,312001,312008)) AND TrN_Bufor=0)) &#xD;
	AND TrE_Aktywny&lt;&gt;0)	OR TrE_TrEID IS NULL)&#xD;
	AND (TrN_DataOpe &lt; CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD, 120) + ''',120) OR TrE_TrEID IS NULL)  &#xD;
GROUP BY Twr_TwrID, Twr_NieAktywny, TWR_SWW, knt4.Knt_Kod, Twr_JMZ' + @kolumny2&#xD;
&#xD;
exec (@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QHRUwalZ8pMVJl4bnvAvbQJZcV6Wn+9eyurT5z7pvsx453uBpU8ZVZBU3sxojq0nr7SEb6pIcBltbZneCkQXihh2PJK4OnljQYqeZz6oFgeKpqUN1a0P8/X1EVgEjUyAynh2e+VUqmLaTxvo2adC1y/WjNl2Vo5HaL2i46mtibOu7HvVCLZ13K</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Ogólna" caption="Produkt Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Szczegółowa" caption="Produkt Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy H" caption="Ilość Stan Początkowy H" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy M" caption="Ilość Stan Początkowy M" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FZ" caption="Ilość FZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FS" caption="Ilość FS" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PA" caption="Ilość PA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PZ" caption="Ilość PZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PKA" caption="Ilość PKA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PW" caption="Ilość PW" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM OL" caption="Ilość MM OL" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WZ" caption="Ilość WZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WKA" caption="Ilość WKA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość RW" caption="Ilość RW" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM LO" caption="Ilość MM LO" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM" caption="Ilość MM" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy H Jednostka Pomocnicza" caption="Ilość Stan Początkowy H Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy M Jednostka Pomocnicza" caption="Ilość Stan Początkowy M Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FZ Jednostka Pomocnicza" caption="Ilość FZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FS Jednostka Pomocnicza" caption="Ilość FS Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PA Jednostka Pomocnicza" caption="Ilość PA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PZ Jednostka Pomocnicza" caption="Ilość PZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PKA Jednostka Pomocnicza" caption="Ilość PKA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PW Jednostka Pomocnicza" caption="Ilość PW Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM OL Jednostka Pomocnicza" caption="Ilość MM OL Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WZ Jednostka Pomocnicza" caption="Ilość WZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WKA Jednostka Pomocnicza" caption="Ilość WKA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość RW Jednostka Pomocnicza" caption="Ilość RW Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM LO Jednostka Pomocnicza" caption="Ilość MM LO Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM Jednostka Pomocnicza" caption="Ilość MM Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Stan Początkowy H" caption="Wartość Stan Początkowy H" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Stan Początkowy M" caption="Wartość Stan Początkowy M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość FZ" caption="Wartość FZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość FS" caption="Wartość FS" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PA" caption="Wartość PA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PZ" caption="Wartość PZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PKA" caption="Wartość PKA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PW" caption="Wartość PW" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM OL" caption="Wartość MM OL" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość WZ" caption="Wartość WZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość WKA" caption="Wartość WKA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość RW" caption="Wartość RW" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM LO" caption="Wartość MM LO" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM" caption="Wartość MM" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" caption="Ilość Stan Końcowy M" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" caption="Ilość Stan Końcowy H" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" caption="Wartość Stan Końcowy M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" caption="Wartość Stan Końcowy H" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[181be47b-ee11-4e2b-8156-9ec187b983f3]" caption="Przychód Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[e6485a6b-23c5-49c8-b320-480299d8f79a]" caption="Przychód Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[d4bad69d-ee14-4b67-82f4-be5b58801ce0]" caption="Rozchód Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[4e2d8baf-1300-45d7-b7f7-bbe999e66809]" caption="Rozchód Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[e0755fa4-408d-45d3-a3cc-c3fdd16114a0]" caption="Ilość Stan Końcowy H Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[756f4713-3261-4d56-85f3-4fd748ffefc3]" caption="Ilość Stan Końcowy M Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[6c5b0e50-b645-4138-85c5-9f68085ed4b2]" caption="Przychód Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[dcaef927-08f6-429b-9c3f-64c44a9ce98f]" caption="Rozchód Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Od dnia:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początkowa okresu analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-04-09&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Do dnia:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data końcowa okresu analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-05-09&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;WARTOSC&lt;/Name&gt;&#xD;
    &lt;Label&gt;Wartość&lt;/Label&gt;&#xD;
    &lt;Expression&gt;'Wartość Netto'; 'Wartość Zakupu'
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue /&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAeAAAABwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIaW1Byb2R1a3QgS29kXS5bR1JBQklFX09HUl0HAh1bUHJvZHVrdCBLb2RdLltJR0xBS0lfQ1lQUllTXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIZW1Byb2R1a3QgS29kXS5bSkFCxYFPTklFXQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCIltQcm9kdWt0IEtvZF0uW8WBQcWDQ1VDSCBETyBQScWBWV0HAhlbUHJvZHVrdCBLb2RdLltOT1dZVE9XQVJdBwIbW1Byb2R1a3QgS29kXS5bTk/Fu1lDRV9FTC5dBwIaW1Byb2R1a3QgS29kXS5bT0RLX0xJxZpDSV0HAhZbUHJvZHVrdCBLb2RdLltQQUxFVEFdBwIcW1Byb2R1a3QgS29kXS5bUElFTMSYR05BQ0pBXQcCHFtQcm9kdWt0IEtvZF0uW1BJxYFBX0VMRUtUUl0HAh9bUHJvZHVrdCBLb2RdLltQScWBQV9TUEFMSU5PV0FdBwIaW1Byb2R1a3QgS29kXS5bUFJPSl9BUkNISV0HAhxbUHJvZHVrdCBLb2RdLltQUk9KX1pJRUxFTkldBwIcW1Byb2R1a3QgS29kXS5bUk9aRFJBQk5JQUNaXQcCGVtQcm9kdWt0IEtvZF0uW1LDk8W7QV9QTl0HAhhbUHJvZHVrdCBLb2RdLltTQURaT05LSV0HAhdbUHJvZHVrdCBLb2RdLltTRUtBVE9SXQcCGFtQcm9kdWt0IEtvZF0uW1NLUlpZTktBXQcCFltQcm9kdWt0IEtvZF0uW1NUT0pBS10HAhdbUHJvZHVrdCBLb2RdLltTWlBBREVMXQcCGltQcm9kdWt0IEtvZF0uW1RFU1RLT1JFS1RdBwIgW1Byb2R1a3QgS29kXS5bVE9XQVJXT1BBS09XQU5JVV0HAhdbUHJvZHVrdCBLb2RdLltUVUpFXzNMXQcCIVtQcm9kdWt0IEtvZF0uW1VTxYFVR0EgU0VSV0lTT1dBXQcCGltQcm9kdWt0IEtvZF0uW1pFU1RBV19PR1JdBwIXW1Byb2R1a3QgS29kXS5bWkVTVEFXMl0HAhhbUHJvZHVrdCBLb2RdLltaSUVNSUFfNV3/////AAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="False" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" caption="Ilość Stan Końcowy M" formula="Ilość Stan Początkowy M + Ilość PZ + Ilość PKA + Ilość PW + Ilość MM OL - Ilość WZ - Ilość WKA - Ilość RW - Ilość MM LO" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" caption="Ilość Stan Końcowy H" formula="Ilość Stan Początkowy H + Ilość FZ - Ilość FS - Ilość PA" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" caption="Wartość Stan Końcowy M" formula="Wartość Stan Początkowy M + Wartość PZ + Wartość PKA + Wartość PW + Wartość MM OL - Wartość WZ - Wartość WKA - Wartość RW - Wartość MM LO" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" caption="Wartość Stan Końcowy H" formula="Wartość Stan Początkowy H + Wartość FZ - Wartość FS - Wartość PA" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="145" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="190" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość Stan Początkowy H"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="147" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość FZ"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość FS"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość PA"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="133" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Wartość Stan Początkowy H" index="0" expanded="True" width="147" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość FZ" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość FS" index="2" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość PA" index="3" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" index="4" expanded="True" width="133" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" width="145" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Nazwa" index="1" expanded="True" width="190" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje wartość kupionych i sprzedanych towarów na podstawie dokumentów handlowych</a:description><a:id>59</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.23 Raport handlowy towarów dla dokumentów handlowych wartościowo</a:mainLinkName><a:modifiedOn>2021-05-11T10:56:15.677</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>17</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>3</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-04-20T17:55:35.64</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Handlowy&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
declare @wartosc1 varchar(20);&#xD;
set @wartosc1 = case when @wartosc = 'Wartość Netto' then 'Tre_WartoscNetto' else 'Tre_WartoscZakupu' end;&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @kolumny2 varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @kolumny2 = @kolumny2 + ',Poz.Poziom' +LTRIM(@i)&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select =&#xD;
'SELECT &#xD;
	DB_NAME() [Baza Firmowa], &#xD;
	&#xD;
	MAX(Twr_Kod) [Produkt Kod], &#xD;
	25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],	'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__],&#xD;
	&#xD;
	MAX(Twr_Nazwa) [Produkt Nazwa],&#xD;
	CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
	ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
	CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
	25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__],&#xD;
	ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
	MAX(CASE&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
		ELSE ''(NIEOKREŚLONY)''&#xD;
	END) [Produkt Typ],&#xD;
	ISNULL(MAX(Kat_KodOgolny),''(NIEOKREŚLONA)'')  [Produkt Kategoria Ogólna], ISNULL(MAX(Kat_KodSzczegol),''(NIEOKREŚLONA)'') [Produkt Kategoria Szczegółowa], MAX(Twr_JM) [Jednostka Miary], &#xD;
	"Ilość Stan Początkowy H"=0, "Ilość Stan Początkowy M"=0, &#xD;
&#xD;
	"Ilość FZ"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Ilość FS"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Ilość PA"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Ilość PZ"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Ilość PKA"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Ilość PW"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM OL"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Ilość WZ"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Ilość WKA"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Ilość RW"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM LO"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	"Ilość MM"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
&#xD;
	"Ilość Stan Początkowy H Jednostka Pomocnicza"=0, "Ilość Stan Początkowy M Jednostka Pomocnicza"=0, &#xD;
	"Ilość FZ Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Ilość FS Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Ilość PA Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Ilość PZ Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Ilość PKA Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Ilość PW Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM OL Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Ilość WZ Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Ilość WKA Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Ilość RW Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM LO Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	"Ilość MM Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
&#xD;
	"Wartość Stan Początkowy H"=0, "Wartość Stan Początkowy M"=0, &#xD;
	"Wartość FZ"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Wartość FS"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Wartość PA"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Wartość PZ"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Wartość PKA"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Wartość PW"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Wartość MM OL"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Wartość WZ"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Wartość WKA"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Wartość RW"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Wartość MM LO"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	&#xD;
	"Wartość MM"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END)&#xD;
' + @kolumny + &#xD;
' FROM CDN.Towary&#xD;
	LEFT OUTER JOIN cdn.TraElem ON TrE_TwrID=Twr_TwrID&#xD;
	LEFT OUTER JOIN cdn.TraNag  ON TrN_TrNID=TrE_TrNID&#xD;
	LEFT OUTER JOIN cdn.Magazyny ON Mag_MagID=TrN_MagZrdID&#xD;
	LEFT OUTER JOIN cdn.Kategorie ON Kat_KatID=Twr_KatID&#xD;
	LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
	LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
WHERE (TrN_Bufor&lt;&gt;-1  &#xD;
--AND TrN_Korekta IN (0,1) &#xD;
OR TrN_TrNID IS NULL)&#xD;
	AND (((TrE_TypDokumentu IN (302,304,305,306,314,318) OR TrN_Rodzaj IN (312100)&#xD;
	OR ((TrE_TypDokumentu IN (301,310,303,307,313,317) OR TrN_Rodzaj IN (312010) OR TrN_Rodzaj IN (312000,312001,312008)) AND TrN_Bufor=0)) &#xD;
	AND TrE_Aktywny&lt;&gt;0)	OR TrE_TrEID IS NULL)&#xD;
	AND (TrN_DataOpe BETWEEN CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD,120) + ''',120) AND CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATADO,120) + ''',120) OR TrE_TrEID IS NULL)  &#xD;
GROUP BY Twr_TwrID, Twr_NieAktywny, TWR_SWW, knt4.Knt_Kod, Twr_JMZ' + @kolumny2 + '&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
	DB_NAME() [Baza Firmowa], &#xD;
	&#xD;
	MAX(Twr_Kod) [Produkt Kod], &#xD;
	25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],	'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__],&#xD;
	&#xD;
	MAX(Twr_Nazwa) [Produkt Nazwa],&#xD;
	CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
	ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
	CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
	25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],	'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__],&#xD;
	ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
	MAX(CASE&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
		ELSE ''(NIEOKREŚLONY)''&#xD;
	END) [Produkt Typ],&#xD;
	ISNULL(MAX(Kat_KodOgolny),''(NIEOKREŚLONA)'') [Produkt Kategoria Ogólna], ISNULL(MAX(Kat_KodSzczegol),''(NIEOKREŚLONA)'')  [Produkt Kategoria Szczegółowa], MAX(Twr_JM) [Jednostka Miary], &#xD;
	"Ilość Stan Początkowy H"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END), &#xD;
	"Ilość Stan Początkowy M"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END), &#xD;
	"Ilość FZ"=0, "Ilość FS"=0,	"Ilość PA"=0, "Ilość PZ"=0,	"Ilość PKA"=0, "Ilość PW"=0, "Ilość MM OL"=0, "Ilość WZ"=0,	"Ilość WKA"=0, "Ilość RW"=0, "Ilość MM LO"=0,&#xD;
	"Ilość MM" = 0,&#xD;
	"Ilość Stan Początkowy H Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END),&#xD;
	 "Ilość Stan Początkowy M Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END),  &#xD;
	"Ilość FZ Jednostka Pomocnicza"=0, "Ilość FS Jednostka Pomocnicza"=0,	"Ilość PA Jednostka Pomocnicza"=0, "Ilość PZ Jednostka Pomocnicza"=0,	"Ilość PKA Jednostka Pomocnicza"=0, "Ilość PW Jednostka Pomocnicza"=0, "Ilość MM OL Jednostka Pomocnicza"=0, &#xD;
	"Ilość WZ Jednostka Pomocnicza"=0,	"Ilość WKA Jednostka Pomocnicza"=0, "Ilość RW Jednostka Pomocnicza"=0, "Ilość MM LO Jednostka Pomocnicza"=0,&#xD;
	"Ilość MM Jednostka Pomocnicza" = 0,&#xD;
	"Wartość Stan Początkowy H"=SUM(IsNull(' + @wartosc1 + ',''0'')*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END), &#xD;
	"Wartość Stan Początkowy M"=SUM(IsNull(' + @wartosc1 + ',''0'')*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317,312) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END), &#xD;
	"Wartość FZ"=0, "Wartość FS"=0,	"Wartość PA"=0, "Wartość PZ"=0, "Wartość PKA"=0, "Wartość PW"=0, "Wartość MM OL"=0,	"Wartość WZ"=0,	"Wartość WKA"=0, "Wartość RW"=0, "Wartość MM LO"=0,&#xD;
	"Wartość MM"=0&#xD;
' + @kolumny + &#xD;
' FROM CDN.Towary&#xD;
	LEFT OUTER JOIN cdn.TraElem ON TrE_TwrID=Twr_TwrID&#xD;
	LEFT OUTER JOIN cdn.TraNag  ON TrN_TrNID=TrE_TrNID&#xD;
	LEFT OUTER JOIN cdn.Magazyny ON Mag_MagID=TrN_MagZrdID&#xD;
	LEFT OUTER JOIN cdn.Kategorie ON Kat_KatID=Twr_KatID&#xD;
	LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
	LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
WHERE (TrN_Bufor&lt;&gt;-1 &#xD;
--AND TrN_Korekta IN (0,1) &#xD;
OR TrN_TrNID IS NULL)&#xD;
	AND (((TrE_TypDokumentu IN (302,304,305,306,314,318) OR TrN_Rodzaj IN (312100)&#xD;
	OR ((TrE_TypDokumentu IN (301,310,303,307,313,317) OR TrN_Rodzaj IN (312010) OR TrN_Rodzaj IN (312000,312001,312008)) AND TrN_Bufor=0)) &#xD;
	AND TrE_Aktywny&lt;&gt;0)	OR TrE_TrEID IS NULL)&#xD;
	AND (TrN_DataOpe &lt; CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD, 120) + ''',120) OR TrE_TrEID IS NULL)  &#xD;
GROUP BY Twr_TwrID, Twr_NieAktywny, TWR_SWW, knt4.Knt_Kod, Twr_JMZ' + @kolumny2&#xD;
&#xD;
exec (@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QHRUwalZ8pMVJl4bnvAvbQJZcV6Wn+9eyurT5z7pvsx453uBpU8ZVZBU3sxojq0nr7SEb6pIcBltbZneCkQXihh2PJK4OnljQYqeZz6oFgeKpqUN1a0P8/X1EVgEjUyAynh2e+VUqmLaTxvo2adC1y/WjNl2Vo5HaL2i46mtibOu7HvVCLZ13K</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Ogólna" caption="Produkt Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Szczegółowa" caption="Produkt Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy H" caption="Ilość Stan Początkowy H" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy M" caption="Ilość Stan Początkowy M" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FZ" caption="Ilość FZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FS" caption="Ilość FS" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PA" caption="Ilość PA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PZ" caption="Ilość PZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PKA" caption="Ilość PKA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PW" caption="Ilość PW" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM OL" caption="Ilość MM OL" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WZ" caption="Ilość WZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WKA" caption="Ilość WKA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość RW" caption="Ilość RW" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM LO" caption="Ilość MM LO" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM" caption="Ilość MM" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy H Jednostka Pomocnicza" caption="Ilość Stan Początkowy H Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy M Jednostka Pomocnicza" caption="Ilość Stan Początkowy M Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FZ Jednostka Pomocnicza" caption="Ilość FZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FS Jednostka Pomocnicza" caption="Ilość FS Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PA Jednostka Pomocnicza" caption="Ilość PA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PZ Jednostka Pomocnicza" caption="Ilość PZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PKA Jednostka Pomocnicza" caption="Ilość PKA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PW Jednostka Pomocnicza" caption="Ilość PW Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM OL Jednostka Pomocnicza" caption="Ilość MM OL Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WZ Jednostka Pomocnicza" caption="Ilość WZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WKA Jednostka Pomocnicza" caption="Ilość WKA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość RW Jednostka Pomocnicza" caption="Ilość RW Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM LO Jednostka Pomocnicza" caption="Ilość MM LO Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM Jednostka Pomocnicza" caption="Ilość MM Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Stan Początkowy H" caption="Wartość Stan Początkowy H" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Stan Początkowy M" caption="Wartość Stan Początkowy M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość FZ" caption="Wartość FZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość FS" caption="Wartość FS" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PA" caption="Wartość PA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PZ" caption="Wartość PZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PKA" caption="Wartość PKA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PW" caption="Wartość PW" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM OL" caption="Wartość MM OL" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość WZ" caption="Wartość WZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość WKA" caption="Wartość WKA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość RW" caption="Wartość RW" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM LO" caption="Wartość MM LO" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM" caption="Wartość MM" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" caption="Ilość Stan Końcowy M" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" caption="Ilość Stan Końcowy H" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" caption="Wartość Stan Końcowy M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" caption="Wartość Stan Końcowy H" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[181be47b-ee11-4e2b-8156-9ec187b983f3]" caption="Przychód Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[e6485a6b-23c5-49c8-b320-480299d8f79a]" caption="Przychód Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[d4bad69d-ee14-4b67-82f4-be5b58801ce0]" caption="Rozchód Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[4e2d8baf-1300-45d7-b7f7-bbe999e66809]" caption="Rozchód Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[e0755fa4-408d-45d3-a3cc-c3fdd16114a0]" caption="Ilość Stan Końcowy H Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[756f4713-3261-4d56-85f3-4fd748ffefc3]" caption="Ilość Stan Końcowy M Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[6c5b0e50-b645-4138-85c5-9f68085ed4b2]" caption="Przychód Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[dcaef927-08f6-429b-9c3f-64c44a9ce98f]" caption="Rozchód Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Od dnia:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początkowa okresu analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-04-09&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Do dnia:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data końcowa okresu analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-05-09&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;WARTOSC&lt;/Name&gt;&#xD;
    &lt;Label&gt;Wartość&lt;/Label&gt;&#xD;
    &lt;Expression&gt;'Wartość Netto'; 'Wartość Zakupu'
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue /&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAeAAAABwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIaW1Byb2R1a3QgS29kXS5bR1JBQklFX09HUl0HAh1bUHJvZHVrdCBLb2RdLltJR0xBS0lfQ1lQUllTXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIZW1Byb2R1a3QgS29kXS5bSkFCxYFPTklFXQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCIltQcm9kdWt0IEtvZF0uW8WBQcWDQ1VDSCBETyBQScWBWV0HAhlbUHJvZHVrdCBLb2RdLltOT1dZVE9XQVJdBwIbW1Byb2R1a3QgS29kXS5bTk/Fu1lDRV9FTC5dBwIaW1Byb2R1a3QgS29kXS5bT0RLX0xJxZpDSV0HAhZbUHJvZHVrdCBLb2RdLltQQUxFVEFdBwIcW1Byb2R1a3QgS29kXS5bUElFTMSYR05BQ0pBXQcCHFtQcm9kdWt0IEtvZF0uW1BJxYFBX0VMRUtUUl0HAh9bUHJvZHVrdCBLb2RdLltQScWBQV9TUEFMSU5PV0FdBwIaW1Byb2R1a3QgS29kXS5bUFJPSl9BUkNISV0HAhxbUHJvZHVrdCBLb2RdLltQUk9KX1pJRUxFTkldBwIcW1Byb2R1a3QgS29kXS5bUk9aRFJBQk5JQUNaXQcCGVtQcm9kdWt0IEtvZF0uW1LDk8W7QV9QTl0HAhhbUHJvZHVrdCBLb2RdLltTQURaT05LSV0HAhdbUHJvZHVrdCBLb2RdLltTRUtBVE9SXQcCGFtQcm9kdWt0IEtvZF0uW1NLUlpZTktBXQcCFltQcm9kdWt0IEtvZF0uW1NUT0pBS10HAhdbUHJvZHVrdCBLb2RdLltTWlBBREVMXQcCGltQcm9kdWt0IEtvZF0uW1RFU1RLT1JFS1RdBwIgW1Byb2R1a3QgS29kXS5bVE9XQVJXT1BBS09XQU5JVV0HAhdbUHJvZHVrdCBLb2RdLltUVUpFXzNMXQcCIVtQcm9kdWt0IEtvZF0uW1VTxYFVR0EgU0VSV0lTT1dBXQcCGltQcm9kdWt0IEtvZF0uW1pFU1RBV19PR1JdBwIXW1Byb2R1a3QgS29kXS5bWkVTVEFXMl0HAhhbUHJvZHVrdCBLb2RdLltaSUVNSUFfNV3/////AAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="False" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" caption="Ilość Stan Końcowy M" formula="Ilość Stan Początkowy M + Ilość PZ + Ilość PKA + Ilość PW + Ilość MM OL - Ilość WZ - Ilość WKA - Ilość RW - Ilość MM LO" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" caption="Ilość Stan Końcowy H" formula="Ilość Stan Początkowy H + Ilość FZ - Ilość FS - Ilość PA" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" caption="Wartość Stan Końcowy M" formula="Wartość Stan Początkowy M + Wartość PZ + Wartość PKA + Wartość PW + Wartość MM OL - Wartość WZ - Wartość WKA - Wartość RW - Wartość MM LO" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" caption="Wartość Stan Końcowy H" formula="Wartość Stan Początkowy H + Wartość FZ - Wartość FS - Wartość PA" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="145" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="190" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość Stan Początkowy M"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="130" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość PZ"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość PKA"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość PW"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość MM OL"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość WZ"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość WKA"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość RW"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość MM LO"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="116" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Ilość Stan Początkowy M" index="0" expanded="True" width="130" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość PZ" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość PKA" index="2" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość PW" index="3" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość MM OL" index="4" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość WZ" index="5" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość WKA" index="6" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość RW" index="7" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Ilość MM LO" index="8" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" index="9" expanded="True" width="116" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" width="145" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Nazwa" index="1" expanded="True" width="190" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje ilość kupionych i sprzedanych towarów na podstawie dokumentów magazynowych</a:description><a:id>60</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.24 Raport handlowy towarów dla dokumentów magazynowych ilościowo</a:mainLinkName><a:modifiedOn>2021-05-11T10:56:25.217</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>17</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>7</a:id></a:Context><a:Context><a:id>8</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-04-20T17:57:26.13</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Handlowy&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
declare @wartosc1 varchar(20);&#xD;
set @wartosc1 = case when @wartosc = 'Wartość Netto' then 'Tre_WartoscNetto' else 'Tre_WartoscZakupu' end;&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @kolumny2 varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @kolumny2 = @kolumny2 + ',Poz.Poziom' +LTRIM(@i)&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select =&#xD;
'SELECT &#xD;
	DB_NAME() [Baza Firmowa], &#xD;
	&#xD;
	MAX(Twr_Kod) [Produkt Kod], &#xD;
	25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],	'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__],&#xD;
	&#xD;
	MAX(Twr_Nazwa) [Produkt Nazwa],&#xD;
	CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
	ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
	CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
	25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__],&#xD;
	ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
	MAX(CASE&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
		ELSE ''(NIEOKREŚLONY)''&#xD;
	END) [Produkt Typ],&#xD;
	ISNULL(MAX(Kat_KodOgolny),''(NIEOKREŚLONA)'')  [Produkt Kategoria Ogólna], ISNULL(MAX(Kat_KodSzczegol),''(NIEOKREŚLONA)'') [Produkt Kategoria Szczegółowa], MAX(Twr_JM) [Jednostka Miary], &#xD;
	"Ilość Stan Początkowy H"=0, "Ilość Stan Początkowy M"=0, &#xD;
&#xD;
	"Ilość FZ"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Ilość FS"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Ilość PA"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Ilość PZ"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Ilość PKA"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Ilość PW"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM OL"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Ilość WZ"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Ilość WKA"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Ilość RW"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM LO"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	"Ilość MM"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
&#xD;
	"Ilość Stan Początkowy H Jednostka Pomocnicza"=0, "Ilość Stan Początkowy M Jednostka Pomocnicza"=0, &#xD;
	"Ilość FZ Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Ilość FS Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Ilość PA Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Ilość PZ Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Ilość PKA Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Ilość PW Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM OL Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Ilość WZ Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Ilość WKA Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Ilość RW Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Ilość MM LO Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	"Ilość MM Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
&#xD;
	"Wartość Stan Początkowy H"=0, "Wartość Stan Początkowy M"=0, &#xD;
	"Wartość FZ"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
	"Wartość FS"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
	"Wartość PA"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
	"Wartość PZ"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
	"Wartość PKA"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
	"Wartość PW"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
	"Wartość MM OL"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
	"Wartość WZ"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
	"Wartość WKA"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
	"Wartość RW"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
	"Wartość MM LO"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
	&#xD;
	"Wartość MM"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END)&#xD;
' + @kolumny + &#xD;
' FROM CDN.Towary&#xD;
	LEFT OUTER JOIN cdn.TraElem ON TrE_TwrID=Twr_TwrID&#xD;
	LEFT OUTER JOIN cdn.TraNag  ON TrN_TrNID=TrE_TrNID&#xD;
	LEFT OUTER JOIN cdn.Magazyny ON Mag_MagID=TrN_MagZrdID&#xD;
	LEFT OUTER JOIN cdn.Kategorie ON Kat_KatID=Twr_KatID&#xD;
	LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
	LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
WHERE (TrN_Bufor&lt;&gt;-1  &#xD;
--AND TrN_Korekta IN (0,1) &#xD;
OR TrN_TrNID IS NULL)&#xD;
	AND (((TrE_TypDokumentu IN (302,304,305,306,314,318) OR TrN_Rodzaj IN (312100)&#xD;
	OR ((TrE_TypDokumentu IN (301,310,303,307,313,317) OR TrN_Rodzaj IN (312010) OR TrN_Rodzaj IN (312000,312001,312008)) AND TrN_Bufor=0)) &#xD;
	AND TrE_Aktywny&lt;&gt;0)	OR TrE_TrEID IS NULL)&#xD;
	AND (TrN_DataOpe BETWEEN CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD,120) + ''',120) AND CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATADO,120) + ''',120) OR TrE_TrEID IS NULL)  &#xD;
GROUP BY Twr_TwrID, Twr_NieAktywny, TWR_SWW, knt4.Knt_Kod, Twr_JMZ' + @kolumny2 + '&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
	DB_NAME() [Baza Firmowa], &#xD;
	&#xD;
	MAX(Twr_Kod) [Produkt Kod], &#xD;
	25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],	'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__],&#xD;
	&#xD;
	MAX(Twr_Nazwa) [Produkt Nazwa],&#xD;
	CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
	ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
	CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
	25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],	'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__],&#xD;
	ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
	MAX(CASE&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
		ELSE ''(NIEOKREŚLONY)''&#xD;
	END) [Produkt Typ],&#xD;
	ISNULL(MAX(Kat_KodOgolny),''(NIEOKREŚLONA)'') [Produkt Kategoria Ogólna], ISNULL(MAX(Kat_KodSzczegol),''(NIEOKREŚLONA)'')  [Produkt Kategoria Szczegółowa], MAX(Twr_JM) [Jednostka Miary], &#xD;
	"Ilość Stan Początkowy H"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END), &#xD;
	"Ilość Stan Początkowy M"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END), &#xD;
	"Ilość FZ"=0, "Ilość FS"=0,	"Ilość PA"=0, "Ilość PZ"=0,	"Ilość PKA"=0, "Ilość PW"=0, "Ilość MM OL"=0, "Ilość WZ"=0,	"Ilość WKA"=0, "Ilość RW"=0, "Ilość MM LO"=0,&#xD;
	"Ilość MM" = 0,&#xD;
	"Ilość Stan Początkowy H Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END),&#xD;
	 "Ilość Stan Początkowy M Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END),  &#xD;
	"Ilość FZ Jednostka Pomocnicza"=0, "Ilość FS Jednostka Pomocnicza"=0,	"Ilość PA Jednostka Pomocnicza"=0, "Ilość PZ Jednostka Pomocnicza"=0,	"Ilość PKA Jednostka Pomocnicza"=0, "Ilość PW Jednostka Pomocnicza"=0, "Ilość MM OL Jednostka Pomocnicza"=0, &#xD;
	"Ilość WZ Jednostka Pomocnicza"=0,	"Ilość WKA Jednostka Pomocnicza"=0, "Ilość RW Jednostka Pomocnicza"=0, "Ilość MM LO Jednostka Pomocnicza"=0,&#xD;
	"Ilość MM Jednostka Pomocnicza" = 0,&#xD;
	"Wartość Stan Początkowy H"=SUM(IsNull(' + @wartosc1 + ',''0'')*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END), &#xD;
	"Wartość Stan Początkowy M"=SUM(IsNull(' + @wartosc1 + ',''0'')*CASE WHEN TrE_TypDokumentu IN (310,303,307,313,317,312) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305) THEN 0 ELSE -1 END), &#xD;
	"Wartość FZ"=0, "Wartość FS"=0,	"Wartość PA"=0, "Wartość PZ"=0, "Wartość PKA"=0, "Wartość PW"=0, "Wartość MM OL"=0,	"Wartość WZ"=0,	"Wartość WKA"=0, "Wartość RW"=0, "Wartość MM LO"=0,&#xD;
	"Wartość MM"=0&#xD;
' + @kolumny + &#xD;
' FROM CDN.Towary&#xD;
	LEFT OUTER JOIN cdn.TraElem ON TrE_TwrID=Twr_TwrID&#xD;
	LEFT OUTER JOIN cdn.TraNag  ON TrN_TrNID=TrE_TrNID&#xD;
	LEFT OUTER JOIN cdn.Magazyny ON Mag_MagID=TrN_MagZrdID&#xD;
	LEFT OUTER JOIN cdn.Kategorie ON Kat_KatID=Twr_KatID&#xD;
	LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
	LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
WHERE (TrN_Bufor&lt;&gt;-1 &#xD;
--AND TrN_Korekta IN (0,1) &#xD;
OR TrN_TrNID IS NULL)&#xD;
	AND (((TrE_TypDokumentu IN (302,304,305,306,314,318) OR TrN_Rodzaj IN (312100)&#xD;
	OR ((TrE_TypDokumentu IN (301,310,303,307,313,317) OR TrN_Rodzaj IN (312010) OR TrN_Rodzaj IN (312000,312001,312008)) AND TrN_Bufor=0)) &#xD;
	AND TrE_Aktywny&lt;&gt;0)	OR TrE_TrEID IS NULL)&#xD;
	AND (TrN_DataOpe &lt; CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD, 120) + ''',120) OR TrE_TrEID IS NULL)  &#xD;
GROUP BY Twr_TwrID, Twr_NieAktywny, TWR_SWW, knt4.Knt_Kod, Twr_JMZ' + @kolumny2&#xD;
&#xD;
exec (@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QHRUwalZ8pMVJl4bnvAvbQJZcV6Wn+9eyurT5z7pvsx453uBpU8ZVZBU3sxojq0nr7SEb6pIcBltbZneCkQXihh2PJK4OnljQYqeZz6oFgeKpqUN1a0P8/X1EVgEjUyAynh2e+VUqmLaTxvo2adC1y/WjNl2Vo5HaL2i46mtibOu7HvVCLZ13K</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Ogólna" caption="Produkt Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Szczegółowa" caption="Produkt Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy H" caption="Ilość Stan Początkowy H" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy M" caption="Ilość Stan Początkowy M" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FZ" caption="Ilość FZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FS" caption="Ilość FS" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PA" caption="Ilość PA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PZ" caption="Ilość PZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PKA" caption="Ilość PKA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PW" caption="Ilość PW" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM OL" caption="Ilość MM OL" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WZ" caption="Ilość WZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WKA" caption="Ilość WKA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość RW" caption="Ilość RW" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM LO" caption="Ilość MM LO" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM" caption="Ilość MM" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy H Jednostka Pomocnicza" caption="Ilość Stan Początkowy H Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy M Jednostka Pomocnicza" caption="Ilość Stan Początkowy M Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FZ Jednostka Pomocnicza" caption="Ilość FZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FS Jednostka Pomocnicza" caption="Ilość FS Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PA Jednostka Pomocnicza" caption="Ilość PA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PZ Jednostka Pomocnicza" caption="Ilość PZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PKA Jednostka Pomocnicza" caption="Ilość PKA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PW Jednostka Pomocnicza" caption="Ilość PW Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM OL Jednostka Pomocnicza" caption="Ilość MM OL Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WZ Jednostka Pomocnicza" caption="Ilość WZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WKA Jednostka Pomocnicza" caption="Ilość WKA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość RW Jednostka Pomocnicza" caption="Ilość RW Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM LO Jednostka Pomocnicza" caption="Ilość MM LO Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM Jednostka Pomocnicza" caption="Ilość MM Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Stan Początkowy H" caption="Wartość Stan Początkowy H" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Stan Początkowy M" caption="Wartość Stan Początkowy M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość FZ" caption="Wartość FZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość FS" caption="Wartość FS" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PA" caption="Wartość PA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PZ" caption="Wartość PZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PKA" caption="Wartość PKA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PW" caption="Wartość PW" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM OL" caption="Wartość MM OL" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość WZ" caption="Wartość WZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość WKA" caption="Wartość WKA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość RW" caption="Wartość RW" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM LO" caption="Wartość MM LO" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM" caption="Wartość MM" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" caption="Ilość Stan Końcowy M" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" caption="Ilość Stan Końcowy H" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" caption="Wartość Stan Końcowy M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" caption="Wartość Stan Końcowy H" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[181be47b-ee11-4e2b-8156-9ec187b983f3]" caption="Przychód Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[e6485a6b-23c5-49c8-b320-480299d8f79a]" caption="Przychód Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[d4bad69d-ee14-4b67-82f4-be5b58801ce0]" caption="Rozchód Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[4e2d8baf-1300-45d7-b7f7-bbe999e66809]" caption="Rozchód Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[e0755fa4-408d-45d3-a3cc-c3fdd16114a0]" caption="Ilość Stan Końcowy H Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[756f4713-3261-4d56-85f3-4fd748ffefc3]" caption="Ilość Stan Końcowy M Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[6c5b0e50-b645-4138-85c5-9f68085ed4b2]" caption="Przychód Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[dcaef927-08f6-429b-9c3f-64c44a9ce98f]" caption="Rozchód Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Od dnia:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początkowa okresu analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-04-09&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Do dnia:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data końcowa okresu analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-05-09&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;WARTOSC&lt;/Name&gt;&#xD;
    &lt;Label&gt;Wartość&lt;/Label&gt;&#xD;
    &lt;Expression&gt;'Wartość Netto'; 'Wartość Zakupu'
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue /&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAeAAAABwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIaW1Byb2R1a3QgS29kXS5bR1JBQklFX09HUl0HAh1bUHJvZHVrdCBLb2RdLltJR0xBS0lfQ1lQUllTXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIZW1Byb2R1a3QgS29kXS5bSkFCxYFPTklFXQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCIltQcm9kdWt0IEtvZF0uW8WBQcWDQ1VDSCBETyBQScWBWV0HAhlbUHJvZHVrdCBLb2RdLltOT1dZVE9XQVJdBwIbW1Byb2R1a3QgS29kXS5bTk/Fu1lDRV9FTC5dBwIaW1Byb2R1a3QgS29kXS5bT0RLX0xJxZpDSV0HAhZbUHJvZHVrdCBLb2RdLltQQUxFVEFdBwIcW1Byb2R1a3QgS29kXS5bUElFTMSYR05BQ0pBXQcCHFtQcm9kdWt0IEtvZF0uW1BJxYFBX0VMRUtUUl0HAh9bUHJvZHVrdCBLb2RdLltQScWBQV9TUEFMSU5PV0FdBwIaW1Byb2R1a3QgS29kXS5bUFJPSl9BUkNISV0HAhxbUHJvZHVrdCBLb2RdLltQUk9KX1pJRUxFTkldBwIcW1Byb2R1a3QgS29kXS5bUk9aRFJBQk5JQUNaXQcCGVtQcm9kdWt0IEtvZF0uW1LDk8W7QV9QTl0HAhhbUHJvZHVrdCBLb2RdLltTQURaT05LSV0HAhdbUHJvZHVrdCBLb2RdLltTRUtBVE9SXQcCGFtQcm9kdWt0IEtvZF0uW1NLUlpZTktBXQcCFltQcm9kdWt0IEtvZF0uW1NUT0pBS10HAhdbUHJvZHVrdCBLb2RdLltTWlBBREVMXQcCGltQcm9kdWt0IEtvZF0uW1RFU1RLT1JFS1RdBwIgW1Byb2R1a3QgS29kXS5bVE9XQVJXT1BBS09XQU5JVV0HAhdbUHJvZHVrdCBLb2RdLltUVUpFXzNMXQcCIVtQcm9kdWt0IEtvZF0uW1VTxYFVR0EgU0VSV0lTT1dBXQcCGltQcm9kdWt0IEtvZF0uW1pFU1RBV19PR1JdBwIXW1Byb2R1a3QgS29kXS5bWkVTVEFXMl0HAhhbUHJvZHVrdCBLb2RdLltaSUVNSUFfNV3/////AAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="False" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" caption="Ilość Stan Końcowy M" formula="Ilość Stan Początkowy M + Ilość PZ + Ilość PKA + Ilość PW + Ilość MM OL - Ilość WZ - Ilość WKA - Ilość RW - Ilość MM LO" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" caption="Ilość Stan Końcowy H" formula="Ilość Stan Początkowy H + Ilość FZ - Ilość FS - Ilość PA" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" caption="Wartość Stan Końcowy M" formula="Wartość Stan Początkowy M + Wartość PZ + Wartość PKA + Wartość PW + Wartość MM OL - Wartość WZ - Wartość WKA - Wartość RW - Wartość MM LO" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" caption="Wartość Stan Końcowy H" formula="Wartość Stan Początkowy H + Wartość FZ - Wartość FS - Wartość PA" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="145" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="190" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość Stan Początkowy M"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="148" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość PZ"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość PKA"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość PW"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość MM OL"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość WZ"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość WKA"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość RW"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość MM LO"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="134" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Wartość Stan Początkowy M" index="0" expanded="True" width="148" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość PZ" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość PKA" index="2" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość PW" index="3" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość MM OL" index="4" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość WZ" index="5" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość WKA" index="6" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość RW" index="7" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Wartość MM LO" index="8" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" index="9" expanded="True" width="134" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" width="145" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Nazwa" index="1" expanded="True" width="190" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje wartość kupionych i sprzedanych towarów na podstawie dokumentów magazynowych</a:description><a:id>61</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.25 Raport handlowy towarów dla dokumentów magazynowych wartościowo</a:mainLinkName><a:modifiedOn>2021-05-11T10:56:34.477</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>17</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>7</a:id></a:Context><a:Context><a:id>8</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-05-17T15:34:58.863</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Analiza RO &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END&#xD;
        END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'                 &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END&#xD;
        END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END&#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE&#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5 &#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa,&#xD;
    "Dokument Numer" = TrN_NumerPelny, &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    "Dokument Obcy" = ISNULL(NULLIF(TrN_NumerObcy,''''),''(BRAK)''),&#xD;
    Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
       "Dokument Status" = CASE &#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 1 THEN ''(PUSTY)''&#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 2 THEN ''W realizacji'' &#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 3 THEN ''Zrealizowano'' &#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 4 THEN ''Zamknięto'' &#xD;
       END,&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],      &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1,     &#xD;
       "Odbiorca Kod" = pod3.Pod_Kod,      &#xD;
       "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Kraj" = CASE WHEN pod3.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Kraj END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,    &#xD;
    "Produkt Nazwa" = Twr_Nazwa,&#xD;
    "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],     &#xD;
    "Produkt Kod" = Twr_Kod,&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],     &#xD;
         "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)), "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
&#xD;
CASE TrN_eSklepZrodlo&#xD;
WHEN 0 THEN ''e-Sklep''&#xD;
WHEN 2 THEN ''Facebook''&#xD;
WHEN 3 THEN ''Allegro''&#xD;
WHEN 4 THEN ''wszytsko.pl''&#xD;
WHEN 5 THEN ''Comarch e-Sklep RWD''&#xD;
WHEN 6 THEN ''API''&#xD;
WHEN 7 THEN ''system ERP''&#xD;
WHEN 8 THEN ''eBay''&#xD;
WHEN 9 THEN ''Ceneo''&#xD;
WHEN 10 THEN ''Comarch e-Sklep wersja mobilna''&#xD;
WHEN 13 THEN ''Amazon''&#xD;
ELSE ''(NIEPRZYPISANE)'' END                                                                    AS [Rezerwacja Źródło],&#xD;
&#xD;
       "Jednostka Miary" = Twr_Jm,     &#xD;
       "Magazyn Nazwa" = Mag_Symbol,       &#xD;
       "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Pozostała" = CASE WHEN TrN_ZwroconoCalaIlosc IN (3,4) THEN 0 ELSE TR.TrE_Ilosc + ISNULL(IP.Ilosc,0) END * TR.TrE_Cena0, &#xD;
       "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, "Sprzedaż Ilość Pozostała" = CASE WHEN TrN_ZwroconoCalaIlosc IN (3,4) THEN 0 ELSE TR.TrE_Ilosc + ISNULL(IP.Ilosc,0) END, &#xD;
       "Sprzedaż Marża" = TR.TrE_WartoscNetto - (isNull(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), "Koszt Zakupu" = isNull(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi&#xD;
      /* &#xD;
       ----------DATY POINT&#xD;
     ,"Data Rezerwacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
     ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataDok, 111), ''/'', ''-'')&#xD;
     ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
     */&#xD;
       ----------DATY ANALIZY&#xD;
     ,"Data Rezerwacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
     ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataDok, 111), ''/'', ''-'')&#xD;
     ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ &#xD;
     ,"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe) &#xD;
&#xD;
       ----------KONTEKSTY&#xD;
    ,25039 [Dokument Numer __PROCID__RO__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__], '''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
       &#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT OUTER JOIN (&#xD;
           SELECT TE1.TrE_TrEID [TREID], SUM(TrS_Ilosc) [Ilosc]&#xD;
           FROM CDN.TraElem TE1&#xD;
           JOIN CDN.TraSElem ON TrS_TrEID = TE1.TrE_TrEID&#xD;
           WHERE TrS_TrEIdWydania &lt;&gt; 0&#xD;
           GROUP BY TE1.TrE_TrEID&#xD;
     ) AS IP ON TR.TrE_TrEId = IP.TREID     &#xD;
     /* LEFT OUTER JOIN (&#xD;
            SELECT TE1.TrE_TrEID [TREID], SUM(TE2.TrE_Ilosc) [Ilosc]&#xD;
            FROM CDN.TraElem TE1&#xD;
                JOIN CDN.TraNag TN1 ON TE1.TrE_TrNId = TN1.TrN_TrNID &#xD;
                JOIN CDN.TraNagRelacje TR1 ON TN1.TrN_TrNID = TR1.TrR_TrNId AND TR1.TrR_FaTyp = 306&#xD;
                JOIN CDN.TraNag TN2 ON TR1.TrR_FaId = TN2.TrN_TrNID&#xD;
                JOIN CDN.TraElem TE2 ON TE2.TrE_TrNId = TN2.TrN_TrNID AND TE2.TrE_Lp = TE1.TrE_Lp&#xD;
            GROUP BY TE1.TrE_TrEID&#xD;
     ) AS Zal ON TR.TrE_TrEId = Zal.TREID */     &#xD;
LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (308)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
  DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut &amp;quot;ASD&amp;quot;" caption="Kontrahent Atrybut &amp;quot;ASD&amp;quot;" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut ~!@#$%^&amp;amp;*()_+-=&amp;lt;&amp;gt;,./" caption="Kontrahent Atrybut ~!@#$%^&amp;amp;*()_+-=&amp;lt;&amp;gt;,./" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut ['&amp;quot;;:{}[[[_--" caption="Kontrahent Atrybut ['&amp;quot;;:{}[[[_--" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS" caption="Dokument Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut &amp;quot;ASD&amp;quot; (K)" caption="Dokument Atrybut &amp;quot;ASD&amp;quot; (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DAWKA SZKODLIWA /MG/" caption="Produkt Atrybut DAWKA SZKODLIWA /MG/" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROŚLINA ŚWIATŁOLUBNA" caption="Produkt Atrybut ROŚLINA ŚWIATŁOLUBNA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut WYSOKOŚĆ" caption="Produkt Atrybut WYSOKOŚĆ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut REZLIZACJA" caption="Produkt Atrybut REZLIZACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wQAAAAHAiJbS29udHJhaGVudCBLb2RdLlshTklFT0tSRcWaTE9OWSFdBwIWW0tvbnRyYWhlbnQgS29kXS5bQURNXQcCHFtLb250cmFoZW50IEtvZF0uW01BUlNaQUxJS10HAhtbS29udHJhaGVudCBLb2RdLltTT0ZUTEFORF0=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Grupa"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="1" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="0" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="2" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent Grupa" index="0" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę kontrahentów z produktami, które zostały im sprzedane na podstawie dokumentów rezerwacji odbiorcy.</a:description><a:id>62</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.26 Analiza RO według kontrahentów</a:mainLinkName><a:modifiedOn>2025-05-23T17:32:02.863</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>5</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-08-20T15:48:56.407</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Analiza RO &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END&#xD;
        END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'                 &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END&#xD;
        END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END&#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE&#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5 &#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa,&#xD;
    "Dokument Numer" = TrN_NumerPelny, &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    "Dokument Obcy" = ISNULL(NULLIF(TrN_NumerObcy,''''),''(BRAK)''),&#xD;
    Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
       "Dokument Status" = CASE &#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 1 THEN ''(PUSTY)''&#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 2 THEN ''W realizacji'' &#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 3 THEN ''Zrealizowano'' &#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 4 THEN ''Zamknięto'' &#xD;
       END,&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],      &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1,     &#xD;
       "Odbiorca Kod" = pod3.Pod_Kod,      &#xD;
       "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Kraj" = CASE WHEN pod3.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Kraj END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,    &#xD;
    "Produkt Nazwa" = Twr_Nazwa,&#xD;
    "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],     &#xD;
    "Produkt Kod" = Twr_Kod,&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],     &#xD;
         "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)), "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
       "Jednostka Miary" = Twr_Jm,     &#xD;
       "Magazyn Nazwa" = Mag_Symbol,       &#xD;
       "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
CASE TrN_eSklepZrodlo&#xD;
WHEN 0 THEN ''e-Sklep''&#xD;
WHEN 2 THEN ''Facebook''&#xD;
WHEN 3 THEN ''Allegro''&#xD;
WHEN 4 THEN ''wszytsko.pl''&#xD;
WHEN 5 THEN ''Comarch e-Sklep RWD''&#xD;
WHEN 6 THEN ''API''&#xD;
WHEN 7 THEN ''system ERP''&#xD;
WHEN 8 THEN ''eBay''&#xD;
WHEN 9 THEN ''Ceneo''&#xD;
WHEN 10 THEN ''Comarch e-Sklep wersja mobilna''&#xD;
WHEN 13 THEN ''Amazon''&#xD;
ELSE ''(NIEPRZYPISANE)'' END                                                                    AS [Rezerwacja Źródło],&#xD;
&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Pozostała" = CASE WHEN TrN_ZwroconoCalaIlosc IN (3,4) THEN 0 ELSE TR.TrE_Ilosc + ISNULL(IP.Ilosc,0) END * TR.TrE_Cena0, &#xD;
       "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, "Sprzedaż Ilość Pozostała" = CASE WHEN TrN_ZwroconoCalaIlosc IN (3,4) THEN 0 ELSE TR.TrE_Ilosc + ISNULL(IP.Ilosc,0) END, &#xD;
       "Sprzedaż Marża" = TR.TrE_WartoscNetto - (isNull(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), "Koszt Zakupu" = isNull(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi&#xD;
      /* &#xD;
       ----------DATY POINT&#xD;
     ,"Data Rezerwacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
     ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataDok, 111), ''/'', ''-'')&#xD;
     ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
     */&#xD;
       ----------DATY ANALIZY&#xD;
     ,"Data Rezerwacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
     ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataDok, 111), ''/'', ''-'')&#xD;
     ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ &#xD;
     ,"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe) &#xD;
&#xD;
       ----------KONTEKSTY&#xD;
    ,25039 [Dokument Numer __PROCID__RO__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__], '''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
       &#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT OUTER JOIN (&#xD;
           SELECT TE1.TrE_TrEID [TREID], SUM(TrS_Ilosc) [Ilosc]&#xD;
           FROM CDN.TraElem TE1&#xD;
           JOIN CDN.TraSElem ON TrS_TrEID = TE1.TrE_TrEID&#xD;
           WHERE TrS_TrEIdWydania &lt;&gt; 0&#xD;
           GROUP BY TE1.TrE_TrEID&#xD;
     ) AS IP ON TR.TrE_TrEId = IP.TREID     &#xD;
     /* LEFT OUTER JOIN (&#xD;
            SELECT TE1.TrE_TrEID [TREID], SUM(TE2.TrE_Ilosc) [Ilosc]&#xD;
            FROM CDN.TraElem TE1&#xD;
                JOIN CDN.TraNag TN1 ON TE1.TrE_TrNId = TN1.TrN_TrNID &#xD;
                JOIN CDN.TraNagRelacje TR1 ON TN1.TrN_TrNID = TR1.TrR_TrNId AND TR1.TrR_FaTyp = 306&#xD;
                JOIN CDN.TraNag TN2 ON TR1.TrR_FaId = TN2.TrN_TrNID&#xD;
                JOIN CDN.TraElem TE2 ON TE2.TrE_TrNId = TN2.TrN_TrNID AND TE2.TrE_Lp = TE1.TrE_Lp&#xD;
            GROUP BY TE1.TrE_TrEID&#xD;
     ) AS Zal ON TR.TrE_TrEId = Zal.TREID */     &#xD;
LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (308)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
  DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Status" caption="Dokument Status" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Pozostała" caption="Sprzedaż Ilość Pozostała" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut &amp;quot;ASD&amp;quot;" caption="Kontrahent Atrybut &amp;quot;ASD&amp;quot;" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut ~!@#$%^&amp;amp;*()_+-=&amp;lt;&amp;gt;,./" caption="Kontrahent Atrybut ~!@#$%^&amp;amp;*()_+-=&amp;lt;&amp;gt;,./" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut ['&amp;quot;;:{}[[[_--" caption="Kontrahent Atrybut ['&amp;quot;;:{}[[[_--" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS" caption="Dokument Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut &amp;quot;ASD&amp;quot; (K)" caption="Dokument Atrybut &amp;quot;ASD&amp;quot; (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DAWKA SZKODLIWA /MG/" caption="Produkt Atrybut DAWKA SZKODLIWA /MG/" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROŚLINA ŚWIATŁOLUBNA" caption="Produkt Atrybut ROŚLINA ŚWIATŁOLUBNA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut WYSOKOŚĆ" caption="Produkt Atrybut WYSOKOŚĆ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut REZLIZACJA" caption="Produkt Atrybut REZLIZACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wEAAAAHAhxbRG9rdW1lbnQgTnVtZXJdLltSTy80LzIwMDhd</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="False" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dokument Status"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość Pozostała"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="2" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="1" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość Pozostała" index="0" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="3" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="0" expanded="True" order="descending" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy dataFieldName="Sprzedaż Ilość Pozostała" /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" order="descending" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy dataFieldName="Sprzedaż Ilość Pozostała" /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Dokument Status" index="0" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;included&gt;&lt;value uniqueName="W realizacji" /&gt;&lt;/included&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę dokumentów RO, które są w realizacji razem ilością towaru pozostałą do realizacji.</a:description><a:id>63</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>1.27 Analiza RO pozostałych do realizacji</a:mainLinkName><a:modifiedOn>2025-05-23T17:31:30.33</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>5</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2013-01-23T11:37:57.807</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/*&#xD;
* Raport Sprzedaży w zakresie dat&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
	JOIN CDN.TraElem ON TrA_TrEId = TrE_TrEID&#xD;
	JOIN CDN.TraNag ON TrE_TrNId = TrN_TrNID&#xD;
WHERE&#xD;
	TrN_TypDokumentu IN (-1,302,305)&#xD;
	AND TrN_Bufor&lt;&gt;-1&#xD;
	AND TrE_Aktywny&lt;&gt;0&#xD;
	AND TrN_DataOpe BETWEEN @DATAOD AND @DATADO&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun], &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj], &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],  &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],&#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    Tre_Lp [Produkt Lp.],&#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy] &#xD;
    ,CAST(TR.TrE_Ilosc/(Twr_JMPrzelicznikL/Twr_JMPrzelicznikM) AS Decimal(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok] &#xD;
    &#xD;
    &#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND Trn.TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
	 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
     LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
AND trn.TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],   &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod],    &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],             &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    NULL [Produkt Lp.],&#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary],     &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Produkt Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,NULL [Produkt Pozycja Dokumentu]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/  &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	  LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmppozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2j/1TkAflu1qJpLRHJ6czE3BujRzlkUSaW8as+SjVAXoelJ5fuODTQnscD+DslihafV958jzfo3RdXYsmku2eJEY0lSvsR/XYwAYcufTKHYJbXyO6BdnoAagVw7fqNxEWDujw5hEHCVIKtaqZinJSWWw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR PARTII" caption="Produkt Atrybut NR PARTII" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAZNOSCI" caption="Produkt Atrybut DATA WAZNOSCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR PARTII" caption="Pozycja Atrybut NR PARTII" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAZNOSCI" caption="Pozycja Atrybut DATA WAZNOSCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[19f5c91f-3fc7-4a9a-ae4f-ce81b43d3c06]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data początkowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Początkowa data analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-08-21&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data końcowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Końcowa data analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-09-20&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="311" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[19f5c91f-3fc7-4a9a-ae4f-ce81b43d3c06]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport umożliwia standardową analizę sprzedaży dla określonego podczas uruchamiania zakresu dat dokumentów sprzedaży.</a:description><a:id>64</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.28 Sprzedaż w zakresie dat</a:mainLinkName><a:modifiedOn>2025-05-23T17:30:21.307</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2013-01-25T15:15:45.037</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży z fakturami zaliczkowymi&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @kolumny2 varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @kolumny2 = @kolumny2 + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = NULL'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'            &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'')           &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
DECLARE @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', NULL [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
					 &#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''') &#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, &#xD;
    "Dokument Numer" = trn.TrN_NumerPelny, &#xD;
"Dokument Symbol" = dd.DDf_Symbol,&#xD;
ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
     Waluta = CASE WHEN trn.TrN_Waluta = '''' THEN @Wal ELSE trn.TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),      &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],       &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
       "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Kraj" = CASE WHEN pod3.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Kraj END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU], &#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],    &#xD;
       "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)), "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Kaucja" = CASE WHEN TR.TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm,       &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
                                                WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
                                                ELSE ''NIE'' END,&#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" =  CASE WHEN (ISNULL(trn.TrN_RazemNetto,0) = ISNULL(pro.TrN_RazemNetto,0) or ISNULL(trn.TrN_RazemNettoWal,0) = ISNULL(pro.TrN_RazemNettoWal,0)) THEN trpro.Tre_Ilosc  ELSE TR.TrE_Ilosc END,&#xD;
       "Koszt Zakupu" = CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)),&#xD;
TR.TrE_Ilosc * (TR.TrE_Cena0WD - (TR.TrE_CenaWWD/TR.TrE_JMPrzelicznikL*TR.TrE_JMPrzelicznikM)) * TR.TrE_KursL / TR.TrE_KursM [Sprzedaż Rabat]&#xD;
        ,ISNULL(kzal.Knt_Kod,''(BRAK)'') [Podmiot Pobierający Zaliczkę Kod] &#xD;
        ,ISNULL(kzal.Knt_Nazwa1,''(BRAK)'') [Podmiot Pobierający Zaliczkę Nazwa] &#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
       ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'')&#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
       ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ &#xD;
       ,"Data Operacji Miesiąc" = MONTH(trn.TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, trn.TrN_DataOpe), "Data Operacji Rok" = YEAR(trn.TrN_DataOpe)&#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ &#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(trn.TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, trn.TrN_DataWys), "Data Wystawienia Rok" = YEAR(trn.TrN_DataWys) &#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(trn.TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, trn.TrN_Termin), "Termin Płatności Rok" = YEAR(trn.TrN_Termin) &#xD;
&#xD;
----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__], '''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__], '''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca KOd __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select = @select +&#xD;
' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TR.TrE_TrNID=trn.TrN_TrNID &#xD;
    LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
    LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TR.TrE_PodID=knt1.Knt_KntId AND TR.TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TR.TrE_PodID= pod1.Pod_PodId AND TR.TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TR.TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TR.TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TR.TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TR.TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TR.TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
    LEFT JOIN CDN.Kontrahenci kzal ON kzal.Knt_KntId = trn.TrN_PodZalId&#xD;
	--KF 20.11.24 Po co łączymy sie do proformy skoro w 2 Unionie są zaliczkowe?&#xD;
     ------dodanie joina do wzorcowych faktur proforma, jeśli kwota całkowita proformy odpowiada całkowitej kwocie faktury zaliczkowej + join do elementów i ilości &#xD;
   &#xD;
	 LEFT JOIN  cdn.TraFakZaliczkowe on  TrZ_TrNID = trn.TrN_TrNID&#xD;
	 left join cdn.tranag pro on TrZ_FZID = pro.trn_trnid   &#xD;
     left join cdn.TraElem TRpro ON trpro.TrE_TrNID=pro.trn_TrNID and (trn.TrN_RazemNetto = pro.TrN_RazemNetto or trn.TrN_RazemNettoWal = pro.TrN_RazemNettoWal) and trpro.TrE_TwrId = tr.TrE_TwrId and trpro.tre_lp = tr.tre_lp    &#xD;
     -------&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND (TR.TrE_Aktywny&lt;&gt;0 OR trn.TrN_Rodzaj IN (302200, 302202))&#xD;
AND TR.TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL '&#xD;
&#xD;
set @select2 ='&#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, &#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
 "Dokument Symbol" = dd.DDf_Symbol,&#xD;
 ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = NULL,&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = NULL,&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod],&#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
       "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Kraj" = CASE WHEN pod3.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Kraj END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = NULL,&#xD;
    "Produkt Nazwa" = ''Faktura zaliczkowa '' + TrZ_NumerPelny,&#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU], &#xD;
    NULL [Produkt Dostawca],&#xD;
    "Produkt Kod" = ''Faktura zaliczkowa '' + TrZ_NumerPelny,&#xD;
    NULL [Produkt Aktywny],&#xD;
       "Produkt Numer Katalogowy" = NULL, "Produkt Opis" = NULL, "Produkt Pełna Nazwa Grupy" = NULL, "Produkt Kaucja" = NULL,&#xD;
       "Jednostka Miary" = NULL,       &#xD;
    "Magazyn Nazwa" = NULL,    &#xD;
        "Produkt Producent" = NULL, "Produkt Marka" = NULL, "Produkt Typ" = NULL,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
                                                WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
                                                ELSE ''NIE'' END,&#xD;
            --"Sprzedaż Wartość" = -TrZ_KwotaNettoSys, "Sprzedaż Wartość Brutto" = -TrZ_KwotaBruttoSys,&#xD;
       "Sprzedaż Wartość" = -TrZ_KwotaNetto * TrN_KursL / ISNULL(TrN_KursM,1), "Sprzedaż Wartość Brutto" = -TrZ_KwotaBrutto * TrN_KursL / ISNULL(TrN_KursM,1),&#xD;
    "Sprzedaż Wartość Waluta" = -TrZ_KwotaNetto, &#xD;
       "Sprzedaż Ilość" = NULL, "Koszt Zakupu" = NULL,&#xD;
        "Sprzedaż Marża" = NULL,  NULL [Sprzedaż Rabat]&#xD;
        ,ISNULL(kzal.Knt_Kod,''(BRAK)'') [Podmiot Pobierający Zaliczkę Kod] &#xD;
        ,ISNULL(kzal.Knt_Nazwa1,''(BRAK)'') [Podmiot Pobierający Zaliczkę Nazwa] &#xD;
/*  &#xD;
    ----------DATY POINT&#xD;
      ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
      ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
      ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'')&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
      ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ &#xD;
      ,"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe) &#xD;
      ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ &#xD;
      ,"Data Wystawienia Miesiąc" = MONTH(TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TrN_DataWys), "Data Wystawienia Rok" = YEAR(TrN_DataWys)&#xD;
      ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ &#xD;
      ,"Termin Płatności Miesiąc" = MONTH(TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TrN_Termin), "Termin Płatności Rok" = YEAR(TrN_Termin)&#xD;
&#xD;
        ----------KONTEKSTY&#xD;
    ,29126 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__], '''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,29126 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,29126 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29126 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
        &#xD;
        '&#xD;
       + @kolumny2 + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
&#xD;
set @select2 = @select2 + &#xD;
' FROM cdn.TraFakZaliczkowe&#xD;
     JOIN cdn.TraNag ON TrZ_TrNID=TrN_TrNID &#xD;
LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8&#xD;
 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.Kontrahenci kzal ON kzal.Knt_KntId = TrN_PodZalId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrZ_Uwzgledniac = 1&#xD;
AND TrN_Anulowany &lt;&gt; -2147483647&#xD;
&#xD;
'&#xD;
&#xD;
print (@select + @select2)&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5oGgM7ZyTqUt95ZsUhznLPGaI6d6f6KTDb9vY+wQZ9uZ1Osv9PWBRjxK7063do1EP3SFXPCnnPfLlapWirHqSc4A8x791GnStC1DFwQ7mHQlsrGFxXfnYiGT4TZT1NeEUw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podmiot Pobierający Zaliczkę Kod" caption="Podmiot Pobierający Zaliczkę Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pobierający Zaliczkę Nazwa" caption="Podmiot Pobierający Zaliczkę Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut BUDŻET FA/FZ" caption="Dokument Atrybut BUDŻET FA/FZ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut BUDŻET PZ/PA" caption="Dokument Atrybut BUDŻET PZ/PA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DATAWAŻNOSCI" caption="Dokument Atrybut DATAWAŻNOSCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DATAWAZLICZBADNI" caption="Dokument Atrybut DATAWAZLICZBADNI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NUMER SERYJNY" caption="Pozycja Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[5bfce9e3-6591-44b6-84e4-e890e2e431ff]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wYAAAAHAhZbRG9rdW1lbnQgU3ltYm9sXS5bRkFdBwIYW0Rva3VtZW50IFN5bWJvbF0uW0ZBUEZdBwIYW0Rva3VtZW50IFN5bWJvbF0uW0ZBVUVdBwIYW0Rva3VtZW50IFN5bWJvbF0uW0ZBWkxdBwIYW0Rva3VtZW50IFN5bWJvbF0uW0ZLT1JdBwIWW0Rva3VtZW50IFN5bWJvbF0uW1BBXQ==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="275" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[5bfce9e3-6591-44b6-84e4-e890e2e431ff]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dokument Symbol"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Dokument Symbol" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje dokumenty sprzedaży z fakturami zaliczkowymi, które zostały do nich wystawione. Wartośc faktury końcowej jest pomniejszona o wartość faktur zaliczkowych.</a:description><a:id>65</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.29 Sprzedaż z fakturami zaliczkowymi</a:mainLinkName><a:modifiedOn>2025-05-23T17:29:05.88</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2013-02-12T12:04:27.163</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Faktury nierozliczone&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'           &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Wyliczanie statusu rozliczenia&#xD;
--SELECT TrN_TrNId [NagID], &#xD;
--CASE &#xD;
--  WHEN Z.BZd_Rozliczono=1 AND Z.BZd_Rozliczono2=1 THEN 'Nierozliczony' &#xD;
--  WHEN Z.BZd_Rozliczono=2 THEN 'Rozliczony' &#xD;
--  WHEN Z.BZd_Rozliczono=1 AND Z.BZd_Rozliczono2=2 THEN 'Częściowo Rozliczony' &#xD;
--  WHEN (Z.BZd_Rozliczono=0 AND Z.BZd_Rozliczono2=0) OR TrN_BlokadaPlatnosci = 1 THEN 'Nie podlega'&#xD;
--  WHEN Z.BZd_Rozliczono=2 AND Z.BZd_Rozliczono2=2 THEN 'Rozliczany w całości'&#xD;
--ELSE '(BRAK)' END [StatusRoz]&#xD;
--INTO #tmpRozliczenia&#xD;
--FROM CDN.TraNag&#xD;
--JOIN(&#xD;
--  SELECT BZd_DokumentID, MIN(BZd_Rozliczono) [BZd_Rozliczono], MAX(BZd_Rozliczono2) [BZd_Rozliczono2]&#xD;
--  FROM CDN.BnkZdarzenia&#xD;
--  WHERE BZd_DokumentTyp = 1&#xD;
--  GROUP BY BZd_DokumentID&#xD;
--)Z ON Z.BZd_DokumentID = TrN_TrNID&#xD;
SELECT TrN_TrNId [NagID], &#xD;
CASE&#xD;
    WHEN Z.Rozliczono &lt; 10 OR TrN_BlokadaPlatnosci = 1 THEN 'Nie podlega'  &#xD;
    WHEN Z.Rozliczono &lt; 100 THEN 'Rozliczony' &#xD;
    WHEN Z.Rozliczono &lt; 1000 THEN 'Częściowo Rozliczony' &#xD;
    WHEN Z.Rozliczono % 1000 &lt;&gt; 0 THEN 'Częściowo Rozliczony' &#xD;
    WHEN Z.Rozliczono &lt; 10000 THEN 'Nierozliczony' &#xD;
ELSE '(BRAK)' END [StatusRoz]&#xD;
INTO #tmpRozliczenia&#xD;
FROM CDN.TraNag&#xD;
JOIN(&#xD;
    SELECT BZd_DokumentID, &#xD;
    SUM(CASE&#xD;
        WHEN BZd_Rozliczono = 0 THEN 1   &#xD;
        WHEN BZd_Rozliczono = 2 THEN 10&#xD;
        WHEN BZd_Rozliczono = 1 AND BZd_Rozliczono2 = 2 THEN 100&#xD;
        WHEN BZd_Rozliczono = 1 AND BZd_Rozliczono2 = 1 THEN 1000&#xD;
    END) [Rozliczono]&#xD;
    FROM CDN.BnkZdarzenia&#xD;
    WHERE BZd_DokumentTyp = 1&#xD;
    GROUP BY BZd_DokumentID&#xD;
)Z ON Z.BZd_DokumentID = TrN_TrNID&#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
DECLARE @select VARCHAR(MAX), @select2 VARCHAR(MAX);&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3) &#xD;
Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT &#xD;
    --Wymiary&#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    F.TrN_NumerPelny [Dokument Numer],  &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(F.TrN_NumerPelny,0,CHARINDEX(''/'',F.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(F.TrN_NumerPelny,CHARINDEX(''/'',F.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(F.TrN_Opis,''''),''(BRAK)'') [Dokument Opis], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(NULLIF(F.TrN_Waluta, ''''), @Wal) [Dokument Waluta], &#xD;
    ISNULL(Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna], ISNULL(Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa],    &#xD;
    knt.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    knt.Pod_Nazwa1 + knt.Pod_Nazwa2 [Kontrahent Pierwotny Nazwa], &#xD;
    ISNULL(NULLIF(knt.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto], &#xD;
    ISNULL(NULLIF(knt.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(knt.Pod_NIP, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP], &#xD;
    ISNULL(NULLIF(knt.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(knt.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa],&#xD;
    odb.Pod_Kod [Odbiorca Kod], &#xD;
    odb.Pod_Nazwa1 + odb.Pod_Nazwa2 [Odbiorca Nazwa],   &#xD;
    ISNULL(NULLIF(odb.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Miasto], &#xD;
    ISNULL(NULLIF(odb.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Kraj], &#xD;
    ISNULL(NULLIF(odb.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(odb.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    CASE &#xD;
        WHEN opk.Knt_OpiekunTyp = 3 THEN ISNULL(opp.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN opk.Knt_OpiekunTyp = 8 THEN ISNULL(op.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE opk.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN Z2.DokRoz&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Dokument Rozliczający Numer],&#xD;
    ISNULL(StatusRoz, ''Nie dotyczy'') [Status Rozliczenia],    &#xD;
    ''(NIEPRZYPISANY)'' as [Zakład Symbol],&#xD;
    ''(NIEPRZYPISANY)'' as [Zakład Nazwa Firmy], &#xD;
    --Miary&#xD;
    F.TrN_RazemNetto/zc.walc [Sprzedaż Wartość], F.TrN_RazemBrutto/zc.walc [Sprzedaż Wartość Brutto], &#xD;
    KosztWyliczony.Koszt/zc.walc [Koszt Zakupu], (F.TrN_RazemNetto - KosztWyliczony.Koszt)/zc.walc [Sprzedaż Marża], F.TrN_RabatWartosc/zc.walc [Sprzedaż Rabat],&#xD;
    F.TrN_RazemNettoWal/zc.walc [Sprzedaż Wartość Waluta], F.TrN_RazemBruttoWal/zc.walc [Sprzedaż Wartość Brutto Waluta],   &#xD;
    CASE WHEN F.TrN_Rodzaj IN (302001,302002,302005,302007,302091,302092,302101,302102,305001,305005,305101) THEN&#xD;
    -1*NULLIF(ISNULL(Z.BZd_KwotaSys - Z.BZd_KwotaRozSys - Z.BZd_KwotaNPSys, F.TrN_RazemBrutto),0)&#xD;
    ELSE NULLIF(ISNULL(Z.BZd_KwotaSys - Z.BZd_KwotaRozSys - Z.BZd_KwotaNPSys, F.TrN_RazemBrutto),0) END [Kwota Nierozliczona], &#xD;
    NULLIF(ISNULL(Z.BZd_Kwota - Z.BZd_KwotaRoz - Z.BZd_KwotaNP, F.TrN_RazemBruttoWal),0) [Kwota Nierozliczona Waluta],&#xD;
    NULL [Kwota Rozliczona], NULL [Kwota Rozliczona Waluta], Z.BZd_KwotaNPSys [Kwota Nie Podlega], Z.BZd_KwotaNP [Kwota Nie Podlega Waluta],&#xD;
    ISNULL(NULLIF(Z.wal, ''''), @Wal) [Rozliczenie Waluta],&#xD;
    CASE &#xD;
        WHEN StatusRoz = ''Nie podlega'' THEN NULL&#xD;
        WHEN StatusRoz &lt;&gt; ''Rozliczony'' THEN CASE WHEN DATEDIFF(DAY,F.TrN_Termin,GETDATE()) &lt; 0 THEN 0 ELSE DATEDIFF(DAY,F.TrN_Termin,GETDATE()) END&#xD;
        ELSE NULL&#xD;
    END [Liczba Dni Przeterminowania]&#xD;
/*  &#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Sprzedaży]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN REPLACE(CONVERT(VARCHAR(10), Z2.BZd_DataRoz, 111), ''/'', ''-'')&#xD;
            END [Data Rozliczenia]&#xD;
            ,REPLACE(CONVERT(VARCHAR(10), F.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Sprzedaży Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, F.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Sprzedaży Tydzień Roku], MONTH(F.TrN_DataOpe) [Data Sprzedaży Miesiąc]&#xD;
    ,DATEPART(quarter, F.TrN_DataOpe) [Data Sprzedaży Kwartał], YEAR(F.TrN_DataOpe) [Data Sprzedaży Rok]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN REPLACE(CONVERT(VARCHAR(10), Z2.BZd_DataRoz, 111), ''/'', ''-'')&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Dzień]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN CONVERT(VARCHAR(10), MONTH(Z2.BZd_DataRoz))&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Miesiąc]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN CONVERT(VARCHAR(10), DATEPART(quarter, Z2.BZd_DataRoz))&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Kwartał]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN CONVERT(VARCHAR(10), YEAR(Z2.BZd_DataRoz))&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN F.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], F.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], knt.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__], '''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], knt.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], odb.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], odb.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    &#xD;
    &#xD;
    ' + @atrybuty + @atrybutyDok&#xD;
     &#xD;
SET @select2 = ' &#xD;
FROM &#xD;
    CDN.TraNag F&#xD;
    LEFT JOIN #tmpSeria ser ON F.TrN_DDfId = DDf_DDfID&#xD;
    LEFT JOIN CDN.DokDefinicje dd ON F.TrN_DDfId = dd.DDf_DDfID &#xD;
    JOIN CDN.PodmiotyView knt ON F.TrN_PodID = knt.Pod_PodId AND F.TrN_PodmiotTyp = knt.Pod_PodmiotTyp&#xD;
    JOIN CDN.PodmiotyView odb ON F.TrN_OdbID = odb.Pod_PodId AND F.TrN_OdbiorcaTyp = odb.Pod_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci opk ON F.TrN_PodID = opk.Knt_KntId AND F.TrN_PodmiotTyp = 1&#xD;
    LEFT JOIN cdn.PodmiotyView opp ON opk.Knt_OpiekunId = opp.Pod_PodId AND opk.Knt_OpiekunTyp = opp.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt2 ON F.TrN_OdbId = knt2.Knt_KntId AND F.TrN_OdbiorcaTyp = 1&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op ON opk.Knt_OpiekunId = op.Ope_OpeId AND opk.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON F.TrN_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON F.TrN_OpeModID = mod.Ope_OpeId&#xD;
    LEFT JOIN CDN.Kategorie ON F.TrN_KatID = Kat_KatID&#xD;
    LEFT JOIN CDN.FormyPlatnosci ON F.TrN_FPlId = FPl_FPlId&#xD;
    LEFT JOIN (&#xD;
        SELECT Bzd_Waluta wal, BZd_DokumentID, SUM(BZd_KwotaSys) [BZd_KwotaSys], SUM(BZd_KwotaRozSys) [BZd_KwotaRozSys], SUM(BZd_Kwota) [BZd_Kwota], SUM(BZd_KwotaRoz) [BZd_KwotaRoz],&#xD;
        SUM(CASE WHEN BzD_Rozliczono = 0 THEN BZd_KwotaSys ELSE 0 END) [BZd_KwotaNPSys], SUM(CASE WHEN BzD_Rozliczono = 0 THEN BZd_Kwota ELSE 0 END) [BZd_KwotaNP]&#xD;
        FROM CDN.BnkZdarzenia&#xD;
        WHERE BZd_DokumentTyp = 1 &#xD;
        GROUP BY BZd_DokumentID, BZd_Waluta&#xD;
    )Z ON Z.BZd_DokumentID = F.TrN_TrNID&#xD;
        LEFT JOIN (&#xD;
        SELECT COUNT(Bzd_Waluta) walc, BZd_DokumentID&#xD;
        FROM CDN.BnkZdarzenia&#xD;
        WHERE BZd_DokumentTyp = 1&#xD;
        GROUP BY BZd_DokumentID&#xD;
    )ZC ON ZC.BZd_DokumentID = F.TrN_TrNID&#xD;
    LEFT JOIN (&#xD;
        SELECT BZd_DokumentID, MAX(BZd_DataRoz) [BZd_DataRoz], COUNT(L.BRK_BRKID) + COUNT(P.BRK_BRKID) [LZD], &#xD;
        MAX(CASE WHEN BZd_BZdID = L.BRK_LDokID THEN L.BRK_PNumer ELSE P.BRK_LNumer END) [DokRoz]&#xD;
        FROM CDN.BnkZdarzenia&#xD;
        LEFT JOIN CDN.BnkRozKwoty L ON BZd_BZdID = L.BRK_LDokID AND L.BRK_LDokTyp = 1&#xD;
        LEFT JOIN CDN.BnkRozKwoty P ON BZd_BZdID = P.BRK_PDokID AND P.BRK_PDokTyp = 1&#xD;
        WHERE BZd_DokumentTyp = 1&#xD;
        GROUP BY BZd_DokumentID&#xD;
    )Z2 ON Z2.BZd_DokumentID = F.TrN_TrNID&#xD;
    LEFT JOIN #tmpRozliczenia ON NagId = F.TrN_trNID&#xD;
    LEFT JOIN #tmpKonAtr KonAtr ON knt.Pod_PodId = KonAtr.KnA_PodmiotId AND knt.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
    LEFT JOIN #tmpDokAtr DokAtr ON F.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
    LEFT JOIN CDN.TraNag P ON F.TrN_FaId = P.TrN_TrNID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on knt.Pod_GlID = pod5.Pod_PodId and knt.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrnID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrnID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrnID = f.Trn_TrnID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE &#xD;
    F.TrN_TypDokumentu IN (-1,302,305)&#xD;
    AND F.TrN_Rodzaj &lt;&gt; 302100&#xD;
    AND F.TrN_Rodzaj &lt;&gt; 305100&#xD;
    AND F.TrN_Bufor&lt;&gt;-1&#xD;
    AND ISNULL(P.TrN_TypDokumentu,302) &lt;&gt; 305&#xD;
    &#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
    --Wymiary&#xD;
    BAZ.Baz_Nazwa [Baza Firmowa],   &#xD;
    F.TrN_NumerPelny [Dokument Numer], &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(F.TrN_NumerPelny,0,CHARINDEX(''/'',F.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(F.TrN_NumerPelny,CHARINDEX(''/'',F.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(F.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(NULLIF(F.TrN_Waluta, ''''), @Wal) [Dokument Waluta], &#xD;
    ISNULL(Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna], ISNULL(Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa],    &#xD;
    knt.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    knt.Pod_Nazwa1 + knt.Pod_Nazwa2 [Kontrahent Pierwotny Nazwa],   &#xD;
    ISNULL(NULLIF(knt.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto], &#xD;
    ISNULL(NULLIF(knt.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], &#xD;
    ISNULL(NULLIF(knt.Pod_NIP, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP], &#xD;
    ISNULL(NULLIF(knt.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(knt.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa],&#xD;
    odb.Pod_Kod [Odbiorca Kod],     &#xD;
    odb.Pod_Nazwa1 + odb.Pod_Nazwa2 [Odbiorca Nazwa],   &#xD;
    ISNULL(NULLIF(odb.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Miasto], &#xD;
    ISNULL(NULLIF(odb.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Kraj], &#xD;
    ISNULL(NULLIF(odb.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(odb.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    CASE &#xD;
        WHEN opk.Knt_OpiekunTyp = 3 THEN ISNULL(opp.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN opk.Knt_OpiekunTyp = 8 THEN ISNULL(op.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun], &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE opk.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    BRK_PNumer [Dokument Rozliczający Numer],    &#xD;
    StatusRoz [Status Rozliczenia],&#xD;
    isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
    isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
    --Miary&#xD;
    NULL [Sprzedaż Wartość], NULL [Sprzedaż Wartość Brutto], NULL [Koszt Zakupu], NULL [Sprzedaż Marża], NULL [Sprzedaż Rabat], NULL [Sprzedaż Wartość Waluta], &#xD;
    NULL [Sprzedaż Wartość Brutto Waluta], NULL [Kwota Nierozliczona],  NULL [Kwota Nierozliczona Waluta], &#xD;
    BRK_KwotaSysL [Kwota Rozliczona], BRK_Kwota [Kwota Rozliczona Waluta], NULL [Kwota Nie Podlega], NULL [Kwota Nie Podlega Waluta],&#xD;
    ISNULL(NULLIF(F.TrN_Waluta, ''''), @Wal) [Rozliczenie Waluta],&#xD;
    CASE WHEN DATEDIFF(DAY,BZd_Termin,BRK_DataDok) &lt; 0 THEN 0 ELSE DATEDIFF(DAY,BZd_Termin,BRK_DataDok) END [Liczba Dni Przeterminowania] &#xD;
/*  &#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Sprzedaży] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BRK_DataDok, 111), ''/'', ''-'') [Data Rozliczenia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BZd_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Sprzedaży Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, F.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Sprzedaży Tydzień Roku], MONTH(F.TrN_DataOpe) [Data Sprzedaży Miesiąc]&#xD;
    ,DATEPART(quarter, F.TrN_DataOpe) [Data Sprzedaży Kwartał], YEAR(F.TrN_DataOpe) [Data Sprzedaży Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BRK_DataDok, 111), ''/'', ''-'') [Data Rozliczenia Dzień]&#xD;
    ,CONVERT(VARCHAR(10),MONTH(BRK_DataDok)) [Data Rozliczenia Miesiąc], CONVERT(VARCHAR(10),DATEPART(quarter, BRK_DataDok)) [Data Rozliczenia Kwartał] &#xD;
    ,CONVERT(VARCHAR(10),YEAR(BRK_DataDok)) [Data Rozliczenia Rok]&#xD;
    ,ISNULL(REPLACE(CONVERT(VARCHAR(10), BZd_Termin, 111), ''/'', ''-''),''(Nierozliczony)'') [Termin Płatności Dzień]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN F.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], F.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], knt.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__], '''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], knt.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], odb.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], odb.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    &#xD;
    &#xD;
    ' &#xD;
    + @atrybuty + @atrybutyDok + ' &#xD;
FROM &#xD;
    CDN.TraNag F&#xD;
    LEFT JOIN #tmpSeria ser ON F.TrN_DDfId = DDf_DDfID&#xD;
    LEFT JOIN CDN.DokDefinicje dd ON F.TrN_DDfId = dd.DDf_DDfID&#xD;
    JOIN CDN.BnkZdarzenia ON BZd_DokumentID = F.TrN_TrNID AND BZd_DokumentTyp = 1&#xD;
    JOIN CDN.BnkRozKwoty ON BRK_LDokID = BZd_BZdID AND BRK_LDokTyp = 1&#xD;
    JOIN CDN.PodmiotyView knt ON F.TrN_PodID = knt.Pod_PodId AND F.TrN_PodmiotTyp = knt.Pod_PodmiotTyp&#xD;
    JOIN CDN.PodmiotyView odb ON F.TrN_OdbID = odb.Pod_PodId AND F.TrN_OdbiorcaTyp = odb.Pod_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci opk ON F.TrN_PodID = opk.Knt_KntId AND F.TrN_PodmiotTyp = 1&#xD;
    LEFT JOIN cdn.PodmiotyView opp ON opk.Knt_OpiekunId = opp.Pod_PodId AND opk.Knt_OpiekunTyp = opp.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON F.TrN_OdbId = knt2.Knt_KntId AND F.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op ON opk.Knt_OpiekunId = op.Ope_OpeId AND opk.Knt_OpiekunTyp = 8 &#xD;
 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON F.TrN_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON F.TrN_OpeModID = mod.Ope_OpeId&#xD;
    LEFT JOIN CDN.Kategorie ON F.TrN_KatID = Kat_KatID&#xD;
    LEFT JOIN CDN.FormyPlatnosci ON F.TrN_FPlId = FPl_FPlId&#xD;
    LEFT JOIN #tmpRozliczenia ON NagId = F.TrN_trNID&#xD;
    LEFT JOIN #tmpKonAtr KonAtr ON knt.Pod_PodId = KonAtr.KnA_PodmiotId AND knt.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
    LEFT JOIN #tmpDokAtr DokAtr ON F.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
    LEFT JOIN CDN.TraNag P ON F.TrN_FaId = P.TrN_TrNID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on knt.Pod_GlID = pod5.Pod_PodId and knt.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = BRK_ZakID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE &#xD;
    F.TrN_TypDokumentu IN (-1,302,305)&#xD;
    AND F.TrN_Rodzaj &lt;&gt; 302100&#xD;
    AND F.TrN_Rodzaj &lt;&gt; 305100&#xD;
    AND F.TrN_Bufor&lt;&gt;-1&#xD;
    AND ISNULL(P.TrN_TypDokumentu,302) &lt;&gt; 305&#xD;
    &#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
    --Wymiary&#xD;
    BAZ.Baz_Nazwa [Baza Firmowa],   &#xD;
    F.TrN_NumerPelny [Dokument Numer],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(F.TrN_NumerPelny,0,CHARINDEX(''/'',F.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(F.TrN_NumerPelny,CHARINDEX(''/'',F.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(F.TrN_Opis,''''),''(BRAK)'') [Dokument Opis], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(NULLIF(F.TrN_Waluta, ''''), @Wal) [Dokument Waluta], &#xD;
    ISNULL(Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna], ISNULL(Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa],        &#xD;
    knt.Pod_Kod [Kontrahent Kod], &#xD;
    knt.Pod_Nazwa1 + knt.Pod_Nazwa2 [Kontrahent Nazwa],     &#xD;
    ISNULL(NULLIF(knt.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Miasto], &#xD;
    ISNULL(NULLIF(knt.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(knt.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP], &#xD;
    ISNULL(NULLIF(knt.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(knt.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa],&#xD;
    odb.Pod_Kod [Odbiorca Kod], &#xD;
    odb.Pod_Nazwa1 + odb.Pod_Nazwa2 [Odbiorca Nazwa],   &#xD;
    ISNULL(NULLIF(odb.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Miasto], &#xD;
    ISNULL(NULLIF(odb.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Kraj], &#xD;
    ISNULL(NULLIF(odb.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(odb.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    CASE &#xD;
        WHEN opk.Knt_OpiekunTyp = 3 THEN ISNULL(opp.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN opk.Knt_OpiekunTyp = 8 THEN ISNULL(op.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE opk.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    BRK_LNumer [Dokument Rozliczający Numer], &#xD;
    StatusRoz [Status Rozliczenia],&#xD;
    isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
    isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
    --Miary&#xD;
    NULL [Sprzedaż Wartość], NULL [Sprzedaż Wartość Brutto], NULL [Koszt Zakupu], NULL [Sprzedaż Marża], NULL [Sprzedaż Rabat], NULL [Sprzedaż Wartość Waluta], &#xD;
    NULL [Sprzedaż Wartość Brutto Waluta], NULL [Kwota Nierozliczona], NULL [Kwota Nierozliczona Waluta],&#xD;
    BRK_KwotaSysP [Kwota Rozliczona], BRK_Kwota [Kwota Rozliczona Waluta], NULL [Kwota Nie Podlega], NULL [Kwota Nie Podlega Waluta],&#xD;
    ISNULL(NULLIF(F.TrN_Waluta, ''''), @Wal) [Rozliczenie Waluta],&#xD;
    CASE WHEN DATEDIFF(DAY,BZd_Termin,BRK_DataDok) &lt; 0 THEN 0 ELSE DATEDIFF(DAY,BZd_Termin,BRK_DataDok) END [Liczba Dni Przeterminowania]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Sprzedaży] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BRK_DataDok, 111), ''/'', ''-'') [Data Rozliczenia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BZd_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Sprzedaży Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, F.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Sprzedaży Tydzień Roku], MONTH(F.TrN_DataOpe) [Data Sprzedaży Miesiąc]&#xD;
    ,DATEPART(quarter, F.TrN_DataOpe) [Data Sprzedaży Kwartał], YEAR(F.TrN_DataOpe) [Data Sprzedaży Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BRK_DataDok, 111), ''/'', ''-'') [Data Rozliczenia Dzień]&#xD;
    ,CONVERT(VARCHAR(10),MONTH(BRK_DataDok)) [Data Rozliczenia Miesiąc], CONVERT(VARCHAR(10),DATEPART(quarter, BRK_DataDok)) [Data Rozliczenia Kwartał]&#xD;
    ,CONVERT(VARCHAR(10),YEAR(BRK_DataDok)) [Data Rozliczenia Rok]  &#xD;
    ,ISNULL(REPLACE(CONVERT(VARCHAR(10), BZd_Termin, 111), ''/'', ''-''),''(Nierozliczony)'') [Termin Płatności Dzień]&#xD;
    &#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN F.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], F.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], knt.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], knt.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], odb.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], odb.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    &#xD;
    ' &#xD;
    + @atrybuty + @atrybutyDok + ' &#xD;
FROM &#xD;
    CDN.TraNag F&#xD;
    LEFT JOIN #tmpSeria ser ON F.TrN_DDfId = DDf_DDfID&#xD;
    LEFT JOIN CDN.DokDefinicje dd ON F.TrN_DDfId = dd.DDf_DDfID&#xD;
    JOIN CDN.BnkZdarzenia ON BZd_DokumentID = F.TrN_TrNID AND BZd_DokumentTyp = 1&#xD;
    JOIN CDN.BnkRozKwoty ON BRK_PDokID = BZd_BZdID AND BRK_PDokTyp = 1&#xD;
    JOIN CDN.PodmiotyView knt ON F.TrN_PodID = knt.Pod_PodId AND F.TrN_PodmiotTyp = knt.Pod_PodmiotTyp&#xD;
    JOIN CDN.PodmiotyView odb ON F.TrN_OdbID = odb.Pod_PodId AND F.TrN_OdbiorcaTyp = odb.Pod_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci opk ON F.TrN_PodID = opk.Knt_KntId AND F.TrN_PodmiotTyp = 1&#xD;
    LEFT JOIN cdn.PodmiotyView opp ON opk.Knt_OpiekunId = opp.Pod_PodId AND opk.Knt_OpiekunTyp = opp.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON F.TrN_OdbId = knt2.Knt_KntId AND F.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op ON opk.Knt_OpiekunId = op.Ope_OpeId AND opk.Knt_OpiekunTyp = 8 &#xD;
 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON F.TrN_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON F.TrN_OpeModID = mod.Ope_OpeId&#xD;
    LEFT JOIN CDN.Kategorie ON F.TrN_KatID = Kat_KatID&#xD;
    LEFT JOIN CDN.FormyPlatnosci ON F.TrN_FPlId = FPl_FPlId&#xD;
    LEFT JOIN #tmpRozliczenia ON NagId = F.TrN_trNID&#xD;
    LEFT JOIN #tmpKonAtr KonAtr ON knt.Pod_PodId = KonAtr.KnA_PodmiotId AND knt.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
    LEFT JOIN #tmpDokAtr DokAtr ON F.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
    LEFT JOIN CDN.TraNag P ON F.TrN_FaId = P.TrN_TrNID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on knt.Pod_GlID = pod5.Pod_PodId and knt.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = BRK_ZakID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE &#xD;
    F.TrN_TypDokumentu IN (-1,302,305)&#xD;
    AND F.TrN_Rodzaj &lt;&gt; 302100&#xD;
    AND F.TrN_Rodzaj &lt;&gt; 305100&#xD;
    AND F.TrN_Bufor&lt;&gt;-1&#xD;
    AND ISNULL(P.TrN_TypDokumentu,302) &lt;&gt; 305&#xD;
&#xD;
'&#xD;
PRINT(@select + @select2)&#xD;
EXEC(@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpRozliczenia&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Waluta" caption="Dokument Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Dzień" caption="Data Sprzedaży Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Tydzień Roku" caption="Data Sprzedaży Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Miesiąc" caption="Data Sprzedaży Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Kwartał" caption="Data Sprzedaży Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Rok" caption="Data Sprzedaży Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna" caption="Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa" caption="Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Rozliczający Numer" caption="Dokument Rozliczający Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Dzień" caption="Data Rozliczenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Miesiąc" caption="Data Rozliczenia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Kwartał" caption="Data Rozliczenia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Rok" caption="Data Rozliczenia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Status Rozliczenia" caption="Status Rozliczenia" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto Waluta" caption="Sprzedaż Wartość Brutto Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nierozliczona" caption="Kwota Nierozliczona" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nierozliczona Waluta" caption="Kwota Nierozliczona Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Rozliczona" caption="Kwota Rozliczona" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Rozliczona Waluta" caption="Kwota Rozliczona Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nie Podlega" caption="Kwota Nie Podlega" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nie Podlega Waluta" caption="Kwota Nie Podlega Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania" caption="Liczba Dni Przeterminowania" type="measure" formatString="n0" aggregate="Max" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[d0206ac6-36d0-4c4d-af25-1888e70f0018]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[708e63d4-31a5-4036-8930-7595c424326f]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAADAAAABwIXW0tvbnRyYWhlbnQgS29kXS5bVEVTVF0HAhhbS29udHJhaGVudCBLb2RdLltURVNUMl0HAhhbS29udHJhaGVudCBLb2RdLltURVNUM13/////FwAAAAcCIltLb250cmFoZW50IEtvZF0uWyFOSUVPS1JFxZpMT05ZIV0HAhZbS29udHJhaGVudCBLb2RdLltBRE1dBwIaW0tvbnRyYWhlbnQgS29kXS5bQUxfS09NUF0HAiJbS29udHJhaGVudCBLb2RdLltBTF9LT01QX0dMSVdJQ0VdBwIYW0tvbnRyYWhlbnQgS29kXS5bQUxPWkFdBwIZW0tvbnRyYWhlbnQgS29kXS5bQklHR1VOXQcCHFtLb250cmFoZW50IEtvZF0uW0JJVVJPV0lFQ10HAiRbS29udHJhaGVudCBLb2RdLltCSVVST1dJRUNfU0tBV0lOQV0HAhhbS29udHJhaGVudCBLb2RdLltCTEVJTV0HAhZbS29udHJhaGVudCBLb2RdLltDUE5dBwIeW0tvbnRyYWhlbnQgS29kXS5bRUxFS1RST1dOSUFdBwIZW0tvbnRyYWhlbnQgS29kXS5bS09MQVNBXQcCG1tLb250cmFoZW50IEtvZF0uW0tPV0FMU0tJXQcCFltLb250cmFoZW50IEtvZF0uW0xBU10HAhlbS29udHJhaGVudCBLb2RdLltNQVJJWkFdBwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSS1VTXQcCHFtLb250cmFoZW50IEtvZF0uW01BUlNaQUxJS10HAhlbS29udHJhaGVudCBLb2RdLltQVUNVxZpdBwIbW0tvbnRyYWhlbnQgS29kXS5bU09GVExBTkRdBwIYW0tvbnRyYWhlbnQgS29kXS5bU1RJTExdBwIYW0tvbnRyYWhlbnQgS29kXS5bVEVSUkFdBwIXW0tvbnRyYWhlbnQgS29kXS5bVFBTQV0HAh5bS29udHJhaGVudCBLb2RdLltUV8OTSk9HUsOTRF0=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[d0206ac6-36d0-4c4d-af25-1888e70f0018]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[708e63d4-31a5-4036-8930-7595c424326f]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Status Rozliczenia"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość Brutto"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Kwota Nierozliczona"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="1" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Wartość Brutto" index="0" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Kwota Nierozliczona" index="2" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="1" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Status Rozliczenia" index="0" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;included&gt;&lt;value uniqueName="Częściowo Rozliczony" /&gt;&lt;value uniqueName="Nierozliczony" /&gt;&lt;/included&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje dokumenty sprzedaży oraz dokumenty, które je rozliczają. Znajduje się w nim również status i poziom rozliczenia dokumentu sprzedaży.</a:description><a:id>66</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.30 Faktury nierozliczone</a:mainLinkName><a:modifiedOn>2025-06-11T17:57:56.44</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2013-02-18T11:38:57.563</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży dla grupy produktowej&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'      &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Dodanie Grup Towarowych Nadrzędnych&#xD;
CREATE TABLE #tmpGr (&#xD;
    gidnumer INT,&#xD;
    gidtyp INT,&#xD;
    parent INT);&#xD;
&#xD;
DECLARE @gidnumer INT, @gidtyp INT, @parent INT, @tmpparent INT;&#xD;
&#xD;
DECLARE twr_cursor CURSOR FOR&#xD;
SELECT TwG_GIDNumer, TwG_GIDTyp, TwG_GrONumer &#xD;
FROM CDN.TwrGrupy &#xD;
WHERE TwG_GIDTyp = 16 AND TwG_GroTyp = -16;&#xD;
&#xD;
OPEN twr_cursor;&#xD;
FETCH NEXT FROM twr_cursor INTO @gidnumer, @gidtyp, @parent;&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0  &#xD;
BEGIN&#xD;
    SET @tmpparent = @parent;&#xD;
    WHILE @parent IS NOT NULL&#xD;
    BEGIN&#xD;
        INSERT INTO #tmpGr (gidnumer, gidtyp, parent) VALUES (@gidnumer, @gidtyp, @parent);&#xD;
        SELECT @tmpparent = TwG_GrONumer &#xD;
        FROM cdn.twrgrupy&#xD;
        WHERE TwG_GIDNumer = @tmpparent AND TwG_GIDTyp = -16 AND TwG_GroTyp = -16;&#xD;
        IF @tmpparent = @parent BREAK ELSE SET @parent = @tmpparent;&#xD;
    END&#xD;
    FETCH NEXT FROM twr_cursor INTO @gidnumer, @gidtyp, @parent; &#xD;
END;&#xD;
&#xD;
CLOSE twr_cursor;&#xD;
DEALLOCATE twr_cursor;&#xD;
SELECT DISTINCT * INTO #tmpGr2 FROM #tmpGr;&#xD;
DROP TABLE #tmpGr;&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, &#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    "Dokument Symbol" = dd.DDf_Symbol,&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],       &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],  &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
       "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Kraj" = CASE WHEN pod3.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Kraj END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    Twr_Kod [Produkt Kod], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],    &#xD;
       "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),&#xD;
       "Produkt Kaucja" = CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END, "Jednostka Miary" = Twr_Jm,      &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
       "Produkt Grupa" = fngr.sciezka,&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc Poprzedni" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
                                                WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
                                                ELSE ''NIE'' END,&#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, &#xD;
"Koszt Zakupu" = CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), &#xD;
"Sprzedaż Marża" = TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)),&#xD;
TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat]&#xD;
/*&#xD;
----------DATY POINT&#xD;
 ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'')&#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
 ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe) &#xD;
&#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ &#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TrN_DataWys), "Data Wystawienia Rok" = YEAR(TrN_DataWys)&#xD;
&#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ &#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TrN_Termin), "Termin Płatności Rok" = YEAR(TrN_Termin)&#xD;
&#xD;
----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__], '''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID   &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpGr2 gr ON Twr_GIDNumer = gr.gidnumer AND gr.gidtyp = 16&#xD;
     LEFT JOIN CDN.fnTwrGrupy() fngr ON fngr.GIDNumer = gr.parent&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
    LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
and gr.parent in ('+ convert(varchar,@GRUPA) +')'&#xD;
&#xD;
print (@select + @select2)&#xD;
exec (@select + @select2)&#xD;
&#xD;
--DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpGr2;&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[62354c07-78e9-461f-ba86-7d1a8b6df68d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;GRUPA&lt;/Name&gt;&#xD;
    &lt;Label&gt;Grupa produktowa:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Grupa produktowa, dla której zostaną wyświetlone wyniki analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GIDNumer, Sciezka FROM CDN.fnTwrGrupy() WHERE TwGID &amp;lt;&amp;gt; 0 ORDER BY Sciezka&lt;/Expression&gt;&#xD;
    &lt;Type&gt;SQL&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Sql&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="False" type="Bar" palette="In A Fog" paletteBaseColor="0" style="In A Fog" grandTotals="False" subTotals="False" onlySelected="False" showSeriesInSeparatePanes="False" fieldVisible="False" rotated="False" dataVertical="True" showParametersValues="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#C6D3EF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="False" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="Top" zeroValues="False" textIndent="2" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1" textOrientation="Horizontal"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="2" spacingHorizontal="4" limitsVertical="100" limitsHorizontal="100" location="{X=1097,Y=432}" isCustomLocation="False"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="1.31 Sprzedaż dla grupy produktowej" visible="True" dock="Top" alignment="Center" indent="5" location="{X=612,Y=5}" isCustomLocation="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="Black" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;pointOptions pointView="Values" pattern="{V}"&gt;&#xD;
    &lt;valueNumericOptions numericFormat="General" numericPrecision="2" /&gt;&#xD;
    &lt;valueDateTimeOptions dateTimeFormat="ShortDate" dateTimeFormatString="" /&gt;&#xD;
    &lt;argumentNumericOptions numericFormat="General" numericPrecision="2" /&gt;&#xD;
    &lt;argumentDateTimeOptions dateTimeFormat="ShortDate" dateTimeFormatString="" /&gt;&#xD;
  &lt;/pointOptions&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="[Produkt Kod].[GRABIE_LIŚCIE]" rangeMax="[Produkt Kod].[SZPADEL]" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="0" rangeMax="46386,791" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="275" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[62354c07-78e9-461f-ba86-7d1a8b6df68d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isChartHidden="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isChartHidden="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isChartHidden="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isChartHidden="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje standardową analizę sprzedaży dla jednej grupy produktowej. W odróżnieniu od pozostałych raportów przy generowaniu analizy uwzględniane są grupy przypisane na zakładce 7 karty towaru oraz ich grupy nadrzędne.</a:description><a:id>67</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.31 Sprzedaż dla grupy produktowej</a:mainLinkName><a:modifiedOn>2025-05-23T16:49:50.053</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2015-06-12T13:01:56.39</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży od dostawców&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'             &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TN.TrN_NumerPelny [Dokument Numer], &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TN.TrN_Opis,''''),''(BRAK)'') [Dokument Opis],    &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TN.TrN_NumerPelny,0,CHARINDEX(''/'',TN.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TN.TrN_NumerPelny,CHARINDEX(''/'',TN.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TN.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],    &#xD;
pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],&#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],       &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    ISNULL(dst.Knt_Kod, ''(NIEPRZYPISANY)'') [Dostawca Kod], ISNULL(dst.Knt_Nazwa1, ''(NIEPRZYPISANY)'') [Dostawca Nazwa],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU], &#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TR.TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TN.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TN.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TN.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TN.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TN.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TN.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TN.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TN.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TN.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TN.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    ISNULL(TR.TrE_WartoscNetto/ISNULL(NULLIF(TR.TrE_Ilosc,0),1)*TSE.TrS_Ilosc, TR.TrE_WartoscNetto) [Sprzedaż Wartość], &#xD;
    ISNULL(TR.TrE_WartoscBrutto/ISNULL(NULLIF(TR.TrE_Ilosc,0),1)*TSE.TrS_Ilosc, TR.TrE_WartoscBrutto) [Sprzedaż Wartość Brutto], &#xD;
    ISNULL(TR.TrE_WartoscNettoWal/ISNULL(NULLIF(TR.TrE_Ilosc,0),1)*TSE.TrS_Ilosc, TR.TrE_WartoscNettoWal) [Sprzedaż Wartość Waluta], &#xD;
    ISNULL(TSE.TrS_Ilosc, TR.TrE_Ilosc) [Sprzedaż Ilość], &#xD;
    (CASE WHEN TN.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(TSE.TrS_Wartosc, isNull(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Koszt Zakupu], &#xD;
    ISNULL(TR.TrE_WartoscNetto/ISNULL(NULLIF(TR.TrE_Ilosc,0),1)*TSE.TrS_Ilosc - TSE.TrS_Wartosc, TR.TrE_WartoscNetto - (isNull(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    ISNULL(TSE.TrS_Ilosc, TR.TrE_Ilosc) * (TR.TrE_Cena0WD - (TR.TrE_CenaWWD/TR.TrE_JMPrzelicznikL*TR.TrE_JMPrzelicznikM)) * TR.TrE_KursL / TR.TrE_KursM [Sprzedaż Rabat]&#xD;
    &#xD;
    ,TND.TrN_NumerPelny [Dokument Dostawy]&#xD;
    ,Datediff(dd,TND.TrN_DataOpe,TN.TrN_DataOpe) [Liczba Dni od Dostawy]&#xD;
&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TND.TrN_DataOpe, 111), ''/'', ''-'') [Data Dostawy]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TN.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TN.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TN.TrN_DataOpe) [Data Operacji Kwartał], YEAR(TN.TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TN.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TN.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TN.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TN.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TN.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TN.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TN.TrN_Termin) [Termin Płatności Kwartał], YEAR(TN.TrN_Termin) [Termin Płatności Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TND.TrN_DataOpe, 111), ''/'', ''-'') [Data Dostawy Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TND.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TND.TrN_DataOpe)*/ [Data Dostawy Tydzień Roku] &#xD;
    ,MONTH(TND.TrN_DataOpe) [Data Dostawy Miesiąc], DATEPART(quarter, TND.TrN_DataOpe) [Data Dostawy Kwartał], YEAR(TND.TrN_DataOpe) [Data Dostawy Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TN.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TN.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag TN&#xD;
     JOIN cdn.TraElem TR ON TR.TrE_TrNID=TN.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TN.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TN.TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TR.TrE_PodID=knt1.Knt_KntId AND TR.TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TR.TrE_PodID= pod1.Pod_PodId AND TR.TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TN.TrN_OdbID= pod3.Pod_PodId AND TN.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TN.TrN_OdbId = knt2.Knt_KntId AND TN.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TR.TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TR.TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TN.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TR.TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TN.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TR.TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TN.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TN.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TN.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
    LEFT JOIN(&#xD;
        SELECT TRERel.TrE_TrEID [TRELID], TE.TrE_TrEID [TID]&#xD;
        FROM CDN.TraNag TN&#xD;
        JOIN CDN.TraElem TE ON TE.TrE_TrNID=TN.TrN_TrNID &#xD;
        JOIN CDN.TraNagRelacje TRR ON TN.TrN_TrNId = TRR.TrR_FaId AND TRR.TrR_Flaga &lt;&gt; 1 AND TRR.TrR_TrNTyp in (306,304,312,314,318) &#xD;
        JOIN CDN.TraElem TRERel ON TRERel.TrE_TrNId = TRR.TrR_TrNId AND TREREl.TrE_LpPow = TE.TrE_LpPow ---AND TRERel.TrE_ZwrId IS NULL - Dołączenie warunku wyłącza uwzględnianie dostawców na korektach&#xD;
        WHERE&#xD;
        TN.TrN_TypDokumentu IN (-1,302,305)&#xD;
        AND TN.TrN_Bufor&lt;&gt;-1&#xD;
        AND TE.TrE_Aktywny&lt;&gt;0&#xD;
    ) AS TRERel ON TRERel.TID = TR.TrE_TrEID &#xD;
    LEFT JOIN CDN.TraSElem TSE ON TSE.TrS_TrEId=TRERel.TRELID&#xD;
    LEFT JOIN CDN.TraSElem TDE ON TSE.TrS_TrSIdDost=TDE.TrS_TrSID&#xD;
    LEFT JOIN cdn.TraElem TED ON TDE.TrS_TrEId = TED.TrE_TrEID&#xD;
    LEFT JOIN CDN.TraNag TND ON TED.TrE_TrNId = TND.TrN_TrNID&#xD;
    LEFT JOIN CDN.Kontrahenci dst ON TED.TrE_PodID=dst.Knt_KntId AND TED.TrE_PodmiotTyp = 1 &#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TN.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TN.TrN_Bufor&lt;&gt;-1&#xD;
AND TR.TrE_Aktywny&lt;&gt;0&#xD;
AND TR.TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],       &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod],&#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    ''(NIEPRZYPISANY)'' [Dostawca Kod], ''(NIEPRZYPISANY)'' [Dostawca Nazwa],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU],&#xD;
    ''(BRAK)'' [Produkt Dostawca], &#xD;
    ''Korekta zbiorcza'' [Produkt Kod], &#xD;
    ''(BRAK)'' [Produkt Aktywny],           &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary],     &#xD;
    ''(BRAK)'' [Magazyn Nazwa],&#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat]&#xD;
    ,''(NIEPRZYPISANE)'' [Dokument Dostawy]&#xD;
    ,NULL [Liczba Dni]&#xD;
&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
    ,NULL [Data Dostawy]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
    ,NULL [Data Dostawy Dzień]&#xD;
    ,NULL [Data Dostawy Tydzień Roku] &#xD;
    ,NULL [Data Dostawy Miesiąc], NULL [Data Dostawy Kwartał], NULL [Data Dostawy Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
      LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
        LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	  LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+R9xVUaSNnhw1ovX8kGyRfvi+FPVVwm8BXQToPM2XXd7Cy6m9BIS7z9s1IwAideFbTKXNgYEsZmxH4ZxrA6lmE7QgFLq+a2/6vhE78xSUnvDxbs+BsIWWyvH7fGCLkVDMpKg0ciAgY8sLRCTy+3uvFuGg/3PU/oLZvxA4q7nTV/87QZZOcnSY3BHSM/dy29J4Nb7KMfUpBb2A==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dostawca Kod" caption="Dostawca Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dostawca Nazwa" caption="Dostawca Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Dostawy" caption="Dokument Dostawy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dni od Dostawy" caption="Liczba Dni od Dostawy" type="measure" formatString="" aggregate="Max" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dostawy Dzień" caption="Data Dostawy Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dostawy Tydzień Roku" caption="Data Dostawy Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dostawy Miesiąc" caption="Data Dostawy Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dostawy Kwartał" caption="Data Dostawy Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dostawy Rok" caption="Data Dostawy Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[ff2f770b-fcb0-4288-bd59-30579f1302c1]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[1956bdc6-c0e8-4406-a590-72e887e43e04]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAIAAAABwIgW0Rvc3Rhd2NhIEtvZF0uWyhOSUVQUlpZUElTQU5ZKV0HAhhbRG9zdGF3Y2EgS29kXS5bQUxfS09NUF0HAiBbRG9zdGF3Y2EgS29kXS5bQUxfS09NUF9HTElXSUNFXQcCFltEb3N0YXdjYSBLb2RdLltBTE9aQV0HAhpbRG9zdGF3Y2EgS29kXS5bQklVUk9XSUVDXQcCFltEb3N0YXdjYSBLb2RdLltCTEVJTV0HAhRbRG9zdGF3Y2EgS29kXS5bTEFTXQcCF1tEb3N0YXdjYSBLb2RdLltNQVJLVVNd/////wAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[ff2f770b-fcb0-4288-bd59-30579f1302c1]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[1956bdc6-c0e8-4406-a590-72e887e43e04]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dostawca Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dostawca Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dostawca Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Dostawca Nazwa" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż w podziale na dostawców.</a:description><a:id>68</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.32 Sprzedaż od dostawców</a:mainLinkName><a:modifiedOn>2025-05-23T16:48:52.04</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2016-05-13T13:37:56.263</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży z korektami i WZKK&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'      &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
&#xD;
--Wyliczanie wartości korekt&#xD;
&#xD;
SELECT &#xD;
    TR.TrE_TrEID [Id], TR.TrE_Lp [Lp],&#xD;
    Korekty1.WartoscNetto AS [NettoFakor],&#xD;
    Korekty1.WartoscBrutto AS [BruttoFakor],&#xD;
    Korekty1.WartoscNettoWal AS [NettoWalFakor],&#xD;
    Korekty1.Koszt AS [KosztFakor],&#xD;
    Korekty1.Ilosc AS [IloscFakor],&#xD;
    Korekty1.IloscJM AS [IloscJMFakor],&#xD;
    Korekty1.CenaW AS [CenaWFakor],&#xD;
    Korekty1.KursL AS [KursLFakor],&#xD;
    Korekty1.KursM AS [KursMFakor],&#xD;
    Korekty1.Cena0 AS [Cena0Fakor]&#xD;
    into #Fakor&#xD;
        FROM cdn.TraNag &#xD;
        JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID    &#xD;
        LEFT JOIN&#xD;
        (           &#xD;
         SELECT ele.TrE_TrEID, ele.TrE_Lp,&#xD;
SUM(ISNULL(fakorE.TrE_WartoscNetto,0)) AS WartoscNetto,&#xD;
SUM(ISNULL(fakorE.TrE_WartoscBrutto,0)) AS WartoscBrutto,&#xD;
SUM(ISNULL(fakorE.TrE_WartoscNettoWal,0)) AS WartoscNettoWal,&#xD;
SUM(ISNULL(KosztWyliczonyFAKOREle.Koszt,0)) AS Koszt,&#xD;
SUM(ISNULL(fakorE.TrE_Ilosc,0)) AS Ilosc,       &#xD;
SUM(ISNULL(fakorE.TrE_IloscJM,0)) AS IloscJM,&#xD;
SUM(ISNULL(fakorE.TrE_CenaWWD,0)) AS CenaW,&#xD;
SUM(ISNULL(fakorE.TrE_KursL,0)) AS KursL,&#xD;
SUM(ISNULL(fakorE.TrE_KursM,0)) AS KursM,&#xD;
SUM(ISNULL(fakorE.TrE_Cena0WD,0)) AS Cena0          &#xD;
         FROM CDN.TraNag dok&#xD;
         JOIN CDN.TraElem ele ON ele.TrE_TrNId = dok.TrN_TrNID &#xD;
                                    AND dok.TrN_TypDokumentu IN (-1,302,305) &#xD;
                                    AND TrN_Bufor&lt;&gt;-1&#xD;
                                    AND TrE_Aktywny&lt;&gt;0&#xD;
                                    AND TrE_UslugaZlozonaId = 0&#xD;
									AND Trn_Anulowany = 0 &#xD;
         --FAKOR&#xD;
         LEFT JOIN CDN.TraElem fakorE ON fakorE.TrE_ZwrId = ele.TrE_TrEID AND fakorE.TrE_Lp = ele.TrE_Lp   AND fakorE.TrE_Aktywny&lt;&gt;0  -- element faktury korekcyjnej&#xD;
        LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj in (312000,312008) AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                    WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                    ELSE TrS_Wartosc&#xD;
                                END),0) as Koszt,&#xD;
                            TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                    FROM CDN.TraElem&#xD;
                    UNION ALL&#xD;
                    SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                        FROM cdn.TraElem TRE&#xD;
                        JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                        JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                        JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                        WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308,301 )&#xD;
                    ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
         )KosztWyliczonyFAKOREle  ON KosztWyliczonyFAKOREle.TrE_TrEID = fakorE.TrE_TrEID&#xD;
         &#xD;
        GROUP BY ele.TrE_TrEID, ele.TrE_Lp&#xD;
         ) Korekty1 ON Korekty1.TrE_TrEID = TR.TrE_TrEID AND Korekty1.TrE_Lp = TR.TrE_Lp&#xD;
&#xD;
SELECT &#xD;
    TR.TrE_TrEID [Id], TR.TrE_Lp [Lp],&#xD;
    Korekty2.WartoscNetto AS [NettoWzkk],&#xD;
    Korekty2.WartoscBrutto AS [BruttoWzkk],&#xD;
    Korekty2.WartoscNettoWal AS [NettoWalWzkk],&#xD;
    Korekty2.Koszt AS [KosztWzkk],&#xD;
    Korekty2.Ilosc AS [IloscWzkk],&#xD;
    Korekty2.IloscJM AS [IloscJMWzkk],&#xD;
    Korekty2.CenaW AS [CenaWWzkk],&#xD;
    Korekty2.KursL AS [KursLWzkk],&#xD;
    Korekty2.KursM AS [KursMWzkk],&#xD;
    Korekty2.Cena0 AS [Cena0Wzkk]&#xD;
&#xD;
    into #wzkk&#xD;
        FROM cdn.TraNag &#xD;
        JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
        LEFT JOIN&#xD;
        (           &#xD;
         SELECT ele.TrE_TrEID, ele.TrE_Lp,&#xD;
SUM(ISNULL(wzkkE.TrE_WartoscNetto,0)) AS WartoscNetto,&#xD;
SUM(ISNULL(wzkkE.TrE_WartoscBrutto,0)) AS WartoscBrutto,&#xD;
SUM(ISNULL(wzkkE.TrE_WartoscNettoWal,0)) AS WartoscNettoWal,&#xD;
SUM(ISNULL(KosztWyliczonyWZKKEle.Koszt,0)) AS Koszt,&#xD;
SUM(ISNULL(wzkkE.TrE_Ilosc,0)) AS Ilosc,    &#xD;
SUM(ISNULL(wzkkE.TrE_IloscJM,0)) AS IloscJM,&#xD;
SUM(ISNULL(wzkkE.TrE_CenaWWD,0)) AS CenaW,&#xD;
SUM(ISNULL(wzkkE.TrE_KursL,0)) AS KursL,&#xD;
SUM(ISNULL(wzkkE.TrE_KursM,0)) AS KursM,&#xD;
SUM(ISNULL(wzkkE.TrE_Cena0WD,0)) AS Cena0               &#xD;
         FROM CDN.TraNag dok&#xD;
         JOIN CDN.TraElem ele ON ele.TrE_TrNId = dok.TrN_TrNID &#xD;
                                    AND dok.TrN_TypDokumentu IN (-1,302,305) &#xD;
                                    AND TrN_Bufor&lt;&gt;-1&#xD;
                                    AND TrE_Aktywny&lt;&gt;0&#xD;
                                    AND TrE_UslugaZlozonaId = 0 &#xD;
              --WZKK&#xD;
LEFT JOIN CDN.TraNagRelacje rel ON dok.TrN_TrNID = rel.TrR_TrNId&#xD;
INNER JOIN CDN.TraNag wzkk ON rel.TrR_FaId = wzkk.TrN_ZwrId &#xD;
AND rel.TrR_FaTyp = 306 AND wzkk.TrN_Rodzaj IN (306061,306071,306072) -- WZKK&#xD;
LEFT JOIN CDN.TraElem wzkkE ON wzkkE.TrE_TrNId = wzkk.TrN_TrNID AND wzkkE.TrE_Lp = ele.TrE_Lp -- element WZKK&#xD;
&#xD;
--dla elementów WZKK&#xD;
      LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj in (312000,312008) AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                    WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                    ELSE TrS_Wartosc&#xD;
                                END),0) as Koszt,&#xD;
                            TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                    FROM CDN.TraElem&#xD;
                    UNION ALL&#xD;
                    SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                        FROM cdn.TraElem TRE&#xD;
                        JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                        JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                        JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                        WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308,301 )&#xD;
                    ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID, TRE.TrE_Lp&#xD;
         )KosztWyliczonyWZKKEle ON KosztWyliczonyWZKKEle.TrE_TrEID = wzkkE.TrE_TrEID&#xD;
&#xD;
         &#xD;
        GROUP BY ele.TrE_TrEID, ele.TrE_Lp&#xD;
         ) Korekty2 ON Korekty2.TrE_TrEID = TR.TrE_TrEID AND Korekty2.TrE_Lp = TR.TrE_Lp&#xD;
&#xD;
SELECT f.id [KorId], f.Lp [KorLp],&#xD;
ISNULL(f.NettoFakor,0)+ISNULL(w.NettoWzkk,0) [KorNetto],&#xD;
ISNULL(f.BruttoFakor,0)+ISNULL(w.BruttoWzkk,0) [KorBrutto],&#xD;
ISNULL(f.NettoWalFakor,0)+ISNULL(w.NettoWalWzkk,0) [KorNettoWal],&#xD;
ISNULL(f.KosztFakor,0)+ISNULL(w.KosztWzkk,0) [KorKoszt],&#xD;
ISNULL(f.IloscFakor,0)+ISNULL(w.IloscWzkk,0) [KorIlosc],&#xD;
ISNULL(f.IloscJMFakor,0)+ISNULL(w.IloscJMWzkk,0) [KorIloscJM],&#xD;
ISNULL(f.CenaWFakor,0)+ISNULL(w.CenaWWzkk,0) [KorCenaW],&#xD;
ISNULL(f.KursLFakor,0)+ISNULL(w.KursLWzkk,0) [KorKursL],&#xD;
ISNULL(f.KursMFakor,0)+ISNULL(w.KursMWzkk,0) [KorKursM],&#xD;
ISNULL(f.Cena0Fakor,0)+ISNULL(w.Cena0Wzkk,0) [KorCena0]&#xD;
&#xD;
into #Kor FROM #fakor f&#xD;
LEFT JOIN #wzkk w ON f.Id = w.Id and f.Lp = w.Lp&#xD;
&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
					 &#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],   &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],       &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU], &#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    Twr_Kod [Produkt Kod],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat], &#xD;
    TR.TrE_WartoscNetto + KorNetto AS [Sprzedaż Wartość po korekcie], TR.TrE_WartoscBrutto + KorBrutto AS [Sprzedaż Wartość Brutto po korekcie],&#xD;
    TR.TrE_WartoscNettoWal + KorNettoWal [Sprzedaż Wartość Waluta po korekcie], TR.TrE_Ilosc + KorIlosc AS [Sprzedaż Ilość po korekcie],&#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + KorKoszt + TR.TrE_KosztUslugi) AS [Koszt Zakupu po korekcie],&#xD;
    TR.TrE_WartoscNetto + KorNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + KorKoszt + TR.TrE_KosztUslugi) AS [Sprzedaż Marża po korekcie], &#xD;
    (TrE_IloscJM + KorIloscJM) * (TrE_Cena0WD + KorCena0 - ((TrE_CenaWWD + KorCenaW)/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * (TrE_KursL + KorKursL ) / (TrE_KursM + KorKursM) AS [Sprzedaż Rabat po korekcie]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
    -- wartości korekt: FAKOR i WZKK, wyliczając koszty&#xD;
    &#xD;
    LEFT JOIN #Kor ON KorID = TR.TrE_TrEID AND KorLp = TR.TrE_Lp&#xD;
&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],   &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],        &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ''(PUSTA)'' [Produkt Kategoria],    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa], &#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU],&#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod], &#xD;
    ''(BRAK)'' [Produkt Aktywny],           &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    --korekty&#xD;
    TrN_RazemNetto AS [Sprzedaż Wartość po korekcie], TrN_RazemBrutto AS [Sprzedaż Wartość Brutto po korekcie],TrN_RazemNettoWal [Sprzedaż Wartość Waluta po korekcie], &#xD;
    0 AS [Sprzedaż Ilość po korekcie], KosztWyliczony.Koszt AS [Koszt Zakupu po korekcie], TrN_RazemNetto - KosztWyliczony.Koszt AS [Sprzedaż Marża po korekcie], 0 AS [Sprzedaż Rabat po korekcie]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/  &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
    &#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
      LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	  LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #fakor&#xD;
DROP TABLE #wzkk&#xD;
DROP TABLE #kor&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QLNy8SvsWvjndP4rYWmIrmw65/eZ7QPiim3cKUThrJOp91uo2s2QytZVCI0ahIBHPzdhq77ZDLGV416eqisuhRvsBchYe/0nZ1nxm0MvuxGuMSkybFYJKikIyc3Jy8uSmQ13fU8LlOUnG1yBgPjtNfudwNqxTra3BFd8CawZLzfbHViM3udhwwi65LCa8cKtSBlCg2ZSO0nA==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="c2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość po korekcie" caption="Sprzedaż Wartość po korekcie" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto po korekcie" caption="Sprzedaż Wartość Brutto po korekcie" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta po korekcie" caption="Sprzedaż Wartość Waluta po korekcie" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość po korekcie" caption="Sprzedaż Ilość po korekcie" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu po korekcie" caption="Koszt Zakupu po korekcie" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża po korekcie" caption="Sprzedaż Marża po korekcie" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat po korekcie" caption="Sprzedaż Rabat po korekcie" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[f95d5f1b-99eb-47e9-959b-4186325ac18a]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[95d33628-b7be-4d71-b298-2e019b2801d3]" caption="Sprzedaż Marża po korekcie %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[7336d1b5-2b24-42c0-a744-761d16d4fabc]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[368c7617-4943-4ae4-8487-1825d20e4425]" caption="Sprzedaż Rabat po korekcie %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAAAAAAAAAAAP////8bAAAABwIiW0tvbnRyYWhlbnQgS29kXS5bIU5JRU9LUkXFmkxPTlkhXQcCFltLb250cmFoZW50IEtvZF0uW0FETV0HAhpbS29udHJhaGVudCBLb2RdLltBTF9LT01QXQcCIltLb250cmFoZW50IEtvZF0uW0FMX0tPTVBfR0xJV0lDRV0HAhhbS29udHJhaGVudCBLb2RdLltBTE9aQV0HAhlbS29udHJhaGVudCBLb2RdLltCSUdHVU5dBwIcW0tvbnRyYWhlbnQgS29kXS5bQklVUk9XSUVDXQcCJFtLb250cmFoZW50IEtvZF0uW0JJVVJPV0lFQ19TS0FXSU5BXQcCJltLb250cmFoZW50IEtvZF0uW0JJVVJPV0lFQ19XSUVMSUNaS0FdBwIYW0tvbnRyYWhlbnQgS29kXS5bQkxFSU1dBwIWW0tvbnRyYWhlbnQgS29kXS5bQ1BOXQcCHltLb250cmFoZW50IEtvZF0uW0VMRUtUUk9XTklBXQcCGVtLb250cmFoZW50IEtvZF0uW0tPTEFTQV0HAhtbS29udHJhaGVudCBLb2RdLltLT1dBTFNLSV0HAhZbS29udHJhaGVudCBLb2RdLltMQVNdBwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSSVpBXQcCGVtLb250cmFoZW50IEtvZF0uW01BUktVU10HAhxbS29udHJhaGVudCBLb2RdLltNQVJTWkFMSUtdBwIZW0tvbnRyYWhlbnQgS29kXS5bUFVDVcWaXQcCG1tLb250cmFoZW50IEtvZF0uW1NPRlRMQU5EXQcCGFtLb250cmFoZW50IEtvZF0uW1NUSUxMXQcCGFtLb250cmFoZW50IEtvZF0uW1RFUlJBXQcCF1tLb250cmFoZW50IEtvZF0uW1RFU1RdBwIYW0tvbnRyYWhlbnQgS29kXS5bVEVTVDJdBwIYW0tvbnRyYWhlbnQgS29kXS5bVEVTVDNdBwIXW0tvbnRyYWhlbnQgS29kXS5bVFBTQV0HAh5bS29udHJhaGVudCBLb2RdLltUV8OTSk9HUsOTRF0AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[f95d5f1b-99eb-47e9-959b-4186325ac18a]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[95d33628-b7be-4d71-b298-2e019b2801d3]" caption="Sprzedaż Marża po korekcie %" formula="(Koszt Zakupu po korekcie = 0 ? 1 : (Sprzedaż Wartość po korekcie-Koszt Zakupu po korekcie)/Koszt Zakupu po korekcie)" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[7336d1b5-2b24-42c0-a744-761d16d4fabc]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[368c7617-4943-4ae4-8487-1825d20e4425]" caption="Sprzedaż Rabat po korekcie %" formula="((Sprzedaż Rabat po korekcie + Sprzedaż Wartość po korekcie) = 0 ? 0 : Sprzedaż Rabat po korekcie/(Sprzedaż Rabat po korekcie + Sprzedaż Wartość po korekcie))" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dokument Symbol"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość po korekcie"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="157" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość po korekcie"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża po korekcie"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="4" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Wartość po korekcie" index="3" expanded="True" sortMode="default" order="ascending" width="157" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość po korekcie" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża po korekcie" index="5" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Dokument Symbol" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded&gt;&lt;value uniqueName="FAKOR" /&gt;&lt;/excluded&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje dane ze sprzedaży z uwzględnieniem korekt i WZKK. Prezentowane są miary przed i po korekcie.&#xD;
&#xD;
UWAGA:&#xD;
Dla poprawnego sumowania należy odznaczyć w filtrze dokumenty korekt.</a:description><a:id>69</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.33 Sprzedaż z korektami i WZKK</a:mainLinkName><a:modifiedOn>2025-05-30T15:38:47.51</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2016-05-13T13:37:56.263</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/*&#xD;
* Raport Sprzedaży z korektami w zakresie dat &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'      &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
	JOIN CDN.TraElem ON TrA_TrEId = TrE_TrEID&#xD;
	JOIN CDN.TraNag ON TrE_TrNId = TrN_TrNID&#xD;
WHERE&#xD;
	TrN_TypDokumentu IN (-1,302,305)&#xD;
	AND TrN_Bufor&lt;&gt;-1&#xD;
	AND TrE_Aktywny&lt;&gt;0&#xD;
	AND TrN_DataOpe BETWEEN @DATAOD AND @DATADO&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
&#xD;
--Wyliczanie wartości korekt&#xD;
&#xD;
SELECT &#xD;
    TR.TrE_TrEID [Id], TR.TrE_Lp [Lp],&#xD;
    Korekty1.WartoscNetto AS [NettoFakor],&#xD;
    Korekty1.WartoscBrutto AS [BruttoFakor],&#xD;
    Korekty1.WartoscNettoWal AS [NettoWalFakor],&#xD;
    Korekty1.Koszt AS [KosztFakor],&#xD;
    Korekty1.Ilosc AS [IloscFakor],&#xD;
    Korekty1.IloscJM AS [IloscJMFakor],&#xD;
    Korekty1.CenaW AS [CenaWFakor],&#xD;
    Korekty1.KursL AS [KursLFakor],&#xD;
    Korekty1.KursM AS [KursMFakor],&#xD;
    Korekty1.Cena0 AS [Cena0Fakor]&#xD;
    into #Fakor&#xD;
        FROM cdn.TraNag &#xD;
        JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID    &#xD;
        LEFT JOIN&#xD;
        (           &#xD;
         SELECT ele.TrE_TrEID, ele.TrE_Lp,&#xD;
SUM(ISNULL(fakorE.TrE_WartoscNetto,0)) AS WartoscNetto,&#xD;
SUM(ISNULL(fakorE.TrE_WartoscBrutto,0)) AS WartoscBrutto,&#xD;
SUM(ISNULL(fakorE.TrE_WartoscNettoWal,0)) AS WartoscNettoWal,&#xD;
SUM(ISNULL(KosztWyliczonyFAKOREle.Koszt,0)) AS Koszt,&#xD;
SUM(ISNULL(fakorE.TrE_Ilosc,0)) AS Ilosc,       &#xD;
SUM(ISNULL(fakorE.TrE_IloscJM,0)) AS IloscJM,&#xD;
SUM(ISNULL(fakorE.TrE_CenaWWD,0)) AS CenaW,&#xD;
SUM(ISNULL(fakorE.TrE_KursL,0)) AS KursL,&#xD;
SUM(ISNULL(fakorE.TrE_KursM,0)) AS KursM,&#xD;
SUM(ISNULL(fakorE.TrE_Cena0WD,0)) AS Cena0          &#xD;
         FROM CDN.TraNag dok&#xD;
         JOIN CDN.TraElem ele ON ele.TrE_TrNId = dok.TrN_TrNID &#xD;
                                    AND dok.TrN_TypDokumentu IN (-1,302,305) &#xD;
                                    AND TrN_Bufor&lt;&gt;-1&#xD;
                                    AND TrE_Aktywny&lt;&gt;0&#xD;
                                    AND TrE_UslugaZlozonaId = 0&#xD;
         --FAKOR&#xD;
         LEFT JOIN CDN.TraElem fakorE ON fakorE.TrE_ZwrId = ele.TrE_TrEID AND fakorE.TrE_Lp = ele.TrE_Lp  -- element faktury korekcyjnej&#xD;
        LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj in (312000,312008) AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                    WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                    ELSE TrS_Wartosc&#xD;
                                END),0) as Koszt,&#xD;
                            TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                    FROM CDN.TraElem&#xD;
                    UNION ALL&#xD;
                    SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                        FROM cdn.TraElem TRE&#xD;
                        JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                        JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                        JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                        WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308,301 )&#xD;
                    ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
         )KosztWyliczonyFAKOREle  ON KosztWyliczonyFAKOREle.TrE_TrEID = fakorE.TrE_TrEID&#xD;
         &#xD;
        GROUP BY ele.TrE_TrEID, ele.TrE_Lp&#xD;
         ) Korekty1 ON Korekty1.TrE_TrEID = TR.TrE_TrEID AND Korekty1.TrE_Lp = TR.TrE_Lp&#xD;
&#xD;
SELECT &#xD;
    TR.TrE_TrEID [Id], TR.TrE_Lp [Lp],&#xD;
    Korekty2.WartoscNetto AS [NettoWzkk],&#xD;
    Korekty2.WartoscBrutto AS [BruttoWzkk],&#xD;
    Korekty2.WartoscNettoWal AS [NettoWalWzkk],&#xD;
    Korekty2.Koszt AS [KosztWzkk],&#xD;
    Korekty2.Ilosc AS [IloscWzkk],&#xD;
    Korekty2.IloscJM AS [IloscJMWzkk],&#xD;
    Korekty2.CenaW AS [CenaWWzkk],&#xD;
    Korekty2.KursL AS [KursLWzkk],&#xD;
    Korekty2.KursM AS [KursMWzkk],&#xD;
    Korekty2.Cena0 AS [Cena0Wzkk]&#xD;
&#xD;
    into #wzkk&#xD;
        FROM cdn.TraNag &#xD;
        JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
        LEFT JOIN&#xD;
        (           &#xD;
         SELECT ele.TrE_TrEID, ele.TrE_Lp,&#xD;
SUM(ISNULL(wzkkE.TrE_WartoscNetto,0)) AS WartoscNetto,&#xD;
SUM(ISNULL(wzkkE.TrE_WartoscBrutto,0)) AS WartoscBrutto,&#xD;
SUM(ISNULL(wzkkE.TrE_WartoscNettoWal,0)) AS WartoscNettoWal,&#xD;
SUM(ISNULL(KosztWyliczonyWZKKEle.Koszt,0)) AS Koszt,&#xD;
SUM(ISNULL(wzkkE.TrE_Ilosc,0)) AS Ilosc,    &#xD;
SUM(ISNULL(wzkkE.TrE_IloscJM,0)) AS IloscJM,&#xD;
SUM(ISNULL(wzkkE.TrE_CenaWWD,0)) AS CenaW,&#xD;
SUM(ISNULL(wzkkE.TrE_KursL,0)) AS KursL,&#xD;
SUM(ISNULL(wzkkE.TrE_KursM,0)) AS KursM,&#xD;
SUM(ISNULL(wzkkE.TrE_Cena0WD,0)) AS Cena0               &#xD;
         FROM CDN.TraNag dok&#xD;
         JOIN CDN.TraElem ele ON ele.TrE_TrNId = dok.TrN_TrNID &#xD;
                                    AND dok.TrN_TypDokumentu IN (-1,302,305) &#xD;
                                    AND TrN_Bufor&lt;&gt;-1&#xD;
                                    AND TrE_Aktywny&lt;&gt;0&#xD;
                                    AND TrE_UslugaZlozonaId = 0 &#xD;
              --WZKK&#xD;
LEFT JOIN CDN.TraNagRelacje rel ON dok.TrN_TrNID = rel.TrR_TrNId&#xD;
INNER JOIN CDN.TraNag wzkk ON rel.TrR_FaId = wzkk.TrN_ZwrId &#xD;
AND rel.TrR_FaTyp = 306 AND wzkk.TrN_Rodzaj IN (306061,306071,306072) -- WZKK&#xD;
LEFT JOIN CDN.TraElem wzkkE ON wzkkE.TrE_TrNId = wzkk.TrN_TrNID AND wzkkE.TrE_Lp = ele.TrE_Lp -- element WZKK&#xD;
&#xD;
--dla elementów WZKK&#xD;
      LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj in (312000,312008) AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                    WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                    ELSE TrS_Wartosc&#xD;
                                END),0) as Koszt,&#xD;
                            TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                    FROM CDN.TraElem&#xD;
                    UNION ALL&#xD;
                    SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                        FROM cdn.TraElem TRE&#xD;
                        JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                        JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                        JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                        WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308,301 )&#xD;
                    ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID, TRE.TrE_Lp&#xD;
         )KosztWyliczonyWZKKEle ON KosztWyliczonyWZKKEle.TrE_TrEID = wzkkE.TrE_TrEID&#xD;
&#xD;
         &#xD;
        GROUP BY ele.TrE_TrEID, ele.TrE_Lp&#xD;
         ) Korekty2 ON Korekty2.TrE_TrEID = TR.TrE_TrEID AND Korekty2.TrE_Lp = TR.TrE_Lp&#xD;
&#xD;
SELECT f.id [KorId], f.Lp [KorLp],&#xD;
ISNULL(f.NettoFakor,0)+ISNULL(w.NettoWzkk,0) [KorNetto],&#xD;
ISNULL(f.BruttoFakor,0)+ISNULL(w.BruttoWzkk,0) [KorBrutto],&#xD;
ISNULL(f.NettoWalFakor,0)+ISNULL(w.NettoWalWzkk,0) [KorNettoWal],&#xD;
ISNULL(f.KosztFakor,0)+ISNULL(w.KosztWzkk,0) [KorKoszt],&#xD;
ISNULL(f.IloscFakor,0)+ISNULL(w.IloscWzkk,0) [KorIlosc],&#xD;
ISNULL(f.IloscJMFakor,0)+ISNULL(w.IloscJMWzkk,0) [KorIloscJM],&#xD;
ISNULL(f.CenaWFakor,0)+ISNULL(w.CenaWWzkk,0) [KorCenaW],&#xD;
ISNULL(f.KursLFakor,0)+ISNULL(w.KursLWzkk,0) [KorKursL],&#xD;
ISNULL(f.KursMFakor,0)+ISNULL(w.KursMWzkk,0) [KorKursM],&#xD;
ISNULL(f.Cena0Fakor,0)+ISNULL(w.Cena0Wzkk,0) [KorCena0]&#xD;
&#xD;
into #Kor FROM #fakor f&#xD;
LEFT JOIN #wzkk w ON f.Id = w.Id and f.Lp = w.Lp&#xD;
&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
CONCAT(BAZ.Baz_Nazwa ,'':'', TrN_NumerPelny) [Liczba Dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],   &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],       &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    COALESCE(NULLIF(pod3.Pod_Wojewodztwo, ''''),NULLIF(TrN_OdbWojewodztwo,''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo],&#xD;
	COALESCE(NULLIF(pod3.Pod_Miasto, ''''),NULLIF(TrN_OdbMiasto,''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    COALESCE(NULLIF(pod3.Pod_Kraj, ''''),NULLIF(TrN_OdbKraj,''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa], &#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    Twr_Kod [Produkt Kod],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary],  &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
	 ISNULL(Nullif(twr_ean,''''),''(NIEPRZYPISANE)'') AS [Produkt EAN],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień], &#xD;
    (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku], &#xD;
    MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok],&#xD;
    REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień], &#xD;
    (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku], &#xD;
    MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok],&#xD;
    REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień], &#xD;
    (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku], &#xD;
    MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok], &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat], &#xD;
    TR.TrE_WartoscNetto + KorNetto AS [Sprzedaż Wartość po korekcie], TR.TrE_WartoscBrutto + KorBrutto AS [Sprzedaż Wartość Brutto po korekcie],&#xD;
    TR.TrE_WartoscNettoWal + KorNettoWal [Sprzedaż Wartość Waluta po korekcie], TR.TrE_Ilosc + KorIlosc AS [Sprzedaż Ilość po korekcie],&#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + KorKoszt + TR.TrE_KosztUslugi) AS [Koszt Zakupu po korekcie],&#xD;
    TR.TrE_WartoscNetto + KorNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + KorKoszt + TR.TrE_KosztUslugi) AS [Sprzedaż Marża po korekcie], &#xD;
    (TrE_IloscJM + KorIloscJM) * (TrE_Cena0WD + KorCena0 - ((TrE_CenaWWD + KorCenaW)/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * (TrE_KursL + KorKursL ) / (TrE_KursM + KorKursM) AS [Sprzedaż Rabat po korekcie]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
    -- wartości korekt: FAKOR i WZKK, wyliczając koszty&#xD;
    &#xD;
    LEFT JOIN #Kor ON KorID = TR.TrE_TrEID AND KorLp = TR.TrE_Lp&#xD;
&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
AND TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
CONCAT(BAZ.Baz_Nazwa ,'':'', TrN_NumerPelny) [Liczba Dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],   &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],        &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    COALESCE(NULLIF(pod3.Pod_Wojewodztwo, ''''),NULLIF(TrN_OdbWojewodztwo,''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo],&#xD;
	COALESCE(NULLIF(pod3.Pod_Miasto, ''''),NULLIF(TrN_OdbMiasto,''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    COALESCE(NULLIF(pod3.Pod_Kraj, ''''),NULLIF(TrN_OdbKraj,''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod], &#xD;
    ''(BRAK)'' [Produkt Aktywny],           &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary],     &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
		''(BRAK)'' [Produkt EAN],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień], &#xD;
    (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku], &#xD;
    MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok], &#xD;
    REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień], &#xD;
    (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku], &#xD;
    MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok],&#xD;
    REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień], &#xD;
    (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku], &#xD;
    MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    --korekty&#xD;
    TrN_RazemNetto AS [Sprzedaż Wartość po korekcie], TrN_RazemBrutto AS [Sprzedaż Wartość Brutto po korekcie], TrN_RazemNettoWal [Sprzedaż Wartość Waluta po korekcie], &#xD;
    0 AS [Sprzedaż Ilość po korekcie], KosztWyliczony.Koszt AS [Koszt Zakupu po korekcie], TrN_RazemNetto - TrN_WartoscZakupu AS [Sprzedaż Marża po korekcie], 0 AS [Sprzedaż Rabat po korekcie]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
      LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	  LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #fakor&#xD;
DROP TABLE #wzkk&#xD;
DROP TABLE #kor&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="c2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość po korekcie" caption="Sprzedaż Wartość po korekcie" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto po korekcie" caption="Sprzedaż Wartość Brutto po korekcie" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta po korekcie" caption="Sprzedaż Wartość Waluta po korekcie" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość po korekcie" caption="Sprzedaż Ilość po korekcie" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu po korekcie" caption="Koszt Zakupu po korekcie" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża po korekcie" caption="Sprzedaż Marża po korekcie" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat po korekcie" caption="Sprzedaż Rabat po korekcie" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[f95d5f1b-99eb-47e9-959b-4186325ac18a]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[95d33628-b7be-4d71-b298-2e019b2801d3]" caption="Sprzedaż Marża po korekcie %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[7336d1b5-2b24-42c0-a744-761d16d4fabc]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[368c7617-4943-4ae4-8487-1825d20e4425]" caption="Sprzedaż Rabat po korekcie %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data początkowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Początkowa data analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-08-21&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data końcowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Końcowa data analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-09-20&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAAAAAAAAAAAP////8AAAAAAAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[f95d5f1b-99eb-47e9-959b-4186325ac18a]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[95d33628-b7be-4d71-b298-2e019b2801d3]" caption="Sprzedaż Marża po korekcie %" formula="(Koszt Zakupu po korekcie = 0 ? 1 : (Sprzedaż Wartość po korekcie-Koszt Zakupu po korekcie)/Koszt Zakupu po korekcie)" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[7336d1b5-2b24-42c0-a744-761d16d4fabc]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[368c7617-4943-4ae4-8487-1825d20e4425]" caption="Sprzedaż Rabat po korekcie %" formula="((Sprzedaż Rabat po korekcie + Sprzedaż Wartość po korekcie) = 0 ? 0 : Sprzedaż Rabat po korekcie/(Sprzedaż Rabat po korekcie + Sprzedaż Wartość po korekcie))" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dokument Symbol"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość po korekcie"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="157" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość po korekcie"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża po korekcie"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="4" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Wartość po korekcie" index="3" expanded="True" sortMode="default" order="ascending" width="157" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość po korekcie" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża po korekcie" index="5" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Dokument Symbol" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded&gt;&lt;value uniqueName="FAKOR" /&gt;&lt;/excluded&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje dane ze sprzedaży w podanym przy urochomieniu raportu zakresie dat z uwzględnieniem korekt i WZKK. Prezentowane są miary przed i po korekcie.&#xD;
&#xD;
UWAGA:&#xD;
Dla poprawnego sumowania należy odznaczyć w filtrze dokumenty korekt.</a:description><a:id>70</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.34 Sprzedaż z korektami i WZKK w zakresie dat</a:mainLinkName><a:modifiedOn>2025-05-23T16:12:09.533</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2013-01-23T11:37:57.807</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży - towary i usługi złożone&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
	&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT&#xD;
[ID] = twr1.Twr_TwrId,&#xD;
[Produkt] = twr1.Twr_Kod,&#xD;
[Receptura] = PdR_Nazwa,&#xD;
[Skladile] = COUNT(PdS_Ilosc)&#xD;
INTO #skladile &#xD;
FROM&#xD;
CDN.Towary twr1&#xD;
LEFT JOIN CDN.ProdReceptury ON PdR_TwrId = twr1.Twr_TwrId AND PdR_Domyslna = 1&#xD;
LEFT OUTER JOIN CDN.ProdSkladniki ON twr1.Twr_TwrId = PdS_ProdId AND PdR_PdRId = PdS_PdRId&#xD;
LEFT OUTER JOIN CDN.Towary twr2 ON PdS_TwrId=twr2.Twr_TwrId&#xD;
--LEFT JOIN cdn.TwrCeny ON TwC_TwrID = twr2.Twr_TwrId&#xD;
GROUP BY twr1.Twr_TwrId, twr1.Twr_Kod, PdR_Nazwa&#xD;
&#xD;
SELECT&#xD;
[RecID] = twr1.Twr_TwrId,&#xD;
[Produkt] = twr1.Twr_Kod,&#xD;
[Recile] = COUNT(PdR_Kod)&#xD;
INTO #recile &#xD;
FROM&#xD;
CDN.Towary twr1&#xD;
JOIN CDN.ProdReceptury ON PdR_TwrId = twr1.Twr_TwrId AND PdR_Domyslna = 1&#xD;
GROUP BY twr1.Twr_TwrId, twr1.Twr_Kod;&#xD;
&#xD;
select&#xD;
[Tow1ID] = twr1.Twr_TwrId,&#xD;
[Tow2ID] = twr2.Twr_TwrId,&#xD;
[SkladLp] = PdS_Lp,&#xD;
[Skladilosc] = PdS_Ilosc&#xD;
&#xD;
INTO #skladilosc&#xD;
FROM CDN.Towary twr1 &#xD;
LEFT JOIN CDN.ProdReceptury ON PdR_TwrId = twr1.Twr_TwrId AND PdR_Domyslna = 1&#xD;
LEFT OUTER JOIN CDN.ProdSkladniki ON twr1.Twr_TwrId = PdS_ProdId AND PdR_PdRId = PdS_PdRId&#xD;
LEFT OUTER JOIN CDN.Towary twr2 ON PdS_TwrId=twr2.Twr_TwrId&#xD;
WHERE PdR_Ilosc&lt;&gt;0;&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod],&#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    PdS_Lp [Składnik Lp],&#xD;
    twr2.Twr_Nazwa [Składnik Nazwa],&#xD;
    twr2.Twr_Kod [Składnik Kod],&#xD;
    --CASE WHEN PdR_Ilosc&lt;&gt;0 THEN   TR.TrE_Ilosc*PdS_Ilosc/PdR_Ilosc ELSE TR.TrE_Ilosc*PdS_Ilosc END [Składnik Ilość],&#xD;
    Skladilosc [Składnik Ilość],&#xD;
    PdS_Jm [Składnik Jednostka Miary],  &#xD;
    twr1.Twr_Nazwa [Produkt Nazwa],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    ISNULL(NULLIF(PdR_Nazwa,''''),NULL) [Receptura Nazwa],&#xD;
    PdR_Ilosc [Receptura Ilość Produktu],&#xD;
    PdR_JM [Receptura Jednostka Miary],&#xD;
    TwC_Wartosc*twr2.Twr_KursL/twr2.Twr_KursM [Składnik Cena],&#xD;
    twr1.Twr_Kod [Produkt Kod],     &#xD;
    twr1.Twr_NumerKat [Produkt Numer Katalogowy], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], twr1.Twr_Jm [Jednostka Miary], &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN twr1.Twr_Typ = 0 AND twr1.Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN twr1.Twr_Typ = 0 AND twr1.Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN twr1.Twr_Typ = 1 AND twr1.Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN twr1.Twr_Typ = 1 AND twr1.Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
CASE WHEN (Skladile &lt;&gt; 0 AND Recile &lt;&gt; 0) THEN TR.TrE_WartoscNetto/(Skladile*Recile) ELSE TR.TrE_WartoscNetto END [Sprzedaż Wartość], &#xD;
CASE WHEN (Skladile &lt;&gt; 0 AND Recile &lt;&gt; 0) THEN TR.TrE_WartoscBrutto/(Skladile*Recile) ELSE TR.TrE_WartoscBrutto END [Sprzedaż Wartość Brutto], &#xD;
CASE WHEN (Skladile &lt;&gt; 0 AND Recile &lt;&gt; 0) THEN TR.TrE_WartoscNettoWal/(Skladile*Recile) ELSE TR.TrE_WartoscNettoWal END [Sprzedaż Wartość Waluta],&#xD;
CASE WHEN (Skladile &lt;&gt; 0 AND Recile &lt;&gt; 0) THEN TR.TrE_Ilosc/(Skladile*Recile) ELSE TR.TrE_Ilosc END [Sprzedaż Ilość],&#xD;
CASE WHEN (Skladile &lt;&gt; 0 AND Recile &lt;&gt; 0) THEN&#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(Case when KosztWyliczony.Koszt =0 then TR.Tre_WartoscZakupuWylicz else KosztWyliczony.Koszt end/(Skladile*Recile) ,0) + TR.TrE_KosztUslugi/(Skladile*Recile)) &#xD;
    ELSE&#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(Case when KosztWyliczony.Koszt =0 then TR.Tre_WartoscZakupuWylicz else KosztWyliczony.Koszt end ,0) + TR.TrE_KosztUslugi) END AS [Koszt Zakupu],&#xD;
    &#xD;
CASE WHEN (Skladile &lt;&gt; 0 AND Recile &lt;&gt; 0) THEN&#xD;
    TR.TrE_WartoscNetto/(Skladile*Recile) - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(Case when KosztWyliczony.Koszt =0 then TR.Tre_WartoscZakupuWylicz else KosztWyliczony.Koszt end/(Skladile*Recile) ,0) + TR.TrE_KosztUslugi/(Skladile*Recile)))&#xD;
    ELSE&#xD;
    TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(Case when KosztWyliczony.Koszt =0 then TR.Tre_WartoscZakupuWylicz else KosztWyliczony.Koszt end ,0) + TR.TrE_KosztUslugi)) END AS [Sprzedaż Marża]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], twr1.Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], twr1.Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TR.TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary twr1 ON TrE_TwrId=twr1.Twr_TwrId &#xD;
     LEFT JOIN CDN.ProdReceptury ON PdR_TwrId = twr1.Twr_TwrId AND PdR_Domyslna = 1&#xD;
     LEFT OUTER JOIN CDN.ProdSkladniki ON twr1.Twr_TwrId = PdS_ProdId AND PdR_PdRId = PdS_PdRId&#xD;
     LEFT OUTER JOIN #skladile ON id = twr1.Twr_TwrId&#xD;
     LEFT OUTER JOIN #recile ON RecID=twr1.Twr_TwrId&#xD;
     LEFT OUTER JOIN CDN.Towary twr2 ON PdS_TwrId=twr2.Twr_TwrId&#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = ser.DDf_DDfID&#xD;
&#xD;
     LEFT JOIN cdn.TwrCeny ON TwC_TwrID = twr2.Twr_TwrId AND TwC_TwCNumer=1&#xD;
     LEFT JOIN #skladilosc ON Tow1ID = twr1.Twr_TwrId AND Tow2ID = twr2.Twr_TwrId AND SkladLp = PdS_Lp&#xD;
     &#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = twr1.Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = twr1.Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON twr1.Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON twr1.Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON twr1.Twr_KntId = knt4.Knt_KntId&#xD;
   	 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod1.Pod_Kod [Kontrahent Kod],  &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    NULL [Składnik Lp],&#xD;
    ''Korekta zbiorcza'' [Składnik Nazwa],  &#xD;
    ''Korekta zbiorcza'' [Składnik Kod],    &#xD;
    0 [Składnik Ilość], &#xD;
    ''(BRAK)'' [Składnik Jednostka Miary],  &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa], &#xD;
    ''(BRAK)'' [Produkt Dostawca], &#xD;
 ''Korekta zbiorcza'' [Receptura Nazwa],&#xD;
 0 [Receptura Ilość Produktu],&#xD;
    ''Korekta zbiorcza'' [Receptura Jednostka Miary],&#xD;
    0 [Składnik Cena],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],         &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary],     &#xD;
    ''(BRAK)'' [Magazyn Nazwa],&#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
*/&#xD;
    ---------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = ser.DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	  LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)&#xD;
&#xD;
&#xD;
DROP TABLE #skladile&#xD;
DROP TABLE #recile&#xD;
DROP TABLE #skladilosc&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2j/1TkAflu1qJpLRHJ6czE3BujRzlkUSaW8as+SjVAXoelJ5fuODTQnscD+DslihafV958jzfo3RdXYsmku2eJEY0lSvsR/XYwAYcufTKHYJbXyO6BdnoAagVw7fqNxEWDujw5hEHCVIKtaqZinJSWWw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Składnik Lp" caption="Składnik Lp" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Składnik Nazwa" caption="Składnik Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Składnik Kod" caption="Składnik Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Składnik Ilość" caption="Składnik Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składnik Jednostka Miary" caption="Składnik Jednostka Miary" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Receptura Nazwa" caption="Receptura Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Receptura Ilość Produktu" caption="Receptura Ilość Produktu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Receptura Jednostka Miary" caption="Receptura Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Składnik Cena" caption="Składnik Cena" type="measure" formatString="c2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa __DATABASE__1" caption="Odbiorca Nazwa __DATABASE__" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR PARTII" caption="Produkt Atrybut NR PARTII" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAZNOSCI" caption="Produkt Atrybut DATA WAZNOSCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR PARTII" caption="Pozycja Atrybut NR PARTII" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAZNOSCI" caption="Pozycja Atrybut DATA WAZNOSCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[f9145f3d-0ca0-4dc7-8be7-fedf571987a1]" caption="Składnik Wartość Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data początkowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Początkowa data analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT DATEADD( dd, -DAY( GETDATE()-1),GETDATE())&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-09-01&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data końcowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Końcowa data analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-09-20&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAAAAAAAAAAAP////8AAAAAAAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="311" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[f9145f3d-0ca0-4dc7-8be7-fedf571987a1]" caption="Składnik Wartość Zakupu" formula="Składnik Ilość*Składnik Cena" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Składnik Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Składnik Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="119" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Produkt Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Składnik Cena"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="131" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Typ"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="121" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="124" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[f9145f3d-0ca0-4dc7-8be7-fedf571987a1]"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="False" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Składnik Ilość" index="2" expanded="True" sortMode="default" order="ascending" width="119" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Składnik Cena" index="3" expanded="True" sortMode="default" order="ascending" width="131" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="121" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="1" expanded="True" sortMode="default" order="ascending" width="124" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[f9145f3d-0ca0-4dc7-8be7-fedf571987a1]" index="4" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="False" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Składnik Nazwa" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Nazwa" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Produkt Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Typ" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;included&gt;&lt;value uniqueName="Towar złożony" /&gt;&lt;value uniqueName="Usługa złożona" /&gt;&lt;/included&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż z uwzględnieniem towarów i usług złożonych dla określonego podczas uruchamiania zakresu dat dokumentów sprzedaży. Dla towarów i usług złożonych przyjmowana jest domyślna receptura i jej składniki.</a:description><a:id>71</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.35 Sprzedaż - towary i usługi złożone</a:mainLinkName><a:modifiedOn>2025-05-23T16:09:08.153</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2018-09-14T15:24:49.057</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży ze stawkami VAT&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    CONVERT(varchar,TrE_Stawka) + ''%'' [Stawka VAT],&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
    ,CAST(TR.TrE_Ilosc/(Twr_JMPrzelicznikL*Twr_JMPrzelicznikM) AS DECIMAL(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,CAST(TR.TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
	LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    CONVERT(varchar,TrV_Stawka) + ''%'' [Stawka VAT],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,''(BRAK)'' [Produkt Pozycja Dokumentu]&#xD;
&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
    LEFT JOIN CDN.TraVat ON TrN_TrNID = TrV_TrNID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmppozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Stawka VAT" caption="Stawka VAT" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAC6AAAABwIlW0Rva3VtZW50IE51bWVyXS5bQVNEL0ZBV1ovMS8yMDE2LzEwXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzEvMjAwOF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS8xLzIwMDldBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMS8yMDExXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzEvMjAxNF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS8xLzIwMTVdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMS8yMDE2XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzEvMjAxOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xMC8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzEwLzIwMTJdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTAvMjAxNF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xMC8yMDE4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzEwMC8yMDA4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzEwMS8yMDA4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzEwMi8yMDA4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzEwMy8yMDA4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzEwNC8yMDA4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzEwNS8yMDA4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzEwNi8yMDA4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzEwNy8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzExLzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTEvMjAwOV0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xMS8yMDEyXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzExLzIwMTRdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTEvMjAxOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xMi8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzEyLzIwMDldBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTIvMjAxMl0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xMi8yMDE0XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzEyLzIwMThdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTMvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xMy8yMDA5XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzEzLzIwMTJdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTMvMjAxNF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xMy8yMDE4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzE0LzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTQvMjAxMl0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xNC8yMDE0XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzE0LzIwMThdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTUvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xNS8yMDEyXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzE1LzIwMTRdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTUvMjAxOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xNi8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzE2LzIwMTJdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTYvMjAxOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xNy8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzE3LzIwMThdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTgvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xOC8yMDEyXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzE5LzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTkvMjAxMl0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS8yLzIwMDhdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMi8yMDA5XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzIvMjAxMV0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS8yLzIwMTJdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMi8yMDEzXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzIvMjAxNF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS8yLzIwMTVdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMi8yMDE2XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzIvMjAxOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8yMC8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzIwLzIwMTJdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjEvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8yMS8yMDEyXQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzIxMi8yMDA4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzIxMy8yMDA4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzIxNC8yMDA4XQcCHltEb2t1bWVudCBOdW1lcl0uW0ZBLzIxNS8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzIyLzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjIvMjAxMl0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8yMy8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzIzLzIwMTJdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjQvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8yNC8yMDEyXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzI1LzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjUvMjAxMl0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8yNi8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzI2LzIwMTJdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjcvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8yOC8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzI5LzIwMDhdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMy8yMDA4XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzMvMjAwOV0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS8zLzIwMTFdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMy8yMDEyXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzMvMjAxM10HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS8zLzIwMTRdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMy8yMDE4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzMwLzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMzEvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8zMy8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzM0LzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMzUvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8zNi8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzM3LzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMzgvMjAwOF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS80LzIwMDhdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvNC8yMDA5XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzQvMjAxMV0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS80LzIwMTJdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvNC8yMDEzXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzQvMjAxNF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS80LzIwMThdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvNDAvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS80MS8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzQyLzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvNDMvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS80NC8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzQ1LzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvNDYvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS80Ny8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzQ4LzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvNDkvMjAwOF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS81LzIwMDhdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvNS8yMDA5XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzUvMjAxMV0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS81LzIwMTJdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvNS8yMDE0XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzUvMjAxOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS81MC8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzUxLzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvNTIvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS81My8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzU0LzIwMDhdBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvNTUvMjAwOF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS82LzIwMDhdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvNi8yMDA5XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzYvMjAxMV0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS82LzIwMTJdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvNi8yMDEzXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzYvMjAxNF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS82LzIwMThdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvNy8yMDA4XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzcvMjAwOV0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS83LzIwMTFdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvNy8yMDEyXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzcvMjAxM10HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS83LzIwMTRdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvNy8yMDE4XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzgvMjAwOF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS84LzIwMDldBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvOC8yMDEyXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzgvMjAxM10HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS84LzIwMTRdBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvOC8yMDE4XQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzkvMjAwOF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS85LzIwMDldBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvOS8yMDEyXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzkvMjAxNF0HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS85LzIwMThdBwImW0Rva3VtZW50IE51bWVyXS5bRkFVRS8wMDAwMDEvMjAwOC9VRV0HAiZbRG9rdW1lbnQgTnVtZXJdLltGQVVFLzAwMDAwMi8yMDA4L1VFXQcCJltEb2t1bWVudCBOdW1lcl0uW0ZBVUUvMDAwMDAzLzIwMDgvVUVdBwImW0Rva3VtZW50IE51bWVyXS5bRkFVRS8wMDAwMDQvMjAwOC9VRV0HAh5bRG9rdW1lbnQgTnVtZXJdLltGQVdLLzEvMjAwOF0HAh5bRG9rdW1lbnQgTnVtZXJdLltGQVdLLzIvMjAwOF0HAh5bRG9rdW1lbnQgTnVtZXJdLltGS09SLzEvMjAxMl0HAh5bRG9rdW1lbnQgTnVtZXJdLltGS09SLzEvMjAxM10HAh5bRG9rdW1lbnQgTnVtZXJdLltGS09SLzEvMjAxOF0HAh5bRG9rdW1lbnQgTnVtZXJdLltGS09SLzIvMjAxMl0HAh5bRG9rdW1lbnQgTnVtZXJdLltGS09SLzIvMjAxM10HAh5bRG9rdW1lbnQgTnVtZXJdLltGS09SLzIvMjAxOF0HAh5bRG9rdW1lbnQgTnVtZXJdLltGS09SLzMvMjAxMl0HAh5bRG9rdW1lbnQgTnVtZXJdLltGS09SLzMvMjAxOF0HAh5bRG9rdW1lbnQgTnVtZXJdLltGS09SLzQvMjAxMl0HAhxbRG9rdW1lbnQgTnVtZXJdLltQQS8xLzIwMDhdBwIcW0Rva3VtZW50IE51bWVyXS5bUEEvMS8yMDEyXQcCHFtEb2t1bWVudCBOdW1lcl0uW1BBLzEvMjAxOF0HAhxbRG9rdW1lbnQgTnVtZXJdLltQQS8yLzIwMDhdBwIcW0Rva3VtZW50IE51bWVyXS5bUEEvMi8yMDEyXQcCHFtEb2t1bWVudCBOdW1lcl0uW1BBLzIvMjAxOF0HAhxbRG9rdW1lbnQgTnVtZXJdLltQQS8zLzIwMDhdBwIcW0Rva3VtZW50IE51bWVyXS5bUEEvMy8yMDEyXQcCHFtEb2t1bWVudCBOdW1lcl0uW1BBLzMvMjAxOF0HAhxbRG9rdW1lbnQgTnVtZXJdLltQQS80LzIwMDhdBwIcW0Rva3VtZW50IE51bWVyXS5bUEEvNC8yMDEyXQcCHFtEb2t1bWVudCBOdW1lcl0uW1BBLzQvMjAxOF0HAhxbRG9rdW1lbnQgTnVtZXJdLltQQS81LzIwMDhdBwIcW0Rva3VtZW50IE51bWVyXS5bUEEvNS8yMDE4XQcCH1tEb2t1bWVudCBOdW1lcl0uW1BBS09SLzEvMjAxOF0HAh9bRG9rdW1lbnQgTnVtZXJdLltQQUtPUi8yLzIwMThdBwIfW0Rva3VtZW50IE51bWVyXS5bUEFLT1IvMy8yMDE4XQcCH1tEb2t1bWVudCBOdW1lcl0uW1BBS09SLzQvMjAxOF0HAh9bRG9rdW1lbnQgTnVtZXJdLltQQUtPUi81LzIwMThdBwIfW0Rva3VtZW50IE51bWVyXS5bUEFLT1IvNi8yMDE4Xf////8AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Stawka VAT"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Stawka VAT" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż z uwzględnieniem stawek VAT.</a:description><a:id>72</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.36 Sprzedaż ze stawkami VAT</a:mainLinkName><a:modifiedOn>2025-05-23T16:07:20.84</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2018-09-19T11:55:59.153</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży ze stanami magazynowymi na dzień&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Liczenie ostatniej daty w bazie&#xD;
SELECT TwI_TwrId [TwI_TId], ISNULL(TwI_MagId,0) [TwI_MId], MAX(TwI_Data) [TwI_OstatniaData] INTO #TwrIlosci&#xD;
FROM CDN.TwrIlosci t&#xD;
WHERE TwI_Data &lt;= @DATA&#xD;
GROUP BY TwI_TwrId, TwI_MagId;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g;&#xD;
&#xD;
 WITH RankedData AS (&#xD;
  SELECT&#xD;
    twi_twiid,&#xD;
    twi_twrid,&#xD;
    Twi_data,&#xD;
    ROW_NUMBER() OVER (PARTITION BY twi_twrid ORDER BY Twi_data DESC) AS rn&#xD;
  FROM cdn.twrilosci&#xD;
  where twi_magid is not null &#xD;
)&#xD;
SELECT twi_twiid as id, twi_twrid, Twi_data&#xD;
into #TmpOstatniStanMag&#xD;
FROM RankedData&#xD;
WHERE rn = 1;&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @select4 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
&#xD;
	 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Potencjalny'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Potencjalny'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary],  &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość],&#xD;
    d.ild [Ilość Dostępna],&#xD;
    d.ilmin [Ilość Minimalna],&#xD;
    d.ilmax [Ilość Maksymalna],&#xD;
    d.zampo [Zamawiać Po],&#xD;
    d.braki [Braki],&#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] &#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/  &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT JOIN &#xD;
     (&#xD;
     SELECT &#xD;
    TwI_TwrId [towid],&#xD;
    CASE WHEN SUM(ISNULL(TwI_Ilosc, 0))&gt;0 THEN SUM(ISNULL(TwI_Ilosc, 0)) ELSE 0 END [tilosc],&#xD;
    CASE WHEN SUM(ISNULL(TwI_Ilosc-TwI_Rezerwacje, 0))&gt;0 THEN SUM(ISNULL(TwI_Ilosc-TwI_Rezerwacje, 0)) ELSE 0 END [ild],&#xD;
    CASE WHEN MIN(ISNULL(Twr_IloscMin, 0))&gt;0 THEN MIN(ISNULL(Twr_IloscMin, 0)) ELSE 0 END [ilmin],&#xD;
    CASE WHEN MAX(ISNULL(Twr_IloscMax, 0))&gt;0 THEN MAX(ISNULL(Twr_IloscMax, 0)) ELSE 0 END [ilmax],&#xD;
    CASE WHEN MIN(ISNULL(Twr_IloscZam, 0))&gt;0 THEN MIN(ISNULL(Twr_IloscZam, 0)) ELSE 0 END [zampo],&#xD;
    CASE WHEN SUM(ISNULL(TwI_Braki, 0))&gt;0 THEN SUM(ISNULL(TwI_Braki, 0)) ELSE 0 END [braki],&#xD;
    TwI_MagId [magid]&#xD;
    FROM CDN.TwrIlosci&#xD;
    JOIN CDN.Towary ON TwI_TwrId = Twr_TwrId&#xD;
    JOIN #TwrIlosci ON TwI_TId = TwI_TwrId AND TwI_OstatniaData = TwI_Data AND TwI_MId = TwI_MagId&#xD;
    GROUP BY TwI_TwrId, TwI_MagId)&#xD;
    d ON d.towid = TrE_TwrId AND d.towid = Twr_TwrId and d.magid = Mag_MagId &#xD;
&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0'&#xD;
IF @ZEROWE = 'NIE' SET @select2 = @select2 + 'AND ISNULL(d.tilosc, 0) &lt;&gt; 0'&#xD;
&#xD;
SET @select2 = @select2 + '&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],    &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],   &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod],    &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Potencjalny'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Potencjalny'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],             &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary],     &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość],&#xD;
    0 [Ilość Dostępna],&#xD;
    0 [Ilość Minimalna],&#xD;
    0 [Ilość Maksymalna],&#xD;
    0 [Zamawiać Po],&#xD;
    0 [Braki],&#xD;
    KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
       +&#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
	 &#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
set @select3 = ''&#xD;
IF @BEZSPRZEDAZY = 'TAK' SET @select3 = @select3 + &#xD;
'&#xD;
UNION ALL &#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    ''Nie Dotyczy''[Liczba dokumentów],&#xD;
    ''Nie Dotyczy'' [Dokument Numer],&#xD;
    ''Nie Dotyczy'' [Dokument Opis],&#xD;
    ''Nie Dotyczy'' [Dokument Symbol],  &#xD;
    ''Nie Dotyczy''  [Dokument Seria],&#xD;
    ''Nie Dotyczy'' [Waluta],&#xD;
    ''Nie Dotyczy'' [Forma Płatności],&#xD;
    ''Nie Dotyczy'' [Kategoria Szczegółowa z Nagłówka], ''Nie Dotyczy'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ''Nie Dotyczy'' [Kategoria Ogólna z Nagłówka], ''Nie Dotyczy'' [Kategoria Ogólna z Pozycji],    &#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Nazwa],   &#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Kod],     &#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Województwo],''Nie Dotyczy'' [Kontrahent Pierwotny Miasto],&#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Kraj], ''Nie Dotyczy'' [Kontrahent Pierwotny NIP],&#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Grupa], ''Nie Dotyczy'' [Kontrahent Pierwotny Kategoria],&#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Opiekun],&#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Rodzaj],&#xD;
    ''Nie Dotyczy'' [Liczba Kontrahentów], &#xD;
    ''Nie Dotyczy'' [Kontrahent Nazwa],     &#xD;
    ''Nie Dotyczy'' [Kontrahent Kod],&#xD;
        ''Nie Dotyczy'' [Kontrahent Województwo],''Nie Dotyczy'' [Kontrahent Miasto],&#xD;
    ''Nie Dotyczy''[Kontrahent Kraj], ''Nie Dotyczy'' [Kontrahent NIP],&#xD;
    ''Nie Dotyczy'' [Kontrahent Grupa], ''Nie Dotyczy'' [Kontrahent Kategoria],&#xD;
    ''Nie Dotyczy'' [Kontrahent Opiekun],&#xD;
    ''Nie Dotyczy''[Kontrahent Rodzaj], &#xD;
    ''Nie Dotyczy''  [Liczba Odbiorców], &#xD;
    ''Nie Dotyczy'' [Odbiorca Nazwa],   &#xD;
    ''Nie Dotyczy'' [Odbiorca Kod], &#xD;
        ''Nie Dotyczy'' [Odbiorca Województwo],&#xD;
    ''Nie Dotyczy'' [Odbiorca Miasto],&#xD;
    ''Nie Dotyczy'' [Odbiorca Kraj],&#xD;
    ''Nie Dotyczy'' [Odbiorca Grupa], &#xD;
    ''Nie Dotyczy'' [Odbiorca Opiekun],&#xD;
    ''Nie Dotyczy'' [Operator Wprowadzający], ''Nie Dotyczy'' [Operator Modyfikujący],&#xD;
    NULL  [Liczba Produktów], &#xD;
     ISNULL(Twr_Kategoria,Kat_Opis) [Produkt Kategoria],&#xD;
     Twr_Nazwa [Produkt Nazwa],&#xD;
    Twr_SWW [Produkt PKWiU], &#xD;
    ISNULL(knt_kod , ''(NIEPRZYPISANE)'')[Produkt Dostawca],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], ''Nie Dotyczy'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''Nie Dotyczy'' [Produkt Kaucja], Twr_Jm [Jednostka Miary],     &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
&#xD;
    NULL [Czas Aktualny Dziś],&#xD;
    NULL [Czas Aktualny Wczoraj],&#xD;
    NULL [Czas Aktualny Tydzień],&#xD;
    NULL [Czas Aktualny Miesiąc],&#xD;
    NULL [Czas Aktualny Miesiąc Poprzedni],&#xD;
    0 [Sprzedaż Wartość], 0 [Sprzedaż Wartość Brutto], 0 [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość],&#xD;
    TwI_Ilosc [Ilość Dostępna],&#xD;
    ISNULL(Twr_IloscMin,0) [Ilość Minimalna],&#xD;
    ISNULL(Twr_IloscMax,0) [Ilość Maksymalna],&#xD;
    0 [Zamawiać Po],&#xD;
    TwI_Braki [Braki],&#xD;
    0 [Koszt Zakupu], &#xD;
    0 [Sprzedaż Marża],&#xD;
    0 [Sprzedaż Rabat]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,NULL [Data Operacji] &#xD;
    ,NULL [Data Wystawienia] &#xD;
    ,NULL [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,NULL [Data Operacji Dzień] &#xD;
    ,NULL [Data Operacji Tydzień Roku] &#xD;
    ,NULL [Data Operacji Miesiąc], NULL [Data Operacji Kwartał], NULL [Data Operacji Rok] &#xD;
    ,NULL [Data Wystawienia Dzień] &#xD;
    ,NULL [Data Wystawienia Tydzień Roku] &#xD;
    ,NULL [Data Wystawienia Miesiąc], NULL [Data Wystawienia Kwartał],NULL [Data Wystawienia Rok] &#xD;
    ,NULL [Termin Płatności Dzień]&#xD;
    ,NULL [Termin Płatności Tydzień Roku] &#xD;
    ,NULL [Termin Płatności Miesiąc], NULL [Termin Płatności Kwartał],NULL [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], NULL [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], NULL [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], NULL[Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], NULL [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__],NULL [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], NULL [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], NULL [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], twr_twrid [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], twr_twrid [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], mag_magid [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
      ' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       +'&#xD;
 FROM cdn.TwrIlosci&#xD;
LEFT JOIN cdn.Towary on Twr_TwrId = TwI_TwrId &#xD;
LEFT JOIN cdn.Magazyny on TwI_MagId = Mag_MagId AND twi_magid is not null&#xD;
Left join cdn.Kontrahenci on Twr_KntId = Knt_KntId &#xD;
LEFT JOIN cdn.Kategorie on  Twr_KatId = Kat_KatID &#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
         LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
         LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON 0=1&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON 0=1&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON 0=1&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON Twr_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on 0=1&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
             WHERE twi_twrid not in (select tre_twrid from cdn.traelem where TrE_TypDokumentu IN (-1,302,305)) &#xD;
             AND twi_twiid IN (SELECT id from #TmpOstatniStanMag)&#xD;
&#xD;
'&#xD;
&#xD;
set @select4 = ''&#xD;
IF @ZEROWE = 'TAK' SET @select4 = @select4 + &#xD;
'&#xD;
UNION ALL &#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    ''Nie Dotyczy''[Liczba dokumentów],&#xD;
    ''Nie Dotyczy'' [Dokument Numer],&#xD;
    ''Nie Dotyczy'' [Dokument Opis],&#xD;
    ''Nie Dotyczy'' [Dokument Symbol],  &#xD;
    ''Nie Dotyczy''  [Dokument Seria],&#xD;
    ''Nie Dotyczy'' [Waluta],&#xD;
    ''Nie Dotyczy'' [Forma Płatności],&#xD;
    ''Nie Dotyczy'' [Kategoria Szczegółowa z Nagłówka], ''Nie Dotyczy'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ''Nie Dotyczy'' [Kategoria Ogólna z Nagłówka], ''Nie Dotyczy'' [Kategoria Ogólna z Pozycji],    &#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Nazwa],   &#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Kod],     &#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Województwo],''Nie Dotyczy'' [Kontrahent Pierwotny Miasto],&#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Kraj], ''Nie Dotyczy'' [Kontrahent Pierwotny NIP],&#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Grupa], ''Nie Dotyczy'' [Kontrahent Pierwotny Kategoria],&#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Opiekun],&#xD;
    ''Nie Dotyczy'' [Kontrahent Pierwotny Rodzaj],&#xD;
    ''Nie Dotyczy'' [Liczba Kontrahentów], &#xD;
    ''Nie Dotyczy'' [Kontrahent Nazwa],     &#xD;
    ''Nie Dotyczy'' [Kontrahent Kod],&#xD;
        ''Nie Dotyczy'' [Kontrahent Województwo],''Nie Dotyczy'' [Kontrahent Miasto],&#xD;
    ''Nie Dotyczy''[Kontrahent Kraj], ''Nie Dotyczy'' [Kontrahent NIP],&#xD;
    ''Nie Dotyczy'' [Kontrahent Grupa], ''Nie Dotyczy'' [Kontrahent Kategoria],&#xD;
    ''Nie Dotyczy'' [Kontrahent Opiekun],&#xD;
    ''Nie Dotyczy''[Kontrahent Rodzaj], &#xD;
    ''Nie Dotyczy''  [Liczba Odbiorców], &#xD;
    ''Nie Dotyczy'' [Odbiorca Nazwa],   &#xD;
    ''Nie Dotyczy'' [Odbiorca Kod], &#xD;
        ''Nie Dotyczy'' [Odbiorca Województwo],&#xD;
    ''Nie Dotyczy'' [Odbiorca Miasto],&#xD;
    ''Nie Dotyczy'' [Odbiorca Kraj],&#xD;
    ''Nie Dotyczy'' [Odbiorca Grupa], &#xD;
    ''Nie Dotyczy'' [Odbiorca Opiekun],&#xD;
    ''Nie Dotyczy'' [Operator Wprowadzający], ''Nie Dotyczy'' [Operator Modyfikujący],&#xD;
    NULL  [Liczba Produktów], &#xD;
     ISNULL(Twr_Kategoria,Kat_Opis) [Produkt Kategoria],&#xD;
     Twr_Nazwa [Produkt Nazwa],&#xD;
    Twr_SWW [Produkt PKWiU], &#xD;
    ISNULL(knt_kod , ''(NIEPRZYPISANE)'')[Produkt Dostawca],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], ''Nie Dotyczy'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''Nie Dotyczy'' [Produkt Kaucja], Twr_Jm [Jednostka Miary],     &#xD;
    ''Nie Dotyczy'' [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
&#xD;
    NULL [Czas Aktualny Dziś],&#xD;
    NULL [Czas Aktualny Wczoraj],&#xD;
    NULL [Czas Aktualny Tydzień],&#xD;
    NULL [Czas Aktualny Miesiąc],&#xD;
    NULL [Czas Aktualny Miesiąc Poprzedni],&#xD;
    0 [Sprzedaż Wartość], 0 [Sprzedaż Wartość Brutto], 0 [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość],&#xD;
    0 [Ilość Dostępna],&#xD;
    ISNULL(Twr_IloscMin,0) [Ilość Minimalna],&#xD;
    ISNULL(Twr_IloscMax,0) [Ilość Maksymalna],&#xD;
    0 [Zamawiać Po],&#xD;
    0 [Braki],&#xD;
    0 [Koszt Zakupu], &#xD;
    0 [Sprzedaż Marża],&#xD;
    0 [Sprzedaż Rabat]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,NULL [Data Operacji] &#xD;
    ,NULL [Data Wystawienia] &#xD;
    ,NULL [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,NULL [Data Operacji Dzień] &#xD;
    ,NULL [Data Operacji Tydzień Roku] &#xD;
    ,NULL [Data Operacji Miesiąc], NULL [Data Operacji Kwartał], NULL [Data Operacji Rok] &#xD;
    ,NULL [Data Wystawienia Dzień] &#xD;
    ,NULL [Data Wystawienia Tydzień Roku] &#xD;
    ,NULL [Data Wystawienia Miesiąc], NULL [Data Wystawienia Kwartał],NULL [Data Wystawienia Rok] &#xD;
    ,NULL [Termin Płatności Dzień]&#xD;
    ,NULL [Termin Płatności Tydzień Roku] &#xD;
    ,NULL [Termin Płatności Miesiąc], NULL [Termin Płatności Kwartał],NULL [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], NULL [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], NULL [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], NULL[Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], NULL [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__],NULL [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], NULL [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], NULL [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], twr_twrid [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], twr_twrid [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], null [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
      ' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       +'&#xD;
 FROM cdn.Towary&#xD;
&#xD;
Left join cdn.Kontrahenci on Twr_KntId = Knt_KntId &#xD;
LEFT JOIN cdn.Kategorie on  Twr_KatId = Kat_KatID &#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
         LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
         LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON 0=1&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON 0=1&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON 0=1&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON Twr_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on 0=1&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE  twr_twrid not in (Select twi_twrid from cdn.twrilosci)&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3+@select4)&#xD;
exec (@select + @select2 + @select3+@select4)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #TwrIlosci&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #TmpOstatniStanMag&#xD;
  DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJYUqeCr8Pxdj8+upk/NTIN3v9MLjfPmIU+nQ5u+PJf8FQf4EHonltB/N8DJWtwPpYBgTi8H+3FEvyN+L4/XRST6Gi7CffiFzdiVYZnKf7YOwe4CzwSKWfhcV3WUBWxKGjSsug9Z8luBjB9NZgGJzbng==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Dostępna" caption="Ilość Dostępna" type="measure" formatString="n2" aggregate="Min" /&gt;&#xD;
    &lt;column name="Ilość Minimalna" caption="Ilość Minimalna" type="measure" formatString="n2" aggregate="Min" /&gt;&#xD;
    &lt;column name="Ilość Maksymalna" caption="Ilość Maksymalna" type="measure" formatString="n2" aggregate="Max" /&gt;&#xD;
    &lt;column name="Zamawiać Po" caption="Zamawiać Po" type="measure" formatString="n2" aggregate="Min" /&gt;&#xD;
    &lt;column name="Braki" caption="Braki" type="measure" formatString="n2" aggregate="Min" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATA&lt;/Name&gt;&#xD;
    &lt;Label&gt;Stan magazynów na dzień:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data, dla której zostanie wykonana analiza&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;ZEROWE&lt;/Name&gt;&#xD;
    &lt;Label&gt;Pokazuj stany zerowe:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Parametr określający czy w raporcie mają być widoczne stany zerowe&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;'TAK';'NIE'&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;'NIE'&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;BEZSPRZEDAZY&lt;/Name&gt;&#xD;
    &lt;Label&gt;Pokazuj produkty bez sprzedaży:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Parametr określający czy w raporcie mają być widoczne produkty bez dokumentów sprzedaży&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;'TAK';'NIE'&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;'NIE'&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Magazyn Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Ilość Dostępna"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Ilość Minimalna"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Ilość Maksymalna"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Zamawiać Po"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Braki"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Ilość Dostępna" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Ilość Minimalna" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Ilość Maksymalna" index="3" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Zamawiać Po" index="4" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Braki" index="5" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Magazyn Nazwa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters filetrMask="" isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż dla produktów z uwgzględnieniem ich stanów magazynowaych.</a:description><a:id>73</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.37 Sprzedaż ze stanami magazynowymi na dzień</a:mainLinkName><a:modifiedOn>2025-05-23T14:59:45.763</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2018-09-24T10:39:39.09</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zestawienie miesięczne sprzedaży i zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @select4 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
	 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary],  &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość],&#xD;
    0 [Zakupy Wartość], 0 [Zakupy Wartość Brutto], 0 [Zakupy Wartość Waluta], 0 [Zakupy Ilość], &#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] &#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]  &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa], &#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU],&#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],             &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary],     &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], 0 [Zakupy Wartość], 0 [Zakupy Wartość Brutto], 0 [Zakupy Wartość Waluta], 0 [Zakupy Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary],  &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    0 [Sprzedaż Wartość], 0 [Sprzedaż Wartość Brutto], 0 [Sprzedaż Wartość Waluta], 0 [Sprzedaż Ilość],&#xD;
    TR.TrE_WartoscNetto [Zakupy Wartość], TR.TrE_WartoscBrutto [Zakupy Wartość Brutto], TR.TrE_WartoscNettoWal [Zakupy Wartość Waluta], TR.TrE_Ilosc [Zakupy Ilość], &#xD;
    0 [Koszt Zakupu], &#xD;
    0 [Sprzedaż Marża],&#xD;
    0 [Sprzedaż Rabat] &#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
*/  &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,29047 [Dokument Numer __PROCID__Zakupy__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select4 = &#xD;
' FROM cdn.TraNag &#xD;
JOIN cdn.TraElem TR ON TR.TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu=301&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3 + @select4) &#xD;
exec (@select + @select2 + @select3 + @select4)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
  DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[6199214a-de58-4fcb-a190-d5100ae2d500]" caption="Dochód/Strata" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[133fe894-2dff-4a9b-9e07-f4be2ca29c8d]" caption="Nadwyżka Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[6199214a-de58-4fcb-a190-d5100ae2d500]" caption="Dochód/Strata" formula="Sprzedaż Wartość-Zakupy Wartość" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[133fe894-2dff-4a9b-9e07-f4be2ca29c8d]" caption="Nadwyżka Zakupu" formula="Zakupy Wartość-Koszt Zakupu" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Data Operacji Miesiąc"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Koszt Zakupu"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[6199214a-de58-4fcb-a190-d5100ae2d500]"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="False" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[133fe894-2dff-4a9b-9e07-f4be2ca29c8d]"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="False" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Wartość" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Koszt Zakupu" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[6199214a-de58-4fcb-a190-d5100ae2d500]" index="3" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="False" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[133fe894-2dff-4a9b-9e07-f4be2ca29c8d]" index="4" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="False" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Data Operacji Miesiąc" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Data Operacji Rok" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje zestawienie miesięczne sprzedaży oraz zakupów.&#xD;
W przypadku faktur do których są wysatawione paragony raport prezntuje paragony. &#xD;
W przypadku faktur, do których są wystawione faktury zaliczkowe raport nie pokazuje faktur zaliczkowych, a cała kwota faktury jest pokazywana w fakturze finalnej</a:description><a:id>74</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.38 Zestawienie miesięczne sprzedaży i zakupów </a:mainLinkName><a:modifiedOn>2025-05-23T14:55:35.787</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2018-09-28T14:36:58.987</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/*&#xD;
* Raport Sprzedaży z analizą ABC&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje;&#xD;
&#xD;
--Grupowanie produktów pod Analizę ABC&#xD;
WITH ProdABC AS &#xD;
(&#xD;
SELECT&#xD;
[prid] = Twr_TwrId,&#xD;
[Sumsal] = SUM(TrE_WartoscNetto)&#xD;
FROM CDN.TraNag&#xD;
JOIN CDN.TraElem ON TrN_TrNID = TrE_TrNId&#xD;
LEFT JOIN CDN.Towary ON TrE_TwrId = Twr_TwrId&#xD;
 WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
GROUP BY&#xD;
Twr_TwrId&#xD;
)&#xD;
&#xD;
SELECT prid,&#xD;
CASE&#xD;
    WHEN SUM(sumsal) OVER (ORDER BY sumsal DESC) / SUM(sumsal) OVER () &lt;= CAST(@A AS DECIMAL)/100 THEN 'A'&#xD;
    WHEN SUM(sumsal) OVER (ORDER BY sumsal DESC) / SUM(sumsal) OVER ()  &gt; CAST(@A AS DECIMAL)/100 AND SUM(sumsal) OVER (ORDER BY sumsal DESC) / SUM(sumsal) OVER () &lt; (100 - CAST(@C AS DECIMAL))/100 THEN 'B'&#xD;
    ELSE 'C'&#xD;
    END [abc]&#xD;
INTO #abc&#xD;
FROM ProdABC&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    abc [Analiza ABC],&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] &#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
*/      &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT JOIN #abc ON prid = Twr_TwrId&#xD;
LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],   &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod],    &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],             &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    ''(BRAK)'' [Analiza ABC],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	  LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #abc&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Analiza ABC" caption="Analiza ABC" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;A&lt;/Name&gt;&#xD;
    &lt;Label&gt;A %&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Procentowy udział w skumulowanej sumie sprzedaży dla kategorii A.&lt;/ToolTip&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;1&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;100&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;80&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;C&lt;/Name&gt;&#xD;
    &lt;Label&gt;C %&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Procentowy udział w skumulowanej sumie sprzedaży dla kategorii C.&lt;/ToolTip&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;1&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;100&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;5&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="False" type="Bar" palette="In A Fog" paletteBaseColor="0" style="In A Fog" grandTotals="False" subTotals="False" onlySelected="False" showSeriesInSeparatePanes="False" fieldVisible="False" rotated="False" dataVertical="True" showParametersValues="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#C6D3EF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="False" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="Top" zeroValues="False" textIndent="2" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1" textOrientation="Horizontal"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="2" spacingHorizontal="4" limitsVertical="100" limitsHorizontal="100" location="{X=1190,Y=432}" isCustomLocation="False"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Analiza ABC" visible="True" dock="Top" alignment="Center" indent="5" location="{X=655,Y=5}" isCustomLocation="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="Black" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;pointOptions pointView="Values" pattern="{V}"&gt;&#xD;
    &lt;valueNumericOptions numericFormat="General" numericPrecision="2" /&gt;&#xD;
    &lt;valueDateTimeOptions dateTimeFormat="ShortDate" dateTimeFormatString="" /&gt;&#xD;
    &lt;argumentNumericOptions numericFormat="General" numericPrecision="2" /&gt;&#xD;
    &lt;argumentDateTimeOptions dateTimeFormat="ShortDate" dateTimeFormatString="" /&gt;&#xD;
  &lt;/pointOptions&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="[Analiza ABC].[A]|[Produkt Kod].[RÓŻA_PN]" rangeMax="[Analiza ABC].[C]|[Produkt Kod].[TOWARWOPAKOWANIU]" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="0" rangeMax="81159,012" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Analiza ABC"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="displayText" order="descending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy dataFieldName="Sprzedaż Wartość" /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Analiza ABC" index="0" expanded="True" sortMode="displayText" order="descending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy dataFieldName="Sprzedaż Wartość" /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded&gt;&lt;value uniqueName="(BRAK)" /&gt;&lt;/excluded&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje produkty wraz wartością ich sprzedaży w podziale na kategorie A,B i C. Domyślnie kategoria A obejmuje produkty generujące 80% sprzedaży, kategoria C - 5% sprzedaży oraz kategoria B – pozostałe 15%. Możliwa jest edycja procentowych wartości parametrów A i C.&#xD;
&#xD;
Raport działa prawidłowo dla SQL Server w wersji od 2012.</a:description><a:id>75</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.39 Analiza ABC</a:mainLinkName><a:modifiedOn>2025-05-23T12:56:50.827</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2018-10-09T12:40:36.797</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Kontrahentów&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
&#xD;
&#xD;
DECLARE @select VARCHAR(MAX);&#xD;
DECLARE @select2 VARCHAR(MAX);&#xD;
&#xD;
&#xD;
&#xD;
set @select = &#xD;
'&#xD;
SELECT&#xD;
DB_NAME() [Baza Firmowa],&#xD;
knt_nazwa1 [Kontrahent Nazwa], &#xD;
&#xD;
20201 [Kontrahent Nazwa __PROCID__], Knt_KntId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__],&#xD;
&#xD;
knt_kod [Kontrahent Kod],&#xD;
20201 [Kontrahent Kod __PROCID__Kontrahenci__], Knt_KntId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__],&#xD;
&#xD;
REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Pierwszej Operacji Dzień], &#xD;
(datepart(DY, datediff(d, 0, pierwsza) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, pierwsza)*/ [Data Pierwszej Operacji Tydzień Roku], &#xD;
MONTH(pierwsza) [Data Pierwszej Operacji Miesiąc], DATEPART(quarter, pierwsza) [Data Pierwszej Operacji Kwartał], YEAR(pierwsza) [Data Pierwszej Operacji Rok], &#xD;
&#xD;
REPLACE(CONVERT(VARCHAR(10), ostatnia, 111), ''/'', ''-'') [Data Ostatniej Operacji Dzień], &#xD;
(datepart(DY, datediff(d, 0, ostatnia) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Ostatniej Operacji Tydzień Roku], &#xD;
MONTH(ostatnia) [Data Ostatniej Operacji Miesiąc], DATEPART(quarter, ostatnia) [Data Ostatniej Operacji Kwartał], YEAR(ostatnia) [Data Ostatniej Operacji Rok], &#xD;
&#xD;
&#xD;
CASE WHEN g.id IS NULL THEN ''Nie'' ELSE ''Tak'' END [Kontrahent ze Sprzedażą/Zakupem],&#xD;
CASE Knt_Nieaktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Kontrahent Aktywny],&#xD;
DB_NAME()+''_''+convert(Varchar(10),knt_PodmiotTyp)+''_''+convert(Varchar(10),Knt_KntId)  [Liczba Kontrahentów]&#xD;
'&#xD;
&#xD;
set @select2 = &#xD;
'&#xD;
&#xD;
from cdn.kontrahenci&#xD;
&#xD;
Left join&#xD;
(&#xD;
Select distinct &#xD;
TrN_PodID [id],&#xD;
MIN(TrN_DataOpe) [pierwsza],&#xD;
MAX(TrN_DataOpe) [ostatnia]&#xD;
from&#xD;
cdn.tranag&#xD;
GROUP BY TrN_PodID) g ON g.id = Knt_KntId&#xD;
'&#xD;
&#xD;
print (@select + @select2)&#xD;
exec (@select + @select2)&#xD;
&#xD;
 &#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QLNy8SvsWvjndP4rYWmIrmw65/eZ7QPiim3cKUThrJOp91uo2s2QytZVCI0ahIBHPzdhq77ZDLGS8LuZiEj0zYsIgS5K2HrbyaqCJT/6WDiznZVF9elSOhzVl2dH/e0c9PnG3YSMpcSF3Y8x5vWCkpLScwlLQEW3Qqe7R0u8VkZs9N9mOdplX8Q/6cokntZkj4+ymM9XCT/A==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Dzień" caption="Data Pierwszej Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Tydzień Roku" caption="Data Pierwszej Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Miesiąc" caption="Data Pierwszej Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Kwartał" caption="Data Pierwszej Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Rok" caption="Data Pierwszej Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Dzień" caption="Data Ostatniej Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Tydzień Roku" caption="Data Ostatniej Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Miesiąc" caption="Data Ostatniej Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Kwartał" caption="Data Ostatniej Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Rok" caption="Data Ostatniej Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent ze Sprzedażą/Zakupem" caption="Kontrahent ze Sprzedażą/Zakupem" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAAAAAAAAAAAP////8BAAAABwIZW0JhemEgRmlybW93YV0uW0NETl9TUFMyXQAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Baza Firmowa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent ze Sprzedażą/Zakupem"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Aktywny"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Liczba Kontrahentów"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Liczba Kontrahentów" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Baza Firmowa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Nazwa" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded&gt;&lt;value uniqueName="!NIEOKREŚLONY!" /&gt;&lt;/excluded&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent ze Sprzedażą/Zakupem" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Kontrahent Aktywny" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje wszystkich kontrahentów w bazie firmowej oraz ich liczbę. Umożliwia zafiltrowanie danych tylko do kontrahentów, dla których nie odnotowano jeszcze operacji sprzedaży lub zakupu.</a:description><a:id>76</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.40 Kontrahenci w bazie firmowej</a:mainLinkName><a:modifiedOn>2019-04-11T14:37:43.2</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>29</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2018-10-09T12:40:36.797</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Kontrahentów&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
&#xD;
&#xD;
DECLARE @select VARCHAR(MAX);&#xD;
DECLARE @select2 VARCHAR(MAX);&#xD;
&#xD;
&#xD;
&#xD;
set @select = &#xD;
'&#xD;
SELECT&#xD;
DB_NAME() [Baza Firmowa],&#xD;
knt_nazwa1 [Kontrahent Nazwa], &#xD;
&#xD;
20201 [Kontrahent Nazwa __PROCID__], Knt_KntId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__],&#xD;
&#xD;
knt_kod [Kontrahent Kod],&#xD;
20201 [Kontrahent Kod __PROCID__Kontrahenci__], Knt_KntId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__],&#xD;
&#xD;
REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Pierwszej Operacji Dzień], &#xD;
(datepart(DY, datediff(d, 0, pierwsza) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, pierwsza)*/ [Data Pierwszej Operacji Tydzień Roku], &#xD;
MONTH(pierwsza) [Data Pierwszej Operacji Miesiąc], DATEPART(quarter, pierwsza) [Data Pierwszej Operacji Kwartał], YEAR(pierwsza) [Data Pierwszej Operacji Rok], &#xD;
&#xD;
REPLACE(CONVERT(VARCHAR(10), ostatnia, 111), ''/'', ''-'') [Data Ostatniej Operacji Dzień], &#xD;
(datepart(DY, datediff(d, 0, ostatnia) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Ostatniej Operacji Tydzień Roku], &#xD;
MONTH(ostatnia) [Data Ostatniej Operacji Miesiąc], DATEPART(quarter, ostatnia) [Data Ostatniej Operacji Kwartał], YEAR(ostatnia) [Data Ostatniej Operacji Rok], &#xD;
&#xD;
reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
	(CASE Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
	(CASE Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
	(CASE Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
	(CASE Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
	(CASE Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
&#xD;
CASE WHEN g.id IS NULL THEN ''Nie'' ELSE ''Tak'' END [Kontrahent ze Sprzedażą/Zakupem],&#xD;
CASE Knt_Nieaktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Kontrahent Aktywny],&#xD;
DB_NAME()+''_''+convert(Varchar(10),knt_PodmiotTyp)+''_''+convert(Varchar(10),Knt_KntId)  [Liczba Kontrahentów]&#xD;
'&#xD;
&#xD;
set @select2 = &#xD;
'&#xD;
&#xD;
from cdn.kontrahenci&#xD;
&#xD;
Left join&#xD;
(&#xD;
Select distinct &#xD;
TrN_PodID [id],&#xD;
MIN(TrN_DataOpe) [pierwsza],&#xD;
MAX(TrN_DataOpe) [ostatnia]&#xD;
from&#xD;
cdn.tranag&#xD;
GROUP BY TrN_PodID) g ON g.id = Knt_KntId&#xD;
'&#xD;
&#xD;
print (@select + @select2)&#xD;
exec (@select + @select2)&#xD;
&#xD;
 &#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>gQWkd6czm+6zNoCYrM4dsA==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Dzień" caption="Data Pierwszej Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Tydzień Roku" caption="Data Pierwszej Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Miesiąc" caption="Data Pierwszej Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Kwartał" caption="Data Pierwszej Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Rok" caption="Data Pierwszej Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Dzień" caption="Data Ostatniej Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Tydzień Roku" caption="Data Ostatniej Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Miesiąc" caption="Data Ostatniej Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Kwartał" caption="Data Ostatniej Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Rok" caption="Data Ostatniej Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent ze Sprzedażą/Zakupem" caption="Kontrahent ze Sprzedażą/Zakupem" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAAAAAAAAAAAP////8MAAAABwImW0RhdGEgUGllcndzemVqIE9wZXJhY2ppIE1pZXNpxIVjXS5bMV0HAiZbRGF0YSBQaWVyd3N6ZWogT3BlcmFjamkgTWllc2nEhWNdLlsyXQcCJltEYXRhIFBpZXJ3c3plaiBPcGVyYWNqaSBNaWVzacSFY10uWzNdBwImW0RhdGEgUGllcndzemVqIE9wZXJhY2ppIE1pZXNpxIVjXS5bNF0HAiZbRGF0YSBQaWVyd3N6ZWogT3BlcmFjamkgTWllc2nEhWNdLls1XQcCJltEYXRhIFBpZXJ3c3plaiBPcGVyYWNqaSBNaWVzacSFY10uWzZdBwImW0RhdGEgUGllcndzemVqIE9wZXJhY2ppIE1pZXNpxIVjXS5bN10HAiZbRGF0YSBQaWVyd3N6ZWogT3BlcmFjamkgTWllc2nEhWNdLls4XQcCJltEYXRhIFBpZXJ3c3plaiBPcGVyYWNqaSBNaWVzacSFY10uWzldBwInW0RhdGEgUGllcndzemVqIE9wZXJhY2ppIE1pZXNpxIVjXS5bMTBdBwInW0RhdGEgUGllcndzemVqIE9wZXJhY2ppIE1pZXNpxIVjXS5bMTFdBwInW0RhdGEgUGllcndzemVqIE9wZXJhY2ppIE1pZXNpxIVjXS5bMTJdAAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Pierwszej Operacji Dzień"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Pierwszej Operacji Miesiąc"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Pierwszej Operacji Rok"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent ze Sprzedażą/Zakupem"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Aktywny"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Liczba Kontrahentów"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Liczba Kontrahentów" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded&gt;&lt;value uniqueName="!NIEOKREŚLONY!" /&gt;&lt;/excluded&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Data Pierwszej Operacji Dzień" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Data Pierwszej Operacji Miesiąc" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Data Pierwszej Operacji Rok" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Kontrahent ze Sprzedażą/Zakupem" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;included&gt;&lt;value uniqueName="Tak" /&gt;&lt;/included&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Kontrahent Aktywny" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport przedstawia kontrahentów wraz z datą pierwszej operacji sprzedaży w podziale na miesiące.</a:description><a:id>77</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.41 Nowi kontrahenci w miesiącu</a:mainLinkName><a:modifiedOn>2019-05-14T13:37:42.423</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>29</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2019-05-08T15:42:23.843</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Faktury pro forma &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun], &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj], &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],  &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod],&#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] &#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu = 320&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmppozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QLNy8SvsWvjndP4rYWmIrmw65/eZ7QPiim3cKUThrJOp91uo2s2QytZVCI0ahIBHPzdhq77ZDLGUiitSfcKm3Ekit3K1tJrHEOUzyDdGANbwJ01xHN31jIkIKK2tnJrrAP28/YieGJfe/OoKqvIKRJL6MDHcW3mKuEMYI6BrIH/wQEhYLXRYCFzjmpkMplPW/5KOi0zJ5mJg==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DAWKA SZKODLIWA /MG/" caption="Produkt Atrybut DAWKA SZKODLIWA /MG/" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROŚLINA ŚWIATŁOLUBNA" caption="Produkt Atrybut ROŚLINA ŚWIATŁOLUBNA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut WYSOKOŚĆ" caption="Produkt Atrybut WYSOKOŚĆ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut REZLIZACJA" caption="Produkt Atrybut REZLIZACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DAWKA SZKODLIWA /MG/" caption="Pozycja Atrybut DAWKA SZKODLIWA /MG/" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROŚLINA ŚWIATŁOLUBNA" caption="Pozycja Atrybut ROŚLINA ŚWIATŁOLUBNA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut WYSOKOŚĆ" caption="Pozycja Atrybut WYSOKOŚĆ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut REZLIZACJA" caption="Pozycja Atrybut REZLIZACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut BUYERITEMCODE" caption="Pozycja Atrybut BUYERITEMCODE" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////woAAAAHAh1bRG9rdW1lbnQgTnVtZXJdLltGUEYvMS8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZQRi8xLzIwMTFdBwIdW0Rva3VtZW50IE51bWVyXS5bRlBGLzEvMjAxMl0HAh1bRG9rdW1lbnQgTnVtZXJdLltGUEYvMi8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZQRi8yLzIwMTFdBwIdW0Rva3VtZW50IE51bWVyXS5bRlBGLzIvMjAxMl0HAh1bRG9rdW1lbnQgTnVtZXJdLltGUEYvMy8yMDA4XQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZQRi8zLzIwMTJdBwIdW0Rva3VtZW50IE51bWVyXS5bRlBGLzQvMjAwOF0HAh1bRG9rdW1lbnQgTnVtZXJdLltGUEYvNC8yMDEyXQ==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Miesiąc"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Data Operacji Miesiąc" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Data Operacji Rok" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport przedstawia dane sprzedażowe w oparciu o faktury Pro Forma.</a:description><a:id>78</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.42 Faktury pro forma</a:mainLinkName><a:modifiedOn>2025-05-22T18:32:19.457</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2021-04-22T14:38:11.98</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zamienniki produktów&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
set @select = '&#xD;
SELECT&#xD;
BAZ.Baz_Nazwa [Baza Firmowa]&#xD;
,tow.twr_kod [Produkt Kod]&#xD;
,tow.twr_nazwa [Produkt Nazwa]&#xD;
,CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep]&#xD;
,CASE tow.Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny]&#xD;
,zam.twr_twrid [Liczba Zamienników]&#xD;
,isnull(zam.twr_kod,''(BRAK)'') [Zamiennik Kod]&#xD;
,isnull(zam.twr_nazwa,''(BRAK)'') [Zamiennik Nazwa]&#xD;
&#xD;
----------KONTEKSTY&#xD;
,25003 [Produkt Nazwa __PROCID__], tow.Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
,25003 [Produkt Kod __PROCID__Towary__], tow.Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
'&#xD;
+ @kolumny + @atrybutyTwr&#xD;
&#xD;
&#xD;
set @select2 = &#xD;
' from cdn.Towary tow&#xD;
left join cdn.zamienniki on zam_twrid = twr_twrid&#xD;
left join cdn.towary zam on ZAM_ZamTwrId = zam.twr_twrid&#xD;
LEFT JOIN #tmpTwrGr Poz ON tow.Twr_TwGGIDNumer = Poz.gidNumer&#xD;
LEFT JOIN #tmpTwrAtr TwrAtr ON tow.Twr_TwrId  = TwrAtr.TwA_TwrId&#xD;
LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = tow.Twr_TwrId&#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
'&#xD;
print(@select + @select2)&#xD;
exec(@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5vCxSmgondMfdtmo6sliIgTWPbj17BviVUXyPzdkotJkq7igEVPx67QBSiMcx5zyeTJgrs/t+z/BIjq9oHQl3dL1vDiIZ84Ys7b36fBxBgdA</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Zamienników" caption="Liczba Zamienników" type="measure" formatString="n0" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Zamiennik Kod" caption="Zamiennik Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Zamiennik Nazwa" caption="Zamiennik Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wcAAAAHAh5bUHJvZHVrdCBLb2RdLltHUkFCSUVfTEnFmkNJRV0HAhpbUHJvZHVrdCBLb2RdLltHUkFCSUVfT0dSXQcCHVtQcm9kdWt0IEtvZF0uW0lHTEFLSV9DWVBSWVNdBwIgW1Byb2R1a3QgS29kXS5bSUdMQUtJX0pBxYFPV0lFQ10HAhxbUHJvZHVrdCBLb2RdLltQScWBQV9FTEVLVFJdBwIfW1Byb2R1a3QgS29kXS5bUEnFgUFfU1BBTElOT1dBXQcCF1tQcm9kdWt0IEtvZF0uW1RVSkVfM0xd</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Baza Firmowa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Aktywny"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Liczba Zamienników"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="n0" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Zamiennik Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Liczba Zamienników" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Zamiennik Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Baza Firmowa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Aktywny" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę towarów posiadających zmienniki wraz z informacją na temat zamienników.</a:description><a:id>79</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.43 Zamienniki produktów</a:mainLinkName><a:modifiedOn>2024-09-06T09:30:25.823</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2021-04-26T13:07:55.21</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g (&#xD;
    gid&#xD;
    ,gidTyp&#xD;
    ,kod&#xD;
    ,gidNumer&#xD;
    ,grONumer&#xD;
    ,poziom&#xD;
    ,sciezka&#xD;
    )&#xD;
AS (&#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,0 AS poziom&#xD;
        ,convert(NVARCHAR(1024), '') AS sciezka&#xD;
    FROM CDN.TwrGrupy&#xD;
    WHERE TwG_TwGID = 0&#xD;
    &#xD;
    UNION ALL&#xD;
    &#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,p.poziom + 1 AS poziom&#xD;
        ,convert(NVARCHAR(1024), p.sciezka + N'\' + c.TwG_Kod) AS sciezka&#xD;
    FROM g p&#xD;
    JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer&#xD;
    WHERE c.TwG_TwGID &lt;&gt; 0&#xD;
        AND c.TwG_GIDTyp = - 16&#xD;
    )&#xD;
SELECT *&#xD;
INTO #tmpTwrGr&#xD;
FROM g&#xD;
&#xD;
DECLARE @poziom INT&#xD;
DECLARE @poziom_max INT&#xD;
DECLARE @sql NVARCHAR(max)&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom)&#xD;
FROM #tmpTwrGr&#xD;
&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0&#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50), ONr' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50)'&#xD;
&#xD;
    EXEC (@sql)&#xD;
&#xD;
    IF @poziom = @poziom_max&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS NVARCHAR) + '= grONumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS NVARCHAR) + ' = kod'&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
    ELSE&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
DECLARE @select VARCHAR(max)&#xD;
DECLARE @select2 VARCHAR(max)&#xD;
DECLARE @select3 VARCHAR(max)&#xD;
DECLARE @kolumny VARCHAR(max)&#xD;
DECLARE @i INT&#xD;
&#xD;
SET @kolumny = ''&#xD;
SET @i = 0&#xD;
&#xD;
WHILE (@i &lt;= @poziom_max)&#xD;
BEGIN&#xD;
    SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' + LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    SET @i = @i + 1&#xD;
END&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id INT&#xD;
    ,@atrybut_kod NVARCHAR(50)&#xD;
    ,@atrybut_typ INT&#xD;
    ,@atrybut_format INT&#xD;
    ,@atrybuty VARCHAR(max)&#xD;
    ,@sqlA NVARCHAR(max);&#xD;
DECLARE @wersja FLOAT;&#xD;
&#xD;
SET @wersja = (&#xD;
        SELECT CONVERT(FLOAT, SYS_Wartosc)&#xD;
        FROM CDN.SystemCDN&#xD;
        WHERE SYS_ID = 3&#xD;
        )&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId&#xD;
    ,KnA_PodmiotTyp&#xD;
INTO #tmpKonAtr&#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId&#xD;
INTO #tmpDokAtr&#xD;
FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr VARCHAR(max)&#xD;
    ,@atrybutyTwr2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId&#xD;
INTO #tmpTwrAtr&#xD;
FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz VARCHAR(max)&#xD;
    ,@atrybutyPoz2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId&#xD;
INTO #tmpPozAtr&#xD;
FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID&#xD;
    ,CASE &#xD;
        WHEN DDf_Numeracja LIKE '@rejestr%'&#xD;
            THEN 5&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 1) = '@rejestr'&#xD;
            THEN 1&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 2) = '@rejestr'&#xD;
            THEN 2&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 3) = '@rejestr'&#xD;
            THEN 3&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 4) = '@rejestr'&#xD;
            THEN 4&#xD;
        END [seria]&#xD;
INTO #tmpSeria&#xD;
FROM CDN.DokDefinicje&#xD;
&#xD;
SELECT *  INTO #tmpKosztyGraniczne FROM (&#xD;
SELECT SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TNFS.TrN_TrNID TransId&#xD;
FROM cdn.tranag TNKG&#xD;
JOIN cdn.traelem TEKG ON TEKG.tre_trnid = TNKG.TrN_TrNID&#xD;
JOIN cdn.Tranag TNFZ ON TNFZ.Trn_trnid = TNKG.TrN_ZwrId&#xD;
JOIN cdn.TranagRelacje ON TNFZ.Trn_trnid = TrR_TrNId&#xD;
    AND TrR_FaTyp IN (&#xD;
        302&#xD;
        ,305&#xD;
        )&#xD;
JOIN cdn.Tranag TNFS ON TNFS.TrN_TrNID = TrR_FaId&#xD;
JOIN cdn.TraElem TEFS ON TNFS.trn_trnid = TEFS.TrE_TrNId&#xD;
    AND TEKG.TrE_Lp = TEFS.TrE_LpPow&#xD;
WHERE TNKG.trn_rodzaj IN (&#xD;
        301008&#xD;
        ,301009&#xD;
        ,301018&#xD;
        )&#xD;
GROUP BY TEFS.TrE_TrEID&#xD;
    ,TNFS.TrN_TrNID&#xD;
&#xD;
	UNION ALL&#xD;
	&#xD;
	 SELECT  SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TEFS.TrE_TrNId TransId&#xD;
    FROM CDN.TraElem TEFS&#xD;
    JOIN CDN.tranagrelacje tr on tr.TrR_TrNID = TEFS.TrE_TrNID&#xD;
    JOIN CDN.traelem TEWZ on tr.TrR_FaId = TEWZ.TrE_TrNID AND TEFS.TrE_Lppow = TEWZ.TrE_LpPow&#xD;
    JOIN CDN.TraSElemDost TraSElemDost on TEWZ.TrE_TrEID = TsD_TrEID&#xD;
	JOIN  CDN.TraSElem ON TsD_TrSIdDost = trs_trsid&#xD;
	JOIN CDN.TraElem TEPZ on TrS_TrEId = TEPZ.TrE_TrEID&#xD;
	JOIN CDN.TraNag  TNPZ on TEPZ.TrE_TrNId = TrN_TrNID&#xD;
	JOIN CDN.TraNagRelacje TRFZ ON TRFZ.TrR_TrNId = TNPZ.TRN_TRNID &#xD;
	JOIN CDN.TraNag  TNFZ ON TNFZ.TrN_TrNID = TRFZ.TrR_FaId&#xD;
	JOIN CDN.TraNag  TNKG ON TNFZ.TrN_TrNID = TNKG.TrN_ZwrId AND TNKG.TrN_Rodzaj = 301009 -- Korekty Graniczne&#xD;
	join CDN.TraElem TEKG ON TEKG.TrE_TrNId = TNKG.TrN_TrNID AND TEKG.TrE_Lp = TEPZ.TrE_LpPow&#xD;
	GROUP BY TEFS.TrE_TrNId,TEFS.TrE_TrEID&#xD;
&#xD;
	)X&#xD;
&#xD;
&#xD;
--Tworzenie tabelki pomocniczej do liczenia marży&#xD;
SELECT TRE.TrE_TrEId treid, TRERel.TrE_TreId trerelid, TRERel.TrE_TypDokumentu trereltyp INTO #tmpMarza&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       LEFT JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId&#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @select = &#xD;
    'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    Tre_Lp [Produkt Lp.],&#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/ISNULL(NULLIF([TrE_JMPrzelicznikL],0),1)*[TrE_JMPrzelicznikM])) * TrE_KursL / ISNULL(NULLIF(TrE_KursM,0),1) [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
	&#xD;
    ,CAST(TR.TrE_Ilosc/ ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS DECIMAL(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) [Waluta Koszt Zakupu]&#xD;
    ,ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1),TR.TrE_KosztUslugi)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],''' + &#xD;
    @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
SET @select2 = &#xD;
    ' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND trn.TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + &#xD;
    ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
   LEFT OUTER JOIN (&#xD;
    SELECT ISNULL(SUM(CASE &#xD;
                    WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
        ,TRE.TrE_TrEID&#xD;
        ,TREWAL.TRE_Waluta&#xD;
        ,TREWAL.TrE_KursL KursZakL&#xD;
        ,TREWAL.Tre_KursM KursZakM&#xD;
    FROM CDN.TraElem TRE&#xD;
    JOIN (&#xD;
        SELECT TrE_TrEId AS IdElem&#xD;
            ,TrE_TrEId AS IdZwiaz&#xD;
        FROM CDN.TraElem&#xD;
        &#xD;
        UNION ALL&#xD;
        &#xD;
        SELECT treid, trerelid &#xD;
		FROM #tmpMarza&#xD;
        WHERE trereltyp NOT IN (&#xD;
                318&#xD;
                ,309&#xD;
                ,308&#xD;
                ,301&#xD;
                )&#xD;
				AND  trerelid is not null&#xD;
        ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
    JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
    JOIN CDN.TraElem TREWAL ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
    GROUP BY TRE.TrE_TrEID,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    ) KosztWyliczony ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN #tmpKosztyGraniczne ON ElemId = TR.Tre_Treid&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy],&#xD;
    NULL [Produkt Lp.],&#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], TrN_WartoscZakupu [Koszt Zakupu], TrN_RazemNetto - TrN_WartoscZakupu [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,NULL [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,KosztWyliczony.TRE_Waluta [Waluta Koszt Zakupu]&#xD;
    ,(CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0)) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + &#xD;
    ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
SET @select3 = &#xD;
    ' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     lEFT JOIN (SELECT  sum(KosztyGraniczne) AS KosztyGraniczne, TransID FROM #tmpKosztyGraniczne GROUP BY TransId)KosztyGran ON Trn_Trnid = TransID &#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
	  LEFT OUTER JOIN (&#xD;
    SELECT ISNULL(SUM(CASE &#xD;
                    WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
        ,TRE.TrE_TrNId&#xD;
        ,TREWAL.TRE_Waluta&#xD;
        ,TREWAL.TrE_KursL KursZakL&#xD;
        ,TREWAL.Tre_KursM KursZakM&#xD;
    FROM CDN.TraElem TRE&#xD;
    JOIN (&#xD;
        SELECT TrE_TrEId AS IdElem&#xD;
            ,TrE_TrEId AS IdZwiaz&#xD;
        FROM CDN.TraElem&#xD;
        &#xD;
        UNION ALL&#xD;
           &#xD;
        SELECT treid, trerelid &#xD;
		FROM #tmpMarza&#xD;
        WHERE trereltyp NOT IN (&#xD;
                318&#xD;
                ,309&#xD;
                ,308&#xD;
                ,301&#xD;
                )&#xD;
				AND  trerelid is not null&#xD;
        ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
    JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
    JOIN CDN.TraElem TREWAL ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
    GROUP BY TRE.TrE_TrNId,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
   ) KosztWyliczony ON KosztWyliczony.TrE_TrNId = Trn_trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
&#xD;
'&#xD;
&#xD;
PRINT (@select + @select2 + @select3)&#xD;
&#xD;
EXEC (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
DROP TABLE #tmpKonAtr&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
DROP TABLE #tmpSeria&#xD;
&#xD;
DROP TABLE #tmppozatr&#xD;
&#xD;
DROP TABLE #tmpKosztyGraniczne&#xD;
&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QHRUwalZ8pMVJl4bnvAvbQJZcV6Wn+9eyurT5z7pvsx453uBpU8ZVZBU3sxojq0nr7SEb6pIcBltbZneCkQXihh2PJK4OnljQYqeZz6oFgeKpqUN1a0P8/X1EVgEjUyAynh2e+VUqmLaTxvo2adC1y/WjNl2Vo5HaL2i46mtibOu7HvVCLZ13K</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Waluta Koszt Zakupu" caption="Waluta Koszt Zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Waluta" caption="Koszt Zakupu Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Dzień" caption="Data Analizy Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Tydzień Roku" caption="Data Analizy Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Miesiąc" caption="Data Analizy Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Kwartał" caption="Data Analizy Kwartał" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Rok" caption="Data Analizy Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut TEST" caption="Kontrahent Pierwotny Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut TEST" caption="Kontrahent Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut TEST" caption="Odbiorca Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOLOR" caption="Dokument Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut CENA ATRYB" caption="Dokument Atrybut CENA ATRYB" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROWIZJA" caption="Dokument Atrybut PROWIZJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut MONTER KOSZT (K)" caption="Dokument Atrybut MONTER KOSZT (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut CENA2" caption="Produkt Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TESTZAS" caption="Produkt Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DIETA" caption="Produkt Atrybut DIETA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut CENA2" caption="Pozycja Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut TESTZAS" caption="Pozycja Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAsAAAAOAAAABwIWW0tvbnRyYWhlbnQgS29kXS5bQURNXQcCGltLb250cmFoZW50IEtvZF0uW0FMX0tPTVBdBwIYW0tvbnRyYWhlbnQgS29kXS5bQUxPWkFdBwIcW0tvbnRyYWhlbnQgS29kXS5bQklVUk9XSUVDXQcCFltLb250cmFoZW50IEtvZF0uW0NQTl0HAh5bS29udHJhaGVudCBLb2RdLltFTEVLVFJPV05JQV0HAhlbS29udHJhaGVudCBLb2RdLltLT0xBU0FdBwIbW0tvbnRyYWhlbnQgS29kXS5bS09XQUxTS0ldBwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSSVpBXQcCHFtLb250cmFoZW50IEtvZF0uW01BUlNaQUxJS10HAhtbS29udHJhaGVudCBLb2RdLltTT0ZUTEFORF0HAhhbS29udHJhaGVudCBLb2RdLltTVElMTF0HAhhbS29udHJhaGVudCBLb2RdLltURVJSQV0HAh5bS29udHJhaGVudCBLb2RdLltUV8OTSk9HUsOTRF0AAAAAAAAAAAAAAAAAAAAA/////wAAAAB0AAAABwIWW0tvbnRyYWhlbnQgS29kXS5bQURNXQcCGltQcm9kdWt0IEtvZF0uW0dSQUJJRV9PR1JdBwIWW0tvbnRyYWhlbnQgS29kXS5bQURNXQcCHVtQcm9kdWt0IEtvZF0uW0lHTEFLSV9DWVBSWVNdBwIWW0tvbnRyYWhlbnQgS29kXS5bQURNXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIWW0tvbnRyYWhlbnQgS29kXS5bQURNXQcCGVtQcm9kdWt0IEtvZF0uW0pBQsWBT05JRV0HAhZbS29udHJhaGVudCBLb2RdLltBRE1dBwIYW1Byb2R1a3QgS29kXS5bS09SQV9TODBdBwIWW0tvbnRyYWhlbnQgS29kXS5bQURNXQcCGVtQcm9kdWt0IEtvZF0uW1LDk8W7QV9QTl0HAhpbS29udHJhaGVudCBLb2RdLltBTF9LT01QXQcCHltQcm9kdWt0IEtvZF0uW0dSQUJJRV9MScWaQ0lFXQcCGFtLb250cmFoZW50IEtvZF0uW0FMT1pBXQcCHltQcm9kdWt0IEtvZF0uW0dSQUJJRV9MScWaQ0lFXQcCGFtLb250cmFoZW50IEtvZF0uW0FMT1pBXQcCHVtQcm9kdWt0IEtvZF0uW0lHTEFLSV9DWVBSWVNdBwIYW0tvbnRyYWhlbnQgS29kXS5bQUxPWkFdBwIgW1Byb2R1a3QgS29kXS5bSUdMQUtJX0pBxYFPV0lFQ10HAhhbS29udHJhaGVudCBLb2RdLltBTE9aQV0HAhlbUHJvZHVrdCBLb2RdLltKQULFgU9OSUVdBwIYW0tvbnRyYWhlbnQgS29kXS5bQUxPWkFdBwIbW1Byb2R1a3QgS29kXS5bTk/Fu1lDRV9FTC5dBwIYW0tvbnRyYWhlbnQgS29kXS5bQUxPWkFdBwIcW1Byb2R1a3QgS29kXS5bUElFTMSYR05BQ0pBXQcCGFtLb250cmFoZW50IEtvZF0uW0FMT1pBXQcCHFtQcm9kdWt0IEtvZF0uW1BJxYFBX0VMRUtUUl0HAhhbS29udHJhaGVudCBLb2RdLltBTE9aQV0HAh9bUHJvZHVrdCBLb2RdLltQScWBQV9TUEFMSU5PV0FdBwIYW0tvbnRyYWhlbnQgS29kXS5bQUxPWkFdBwIaW1Byb2R1a3QgS29kXS5bUFJPSl9BUkNISV0HAhhbS29udHJhaGVudCBLb2RdLltBTE9aQV0HAhxbUHJvZHVrdCBLb2RdLltQUk9KX1pJRUxFTkldBwIYW0tvbnRyYWhlbnQgS29kXS5bQUxPWkFdBwIcW1Byb2R1a3QgS29kXS5bUk9aRFJBQk5JQUNaXQcCGFtLb250cmFoZW50IEtvZF0uW0FMT1pBXQcCGVtQcm9kdWt0IEtvZF0uW1LDk8W7QV9QTl0HAhhbS29udHJhaGVudCBLb2RdLltBTE9aQV0HAhdbUHJvZHVrdCBLb2RdLltTRUtBVE9SXQcCGFtLb250cmFoZW50IEtvZF0uW0FMT1pBXQcCFltQcm9kdWt0IEtvZF0uW1NUT0pBS10HAhhbS29udHJhaGVudCBLb2RdLltBTE9aQV0HAhdbUHJvZHVrdCBLb2RdLltTWlBBREVMXQcCGFtLb250cmFoZW50IEtvZF0uW0FMT1pBXQcCF1tQcm9kdWt0IEtvZF0uW1RVSkVfM0xdBwIcW0tvbnRyYWhlbnQgS29kXS5bQklVUk9XSUVDXQcCHVtQcm9kdWt0IEtvZF0uW0lHTEFLSV9DWVBSWVNdBwIcW0tvbnRyYWhlbnQgS29kXS5bQklVUk9XSUVDXQcCGVtQcm9kdWt0IEtvZF0uW0pBQsWBT05JRV0HAhxbS29udHJhaGVudCBLb2RdLltCSVVST1dJRUNdBwIYW1Byb2R1a3QgS29kXS5bS09SQV9TODBdBwIWW0tvbnRyYWhlbnQgS29kXS5bQ1BOXQcCGVtQcm9kdWt0IEtvZF0uW0pBQsWBT05JRV0HAhZbS29udHJhaGVudCBLb2RdLltDUE5dBwIYW1Byb2R1a3QgS29kXS5bS09SQV9TODBdBwIeW0tvbnRyYWhlbnQgS29kXS5bRUxFS1RST1dOSUFdBwIgW1Byb2R1a3QgS29kXS5bSUdMQUtJX0pBxYFPV0lFQ10HAhlbS29udHJhaGVudCBLb2RdLltLT0xBU0FdBwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIZW0tvbnRyYWhlbnQgS29kXS5bS09MQVNBXQcCGltQcm9kdWt0IEtvZF0uW0dSQUJJRV9PR1JdBwIZW0tvbnRyYWhlbnQgS29kXS5bS09MQVNBXQcCHVtQcm9kdWt0IEtvZF0uW0lHTEFLSV9DWVBSWVNdBwIZW0tvbnRyYWhlbnQgS29kXS5bS09MQVNBXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIZW0tvbnRyYWhlbnQgS29kXS5bS09MQVNBXQcCGVtQcm9kdWt0IEtvZF0uW0pBQsWBT05JRV0HAhlbS29udHJhaGVudCBLb2RdLltLT0xBU0FdBwIYW1Byb2R1a3QgS29kXS5bS09SQV9TODBdBwIZW0tvbnRyYWhlbnQgS29kXS5bS09MQVNBXQcCIltQcm9kdWt0IEtvZF0uW8WBQcWDQ1VDSCBETyBQScWBWV0HAhlbS29udHJhaGVudCBLb2RdLltLT0xBU0FdBwIbW1Byb2R1a3QgS29kXS5bTk/Fu1lDRV9FTC5dBwIZW0tvbnRyYWhlbnQgS29kXS5bS09MQVNBXQcCHFtQcm9kdWt0IEtvZF0uW1BJxYFBX0VMRUtUUl0HAhlbS29udHJhaGVudCBLb2RdLltLT0xBU0FdBwIfW1Byb2R1a3QgS29kXS5bUEnFgUFfU1BBTElOT1dBXQcCGVtLb250cmFoZW50IEtvZF0uW0tPTEFTQV0HAhdbUHJvZHVrdCBLb2RdLltTRUtBVE9SXQcCGVtLb250cmFoZW50IEtvZF0uW0tPTEFTQV0HAhZbUHJvZHVrdCBLb2RdLltTVE9KQUtdBwIZW0tvbnRyYWhlbnQgS29kXS5bS09MQVNBXQcCF1tQcm9kdWt0IEtvZF0uW1NaUEFERUxdBwIbW0tvbnRyYWhlbnQgS29kXS5bS09XQUxTS0ldBwIWW1Byb2R1a3QgS29kXS5bU1RPSkFLXQcCG1tLb250cmFoZW50IEtvZF0uW0tPV0FMU0tJXQcCF1tQcm9kdWt0IEtvZF0uW1NaUEFERUxdBwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSSVpBXQcCHltQcm9kdWt0IEtvZF0uW0dSQUJJRV9MScWaQ0lFXQcCGVtLb250cmFoZW50IEtvZF0uW01BUklaQV0HAhpbUHJvZHVrdCBLb2RdLltHUkFCSUVfT0dSXQcCGVtLb250cmFoZW50IEtvZF0uW01BUklaQV0HAh1bUHJvZHVrdCBLb2RdLltJR0xBS0lfQ1lQUllTXQcCGVtLb250cmFoZW50IEtvZF0uW01BUklaQV0HAiBbUHJvZHVrdCBLb2RdLltJR0xBS0lfSkHFgU9XSUVDXQcCGVtLb250cmFoZW50IEtvZF0uW01BUklaQV0HAhlbUHJvZHVrdCBLb2RdLltKQULFgU9OSUVdBwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSSVpBXQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCGVtLb250cmFoZW50IEtvZF0uW01BUklaQV0HAhtbUHJvZHVrdCBLb2RdLltOT8W7WUNFX0VMLl0HAhlbS29udHJhaGVudCBLb2RdLltNQVJJWkFdBwIaW1Byb2R1a3QgS29kXS5bT0RLX0xJxZpDSV0HAhlbS29udHJhaGVudCBLb2RdLltNQVJJWkFdBwIcW1Byb2R1a3QgS29kXS5bUEnFgUFfRUxFS1RSXQcCGVtLb250cmFoZW50IEtvZF0uW01BUklaQV0HAh9bUHJvZHVrdCBLb2RdLltQScWBQV9TUEFMSU5PV0FdBwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSSVpBXQcCHFtQcm9kdWt0IEtvZF0uW1JPWkRSQUJOSUFDWl0HAhlbS29udHJhaGVudCBLb2RdLltNQVJJWkFdBwIXW1Byb2R1a3QgS29kXS5bU0VLQVRPUl0HAhlbS29udHJhaGVudCBLb2RdLltNQVJJWkFdBwIXW1Byb2R1a3QgS29kXS5bU1pQQURFTF0HAhlbS29udHJhaGVudCBLb2RdLltNQVJJWkFdBwIXW1Byb2R1a3QgS29kXS5bVFVKRV8zTF0HAhlbS29udHJhaGVudCBLb2RdLltNQVJJWkFdBwIYW1Byb2R1a3QgS29kXS5bWklFTUlBXzVdBwIcW0tvbnRyYWhlbnQgS29kXS5bTUFSU1pBTElLXQcCGVtQcm9kdWt0IEtvZF0uW0pBQsWBT05JRV0HAhxbS29udHJhaGVudCBLb2RdLltNQVJTWkFMSUtdBwIiW1Byb2R1a3QgS29kXS5bxYFBxYNDVUNIIERPIFBJxYFZXQcCHFtLb250cmFoZW50IEtvZF0uW01BUlNaQUxJS10HAhtbUHJvZHVrdCBLb2RdLltOT8W7WUNFX0VMLl0HAhxbS29udHJhaGVudCBLb2RdLltNQVJTWkFMSUtdBwIcW1Byb2R1a3QgS29kXS5bUEnFgUFfRUxFS1RSXQcCHFtLb250cmFoZW50IEtvZF0uW01BUlNaQUxJS10HAh9bUHJvZHVrdCBLb2RdLltQScWBQV9TUEFMSU5PV0FdBwIbW0tvbnRyYWhlbnQgS29kXS5bU09GVExBTkRdBwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIbW0tvbnRyYWhlbnQgS29kXS5bU09GVExBTkRdBwIaW1Byb2R1a3QgS29kXS5bR1JBQklFX09HUl0HAhtbS29udHJhaGVudCBLb2RdLltTT0ZUTEFORF0HAhxbUHJvZHVrdCBLb2RdLltQSUVMxJhHTkFDSkFdBwIbW0tvbnRyYWhlbnQgS29kXS5bU09GVExBTkRdBwIfW1Byb2R1a3QgS29kXS5bUEnFgUFfU1BBTElOT1dBXQcCG1tLb250cmFoZW50IEtvZF0uW1NPRlRMQU5EXQcCHFtQcm9kdWt0IEtvZF0uW1BST0pfWklFTEVOSV0HAhtbS29udHJhaGVudCBLb2RdLltTT0ZUTEFORF0HAhxbUHJvZHVrdCBLb2RdLltST1pEUkFCTklBQ1pdBwIbW0tvbnRyYWhlbnQgS29kXS5bU09GVExBTkRdBwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCG1tLb250cmFoZW50IEtvZF0uW1NPRlRMQU5EXQcCF1tQcm9kdWt0IEtvZF0uW1NFS0FUT1JdBwIbW0tvbnRyYWhlbnQgS29kXS5bU09GVExBTkRdBwIWW1Byb2R1a3QgS29kXS5bU1RPSkFLXQcCG1tLb250cmFoZW50IEtvZF0uW1NPRlRMQU5EXQcCF1tQcm9kdWt0IEtvZF0uW1NaUEFERUxdBwIbW0tvbnRyYWhlbnQgS29kXS5bU09GVExBTkRdBwIXW1Byb2R1a3QgS29kXS5bVFVKRV8zTF0HAhtbS29udHJhaGVudCBLb2RdLltTT0ZUTEFORF0HAhhbUHJvZHVrdCBLb2RdLltaSUVNSUFfNV0HAhhbS29udHJhaGVudCBLb2RdLltTVElMTF0HAhlbUHJvZHVrdCBLb2RdLltKQULFgU9OSUVdBwIYW0tvbnRyYWhlbnQgS29kXS5bU1RJTExdBwIYW1Byb2R1a3QgS29kXS5bS09SQV9TODBdBwIYW0tvbnRyYWhlbnQgS29kXS5bU1RJTExdBwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCGFtLb250cmFoZW50IEtvZF0uW1NUSUxMXQcCF1tQcm9kdWt0IEtvZF0uW1NFS0FUT1JdBwIYW0tvbnRyYWhlbnQgS29kXS5bVEVSUkFdBwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIYW0tvbnRyYWhlbnQgS29kXS5bVEVSUkFdBwIaW1Byb2R1a3QgS29kXS5bR1JBQklFX09HUl0HAhhbS29udHJhaGVudCBLb2RdLltURVJSQV0HAh1bUHJvZHVrdCBLb2RdLltJR0xBS0lfQ1lQUllTXQcCGFtLb250cmFoZW50IEtvZF0uW1RFUlJBXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIYW0tvbnRyYWhlbnQgS29kXS5bVEVSUkFdBwIZW1Byb2R1a3QgS29kXS5bSkFCxYFPTklFXQcCGFtLb250cmFoZW50IEtvZF0uW1RFUlJBXQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCGFtLb250cmFoZW50IEtvZF0uW1RFUlJBXQcCG1tQcm9kdWt0IEtvZF0uW05PxbtZQ0VfRUwuXQcCGFtLb250cmFoZW50IEtvZF0uW1RFUlJBXQcCGltQcm9kdWt0IEtvZF0uW09ES19MScWaQ0ldBwIYW0tvbnRyYWhlbnQgS29kXS5bVEVSUkFdBwIcW1Byb2R1a3QgS29kXS5bUEnFgUFfRUxFS1RSXQcCGFtLb250cmFoZW50IEtvZF0uW1RFUlJBXQcCH1tQcm9kdWt0IEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0HAhhbS29udHJhaGVudCBLb2RdLltURVJSQV0HAhxbUHJvZHVrdCBLb2RdLltST1pEUkFCTklBQ1pdBwIYW0tvbnRyYWhlbnQgS29kXS5bVEVSUkFdBwIXW1Byb2R1a3QgS29kXS5bU0VLQVRPUl0HAhhbS29udHJhaGVudCBLb2RdLltURVJSQV0HAhZbUHJvZHVrdCBLb2RdLltTVE9KQUtdBwIYW0tvbnRyYWhlbnQgS29kXS5bVEVSUkFdBwIXW1Byb2R1a3QgS29kXS5bU1pQQURFTF0HAhhbS29udHJhaGVudCBLb2RdLltURVJSQV0HAhdbUHJvZHVrdCBLb2RdLltUVUpFXzNMXQcCGFtLb250cmFoZW50IEtvZF0uW1RFUlJBXQcCIVtQcm9kdWt0IEtvZF0uW1VTxYFVR0EgU0VSV0lTT1dBXQcCGFtLb250cmFoZW50IEtvZF0uW1RFUlJBXQcCGFtQcm9kdWt0IEtvZF0uW1pJRU1JQV81XQcCHltLb250cmFoZW50IEtvZF0uW1RXw5NKT0dSw5NEXQcCHltQcm9kdWt0IEtvZF0uW0dSQUJJRV9MScWaQ0lFXQcCHltLb250cmFoZW50IEtvZF0uW1RXw5NKT0dSw5NEXQcCGltQcm9kdWt0IEtvZF0uW0dSQUJJRV9PR1JdBwIeW0tvbnRyYWhlbnQgS29kXS5bVFfDk0pPR1LDk0RdBwIdW1Byb2R1a3QgS29kXS5bSUdMQUtJX0NZUFJZU10HAh5bS29udHJhaGVudCBLb2RdLltUV8OTSk9HUsOTRF0HAiBbUHJvZHVrdCBLb2RdLltJR0xBS0lfSkHFgU9XSUVDXQcCHltLb250cmFoZW50IEtvZF0uW1RXw5NKT0dSw5NEXQcCGVtQcm9kdWt0IEtvZF0uW0pBQsWBT05JRV0HAh5bS29udHJhaGVudCBLb2RdLltUV8OTSk9HUsOTRF0HAhhbUHJvZHVrdCBLb2RdLltLT1JBX1M4MF0HAh5bS29udHJhaGVudCBLb2RdLltUV8OTSk9HUsOTRF0HAiJbUHJvZHVrdCBLb2RdLlvFgUHFg0NVQ0ggRE8gUEnFgVldBwIeW0tvbnRyYWhlbnQgS29kXS5bVFfDk0pPR1LDk0RdBwIbW1Byb2R1a3QgS29kXS5bTk/Fu1lDRV9FTC5dBwIeW0tvbnRyYWhlbnQgS29kXS5bVFfDk0pPR1LDk0RdBwIaW1Byb2R1a3QgS29kXS5bT0RLX0xJxZpDSV0HAh5bS29udHJhaGVudCBLb2RdLltUV8OTSk9HUsOTRF0HAhxbUHJvZHVrdCBLb2RdLltQSUVMxJhHTkFDSkFdBwIeW0tvbnRyYWhlbnQgS29kXS5bVFfDk0pPR1LDk0RdBwIcW1Byb2R1a3QgS29kXS5bUEnFgUFfRUxFS1RSXQcCHltLb250cmFoZW50IEtvZF0uW1RXw5NKT0dSw5NEXQcCH1tQcm9kdWt0IEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0HAh5bS29udHJhaGVudCBLb2RdLltUV8OTSk9HUsOTRF0HAhxbUHJvZHVrdCBLb2RdLltST1pEUkFCTklBQ1pdBwIeW0tvbnRyYWhlbnQgS29kXS5bVFfDk0pPR1LDk0RdBwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCHltLb250cmFoZW50IEtvZF0uW1RXw5NKT0dSw5NEXQcCF1tQcm9kdWt0IEtvZF0uW1NFS0FUT1JdBwIeW0tvbnRyYWhlbnQgS29kXS5bVFfDk0pPR1LDk0RdBwIWW1Byb2R1a3QgS29kXS5bU1RPSkFLXQcCHltLb250cmFoZW50IEtvZF0uW1RXw5NKT0dSw5NEXQcCF1tQcm9kdWt0IEtvZF0uW1NaUEFERUxdBwIeW0tvbnRyYWhlbnQgS29kXS5bVFfDk0pPR1LDk0RdBwIXW1Byb2R1a3QgS29kXS5bVFVKRV8zTF0HAh5bS29udHJhaGVudCBLb2RdLltUV8OTSk9HUsOTRF0HAhhbUHJvZHVrdCBLb2RdLltaSUVNSUFfNV0AAAAAAAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" formula="( Sprzedaż Wartość= 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Sprzedaż Wartość)" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Wystawienia Dzień"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Wystawienia Miesiąc"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Wystawienia Kwartał"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Wystawienia Rok"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Cena początkowa"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Cena transakcyjna"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Cena początkowa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Cena transakcyjna" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Data Wystawienia Dzień" index="5" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Data Wystawienia Miesiąc" index="4" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Data Wystawienia Kwartał" index="3" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Data Wystawienia Rok" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent Nazwa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje średnią cenę produktów (z dokumentów handlowych) dla kontrahentów.&#xD;
Cena początkowa - cena początkowa produktu.&#xD;
Cena transakcyjna - cena z uwzględnieniem rabatów.</a:description><a:id>80</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.44 Średnie ceny dla kontrahentów</a:mainLinkName><a:modifiedOn>2025-04-14T09:53:54.617</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>2</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2021-04-28T07:11:42.423</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Stałych Cen&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
--Stała cena:&#xD;
--11- wszyscy kontrahenci&#xD;
--12 - grupa kontrahentów&#xD;
--13 - jeden kontrahent &#xD;
--Rabat stała cena&#xD;
--Właściwe zapytanie&#xD;
--rabat na pojedynczego kontrahenta&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
ISNULL(NULLIF(rabaty.Rab_Waluta, ''''),@Wal) [Waluta],&#xD;
CASE Rab_TypCenyNB  WHEN&#xD;
1 THEN '' Netto''&#xD;
ELSE ''Brutto'' END AS [Typ Ceny],&#xD;
Rab_Cena AS [Cena],&#xD;
podm.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    podm.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(podm.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(podm.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(podm.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(podm.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(podm.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CONVERT(VARCHAR,ISNULL(rabaty.Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE WHEN ISNULL(Twr_ESklep,0)=1 THEN ''Tak'' ELSE ''Nie'' END [Produkt e-Sklep],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy],  &#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), rabaty.Rab_DataOd, 111), ''/'', ''-'') [Data Rabat Od Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, rabaty.Rab_DataOd) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Rabat Od Tydzień Roku]&#xD;
	,MONTH(rabaty.Rab_DataOd) [Data Rabat Od Miesiąc], DATEPART(quarter, rabaty.Rab_DataOd) [Data Rabat Od Kwartał], YEAR(rabaty.Rab_DataOd) [Data Rabat Od Rok]&#xD;
&#xD;
	,REPLACE(CONVERT(VARCHAR(10), 	rabaty.Rab_DataDo, 111), ''/'', ''-'') [Data Rabat Do Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, 	rabaty.Rab_DataDo) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Rabat Do Tydzień Roku]&#xD;
	,MONTH(rabaty.Rab_DataDo) [Data Rabat Do Miesiąc], DATEPART(quarter, 	rabaty.Rab_DataDo) [Data Rabat Do Kwartał], YEAR(	rabaty.Rab_DataDo) [Data Rabat Do Rok]&#xD;
    ----------KONTEKSTY&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], podm.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], podm.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty  + @atrybutyTwr + '&#xD;
FROM CDN.Rabaty rabaty&#xD;
LEFT JOIN CDN.Grupy ON Gru_GruId = Rab_PodmiotId&#xD;
          AND Gru_Typ = 31 AND Rab_PodmiotTyp IS NULL&#xD;
LEFT JOIN CDN.PodmiotyView  podm ON &#xD;
        Pod_PodmiotTyp = Rab_PodmiotTyp &#xD;
          AND Pod_PodId = Rab_PodmiotId &#xD;
LEFT JOIN CDN.PodmiotyView  podm2 ON &#xD;
        podm2.Pod_Grupa = Grupy.Gru_Nazwa&#xD;
LEFT JOIN CDN.Towary ON Twr_TwrId=rabaty.Rab_TwrId&#xD;
LEFT OUTER JOIN CDN.Kontrahenci knt3 ON podm.Pod_PodID=knt3.Knt_KntId AND podm.Pod_PodmiotTyp = 1&#xD;
LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
LEFT JOIN #tmpKonAtr KonAtr1 ON podm.Pod_PodId = KonAtr1.KnA_PodmiotId AND podm.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpTwrAtr TwrAtr ON rabaty.Rab_TwrId  = TwrAtr.TwA_TwrId &#xD;
LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE RAB_Typ = 13'&#xD;
set @select2 = &#xD;
'UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
ISNULL(NULLIF(rabaty.Rab_Waluta, ''''),@Wal) [Waluta],&#xD;
CASE rabaty.Rab_TypCenyNB  WHEN&#xD;
1 THEN '' Netto''&#xD;
ELSE ''Brutto'' END AS [Typ Ceny],&#xD;
rabaty.Rab_Cena AS [Cena],&#xD;
podm.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    podm.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(podm.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(podm.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(podm.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(podm.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(podm.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CONVERT(VARCHAR,ISNULL(rabaty.Rab_Rabat,0))+''%'' [Kontrahent Rabat],   &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE WHEN ISNULL(Twr_ESklep,0)=1 THEN ''Tak'' ELSE ''Nie'' END [Produkt e-Sklep],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy],  &#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), rabaty.Rab_DataOd, 111), ''/'', ''-'') [Data Rabat Od Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, rabaty.Rab_DataOd) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Rabat Od Tydzień Roku]&#xD;
	,MONTH(rabaty.Rab_DataOd) [Data Rabat Od Miesiąc], DATEPART(quarter, rabaty.Rab_DataOd) [Data Rabat Od Kwartał], YEAR(rabaty.Rab_DataOd) [Data Rabat Od Rok]&#xD;
&#xD;
	,REPLACE(CONVERT(VARCHAR(10), 	rabaty.Rab_DataDo, 111), ''/'', ''-'') [Data Rabat Do Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, 	rabaty.Rab_DataDo) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Rabat Do Tydzień Roku]&#xD;
	,MONTH(rabaty.Rab_DataDo) [Data Rabat Do Miesiąc], DATEPART(quarter, 	rabaty.Rab_DataDo) [Data Rabat Do Kwartał], YEAR(	rabaty.Rab_DataDo) [Data Rabat Do Rok]&#xD;
    ----------KONTEKSTY&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], podm.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], podm.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty  + @atrybutyTwr + '&#xD;
FROM CDN.Rabaty rabaty&#xD;
LEFT JOIN CDN.Grupy ON Gru_GruId = Rab_PodmiotId&#xD;
          AND Gru_Typ = 31 AND Rab_PodmiotTyp IS NULL&#xD;
LEFT JOIN CDN.PodmiotyView  podm ON &#xD;
        podm.Pod_Grupa = Grupy.Gru_Nazwa&#xD;
--bierzemy rabat grupowy tylko wtedy gdy dla tego kontrahenta nie ma rabatów indywidualnych&#xD;
LEFT JOIN CDN.Rabaty rabatyInd ON Pod_PodmiotTyp = rabatyInd.Rab_PodmiotTyp &#xD;
          AND Pod_PodId = rabatyInd.Rab_PodmiotId &#xD;
          AND rabaty.Rab_TwrId = rabatyInd.Rab_TwrId&#xD;
AND rabatyInd.RAB_Typ = 13 &#xD;
&#xD;
LEFT JOIN CDN.Towary ON Twr_TwrId=rabaty.Rab_TwrId&#xD;
LEFT OUTER JOIN CDN.Kontrahenci knt3 ON podm.Pod_PodID=knt3.Knt_KntId AND podm.Pod_PodmiotTyp = 1&#xD;
LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
LEFT JOIN #tmpKonAtr KonAtr1 ON podm.Pod_PodId = KonAtr1.KnA_PodmiotId AND podm.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpTwrAtr TwrAtr ON rabaty.Rab_TwrId  = TwrAtr.TwA_TwrId &#xD;
LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE rabaty.RAB_Typ = 12  AND rabatyInd.Rab_RabId IS NULL'&#xD;
&#xD;
set @select3 = &#xD;
' UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
ISNULL(NULLIF(rabaty.Rab_Waluta, ''''),@Wal) [Waluta],&#xD;
CASE rabaty.Rab_TypCenyNB  WHEN&#xD;
1 THEN '' Netto''&#xD;
ELSE ''Brutto'' END AS [Typ Ceny],&#xD;
rabaty.Rab_Cena AS [Cena],&#xD;
podm.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    podm.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(podm.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(podm.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(podm.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(podm.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(podm.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CONVERT(VARCHAR,ISNULL(rabaty.Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE WHEN ISNULL(Twr_ESklep,0)=1 THEN ''Tak'' ELSE ''Nie'' END [Produkt e-Sklep],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy],  &#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ]&#xD;
&#xD;
	,REPLACE(CONVERT(VARCHAR(10), rabaty.Rab_DataOd, 111), ''/'', ''-'') [Data Rabat Od Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, rabaty.Rab_DataOd) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Rabat Od Tydzień Roku]&#xD;
	,MONTH(rabaty.Rab_DataOd) [Data Rabat Od Miesiąc], DATEPART(quarter, rabaty.Rab_DataOd) [Data Rabat Od Kwartał], YEAR(rabaty.Rab_DataOd) [Data Rabat Od Rok]&#xD;
&#xD;
	,REPLACE(CONVERT(VARCHAR(10), 	rabaty.Rab_DataDo, 111), ''/'', ''-'') [Data Rabat Do Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, 	rabaty.Rab_DataDo) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Rabat Do Tydzień Roku]&#xD;
	,MONTH(rabaty.Rab_DataDo) [Data Rabat Do Miesiąc], DATEPART(quarter, 	rabaty.Rab_DataDo) [Data Rabat Do Kwartał], YEAR(	rabaty.Rab_DataDo) [Data Rabat Do Rok]&#xD;
&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], podm.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], podm.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty  + @atrybutyTwr + '&#xD;
FROM CDN.Rabaty rabaty&#xD;
LEFT JOIN CDN.PodmiotyView  podm ON podm.Pod_PodmiotTyp = 1&#xD;
LEFT JOIN CDN.Grupy ON Gru_Nazwa = Pod_Grupa&#xD;
LEFT JOIN CDN.Rabaty rabatyGr ON&#xD;
&#xD;
 Gru_GruId = rabatyGr.Rab_PodmiotId&#xD;
          AND Gru_Typ = 31 AND rabatyGr.Rab_PodmiotTyp IS NULL&#xD;
           AND rabatyGR.Rab_TwrId = rabaty.Rab_TwrId&#xD;
          AND rabatyGr.Rab_Typ = 12&#xD;
--podm ON &#xD;
    --  podm.Pod_Grupa = Grupy.Gru_Nazwa&#xD;
--bierzemy rabat grupowy tylko wtedy gdy dla tego kontrahenta nie ma rabatów indywidualnych&#xD;
LEFT JOIN CDN.Rabaty rabatyInd ON Pod_PodmiotTyp = rabatyInd.Rab_PodmiotTyp &#xD;
          AND Pod_PodId = rabatyInd.Rab_PodmiotId &#xD;
          AND rabaty.Rab_TwrId = rabatyInd.Rab_TwrId&#xD;
AND rabatyInd.RAB_Typ = 13 &#xD;
LEFT JOIN CDN.Towary ON Twr_TwrId=rabaty.Rab_TwrId&#xD;
LEFT OUTER JOIN CDN.Kontrahenci knt3 ON podm.Pod_PodID=knt3.Knt_KntId AND podm.Pod_PodmiotTyp = 1&#xD;
LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
LEFT JOIN #tmpKonAtr KonAtr1 ON podm.Pod_PodId = KonAtr1.KnA_PodmiotId AND podm.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpTwrAtr TwrAtr ON rabaty.Rab_TwrId  = TwrAtr.TwA_TwrId &#xD;
LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE rabaty.RAB_Typ = 11  AND rabatyInd.Rab_RabId IS NULL&#xD;
AND rabatyGr.Rab_RabId IS NULL'&#xD;
--print @select&#xD;
--print @select2&#xD;
--print @select3&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QHRUwalZ8pMVJl4bnvAvbQJZcV6Wn+9eyurT5z7pvsx453uBpU8ZVZBU3sxojq0nr7SEb6pIcBltbZneCkQXihh2PJK4OnljQYqeZz6oFgeKpqUN1a0P8/X1EVgEjUyAynh2e+VUqmLaTxvo2adC1y/WjNl2Vo5HaL2i46mtibOu7HvVCLZ13K</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Typ Ceny" caption="Typ Ceny" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Cena" caption="Cena" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="n2" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAbAAAABwIiW0tvbnRyYWhlbnQgS29kXS5bIU5JRU9LUkXFmkxPTlkhXQcCFltLb250cmFoZW50IEtvZF0uW0FETV0HAhpbS29udHJhaGVudCBLb2RdLltBTF9LT01QXQcCIltLb250cmFoZW50IEtvZF0uW0FMX0tPTVBfR0xJV0lDRV0HAhhbS29udHJhaGVudCBLb2RdLltBTE9aQV0HAhlbS29udHJhaGVudCBLb2RdLltCSUdHVU5dBwIcW0tvbnRyYWhlbnQgS29kXS5bQklVUk9XSUVDXQcCJFtLb250cmFoZW50IEtvZF0uW0JJVVJPV0lFQ19TS0FXSU5BXQcCJltLb250cmFoZW50IEtvZF0uW0JJVVJPV0lFQ19XSUVMSUNaS0FdBwIYW0tvbnRyYWhlbnQgS29kXS5bQkxFSU1dBwIWW0tvbnRyYWhlbnQgS29kXS5bQ1BOXQcCHltLb250cmFoZW50IEtvZF0uW0VMRUtUUk9XTklBXQcCGVtLb250cmFoZW50IEtvZF0uW0tPTEFTQV0HAhtbS29udHJhaGVudCBLb2RdLltLT01PUk4vMV0HAhtbS29udHJhaGVudCBLb2RdLltLT1dBTFNLSV0HAhZbS29udHJhaGVudCBLb2RdLltMQVNdBwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSSVpBXQcCGVtLb250cmFoZW50IEtvZF0uW01BUktVU10HAhpbS29udHJhaGVudCBLb2RdLltNQVJLVVMyXQcCHFtLb250cmFoZW50IEtvZF0uW01BUlNaQUxJS10HAhlbS29udHJhaGVudCBLb2RdLltQVUNVxZpdBwIWW0tvbnRyYWhlbnQgS29kXS5bUFpVXQcCG1tLb250cmFoZW50IEtvZF0uW1NPRlRMQU5EXQcCGFtLb250cmFoZW50IEtvZF0uW1NUSUxMXQcCGFtLb250cmFoZW50IEtvZF0uW1RFUlJBXQcCF1tLb250cmFoZW50IEtvZF0uW1RQU0FdBwIeW0tvbnRyYWhlbnQgS29kXS5bVFfDk0pPR1LDk0Rd/////wAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="False" fieldListExpanded="False" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Typ Ceny"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Cena"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" grandTotal="False" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 4"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Cena" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Typ Ceny" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields&gt;&lt;filter fieldName="Produkt Grupa Poziom 4" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport pokazuje stałe ceny dla kontrahentów.</a:description><a:id>81</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.45 Stałe ceny dla kontrahentów</a:mainLinkName><a:modifiedOn>2025-05-30T16:13:09.62</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2021-04-28T16:04:22.427</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Deklaracji Intrastat &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
        SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
       &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT &#xD;
BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
IsN_Rok [Deklaracja Rok],&#xD;
IsN_Miesiac [Deklaracja Miesiąc],&#xD;
ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta],&#xD;
CONVERT(VARCHAR(10), IsN_DataWypelnienia, 20) [Deklaracja Data Wypełnienia],&#xD;
CASE IsN_Typ WHEN 1 THEN ''Przywóz'' WHEN 2 THEN ''Wywóz'' END [Deklaracja Typ],&#xD;
CASE IsN_Czesciowa WHEN 0 THEN ''Całościowa miesięczna'' WHEN 1 THEN ''Częściowa'' END [Deklaracja Rodzaj],&#xD;
IsE_RodzajTransakcji [Kod Transakcji],&#xD;
IsE_CN [Produkt Kod CN],&#xD;
TrN_NumerPelny [Powiązany Dokument],&#xD;
Twr_Nazwa [Produkt Nazwa],&#xD;
Twr_Kod [Produkt Kod],&#xD;
ISNULL(CAST(IsE_MasaNetto AS VARCHAR(20)),''(BRAK)'') [Produkt Masa],&#xD;
IsE_Netto [Wartość Netto],&#xD;
ISNULL(IsN_PodNazwa1,''(NIEPRZYPISANY)'') [Dostawca Nazwa],&#xD;
ISNULL(IsN_PodKraj,''(NIEPRZYPISANY)'') [Dostawca Kraj],&#xD;
ISNULL(IsN_PodNipE,''(NIEPRZYPISANY)'') [Dostawca NIP],&#xD;
ISNULL(Knt_Nazwa1,''(NIEPRZYPISANY)'') [Kontrahent Nazwa],&#xD;
ISNULL(Knt_Kod,''(NIEPRZYPISANY)'') [Kontrahent Kod],&#xD;
ISNULL(Knt_Kraj,''(NIEPRZYPISANY)'') [Kontrahent Kraj],&#xD;
ISNULL(Knt_NipKraj + Knt_Nip,''(NIEPRZYPISANY)'') [Kontrahent NIP],&#xD;
ISNULL(IsN_WypNazwisko + '' '' + IsN_WypImie,''(NIEPRZYPISANY)'') [Wypełniający Nazwa],&#xD;
IsE_IsEId [Deklaracja Liczba Pozycji],&#xD;
ISNULL(CONVERT(VARCHAR(11), IsN_EDekl_DataWyslania, 20),''Nie wysłano'') [e-Deklaracja Data Wysłania]&#xD;
&#xD;
----------KONTEKSTY&#xD;
&#xD;
,20201 [Kontrahent Nazwa __PROCID__], Knt_KntId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
,20201 [Kontrahent Kod __PROCID__Kontrahenci__], Knt_KntId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
,25003 [Produkt Nazwa __PROCID__], Twr_TwrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
,25003 [Produkt Kod __PROCID__], Twr_TwrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
'&#xD;
+ @kolumny + @atrybuty + @atrybutyTwr &#xD;
       &#xD;
set @select2 = &#xD;
'&#xD;
FROM CDN.IntrastatNag&#xD;
LEFT JOIN CDN.IntrastatElem ON IsE_IsNId = IsN_IsNId &#xD;
LEFT JOIN CDN.TraNag ON TrN_IsNId = IsN_IsNId&#xD;
LEFT JOIN CDn.TraElem ON TrE_TrNId = TrN_TrNID &#xD;
LEFT JOIN CDN.Kontrahenci ON Knt_KntId = TrN_PodID AND Knt_PodmiotTyp = TrN_PodmiotTyp&#xD;
LEFT JOIN CDN.Towary ON Twr_TwrId = TrE_TwrId &#xD;
LEFT JOIN CDN.KodyCN ON Twr_KCNId = KCN_KCNId &#xD;
  LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
  LEFT JOIN #tmpKonAtr KonAtr1 ON Knt_KntId = KonAtr1.KnA_PodmiotId AND Knt_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
  LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
  LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5vCxSmgondMfdtmo6sliIgTWPbj17BviVUXyPzdkotJkq7igEVPx67QBSiMcx5zyeTJgrs/t+z/BIjq9oHQl3dL1vDiIZ84Ys7b36fBxBgdA</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Deklaracja Rok" caption="Deklaracja Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Deklaracja Miesiąc" caption="Deklaracja Miesiąc" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Deklaracja Data Wypełnienia" caption="Deklaracja Data Wypełnienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Deklaracja Typ" caption="Deklaracja Typ" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Deklaracja Rodzaj" caption="Deklaracja Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kod Transakcji" caption="Kod Transakcji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Powiązany Dokument" caption="Powiązany Dokument" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Masa" caption="Produkt Masa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wartość Netto" caption="Wartość Netto" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dostawca Nazwa" caption="Dostawca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dostawca Kraj" caption="Dostawca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dostawca NIP" caption="Dostawca NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Wypełniający Nazwa" caption="Wypełniający Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Deklaracja Liczba Pozycji" caption="Deklaracja Liczba Pozycji" type="measure" formatString="n0" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="e-Deklaracja Data Wysłania" caption="e-Deklaracja Data Wysłania" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAA0AAAABAAAABwIXW0Rla2xhcmFjamEgUm9rXS5bMjAyMV0BAAAABwIXW0Rla2xhcmFjamEgUm9rXS5bMjAyMV0HAhlbRGVrbGFyYWNqYSBNaWVzacSFY10uWzRdAQAAAAcCF1tEZWtsYXJhY2phIFJva10uWzIwMjFdBwIZW0Rla2xhcmFjamEgTWllc2nEhWNdLls0XQcCIltQb3dpxIV6YW55IERva3VtZW50XS5bRkEvMzMvMjAyMV0BAAAABwIXW0Rla2xhcmFjamEgUm9rXS5bMjAyMV0HAhlbRGVrbGFyYWNqYSBNaWVzacSFY10uWzRdBwIiW1Bvd2nEhXphbnkgRG9rdW1lbnRdLltGQS8zMy8yMDIxXQcCGFtLb250cmFoZW50IEtvZF0uW0JMRUlNXQEAAAAHAhdbRGVrbGFyYWNqYSBSb2tdLlsyMDIxXQcCGVtEZWtsYXJhY2phIE1pZXNpxIVjXS5bNF0HAiJbUG93acSFemFueSBEb2t1bWVudF0uW0ZBLzMzLzIwMjFdBwIYW0tvbnRyYWhlbnQgS29kXS5bQkxFSU1dBwIdW0tvbnRyYWhlbnQgTklQXS5bREUyNjc1NDI5NV0BAAAABwIXW0Rla2xhcmFjamEgUm9rXS5bMjAyMV0HAhlbRGVrbGFyYWNqYSBNaWVzacSFY10uWzRdBwIiW1Bvd2nEhXphbnkgRG9rdW1lbnRdLltGQS8zMy8yMDIxXQcCGFtLb250cmFoZW50IEtvZF0uW0JMRUlNXQcCHVtLb250cmFoZW50IE5JUF0uW0RFMjY3NTQyOTVdBwIdW1Byb2R1a3QgS29kXS5bSUdMQUtJX0NZUFJZU13/////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Baza Firmowa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Deklaracja Rok"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Deklaracja Miesiąc"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Deklaracja Typ"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Deklaracja Rodzaj"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod CN"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Powiązany Dokument"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Wartość Netto"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent NIP"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Deklaracja Liczba Pozycji"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="n0" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Wartość Netto" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Deklaracja Liczba Pozycji" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Deklaracja Rok" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int16"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Deklaracja Miesiąc" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Byte"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod CN" index="6" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Powiązany Dokument" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="5" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Kod" index="3" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent NIP" index="4" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Baza Firmowa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Deklaracja Typ" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Deklaracja Rodzaj" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę deklaracji Intrastat wraz z informacjami o dokumentach źródłowych, produktach i kontrahentach. Raport oparty jest na tabelach CDN.IntrastatNag, CDN.IntrastatElem, CDN.Tranag oraz CDN.TraElem.</a:description><a:id>82</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.46 Deklaracje Intrastat</a:mainLinkName><a:modifiedOn>2024-09-06T09:39:59.86</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-31T17:19:31.19</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @OPERATOR1 NVARCHAR(30);&#xD;
SET @OPERATOR1 = '''' + @OPERATOR + '''';&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
declare @op varchar(30);&#xD;
set @op = ' + @Operator1 + ';&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień], &#xD;
    (datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku], &#xD;
    MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok], &#xD;
&#xD;
        REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień], &#xD;
    (datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku], &#xD;
    MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok], &#xD;
&#xD;
    REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień], &#xD;
    (datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku], &#xD;
    MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok], &#xD;
&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0 - ([TrE_CenaW]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0 AS [Cena początkowa]&#xD;
    ,TrE_CenaW AS [Cena transakcyjna]&#xD;
    ,CAST(TR.TrE_Ilosc/(Twr_JMPrzelicznikL*Twr_JMPrzelicznikM) AS Decimal(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
AND opk3.Ope_Kod = @Op&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień], &#xD;
    (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku], &#xD;
    MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok], &#xD;
&#xD;
    REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień], &#xD;
    (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku], &#xD;
    MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok], &#xD;
&#xD;
    REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień], &#xD;
    (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku], &#xD;
    MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok], &#xD;
&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	  LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND opk3.Ope_Kod = @Op&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmppozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5vCxSmgondMfdtmo6sliIgTWPbj17BviVUXyPzdkotJkq7igEVPx67QBSiMcx5zyeTJgrs/t+z/BIjq9oHQl3dL1vDiIZ84Ys7b36fBxBgdA</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Towar EAN" caption="Towar EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Towar Kod Dostawcy" caption="Towar Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;OPERATOR&lt;/Name&gt;&#xD;
    &lt;Label&gt;Operator&lt;/Label&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Operator&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Operator&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;admin&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAABAAAABwIcW0tvbnRyYWhlbnQgT3BpZWt1bl0uW0FETUlOXf////8AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" formula="( Sprzedaż Wartość= 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Sprzedaż Wartość)" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="122" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Opiekun"&gt;&lt;header fontName="Tahoma" fontSize="8" width="130" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Odbiorca Opiekun"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="136" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="136" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="1" expanded="True" sortMode="default" order="ascending" width="122" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Opiekun" index="0" expanded="True" sortMode="default" order="ascending" width="130" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields&gt;&lt;filter fieldName="Odbiorca Opiekun" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje sprzedaż kontrahentów dla opiekuna - operatora aktualnie zalogowanego do Analiz BI.</a:description><a:id>83</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.47 Sprzedaż dla opiekuna kontrahenta</a:mainLinkName><a:modifiedOn>2025-05-26T02:21:18.1</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context><a:Context><a:id>9</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2021-05-06T17:49:26.413</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Analiza RO z fakturami sprzedaży i paragonami&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
        SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
       &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
select SUM(TrN_TypDokumentu) Suma, TrN_TrNID PFP INTO #tmpProForma FROM(&#xD;
SELECT TN.TrN_TrNID,pow.TrN_TypDokumentu,COUNT(*) CNT FROM CDN.Tranag TN&#xD;
outer apply cdn.Powiazania(TN.TrN_TrNID,308) pow&#xD;
WHERE  TN.TrN_TypDokumentu = 308&#xD;
and pow.TrN_TypDokumentu IN (320,302,305)&#xD;
GROUP BY TN.TrN_TrNID ,pow.TrN_TypDokumentu )X group by TrN_TrNID&#xD;
HAVING SUM(TrN_TypDokumentu)  = 320&#xD;
&#xD;
&#xD;
DECLARE @ROTyp INT&#xD;
SET @ROTyp = 308&#xD;
&#xD;
SELECT Trn_TRNID roid &#xD;
INTO #ROID&#xD;
FROM CDN.TraNag where TrN_TypDokumentu = @ROTyp&#xD;
&#xD;
SELECT &#xD;
        roid,&#xD;
        TrN_TypDokumentu, &#xD;
        TrN_TrNId id&#xD;
INTO #Powiaz FROM #ROID&#xD;
CROSS APPLY CDN.Powiazania (roid,@ROTyp)&#xD;
&#xD;
SET @select = '&#xD;
&#xD;
DECLARE @ROK2 INT;&#xD;
SET @ROK2 = CAST(' + @ROK + ' AS INT);&#xD;
&#xD;
SELECT  &#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
TNRO.TrN_NumerPelny                                                                             AS [Rezerwacja Numer],&#xD;
ISNULL(TNPOW.TrN_NumerPelny,''(BRAK)'')                                                         AS [Dokument Sprzedaży Numer],&#xD;
Twr_Kod                                                                                         AS [Produkt Kod],&#xD;
Twr_Nazwa                                                                                       AS [Produkt Nazwa],&#xD;
ISNULL(DD.DDf_Symbol,''(BRAK)'')                                                                        AS [Dokument Sprzedaży Symbol],&#xD;
CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END   AS [Produkt PKWiU],&#xD;
CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END                                        AS [Produkt Aktywny],&#xD;
Twr_JM                                                                                          AS [Produkt Jednostka Miary], &#xD;
ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'')                                                        AS [Produkt Jednostka Miary Pomocnicza],&#xD;
CAST(Twr_Opis as VARCHAR(1024))                                                                 AS [Produkt Opis],&#xD;
Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'')                                    AS [Produkt Waga KG],&#xD;
    CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
END                                                                                             AS [Produkt Typ], &#xD;
TwC_Wartosc                                                                                     AS [Cena Domyślna], &#xD;
ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'')                                                            AS [Produkt Producent], &#xD;
ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'')                                                          AS [Produkt Marka],&#xD;
'&#xD;
+&#xD;
'&#xD;
CASE tnro.TrN_eSklepZrodlo&#xD;
WHEN 0 THEN ''e-Sklep''&#xD;
WHEN 2 THEN ''Facebook''&#xD;
WHEN 3 THEN ''Allegro''&#xD;
WHEN 4 THEN ''wszytsko.pl''&#xD;
WHEN 5 THEN ''Comarch e-Sklep RWD''&#xD;
WHEN 6 THEN ''API''&#xD;
WHEN 7 THEN ''system ERP''&#xD;
WHEN 8 THEN ''eBay''&#xD;
WHEN 9 THEN ''Ceneo''&#xD;
WHEN 10 THEN ''Comarch e-Sklep wersja mobilna''&#xD;
WHEN 13 THEN ''Amazon''&#xD;
ELSE ''(NIEPRZYPISANE)'' END                                                                    AS [Rezerwacja Źródło],&#xD;
CASE WHEN tnro.TrN_Anulowany = -2147483647 THEN ''Anulowany'' ELSE&#xD;
CASE WHEN PFP is not null then ''PF'' ELSE&#xD;
CASE tnro.TrN_ZwroconoCalaIlosc&#xD;
WHEN 1 THEN ''Pusty''&#xD;
WHEN 2 THEN ''W realizacji''&#xD;
WHEN 3 THEN ''Zrealizowano''&#xD;
WHEN 4 THEN ''Zamknięto''&#xD;
ELSE ''(BRAK)''&#xD;
END END END                                                                                             AS [Rezerwacja Status],                                                                 &#xD;
PodRO.pod_kod                                                                                           AS [Kontrahent Kod],&#xD;
PodRO.Pod_Nazwa1                                                                                        AS [Kontrahent Nazwa],&#xD;
CASE WHEN TNRO.TrN_ZwroconoCalaIlosc=3 or (TNRO.TrN_ZwroconoCalaIlosc=4 and dre.data is not null) THEN &#xD;
CASE WHEN TNPOW.TrN_DataDok&gt;TNRO.trn_datawys THEN datediff(dd,TNRO.trn_datawys,TNPOW.TrN_DataDok) ELSE 0 END&#xD;
ELSE&#xD;
CASE WHEN TNRO.trn_datawys&gt;getdate() THEN 0 ELSE datediff(dd,TNRO.trn_datawys,getdate()) end end        AS[Liczba dni opóźnienia],&#xD;
--Miary&#xD;
Powiaz.Ilosc                AS [Sprzedaż Ilość],&#xD;
Powiaz.Brutto               AS [Sprzedaż Wartość Brutto],&#xD;
Powiaz.Netto                AS [Sprzedaż Wartość Netto],&#xD;
Powiaz.IloscJM              AS [Sprzedaż Ilość Jednostka Miary],&#xD;
&#xD;
ro.Ilosc                    AS [Rezerwacja Ilość],&#xD;
ro.Brutto                   AS [Rezerwacja Wartość Brutto],&#xD;
ro.Netto                    AS [Rezerwacja Wartość Netto],&#xD;
ro.IloscJM                  AS [Rezerwacja Ilość Jednostka Miary],&#xD;
&#xD;
TNRO.TRN_NumerObcy			AS [Dokument Rezerwacja Numer Zamówienia]&#xD;
&#xD;
--Daty Point&#xD;
/*&#xD;
,REPLACE(CONVERT(VARCHAR(10), tnro.trn_datawys, 111), ''/'', ''-'') [Rezerwacja Termin] &#xD;
,REPLACE(CONVERT(VARCHAR(10), dre.data, 111), ''/'', ''-'') [Data Realizacji]&#xD;
,REPLACE(CONVERT(VARCHAR(10), tnpow.TrN_DataOpe, 111), ''/'', ''-'') [Data Sprzedaży]&#xD;
,REPLACE(CONVERT(VARCHAR(10), tnro.TrN_DataDok, 111), ''/'', ''-'') [Data Rezerwacji]&#xD;
*/&#xD;
'&#xD;
set @select2 = '&#xD;
,REPLACE(CONVERT(VARCHAR(10), tnro.trn_datawys, 111), ''/'', ''-'') [Rezerwacja Termin Dzień] &#xD;
,(datepart(DY, datediff(d, 0, tnro.trn_datawys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Rezerwacja Termin Tydzień Roku]&#xD;
,MONTH(tnro.trn_datawys) [Rezerwacja Termin Miesiąc]&#xD;
, DATEPART(quarter, tnro.trn_datawys) [Rezerwacja Termin Kwartał]&#xD;
, YEAR(tnro.trn_datawys) [Rezerwacja Termin Rok]&#xD;
&#xD;
,ISNULL(REPLACE(CONVERT(VARCHAR(10), tnpow.TrN_DataOpe, 111), ''/'', ''-''),''(BRAK)'') [Data Sprzedaży Dzień]&#xD;
,ISNULL(CAST((datepart(DY, datediff(d, 0, tnpow.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 AS VARCHAR),''(BRAK)'') [Data Sprzedaży Tydzień Roku]&#xD;
,ISNULL(CAST(MONTH(tnpow.TrN_DataOpe) AS VARCHAR(10)),''(BRAK)'') [Data Sprzedaży Miesiąc]&#xD;
,ISNULL(CAST(DATEPART(quarter, tnpow.TrN_DataOpe) AS VARCHAR(10)),''(BRAK)'') [Data Sprzedaży Kwartał]&#xD;
,ISNULL(CAST(YEAR(tnpow.TrN_DataOpe) AS VARCHAR(10)),''(BRAK)'') [Data Sprzedaży Rok]&#xD;
&#xD;
,ISNULL(REPLACE(CONVERT(VARCHAR(10), tnro.TrN_DataDok, 111), ''/'', ''-''),''(BRAK)'') [Data Rezerwacji Dzień]&#xD;
,ISNULL(CAST((datepart(DY, datediff(d, 0, tnro.TrN_DataDoK) / 7 * 7 + 3)+6) / 7 AS VARCHAR),''(BRAK)'') [Data Rezerwacji  Tydzień Roku]&#xD;
,ISNULL(CAST(MONTH(tnro.TrN_DataDok) AS VARCHAR(10)),''(BRAK)'') [Data Rezerwacji  Miesiąc]&#xD;
,ISNULL(CAST(DATEPART(quarter, tnro.TrN_DataDok) AS VARCHAR(10)),''(BRAK)'') [Data Rezerwacji  Kwartał]&#xD;
,ISNULL(CAST(YEAR(tnro.TrN_DataDok) AS VARCHAR(10)),''(BRAK)'') [Data Rezerwacji  Rok]&#xD;
&#xD;
,ISNULL(REPLACE(CONVERT(VARCHAR(10), dre.data, 111), ''/'', ''-''),''(BRAK)'') [Data Realizacji Dzień]&#xD;
,ISNULL(CAST((datepart(DY, datediff(d, 0, dre.data) / 7 * 7 + 3)+6) / 7 AS VARCHAR),''(BRAK)'')  [Data Realizacji Tydzień Roku]&#xD;
,ISNULL(CAST(MONTH(dre.data) AS VARCHAR(10)),''(BRAK)'')   [Data Realizacji Miesiąc]&#xD;
,ISNULL(CAST(DATEPART(quarter, dre.data) AS VARCHAR(10)),''(BRAK)'')   [Data Realizacji Kwartał]&#xD;
,ISNULL(CAST(YEAR(dre.data) AS VARCHAR(10)),''(BRAK)'')  [Data Realizacji Rok]&#xD;
&#xD;
--Konteksty&#xD;
&#xD;
,25039 [Rezerwacja Numer __PROCID__RO__], TNRO.TrN_TrNId [Rezerwacja Numer __ORGID__],'''+@bazaFirmowa+''' [Rezerwacja Numer __DATABASE__]&#xD;
,20201 [Kontrahent Nazwa __PROCID__], PodRO.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
,20201 [Kontrahent Kod __PROCID__Kontrahenci__], PodRO.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
,25003 [Produkt Nazwa __PROCID__], Twr_TwrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
,25003 [Produkt Kod __PROCID__], Twr_TwrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
'&#xD;
+ @kolumny + @atrybuty + @atrybutyTwr  + @atrybutyDok + '&#xD;
FROM &#xD;
CDN.Towary&#xD;
 JOIN &#xD;
--DOK RO&#xD;
(SELECT&#xD;
    SUM(tRE_ILOSC) Ilosc,&#xD;
    SUM(tRE_WARTOSCNETTO) Brutto,&#xD;
    SUM(TrE_WartoscNetto) Netto,&#xD;
    SUM(TrE_IloscJM) IloscJM,&#xD;
    TrE_TwrId TowID,&#xD;
    ROID&#xD;
FROM #ROID&#xD;
LEFT JOIN cdn.TraElem ON Roid = Tre_trnid&#xD;
GROUP BY ROID,TrE_TwrId&#xD;
)Ro ON Twr_TwrId = RO.TowID &#xD;
 LEFT JOIN &#xD;
--dok Powiaz&#xD;
(&#xD;
SELECT &#xD;
id TransID,&#xD;
TrE_TwrId TowID,&#xD;
roid,&#xD;
SUM(tRE_ILOSC) Ilosc,&#xD;
SUM(tRE_WARTOSCNETTO) Brutto,&#xD;
SUM(TrE_WartoscNetto) Netto,&#xD;
SUM(TrE_IloscJM) IloscJM &#xD;
FROM #Powiaz &#xD;
LEFT JOIN cdn.Traelem ON id = Tre_trnid&#xD;
GROUP BY roid,tre_twrid,id)Powiaz ON Powiaz.towid = twr_twrid and Powiaz.roid = Ro.ROID&#xD;
&#xD;
  LEFT JOIN CDN.TraNag TNPOW ON Powiaz.TransID = TNPOW.TrN_TrNID &#xD;
  LEFT JOIN CDN.TraNag TNRO ON ro.ROID = TNRO.TrN_TrNID &#xD;
  LEFT JOIN CDN.DokDefinicje DD ON TNPOW.TrN_DDfId = DD.DDf_DDfID&#xD;
  LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
  LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
  LEFT JOIN cdn.podmiotyview PodRO on PodRO.Pod_PodId = TNRO.TrN_PodID and TNRO.TrN_PodmiotTyp = PodRO.Pod_PodmiotTyp&#xD;
  LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
&#xD;
   LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
   LEFT JOIN #tmpKonAtr KonAtr1 ON PodRO.Pod_PodId = KonAtr1.KnA_PodmiotId AND PodRO.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
   LEFT JOIN #tmpDokAtr DokAtr ON TNRO.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
   LEFT JOIN #tmpTwrAtr TwrAtr ON Twr_TwrId  = TwrAtr.TwA_TwrId &#xD;
&#xD;
   left join&#xD;
(&#xD;
select max(trn_dataope) data, trn_trnid roid from(&#xD;
select ro.trn_trnid, fa.Trn_Dataope, &#xD;
CASE WHEN COUNT(efa.tre_wartoscnetto) OVER(PARTITION BY ro.trn_trnid,ero.TrE_TwrId,ero.TrE_Lp ORDER BY fa.trn_trnid) = COUNT(efa.tre_wartoscnetto) OVER(PARTITION BY ro.trn_trnid,ero.TrE_TwrId,ero.TrE_Lp ORDER BY fa.trn_trnid ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) then 1 else 0 end fareal&#xD;
from cdn.tranag ro&#xD;
left join cdn.traelem ero on ero.tre_trnid = ro.trn_trnid&#xD;
outer apply [CDN].[Powiazania](ro.TrN_TrNId,ro.TrN_TypDokumentu) pow &#xD;
left join cdn.tranag fa on fa.trn_trnid = pow.TrN_TrNId&#xD;
left join cdn.traelem efa on efa.tre_trnid = fa.trn_trnid and efa.TrE_TwrId = ero.TrE_TwrId and (efa.TrE_Lp = ero.TrE_Lppow OR efa.Tre_LpPow = ero.Tre_LP)&#xD;
where ro.TrN_TypDokumentu = 308 and (pow.TrN_TypDokumentu = 302)&#xD;
) f&#xD;
where fareal = 1&#xD;
group by trn_trnid &#xD;
) dre on dre.roid = tnro.trn_trnid &#xD;
 LEFT JOIN #tmpProForma ON PFP = tnro.Trn_trnid&#xD;
 LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
&#xD;
where tnro.trn_typdokumentu = 308 and (tnpow.TrN_TypDokumentu in (302,305) or tnpow.TrN_TypDokumentu IS NULL OR(pfp is not null and tnpow.TrN_TypDokumentu =320)) and YEAR(tnro.TrN_DataDok) =  @ROK2 &#xD;
  '&#xD;
print (@select)&#xD;
exec (@select+@select2)&#xD;
&#xD;
&#xD;
&#xD;
DROP TABLE #ROID&#xD;
DROP TABLE #Powiaz&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROp TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpProForma&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5vCxSmgondMfdtmo6sliIgTWPbj17BviVUXyPzdkotJkq7igEVPx67QBSiMcx5zyeTJgrs/t+z/BIjq9oHQl3dL1vDiIZ84Ys7b36fBxBgdA</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Rezerwacja Numer" caption="Rezerwacja Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Rezerwacja Termin Dzień" caption="Rezerwacja Termin Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Rezerwacja Termin Tydzień Roku" caption="Rezerwacja Termin Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rezerwacja Termin Miesiąc" caption="Rezerwacja Termin Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rezerwacja Termin Kwartał" caption="Rezerwacja Termin Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rezerwacja Termin Rok" caption="Rezerwacja Termin Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rezerwacja Źródło" caption="Rezerwacja Źródło" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Rezerwacja Status" caption="Rezerwacja Status" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Rezerwacja Wartość Netto" caption="Rezerwacja Wartość Netto" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rezerwacja Ilość" caption="Rezerwacja Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Sprzedaży Numer" caption="Dokument Sprzedaży Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Realizacji Dzień" caption="Data Realizacji Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Realizacji Tydzień Roku" caption="Data Realizacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Miesiąc" caption="Data Realizacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Kwartał" caption="Data Realizacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Rok" caption="Data Realizacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Dzień" caption="Data Sprzedaży Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Tydzień Roku" caption="Data Sprzedaży Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Miesiąc" caption="Data Sprzedaży Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Kwartał" caption="Data Sprzedaży Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Rok" caption="Data Sprzedaży Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rezerwacji Dzień" caption="Data Rezerwacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rezerwacji  Tydzień Roku" caption="Data Rezerwacji  Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rezerwacji  Miesiąc" caption="Data Rezerwacji  Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rezerwacji  Kwartał" caption="Data Rezerwacji  Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rezerwacji  Rok" caption="Data Rezerwacji  Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Netto" caption="Sprzedaż Wartość Netto" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba dni opóźnienia" caption="Liczba dni opóźnienia" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;ROK&lt;/Name&gt;&#xD;
    &lt;Label&gt;Rok&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Rok wystawienia dokumentu RO&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT distinct YEAR(trn_datadok), YEAR(trn_datadok) from cdn.tranag where trn_typdokumentu = 308&lt;/Expression&gt;&#xD;
    &lt;Type&gt;SQL&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Sql&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAANAAAABwIeW1JlemVyd2FjamEgTnVtZXJdLltSTy8xLzIwMjFdBwIfW1JlemVyd2FjamEgTnVtZXJdLltSTy8xMC8yMDIxXQcCH1tSZXplcndhY2phIE51bWVyXS5bUk8vMTEvMjAyMV0HAh9bUmV6ZXJ3YWNqYSBOdW1lcl0uW1JPLzEyLzIwMjFdBwIfW1JlemVyd2FjamEgTnVtZXJdLltSTy8xMy8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vMi8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vMy8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vNC8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vNS8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vNi8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vNy8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vOC8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vOS8yMDIxXQAAAAD/////AAAAABEAAAAHAh5bUmV6ZXJ3YWNqYSBOdW1lcl0uW1JPLzEvMjAyMV0HAiRbRG9rdW1lbnQgU3ByemVkYcW8eSBOdW1lcl0uWyhCUkFLKV0HAh9bUmV6ZXJ3YWNqYSBOdW1lcl0uW1JPLzEwLzIwMjFdBwIoW0Rva3VtZW50IFNwcnplZGHFvHkgTnVtZXJdLltGQS80MS8yMDIxXQcCH1tSZXplcndhY2phIE51bWVyXS5bUk8vMTAvMjAyMV0HAihbRG9rdW1lbnQgU3ByemVkYcW8eSBOdW1lcl0uW0ZBLzQyLzIwMjFdBwIfW1JlemVyd2FjamEgTnVtZXJdLltSTy8xMS8yMDIxXQcCKFtEb2t1bWVudCBTcHJ6ZWRhxbx5IE51bWVyXS5bRkEvNDMvMjAyMV0HAh9bUmV6ZXJ3YWNqYSBOdW1lcl0uW1JPLzExLzIwMjFdBwIoW0Rva3VtZW50IFNwcnplZGHFvHkgTnVtZXJdLltGQS80NC8yMDIxXQcCH1tSZXplcndhY2phIE51bWVyXS5bUk8vMTIvMjAyMV0HAiRbRG9rdW1lbnQgU3ByemVkYcW8eSBOdW1lcl0uWyhCUkFLKV0HAh9bUmV6ZXJ3YWNqYSBOdW1lcl0uW1JPLzEzLzIwMjFdBwInW0Rva3VtZW50IFNwcnplZGHFvHkgTnVtZXJdLltQQS80LzIwMjFdBwIeW1JlemVyd2FjamEgTnVtZXJdLltSTy8yLzIwMjFdBwIkW0Rva3VtZW50IFNwcnplZGHFvHkgTnVtZXJdLlsoQlJBSyldBwIeW1JlemVyd2FjamEgTnVtZXJdLltSTy8zLzIwMjFdBwIoW0Rva3VtZW50IFNwcnplZGHFvHkgTnVtZXJdLltGQS8yNS8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vNC8yMDIxXQcCKFtEb2t1bWVudCBTcHJ6ZWRhxbx5IE51bWVyXS5bRkEvMjYvMjAyMV0HAh5bUmV6ZXJ3YWNqYSBOdW1lcl0uW1JPLzUvMjAyMV0HAiRbRG9rdW1lbnQgU3ByemVkYcW8eSBOdW1lcl0uWyhCUkFLKV0HAh5bUmV6ZXJ3YWNqYSBOdW1lcl0uW1JPLzYvMjAyMV0HAihbRG9rdW1lbnQgU3ByemVkYcW8eSBOdW1lcl0uW0ZBLzM1LzIwMjFdBwIeW1JlemVyd2FjamEgTnVtZXJdLltSTy82LzIwMjFdBwIoW0Rva3VtZW50IFNwcnplZGHFvHkgTnVtZXJdLltGQS8zNi8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vNy8yMDIxXQcCKFtEb2t1bWVudCBTcHJ6ZWRhxbx5IE51bWVyXS5bRkEvMzcvMjAyMV0HAh5bUmV6ZXJ3YWNqYSBOdW1lcl0uW1JPLzgvMjAyMV0HAihbRG9rdW1lbnQgU3ByemVkYcW8eSBOdW1lcl0uW0ZBLzM4LzIwMjFdBwIeW1JlemVyd2FjamEgTnVtZXJdLltSTy84LzIwMjFdBwIoW0Rva3VtZW50IFNwcnplZGHFvHkgTnVtZXJdLltGQS8zOS8yMDIxXQcCHltSZXplcndhY2phIE51bWVyXS5bUk8vOS8yMDIxXQcCKFtEb2t1bWVudCBTcHJ6ZWRhxbx5IE51bWVyXS5bRkEvNDAvMjAyMV0=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="False" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Rezerwacja Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Rezerwacja Status"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Rezerwacja Wartość Netto"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Rezerwacja Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Dokument Sprzedaży Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość Netto"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Liczba dni opóźnienia"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="n0" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Rezerwacja Wartość Netto" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Rezerwacja Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Wartość Netto" index="3" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Liczba dni opóźnienia" index="4" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Rezerwacja Numer" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Dokument Sprzedaży Numer" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Rezerwacja Status" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę Rezerwacji odbiorcy razem z wynikającymi z nich fakturami/paragonami oraz informacją o statusie realizacji.</a:description><a:id>84</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.48 Analiza RO z fakturami sprzedaży i paragonami</a:mainLinkName><a:modifiedOn>2025-05-21T17:27:19.633</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>5</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-05-17T15:34:58.863</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Analiza RO ze stanem magazynowym &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END&#xD;
        END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'                 &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END&#xD;
        END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END&#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE&#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5 &#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa,&#xD;
    "Dokument Numer" = TrN_NumerPelny, &#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    "Dokument Obcy" = ISNULL(NULLIF(TrN_NumerObcy,''''),''(BRAK)''),&#xD;
    Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, "Forma Płatności" = FPl_Nazwa,&#xD;
       "Dokument Status" = CASE &#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 1 THEN ''(PUSTY)''&#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 2 THEN ''W realizacji'' &#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 3 THEN ''Zrealizowano'' &#xD;
                                WHEN TrN_ZwroconoCalaIlosc = 4 THEN ''Zamknięto'' &#xD;
       END,&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj], &#xD;
       "Odbiorca Nazwa" = pod3.Pod_Nazwa1,     &#xD;
       "Odbiorca Kod" = pod3.Pod_Kod,      &#xD;
       "Odbiorca Województwo" = CASE WHEN pod3.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Wojewodztwo END, &#xD;
       "Odbiorca Miasto" = CASE WHEN pod3.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Miasto END, &#xD;
       "Odbiorca Kraj" = CASE WHEN pod3.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod3.Pod_Kraj END, &#xD;
       "Odbiorca Grupa" = COALESCE(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali''), &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,       &#xD;
    "Produkt Nazwa" = Twr_Nazwa,&#xD;
    "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],     &#xD;
    "Produkt Kod" = Twr_Kod,&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
         "Produkt Numer Katalogowy" = Twr_NumerKat, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)), "Produkt Pełna Nazwa Grupy" = poz.sciezka, &#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
       "Jednostka Miary" = Twr_Jm,    &#xD;
       "Magazyn Nazwa" = Mag_Symbol,       &#xD;
       "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
CASE TrN_eSklepZrodlo&#xD;
WHEN 0 THEN ''e-Sklep''&#xD;
WHEN 2 THEN ''Facebook''&#xD;
WHEN 3 THEN ''Allegro''&#xD;
WHEN 4 THEN ''wszytsko.pl''&#xD;
WHEN 5 THEN ''Comarch e-Sklep RWD''&#xD;
WHEN 6 THEN ''API''&#xD;
WHEN 7 THEN ''system ERP''&#xD;
WHEN 8 THEN ''eBay''&#xD;
WHEN 9 THEN ''Ceneo''&#xD;
WHEN 10 THEN ''Comarch e-Sklep wersja mobilna''&#xD;
WHEN 13 THEN ''Amazon''&#xD;
ELSE ''(NIEPRZYPISANE)'' END                                                                    AS [Rezerwacja Źródło],&#xD;
&#xD;
       "Czas Aktualny Dziś" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Wczoraj" = CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Tydzień" = CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Czas Aktualny Miesiąc" = CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END,&#xD;
       "Sprzedaż Wartość" = TR.TrE_WartoscNetto, "Sprzedaż Wartość Brutto" = TR.TrE_WartoscBrutto, "Sprzedaż Wartość Waluta" = TR.TrE_WartoscNettoWal, &#xD;
       "Sprzedaż Ilość" = TR.TrE_Ilosc, "Sprzedaż Ilość Pozostała" = CASE WHEN TrN_ZwroconoCalaIlosc IN (3,4) THEN 0 ELSE TR.TrE_Ilosc + ISNULL(IP.Ilosc,0) END, &#xD;
       "Sprzedaż Marża" = TR.TrE_WartoscNetto - (isNull(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi), "Koszt Zakupu" = isNull(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi&#xD;
       , "Ilość" = ISNULL(TwI_Ilosc, 0) &#xD;
    /* &#xD;
     ----------DATY POINT&#xD;
     ,"Data Rezerwacji" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
     ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TrN_DataDok, 111), ''/'', ''-'')&#xD;
     ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
     */&#xD;
     ----------DATY ANALIZY&#xD;
     ,"Data Rezerwacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
     ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataDok, 111), ''/'', ''-'')&#xD;
     ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/&#xD;
     ,"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe) &#xD;
&#xD;
       ----------KONTEKSTY&#xD;
    ,25039 [Dokument Numer __PROCID__RO__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__], '''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
       &#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT OUTER JOIN (&#xD;
           SELECT TE1.TrE_TrEID [TREID], SUM(TrS_Ilosc) [Ilosc]&#xD;
           FROM CDN.TraElem TE1&#xD;
           JOIN CDN.TraSElem ON TrS_TrEID = TE1.TrE_TrEID&#xD;
           WHERE TrS_TrEIdWydania &lt;&gt; 0&#xD;
           GROUP BY TE1.TrE_TrEID&#xD;
     ) AS IP ON TR.TrE_TrEId = IP.TREID     &#xD;
     /* LEFT OUTER JOIN (&#xD;
            SELECT TE1.TrE_TrEID [TREID], SUM(TE2.TrE_Ilosc) [Ilosc]&#xD;
            FROM CDN.TraElem TE1&#xD;
                JOIN CDN.TraNag TN1 ON TE1.TrE_TrNId = TN1.TrN_TrNID &#xD;
                JOIN CDN.TraNagRelacje TR1 ON TN1.TrN_TrNID = TR1.TrR_TrNId AND TR1.TrR_FaTyp = 306&#xD;
                JOIN CDN.TraNag TN2 ON TR1.TrR_FaId = TN2.TrN_TrNID&#xD;
                JOIN CDN.TraElem TE2 ON TE2.TrE_TrNId = TN2.TrN_TrNID AND TE2.TrE_Lp = TE1.TrE_Lp&#xD;
            GROUP BY TE1.TrE_TrEID&#xD;
     ) AS Zal ON TR.TrE_TrEId = Zal.TREID */     &#xD;
  &#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
    --ilośc wg daty rezerwacji&#xD;
    LEFT JOIN  CDN.TwrIlosci ilosciMag  ON ilosciMag.TwI_TwIId = (SELECT TOP 1 TwI_TwIId FROM CDN.TwrIlosci &#xD;
    WHERE TwI_TwrId = TrE_TwrId AND  Mag_MagId = TwI_MagId&#xD;
    AND TwI_Data &lt;= TrN_DataWys ORDER BY TrN_DataWys DESC )&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0  &#xD;
    &#xD;
WHERE&#xD;
TrN_TypDokumentu IN (308)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
print @select&#xD;
print @select2&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QHRUwalZ8pMVJl4bnvAvbQJZcV6Wn+9eyurT5z7pvsx453uBpU8ZVZBU3sxojq0nr7SEb6pIcBltbZneCkQXihh2PJK4OnljQYqeZz6oFgeKpqUN1a0P8/X1EVgEjUyAynh2e+VUqmLaTxvo2adC1y/WjNl2Vo5HaL2i46mtibOu7HvVCLZ13K</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Obcy" caption="Dokument Obcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Status" caption="Dokument Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rezerwacji Dzień" caption="Data Rezerwacji Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Pozostała" caption="Sprzedaż Ilość Pozostała" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość" caption="Ilość" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAJAAAABwIdW1Byb2R1a3QgS29kXS5bSUdMQUtJX0NZUFJZU10HAiBbUHJvZHVrdCBLb2RdLltJR0xBS0lfSkHFgU9XSUVDXQcCGVtQcm9kdWt0IEtvZF0uW0pBQsWBT05JRV0HAhhbUHJvZHVrdCBLb2RdLltLT1JBX1M4MF0HAiJbUHJvZHVrdCBLb2RdLlvFgUHFg0NVQ0ggRE8gUEnFgVldBwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCIVtQcm9kdWt0IEtvZF0uW1VTxYFVR0EgU0VSV0lTT1dBXQcCGltQcm9kdWt0IEtvZF0uW1pFU1RBV19PR1JdBwIXW1Byb2R1a3QgS29kXS5bWkVTVEFXM10PAAAABwIdW1Byb2R1a3QgS29kXS5bSUdMQUtJX0NZUFJZU10HAiVbRGF0YSBSZXplcndhY2ppIER6aWXFhF0uWzIwMjEtMDItMDNdBwIdW1Byb2R1a3QgS29kXS5bSUdMQUtJX0NZUFJZU10HAiVbRGF0YSBSZXplcndhY2ppIER6aWXFhF0uWzIwMjEtMDUtMThdBwIgW1Byb2R1a3QgS29kXS5bSUdMQUtJX0pBxYFPV0lFQ10HAiVbRGF0YSBSZXplcndhY2ppIER6aWXFhF0uWzIwMjEtMDItMDNdBwIgW1Byb2R1a3QgS29kXS5bSUdMQUtJX0pBxYFPV0lFQ10HAiVbRGF0YSBSZXplcndhY2ppIER6aWXFhF0uWzIwMjEtMDItMDddBwIZW1Byb2R1a3QgS29kXS5bSkFCxYFPTklFXQcCJVtEYXRhIFJlemVyd2FjamkgRHppZcWEXS5bMjAyMS0wMi0wM10HAhlbUHJvZHVrdCBLb2RdLltKQULFgU9OSUVdBwIlW0RhdGEgUmV6ZXJ3YWNqaSBEemllxYRdLlsyMDIxLTA1LTE4XQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCJVtEYXRhIFJlemVyd2FjamkgRHppZcWEXS5bMjAyMS0wMS0zMV0HAiJbUHJvZHVrdCBLb2RdLlvFgUHFg0NVQ0ggRE8gUEnFgVldBwIlW0RhdGEgUmV6ZXJ3YWNqaSBEemllxYRdLlsyMDIxLTA1LTE2XQcCIltQcm9kdWt0IEtvZF0uW8WBQcWDQ1VDSCBETyBQScWBWV0HAiVbRGF0YSBSZXplcndhY2ppIER6aWXFhF0uWzIwMjEtMDYtMjldBwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCJVtEYXRhIFJlemVyd2FjamkgRHppZcWEXS5bMjAyMS0wMS0zMV0HAiFbUHJvZHVrdCBLb2RdLltVU8WBVUdBIFNFUldJU09XQV0HAiVbRGF0YSBSZXplcndhY2ppIER6aWXFhF0uWzIwMjEtMDUtMTZdBwIhW1Byb2R1a3QgS29kXS5bVVPFgVVHQSBTRVJXSVNPV0FdBwIlW0RhdGEgUmV6ZXJ3YWNqaSBEemllxYRdLlsyMDIxLTA2LTI5XQcCGltQcm9kdWt0IEtvZF0uW1pFU1RBV19PR1JdBwIlW0RhdGEgUmV6ZXJ3YWNqaSBEemllxYRdLlsyMDIxLTA1LTE2XQcCGltQcm9kdWt0IEtvZF0uW1pFU1RBV19PR1JdBwIlW0RhdGEgUmV6ZXJ3YWNqaSBEemllxYRdLlsyMDIxLTA2LTI5XQcCF1tQcm9kdWt0IEtvZF0uW1pFU1RBVzNdBwIlW0RhdGEgUmV6ZXJ3YWNqaSBEemllxYRdLlsyMDIxLTA1LTA2Xf////8AAAAAAAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Grupa"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Magazyn Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Rezerwacji Dzień"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Ilość" index="3" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Magazyn Nazwa" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Data Rezerwacji Dzień" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent Grupa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje produkty na podstawie dokumentów rezerwacji odbiorcy wraz z ich stanem magazynowym na datę rezerwacji (jeśli data rezerwacji wypada w przyszłości to miara "Ilość" pokazuje aktualny stan magazynowy).</a:description><a:id>85</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.49 Analiza RO ze stanem magazynowym</a:mainLinkName><a:modifiedOn>2025-05-22T18:29:25.067</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>5</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2021-05-13T16:33:10.2</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży z jednostkami pomocniczymi&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(jpom1.TwJZ_JM,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza 1],&#xD;
    ISNULL(NULLIF(jpom2.TwJZ_JM,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza 2],&#xD;
    ISNULL(NULLIF(jpom3.TwJZ_JM,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza 3],&#xD;
    ISNULL(NULLIF(jpom4.TwJZ_JM,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza 4],&#xD;
    ISNULL(NULLIF(jpom5.TwJZ_JM,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza 5],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
    ,CAST(TR.TrE_Ilosc/(jpom1.TwJZ_JMPrzelicznikL/jpom1.TwJZ_JMPrzelicznikM) AS Decimal(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza 1]&#xD;
    ,CAST(TR.TrE_Ilosc/(jpom2.TwJZ_JMPrzelicznikL/jpom2.TwJZ_JMPrzelicznikM) AS Decimal(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza 2]&#xD;
    ,CAST(TR.TrE_Ilosc/(jpom3.TwJZ_JMPrzelicznikL/jpom3.TwJZ_JMPrzelicznikM) AS Decimal(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza 3]&#xD;
    ,CAST(TR.TrE_Ilosc/(jpom4.TwJZ_JMPrzelicznikL/jpom4.TwJZ_JMPrzelicznikM) AS Decimal(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza 4]&#xD;
    ,CAST(TR.TrE_Ilosc/(jpom5.TwJZ_JMPrzelicznikL/jpom5.TwJZ_JMPrzelicznikM) AS Decimal(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza 5]&#xD;
    ,CAST(TR.TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
	 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TreId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TreId,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TreId = TR.TrE_Treid&#xD;
	&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN CDN.TwrJmz jpom1 on jpom1.TwJZ_TwrID = Twr_TwrId and jpom1.TwJZ_Lp = 1&#xD;
    LEFT JOIN CDN.TwrJmz jpom2 on jpom2.TwJZ_TwrID = Twr_TwrId and jpom2.TwJZ_Lp = 2&#xD;
    LEFT JOIN CDN.TwrJmz jpom3 on jpom3.TwJZ_TwrID = Twr_TwrId and jpom3.TwJZ_Lp = 3&#xD;
    LEFT JOIN CDN.TwrJmz jpom4 on jpom4.TwJZ_TwrID = Twr_TwrId and jpom4.TwJZ_Lp = 4&#xD;
    LEFT JOIN CDN.TwrJmz jpom5 on jpom5.TwJZ_TwrID = Twr_TwrId and jpom5.TwJZ_Lp = 5&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza 1],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza 2],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza 3],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza 4],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza 5],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza 1]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza 2]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza 3]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza 4]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza 5]&#xD;
    ,''(BRAK)'' [Produkt Pozycja Dokumentu]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	  LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmppozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5vCxSmgondMfdtmo6sliIgTWPbj17BviVUXyPzdkotJkq7igEVPx67QBSiMcx5zyeTJgrs/t+z/BIjq9oHQl3dL1vDiIZ84Ys7b36fBxBgdA</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza 1" caption="Jednostka Miary Pomocnicza 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza 2" caption="Jednostka Miary Pomocnicza 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza 3" caption="Jednostka Miary Pomocnicza 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza 4" caption="Jednostka Miary Pomocnicza 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza 5" caption="Jednostka Miary Pomocnicza 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza 1" caption="Sprzedaż Ilość Jednostka Pomocnicza 1" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza 2" caption="Sprzedaż Ilość Jednostka Pomocnicza 2" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza 3" caption="Sprzedaż Ilość Jednostka Pomocnicza 3" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza 4" caption="Sprzedaż Ilość Jednostka Pomocnicza 4" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza 5" caption="Sprzedaż Ilość Jednostka Pomocnicza 5" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="328" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport zawiera informacje o sprzedaży w firmie. Wartości prezentowane są w walucie systemowej. Ilości prezentowane ją w jednostce podstawowej oraz w pięciu jednostkach pomocniczych.&#xD;
&#xD;
Analizy oparte są o faktury sprzedaży, paragony nieskojarzone z fakturą sprzedaży i dokumenty &#xD;
skojarzone. Niebrane pod uwagę są natomiast następujące dokumenty pierwotne a także dokumenty anulowane.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (faktur, paragonów itp.). &#xD;
TraElem - Tabela z elementami dokumentów (faktur, paragonów itp.).</a:description><a:id>86</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.50 Sprzedaż z jednostkami pomocniczymi</a:mainLinkName><a:modifiedOn>2025-05-26T02:19:50.657</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2021-09-20T11:39:39.593</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży z Opłatą Cukrową&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
    ,CAST(TR.TrE_Ilosc/(Twr_JMPrzelicznikL*Twr_JMPrzelicznikM) AS Decimal(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,CASE WHEN Twr_OplataCukrowa = 1 AND trn.TrN_NieNaliczajOplataCukrowa = 0 AND knt3.Knt_NieNaliczajOplataCukrowa = 0 THEN TR.TrE_OplataCukrowaDoliczDoCeny*TR.TrE_Ilosc ELSE NULL END [Opłata Cukrowa Suma]&#xD;
    ,CASE WHEN Twr_OplataCukrowa = 1 AND trn.TrN_NieNaliczajOplataCukrowa = 0 AND knt3.Knt_NieNaliczajOplataCukrowa = 0 THEN TR.TrE_OplataCukrowaPrzelicznikML*TR.TrE_Ilosc ELSE NULL END [Opłata Cukrowa Ilość W Mililitrach]&#xD;
    ,CASE WHEN Twr_OplataCukrowa = 1 AND trn.TrN_NieNaliczajOplataCukrowa = 0 AND knt3.Knt_NieNaliczajOplataCukrowa = 0 THEN TR.TrE_OplataCukrowaOdCukrowStala ELSE NULL END [Opłata Cukrowa Stała]&#xD;
    ,CASE WHEN Twr_OplataCukrowa = 1 AND trn.TrN_NieNaliczajOplataCukrowa = 0 AND knt3.Knt_NieNaliczajOplataCukrowa = 0 THEN TR.TrE_OplataCukrowaOdCukrowzmienna ELSE NULL END [Opłata Cukrowa Zmienna]&#xD;
    ,CASE WHEN Twr_OplataCukrowa = 1 AND trn.TrN_NieNaliczajOplataCukrowa = 0 AND knt3.Knt_NieNaliczajOplataCukrowa = 0 THEN TR.TrE_OplataCukrowaDoliczDoCeny ELSE NULL END [Opłata Cukrowa Doliczono Do Ceny]&#xD;
    ,CASE WHEN Twr_OplataCukrowa = 1 AND trn.TrN_NieNaliczajOplataCukrowa = 0 AND knt3.Knt_NieNaliczajOplataCukrowa = 0 THEN ''Tak'' ELSE ''Nie'' END [Opłata Cukrowa]&#xD;
    ,CAST(TR.TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
    &#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TreId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TreId,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TreId = TR.TrE_Treid&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,NULL [Opłata Cukrowa Suma]&#xD;
    ,NULL [Opłata Cukrowa Ilość W Mililitrach]&#xD;
    ,NULL [Opłata Cukrowa Stała]&#xD;
    ,NULL [Opłata Cukrowa Zmienna]&#xD;
    ,NULL [Opłata Cukrowa Doliczono Do Ceny]&#xD;
    ,''Nie'' [Opłata Cukrowa]&#xD;
    ,''(BRAK)'' [Produkt Pozycja Dokumentu]&#xD;
&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	  LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmppozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5oGgM7ZyTqUt95ZsUhznLPGaI6d6f6KTDb9vY+wQZ9uZ1Osv9PWBRjxK7063do1EP3SFXPCnnPfLlapWirHqSc4A8x791GnStC1DFwQ7mHQlsrGFxXfnYiGT4TZT1NeEUw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Opłata Cukrowa Suma" caption="Opłata Cukrowa Suma" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Opłata Cukrowa Ilość W Mililitrach" caption="Opłata Cukrowa Ilość W Mililitrach" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Opłata Cukrowa Stała" caption="Opłata Cukrowa Stała" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Opłata Cukrowa Zmienna" caption="Opłata Cukrowa Zmienna" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Opłata Cukrowa Doliczono Do Ceny" caption="Opłata Cukrowa Doliczono Do Ceny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Opłata Cukrowa" caption="Opłata Cukrowa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut BUDŻET FA/FZ" caption="Dokument Atrybut BUDŻET FA/FZ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut BUDŻET PZ/PA" caption="Dokument Atrybut BUDŻET PZ/PA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DATAWAŻNOSCI" caption="Dokument Atrybut DATAWAŻNOSCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DATAWAZLICZBADNI" caption="Dokument Atrybut DATAWAZLICZBADNI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NUMER SERYJNY" caption="Pozycja Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wIAAAAHAh5bRG9rdW1lbnQgTnVtZXJdLltGQS8xMDUvMjAyMV0HAh5bRG9rdW1lbnQgTnVtZXJdLltGQS8xMDcvMjAyMV0=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Opłata Cukrowa Suma"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Opłata Cukrowa Ilość W Mililitrach"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="221" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Opłata Cukrowa Stała"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Opłata Cukrowa Zmienna"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Opłata Cukrowa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Opłata Cukrowa Suma" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Opłata Cukrowa Ilość W Mililitrach" index="3" expanded="True" sortMode="default" order="ascending" width="221" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Opłata Cukrowa Stała" index="5" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Opłata Cukrowa Zmienna" index="4" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Opłata Cukrowa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters filetrMask="" isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;included&gt;&lt;value uniqueName="Tak" /&gt;&lt;/included&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje standardowe dane sprzedażowe rozszerzone o informacje dotyczące opłaty cukrowej. Domyślnie zafiltrowany jest do dokumentów, od których pozycji należy uiścić opłatę.</a:description><a:id>87</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.51 Sprzedaż z opłatą cukrową</a:mainLinkName><a:modifiedOn>2025-05-26T02:18:59.227</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2021-09-21T16:04:03.18</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Rabaty kontrahentów&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
set @select = '&#xD;
select BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
rab_rabat as [Rabat], &#xD;
case rab_typ&#xD;
when 1 then ''Grupa kontrahenta''&#xD;
when 2 then ''Kontrahent''&#xD;
when 3 then ''Grupa kontrahenta''&#xD;
when 4 then ''Grupa kontrahenta''&#xD;
when 5 then ''Kontrahent''&#xD;
when 6 then ''Kontrahent''&#xD;
when 7 then ''Wszyscy kontrahenci''&#xD;
when 8 then ''Wszyscy kontrahenci''&#xD;
end [Rabat Typ],&#xD;
case rab_typ&#xD;
when 1 then ''Wszystkie towary''&#xD;
when 2 then ''Wszystkie towary''&#xD;
when 3 then ''Grupa towarowa'' + '' '' + TwG_Kod&#xD;
when 4 then ''Towar''&#xD;
when 5 then ''Grupa towarowa'' + '' '' + TwG_Kod&#xD;
when 6 then ''Towar''&#xD;
when 7 then ''Grupa towarowa'' + '' '' + TwG_Kod&#xD;
when 8 then ''Towar''&#xD;
end [Przedmiot Rabatu],&#xD;
k.Knt_Nazwa1 [Kontrahent Nazwa], &#xD;
k.Knt_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(k.Knt_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(k.Knt_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(k.Knt_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(k.Knt_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(k.Knt_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE k.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE k.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE k.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE k.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE k.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE WHEN ISNULL(t.Twr_ESklep,0)=1 THEN ''Tak'' ELSE ''Nie'' END [Produkt e-Sklep],&#xD;
    --CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    CASE t.Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    t.Twr_Kod [Produkt Kod],    &#xD;
    t.Twr_NumerKat [Produkt Numer Katalogowy], CAST(t.Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy],  &#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], k.knt_kntid [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], k.knt_kntid [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], t.Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], t.Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
'       + @kolumny + @atrybuty  + @atrybutyTwr + '&#xD;
&#xD;
from (&#xD;
select ROW_NUMBER() OVER (PARTITION BY twr_twrid, knt_kntid ORDER BY poziom) as RowNum, * from&#xD;
(&#xD;
--6 = jeden kontrahent / jeden towar &#xD;
select rab_typ, rab_rabat, twr_twrid, knt_kntid, 1 as poziom, Twr_TwGGIDNumer as grupa from cdn.rabaty &#xD;
join cdn.kontrahenci on rab_podmiotid = Knt_KntId AND Knt_Nieaktywny = 0&#xD;
join cdn.towary on Rab_TwrId = Twr_TwrId&#xD;
where rab_typ = 6&#xD;
&#xD;
union all&#xD;
&#xD;
--5 = jeden kontrahent / grupa towarowa &#xD;
select rab_typ, rab_rabat, twr_twrid, knt_kntid, 2 as poziom, Twr_TwGGIDNumer as grupa from cdn.rabaty &#xD;
join cdn.kontrahenci on rab_podmiotid = Knt_KntId AND Knt_Nieaktywny = 0&#xD;
join cdn.TwrGrupy on TwG_GIDNumer = Rab_TwrId and TwG_GIDTyp = -16&#xD;
join cdn.towary on Twr_TwGGIDNumer = TwG_GIDNumer&#xD;
where rab_typ = 5&#xD;
&#xD;
union all&#xD;
&#xD;
--2 = jeden kontrahent / wszystkie towary &#xD;
select rab_typ, rab_rabat, twr_twrid, knt_kntid, 3 as poziom, Twr_TwGGIDNumer as grupa from cdn.rabaty &#xD;
join cdn.kontrahenci on rab_podmiotid = Knt_KntId AND Knt_Nieaktywny = 0&#xD;
cross join cdn.towary&#xD;
where rab_typ = 2&#xD;
&#xD;
union all&#xD;
&#xD;
--4 = grupa kontrahenta / jeden towar &#xD;
select rab_typ, rab_rabat, twr_twrid, knt_kntid, 4 as poziom, Twr_TwGGIDNumer as grupa from cdn.rabaty&#xD;
join cdn.grupy on Gru_GruID = rab_podmiotid AND Gru_Typ = 31&#xD;
join cdn.kontrahenci on Gru_Nazwa = Knt_Grupa AND Knt_Nieaktywny = 0&#xD;
join cdn.towary on Rab_TwrId = Twr_twrid&#xD;
where rab_typ = 4&#xD;
&#xD;
union all&#xD;
&#xD;
--3 = grupa kontrahenta / grupa towarowa &#xD;
select rab_typ, rab_rabat, twr_twrid, knt_kntid, 5 as poziom, Twr_TwGGIDNumer as grupa from cdn.rabaty&#xD;
join cdn.grupy on Gru_GruID = rab_podmiotid AND Gru_Typ = 31&#xD;
join cdn.kontrahenci on Gru_Nazwa = Knt_Grupa AND Knt_Nieaktywny = 0&#xD;
join cdn.TwrGrupy on TwG_GIDNumer = Rab_TwrId  and TwG_GIDTyp = -16&#xD;
join cdn.towary on Twr_TwGGIDNumer = TwG_GIDNumer&#xD;
where rab_typ = 3&#xD;
&#xD;
union all&#xD;
&#xD;
--1 = grupa kontrahenta / wszystkie towary &#xD;
select rab_typ, rab_rabat, twr_twrid, knt_kntid, 6 as poziom, Twr_TwGGIDNumer as grupa from cdn.rabaty&#xD;
join cdn.grupy on Gru_GruID = rab_podmiotid AND Gru_Typ = 31&#xD;
join cdn.kontrahenci on Gru_Nazwa = Knt_Grupa AND Knt_Nieaktywny = 0&#xD;
cross join cdn.towary &#xD;
where rab_typ = 1&#xD;
&#xD;
union all&#xD;
&#xD;
--8 = jeden towar / wszyscy kontrahenci &#xD;
select rab_typ, rab_rabat, twr_twrid, knt_kntid, 7 as poziom, Twr_TwGGIDNumer as grupa from cdn.rabaty &#xD;
join cdn.towary on Rab_TwrId = Twr_TwrId&#xD;
cross join cdn.kontrahenci&#xD;
where rab_typ = 8  AND Knt_Nieaktywny = 0&#xD;
&#xD;
union all&#xD;
&#xD;
--7 = grupa towarowa / wszyscy kontrahenci &#xD;
select rab_typ, rab_rabat, twr_twrid, knt_kntid, 8 as poziom, Twr_TwGGIDNumer as grupa from cdn.rabaty&#xD;
join cdn.TwrGrupy on TwG_GIDNumer = Rab_TwrId  and TwG_GIDTyp = -16&#xD;
join cdn.towary on Twr_TwGGIDNumer = TwG_GIDNumer&#xD;
cross join cdn.kontrahenci &#xD;
where rab_typ = 7 AND Knt_Nieaktywny = 0&#xD;
) x &#xD;
) z &#xD;
left join cdn.towary t on t.Twr_TwrId = z.Twr_TwrId&#xD;
left join cdn.TwrGrupy on TwG_GIDNumer = grupa  and TwG_GIDTyp = -16&#xD;
left join cdn.Kontrahenci k on k.Knt_KntId = z.Knt_KntId&#xD;
LEFT JOIN #tmpTwrGr Poz ON grupa = Poz.gidNumer&#xD;
LEFT JOIN #tmpKonAtr KonAtr1 ON z.Knt_KntId = KonAtr1.KnA_PodmiotId &#xD;
LEFT JOIN #tmpTwrAtr TwrAtr ON t.Twr_TwrId  = TwrAtr.TwA_TwrId &#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
where rownum = 1 or Rab_Typ in (7,8) --najbardziej szczegółowy poziom dla towaru lub rabat naliczony dla wszystkich kontrahentów&#xD;
'&#xD;
&#xD;
exec(@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJ94McTCLWrfkkhybIpA9E6eh7GvxyEO0vrkPmZa9YHPszS+DuDCM+WOXMl2L7JevE0rKpZ3BAb8n4WSMm/1Nvhw5HlbQumS6ia0nUrGzffHU1jteAAptC5o8T+L/eQrlEiND6MiqzlSS/TQFHefppXw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rabat" caption="Rabat" type="measure" formatString="n2" aggregate="Max" /&gt;&#xD;
    &lt;column name="Rabat Typ" caption="Rabat Typ" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Przedmiot Rabatu" caption="Przedmiot Rabatu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAAAAAAAAAAAP////8dAAAABwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIaW1Byb2R1a3QgS29kXS5bR1JBQklFX09HUl0HAh1bUHJvZHVrdCBLb2RdLltJR0xBS0lfQ1lQUllTXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIZW1Byb2R1a3QgS29kXS5bSkFCxYFPTklFXQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCIltQcm9kdWt0IEtvZF0uW8WBQcWDQ1VDSCBETyBQScWBWV0HAhtbUHJvZHVrdCBLb2RdLltOT8W7WUNFX0VMLl0HAhpbUHJvZHVrdCBLb2RdLltPREtfTEnFmkNJXQcCFltQcm9kdWt0IEtvZF0uW1BBTEVUQV0HAhxbUHJvZHVrdCBLb2RdLltQSUVMxJhHTkFDSkFdBwIcW1Byb2R1a3QgS29kXS5bUEnFgUFfRUxFS1RSXQcCH1tQcm9kdWt0IEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0HAhhbUHJvZHVrdCBLb2RdLltQUk9EVUtUMV0HAhpbUHJvZHVrdCBLb2RdLltQUk9KX0FSQ0hJXQcCHFtQcm9kdWt0IEtvZF0uW1BST0pfWklFTEVOSV0HAhxbUHJvZHVrdCBLb2RdLltST1pEUkFCTklBQ1pdBwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCGFtQcm9kdWt0IEtvZF0uW1NBRFpPTktJXQcCF1tQcm9kdWt0IEtvZF0uW1NFS0FUT1JdBwIYW1Byb2R1a3QgS29kXS5bU0tSWllOS0FdBwIWW1Byb2R1a3QgS29kXS5bU1RPSkFLXQcCF1tQcm9kdWt0IEtvZF0uW1NaUEFERUxdBwIUW1Byb2R1a3QgS29kXS5bVEVTVF0HAh1bUHJvZHVrdCBLb2RdLltUT1dBUl9URVNUT1dZXQcCF1tQcm9kdWt0IEtvZF0uW1RVSkVfM0xdBwIhW1Byb2R1a3QgS29kXS5bVVPFgVVHQSBTRVJXSVNPV0FdBwIaW1Byb2R1a3QgS29kXS5bWkVTVEFXX09HUl0HAhhbUHJvZHVrdCBLb2RdLltaSUVNSUFfNV0AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Rabat"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Rabat Typ"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Przedmiot Rabatu"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Rabat" index="0" expanded="True" cusomDisplayText="Rabat (%)" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Rabat Typ" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Przedmiot Rabatu" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę rabatów dla wybranego na filtrze kontrahenta.</a:description><a:id>88</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.52 Rabaty kontrahentów</a:mainLinkName><a:modifiedOn>2024-09-06T10:13:28.427</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-28T17:27:40.433</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Korekt Sprzedaży z Dokumentami Źródłowymi&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
    ,CAST(TR.TrE_Ilosc/(Twr_JMPrzelicznikL*Twr_JMPrzelicznikM) AS Decimal(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,CAST(TR.TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
    ,kor.TrN_NumerPelny [Dokument Żródłowy]&#xD;
&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN CDN.TraNag kor on kor.TrN_TrnId = trn.TrN_ZwrId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
AND trn.TrN_ZwrId IS NOT NULL&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    trn.TrN_RazemNetto/ISNULL(dokil,1) [Sprzedaż Wartość], trn.TrN_RazemBrutto/ISNULL(dokil,1) [Sprzedaż Wartość Brutto], trn.TrN_RazemNettoWal/ISNULL(dokil,1) [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt/ISNULL(dokil,1) [Koszt Zakupu], (trn.TrN_RazemNetto - KosztWyliczony.Koszt)/ISNULL(dokil,1) [Sprzedaż Marża],&#xD;
    trn.TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,''(BRAK)'' [Produkt Pozycja Dokumentu]&#xD;
    ,kor.TrN_NumerPelny [Dokument Źródłowy]&#xD;
&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], trn.TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], trn.TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], trn.TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag trn&#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON trn.TrN_PodID=knt1.Knt_KntId AND trn.TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON trn.TrN_PodID= pod1.Pod_PodId AND trn.TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.TraNagRelacje on TrR_FaId = trn.TrN_TrNId&#xD;
     LEFT JOIN CDN.TraNag kor on kor.TrN_TrNId = TrR_TrNId&#xD;
     LEFT JOIN &#xD;
     (&#xD;
     select trn.TrN_TrNID korid, COUNT(kor.TrN_TrNID) dokil from cdn.tranag trn&#xD;
    LEFT JOIN CDN.TraNagRelacje on TrR_FaId = trn.TrN_TrNId&#xD;
    LEFT JOIN CDN.TraNag kor on kor.TrN_TrNId = TrR_TrNId&#xD;
    WHERE&#xD;
    trn.TrN_Rodzaj = 302010&#xD;
    group by trn.TrN_TrNID) x on x.korid = trn.TrN_TrNID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = trn.Trn_Trnid&#xD;
WHERE&#xD;
trn.TrN_Rodzaj = 302010&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmppozatr&#xD;
&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5oGgM7ZyTqUt95ZsUhznLPGaI6d6f6KTDb9vY+wQZ9uZ1Osv9PWBRjxK7063do1EP3SFXPCnnPfLlapWirHqSc4A8x791GnStC1DFwQ7mHQlsrGFxXfnYiGT4TZT1NeEUw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Żródłowy" caption="Dokument Żródłowy" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut BUDŻET FA/FZ" caption="Dokument Atrybut BUDŻET FA/FZ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut BUDŻET PZ/PA" caption="Dokument Atrybut BUDŻET PZ/PA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DATAWAŻNOSCI" caption="Dokument Atrybut DATAWAŻNOSCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DATAWAZLICZBADNI" caption="Dokument Atrybut DATAWAZLICZBADNI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NUMER SERYJNY" caption="Pozycja Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAEAAAABwIeW0Rva3VtZW50IE51bWVyXS5bRktPUi8xLzIwMjBdBwIeW0Rva3VtZW50IE51bWVyXS5bRktPUi8xLzIwMjFdBwIeW0Rva3VtZW50IE51bWVyXS5bRktPUi8yLzIwMjBdBwIeW0Rva3VtZW50IE51bWVyXS5bRktPUi8yLzIwMjFd/////wAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="275" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" formula="( Sprzedaż Wartość= 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Sprzedaż Wartość)" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Baza Firmowa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Dokument Żródłowy"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Dokument Żródłowy" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Baza Firmowa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje korekty sprzedaży wraz z dokumentami źródłowymi.</a:description><a:id>89</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.53 Korekty z dokumentami źródłowymi</a:mainLinkName><a:modifiedOn>2025-05-26T02:12:56.24</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2022-05-04T12:39:28.31</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zestawy promocyjne&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Towar Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @wersja float, @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max), @sqlA nvarchar(max), @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int;&#xD;
&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Towar Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Towar Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select =&#xD;
'SELECT&#xD;
BAZ.Baz_Nazwa AS [Baza Firmowa],&#xD;
ZTw_Kod AS [Zestaw Promocyjny Kod],&#xD;
ZTw_Nazwa AS [Zestaw Promocyjny Nazwa],&#xD;
Twr_Kod AS [Zestaw Promocyjny Towar Kod],&#xD;
Twr_Nazwa AS [Zestaw Promocyjny Towar Nazwa],&#xD;
ISNULL(NULLIF(ZTw_Opis, ''''), ''(BRAK)'') AS [Zestaw Promocyjny Informacje Dodatkowe],&#xD;
&#xD;
Twr_Kod + '' - towar główny'' [Towar Kod],&#xD;
Twr_Nazwa + '' - towar główny'' AS [Towar Nazwa],&#xD;
1 AS [Towar Ilość],&#xD;
Twr_JM AS [Towar Jm],&#xD;
CASE ZTw_TypRabatu&#xD;
    WHEN 0 THEN ''Rabat''&#xD;
    WHEN 1 THEN ''Stała cena''&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Towar Rodzaj Rabatu],&#xD;
CASE ZTw_TypRabatu&#xD;
    WHEN 1 THEN ZTw_Waluta&#xD;
    ELSE TwC_Waluta&#xD;
END AS [Towar Waluta],&#xD;
TwC_Waluta AS [Towar Waluta Przed Rabatem],&#xD;
&#xD;
CASE ZTw_TypRabatu&#xD;
    WHEN 0 THEN ZTw_Wartosc / 100&#xD;
    ELSE NULL&#xD;
END AS [Towar Procent],&#xD;
CASE ZTw_TypRabatu&#xD;
    WHEN 1 THEN ZTw_Wartosc&#xD;
    ELSE NULL&#xD;
END AS [Towar Cena],&#xD;
TwC_Wartosc AS [Towar Cena Przed Rabatem],&#xD;
CASE ZTw_TypRabatu&#xD;
    WHEN 0 THEN TwC_Wartosc * (100 - ZTw_Wartosc) / 100&#xD;
    WHEN 1 THEN ZTw_Wartosc&#xD;
    ELSE NULL&#xD;
END AS [Towar Wartość],&#xD;
TwC_Wartosc AS [Towar Wartość Przed Rabatem],&#xD;
CASE ZTw_TypRabatu&#xD;
    WHEN 0 THEN (TwC_Wartosc * (100 - ZTw_Wartosc) / 100) - TwC_Wartosc&#xD;
    WHEN 1 THEN ZTw_Wartosc - TwC_Wartosc&#xD;
    ELSE NULL&#xD;
END AS [Towar Wartość Zniżki],&#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), ZTw_DataOd, 111), ''/'', ''-''))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), ZTw_DataDo, 111), ''/'', ''-''))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do],&#xD;
*/&#xD;
&#xD;
----------DATY ANALIZY&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), ZTw_DataOd, 111), ''/'', ''-''))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od Dzień],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, (datepart(DY, datediff(d, 0, ZTw_DataOd) / 7 * 7 + 3) + 6) / 7)&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od Tydzień Roku],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, MONTH(ZTw_DataOd))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od Miesiąc],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, DATEPART(quarter, ZTw_DataOd))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od Kwartał],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, YEAR(ZTw_DataOd))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od Rok],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), ZTw_DataDo, 111), ''/'', ''-''))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do Dzień],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, (datepart(DY, datediff(d, 0, ZTw_DataDo) / 7 * 7 + 3) + 6) / 7)&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do Tydzień Roku],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, MONTH(ZTw_DataDo))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do Miesiąc],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, DATEPART(quarter, ZTw_DataDo))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do Kwartał],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, YEAR(ZTw_DataDo))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do Rok]&#xD;
----------KONTEKSTY&#xD;
,25003 [Towar Nazwa __PROCID__], Twr_twrId [Towar Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Towar Nazwa __DATABASE__]&#xD;
,25003 [Towar Kod __PROCID__Towary__], Twr_twrId [Towar Kod __ORGID__],''' + @bazaFirmowa + ''' [Towar Kod __DATABASE__]'&#xD;
&#xD;
+ @kolumny + @atrybutyTwr&#xD;
&#xD;
set @select2 = &#xD;
' FROM [CDN].[ZestawyTwr]&#xD;
LEFT JOIN [CDN].[Towary] ON ZTw_TwrId = Twr_TwrId&#xD;
LEFT JOIN [CDN].[TwrCeny] ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
LEFT JOIN #tmpTwrAtr TwrAtr ON Twr_TwrId  = TwrAtr.TwA_TwrId&#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT&#xD;
BAZ.Baz_Nazwa AS [Baza Firmowa],&#xD;
ZTw_Kod AS [Zestaw Promocyjny Kod],&#xD;
ZTw_Nazwa AS [Zestaw Promocyjny Nazwa],&#xD;
Twr.Twr_Kod AS [Zestaw Promocyjny Towar Kod],&#xD;
Twr.Twr_Nazwa AS [Zestaw Promocyjny Towar Nazwa],&#xD;
ISNULL(NULLIF(ZTw_Opis, ''''), ''(BRAK)'') AS [Zestaw Promocyjny Informacje Dodatkowe],&#xD;
&#xD;
TwrSkladniki.Twr_Kod [Towar Kod],&#xD;
TwrSkladniki.Twr_Nazwa AS [Towar Nazwa],&#xD;
ZTS_Ilosc AS [Towar Ilość],&#xD;
ZTS_Jm AS [Towar Jm],&#xD;
CASE ZTS_TypRabatu&#xD;
    WHEN 0 THEN ''Rabat''&#xD;
    WHEN 1 THEN ''Stała cena''&#xD;
    WHEN 2 THEN ''Gratis''&#xD;
    WHEN 3 THEN ''Procent od ceny towaru głównego''&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Towar Rodzaj Rabatu],&#xD;
CASE &#xD;
    WHEN ZTS_TypRabatu IN (1, 2) THEN ZTS_Waluta&#xD;
    ELSE CenyTwrS.TwC_Waluta&#xD;
END AS [Towar Waluta],&#xD;
&#xD;
CenyTwrS.TwC_Waluta AS [Towar Waluta Przed Rabatem],&#xD;
CASE &#xD;
    WHEN ZTS_TypRabatu IN (0, 3) THEN ZTS_Wartosc / 100&#xD;
    ELSE NULL&#xD;
END AS [Towar Procent],&#xD;
CASE&#xD;
    WHEN ZTS_TypRabatu IN (1, 2) THEN ZTS_Wartosc&#xD;
    ELSE NULL&#xD;
END AS [Towar Cena],&#xD;
CenyTwrS.TwC_Wartosc AS [Towar Cena Przed Rabatem],&#xD;
CASE &#xD;
    WHEN ZTS_TypRabatu IN (1, 2) THEN ZTS_Ilosc * ZTS_Wartosc&#xD;
    WHEN ZTS_TypRabatu = 0 THEN ZTS_Ilosc * (CenyTwrS.TwC_Wartosc * (100 - ZTS_Wartosc) / 100)&#xD;
    WHEN ZTS_TypRabatu = 3 THEN&#xD;
        CASE ZTw_TypRabatu&#xD;
            WHEN 0 THEN ZTS_Ilosc * (CenyTwr.TwC_Wartosc * (100 - ZTw_Wartosc) / 100) * (ZTS_Wartosc / 100)&#xD;
            WHEN 1 THEN ZTS_Ilosc * ZTw_Wartosc * (ZTS_Wartosc / 100)&#xD;
            ELSE NULL&#xD;
        END&#xD;
    ELSE NULL&#xD;
END AS [Towar Wartość],&#xD;
CenyTwrS.TwC_Wartosc * ZTS_Ilosc AS [Towar Wartość Przed Rabatem],&#xD;
CASE &#xD;
    WHEN ZTS_TypRabatu IN (1, 2) THEN (ZTS_Ilosc * ZTS_Wartosc) - (CenyTwrS.TwC_Wartosc * ZTS_Ilosc)&#xD;
    WHEN ZTS_TypRabatu = 0 THEN (ZTS_Ilosc * (CenyTwrS.TwC_Wartosc * (100 - ZTS_Wartosc) / 100)) - (CenyTwrS.TwC_Wartosc * ZTS_Ilosc)&#xD;
    WHEN ZTS_TypRabatu = 3 THEN&#xD;
        CASE ZTw_TypRabatu&#xD;
            WHEN 0 THEN (ZTS_Ilosc * (CenyTwr.TwC_Wartosc * (100 - ZTw_Wartosc) / 100) * (ZTS_Wartosc / 100)) - (CenyTwrS.TwC_Wartosc * ZTS_Ilosc)&#xD;
            WHEN 1 THEN (ZTS_Ilosc * ZTw_Wartosc * (ZTS_Wartosc / 100)) - (CenyTwrS.TwC_Wartosc * ZTS_Ilosc)&#xD;
            ELSE NULL&#xD;
        END&#xD;
    ELSE NULL&#xD;
END AS [Towar Wartość Zniżki],&#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), ZTw_DataOd, 111), ''/'', ''-''))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), ZTw_DataDo, 111), ''/'', ''-''))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do],&#xD;
*/&#xD;
&#xD;
----------DATY ANALIZY&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), ZTw_DataOd, 111), ''/'', ''-''))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od Dzień],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, (datepart(DY, datediff(d, 0, ZTw_DataOd) / 7 * 7 + 3) + 6) / 7)&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od Tydzień Roku],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, MONTH(ZTw_DataOd))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od Miesiąc],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, DATEPART(quarter, ZTw_DataOd))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od Kwartał],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, YEAR(ZTw_DataOd))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Od Rok],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), ZTw_DataDo, 111), ''/'', ''-''))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do Dzień],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, (datepart(DY, datediff(d, 0, ZTw_DataDo) / 7 * 7 + 3) + 6) / 7)&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do Tydzień Roku],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, MONTH(ZTw_DataDo))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do Miesiąc],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, DATEPART(quarter, ZTw_DataDo))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do Kwartał],&#xD;
CASE &#xD;
    WHEN ZTw_CzyOgraniczacDaty = 1 THEN CONVERT(VARCHAR, YEAR(ZTw_DataDo))&#xD;
    ELSE ''(BRAK)''&#xD;
END AS [Data Obowiązywania Do Rok]&#xD;
&#xD;
----------KONTEKSTY&#xD;
,25003 [Towar Nazwa __PROCID__], TwrSkladniki.Twr_twrId [Towar Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Towar Nazwa __DATABASE__]&#xD;
,25003 [Towar Kod __PROCID__Towary__], TwrSkladniki.Twr_twrId [Towar Kod __ORGID__],''' + @bazaFirmowa + ''' [Towar Kod __DATABASE__]'&#xD;
&#xD;
+ @kolumny + @atrybutyTwr&#xD;
&#xD;
set @select3 =&#xD;
' FROM [CDN].[ZestawyTwr]&#xD;
LEFT JOIN [CDN].[Towary] Twr ON ZTw_TwrId = Twr.Twr_TwrId&#xD;
LEFT JOIN [CDN].[ZestawyTwrSkladniki] ON ZTw_ZTwId = ZTS_ZTwId&#xD;
LEFT JOIN [CDN].[Towary] TwrSkladniki ON ZTS_TwrId = TwrSkladniki.Twr_TwrId&#xD;
LEFT JOIN [CDN].[TwrCeny] CenyTwr ON Twr.Twr_TwrId = CenyTwr.TwC_TwrID AND Twr.Twr_TwCNumer = CenyTwr.TwC_TwCNumer&#xD;
LEFT JOIN [CDN].[TwrCeny] CenyTwrS ON TwrSkladniki.Twr_TwrId = CenyTwrS.TwC_TwrID AND TwrSkladniki.Twr_TwCNumer = CenyTwrS.TwC_TwCNumer&#xD;
LEFT JOIN #tmpTwrGr Poz ON TwrSkladniki.Twr_TwGGIDNumer = Poz.gidNumer&#xD;
LEFT JOIN #tmpTwrAtr TwrAtr ON TwrSkladniki.Twr_TwrId = TwrAtr.TwA_TwrId&#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+R9xVUaSNnhw1ovX8kGyRfvi+FPVVwm8BXQToPM2XXd7Cy6m9BIS7z9s1IwAideFbTKXNgYEsZmxH4ZxrA6lmE7QgFLq+a2/6vhE78xSUnvDxbs+BsIWWyvH7fGCLkVDMpKg0ciAgY8sLRCTy+3uvFuGg/3PU/oLZvxA4q7nTV/87QZZOcnSY3BHSM/dy29J4Nb7KMfUpBb2A==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zestaw Promocyjny Kod" caption="Zestaw Promocyjny Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Zestaw Promocyjny Nazwa" caption="Zestaw Promocyjny Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Zestaw Promocyjny Towar Kod" caption="Zestaw Promocyjny Towar Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Zestaw Promocyjny Towar Nazwa" caption="Zestaw Promocyjny Towar Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Zestaw Promocyjny Informacje Dodatkowe" caption="Zestaw Promocyjny Informacje Dodatkowe" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Towar Kod" caption="Towar Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Towar Nazwa" caption="Towar Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Towar Ilość" caption="Towar Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Towar Jm" caption="Towar Jm" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Towar Rodzaj Rabatu" caption="Towar Rodzaj Rabatu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Towar Waluta" caption="Towar Waluta" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Towar Waluta Przed Rabatem" caption="Towar Waluta Przed Rabatem" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Towar Procent" caption="Towar Procent" type="measure" formatString="p2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Towar Cena" caption="Towar Cena" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Towar Cena Przed Rabatem" caption="Towar Cena Przed Rabatem" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Towar Wartość" caption="Towar Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Towar Wartość Przed Rabatem" caption="Towar Wartość Przed Rabatem" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Towar Wartość Zniżki" caption="Towar Wartość Zniżki" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Obowiązywania Od Dzień" caption="Data Obowiązywania Od Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Obowiązywania Od Tydzień Roku" caption="Data Obowiązywania Od Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Obowiązywania Od Miesiąc" caption="Data Obowiązywania Od Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Obowiązywania Od Kwartał" caption="Data Obowiązywania Od Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Obowiązywania Od Rok" caption="Data Obowiązywania Od Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Obowiązywania Do Dzień" caption="Data Obowiązywania Do Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Obowiązywania Do Tydzień Roku" caption="Data Obowiązywania Do Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Obowiązywania Do Miesiąc" caption="Data Obowiązywania Do Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Obowiązywania Do Kwartał" caption="Data Obowiązywania Do Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Obowiązywania Do Rok" caption="Data Obowiązywania Do Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Towar Grupa Poziom 0" caption="Towar Grupa Poziom 0" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Towar Grupa Poziom 1" caption="Towar Grupa Poziom 1" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Towar Grupa Poziom 2" caption="Towar Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Towar Grupa Poziom 3" caption="Towar Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Towar Grupa Poziom 4" caption="Towar Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Towar Grupa Poziom 5" caption="Towar Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAcAAAACAAAABwIkW1plc3RhdyBQcm9tb2N5am55IEtvZF0uW1pFU1RBV19PR1JdBwIlW1plc3RhdyBQcm9tb2N5am55IEtvZF0uW1pFU1RBV19PR1IxXQIAAAAHAiRbWmVzdGF3IFByb21vY3lqbnkgS29kXS5bWkVTVEFXX09HUl0HAipbWmVzdGF3IFByb21vY3lqbnkgVG93YXIgS29kXS5bR1JBQklFX09HUl0HAiVbWmVzdGF3IFByb21vY3lqbnkgS29kXS5bWkVTVEFXX09HUjFdBwIvW1plc3RhdyBQcm9tb2N5am55IFRvd2FyIEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0AAAAA/////wAAAAAAAAAABwAAAAcCJFtaZXN0YXcgUHJvbW9jeWpueSBLb2RdLltaRVNUQVdfT0dSXQcCKltaZXN0YXcgUHJvbW9jeWpueSBUb3dhciBLb2RdLltHUkFCSUVfT0dSXQcCHFtUb3dhciBLb2RdLltHUkFCSUVfTEnFmkNJRV0HAiRbWmVzdGF3IFByb21vY3lqbnkgS29kXS5bWkVTVEFXX09HUl0HAipbWmVzdGF3IFByb21vY3lqbnkgVG93YXIgS29kXS5bR1JBQklFX09HUl0HAilbVG93YXIgS29kXS5bR1JBQklFX09HUiAtIHRvd2FyIGfFgsOzd255XQcCJFtaZXN0YXcgUHJvbW9jeWpueSBLb2RdLltaRVNUQVdfT0dSXQcCKltaZXN0YXcgUHJvbW9jeWpueSBUb3dhciBLb2RdLltHUkFCSUVfT0dSXQcCFVtUb3dhciBLb2RdLltTWlBBREVMXQcCJVtaZXN0YXcgUHJvbW9jeWpueSBLb2RdLltaRVNUQVdfT0dSMV0HAi9bWmVzdGF3IFByb21vY3lqbnkgVG93YXIgS29kXS5bUEnFgUFfU1BBTElOT1dBXQcCGVtUb3dhciBLb2RdLltOT8W7WUNFX0VMLl0HAiVbWmVzdGF3IFByb21vY3lqbnkgS29kXS5bWkVTVEFXX09HUjFdBwIvW1plc3RhdyBQcm9tb2N5am55IFRvd2FyIEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0HAi5bVG93YXIgS29kXS5bUEnFgUFfU1BBTElOT1dBIC0gdG93YXIgZ8WCw7N3bnldBwIlW1plc3RhdyBQcm9tb2N5am55IEtvZF0uW1pFU1RBV19PR1IxXQcCL1taZXN0YXcgUHJvbW9jeWpueSBUb3dhciBLb2RdLltQScWBQV9TUEFMSU5PV0FdBwIaW1Rvd2FyIEtvZF0uW1JPWkRSQUJOSUFDWl0HAiVbWmVzdGF3IFByb21vY3lqbnkgS29kXS5bWkVTVEFXX09HUjFdBwIvW1plc3RhdyBQcm9tb2N5am55IFRvd2FyIEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0HAhVbVG93YXIgS29kXS5bU0VLQVRPUl0=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="316" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Zestaw Promocyjny Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Zestaw Promocyjny Towar Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Towar Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="185" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Towar Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="94" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Towar Rodzaj Rabatu"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="208" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Towar Procent"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="p2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="103" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Towar Cena"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="92" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Towar Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="105" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Towar Wartość Zniżki"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="128" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Towar Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="94" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Towar Procent" index="2" expanded="True" sortMode="default" order="ascending" width="103" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Towar Cena" index="1" expanded="True" sortMode="default" order="ascending" width="92" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Towar Wartość" index="3" expanded="True" sortMode="default" order="ascending" width="105" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Towar Wartość Zniżki" index="4" expanded="True" sortMode="default" order="ascending" width="128" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Zestaw Promocyjny Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Zestaw Promocyjny Towar Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Towar Kod" index="2" expanded="True" sortMode="default" order="ascending" width="185" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Towar Rodzaj Rabatu" index="3" expanded="True" sortMode="default" order="ascending" width="208" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport zawiera informacje na temat zestawów promocyjnych. Prezentuje wartości cen towarów przed i po uwzględnieniu promocji.</a:description><a:id>90</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.54 Zestawy promocyjne</a:mainLinkName><a:modifiedOn>2025-04-14T09:52:00.13</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2022-05-16T16:14:22.64</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Cennik produktów&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dostawca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'      &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select =&#xD;
'SELECT &#xD;
    BAZ.Baz_Nazwa AS [Baza Firmowa],&#xD;
    Twr_kod AS [Produkt Kod],&#xD;
    Twr_Nazwa AS [Produkt Nazwa],&#xD;
    ISNULL(NULLIF(CAST(Twr_Opis as VARCHAR(1024)), ''''), ''(BRAK)'') AS [Produkt Opis],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END AS [Produkt Aktywny],&#xD;
    Twr_JM AS [Produkt Jednostka Miary],&#xD;
    ISNULL(NULLIF(Twr_JMZ, ''''), ''(BRAK)'') AS [Produkt Jednostka Miary Pomocnicza],&#xD;
    ISNULL(NULLIF(Twr_SWW, ''''), ''(BRAK)'') AS [Produkt PKWiU],&#xD;
    CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
        ELSE ''BRAK''&#xD;
    END AS [Produkt Typ],&#xD;
    ISNULL(Knt_Kod, ''(BRAK)'') AS [Produkt Dostawca],&#xD;
    ISNULL(Prd_Kod, ''(BRAK)'') AS [Produkt Producent],&#xD;
    ISNULL(Mrk_Nazwa, ''(BRAK)'') AS [Produkt Marka],&#xD;
    ISNULL(Kat_KodSzczegol, ''(BRAK)'') AS [Produkt Kategoria Szczegółowa], &#xD;
    ISNULL(Kat_KodOgolny, ''(BRAK)'') AS [Produkt Kategoria Ogólna], &#xD;
    ISNULL(KCN_Kod, ''(BRAK)'') AS [Produkt Kod CN],&#xD;
    ISNULL(NULLIF(Twr_NumerKat, ''''), ''(BRAK)'') AS [Produkt Numer Katalogowy], &#xD;
    ISNULL(NULLIF(Poz.Sciezka, ''''), ''(BRAK)'') AS [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrN.IleDok IS NOT NULL THEN ''Tak'' ELSE ''Nie'' END AS [Dokumenty Powiązane],&#xD;
    DfC_Nazwa AS [Cena Nazwa],&#xD;
    CASE DfC_Typ&#xD;
        WHEN 1 THEN ''Netto''&#xD;
        WHEN 2 THEN ''Brutto''&#xD;
    END AS [Cena Typ],&#xD;
    CASE &#xD;
        WHEN DfC_Lp = 1 THEN ''Cena zakupu''&#xD;
        WHEN DfC_Lp &gt; 1 THEN ''Cena sprzedaży''&#xD;
    END AS [Cena Rodzaj],&#xD;
    CASE TwC_Aktualizacja WHEN 1 THEN ''Tak'' ELSE ''Nie'' END AS [Cena Aktualizacja],&#xD;
    TwC_Marza / 100 AS [Cena Marża],&#xD;
    TwC_Zaokraglenie AS [Cena Zaokrąglenie],&#xD;
    Twr_Stawka / 100 AS [Cena Stawka VAT],&#xD;
    CASE TwC_Typ&#xD;
        WHEN 1 THEN TwC_Wartosc&#xD;
        WHEN 2 THEN CASE Twr_Stawka WHEN 0 THEN TwC_Wartosc ELSE TwC_Wartosc / (1 + Twr_Stawka / 100) END&#xD;
    END AS [Cena Wartość Netto],&#xD;
    CASE TwC_Typ&#xD;
        WHEN 1 THEN (1 + Twr_Stawka / 100) * TwC_Wartosc&#xD;
        WHEN 2 THEN TwC_Wartosc&#xD;
    END AS [Cena Wartość Brutto],&#xD;
    TwC_Waluta AS [Cena Waluta],&#xD;
    ISNULL(TrN.IleDok, 0) * 1.0 / COUNT(Twr_TwrId) OVER(PARTITION BY Twr_TwrId) AS [Liczba Dokumentów Powiązanych]&#xD;
    &#xD;
    ----------KONTEKSTY&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_TwrId [Produkt Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_TwrId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,20201 [Produkt Dostawca __PROCID__], Knt_KntId [Produkt Dostawca __ORGID__],''' + @bazaFirmowa + ''' [Produkt Dostawca __DATABASE__]'&#xD;
&#xD;
    + @kolumny + @atrybutyTwr + @atrybuty&#xD;
&#xD;
set @select2 =&#xD;
' FROM CDN.Towary&#xD;
LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID&#xD;
LEFT JOIN CDN.DefCeny ON TwC_TwCNumer = DfC_DfCid&#xD;
LEFT JOIN CDN.Kontrahenci ON Twr_KntId = Knt_KntId&#xD;
LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
LEFT JOIN CDN.Kategorie ON Twr_KatId = Kat_KatID&#xD;
LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
LEFT JOIN #tmpTwrAtr TwrAtr ON Twr_TwrId  = TwrAtr.TwA_TwrId&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId AND Knt_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
LEFT JOIN (SELECT TrE_TwrId, COUNT(TrN_TrNID) IleDok FROM CDN.TraNag&#xD;
        JOIN CDN.TraElem ON TrN_TrNID = TrE_TrNId&#xD;
        GROUP BY TrE_TwrId) TrN ON TrE_TwrId = Twr_TwrId&#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0'&#xD;
&#xD;
print (@select + @select2)&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpKonAtr&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+R9xVUaSNnhw1ovX8kGyRfvi+FPVVwm8BXQToPM2XXd7Cy6m9BIS7z9s1IwAideFbTKXNgYEsZmxH4ZxrA6lmE7QgFLq+a2/6vhE78xSUnvDxbs+BsIWWyvH7fGCLkVDMpKg0ciAgY8sLRCTy+3uvFuGg/3PU/oLZvxA4q7nTV/87QZZOcnSY3BHSM/dy29J4Nb7KMfUpBb2A==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary" caption="Produkt Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Szczegółowa" caption="Produkt Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Ogólna" caption="Produkt Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokumenty Powiązane" caption="Dokumenty Powiązane" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Cena Nazwa" caption="Cena Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Cena Typ" caption="Cena Typ" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Cena Rodzaj" caption="Cena Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Cena Aktualizacja" caption="Cena Aktualizacja" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Cena Marża" caption="Cena Marża" type="measure" formatString="p2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena Zaokrąglenie" caption="Cena Zaokrąglenie" type="measure" formatString="n2" aggregate="Min" /&gt;&#xD;
    &lt;column name="Cena Stawka VAT" caption="Cena Stawka VAT" type="measure" formatString="p2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena Wartość Netto" caption="Cena Wartość Netto" type="measure" formatString="c2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena Wartość Brutto" caption="Cena Wartość Brutto" type="measure" formatString="c2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena Waluta" caption="Cena Waluta" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów Powiązanych" caption="Liczba Dokumentów Powiązanych" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAAAAAAAAAAAP////8eAAAABwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIaW1Byb2R1a3QgS29kXS5bR1JBQklFX09HUl0HAh1bUHJvZHVrdCBLb2RdLltJR0xBS0lfQ1lQUllTXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIZW1Byb2R1a3QgS29kXS5bSkFCxYFPTklFXQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCIltQcm9kdWt0IEtvZF0uW8WBQcWDQ1VDSCBETyBQScWBWV0HAhtbUHJvZHVrdCBLb2RdLltOT8W7WUNFX0VMLl0HAhpbUHJvZHVrdCBLb2RdLltPREtfTEnFmkNJXQcCFltQcm9kdWt0IEtvZF0uW1BBTEVUQV0HAhxbUHJvZHVrdCBLb2RdLltQSUVMxJhHTkFDSkFdBwIcW1Byb2R1a3QgS29kXS5bUEnFgUFfRUxFS1RSXQcCH1tQcm9kdWt0IEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0HAhVbUHJvZHVrdCBLb2RdLltQUk9EM10HAhVbUHJvZHVrdCBLb2RdLltQUk9ENF0HAhlbUHJvZHVrdCBLb2RdLltQUk9EVUtDSUtdBwIaW1Byb2R1a3QgS29kXS5bUFJPSl9BUkNISV0HAhxbUHJvZHVrdCBLb2RdLltQUk9KX1pJRUxFTkldBwIcW1Byb2R1a3QgS29kXS5bUk9aRFJBQk5JQUNaXQcCGVtQcm9kdWt0IEtvZF0uW1LDk8W7QV9QTl0HAhhbUHJvZHVrdCBLb2RdLltTQURaT05LSV0HAhdbUHJvZHVrdCBLb2RdLltTRUtBVE9SXQcCGFtQcm9kdWt0IEtvZF0uW1NLUlpZTktBXQcCFltQcm9kdWt0IEtvZF0uW1NUT0pBS10HAhdbUHJvZHVrdCBLb2RdLltTWlBBREVMXQcCFFtQcm9kdWt0IEtvZF0uW1RFU1RdBwIXW1Byb2R1a3QgS29kXS5bVFVKRV8zTF0HAiFbUHJvZHVrdCBLb2RdLltVU8WBVUdBIFNFUldJU09XQV0HAhpbUHJvZHVrdCBLb2RdLltaRVNUQVdfT0dSXQcCGFtQcm9kdWt0IEtvZF0uW1pJRU1JQV81XQAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="311" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dokumenty Powiązane"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Cena Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Cena Typ"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Cena Rodzaj"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Cena Marża"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="p2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="108" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Cena Stawka VAT"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="p2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="105" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Cena Wartość Netto"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="121" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Cena Wartość Brutto"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="122" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Cena Marża" index="1" expanded="True" sortMode="default" order="ascending" width="108" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Cena Stawka VAT" index="0" expanded="True" sortMode="default" order="ascending" width="105" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Cena Wartość Netto" index="2" expanded="True" sortMode="default" order="ascending" width="121" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Cena Wartość Brutto" index="3" expanded="True" sortMode="default" order="ascending" width="122" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Cena Nazwa" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Cena Typ" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Dokumenty Powiązane" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;filter fieldName="Cena Rodzaj" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport zawiera informacje na temat cen przypisanych do produktów. Umożliwia filtrowanie danych według cen zakupu lub sprzedaży oraz w zależności od istnienia dokumentów powiązanych.</a:description><a:id>91</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.55 Cennik produktów</a:mainLinkName><a:modifiedOn>2025-04-14T09:51:51.293</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2023-06-05T14:36:43.883</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport sprzedaży w zakresie dat z atrybutami zasobów&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
	JOIN CDN.TraElem ON TrA_TrEId = TrE_TrEID&#xD;
	JOIN CDN.TraNag ON TrE_TrNId = TrN_TrNID&#xD;
WHERE&#xD;
	TrN_TypDokumentu IN (-1,302,305)&#xD;
	AND TrN_Bufor&lt;&gt;-1&#xD;
	AND TrE_Aktywny&lt;&gt;0&#xD;
	AND TrN_DataOpe BETWEEN @DATAOD AND @DATADO&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Zasobów&#xD;
DECLARE @atrybutyZas varchar(max);&#xD;
DECLARE @atrybutyZas2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in &#xD;
(&#xD;
SELECT DISTINCT TsC_Cecha1_DeAId FROM CDN.TraSElemCechy&#xD;
    join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
    join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
    WHERE TrE_TypDokumentu IN (306,312)&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha2_DeAId FROM CDN.TraSElemCechy&#xD;
    join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
    join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
    WHERE TrE_TypDokumentu IN (306,312)&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha3_DeAId FROM CDN.TraSElemCechy&#xD;
    join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
    join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
    WHERE TrE_TypDokumentu IN (306,312)&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha4_DeAId FROM CDN.TraSElemCechy&#xD;
    join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
    join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
    WHERE TrE_TypDokumentu IN (306,312)&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha5_DeAId FROM CDN.TraSElemCechy&#xD;
    join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
    join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
    WHERE TrE_TypDokumentu IN (306,312)&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha6_DeAId FROM CDN.TraSElemCechy&#xD;
    join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
    join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
    WHERE TrE_TypDokumentu IN (306,312)&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha7_DeAId FROM CDN.TraSElemCechy&#xD;
    join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
    join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
    WHERE TrE_TypDokumentu IN (306,312)&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha8_DeAId FROM CDN.TraSElemCechy&#xD;
    join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
    join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
    WHERE TrE_TypDokumentu IN (306,312)&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha9_DeAId FROM CDN.TraSElemCechy&#xD;
    join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
    join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
    WHERE TrE_TypDokumentu IN (306,312)&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha10_DeAId FROM CDN.TraSElemCechy&#xD;
    join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
    join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
    WHERE TrE_TypDokumentu IN (306,312)&#xD;
)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TsC_TrSID &#xD;
INTO #tmpZasAtr &#xD;
FROM CDN.TraSElemCechy&#xD;
join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
WHERE TrE_TypDokumentu IN (306,312) &#xD;
&#xD;
SET @atrybutyZas = ''&#xD;
SET @atrybutyZas2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
       IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
       IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
       --cechy dla zasobów&#xD;
       SET @sqlA = N'ALTER TABLE #tmpZasAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
       EXEC(@sqlA)    &#xD;
       --cechy dla zasobów&#xD;
       SET @sqlA = N'UPDATE #tmpZasAtr&#xD;
             SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = &#xD;
             CASE&#xD;
                WHEN ATR.TsC_Cecha1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha1_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha1_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha2_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha2_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha3_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha3_Wartosc END END &#xD;
                WHEN ATR.TsC_Cecha4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha4_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha4_Wartosc END END &#xD;
                WHEN ATR.TsC_Cecha5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha5_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha5_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha6_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha6_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha6_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha6_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha7_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha7_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha7_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha7_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha8_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha8_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha8_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha8_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha9_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha9_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha9_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha9_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha10_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha10_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha10_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha10_Wartosc END END&#xD;
             ELSE ''(NIEPRZYPISANE)'' END&#xD;
             FROM CDN.TraSElemCechy ATR &#xD;
             JOIN #tmpZasAtr TM ON ATR.TsC_TrSID = TM.TsC_TrSID&#xD;
             WHERE ATR.TsC_Cecha1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha6_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha7_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha8_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha9_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha10_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
       EXEC(@sqlA)    &#xD;
 &#xD;
    --atrbuty zasobów&#xD;
    SET @atrybutyZas = @atrybutyZas + N', ISNULL(ZasAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Zasoby Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyZas2 = @atrybutyZas2 + N', ''(NIEPRZYPISANE)'' [Zasoby Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    &#xD;
       FETCH NEXT FROM atrybut_cursor&#xD;
       INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seriaTmp]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
	&#xD;
--Tworzenie tabelki pomocniczej do liczenia marży&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seriaTmp,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seriaTmp),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun], &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj], &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],  &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],&#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
     TR.Tre_Lp [Produkt Lp.],&#xD;
    CASE WHEN TR.TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    CASE WHEN sub.TrS_Ilosc IS NULL THEN TR.TrE_WartoscNetto ELSE TR.TrE_WartoscNetto*(sub.TrS_Ilosc/ISNULL(TR.TrE_Ilosc,1.0)) END [Sprzedaż Wartość], &#xD;
    CASE WHEN sub.TrS_Ilosc IS NULL THEN TR.TrE_WartoscBrutto ELSE TR.TrE_WartoscBrutto*(sub.TrS_Ilosc/ISNULL(TR.TrE_Ilosc,1.0)) END [Sprzedaż Wartość Brutto], &#xD;
    CASE WHEN sub.TrS_Ilosc IS NULL THEN TR.TrE_WartoscNettoWal ELSE TR.TrE_WartoscNettoWal*(sub.TrS_Ilosc/ISNULL(TR.TrE_Ilosc,1.0)) END [Sprzedaż Wartość Waluta], &#xD;
    CASE WHEN sub.TrS_Ilosc IS NULL THEN TR.TrE_Ilosc ELSE sub.TrS_Ilosc END [Sprzedaż Ilość], &#xD;
    (CASE WHEN sub.TrS_Ilosc IS NULL THEN 1 ELSE (sub.TrS_Ilosc/ISNULL(TR.TrE_Ilosc,1.0)) END) * &#xD;
    ((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi))  [Koszt Zakupu], &#xD;
    (CASE WHEN sub.TrS_Ilosc IS NULL THEN 1 ELSE (sub.TrS_Ilosc/ISNULL(TR.TrE_Ilosc,1.0)) END) * &#xD;
    (TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)))  [Sprzedaż Marża],&#xD;
    (CASE WHEN sub.TrS_Ilosc IS NULL THEN 1 ELSE (sub.TrS_Ilosc/ISNULL(TR.TrE_Ilosc,1.0)) END) * &#xD;
    (TR.TrE_Ilosc * (TR.TrE_CenaWWD - (TR.TrE_Cena0WD/TR.TrE_JMPrzelicznikL*TR.TrE_JMPrzelicznikM)) * TR.TrE_KursL / TR.TrE_KursM)  [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy] &#xD;
    ,(CASE WHEN sub.TrS_Ilosc IS NULL THEN 1 ELSE (sub.TrS_Ilosc/ISNULL(TR.TrE_Ilosc,1.0)) END) * &#xD;
    (CAST(TR.TrE_Ilosc/(Twr_JMPrzelicznikL/Twr_JMPrzelicznikM) AS Decimal(26,10))) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,TR.Tre_Lp [Produkt Pozycja Dokumentu]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok] &#xD;
    &#xD;
    &#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
                                                                                                 &#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz + @atrybutyZas&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TR.TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TR.TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TR.TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TR.TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TR.TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TR.TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TR.TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TR.TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TR.TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TR.TrE_TrEId&#xD;
     LEFT JOIN (&#xD;
        SELECT TrS_Ilosc, wze.TrE_Lp, wze.TrE_LpPow, TrR_FaId, trs_trsid&#xD;
            FROM CDN.TraSElem &#xD;
            JOIN cdn.TraElem WZE ON TrS_TrEId = wze.TrE_TrEID&#xD;
            JOIN cdn.Tranag WZ ON wz.trn_trnid = wze.TrE_TrnId &#xD;
            JOIN cdn.TraNagRelacje on trr_trnid = wz.trn_trnid AND trr_fatyp IN (302,305) AND trr_trntyp IN (306,312)&#xD;
     )sub on sub.TrR_FaId = trn.TrN_TrNID AND sub.TrE_LpPow = tr.tre_lppow&#xD;
     LEFT JOIN #tmpZasAtr ZasAtr ON sub.Trs_TrSId = ZasAtr.TsC_TrSID&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN (SELECT MAX(Tre_Lp) max FROM cdn.TraNag&#xD;
    LEFT JOIN cdn.TraElem ON TrE_TrNID = TrN_TrNID &#xD;
    WHERE TrN_TypDokumentu IN (-1, 302, 305) AND TrN_Bufor &lt;&gt; -1 AND TrE_Aktywny &lt;&gt; 0 AND TrE_UslugaZlozonaId = 0&#xD;
    AND TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)) TRELp ON 1 = 1&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TR.TrE_Aktywny&lt;&gt;0&#xD;
AND TR.TrE_UslugaZlozonaId = 0&#xD;
AND trn.TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seriaTmp,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seriaTmp),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],   &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod],    &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],             &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    NULL [Produkt Lp.],&#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary],     &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Produkt Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,NULL[Produkt Pozycja Dokumentu]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2 + @atrybutyZas2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN #tmpZasAtr ZasAtr ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	 &#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmppozatr&#xD;
DROP TABLE #tmpZasAtr&#xD;
                                                                                                         &#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jsd7hyuUyC8Sdgsl2n/BMjJgiNky53VdN6s+A30dZyDERDxjVxsQnjHChMl6Nve0YtI0skB0usVvB/MqySffaOuuZqCzq0pKnvsjpaKhxxPwZ/2+ghwDXEmC4OPJDAAQ9iKNBEB706qqf90ELy4akSOPWmjMA2j25</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut USŁUGA SERWISOWA" caption="Produkt Atrybut USŁUGA SERWISOWA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut USŁUGA SERWISOWA" caption="Pozycja Atrybut USŁUGA SERWISOWA" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data początkowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początkowa analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data końcowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data końcowa analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport umożliwia standardową analizę sprzedaży dla określonego podczas uruchamiania zakresu dat dokumentów sprzedaży. Raport zawiera atrybuty zasobów.</a:description><a:id>92</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.56 Raport sprzedaży w zakresie dat z atrybutami zasobów</a:mainLinkName><a:modifiedOn>2025-05-26T02:10:51.74</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2024-06-07T14:20:58.71</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
        SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
       &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
DECLARE @ROTyp INT&#xD;
SET @ROTyp = 308&#xD;
&#xD;
SELECT Trn_TRNID roid &#xD;
INTO #ROID&#xD;
FROM CDN.TraNag where TrN_TypDokumentu = @ROTyp&#xD;
&#xD;
SELECT &#xD;
        roid,&#xD;
        TrN_TypDokumentu, &#xD;
        TrN_TrNId id&#xD;
INTO #Powiaz FROM #ROID&#xD;
CROSS APPLY CDN.Powiazania (roid,@ROTyp)&#xD;
&#xD;
SET @select = '&#xD;
SELECT  &#xD;
BAZ.Baz_Nazwa                                                                                   AS [Baza Firmowa],&#xD;
TNRO.TrN_NumerPelny                                                                             AS [Dokument RO Numer],&#xD;
TNPOW.TrN_NumerPelny                                                                            AS [Dokument Powiązany Numer],&#xD;
Twr_Kod                                                                                         AS [Produkt Kod],&#xD;
Twr_Nazwa                                                                                       AS [Produkt Nazwa],&#xD;
DD.DDf_Symbol                                                                                   AS [Dokument Powiązany Symbol],&#xD;
CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END   AS [Produkt PKWiU],&#xD;
CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END                                        AS [Produkt Aktywny],&#xD;
Twr_JM                                                                                          AS [Produkt Jednostka Miary], &#xD;
ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'')                                                        AS [Produkt Jednostka Miary Pomocnicza],&#xD;
CAST(Twr_Opis as VARCHAR(1024))                                                                 AS [Produkt Opis],&#xD;
Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'')                                    AS [Produkt Waga KG],&#xD;
MG1.Mag_Symbol                                                                                  AS [Magazyn Źródłowy Kod],&#xD;
MG2.Mag_Symbol                                                                                  AS [Magazyn Docelowy Kod],&#xD;
    CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
END                                                                                             AS [Produkt Typ], &#xD;
TwC_Wartosc                                                                                     AS [Cena Domyślna], &#xD;
ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'')                                                            AS [Produkt Producent], &#xD;
ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'')                                                          AS [Produkt Marka],&#xD;
&#xD;
CASE tnro.TrN_eSklepZrodlo&#xD;
WHEN 0 THEN ''e-Sklep''&#xD;
WHEN 2 THEN ''Facebook''&#xD;
WHEN 3 THEN ''Allegro''&#xD;
WHEN 4 THEN ''wszytsko.pl''&#xD;
WHEN 5 THEN ''Comarch e-Sklep RWD''&#xD;
WHEN 6 THEN ''API''&#xD;
WHEN 7 THEN ''system ERP''&#xD;
WHEN 8 THEN ''eBay''&#xD;
WHEN 9 THEN ''Ceneo''&#xD;
WHEN 10 THEN ''Comarch e-Sklep wersja mobilna''&#xD;
WHEN 13 THEN ''Amazon''&#xD;
ELSE ''(NIEPRZYPISANE)'' END                                                                    AS [Rezerwacja Źródło],&#xD;
CASE TNro.TrN_ZwroconoCalaIlosc&#xD;
WHEN 1 THEN ''Pusty''&#xD;
WHEN 2 THEN ''W realizacji''&#xD;
WHEN 3 THEN ''Zrealizowano''&#xD;
WHEN 4 THEN ''Zamknięto''&#xD;
ELSE ''(BRAK)'' END                                                                             AS [Rezerwacja Status],&#xD;
PodRO.pod_kod                                                                                   AS [Rezerwacja Kontrahent Kod],&#xD;
PodRO.Pod_Nazwa1                                                                                AS [Rezerwacja Kontrahent Nazwa],&#xD;
PodPow.pod_kod                                                                                  AS [Dokument Powiązany Kontrahent Kod],&#xD;
PodPow.Pod_Nazwa1                                                                               AS [Dokument Powiązany Kontrahent Nazwa],&#xD;
&#xD;
--Miary&#xD;
Powiaz.Ilosc                AS [Dokument Powiazany Ilość],&#xD;
Powiaz.Brutto               AS [Dokument Powiazany Wartość Brutto],&#xD;
Powiaz.Netto                AS [Dokument Powiazany Wartość Netto],&#xD;
Powiaz.IloscJM              AS [Dokument Powiazany Ilość Jednostka Miary],&#xD;
&#xD;
ro.Ilosc                    AS [Dokument Rezerwacja Ilość],&#xD;
ro.Brutto                   AS [Dokument Rezerwacja Wartość Brutto],&#xD;
ro.Netto                    AS [Dokument Rezerwacja Wartość Netto],&#xD;
ro.IloscJM                  AS [Dokument Rezerwacja Ilość Jednostka Miary],&#xD;
&#xD;
TNRO.TRN_NumerObcy			AS [Dokument Rezerwacja Numer Zamówienia]&#xD;
--Daty Point&#xD;
/*&#xD;
,REPLACE(CONVERT(VARCHAR(10), TNRO.TrN_DataWys, 111), ''/'', ''-'')                                 AS [RO Data Wystawienia]&#xD;
,REPLACE(CONVERT(VARCHAR(10), TNPOW.TrN_DataWys, 111), ''/'', ''-'')                                AS [Powiązany Data Wystawienia]&#xD;
*/&#xD;
&#xD;
--Daty Analizy&#xD;
,REPLACE(CONVERT(VARCHAR(10), TNRO.TrN_DataWys, 111), ''/'', ''-'')                                 AS [Rezerwacja Data Wystawienia Dzień]&#xD;
,(datepart(DY, datediff(d, 0, TNRO.TrN_DataWys) / 7 * 7 + 3)+6) / 7                                 AS [Rezerwacja Data Wystawienia Tydzień Roku] &#xD;
,MONTH(TNRO.TrN_DataWys)                                                                            AS [Rezerwacja Data Wystawienia Miesiąc], &#xD;
DATEPART(quarter, TNRO.TrN_DataWys)                                                                 AS [Rezerwacja Data Wystawienia Kwartał], &#xD;
YEAR(TNRO.TrN_DataWys)                                                                              AS [Rezerwacja Data Wystawienia Rok]&#xD;
&#xD;
,REPLACE(CONVERT(VARCHAR(10), TNPOW.TrN_DataWys, 111), ''/'', ''-'')                                AS [Dokument Powiązany Data Wystawienia Dzień]&#xD;
,(datepart(DY, datediff(d, 0, TNPOW.TrN_DataWys) / 7 * 7 + 3)+6) / 7                                AS [Dokument Powiązany Data Wystawienia Tydzień Roku] &#xD;
,MONTH(TNPOW.TrN_DataWys)                                                                           AS [Dokument Powiązany Data Wystawienia Miesiąc], &#xD;
DATEPART(quarter, TNPOW.TrN_DataWys)                                                                AS [Dokument Powiązany Data Wystawienia Kwartał], &#xD;
YEAR(TNPOW.TrN_DataWys)                                                                             AS [Dokument Powiązany Data Wystawienia Rok]&#xD;
&#xD;
--Konteksty&#xD;
&#xD;
,25039 [Rezerwacja Numer __PROCID__RO__], TNRO.TrN_TrNId [Rezerwacja Numer __ORGID__],'''+@bazaFirmowa+''' [Rezerwacja Numer __DATABASE__]&#xD;
,20201 [Kontrahent Nazwa __PROCID__], PodRO.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
,20201 [Kontrahent Kod __PROCID__Kontrahenci__], PodRO.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
,25003 [Produkt Nazwa __PROCID__], Twr_TwrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
,25003 [Produkt Kod __PROCID__], Twr_TwrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
'&#xD;
+ @kolumny + @atrybuty + @atrybutyTwr  + @atrybutyDok +'&#xD;
FROM &#xD;
CDN.Towary&#xD;
 JOIN &#xD;
--DOK RO&#xD;
(SELECT&#xD;
    SUM(tRE_ILOSC) Ilosc,&#xD;
    SUM(tRE_WARTOSCNETTO) Brutto,&#xD;
    SUM(TrE_WartoscNetto) Netto,&#xD;
    SUM(TrE_IloscJM) IloscJM,&#xD;
    TrE_TwrId TowID,&#xD;
    ROID&#xD;
FROM #ROID&#xD;
LEFT JOIN cdn.TraElem ON Roid = Tre_trnid&#xD;
GROUP BY ROID,TrE_TwrId&#xD;
)Ro ON Twr_TwrId = RO.TowID &#xD;
 JOIN &#xD;
--dok Powiaz&#xD;
(&#xD;
SELECT &#xD;
id TransID,&#xD;
TrE_TwrId TowID,&#xD;
roid,&#xD;
SUM(tRE_ILOSC) Ilosc,&#xD;
SUM(tRE_WARTOSCNETTO) Brutto,&#xD;
SUM(TrE_WartoscNetto) Netto,&#xD;
SUM(TrE_IloscJM) IloscJM &#xD;
FROM #Powiaz &#xD;
LEFT JOIN cdn.Traelem ON id = Tre_trnid&#xD;
GROUP BY roid,tre_twrid,id)Powiaz ON Powiaz.towid = twr_twrid and Powiaz.roid = Ro.ROID&#xD;
&#xD;
  LEFT JOIN CDN.TraNag TNPOW ON Powiaz.TransID = TNPOW.TrN_TrNID&#xD;
  LEFT JOIN CDN.TraNag TNRO ON ro.ROID = TNRO.TrN_TrNID &#xD;
  LEFT JOIN CDN.DokDefinicje DD ON TNPOW.TrN_DDfId = DD.DDf_DDfID&#xD;
  LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
  LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
  LEFT JOIN CDN.Magazyny MG1 ON MG1.Mag_MagId = TNPOW.TrN_MagZrdId&#xD;
  LEFT JOIN CDN.Magazyny MG2 ON MG2.Mag_MagId  = TNPOW.TrN_MagDocId&#xD;
  LEFT JOIN cdn.podmiotyview PodRO on PodRO.Pod_PodId = TNRO.TrN_PodID and TNRO.TrN_PodmiotTyp = PodRO.Pod_PodmiotTyp&#xD;
  LEFT JOIN cdn.podmiotyview PodPow on PodPow.Pod_PodId = TNPOW.TrN_PodID and TNPOW.TrN_PodmiotTyp = PodPow.Pod_PodmiotTyp&#xD;
  LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
&#xD;
   LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
   LEFT JOIN #tmpKonAtr KonAtr1 ON PodRO.Pod_PodId = KonAtr1.KnA_PodmiotId AND PodRO.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
   LEFT JOIN #tmpDokAtr DokAtr ON TNRO.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
   LEFT JOIN #tmpTwrAtr TwrAtr ON Twr_TwrId  = TwrAtr.TwA_TwrId &#xD;
   LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
  '&#xD;
  print (@select)&#xD;
  exec (@select)&#xD;
&#xD;
DROP TABLE #ROID&#xD;
DROP TABLE #Powiaz&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROp TABLE #tmpDokAtr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jyra+Oe7op8+HEsrNKk/PEr8e3MQwxTfCJ7bJa+fXaVPqVpYiLhvx7Z/X9WBksnU/iT1mPYU64FmYuAu7pQVo8xPEjiH6H+REeQLBAzBcxY4oRyIN57+c8KXDp4kF4Wqe</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument RO Numer" caption="Dokument RO Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Numer" caption="Dokument Powiązany Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Symbol" caption="Dokument Powiązany Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary" caption="Produkt Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Waga KG" caption="Produkt Waga KG" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Źródłowy Kod" caption="Magazyn Źródłowy Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Docelowy Kod" caption="Magazyn Docelowy Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena Domyślna" caption="Cena Domyślna" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rezerwacja Źródło" caption="Rezerwacja Źródło" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rezerwacja Status" caption="Rezerwacja Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rezerwacja Kontrahent Kod" caption="Rezerwacja Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rezerwacja Kontrahent Nazwa" caption="Rezerwacja Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Kontrahent Kod" caption="Dokument Powiązany Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Kontrahent Nazwa" caption="Dokument Powiązany Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Powiazany Ilość" caption="Dokument Powiazany Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Powiazany Wartość Brutto" caption="Dokument Powiazany Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Powiazany Wartość Netto" caption="Dokument Powiazany Wartość Netto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Powiazany Ilość Jednostka Miary" caption="Dokument Powiazany Ilość Jednostka Miary" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Rezerwacja Ilość" caption="Dokument Rezerwacja Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Rezerwacja Wartość Brutto" caption="Dokument Rezerwacja Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Rezerwacja Wartość Netto" caption="Dokument Rezerwacja Wartość Netto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Rezerwacja Ilość Jednostka Miary" caption="Dokument Rezerwacja Ilość Jednostka Miary" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rezerwacja Data Wystawienia Dzień" caption="Rezerwacja Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rezerwacja Data Wystawienia Tydzień Roku" caption="Rezerwacja Data Wystawienia Tydzień Roku" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rezerwacja Data Wystawienia Miesiąc" caption="Rezerwacja Data Wystawienia Miesiąc" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rezerwacja Data Wystawienia Kwartał" caption="Rezerwacja Data Wystawienia Kwartał" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rezerwacja Data Wystawienia Rok" caption="Rezerwacja Data Wystawienia Rok" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Data Wystawienia Dzień" caption="Dokument Powiązany Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Data Wystawienia Tydzień Roku" caption="Dokument Powiązany Data Wystawienia Tydzień Roku" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Data Wystawienia Miesiąc" caption="Dokument Powiązany Data Wystawienia Miesiąc" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Data Wystawienia Kwartał" caption="Dokument Powiązany Data Wystawienia Kwartał" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Data Wystawienia Rok" caption="Dokument Powiązany Data Wystawienia Rok" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument RO Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dokument Powiązany Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dokument Powiazany Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Dokument Rezerwacja Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Dokument Powiazany Ilość" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Dokument Rezerwacja Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument RO Numer" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Dokument Powiązany Numer" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę Rezerwacji odbiorcy razem z wszystkimi powiązanymi do niech dokumentami.&#xD;
Pozycje z takimi samymi towarami ale innymi LP grupują się w jedną pozycje</a:description><a:id>93</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.58 Raport RO z dokumentami powiązanymi</a:mainLinkName><a:modifiedOn>2025-04-14T09:51:21.307</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>5</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2024-06-07T14:22:09.82</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Faktury nierozliczone z produktami&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'           &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Wyliczanie statusu rozliczenia&#xD;
--SELECT TrN_TrNId [NagID], &#xD;
--CASE &#xD;
--  WHEN Z.BZd_Rozliczono=1 AND Z.BZd_Rozliczono2=1 THEN 'Nierozliczony' &#xD;
--  WHEN Z.BZd_Rozliczono=2 THEN 'Rozliczony' &#xD;
--  WHEN Z.BZd_Rozliczono=1 AND Z.BZd_Rozliczono2=2 THEN 'Częściowo Rozliczony' &#xD;
--  WHEN (Z.BZd_Rozliczono=0 AND Z.BZd_Rozliczono2=0) OR TrN_BlokadaPlatnosci = 1 THEN 'Nie podlega'&#xD;
--  WHEN Z.BZd_Rozliczono=2 AND Z.BZd_Rozliczono2=2 THEN 'Rozliczany w całości'&#xD;
--ELSE '(BRAK)' END [StatusRoz]&#xD;
--INTO #tmpRozliczenia&#xD;
--FROM CDN.TraNag&#xD;
--JOIN(&#xD;
--  SELECT BZd_DokumentID, MIN(BZd_Rozliczono) [BZd_Rozliczono], MAX(BZd_Rozliczono2) [BZd_Rozliczono2]&#xD;
--  FROM CDN.BnkZdarzenia&#xD;
--  WHERE BZd_DokumentTyp = 1&#xD;
--  GROUP BY BZd_DokumentID&#xD;
--)Z ON Z.BZd_DokumentID = TrN_TrNID&#xD;
SELECT TrN_TrNId [NagID], &#xD;
CASE&#xD;
    WHEN Z.Rozliczono &lt; 10 OR TrN_BlokadaPlatnosci = 1 THEN 'Nie podlega'  &#xD;
    WHEN Z.Rozliczono &lt; 100 THEN 'Rozliczony' &#xD;
    WHEN Z.Rozliczono &lt; 1000 THEN 'Częściowo Rozliczony' &#xD;
    WHEN Z.Rozliczono % 1000 &lt;&gt; 0 THEN 'Częściowo Rozliczony' &#xD;
    WHEN Z.Rozliczono &lt; 10000 THEN 'Nierozliczony' &#xD;
ELSE '(BRAK)' END [StatusRoz]&#xD;
INTO #tmpRozliczenia&#xD;
FROM CDN.TraNag&#xD;
JOIN(&#xD;
    SELECT BZd_DokumentID, &#xD;
    SUM(CASE&#xD;
        WHEN BZd_Rozliczono = 0 THEN 1   &#xD;
        WHEN BZd_Rozliczono = 2 THEN 10&#xD;
        WHEN BZd_Rozliczono = 1 AND BZd_Rozliczono2 = 2 THEN 100&#xD;
        WHEN BZd_Rozliczono = 1 AND BZd_Rozliczono2 = 1 THEN 1000&#xD;
    END) [Rozliczono]&#xD;
    FROM CDN.BnkZdarzenia&#xD;
    WHERE BZd_DokumentTyp = 1&#xD;
    GROUP BY BZd_DokumentID&#xD;
)Z ON Z.BZd_DokumentID = TrN_TrNID&#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
SELECT count(tre_treid) ilosc, tre_trnid trnid INTO #TmpIlosci FROM cdn.Traelem WHERE Tre_TypDokumentu IN (-1,302,305) GROUP BY tre_trnid&#xD;
&#xD;
--Tworzenie tabelki pomocniczej do liczenia marży&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
DECLARE @select VARCHAR(MAX), @select2 VARCHAR(MAX);&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3) &#xD;
Set @Wal = cdn.Waluta('''')&#xD;
    SELECT count(tre_treid) ilosc ,tre_trnid trnid INTO #tmpIlosci FROM cdn.Traelem WHERE  Tre_TypDokumentu IN (-1,302,305) GROUP BY tre_trnid&#xD;
&#xD;
SELECT &#xD;
    --Wymiary&#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    F.TrN_NumerPelny [Dokument Numer],  &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(F.TrN_NumerPelny,0,CHARINDEX(''/'',F.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(F.TrN_NumerPelny,CHARINDEX(''/'',F.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(F.TrN_Opis,''''),''(BRAK)'') [Dokument Opis], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(NULLIF(F.TrN_Waluta, ''''), @Wal) [Dokument Waluta], &#xD;
    ISNULL(Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna], ISNULL(Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa],    &#xD;
    knt.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    knt.Pod_Nazwa1 + knt.Pod_Nazwa2 [Kontrahent Pierwotny Nazwa], &#xD;
    ISNULL(NULLIF(knt.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto], &#xD;
    ISNULL(NULLIF(knt.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj],&#xD;
    ISNULL(NULLIF(knt.Pod_NIP, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP], &#xD;
    ISNULL(NULLIF(knt.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(knt.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa],&#xD;
    odb.Pod_Kod [Odbiorca Kod], &#xD;
    odb.Pod_Nazwa1 + odb.Pod_Nazwa2 [Odbiorca Nazwa],   &#xD;
    ISNULL(NULLIF(odb.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Miasto], &#xD;
    ISNULL(NULLIF(odb.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Kraj], &#xD;
    ISNULL(NULLIF(odb.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(odb.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    CASE &#xD;
        WHEN opk.Knt_OpiekunTyp = 3 THEN ISNULL(opp.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN opk.Knt_OpiekunTyp = 8 THEN ISNULL(op.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE opk.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN Z2.DokRoz&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Dokument Rozliczający Numer],&#xD;
    ISNULL(StatusRoz, ''Nie dotyczy'') [Status Rozliczenia],    &#xD;
    ''(NIEPRZYPISANY)'' as [Zakład Symbol],&#xD;
    ''(NIEPRZYPISANY)'' as [Zakład Nazwa Firmy], &#xD;
    --Miary&#xD;
    Tre_WartoscNetto [Sprzedaż Wartość], Tre_WartoscBrutto[Sprzedaż Wartość Brutto], &#xD;
    KosztWyliczony.Koszt/zc.walc/ilosc [Koszt Zakupu], (F.TrN_RazemNetto - KosztWyliczony.Koszt)/zc.walc/ilosc [Sprzedaż Marża], F.TrN_RabatWartosc/zc.walc/ilosc [Sprzedaż Rabat],&#xD;
    Tre_WartoscNettoWal [Sprzedaż Wartość Waluta], Tre_WartoscBruttoWal [Sprzedaż Wartość Brutto Waluta],   &#xD;
    CASE WHEN F.TrN_Rodzaj IN (302001,302002,302005,302007,302091,302092,302101,302102,305001,305005,305101) THEN&#xD;
    -1*NULLIF(ISNULL((Z.BZd_KwotaSys - Z.BZd_KwotaRozSys - Z.BZd_KwotaNPSys)/ilosc, F.TrN_RazemBrutto/ilosc),0)&#xD;
    ELSE NULLIF(ISNULL((Z.BZd_KwotaSys - Z.BZd_KwotaRozSys - Z.BZd_KwotaNPSys)/ilosc, F.TrN_RazemBrutto/ilosc),0) END [Kwota Nierozliczona], &#xD;
    NULLIF(ISNULL((Z.BZd_Kwota - Z.BZd_KwotaRoz - Z.BZd_KwotaNP)/ilosc, F.TrN_RazemBruttoWal/ilosc),0) [Kwota Nierozliczona Waluta],&#xD;
    NULL [Kwota Rozliczona], NULL [Kwota Rozliczona Waluta], Z.BZd_KwotaNPSys /ilosc [Kwota Nie Podlega], Z.BZd_KwotaNP/ilosc [Kwota Nie Podlega Waluta],&#xD;
    ISNULL(NULLIF(Z.wal, ''''), @Wal) [Rozliczenie Waluta],&#xD;
    CASE &#xD;
        WHEN StatusRoz = ''Nie podlega'' THEN NULL&#xD;
        WHEN StatusRoz &lt;&gt; ''Rozliczony'' THEN CASE WHEN DATEDIFF(DAY,F.TrN_Termin,GETDATE()) &lt; 0 THEN 0 ELSE DATEDIFF(DAY,F.TrN_Termin,GETDATE()) /ilosc END&#xD;
        ELSE NULL&#xD;
    END [Liczba Dni Przeterminowania],&#xD;
    &#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis],&#xD;
    Twr_Jm [Jednostka Miary], &#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ]&#xD;
&#xD;
/*  &#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Sprzedaży]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN REPLACE(CONVERT(VARCHAR(10), Z2.BZd_DataRoz, 111), ''/'', ''-'')&#xD;
            END [Data Rozliczenia]&#xD;
            ,REPLACE(CONVERT(VARCHAR(10), F.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Sprzedaży Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, F.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Sprzedaży Tydzień Roku], MONTH(F.TrN_DataOpe) [Data Sprzedaży Miesiąc]&#xD;
    ,DATEPART(quarter, F.TrN_DataOpe) [Data Sprzedaży Kwartał], YEAR(F.TrN_DataOpe) [Data Sprzedaży Rok]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN REPLACE(CONVERT(VARCHAR(10), Z2.BZd_DataRoz, 111), ''/'', ''-'')&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Dzień]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN CONVERT(VARCHAR(10), MONTH(Z2.BZd_DataRoz))&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Miesiąc]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN CONVERT(VARCHAR(10), DATEPART(quarter, Z2.BZd_DataRoz))&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Kwartał]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN CONVERT(VARCHAR(10), YEAR(Z2.BZd_DataRoz))&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN F.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], F.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], knt.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__], '''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], knt.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], odb.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], odb.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    &#xD;
    &#xD;
    ' + @atrybuty + @atrybutyDok&#xD;
     &#xD;
SET @select2 = ' &#xD;
FROM &#xD;
    CDN.TraNag F&#xD;
    LEFT JOIN Cdn.TraElem te ON F.Trn_trnid = Tre_trnid&#xD;
    LEFT JOIN #TmpIlosci ON F.Trn_Trnid = trnid&#xD;
    JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
    LEFT JOIN #tmpSeria ser ON F.TrN_DDfId = DDf_DDfID&#xD;
    LEFT JOIN CDN.DokDefinicje dd ON F.TrN_DDfId = dd.DDf_DDfID &#xD;
    JOIN CDN.PodmiotyView knt ON F.TrN_PodID = knt.Pod_PodId AND F.TrN_PodmiotTyp = knt.Pod_PodmiotTyp&#xD;
    JOIN CDN.PodmiotyView odb ON F.TrN_OdbID = odb.Pod_PodId AND F.TrN_OdbiorcaTyp = odb.Pod_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci opk ON F.TrN_PodID = opk.Knt_KntId AND F.TrN_PodmiotTyp = 1&#xD;
    LEFT JOIN cdn.PodmiotyView opp ON opk.Knt_OpiekunId = opp.Pod_PodId AND opk.Knt_OpiekunTyp = opp.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt2 ON F.TrN_OdbId = knt2.Knt_KntId AND F.TrN_OdbiorcaTyp = 1&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op ON opk.Knt_OpiekunId = op.Ope_OpeId AND opk.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON F.TrN_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON F.TrN_OpeModID = mod.Ope_OpeId&#xD;
    LEFT JOIN CDN.Kategorie ON F.TrN_KatID = Kat_KatID&#xD;
    LEFT JOIN CDN.FormyPlatnosci ON F.TrN_FPlId = FPl_FPlId&#xD;
    LEFT JOIN (&#xD;
        SELECT Bzd_Waluta wal, BZd_DokumentID, SUM(BZd_KwotaSys) [BZd_KwotaSys], SUM(BZd_KwotaRozSys) [BZd_KwotaRozSys], SUM(BZd_Kwota) [BZd_Kwota], SUM(BZd_KwotaRoz) [BZd_KwotaRoz],&#xD;
        SUM(CASE WHEN BzD_Rozliczono = 0 THEN BZd_KwotaSys ELSE 0 END) [BZd_KwotaNPSys], SUM(CASE WHEN BzD_Rozliczono = 0 THEN BZd_Kwota ELSE 0 END) [BZd_KwotaNP]&#xD;
        FROM CDN.BnkZdarzenia&#xD;
        WHERE BZd_DokumentTyp = 1 &#xD;
        GROUP BY BZd_DokumentID, BZd_Waluta&#xD;
    )Z ON Z.BZd_DokumentID = F.TrN_TrNID&#xD;
        LEFT JOIN (&#xD;
        SELECT COUNT(Bzd_Waluta) walc, BZd_DokumentID&#xD;
        FROM CDN.BnkZdarzenia&#xD;
        WHERE BZd_DokumentTyp = 1&#xD;
        GROUP BY BZd_DokumentID&#xD;
    )ZC ON ZC.BZd_DokumentID = F.TrN_TrNID&#xD;
    LEFT JOIN (&#xD;
        SELECT BZd_DokumentID, MAX(BZd_DataRoz) [BZd_DataRoz], COUNT(L.BRK_BRKID) + COUNT(P.BRK_BRKID) [LZD], &#xD;
        MAX(CASE WHEN BZd_BZdID = L.BRK_LDokID THEN L.BRK_PNumer ELSE P.BRK_LNumer END) [DokRoz]&#xD;
        FROM CDN.BnkZdarzenia&#xD;
        LEFT JOIN CDN.BnkRozKwoty L ON BZd_BZdID = L.BRK_LDokID AND L.BRK_LDokTyp = 1&#xD;
        LEFT JOIN CDN.BnkRozKwoty P ON BZd_BZdID = P.BRK_PDokID AND P.BRK_PDokTyp = 1&#xD;
        WHERE BZd_DokumentTyp = 1&#xD;
        GROUP BY BZd_DokumentID&#xD;
    )Z2 ON Z2.BZd_DokumentID = F.TrN_TrNID&#xD;
    LEFT JOIN #tmpRozliczenia ON NagId = F.TrN_trNID&#xD;
    LEFT JOIN #tmpKonAtr KonAtr ON knt.Pod_PodId = KonAtr.KnA_PodmiotId AND knt.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
    LEFT JOIN #tmpDokAtr DokAtr ON F.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
    LEFT JOIN CDN.TraNag P ON F.TrN_FaId = P.TrN_TrNID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on knt.Pod_GlID = pod5.Pod_PodId and knt.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = te.TrE_TrEID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE &#xD;
    F.TrN_TypDokumentu IN (-1,302,305)&#xD;
    AND F.TrN_Rodzaj &lt;&gt; 302100&#xD;
    AND F.TrN_Rodzaj &lt;&gt; 305100&#xD;
    AND F.TrN_Bufor&lt;&gt;-1&#xD;
    AND ISNULL(P.TrN_TypDokumentu,302) &lt;&gt; 305&#xD;
    '&#xD;
PRINT(@select + @select2)&#xD;
EXEC(@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpRozliczenia&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #TmpIlosci&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jsBAYdvQ29HofTNaFuS3ZWJXhmmD0VSRKZTB8y7MnGL8mkbsMJu8U3D2OQ66M7cfudFAgk2nJ6fQBJHi0cOXOszEDXd452d2LdUELSp2JCz2wMJDjM5dccop4X+TWMZP9</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Waluta" caption="Dokument Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna" caption="Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa" caption="Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Rozliczający Numer" caption="Dokument Rozliczający Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Status Rozliczenia" caption="Status Rozliczenia" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto Waluta" caption="Sprzedaż Wartość Brutto Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nierozliczona" caption="Kwota Nierozliczona" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nierozliczona Waluta" caption="Kwota Nierozliczona Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Rozliczona" caption="Kwota Rozliczona" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Rozliczona Waluta" caption="Kwota Rozliczona Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nie Podlega" caption="Kwota Nie Podlega" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nie Podlega Waluta" caption="Kwota Nie Podlega Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozliczenie Waluta" caption="Rozliczenie Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania" caption="Liczba Dni Przeterminowania" type="measure" formatString="n0" aggregate="Average" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Dzień" caption="Data Sprzedaży Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Tydzień Roku" caption="Data Sprzedaży Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Miesiąc" caption="Data Sprzedaży Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Kwartał" caption="Data Sprzedaży Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Sprzedaży Rok" caption="Data Sprzedaży Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Dzień" caption="Data Rozliczenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Miesiąc" caption="Data Rozliczenia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Kwartał" caption="Data Rozliczenia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Rok" caption="Data Rozliczenia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut TEST" caption="Kontrahent Pierwotny Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut TEST" caption="Kontrahent Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOSZT" caption="Dokument Atrybut KOSZT" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOLOR" caption="Dokument Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut CENA ATRYB" caption="Dokument Atrybut CENA ATRYB" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROWIZJA" caption="Dokument Atrybut PROWIZJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut MONTER KOSZT (K)" caption="Dokument Atrybut MONTER KOSZT (K)" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAUAAAAHAAAABwIVW0tvbnRyYWhlbnQgTmF6d2FdLltdBwIjW0tvbnRyYWhlbnQgTmF6d2FdLltBRE0gc3AuIHogby5vLl0HAipbS29udHJhaGVudCBOYXp3YV0uW0YuSC4gQUxPWkEgc3AuIHogby5vLl0HAiJbS29udHJhaGVudCBOYXp3YV0uW0YuSC5VLiBNQVJJWkFdBwIiW0tvbnRyYWhlbnQgTmF6d2FdLltTb2Z0bGFuZCBzLmMuXQcCH1tLb250cmFoZW50IE5hendhXS5bVEVSUkEgcy5jLl0HAiZbS29udHJhaGVudCBOYXp3YV0uW1R3w7NqIE9ncsOzZCBzLmMuXRoAAAAHAhVbS29udHJhaGVudCBOYXp3YV0uW10HAh1bRG9rdW1lbnQgTnVtZXJdLltGUy8xMi8yMDI0XQcCFVtLb250cmFoZW50IE5hendhXS5bXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZTLzIxLzIwMjRdBwIjW0tvbnRyYWhlbnQgTmF6d2FdLltBRE0gc3AuIHogby5vLl0HAh1bRG9rdW1lbnQgTnVtZXJdLltGUy8xMS8yMDIzXQcCI1tLb250cmFoZW50IE5hendhXS5bQURNIHNwLiB6IG8uby5dBwIdW0Rva3VtZW50IE51bWVyXS5bRlMvMjgvMjAyM10HAiNbS29udHJhaGVudCBOYXp3YV0uW0FETSBzcC4geiBvLm8uXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZTLzI5LzIwMjRdBwIqW0tvbnRyYWhlbnQgTmF6d2FdLltGLkguIEFMT1pBIHNwLiB6IG8uby5dBwIdW0Rva3VtZW50IE51bWVyXS5bRlMvMTMvMjAyM10HAipbS29udHJhaGVudCBOYXp3YV0uW0YuSC4gQUxPWkEgc3AuIHogby5vLl0HAh1bRG9rdW1lbnQgTnVtZXJdLltGUy8xNi8yMDIzXQcCKltLb250cmFoZW50IE5hendhXS5bRi5ILiBBTE9aQSBzcC4geiBvLm8uXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZTLzE5LzIwMjNdBwIqW0tvbnRyYWhlbnQgTmF6d2FdLltGLkguIEFMT1pBIHNwLiB6IG8uby5dBwIdW0Rva3VtZW50IE51bWVyXS5bRlMvMjYvMjAyM10HAipbS29udHJhaGVudCBOYXp3YV0uW0YuSC4gQUxPWkEgc3AuIHogby5vLl0HAh1bRG9rdW1lbnQgTnVtZXJdLltGUy8yNy8yMDIzXQcCKltLb250cmFoZW50IE5hendhXS5bRi5ILiBBTE9aQSBzcC4geiBvLm8uXQcCH1tEb2t1bWVudCBOdW1lcl0uW0ZTS09SLzEvMjAyM10HAiJbS29udHJhaGVudCBOYXp3YV0uW0YuSC5VLiBNQVJJWkFdBwIcW0Rva3VtZW50IE51bWVyXS5bRlMvMS8yMDIzXQcCIltLb250cmFoZW50IE5hendhXS5bRi5ILlUuIE1BUklaQV0HAh1bRG9rdW1lbnQgTnVtZXJdLltGUy8xMi8yMDIzXQcCIltLb250cmFoZW50IE5hendhXS5bRi5ILlUuIE1BUklaQV0HAh1bRG9rdW1lbnQgTnVtZXJdLltGUy8xNS8yMDIzXQcCIltLb250cmFoZW50IE5hendhXS5bRi5ILlUuIE1BUklaQV0HAhxbRG9rdW1lbnQgTnVtZXJdLltGUy8yLzIwMjNdBwIiW0tvbnRyYWhlbnQgTmF6d2FdLltTb2Z0bGFuZCBzLmMuXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZTLzEwLzIwMjNdBwIiW0tvbnRyYWhlbnQgTmF6d2FdLltTb2Z0bGFuZCBzLmMuXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZTLzIyLzIwMjNdBwIiW0tvbnRyYWhlbnQgTmF6d2FdLltTb2Z0bGFuZCBzLmMuXQcCH1tEb2t1bWVudCBOdW1lcl0uW0ZTS09SLzMvMjAyM10HAh9bS29udHJhaGVudCBOYXp3YV0uW1RFUlJBIHMuYy5dBwIdW0Rva3VtZW50IE51bWVyXS5bRlMvMTQvMjAyM10HAh9bS29udHJhaGVudCBOYXp3YV0uW1RFUlJBIHMuYy5dBwIdW0Rva3VtZW50IE51bWVyXS5bRlMvMjMvMjAyM10HAh9bS29udHJhaGVudCBOYXp3YV0uW1RFUlJBIHMuYy5dBwIdW0Rva3VtZW50IE51bWVyXS5bRlMvMjUvMjAyM10HAh9bS29udHJhaGVudCBOYXp3YV0uW1RFUlJBIHMuYy5dBwIcW0Rva3VtZW50IE51bWVyXS5bRlMvNC8yMDIzXQcCH1tLb250cmFoZW50IE5hendhXS5bVEVSUkEgcy5jLl0HAhxbRG9rdW1lbnQgTnVtZXJdLltGUy81LzIwMjNdBwIfW0tvbnRyYWhlbnQgTmF6d2FdLltURVJSQSBzLmMuXQcCH1tEb2t1bWVudCBOdW1lcl0uW0ZTS09SLzIvMjAyM10HAiZbS29udHJhaGVudCBOYXp3YV0uW1R3w7NqIE9ncsOzZCBzLmMuXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZTLzE4LzIwMjNdBwImW0tvbnRyYWhlbnQgTmF6d2FdLltUd8OzaiBPZ3LDs2Qgcy5jLl0HAhxbRG9rdW1lbnQgTnVtZXJdLltGUy8zLzIwMjNd/////wAAAAAAAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Status Rozliczenia"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość Brutto"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Kwota Nierozliczona"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Liczba Dni Przeterminowania"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n0" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Produkt Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Wartość Brutto" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Kwota Nierozliczona" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Liczba Dni Przeterminowania" index="3" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Nazwa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Nazwa" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Status Rozliczenia" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;included&gt;&lt;value uniqueName="Nierozliczony" /&gt;&lt;/included&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje nierozliczone faktury wraz z ich pozycjami&#xD;
&#xD;
Kwoty nierozliczone dla danego dokumentu są równo podzielone przez pozycje</a:description><a:id>94</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.59 Faktury nierozliczone z produktami</a:mainLinkName><a:modifiedOn>2025-05-22T18:22:11.383</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2024-09-17T17:29:29.417</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Kontrahentów&#xD;
* Wersja raportu: 35.0&#xD;
* Wersja baz OPTIMY: 2025.0000&#xD;
* Wersja aplikacji OPTIMA: 2025.0.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj in (312000,312008) AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
                           INTO #KosztZakupu&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308,301 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
&#xD;
DECLARE @select VARCHAR(MAX);&#xD;
DECLARE @select2 VARCHAR(MAX);&#xD;
&#xD;
--Wyliczenie miar sprzedaży dla kontrahentów&#xD;
SELECT&#xD;
knt.Knt_KntId [knt_id],&#xD;
sum(TR.TrE_WartoscNetto) [sprzedazWartosc],&#xD;
sum(TR.TrE_Ilosc ) [ilosc],&#xD;
sum(TR.TrE_WartoscBrutto) [sprzedazWartoscBrutto],&#xD;
sum(TR.TrE_WartoscNettoWal) [sprzedazWartoscWaluta],&#xD;
sum(TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi))) marza&#xD;
INTO #tmpKntSprz&#xD;
&#xD;
FROM cdn.Kontrahenci knt&#xD;
left join cdn.tranag trn ON trn.TrN_PodID=Knt_KntId  AND TrN_PodmiotTyp = 1&#xD;
left join cdn.TraElem TR ON TR.TrE_TrNID=trn.TrN_TrNID &#xD;
LEFT JOIN #KosztZakupu KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID &#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
--AND TrE_Aktywny&lt;&gt;0&#xD;
--AND TrE_UslugaZlozonaId = 0&#xD;
GROUP BY Knt_KntId&#xD;
&#xD;
&#xD;
set @select = &#xD;
' &#xD;
SELECT&#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
knt_nazwa1 [Kontrahent Nazwa], &#xD;
knt_kod [Kontrahent Kod],&#xD;
reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
CASE WHEN g.id IS NULL THEN ''Nie'' ELSE ''Tak'' END [Kontrahent ze Sprzedażą/Zakupem],&#xD;
CASE Knt_Nieaktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Kontrahent Aktywny],&#xD;
DB_NAME()+''_''+convert(Varchar(10),knt_PodmiotTyp)+''_''+convert(Varchar(10),Knt_KntId)  [Liczba Kontrahentów],&#xD;
CASE WHEN g.id IS NULL THEN NULL ELSE sprzedazWartosc END [Sprzedaż Wartość Suma],&#xD;
CASE WHEN g.id IS NULL THEN NULL ELSE ilosc END [Sprzedaż Ilość Suma],&#xD;
CASE WHEN g.id IS NULL THEN NULL ELSE sprzedazWartoscBrutto END [Sprzedaż Wartość Brutto Suma],&#xD;
CASE WHEN g.id IS NULL THEN NULL ELSE sprzedazWartoscWaluta END [Sprzedaż Wartość Waluta Suma],&#xD;
CASE WHEN g.id IS NULL THEN NULL ELSE marza END [Sprzedaż Marża Suma],&#xD;
NULL [Pierwsza Sprzedaż Wartość],&#xD;
NULL [Pierwsza Sprzedaż Ilość],&#xD;
NULL [Pierwsza Sprzedaż Wartość Brutto],&#xD;
NULL [Pierwsza Sprzedaż Wartość Waluta],&#xD;
NULL [Pierwsza Sprzedaż Marża],&#xD;
NULL [Produkt Dostawca], &#xD;
NULL [Produkt Kod],&#xD;
NULL [Produkt EAN],&#xD;
NULL [Produkt Kod Dostawcy],&#xD;
zal.Ope_Kod [Operator Wprowadzający], &#xD;
mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
/*&#xD;
--------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Pierwszej Operacji] &#xD;
,REPLACE(CONVERT(VARCHAR(10), ostatnia, 111), ''/'', ''-'') [Data Ostatniej Operacji]&#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Pierwszej Operacji Dzień] &#xD;
,(datepart(DY, datediff(d, 0, pierwsza) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, pierwsza)*/ [Data Pierwszej Operacji Tydzień Roku]&#xD;
,MONTH(pierwsza) [Data Pierwszej Operacji Miesiąc], DATEPART(quarter, pierwsza) [Data Pierwszej Operacji Kwartał], YEAR(pierwsza) [Data Pierwszej Operacji Rok] &#xD;
,REPLACE(CONVERT(VARCHAR(10), ostatnia, 111), ''/'', ''-'') [Data Ostatniej Operacji Dzień]&#xD;
,(datepart(DY, datediff(d, 0, ostatnia) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Ostatniej Operacji Tydzień Roku]&#xD;
,MONTH(ostatnia) [Data Ostatniej Operacji Miesiąc], DATEPART(quarter, ostatnia) [Data Ostatniej Operacji Kwartał], YEAR(ostatnia) [Data Ostatniej Operacji Rok]&#xD;
,GETDATE() [Data Analizy]&#xD;
----------KONTEKSTY&#xD;
,20201 [Kontrahent Nazwa __PROCID__], Knt_KntId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
,20201 [Kontrahent Kod __PROCID__Kontrahenci__], Knt_KntId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
&#xD;
'&#xD;
&#xD;
set @select2 = &#xD;
'&#xD;
&#xD;
from cdn.kontrahenci &#xD;
&#xD;
Left join&#xD;
(&#xD;
Select distinct &#xD;
TrN_PodID [id],&#xD;
MIN(TrN_DataOpe) OVER(PARTITION BY TrN_PodID) AS pierwsza, &#xD;
MAX(TrN_DataOpe) OVER(PARTITION BY TrN_PodID) AS ostatnia  &#xD;
from&#xD;
cdn.tranag  WHERE TrN_TypDokumentu IN (302,305) AND TRN_Bufor = 0&#xD;
GROUP BY TrN_PodID,TrN_DataOpe) g ON g.id = Knt_KntID&#xD;
left join #tmpKntSprz a ON Knt_KntID = a.knt_id&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON Knt_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON Knt_OpeModID = mod.Ope_OpeId&#xD;
&#xD;
&#xD;
UNION ALL &#xD;
&#xD;
SELECT  &#xD;
&#xD;
BAZ.Baz_Nazwa  [Baza Firmowa],&#xD;
KNT.knt_nazwa1 [Kontrahent Nazwa], &#xD;
KNT.knt_kod [Kontrahent Kod],&#xD;
reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE KNT.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
''Tak''  [Kontrahent ze Sprzedażą/Zakupem],&#xD;
CASE KNT.Knt_Nieaktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Kontrahent Aktywny],&#xD;
DB_NAME()+''_''+convert(Varchar(10),KNT.knt_PodmiotTyp)+''_''+convert(Varchar(10),KNT.Knt_KntId)  [Liczba Kontrahentów],&#xD;
NULL [Sprzedaż Wartość Suma],&#xD;
NULL [Sprzedaż Ilość Suma],&#xD;
NULL [Sprzedaż Wartość Brutto Suma],&#xD;
NULL [Sprzedaż Wartość Waluta Suma],&#xD;
NULL [Sprzedaż Marża Suma],&#xD;
TrE_WartoscNetto [Pierwsza Sprzedaż Wartość],&#xD;
TrE_Ilosc [Pierwsza Sprzedaż Ilość],&#xD;
TrE_WartoscBrutto [Pierwsza Sprzedaż Wartość Brutto],&#xD;
TrE_WartoscNettoWal [Pierwsza Sprzedaż Wartość Waluta],&#xD;
TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Pierwsza Sprzedaż Marża],&#xD;
ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
Twr_Kod [Produkt Kod],&#xD;
ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy],&#xD;
zal.Ope_Kod [Operator Wprowadzający], &#xD;
mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
/*&#xD;
--------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Pierwszej Operacji] &#xD;
,REPLACE(CONVERT(VARCHAR(10), ostatnia, 111), ''/'', ''-'') [Data Ostatniej Operacji]&#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Pierwszej Operacji Dzień] &#xD;
,(datepart(DY, datediff(d, 0, pierwsza) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, pierwsza)*/ [Data Pierwszej Operacji Tydzień Roku]&#xD;
,MONTH(pierwsza) [Data Pierwszej Operacji Miesiąc], DATEPART(quarter, pierwsza) [Data Pierwszej Operacji Kwartał], YEAR(pierwsza) [Data Pierwszej Operacji Rok] &#xD;
,REPLACE(CONVERT(VARCHAR(10), ostatnia, 111), ''/'', ''-'') [Data Ostatniej Operacji Dzień]&#xD;
,(datepart(DY, datediff(d, 0, ostatnia) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Ostatniej Operacji Tydzień Roku]&#xD;
,MONTH(ostatnia) [Data Ostatniej Operacji Miesiąc], DATEPART(quarter, ostatnia) [Data Ostatniej Operacji Kwartał], YEAR(ostatnia) [Data Ostatniej Operacji Rok]&#xD;
,GETDATE() [Data Analizy]&#xD;
----------KONTEKSTY&#xD;
,20201 [Kontrahent Nazwa __PROCID__], KNT.Knt_KntId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
,20201 [Kontrahent Kod __PROCID__Kontrahenci__], KNT.Knt_KntId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
&#xD;
FROM &#xD;
(&#xD;
SELECT Trn_trnid id, MIN(TrN_DataOpe) OVER(PARTITION BY TrN_PodID) AS pierwsza, MAX(TrN_DataOpe) OVER(PARTITION BY TrN_PodID) AS ostatnia  &#xD;
FROM CDN.Tranag WHERE TrN_TypDokumentu IN (302,305) AND TRN_Bufor = 0)x &#xD;
JOIN cdn.tranag ON id = TrN_TrNID and pierwsza = TrN_DataOpe&#xD;
left join cdn.TraElem TR ON TR.TrE_TrNID=TrN_TrNID &#xD;
LEFT JOIN cdn.Kontrahenci KNT ON TrN_PodID=KNT.Knt_KntId  AND TrN_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT JOIN #KosztZakupu KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON knt4.Knt_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON knt4.Knt_OpeModID = mod.Ope_OpeId&#xD;
'&#xD;
&#xD;
print (@select + @select2)&#xD;
exec (@select + @select2)&#xD;
&#xD;
drop table #tmpKntSprz&#xD;
Drop Table #KosztZakupu&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5vCxSmgondMfdtmo6sliIgTWPbj17BviVUXyPzdkotJkq7igEVPx67QBSiMcx5zyeTJgrs/t+z/BIjq9oHQl3dL1vDiIZ84Ys7b36fBxBgdA</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Dzień" caption="Data Pierwszej Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Tydzień Roku" caption="Data Pierwszej Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Miesiąc" caption="Data Pierwszej Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Kwartał" caption="Data Pierwszej Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Rok" caption="Data Pierwszej Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Dzień" caption="Data Ostatniej Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Tydzień Roku" caption="Data Ostatniej Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Miesiąc" caption="Data Ostatniej Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Kwartał" caption="Data Ostatniej Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Rok" caption="Data Ostatniej Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent ze Sprzedażą/Zakupem" caption="Kontrahent ze Sprzedażą/Zakupem" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAANAAAABwIVW0tvbnRyYWhlbnQgTmF6d2FdLltdBwIjW0tvbnRyYWhlbnQgTmF6d2FdLltBRE0gc3AuIHogby5vLl0HAipbS29udHJhaGVudCBOYXp3YV0uW0YuSC4gQUxPWkEgc3AuIHogby5vLl0HAiJbS29udHJhaGVudCBOYXp3YV0uW0YuSC5VLiBNQVJJWkFdBwIlW0tvbnRyYWhlbnQgTmF6d2FdLltIYWxpbmFNYWxpbm93c2thXQcCIVtLb250cmFoZW50IE5hendhXS5bS293YWxza2kgSmFuXQcCIVtLb250cmFoZW50IE5hendhXS5bTWFyZWsgS29sYXNhXQcCIltLb250cmFoZW50IE5hendhXS5bU29mdGxhbmQgcy5jLl0HAh9bS29udHJhaGVudCBOYXp3YV0uW1RFUlJBIHMuYy5dBwIjW0tvbnRyYWhlbnQgTmF6d2FdLltURVNUIFBMIFcgRVVST10HAh5bS29udHJhaGVudCBOYXp3YV0uW1RFU1QgVU5JQV0HAhxbS29udHJhaGVudCBOYXp3YV0uW3Rlc3QxMjNdBwImW0tvbnRyYWhlbnQgTmF6d2FdLltUd8OzaiBPZ3LDs2Qgcy5jLl3/////AAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Pierwsza Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Pierwsza Sprzedaż Marża"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Data Pierwszej Operacji Dzień"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Pierwsza Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Pierwsza Sprzedaż Marża" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Nazwa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Data Pierwszej Operacji Dzień" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport przedstawia pierwszy zakup danego kontrahenta</a:description><a:id>95</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.60 Pierwszy zakup kontrahenta</a:mainLinkName><a:modifiedOn>2025-04-14T09:47:55.893</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport>29</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2024-10-10T14:09:44.987</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży z paragonami przekształconymi do faktur&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @select4 varchar(max)&#xD;
declare @select5 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
		  ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
		END    &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
	SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'   &#xD;
	SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
		  ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
		END&#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
		 ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
		END	 &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
	SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
		 ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
		END	 &#xD;
		FROM CDN.TraElemAtr ATR &#xD;
		JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
		WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
	SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
	 WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
	 WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
	 WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
	 WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
	END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
&#xD;
SELECT SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TNFS.TrN_TrNID TransId&#xD;
INTO #tmpKosztyGraniczne&#xD;
FROM cdn.tranag TNKG&#xD;
JOIN cdn.traelem TEKG ON TEKG.tre_trnid = TNKG.TrN_TrNID&#xD;
JOIN cdn.Tranag TNFZ ON TNFZ.Trn_trnid = TNKG.TrN_ZwrId&#xD;
JOIN cdn.TranagRelacje ON TNFZ.Trn_trnid = TrR_TrNId&#xD;
    AND TrR_FaTyp IN (&#xD;
        302&#xD;
        ,305&#xD;
        )&#xD;
JOIN cdn.Tranag TNFS ON TNFS.TrN_TrNID = TrR_FaId&#xD;
JOIN cdn.TraElem TEFS ON TNFS.trn_trnid = TEFS.TrE_TrNId&#xD;
    AND TEKG.TrE_Lp = TEFS.TrE_LpPow&#xD;
WHERE TNKG.trn_rodzaj IN (&#xD;
        301008&#xD;
        ,301009&#xD;
        ,301018&#xD;
        )&#xD;
GROUP BY TEFS.TrE_TrEID&#xD;
    ,TNFS.TrN_TrNID&#xD;
&#xD;
&#xD;
	--Tworzenie tabelki pomocniczej do liczenia marży&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
	trn.TrN_NumerPelny [Dokument Numer],&#xD;
	ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
	dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
	CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
	CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
	ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
	ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
	ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
	&#xD;
	pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
	pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
		ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
	ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
	ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
	CASE knt1.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Kontrahent Pierwotny Opiekun],&#xD;
	&#xD;
	reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
	(CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
	&#xD;
	DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
	pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
	pod5.Pod_Kod [Kontrahent Kod], &#xD;
	ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
	ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
	ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
	CASE knt3.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Kontrahent Opiekun],&#xD;
&#xD;
	CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
	&#xD;
	reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
	(CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
	&#xD;
	DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
	pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
	pod3.Pod_Kod [Odbiorca Kod], &#xD;
	ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
	ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
	ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
	CASE knt2.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Odbiorca Opiekun],&#xD;
	zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
	DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
	ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
	Twr_Nazwa [Produkt Nazwa],&#xD;
	CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
	TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
	CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
	ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
	CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
	KCN_Kod [Produkt Kod CN],&#xD;
	Twr_Kod [Produkt Kod], &#xD;
	Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
	Tre_Lp [Produkt Lp.],&#xD;
	CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
	&#xD;
	Mag_Symbol [Magazyn Nazwa],&#xD;
	ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
	CASE &#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	END [Produkt Typ],&#xD;
	CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
	CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
	CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
		THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Tydzień],&#xD;
	CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
	CASE &#xD;
		WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
		WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Miesiąc Poprzedni],&#xD;
	&#xD;
	TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
	(CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
	TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
	TrE_Ilosc * (TrE_Cena0 - ([TrE_CenaW]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] ,&#xD;
	ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
	ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
	ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
	,TrE_Cena0 AS [Cena początkowa]&#xD;
	,TrE_CenaW AS [Cena transakcyjna]&#xD;
	,CAST(TR.TrE_Ilosc/(Twr_JMPrzelicznikL/Twr_JMPrzelicznikM) AS DECIMAL(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
	,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
	,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
	   ,ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) [Waluta Koszt Zakupu]&#xD;
    ,ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / (KursZakL/KursZakM),TR.TrE_KosztUslugi)[Koszt Zakupu Waluta]&#xD;
&#xD;
	/*&#xD;
	----------DATY POINT&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
	*/&#xD;
	----------DATY ANALIZY&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
	,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
	,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
	,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
	,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
	----------KONTEKSTY&#xD;
	,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
	,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
	,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
	,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
	,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
	,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
	,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
	,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
	,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
	,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
	 LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
	 LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
	 left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
	 LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
	 LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
	 LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
	 LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
	 LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
	 LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
	 LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
	 LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
	 LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
	 LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TreId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TreId,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TreId = TR.TrE_Treid&#xD;
	LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
	LEFT JOIN #tmpKosztyGraniczne ON ElemId = TR.Tre_Treid&#xD;
	    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
AND TR.Tre_treid NOT IN (SELECT e1.tre_treid&#xD;
FROM cdn.traNag t1 &#xD;
	JOIN cdn.traelem e1 on e1.tre_trnid = t1.trn_trnid&#xD;
	 JOIN cdn.TraNag t2 ON t1.trn_Faid = t2.trn_trnid &#xD;
     JOIN cdn.TraElem e2 ON e2.TrE_TrNID=t2.TrN_TrNID  and e2.TrE_LpPow = E1.TrE_LpPow  AND e2.TrE_TwrId = e1.TrE_TwrId&#xD;
	 WHERE&#xD;
t2.TrN_TypDokumentu = 302 and t1.TrN_TypDokumentu = 305)&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
	TrN_NumerPelny [Dokument Numer],&#xD;
	ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
	dd.DDf_Symbol [Dokument Symbol],&#xD;
	CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
	CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
	ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
	ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
	ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
	&#xD;
	pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
	pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
	ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
	ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
	ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
	CASE knt1.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
	reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
	(CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
	DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
	pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
	pod5.Pod_Kod [Kontrahent Kod], &#xD;
	ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
	ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
	ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
	CASE knt3.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Kontrahent Opiekun],&#xD;
&#xD;
	CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
	reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
	(CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
	&#xD;
	DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
	pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
	pod3.Pod_Kod [Odbiorca Kod], &#xD;
	ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
	ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
	ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
	CASE knt2.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Odbiorca Opiekun],&#xD;
&#xD;
	zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
	null  [Liczba Produktów], &#xD;
	''(PUSTA)'' [Produkt Kategoria],&#xD;
	&#xD;
	''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
	''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
	''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
	''(BRAK)'' [Produkt PKWiU], &#xD;
	''(BRAK)'' [Produkt Dostawca],&#xD;
	''(BRAK)'' [Produkt Aktywny],&#xD;
	''(BRAK)'' [Produkt Kod CN],&#xD;
	''Korekta zbiorcza'' [Produkt Kod],   	&#xD;
	''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy],&#xD;
	NULL [Produkt Lp.],&#xD;
	''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
	&#xD;
	''(BRAK)'' [Magazyn Nazwa], &#xD;
	''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
	CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
	CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
	CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
		THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Tydzień],&#xD;
	CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
	CASE &#xD;
		WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
		WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Miesiąc Poprzedni],&#xD;
	TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
	0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
	TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
	''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
	''(BRAK)'' [Produkt EAN],&#xD;
	''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
	,NULL AS [Cena początkowa]&#xD;
	,NULL AS [Cena transakcyjna]&#xD;
	,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
	,NULL [Produkt Pozycja Dokumentu]&#xD;
	,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
	   ,NULL [Waluta Koszt Zakupu]&#xD;
    ,NULL [Koszt Zakupu Waluta]&#xD;
&#xD;
	/*&#xD;
	----------DATY POINT&#xD;
	,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
	,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
	*/&#xD;
	----------DATY ANALIZY&#xD;
	,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
	,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
	,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
	,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
	,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
	,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
	----------KONTEKSTY&#xD;
	,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
	,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
	,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
	,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
	,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
	,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
	,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
	,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
	,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
	,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
	 LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
	 LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
	 	 LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
	 LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
	 LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
	 LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
	 LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
	 LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
	 LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
	 lEFT JOIN (SELECT  sum(KosztyGraniczne) AS KosztyGraniczne, TransID FROM #tmpKosztyGraniczne GROUP BY TransId)KosztyGran ON Trn_Trnid = TransID &#xD;
	     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
		&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
UNION ALL &#xD;
'&#xD;
set @select4 =&#xD;
&#xD;
'&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
	trn.TrN_NumerPelny [Dokument Numer],&#xD;
	ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
	dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
	CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
	CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
	ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
	ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
	ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
	&#xD;
	pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
	pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
		ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
	ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
	ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
	CASE knt1.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Kontrahent Pierwotny Opiekun],&#xD;
	&#xD;
	reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
	(CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
	(CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
	&#xD;
	DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
	pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
	pod5.Pod_Kod [Kontrahent Kod], &#xD;
	ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
	ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
	ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
	CASE knt3.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Kontrahent Opiekun],&#xD;
&#xD;
	CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
	&#xD;
	reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
	(CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
	(CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
	&#xD;
	DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
	pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
	pod3.Pod_Kod [Odbiorca Kod], &#xD;
	ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
	ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
	ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
	CASE knt2.Knt_OpiekunTyp&#xD;
		WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
		WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
		ELSE ''(NIEPRZYPISANE)'' &#xD;
	END [Odbiorca Opiekun],&#xD;
	zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
	DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
	ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
	Twr_Nazwa [Produkt Nazwa],&#xD;
	CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
	TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
	CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
	ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
	CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
	KCN_Kod [Produkt Kod CN],&#xD;
	Twr_Kod [Produkt Kod], &#xD;
	Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
	TR.Tre_Lp [Produkt Lp.],&#xD;
	CASE WHEN TR.TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
	&#xD;
	Mag_Symbol [Magazyn Nazwa],&#xD;
	ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
	CASE &#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
		WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
		WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	END [Produkt Typ],&#xD;
	CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
	CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
	CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
		THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Tydzień],&#xD;
	CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
	CASE &#xD;
		WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
		WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
		ELSE ''NIE'' &#xD;
	END [Czas Aktualny Miesiąc Poprzedni],&#xD;
	&#xD;
	TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
	(CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
	TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
	TR.TrE_Ilosc * (TR.TrE_Cena0 - (TR.TrE_CenaW/TR.TrE_JMPrzelicznikL*TR.TrE_JMPrzelicznikM)) * TR.TrE_KursL / TR.TrE_KursM [Sprzedaż Rabat] ,&#xD;
	ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
	ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
	ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
	,TR.TrE_Cena0 AS [Cena początkowa]&#xD;
	,TR.TrE_CenaW AS [Cena transakcyjna]&#xD;
	,CAST(TR.TrE_Ilosc/(Twr_JMPrzelicznikL/Twr_JMPrzelicznikM) AS DECIMAL(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
	,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
	,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
	   ,ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) [Waluta Koszt Zakupu]&#xD;
    ,ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / (KursZakL/KursZakM),TR.TrE_KosztUslugi)[Koszt Zakupu Waluta]&#xD;
&#xD;
&#xD;
	/*&#xD;
	----------DATY POINT&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
	*/&#xD;
&#xD;
	----------DATY ANALIZY&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
	,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
	,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
	,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
	,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
	,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
	,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
	----------KONTEKSTY&#xD;
	,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
	,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
	,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
	,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
	,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
	,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
	,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
	,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
	,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
	,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
	&#xD;
'+ @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
       &#xD;
set @select5 = &#xD;
' FROM cdn.traNag t1 &#xD;
	JOIN cdn.traelem e1 on e1.tre_trnid = t1.trn_trnid&#xD;
	 JOIN cdn.TraNag trn ON t1.trn_Faid = trn.trn_trnid &#xD;
     JOIN cdn.TraElem TR ON TR.TrE_TrNID=trn.TrN_TrNID  AND TR.tre_lppow = e1.Tre_lppow&#xD;
	 LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
	 LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
	 &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(t1.Trn_PodID,TR.TrE_PodID)=knt1.Knt_KntId AND ISNULL(trn.Trn_PodmiotTyp,TR.TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(t1.Trn_PodID,TR.TrE_PodID)= pod1.Pod_PodId AND ISNULL(trn.Trn_PodmiotTyp,TR.TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
	 LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
	 LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TR.TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TR.TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TR.TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
	 LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
	 LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
	 LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
	 LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
	 LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
	 LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TR.TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
	 LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TR.TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
	 LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
  LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TreId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TreId,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TreId = e1.TrE_Treid&#xD;
	LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
	LEFT JOIN #tmpKosztyGraniczne ON ElemId = TR.Tre_Treid&#xD;
	    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu = 302 and t1.TrN_TypDokumentu = 305&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
&#xD;
AND TR.TrE_UslugaZlozonaId = 0&#xD;
'&#xD;
print (@select + @select2 + @select3+ @select4 + @select5)&#xD;
exec (@select + @select2 + @select3+ @select4 + @select5)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmppozatr&#xD;
DROP TABLE #tmpKosztyGraniczne&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jzDwJgFJoAzREF9NpiTvD7JPaMMU+LfS6ewgmq9kAP6qcqvE25r7AOePFN3U68zd3f4ZCU/uYVcSX601vEYGiZ7T3be4TMftfLMkcbDZWuSOUcEuJiTAnk9R9Z5uxqTmH</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut TEST" caption="Kontrahent Pierwotny Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut TEST" caption="Kontrahent Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut TEST" caption="Odbiorca Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOSZT" caption="Dokument Atrybut KOSZT" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOLOR" caption="Dokument Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut CENA ATRYB" caption="Dokument Atrybut CENA ATRYB" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROWIZJA" caption="Dokument Atrybut PROWIZJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut MONTER KOSZT (K)" caption="Dokument Atrybut MONTER KOSZT (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut CENA2" caption="Produkt Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TESTZAS" caption="Produkt Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DIETA" caption="Produkt Atrybut DIETA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut CENA2" caption="Pozycja Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut TESTZAS" caption="Pozycja Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DIETA" caption="Pozycja Atrybut DIETA" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wUAAAAHAhZbRG9rdW1lbnQgU3ltYm9sXS5bRlNdBwIZW0Rva3VtZW50IFN5bWJvbF0uW0ZTREVUXQcCGVtEb2t1bWVudCBTeW1ib2xdLltGU0tPUl0HAhZbRG9rdW1lbnQgU3ltYm9sXS5bUEFdBwIZW0Rva3VtZW50IFN5bWJvbF0uW1BBREVUXQ==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dokument Symbol"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość Brutto"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Marża"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Wartość Brutto" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Marża" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Dokument Symbol" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport bazuje na raporcie wzorcowym sprzedaży. W przypadku paragonów przekształconych do faktur wyświetlać będzie się faktura a paragon nie będzie brany pod uwagę&#xD;
W przypadku paragonów częściowo przekształconych, elementy nie dodane na faktury będą wciąż wyświetlać sie jako elementy paragonu</a:description><a:id>96</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.61 Sprzedaż z paragonami przekształconymi do faktur</a:mainLinkName><a:modifiedOn>2025-05-26T02:08:54.113</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-28T17:27:40.433</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
/* RAPORT_INFO &#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
DECLARE   /* ZMIENNE POMOCNICZE */&#xD;
		 @wersja			 FLOAT		  = (SELECT CONVERT(FLOAT  ,SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
		,@serwerKonf		 VARCHAR(MAX) = (SELECT CONVERT(VARCHAR,SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
		,@bazaKonf			 VARCHAR(MAX) = (SELECT CONVERT(VARCHAR,SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
		,@bazaFirmowa		 VARCHAR(MAX) = (SELECT CONVERT(VARCHAR,SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
		,@Bazy				 VARCHAR(MAX)&#xD;
		,@Operatorzy		 VARCHAR(MAX)&#xD;
		,@WalutaSys			 VARCHAR(3)	  = cdn.Waluta('')&#xD;
		,@SQLPaczka1_Kolumny NVARCHAR(MAX)&#xD;
		,@SQLPaczka1_Tabele  NVARCHAR(MAX)&#xD;
		,@SQLPaczka2_Kolumny NVARCHAR(MAX)&#xD;
		,@SQLPaczka2_Tabele  NVARCHAR(MAX);&#xD;
	SET @Bazy		= '['+@serwerKonf+'].['+@bazaKonf+'].[CDN].[Bazy]' &#xD;
	SET @Operatorzy = '['+@serwerKonf+'].['+@bazaKonf+'].[CDN].[Operatorzy]' &#xD;
	&#xD;
/* TABELE POMOCNICZE */&#xD;
BEGIN /* #tmpTwrGr			 - tabela pomocnicza z poziomami grup produktów	*/ &#xD;
	WITH g (gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
	AS (SELECT TwG_TwGID,TwG_GIDTyp,TwG_Kod,TwG_GIDNumer,TwG_GrONumer,0 AS poziom,convert(NVARCHAR(1024), '') AS sciezka&#xD;
	      FROM CDN.TwrGrupy&#xD;
	     WHERE TwG_TwGID = 0&#xD;
	    UNION ALL&#xD;
	    SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod,TwG_GIDNumer,TwG_GrONumer,p.poziom + 1 AS poziom,convert(NVARCHAR(1024), p.sciezka + N'\' + c.TwG_Kod) AS sciezka&#xD;
	      FROM g p&#xD;
	      JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer&#xD;
	      WHERE c.TwG_TwGID &lt;&gt; 0&#xD;
	        AND c.TwG_GIDTyp = - 16&#xD;
	    )&#xD;
	SELECT * INTO #tmpTwrGr FROM g&#xD;
	&#xD;
	DECLARE  @poziom	 INT&#xD;
			,@poziom_max INT&#xD;
			,@sql		 NVARCHAR(MAX);&#xD;
	&#xD;
	SET @poziom_max = (SELECT MAX(poziom) FROM #tmpTwrGr)&#xD;
	SET @poziom		= @poziom_max&#xD;
	SET @sql		= N''&#xD;
	&#xD;
	WHILE @poziom &gt;= 0&#xD;
	BEGIN&#xD;
	    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50), ONr' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50)'&#xD;
	    EXEC (@sql)&#xD;
	&#xD;
	    IF @poziom = @poziom_max&#xD;
			BEGIN&#xD;
			    SET @sql = N'UPDATE #tmpTwrGr SET ONr' + CAST(@poziom AS NVARCHAR) + '= grONumer '&#xD;
			    EXEC (@sql)&#xD;
	&#xD;
			    SET @sql = N'UPDATE #tmpTwrGr SET Poziom' + CAST(@poziom AS NVARCHAR) + ' = kod'&#xD;
			    EXEC (@sql)&#xD;
			END&#xD;
	    ELSE&#xD;
			BEGIN&#xD;
				SET @sql = N'UPDATE c SET c.Poziom' + CAST(@poziom AS NVARCHAR) + N' = (CASE &#xD;
							WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.kod AS nvarchar)&#xD;
				            ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				        FROM #tmpTwrGr c&#xD;
				        LEFT JOIN #tmpTwrGr p ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
		        EXEC (@sql)&#xD;
	&#xD;
				SET @sql = N'UPDATE c SET c.ONr' + CAST(@poziom AS NVARCHAR) + N' = (CASE &#xD;
							WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
							ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
						FROM #tmpTwrGr c&#xD;
						LEFT JOIN #tmpTwrGr p ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
				EXEC (@sql)&#xD;
		    END&#xD;
	&#xD;
	    SET @poziom = @poziom - 1&#xD;
	END&#xD;
&#xD;
	DECLARE  @kolumny	VARCHAR(max) = ''&#xD;
			,@i			INT = 0;&#xD;
	&#xD;
	WHILE (@i &lt;= @poziom_max)&#xD;
		BEGIN&#xD;
		    SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = IIF(Poz.Poziom'+LTRIM(@i)+' IS NULL,''(NIEPRZYPISANE)'',Poz.Poziom'+LTRIM(@i)+')'&#xD;
		    SET @i = @i + 1&#xD;
		END&#xD;
END&#xD;
BEGIN /* #tmpKonAtr			 - tabela pomocnicza z atrybutami kontrahentów	*/ &#xD;
	DECLARE  @atrybut_id	 INT&#xD;
			,@atrybut_kod	 NVARCHAR(50)&#xD;
			,@atrybut_typ	 INT&#xD;
			,@atrybut_format INT&#xD;
			,@atrybuty		 NVARCHAR(MAX)&#xD;
			,@sqlA			 NVARCHAR(MAX);&#xD;
			&#xD;
	SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
		SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
	FROM CDN.DefAtrybuty&#xD;
	WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
	AND DeA_Format &lt;&gt; 5'&#xD;
	&#xD;
	IF @wersja &gt;= 2013&#xD;
	    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
	&#xD;
	EXEC (@sqlA)&#xD;
	&#xD;
	OPEN atrybut_cursor;&#xD;
	&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
	&#xD;
	SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp&#xD;
	INTO #tmpKonAtr&#xD;
	FROM CDN.KntAtrybuty&#xD;
	&#xD;
	SET @atrybuty = ''&#xD;
	&#xD;
	WHILE @@FETCH_STATUS = 0&#xD;
		BEGIN&#xD;
			IF @atrybut_typ = 1&#xD;
				BEGIN&#xD;
					SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
				END&#xD;
	&#xD;
			IF @atrybut_typ = 4&#xD;
				BEGIN&#xD;
					SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
				END&#xD;
	&#xD;
			SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
			EXEC (@sqlA)&#xD;
	&#xD;
			SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
						SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
						  ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
						END    &#xD;
						FROM CDN.KntAtrybuty ATR &#xD;
						JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
						WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
			EXEC (@sqlA)&#xD;
	&#xD;
			SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.['  + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
			SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut '			 + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
			SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.['  + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut '			 + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
		&#xD;
			FETCH NEXT FROM atrybut_cursor&#xD;
			INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
		END&#xD;
	&#xD;
	CLOSE atrybut_cursor;	&#xD;
	DEALLOCATE atrybut_cursor;&#xD;
END&#xD;
BEGIN /* #tmpDokAtr			 - tabela pomocnicza z atrybutami dokumentów	*/ &#xD;
	DECLARE @atrybutyDok VARCHAR(max);&#xD;
&#xD;
	SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
				SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
				FROM CDN.DefAtrybuty&#xD;
				WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
				AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
	IF @wersja &gt;= 2013&#xD;
		SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
	EXEC (@sqlA)&#xD;
&#xD;
	OPEN atrybut_cursor;&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
	SELECT DISTINCT DAt_TrNId&#xD;
	INTO #tmpDokAtr&#xD;
	FROM CDN.DokAtrybuty&#xD;
&#xD;
	SET @atrybutyDok = ''&#xD;
	&#xD;
	WHILE @@FETCH_STATUS = 0&#xD;
		BEGIN&#xD;
			IF @atrybut_typ = 2&#xD;
				BEGIN&#xD;
					SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
				END&#xD;
&#xD;
			IF @atrybut_typ = 1&#xD;
				BEGIN&#xD;
					SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
				END&#xD;
&#xD;
			SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
			EXEC (@sqlA)&#xD;
&#xD;
			SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
						SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
						ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
						END&#xD;
						FROM CDN.DokAtrybuty ATR &#xD;
						JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
						WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
			EXEC (@sqlA)&#xD;
&#xD;
			SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
			FETCH NEXT FROM atrybut_cursor&#xD;
			INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
		END&#xD;
&#xD;
	CLOSE atrybut_cursor;&#xD;
	DEALLOCATE atrybut_cursor;&#xD;
END&#xD;
BEGIN /* #tmpTwrAtr			 - tabela pomocnicza z atrybutami towarów		*/ &#xD;
	DECLARE  @atrybutyTwr  VARCHAR(MAX)&#xD;
			,@atrybutyTwr2 VARCHAR(MAX);&#xD;
&#xD;
	SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
				SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
				FROM CDN.DefAtrybuty&#xD;
				WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
				AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
	IF @wersja &gt;= 2013&#xD;
		SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
	EXEC (@sqlA)&#xD;
&#xD;
	OPEN atrybut_cursor;&#xD;
&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
	SELECT DISTINCT TwA_TwrId&#xD;
	INTO #tmpTwrAtr&#xD;
	FROM CDN.TwrAtrybuty&#xD;
&#xD;
	SET @atrybutyTwr = ''&#xD;
	SET @atrybutyTwr2 = ''&#xD;
&#xD;
	WHILE @@FETCH_STATUS = 0&#xD;
		BEGIN&#xD;
			IF @atrybut_typ = 2&#xD;
				BEGIN&#xD;
					SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
				END&#xD;
&#xD;
			IF @atrybut_typ = 4&#xD;
				BEGIN&#xD;
				    SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
				END&#xD;
&#xD;
			SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
			EXEC (@sqlA)&#xD;
&#xD;
			SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
						SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
						ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
						END  &#xD;
						FROM CDN.TwrAtrybuty ATR &#xD;
						JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
						WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
			EXEC (@sqlA)&#xD;
&#xD;
			SET @atrybutyTwr  = @atrybutyTwr  + N', ISNULL(TwrAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
			SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
			FETCH NEXT FROM atrybut_cursor&#xD;
			INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
		END&#xD;
	CLOSE atrybut_cursor;&#xD;
	DEALLOCATE atrybut_cursor;&#xD;
END&#xD;
BEGIN /* #tmpPozAtr			 - tabela pomocnicza z atrybutami pozycji		*/ &#xD;
	DECLARE	 @atrybutyPoz  VARCHAR(MAX)&#xD;
			,@atrybutyPoz2 VARCHAR(MAX);&#xD;
&#xD;
	SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
					SELECT	 DeA_DeAId&#xD;
							,REPLACE(DeA_Kod, '']'', ''_'')&#xD;
							,DeA_Typ&#xD;
							,DeA_Format&#xD;
					  FROM	CDN.DefAtrybuty&#xD;
					 WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
					   AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
	IF @wersja &gt;= 2013&#xD;
	    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
	EXEC (@sqlA)&#xD;
&#xD;
	OPEN atrybut_cursor;&#xD;
	&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
	&#xD;
	SELECT DISTINCT TrA_TrEId&#xD;
	INTO #tmpPozAtr&#xD;
	FROM CDN.TraElemAtr&#xD;
	&#xD;
	SET @atrybutyPoz = ''&#xD;
	SET @atrybutyPoz2 = ''&#xD;
	&#xD;
	WHILE @@FETCH_STATUS = 0&#xD;
	BEGIN&#xD;
	    IF @atrybut_typ = 2&#xD;
	    BEGIN&#xD;
	        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
	    END&#xD;
	&#xD;
	    IF @atrybut_typ = 4&#xD;
	    BEGIN&#xD;
	        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
	    END&#xD;
	&#xD;
	    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
	    EXEC (@sqlA)&#xD;
	&#xD;
	    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
	        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
	         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
	        END  &#xD;
	        FROM CDN.TraElemAtr ATR &#xD;
	        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
	        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
	    EXEC (@sqlA)&#xD;
	&#xD;
	    SET @atrybutyPoz  = @atrybutyPoz + N', ISNULL(PozAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
	    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
	&#xD;
	    FETCH NEXT FROM atrybut_cursor&#xD;
	    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
	END&#xD;
	&#xD;
	CLOSE atrybut_cursor;&#xD;
	DEALLOCATE atrybut_cursor;&#xD;
END&#xD;
BEGIN /* #tmpSeria			 - tabela pomocnicza z serią dokumentów			*/ &#xD;
	SELECT	 DDf_DDfID&#xD;
			,[seria] = CASE &#xD;
				WHEN DDf_Numeracja LIKE '@rejestr%' THEN 5&#xD;
				WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
				WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
				WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
				WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
				END &#xD;
	  INTO #tmpSeria&#xD;
	  FROM CDN.DokDefinicje&#xD;
END&#xD;
BEGIN /* #tmpKosztyGraniczne - tabela pomocnicza 							*/ &#xD;
	SELECT SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
			,TEFS.TrE_TrEID ElemId&#xD;
			,TNFS.TrN_TrNID TransId&#xD;
	INTO #tmpKosztyGraniczne&#xD;
	FROM cdn.tranag			TNKG&#xD;
	JOIN cdn.traelem		TEKG ON TEKG.tre_trnid = TNKG.TrN_TrNID&#xD;
	JOIN cdn.Tranag			TNFZ ON TNFZ.Trn_trnid = TNKG.TrN_ZwrId&#xD;
	JOIN cdn.TranagRelacje		 ON TNFZ.Trn_trnid = TrR_TrNId AND TrR_FaTyp IN (302,305)&#xD;
	JOIN cdn.Tranag			TNFS ON TNFS.TrN_TrNID = TrR_FaId&#xD;
	JOIN cdn.TraElem		TEFS ON TNFS.trn_trnid = TEFS.TrE_TrNId AND TEKG.TrE_Lp = TEFS.TrE_LpPow&#xD;
	WHERE TNKG.trn_rodzaj IN (301008,301009,301018)&#xD;
	GROUP BY TEFS.TrE_TrEID,TNFS.TrN_TrNID&#xD;
END&#xD;
BEGIN /* #tmpMarza			 - tabela pomocnicza do liczenia marży			*/ &#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
END&#xD;
&#xD;
/* WŁAŚCIWE ZAPYTANIE */&#xD;
SET @SQLPaczka1_Kolumny = N' SELECT		/* Paczka 1 | Faktury Sprzedaży, Paragony, Korekty */	&#xD;
	------MIARY&#xD;
			 [Cena początkowa]						= TrE_Cena0WD&#xD;
			,[Cena transakcyjna]					= TrE_CenaWWD&#xD;
			,[Koszt Zakupu]							= (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) &#xD;
														* (CASE &#xD;
															WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) &#xD;
															THEN -1 &#xD;
															ELSE 1 &#xD;
															END)&#xD;
			,[Koszt Zakupu Koszty Graniczne]		= KosztyGraniczne&#xD;
			,[Koszt Zakupu Waluta]					= ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) &#xD;
														* (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1),TR.TrE_KosztUslugi)&#xD;
			,[Liczba Dokumentów]					= CONCAT(DB_NAME(),trn.TrN_TrNID)&#xD;
			,[Liczba Kontrahentów]					= DB_NAME() + ''_''&#xD;
														+ CONVERT(VARCHAR(10),pod5.pod_PodmiotTyp) + ''_''&#xD;
														+ CONVERT(VARCHAR(10),pod5.Pod_PodId)  &#xD;
			,[Liczba Odbiorców]						= DB_NAME() + ''_''&#xD;
														+ CONVERT(VARCHAR(10),pod3.pod_PodmiotTyp) + ''_''&#xD;
														+ CONVERT(VARCHAR(10),pod3.Pod_PodId)  &#xD;
			,[Liczba Produktów]						= DB_NAME() + ''_''&#xD;
														+ CONVERT(VARCHAR(10),Twr_twrId)  &#xD;
			,[Sprzedaż Ilość]						= TR.TrE_Ilosc &#xD;
			,[Sprzedaż Ilość Jednostka Pomocnicza]	= CAST(TR.TrE_Ilosc/ ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS DECIMAL(26,10)) &#xD;
			,[Sprzedaż Marża]						= TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
			,[Sprzedaż Rabat]						= TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/ISNULL(NULLIF([TrE_JMPrzelicznikL],0),1)*[TrE_JMPrzelicznikM])) * TrE_KursL / ISNULL(NULLIF(TrE_KursM,0),1)  &#xD;
			,[Sprzedaż Wartość]						= TR.TrE_WartoscNetto &#xD;
			,[Sprzedaż Wartość Brutto]				= TR.TrE_WartoscBrutto &#xD;
			,[Sprzedaż Wartość Waluta]				= TR.TrE_WartoscNettoWal &#xD;
	&#xD;
	------WYMIARY&#xD;
		--BAZA_FIRMOWA&#xD;
			,[Baza Firmowa]							= BAZ.Baz_Nazwa &#xD;
			&#xD;
		--CZAS_AKTUALNY&#xD;
			,[Czas Aktualny Dziś]					= CASE &#xD;
														WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' &#xD;
														ELSE ''NIE'' &#xD;
														END &#xD;
			,[Czas Aktualny Wczoraj]				= CASE &#xD;
														WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' &#xD;
														ELSE ''NIE'' &#xD;
														END &#xD;
			,[Czas Aktualny Tydzień]				= CASE &#xD;
														WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
														ELSE ''NIE'' &#xD;
														END &#xD;
			,[Czas Aktualny Miesiąc]				= CASE &#xD;
														WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
														ELSE ''NIE'' &#xD;
														END &#xD;
			,[Czas Aktualny Miesiąc Poprzedni]		= CASE &#xD;
														WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
														WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
														ELSE ''NIE'' &#xD;
														END &#xD;
		--CZAS_AKTUALNY_DATA&#xD;
			,[Czas Aktualny Data]					= GETDATE() &#xD;
			&#xD;
		--DOKUMENT&#xD;
			,[Dokument Godzina Wystawienia]			= CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' &#xD;
			,[Dokument Numer]						= trn.TrN_NumerPelny &#xD;
			,[Dokument Opis]						= ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') &#xD;
			,[Dokument Seria]						= CASE &#xD;
														WHEN ISNULL(ser.seria,0) = 5 then substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
														ELSE ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
														END&#xD;
			,[Dokument Symbol]						= dd.DDf_Symbol &#xD;
			,[Kategoria Ogólna z Nagłówka]			= ISNULL(kat1.Kat_KodOgolny		,''(PUSTA)'') &#xD;
			,[Kategoria Ogólna z Pozycji]			= ISNULL(kat2.Kat_KodOgolny		,''(PUSTA)'') &#xD;
			,[Kategoria Szczegółowa z Nagłówka]		= ISNULL(kat1.Kat_KodSzczegol	,''(PUSTA)'') &#xD;
			,[Kategoria Szczegółowa z Pozycji]		= ISNULL(kat2.Kat_KodSzczegol	,''(PUSTA)'') &#xD;
			&#xD;
		--FORMA_PŁATNOŚCI&#xD;
			,[Forma Płatności]						= FPl_Nazwa &#xD;
			&#xD;
		--JEDNOSTKA_MIARY&#xD;
			,[Jednostka Miary]						= Twr_Jm &#xD;
			&#xD;
		--JEDNOSTKA_MIARY_POMOCNICZA&#xD;
			,[Jednostka Miary Pomocnicza]			= ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') &#xD;
			&#xD;
		--KONTRAHENT&#xD;
			,[Kontrahent Grupa]						= ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') &#xD;
			,[Kontrahent Kategoria]					= ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
			,[Kontrahent Kod]						= pod5.Pod_Kod &#xD;
			,[Kontrahent Nazwa]						= pod5.Pod_Nazwa1&#xD;
			,[Kontrahent NIP]						= ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') &#xD;
			,[Kontrahent Opiekun]					= CASE knt3.Knt_OpiekunTyp&#xD;
														WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
														WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
														ELSE ''(NIEPRZYPISANE)'' &#xD;
														END &#xD;
			,[Kontrahent Rabat]						= CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' &#xD;
			,[Kontrahent Rodzaj]					= reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
														  (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) &#xD;
														+ (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) &#xD;
														+ (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) &#xD;
														+ (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) &#xD;
														+ (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, ''''))&#xD;
			,[Kontrahent Kraj]						= ISNULL(NULLIF(pod5.Pod_Kraj		, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Kontrahent Województwo]				= ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Kontrahent Miasto]					= ISNULL(NULLIF(pod5.Pod_Miasto		, ''''),''(NIEPRZYPISANE)'') &#xD;
			&#xD;
		--KONTRAHENT_Z_DOKUMENTU&#xD;
			,[Kontrahent z Dokumentu Nazwa]			= Trn.TrN_PodNazwa1&#xD;
			,[Kontrahent z Dokumentu NIP]			= ISNULL(NULLIF(Trn.TrN_PodNipKraj		, ''''),''(BRAK)'') &#xD;
			,[Kontrahent z Dokumentu Kraj]			= ISNULL(NULLIF(Trn.TrN_PodKraj			, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Kontrahent z Dokumentu Województwo]	= ISNULL(NULLIF(Trn.TrN_PodWojewodztwo	, ''''),''(NIEPRZYPISANE)'')&#xD;
			,[Kontrahent z Dokumentu Miasto]		= ISNULL(NULLIF(Trn.TrN_PodMiasto		, ''''),''(NIEPRZYPISANE)'') &#xD;
&#xD;
		--KONTRAHENT_PIERWOTNY&#xD;
			,[Kontrahent Pierwotny Grupa]			= ISNULL(NULLIF(pod1.Pod_Grupa		, ''''),''Pozostali'') &#xD;
			,[Kontrahent Pierwotny Kategoria]		= ISNULL(kat3.Kat_KodSzczegol		, ''(PUSTA)'') &#xD;
			,[Kontrahent Pierwotny Kod]				= pod1.Pod_Kod &#xD;
			,[Kontrahent Pierwotny Nazwa]			= pod1.Pod_Nazwa1 &#xD;
			,[Kontrahent Pierwotny NIP]				= ISNULL(NULLIF(pod1.Pod_NIP		, ''''),''(BRAK)'') &#xD;
			,[Kontrahent Pierwotny Opiekun]			= CASE knt1.Knt_OpiekunTyp&#xD;
														WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
														WHEN 8 THEN ISNULL(opk.Ope_Kod , ''(NIEPRZYPISANE)'')&#xD;
														ELSE ''(NIEPRZYPISANE)'' &#xD;
														END &#xD;
			,[Kontrahent Pierwotny Rodzaj]			= reverse(stuff(reverse(CONVERT(varchar(100),RTRIM((CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) &#xD;
														+(CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) &#xD;
														+(CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) &#xD;
														+(CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) &#xD;
														+(CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, ''''))&#xD;
			,[Kontrahent Pierwotny Kraj]			= ISNULL(NULLIF(pod1.Pod_Kraj		, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Kontrahent Pierwotny Województwo]		= ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Kontrahent Pierwotny Miasto]			= ISNULL(NULLIF(pod1.Pod_Miasto		, ''''),''(NIEPRZYPISANE)'') &#xD;
			&#xD;
		--KOSZT_ZAKUPU&#xD;
			,[Waluta Koszt Zakupu]					= ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) &#xD;
		&#xD;
		--MAGAZYN	&#xD;
			,[Magazyn Nazwa]						= Mag_Symbol &#xD;
			&#xD;
		--ODBIORCA&#xD;
			,[Odbiorca Grupa]						= ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') &#xD;
			,[Odbiorca Kod]							= pod3.Pod_Kod &#xD;
			,[Odbiorca Nazwa]						= pod3.Pod_Nazwa1&#xD;
			,[Odbiorca Opiekun]						= CASE knt2.Knt_OpiekunTyp&#xD;
														WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
														WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
														ELSE ''(NIEPRZYPISANE)'' &#xD;
														END &#xD;
			,[Odbiorca Kraj]						= ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Odbiorca Województwo]					= ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Odbiorca Miasto]						= ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') &#xD;
		&#xD;
		--ODBIORCA_Z_DOKUMENTU&#xD;
			,[Odbiorca z Dokumentu Nazwa]			= Trn.TrN_OdbNazwa1&#xD;
			,[Odbiorca z Dokumentu NIP]				= ISNULL(NULLIF(Trn.TrN_OdbNipKraj		, ''''),''(BRAK)'') &#xD;
			,[Odbiorca z Dokumentu Kraj]			= ISNULL(NULLIF(Trn.TrN_OdbKraj			, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Odbiorca z Dokumentu Województwo]		= ISNULL(NULLIF(Trn.TrN_OdbWojewodztwo	, ''''),''(NIEPRZYPISANE)'')&#xD;
			,[Odbiorca z Dokumentu Miasto]			= ISNULL(NULLIF(Trn.TrN_OdbMiasto		, ''''),''(NIEPRZYPISANE)'') &#xD;
			&#xD;
		--OPERATOR&#xD;
			,[Operator Modyfikujący]				= mod.Ope_Kod 			&#xD;
			,[Operator Wprowadzający]				= zal.Ope_Kod &#xD;
			&#xD;
		--PRODUKT&#xD;
			,[Produkt Aktywny]						= CASE Twr_NieAktywny &#xD;
														WHEN 0 THEN ''Tak'' &#xD;
														ELSE ''Nie'' &#xD;
														END &#xD;
			,[Produkt Dostawca]						= ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  &#xD;
			,[Produkt e-Sklep]						= CASE ISNULL(esk.Udostepnij,0) &#xD;
														WHEN 0 THEN ''Nie'' &#xD;
														ELSE ''Tak'' &#xD;
														END&#xD;
			,[Produkt EAN]							= ISNULL(Twr_EAN,''(BRAK)'') &#xD;
			,[Produkt Kategoria]					= ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
			,[Produkt Kaucja]						= CASE &#xD;
														WHEN TrE_Kaucja = 1 THEN ''TAK'' &#xD;
														ELSE ''NIE'' &#xD;
														END &#xD;
			,[Produkt Kod]							= Twr_Kod &#xD;
			,[Produkt Kod CN]						= KCN_Kod &#xD;
			,[Produkt Kod Dostawcy]					= ISNULL(Twr_KodDostawcy,''(BRAK)'') &#xD;
			,[Produkt Lp.]							= Tre_Lp &#xD;
			,[Produkt Marka]						= ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') &#xD;
			,[Produkt Nazwa]						= Twr_Nazwa &#xD;
			,[Produkt Nazwa z Faktury]				= TR.Tre_TwrNazwa &#xD;
			,[Produkt Numer Katalogowy]				= Twr_NumerKat &#xD;
			,[Produkt Opis]							= CAST(Twr_Opis as VARCHAR(1024)) &#xD;
			,[Produkt Pełna Nazwa Grupy]			= poz.sciezka &#xD;
			&#xD;
&#xD;
			,[Produkt PKWiU]						= CASE TWR_SWW &#xD;
														WHEN '' '' THEN ''(NIEPRZYPISANE)'' &#xD;
														ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') &#xD;
														END &#xD;
			,[Produkt Pozycja Dokumentu]			= TR.TrE_Lp  &#xD;
			,[Produkt Producent]					= ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') &#xD;
			,[Produkt Typ]							= CASE &#xD;
														WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
														WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
														WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
														WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
														END &#xD;
			&#xD;
		--PRODUKT_Z_DOKUMENTU&#xD;
			,[Produkt z Dokumentu EAN]				= ISNULL(TR.TrE_TwrEAN,''(BRAK)'') &#xD;
			,[Produkt z Dokumentu Kod]				= TR.TrE_TwrKod&#xD;
			,[Produkt z Dokumentu Kod Dostawcy]		= ISNULL(TR.TrE_TwrKodDostawcy,''(BRAK)'')&#xD;
			,[Produkt z Dokumentu Nazwa]			= TR.TrE_TwrNazwa&#xD;
			,[Produkt z Dokumentu Numer Katalogowy]	= TR.TrE_TwrNumerKat&#xD;
			,[Produkt z Dokumentu Opis]				= CAST(TR.TrE_TwrOpis as VARCHAR(1024))&#xD;
			,[Produkt z Dokumentu PKWiU]			= CASE TR.TrE_TwrSWW &#xD;
														WHEN '' '' THEN ''(NIEPRZYPISANE)'' &#xD;
														ELSE ISNULL(TR.TrE_TwrSWW,''(NIEPRZYPISANE)'') &#xD;
														END &#xD;
			,[Produkt z Dokumentu Typ]				= CASE &#xD;
														WHEN TR.TrE_TwrTyp = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
														WHEN TR.TrE_TwrTyp = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
														WHEN TR.TrE_TwrTyp = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
														WHEN TR.TrE_TwrTyp = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
														END &#xD;
&#xD;
		--WALUTA&#xD;
			,[Waluta]								= ISNULL(NULLIF(trn.TrN_Waluta, ''''),'''+@WalutaSys+''') &#xD;
		&#xD;
&#xD;
			/*&#xD;
		----------DATY POINT&#xD;
			,[Data Operacji]						= REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') &#xD;
			,[Data Wystawienia]						= REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') &#xD;
			,[Termin Płatności]						= REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin , 111), ''/'', ''-'') &#xD;
			*/&#xD;
	&#xD;
		----------DATY ANALIZY&#xD;
			,[Data Operacji Dzień]					= REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') &#xD;
			,[Data Operacji Tydzień Roku]			= (datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/&#xD;
			,[Data Operacji Miesiąc]				= MONTH(trn.TrN_DataOpe)&#xD;
			,[Data Operacji Kwartał]				= DATEPART(quarter, trn.TrN_DataOpe) &#xD;
			,[Data Operacji Rok]					= YEAR(trn.TrN_DataOpe) &#xD;
			&#xD;
			,[Data Wystawienia Dzień]				= REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') &#xD;
			,[Data Wystawienia Tydzień Roku]		= (datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/  &#xD;
			,[Data Wystawienia Miesiąc]				= MONTH(trn.TrN_DataWys) &#xD;
			,[Data Wystawienia Kwartał]				= DATEPART(quarter, trn.TrN_DataWys) &#xD;
			,[Data Wystawienia Rok]					= YEAR(trn.TrN_DataWys) &#xD;
			&#xD;
			,[Termin Płatności Dzień]				= REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'')  &#xD;
			,[Termin Płatności Tydzień Roku]		= (datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ &#xD;
			,[Termin Płatności Miesiąc]				= MONTH(trn.TrN_Termin) &#xD;
			,[Termin Płatności Kwartał]				= DATEPART(quarter, trn.TrN_Termin) &#xD;
			,[Termin Płatności Rok]					= YEAR(trn.TrN_Termin) &#xD;
			&#xD;
		----------KONTEKSTY&#xD;
			,[Dokument Numer __PROCID__Sprzedaz__]		= CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END &#xD;
			,[Dokument Numer __ORGID__]					= trn.TrN_TrNId &#xD;
			,[Dokument Numer __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
			,[Kontrahent Pierwotny Nazwa __PROCID__]	= 20201 &#xD;
			,[Kontrahent Pierwotny Nazwa __ORGID__]		= pod1.Pod_PodId &#xD;
			,[Kontrahent Pierwotny Nazwa __DATABASE__]	= '''+@bazaFirmowa+''' &#xD;
			,[Kontrahent Pierwotny Kod __PROCID__]		= 20201 &#xD;
			,[Kontrahent Pierwotny Kod __ORGID__]		= pod1.Pod_PodId &#xD;
			,[Kontrahent Pierwotny Kod __DATABASE__]	= '''+@bazaFirmowa+''' &#xD;
			,[Kontrahent Nazwa __PROCID__]				= 20201 &#xD;
			,[Kontrahent Nazwa __ORGID__]				= pod5.Pod_PodId &#xD;
			,[Kontrahent Nazwa __DATABASE__]			= '''+@bazaFirmowa+''' &#xD;
			,[Kontrahent Kod __PROCID__Kontrahenci__]	= 20201 &#xD;
			,[Kontrahent Kod __ORGID__]					= pod5.Pod_PodId &#xD;
			,[Kontrahent Kod __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
			,[Odbiorca Nazwa __PROCID__]				= 20201 &#xD;
			,[Odbiorca Nazwa __ORGID__]					= pod3.Pod_PodId &#xD;
			,[Odbiorca Nazwa __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
			,[Odbiorca Kod __PROCID__]					= 20201 &#xD;
			,[Odbiorca Kod __ORGID__]					= pod3.Pod_PodId &#xD;
			,[Odbiorca Kod __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
			,[Produkt Nazwa __PROCID__]					= 25003 &#xD;
			,[Produkt Nazwa __ORGID__]					= Twr_twrId &#xD;
			,[Produkt Nazwa __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
			,[Produkt Kod __PROCID__Towary__]			= 25003 &#xD;
			,[Produkt Kod __ORGID__]					= Twr_twrId &#xD;
			,[Produkt Kod __DATABASE__]					= '''+@bazaFirmowa+''' &#xD;
			,[Magazyn Nazwa __PROCID__Magazyny__]		= 29056 &#xD;
			,[Magazyn Nazwa __ORGID__]					= Mag_MagId &#xD;
			,[Magazyn Nazwa __DATABASE__]				= '''+@bazaFirmowa+''' ' &#xD;
			+ @kolumny &#xD;
			+ @atrybuty &#xD;
			+ @atrybutyDok &#xD;
			+ @atrybutyTwr &#xD;
			+ @atrybutyPoz &#xD;
SET @SQLPaczka1_Tabele  = N'																	&#xD;
			   FROM cdn.TraNag trn									&#xD;
			   JOIN cdn.TraElem			TR		ON TrE_TrNID=trn.TrN_TrNID &#xD;
		  LEFT JOIN #tmpSeria			ser		ON trn.TrN_DDfId = DDf_DDfID&#xD;
		  LEFT JOIN CDN.DokDefinicje	dd		ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
		  LEFT JOIN (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) &#xD;
										spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci		knt1	ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView	pod1	ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView	pod3	ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView	pod2	ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci		knt2	ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView	pod4	ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
			   JOIN CDN.Towary					ON TrE_TwrId=Twr_TwrId&#xD;
		  LEFT JOIN CDN.KodyCN					on Twr_KCNId = KCN_KCNId&#xD;
		  LEFT JOIN CDN.Producenci				ON Prd_PrdId = Twr_PrdId&#xD;
		  LEFT JOIN CDN.Marki					ON Mrk_MrkId = Twr_MrkId&#xD;
			   JOIN CDN.Magazyny				ON TrE_MagId=Mag_MagId &#xD;
    LEFT OUTER JOIN CDN.Kategorie		kat1	ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie		kat2	ON TrE_KatID=kat2.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie		kat3	ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie		kat4	ON Twr_KatID=kat4.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView	pod5	on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci		knt3	ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
		  LEFT JOIN CDN.Rabaty					on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND trn.TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
    LEFT OUTER JOIN CDN.Kategorie		kat5	ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView	pod6	ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
		  LEFT JOIN #tmpTwrGr			Poz		ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
		  LEFT JOIN #tmpKonAtr			KonAtr	ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
		  LEFT JOIN #tmpKonAtr			KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
		  LEFT JOIN #tmpKonAtr			OdbAtr	ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
		  LEFT JOIN #tmpDokAtr			DokAtr	ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
		  LEFT JOIN #tmpTwrAtr			TwrAtr	ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
		  LEFT JOIN #tmpPozatr			PozAtr	on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
		  LEFT JOIN '+@Operatorzy+'		opk		ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
		  LEFT JOIN '+@Operatorzy+'		opk2	ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
		  LEFT JOIN '+@Operatorzy+'		zal		ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
		  LEFT JOIN '+@Operatorzy+'		mod		ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
		  LEFT JOIN '+@Operatorzy+'		opk3	ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
		  LEFT JOIN CDN.FormyPlatnosci			ON trn.TrN_FPlId = FPl_FPlId&#xD;
		  LEFT JOIN CDN.Kontrahenci		knt4	ON Twr_KntId = knt4.Knt_KntId&#xD;
   LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
						   	,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID,TREWAL.TRE_Waluta,TREWAL.TrE_KursL ,TREWAL.Tre_KursM &#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
		  LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) &#xD;
										esk		ON esk.Twes_TwrId = Twr_TwrId&#xD;
		  LEFT JOIN #tmpKosztyGraniczne			ON ElemId = TR.Tre_Treid&#xD;
		  LEFT JOIN '+@Bazy+'			BAZ		ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
			  WHERE trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
				AND trn.TrN_Bufor &lt;&gt; -1&#xD;
				AND TrE_Aktywny	  &lt;&gt;  0&#xD;
				AND TrE_UslugaZlozonaId = 0'&#xD;
SET @SQLPaczka2_Kolumny = N' UNION ALL  /* Paczka 2 | Korekty Zbiorcze do Faktur Sprzedaży */	&#xD;
	SELECT  &#xD;
	------MIARY&#xD;
			 [Cena początkowa]						= NULL&#xD;
			,[Cena transakcyjna]					= NULL&#xD;
			,[Koszt Zakupu]							= KosztWyliczony.Koszt &#xD;
			,[Koszt Zakupu Koszty Graniczne]		= KosztyGraniczne&#xD;
			,[Koszt Zakupu Waluta]					= (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0)) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1)&#xD;
    		,[Liczba Dokumentów]					= DB_NAME()+convert(Varchar(10),TrN_TrNID) &#xD;
			,[Liczba Kontrahentów]					= DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) &#xD;
			,[Liczba Odbiorców]						= DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)&#xD;
			,[Liczba Produktów]						= NULL  &#xD;
			,[Sprzedaż Ilość]						= 0 &#xD;
			,[Sprzedaż Ilość Jednostka Pomocnicza]	= 0 &#xD;
			,[Sprzedaż Marża]						= TrN_RazemNetto - KosztWyliczony.Koszt &#xD;
			,[Sprzedaż Rabat]						= TrN_RabatWartosc &#xD;
			,[Sprzedaż Wartość]						= TrN_RazemNetto &#xD;
			,[Sprzedaż Wartość Brutto]				= TrN_RazemBrutto &#xD;
			,[Sprzedaż Wartość Waluta]				= TrN_RazemNettoWal &#xD;
	&#xD;
	------WYMIARY		&#xD;
		--BAZA_FIRMOWA&#xD;
			,[Baza Firmowa]						= BAZ.Baz_Nazwa&#xD;
			&#xD;
		--CZAS_AKTUALNY&#xD;
			,[Czas Aktualny Dziś]				= CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END &#xD;
			,[Czas Aktualny Wczoraj]			= CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END &#xD;
			,[Czas Aktualny Tydzień]			= CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
													THEN ''TAK'' &#xD;
													ELSE ''NIE'' &#xD;
													END &#xD;
			,[Czas Aktualny Miesiąc]			= CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END &#xD;
			,[Czas Aktualny Miesiąc Poprzedni]	= CASE &#xD;
													WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
													WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
													ELSE ''NIE'' &#xD;
													END &#xD;
&#xD;
		--CZAS_AKTUALNY_DATA&#xD;
			,[Czas Aktualny Data]					= GETDATE() &#xD;
		&#xD;
		--DOKUMENT&#xD;
			,[Dokument Godzina Wystawienia]		= CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' &#xD;
			,[Dokument Numer]					= TrN_NumerPelny &#xD;
			,[Dokument Opis]					= ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') &#xD;
			,[Dokument Seria]					= CASE when isnull(ser.seria,0) = 5 then substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
													ELSE ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
													END &#xD;
			,[Dokument Symbol]					= dd.DDf_Symbol &#xD;
			,[Kategoria Ogólna z Nagłówka]		= ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') &#xD;
			,[Kategoria Ogólna z Pozycji]		= ''(PUSTA)'' &#xD;
			,[Kategoria Szczegółowa z Nagłówka] = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'')&#xD;
			,[Kategoria Szczegółowa z Pozycji]	= ''(PUSTA)'' &#xD;
			&#xD;
		--FORMA_PLATNOSCI&#xD;
			,[Forma Płatności]					= FPl_Nazwa &#xD;
		&#xD;
		--JEDNOSTKA_MIARY&#xD;
			,[Jednostka Miary]					= ''(BRAK)'' &#xD;
			&#xD;
		--JEDNOSTKA_MIARY_POMOCNICZA&#xD;
			,[Jednostka Miary Pomocnicza]		= ''(BRAK)'' &#xD;
&#xD;
		--KONTRAHENT&#xD;
			,[Kontrahent Grupa]					= ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') &#xD;
			,[Kontrahent Kategoria]				= ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
			,[Kontrahent Kod]					= pod5.Pod_Kod &#xD;
			,[Kontrahent Nazwa]					= pod5.Pod_Nazwa1 &#xD;
			,[Kontrahent NIP]					= ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') &#xD;
			,[Kontrahent Opiekun]				= CASE knt3.Knt_OpiekunTyp&#xD;
													WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
													WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
													ELSE ''(NIEPRZYPISANE)'' &#xD;
													END &#xD;
			,[Kontrahent Rabat]					= CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%''&#xD;
			,[Kontrahent Rodzaj]				= reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
													(CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
													(CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
													(CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
													(CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
													(CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) &#xD;
			,[Kontrahent Kraj]					= ISNULL(NULLIF(pod5.Pod_Kraj		, ''''),''(NIEPRZYPISANE)'') 	&#xD;
			,[Kontrahent Województwo]			= ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Kontrahent Miasto]				= ISNULL(NULLIF(pod5.Pod_Miasto		, ''''),''(NIEPRZYPISANE)'')&#xD;
		&#xD;
		--KONTRAHENT_Z_DOKUMENTU&#xD;
			,[Kontrahent z Dokumentu Nazwa]			= Trn.TrN_PodNazwa1&#xD;
			,[Kontrahent z Dokumentu NIP]			= ISNULL(NULLIF(Trn.TrN_PodNipKraj		, ''''),''(BRAK)'') &#xD;
			,[Kontrahent z Dokumentu Kraj]			= ISNULL(NULLIF(Trn.TrN_PodKraj			, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Kontrahent z Dokumentu Województwo]	= ISNULL(NULLIF(Trn.TrN_PodWojewodztwo	, ''''),''(NIEPRZYPISANE)'')&#xD;
			,[Kontrahent z Dokumentu Miasto]		= ISNULL(NULLIF(Trn.TrN_PodMiasto		, ''''),''(NIEPRZYPISANE)'') &#xD;
&#xD;
		--KONTRAHENT PIERWOTNY&#xD;
			,[Kontrahent Pierwotny Grupa]		= ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') &#xD;
			,[Kontrahent Pierwotny Kategoria]	= ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
			,[Kontrahent Pierwotny Kod]			= pod1.Pod_Kod &#xD;
			,[Kontrahent Pierwotny Nazwa]		= pod1.Pod_Nazwa1 &#xD;
			,[Kontrahent Pierwotny NIP]			= ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') &#xD;
			,[Kontrahent Pierwotny Opiekun]		= CASE knt1.Knt_OpiekunTyp&#xD;
													WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
													WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
													ELSE ''(NIEPRZYPISANE)'' &#xD;
													END&#xD;
			,[Kontrahent Pierwotny Rodzaj]		= reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
													(CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
													(CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
													(CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
													(CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
													(CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, ''''))&#xD;
			,[Kontrahent Pierwotny Kraj]		= ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Kontrahent Pierwotny Województwo] = ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Kontrahent Pierwotny Miasto]		= ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') &#xD;
			&#xD;
		--KOSZT_ZAKUPU&#xD;
			,[Waluta Koszt Zakupu]					= KosztWyliczony.TRE_Waluta &#xD;
			&#xD;
		--MAGAZYN&#xD;
			,[Magazyn Nazwa]					= ''(BRAK)'' &#xD;
&#xD;
		--ODBIORCA&#xD;
			,[Odbiorca Grupa]					= ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') &#xD;
			,[Odbiorca Kod]						= pod3.Pod_Kod &#xD;
			,[Odbiorca Nazwa]					= pod3.Pod_Nazwa1&#xD;
			,[Odbiorca Opiekun]					= CASE knt2.Knt_OpiekunTyp&#xD;
													WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
													WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
													ELSE ''(NIEPRZYPISANE)'' &#xD;
													END &#xD;
			,[Odbiorca Kraj]					= ISNULL(NULLIF(pod3.Pod_Kraj		, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Odbiorca Województwo]				= ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Odbiorca Miasto]					= ISNULL(NULLIF(pod3.Pod_Miasto		, ''''),''(NIEPRZYPISANE)'') &#xD;
		&#xD;
		--ODBIORCA_Z_DOKUMENTU&#xD;
			,[Odbiorca z Dokumentu Nazwa]		= Trn.TrN_OdbNazwa1&#xD;
			,[Odbiorca z Dokumentu NIP]			= ISNULL(NULLIF(Trn.TrN_OdbNipKraj		, ''''),''(BRAK)'') &#xD;
			,[Odbiorca z Dokumentu Kraj]		= ISNULL(NULLIF(Trn.TrN_OdbKraj			, ''''),''(NIEPRZYPISANE)'') &#xD;
			,[Odbiorca z Dokumentu Województwo]	= ISNULL(NULLIF(Trn.TrN_OdbWojewodztwo	, ''''),''(NIEPRZYPISANE)'')&#xD;
			,[Odbiorca z Dokumentu Miasto]		= ISNULL(NULLIF(Trn.TrN_OdbMiasto		, ''''),''(NIEPRZYPISANE)'') &#xD;
&#xD;
		--OPERATOR&#xD;
			,[Operator Modyfikujący]			= mod.Ope_Kod &#xD;
			,[Operator Wprowadzający]			= zal.Ope_Kod &#xD;
			&#xD;
		--PRODUKT&#xD;
			,[Produkt Aktywny]					= ''(BRAK)'' &#xD;
			,[Produkt Dostawca]					= ''(BRAK)'' &#xD;
			,[Produkt e-Sklep]					= ''Korekta zbiorcza''&#xD;
			,[Produkt EAN]						= ''(BRAK)'' &#xD;
			,[Produkt Kategoria]				= ''(PUSTA)'' &#xD;
			,[Produkt Kaucja]					= ''NIE'' &#xD;
			,[Produkt Kod]						= ''Korekta zbiorcza'' &#xD;
			,[Produkt Kod CN]					= ''(BRAK)'' &#xD;
			,[Produkt Kod Dostawcy]				= ''(BRAK)'' &#xD;
			,[Produkt Lp.]						= NULL &#xD;
			,[Produkt Marka]					= ''(BRAK)'' &#xD;
			,[Produkt Nazwa]					= ''Korekta zbiorcza'' &#xD;
			,[Produkt Nazwa z Faktury]			= ''Korekta zbiorcza'' &#xD;
			,[Produkt Numer Katalogowy]			= ''Korekta zbiorcza'' &#xD;
			,[Produkt Opis]						= ''Korekta zbiorcza'' &#xD;
			,[Produkt Pełna Nazwa Grupy]		= ''Korekta zbiorcza'' &#xD;
			,[Produkt PKWiU]					= ''(BRAK)'' &#xD;
			,[Produkt Pozycja Dokumentu]		= NULL &#xD;
			,[Produkt Producent]				= ''(BRAK)'' &#xD;
			,[Produkt Typ]						= ''Korekta zbiorcza'' &#xD;
		&#xD;
		--PRODUKT_Z_DOKUMENTU&#xD;
			,[Produkt z Dokumentu EAN]				= ''(BRAK)''&#xD;
			,[Produkt z Dokumentu Kod]				= ''Korekta zbiorcza'' &#xD;
			,[Produkt z Dokumentu Kod Dostawcy]		= ''(BRAK)''&#xD;
			,[Produkt z Dokumentu Nazwa]			= ''Korekta zbiorcza''&#xD;
			,[Produkt z Dokumentu Numer Katalogowy]	= ''Korekta zbiorcza''&#xD;
			,[Produkt z Dokumentu Opis]				= ''Korekta zbiorcza''&#xD;
			,[Produkt z Dokumentu PKWiU]			= ''(BRAK)''&#xD;
			,[Produkt z Dokumentu Typ]				= ''Korekta zbiorcza''&#xD;
&#xD;
		--WALUTA&#xD;
			,[Waluta]							= ISNULL(NULLIF(TrN_Waluta, ''''),'''+@WalutaSys+''') &#xD;
		&#xD;
			/*&#xD;
			----------DATY POINT&#xD;
			,[Data Operacji]	= REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') &#xD;
			,[Data Wystawienia] = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') &#xD;
			,[Termin Płatności] = REPLACE(CONVERT(VARCHAR(10), TrN_Termin , 111), ''/'', ''-'') &#xD;
			*/&#xD;
    &#xD;
			----------DATY ANALIZY&#xD;
			,[Data Operacji Dzień]				= REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') &#xD;
			,[Data Operacji Tydzień Roku]		= (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ &#xD;
			,[Data Operacji Miesiąc]			= MONTH(TrN_DataOpe) &#xD;
			,[Data Operacji Kwartał]			= DATEPART(quarter, TrN_DataOpe) &#xD;
			,[Data Operacji Rok]				= YEAR(TrN_DataOpe)  &#xD;
			&#xD;
			,[Data Wystawienia Dzień]			= REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') &#xD;
			,[Data Wystawienia Tydzień Roku]	= (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ &#xD;
			,[Data Wystawienia Miesiąc]			= MONTH(TrN_DataWys) &#xD;
			,[Data Wystawienia Kwartał]			= DATEPART(quarter, TrN_DataWys) &#xD;
			,[Data Wystawienia Rok]				= YEAR(TrN_DataWys) &#xD;
			&#xD;
			,[Termin Płatności Dzień]			= REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') &#xD;
			,[Termin Płatności Tydzień Roku]	= (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ &#xD;
			,[Termin Płatności Miesiąc]			= MONTH(TrN_Termin) &#xD;
			,[Termin Płatności Kwartał]			= DATEPART(quarter, TrN_Termin) &#xD;
			,[Termin Płatności Rok]				=  YEAR(TrN_Termin)  &#xD;
    &#xD;
			----------KONTEKSTY&#xD;
			,[Dokument Numer __PROCID__Sprzedaz__]				= 30392 &#xD;
			,[Dokument Numer __ORGID__]							= TrN_TrNId &#xD;
			,[Dokument Numer __DATABASE__]						= '''+@bazaFirmowa+''' &#xD;
			,[Kontrahent Pierwotny Nazwa __PROCID__]			= 20201 &#xD;
			,[Kontrahent Pierwotny Nazwa __ORGID__]				= pod1.Pod_PodId &#xD;
			,[Kontrahent Pierwotny Nazwa __DATABASE__]			= '''+@bazaFirmowa+''' &#xD;
			,[Kontrahent Pierwotny Kod __PROCID__Kontrahenci__] = 20201 &#xD;
			,[Kontrahent Pierwotny Kod __ORGID__]				= pod1.Pod_PodId &#xD;
			,[Kontrahent Pierwotny Kod __DATABASE__]			= '''+@bazaFirmowa+''' &#xD;
			,[Kontrahent Nazwa __PROCID__]						= 20201 &#xD;
			,[Kontrahent Nazwa __ORGID__]						= pod5.Pod_PodId &#xD;
			,[Kontrahent Nazwa __DATABASE__]					= '''+@bazaFirmowa+''' &#xD;
			,[Kontrahent Kod __PROCID__Kontrahenci__]			= 20201 &#xD;
			,[Kontrahent Kod __ORGID__]							= pod5.Pod_PodId &#xD;
			,[Kontrahent Kod __DATABASE__]						= '''+@bazaFirmowa+''' &#xD;
			,[Odbiorca Nazwa __PROCID__]						= 20201 &#xD;
			,[Odbiorca Nazwa __ORGID__]							= pod3.Pod_PodId &#xD;
			,[Odbiorca Nazwa __DATABASE__]						= '''+@bazaFirmowa+''' &#xD;
			,[Odbiorca Kod __PROCID__]							= 20201 &#xD;
			,[Odbiorca Kod __ORGID__]							= pod3.Pod_PodId &#xD;
			,[Odbiorca Kod __DATABASE__]						= '''+@bazaFirmowa+''' &#xD;
			,[Produkt Nazwa __PROCID__]							= 30392 &#xD;
			,[Produkt Nazwa __ORGID__]							= TrN_TrNId &#xD;
			,[Produkt Nazwa __DATABASE__]						= '''+@bazaFirmowa+''' &#xD;
			,[Produkt Kod __PROCID__Towary__]					= 30392 &#xD;
			,[Produkt Kod __ORGID__]							= TrN_TrNId &#xD;
			,[Produkt Kod __DATABASE__]							= '''+@bazaFirmowa+''' &#xD;
			,[Magazyn Nazwa __PROCID__Magazyny__]				= 30392 &#xD;
			,[Magazyn Nazwa __ORGID__]							= TrN_TrNId &#xD;
			,[Magazyn Nazwa __DATABASE__]						= '''+@bazaFirmowa+''' ' &#xD;
			+ @kolumny &#xD;
			+ @atrybuty &#xD;
			+ @atrybutyDok &#xD;
			+ @atrybutyTwr2 &#xD;
			+ @atrybutyPoz2&#xD;
SET @SQLPaczka2_Tabele	= N'																	&#xD;
				 FROM CDN.TraNag		Trn		&#xD;
			LEFT JOIN #tmpSeria			ser			ON TrN_DDfId = DDf_DDfID&#xD;
			LEFT JOIN CDN.DokDefinicje	dd			ON TrN_DDfId = dd.DDf_DDfID&#xD;
      LEFT OUTER JOIN CDN.Kontrahenci	knt1		ON TrN_PodID = knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
      LEFT OUTER JOIN CDN.PodmiotyView	pod1		ON TrN_PodID = pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN CDN.PodmiotyView	pod3		ON TrN_OdbID = pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN CDN.PodmiotyView	pod2		ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN CDN.Kontrahenci	knt2		ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
      LEFT OUTER JOIN CDN.PodmiotyView	pod4		ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN CDN.PodmiotyView	pod5		ON pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
      LEFT OUTER JOIN CDN.Kategorie		kat1		ON TrN_KatID = kat1.Kat_KatID&#xD;
      LEFT OUTER JOIN CDN.Kategorie		kat3		ON knt1.Knt_KatID = kat3.Kat_KatID&#xD;
	  LEFT OUTER JOIN CDN.Kontrahenci	knt3		ON pod5.Pod_PodID = knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
			LEFT JOIN CDN.Rabaty					ON rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
      LEFT OUTER JOIN CDN.Kategorie		kat5		ON knt3.Knt_KatID = kat5.Kat_KatID&#xD;
      LEFT OUTER JOIN CDN.PodmiotyView	pod6		ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
			LEFT JOIN #tmpKonAtr		KonAtr		ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
			LEFT JOIN #tmpKonAtr		KonAtr1		ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
			LEFT JOIN #tmpKonAtr		OdbAtr		ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
			LEFT JOIN #tmpDokAtr		DokAtr		ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
			LEFT JOIN #tmpTwrGr			Poz			ON 0 = 1&#xD;
			LEFT JOIN '+@Operatorzy+'	opk			ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
			LEFT JOIN '+@Operatorzy+'	opk2		ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
			LEFT JOIN '+@Operatorzy+'	zal			ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
			LEFT JOIN '+@Operatorzy+'	mod			ON TrN_OpeModID = mod.Ope_OpeId&#xD;
			LEFT JOIN '+@Operatorzy+'	opk3		ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
			LEFT JOIN CDN.FormyPlatnosci			ON TrN_FPlId = FPl_FPlId&#xD;
			lEFT JOIN (SELECT sum(KosztyGraniczne) AS KosztyGraniczne, TransID FROM #tmpKosztyGraniczne GROUP BY TransId) &#xD;
										KosztyGran	ON Trn_Trnid = TransID &#xD;
			LEFT JOIN '+@Bazy+'			BAZ			ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrNId,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = trn_trnid&#xD;
WHERE TRN_Rodzaj = 302010&#xD;
  AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
EXEC (@SQLPaczka1_Kolumny + @SQLPaczka1_Tabele + @SQLPaczka2_Kolumny + @SQLPaczka2_Tabele)&#xD;
&#xD;
/* DEBUG PRINT */ &#xD;
	PRINT CAST(@SQLPaczka1_Kolumny AS NTEXT)&#xD;
	PRINT CAST(@SQLPaczka1_Tabele  AS NTEXT)&#xD;
	PRINT CAST(@SQLPaczka2_Kolumny AS NTEXT)&#xD;
	PRINT CAST(@SQLPaczka2_Tabele  AS NTEXT)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmppozatr&#xD;
DROP TABLE #tmpKosztyGraniczne&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+Qzc0uNFb+LUJRKceV/p60KoxY3f4HysPC/wxlKO+C3QF1S9Kuc74x9ewfUXzBLUSR3Ouk+AN4GPMSplrchLrx7CSyztiu8qCi5k4WDcXoTEHDla8WpIlwy3PBL4RSHrUgXSuvwXKkVGbds4B2+hdhzkCI/Om3bNlNbdc/2y7saoPIHny1NkWQwtYOWav0yceIbqK7ye9iiE+/eWVzzUwKt</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Waluta" caption="Koszt Zakupu Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Data" caption="Czas Aktualny Data" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent z Dokumentu Nazwa" caption="Kontrahent z Dokumentu Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent z Dokumentu NIP" caption="Kontrahent z Dokumentu NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent z Dokumentu Kraj" caption="Kontrahent z Dokumentu Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent z Dokumentu Województwo" caption="Kontrahent z Dokumentu Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent z Dokumentu Miasto" caption="Kontrahent z Dokumentu Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta Koszt Zakupu" caption="Waluta Koszt Zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca z Dokumentu Nazwa" caption="Odbiorca z Dokumentu Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca z Dokumentu NIP" caption="Odbiorca z Dokumentu NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca z Dokumentu Kraj" caption="Odbiorca z Dokumentu Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca z Dokumentu Województwo" caption="Odbiorca z Dokumentu Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca z Dokumentu Miasto" caption="Odbiorca z Dokumentu Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt z Dokumentu EAN" caption="Produkt z Dokumentu EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt z Dokumentu Kod" caption="Produkt z Dokumentu Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt z Dokumentu Kod Dostawcy" caption="Produkt z Dokumentu Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt z Dokumentu Nazwa" caption="Produkt z Dokumentu Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt z Dokumentu Numer Katalogowy" caption="Produkt z Dokumentu Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt z Dokumentu Opis" caption="Produkt z Dokumentu Opis" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt z Dokumentu PKWiU" caption="Produkt z Dokumentu PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt z Dokumentu Typ" caption="Produkt z Dokumentu Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAcAAAAAAAAAAAAAAAAAAAD/////uQAAAAcCPltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bICIgU1BBUlRBS1VTICIgU0tMRVAgU1BPUlRPV1ldBwI7W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLlsgIlNLT1JQSU9OIiBTS0xFUCBTUE9SVE9XWV0HAkRbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uWyIgQUZFS1QiIEFHRU5DSkEgUkVLTEFNT1dPLUhBTkRMT1dBXQcCPFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bIkFMQkFUUk9TIiBSb2JlcnQgQ3phcm5lY2tpXQcCJ1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bIkFNRVgiXQcCN1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bIkFSTUVELU9SVCIgU3AuIHogby5vLl0HAjZbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uWyJELk0uTSIgTUlDSEHFgSBNQVpVUl0HAjdbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uWyJELk0uTS4iIE1JQ0hBxYEgTUFaVVJdBwI9W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLlsiREFOVEVYIiBEYW5pZWwgxbtlbGF6bm93c2tpXQcCPFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bIkRBTlRFWCIgRGFuaWVsIMW7ZWxhem93c2tpXQcCLFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bIkdPUlRPLU1FRCJdBwI6W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLlsiS1JJREEgIiBTUMOTxYFLQSBDWVdJTE5BXQcCN1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bIktXSVROxIRDQSIgU1AuIFogTy5PLl0HAidbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uWyJMT1JEIl0HAj9bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uWyJNQUMgU1lTVEVNUyIgIE1BQ0lFSiBLVUtVQ1pLQV0HAjpbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uWyJNRVRSRVgiIE1BUkVLIENIT0NIUkFDS0ldBwI/W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLlsiUFJPU1BPUlQiIFPFgUFXT01JUiBLT05JRUNaTlldBwJUW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLlsicmVhbCwtIFNwLiB6IG8uby4gaSBTcMOzxYJrYSIgc3DDs8WCa2Ega29tYW5keXRvd2FdBwI1W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLlsiU1BPS0VZIiBTcC4uIHogby5vLl0HAi9bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uWyJTcG9ydG93eSBSYWoiXQcCKFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bIlRFTVBPIl0HAihbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uWyJUUk9QUyJdBwIjW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLls0TV0HAi1bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0FEQU0gQ0hBRFJPU10HAi1bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0FEQU0gV0FMQ1pBS10HAlNbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0FHRU5DSkEgRE9SQURaVFdBICBXIFpBS1JFU0lFIMSGV0lDWkXFgyBTScWBT1dZQ0gsXQcCPltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bQUdFTkNKQSBIQU5ETE9XQSBERVRBTCwgSFVSVCxdBwI2W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltBR05JRVNaS0EgS1dJQVRLT1dTS0FdBwI4W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltBaG9sZCBQb2xza2EgU3AuIHogby5vLl0HAi5bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0FMQkFUUk9TIFMuQy5dBwI3W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltBTEVLU0FORFJBIENFVE5FUk9XU0tBXQcCMFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bQUxFS1NBTkRSQSBVUkxBXQcCLVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bQUxGQSAtIEFMQVJNXQcCMVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bQW5kcnplaiBNYXR1c2lha10HAjRbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0FSQ08gU3R1ZGlvIFJla2xhbXldBwIyW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltBcmlhbmUgU0ssIHMuci5vLl0HAi5bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0FSVFVSIEtVUFJBQ1pdBwIuW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltBdGhsZXRpY1N0b3JlXQcCL1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bQi5VLkYuIFBSRVRJVU1dBwI0W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltCLlUuRi5ILiAiIFBSRVRJVU0iXQcCLFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bQkFDSEEgU1BPUlRdBwIzW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltCQVJCQVJBIMWaTUlFVEFOS0FdBwIzW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltCYXJ0xYJvbWllaiBTb8WEdGFdBwIyW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltCRUFUQSBLV0lBVEtPV1NLQV0HAjJbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0JFRE5BUkNaWUsgTEVTWkVLXQcCOltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bQkXFgUNIQVTDk1dESVMgU1AuIFogTy5PLl0HAidbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0JJQU1BUl0HAjFbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0JPUk9EWU5LTyBTVEVGQU5dBwIwW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltCUlVOT04gR1VaT1dTS0ldBwI7W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltCVVlIT01FIEN6YXN6ecWEc2tpIFRvbWFzel0HAi5bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0NBUk1FTiBGLkguVS5dBwI+W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltDRU5UVU0gSEFORExPV08gRFlTVFJZQlVDWUpORV0HAjBbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0RBTklFTCBLVVJPV1NLSV0HAi9bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0RBUklVU1ogQlJZxYFBXQcCMVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bRURXQVJEIElMQ1pZU1pZTl0HAjdbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0VMQkzEhEdESVMgIFNQLiBaIE8uTy5dBwI8W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltFTElURSBQT0xBTkQgRklUTkVTUyBTQ0hPT0xdBwIzW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltFTMW7QklFVEEgUE9XxYFPS0FdBwIpW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltFVVJPQklVUl0HAjNbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0VXQSBTRVdFUllOLUtPUEFDWl0HAjNbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0VYLVBSRVMgU1AuIFogTy5PLl0HAjNbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0YuSC4gIEFUTSBQT0xBTkQgIl0HAjNbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0YuSC4gIkNBU1RFTCIgUy5DLl0HAjFbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0YuSC5VIFJPV0VSLUxBTkRdBwIyW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltGLkguVS4gUk9XRVItTEFORF0HAilbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0ZBS1RPUklBXQcCLFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bRkhVICJSRU1FWCJdBwI0W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltGaXJtYSAiTElERVIgU1BPUlQiXQcCOVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bRmlybWEgIkxJREVSIFNQT1JUIiBzLmMuXQcCLVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bRmlybWEgIldPSk8iXQcCN1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bRklSTUEgSEFORExPV0EgIEVWSU1FWF0HAkRbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0ZJUk1BIFBST0RVS0NZSk8tVVPFgVVHT1dPLUhBTkRMT1dBXQcCNltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bR2RhxYRza2RpcyBTcC4geiBvLm8uXQcCOFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bR0VBTlQgUE9MU0tBIFNwLiB6IG8uby5dBwI4W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltHUlVQQSBGQUxDT04gUE9MQU5EIEZIVV0HAjpbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0dydXBwYTY2T2dpbHZ5IFNwLiB6IG8uby5dBwI3W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltHUlpFR09SWiBCxYFBxbtFSkVXU0tJXQcCNFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bR1JaRUdPUlogQ0hNSUVMRUNLSV0HAjRbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0dSWkVHT1JaIENIUkFQT05TS0ldBwI2W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltHcnplZ29yeiBTemN6ZXBpxYRza2ldBwI8W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltIQU5ERUwgREVUQUxJQ1pOWSBJIEhVUlRPV1ldBwIwW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltIRU5SWUsgV0/FuU5JQ0FdBwI2W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltIT09QIFBPTFNLQSBTUCBaIE8uTy5dBwI0W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltIT1NQLU1FRCBTcC4geiBvLm8uXQcCM1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bSU1NT01PSyBTUC4gWiBPLk8uXQcCM1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bSXdvbmEgS2/FvHVjaG93aWN6XQcCMltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bSmFkd2lnYSBXb2xub3dza2FdBwI1W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltKQUtJTU9XSUNaIEtSWllTWlRPRl0HAi9bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0pBUyAtIEZCRyBTLkEuXQcCMFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bSkVSWlkgR0FXScWDU0tJXQcCLFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bSsOTWkVGIFBZQ0hdBwIyW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltLQU1JTCBXT0pOQVJPV0lDWl0HAjFbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0tBUk9MIFBMVUNJxYNTS0ldBwJKW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltLQVVGTEFORCBQb2xza2EgTWFya2V0eSBTcC4geiBvLm8uIFNwLiBrLl0HAjtbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0tBVUZMQU5EIFBvbHNrYSBTcC4geiBvLm8uXQcCNVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bS0lFTENFRElTIFNQLiBaIE8uTy5dBwI3W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltLxYFPRFpLT0RJUyBTUC4gWiBPLk8uXQcCMltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bS3J6eXN6dG9mIEdsZXdpY3pdBwI2W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltMQVVCUi1TUE9SVCBDWiBzLnIuby5dBwI6W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltMQVVCUi1TUE9SVCBQTCBTUC4gWiBPLk8uXQcCM1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTEFVQlItU1BPUlQgUk8gU1JMXQcCOVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTEFVQlItU1BPUlQgU0sgc3BvbC4gc3JvXQcCMVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTEVDTEVSQyBXUk9DxYFBV10HAi5bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0xFU1pFSyBJTkdMT1RdBwI1W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltMVUJMSU5ESVMgU1AuIFogTy5PLl0HAi9bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW0xVQ1lOQSBCQVNJRUdBXQcCNltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bxYHDk0TFuURJUyBTUC4gWiBPLk8uXQcCNVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTWHFgmdvcnphdGEgTWlzemN6YWtdBwIyW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltNQcWBR09SWkFUQSBQT1BFUl0HAixbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW01BUkJBLVNQT1JUXQcCMFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTUFSQ0lOIEJST05FSktPXQcCLVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTUFSQ0lOIEZBUllTXQcCLVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTWFyZWsgTGVnZW5jXQcCL1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTUFSRUsgUFVDSEHFgUFdBwIuW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltNQVJJQSBNWUtBxYFBXQcCLltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTUFSSVVTWiBCSUVEQV0HAi9bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW01BUklVU1ogUEFXTEFLXQcCJ1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTWFydGtpXQcCM1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTUFURVVTWiBLQVJQScWDU0tJXQcCOVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTUFYSU1VUyBTdHVkaW8gUmVrcmVhY2ppXQcCKltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bbS1jb25jZXB0XQcCSltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTUVHQSBTUE9SVCBBLksuIFNUUllLT1dTS0kgU1DDk8WBS0EgSkFXTkFdBwI0W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltNSUNIQcWBIELEhENaS09XSUNaXQcCMVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bTWljaGHFgiBUeWJ1cmN6eV0HAjRbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW01vbmlrYSBTemN6ZXBhxYRza2FdBwIqW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltNVUxUSVNIT1BdBwIzW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltOSUpPTEEgU1RBTktJRVdJQ1pdBwIqW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltOT0VMIFMuQy5dBwI4W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltPTEXFmk5JQ0FESVMgU1AuIFogTy5PLl0HAi9bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1AgUC5VLkggQVJUTUVEXQcCL1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bUC5ILlUuICJGQVJBTCJdBwI8W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltQLkguVS4gIlJFSC1NRUQiIFNwLiB6IG8uby5dBwIzW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltQLlAuSC5VLiBURVJHIFMuSi5dBwIuW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltQQUxFU1RSQSBzLmMuXQcCPVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bUG9tb3Jza2llIENlbnRydW0gTWljcm9seXNpc10HAlVbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1BPV0lBVE9XRSBDRU5UUlVNIFpEUk9XSUEgU1DDk8WBS0EgeiBvLm8uIHcgS09XQVJBQ0hdBwJGW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltQcnplZHNpZWJpb3JzdHdvIFByb2R1a2N5am5vIEhhbmRsb3dlXQcCSVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bUHJ6ZWRzacSZYmllcnN0d28gV2llbG9icmFuxbxvd2UgIk5PUklNIl0HAkpbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1ByemVkc2nEmWJpb3JzdHdvIFdpZWxvYnJhbsW8b3dlICJIRUxLQU4iXQcCM1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bUkFET01ESVMgU1AgWiBPLk8uXQcCJ1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bUkVILUFTXQcCMFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bUk9NQU4gV0lFQ1pPUkVLXQcCJltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bUk9OSU5dBwIyW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltSWUJPVFlDS0EgREFOSUVMQV0HAjdbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1JaRVNaw5NXRElTIFNQLiBaIE8uTy5dBwI4W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltTLkYuIExBVUJSLVNQT1JUIHMuci5vLl0HAi5bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1MuTS5JV0FOT1dTQ1ldBwIrW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltTQVZJQSBTLkEuXQcCMltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bU0VST0tBIFNUQU5JU8WBQVddBwI2W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltTSUxFU0lBRElTIFNQLiBaIE8uTy5dBwJHW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltTS0xFUCBBUlRZS1XFgcOTVyBQUlpFTVlTxYFPV1lDSCJBR0FUIl0HAjlbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1NLTEVQIFNQT1JUT1dZICAiIFJFTEFYIl0HAj5bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1NLTEVQIFNQT1JUT1dZICIgT1JLQU4gIiBTLkMuXQcCNltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bU2tsZXAgU3BvcnRvd3kgIlRFQU0iXQcCQVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bU0tMRVAgU1BPUlRPV1kgRS4gWi4gV0lUVElHIFMuQy5dBwI1W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltTxYFVUFNLRElTIFNQIFogTy5PLl0HAi5bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1NQT1JULVNIT1AuUExdBwI1W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltTcHJ6ZWRhxbwgZGV0YWxpY3puYV0HAjVbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1NUQU5JU8WBQVcgTU9MSVRPUllTXQcCL1tLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bU1RSWkVQRUtQQVdFxYFdBwIzW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltTemVsaWdvd3NraSBIZW5yeWtdBwIvW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltTWllNQ1pZSyBIQU5OQV0HAjNbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1RhZGV1c3ogRMSFYnJvd3NraV0HAjJbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1RFQ0hOSUtBIE1FRFlDWk5BXQcCTltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bVEVMRVdJWkpBIFBPTFNLQSBTLkEuIFogU0lFRFpJQsSEIFcgV0FSU1pBV0lFXQcCMltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bVEVSRVNBIERST1pEQUxTS0FdBwI6W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltURVNDTyAvUE9MU0tBLyBTcC4geiBvLm8uXQcCLVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bVE9NQVNaIERVTE5ZXQcCLltLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bVE9NQVNaIEdSQUpOWV0HAi1bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1RPTUFTWiBQQU1JTl0HAjNbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1RVUklTRElTIFNQIFogTy5PLl0HAjRbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1RZQ0hZRElTIFNQLiBaIE8uTy5dBwIyW0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLltWLUdBTExFUlkgIFAuSC5VLl0HAjtbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1ZJQ08tICBUUkFWRUwgVHJlbGEgSGVsZW5hXQcCNFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bV0FSU1pBRElTIFNQIFogTy5PLl0HAjZbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1dBUlNaQVdBRElTIFNQIFogTy5PLl0HAjJbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1dPSkNJRUNIIEtBUkVXSUNaXQcCOFtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bV1JPQ8WBQVdESVMgU1AuICBaIE8uTy5dBwI3W0tvbnRyYWhlbnQgeiBEb2t1bWVudHUgTmF6d2FdLlt3d3cuaGVhbHRoYW5kYmVhdXR5LnBsXQcCPVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bV3lkYXduaWN0d28gIFIuS0xVU1pDWlnFg1NLSV0HAkJbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1pBS8WBQUQgU1RPTEFSU0tJIEpBTlVTWiBLSUpFV1NLSV0HAjtbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1pBS8WBQURZIE1FQkxBUlNLSUUgRE9SSkFOXQcCMVtLb250cmFoZW50IHogRG9rdW1lbnR1IE5hendhXS5bWkJJR05JRVcgVE9NRUNLSV0HAkVbS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1pFU1DDk8WBIFNaS09MTk8gLSBQUlpFRFNaS09MTlkgTlIuNF0HAi1bS29udHJhaGVudCB6IERva3VtZW50dSBOYXp3YV0uW1pPRklBICBLVVJFS10AAAAAAAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="275" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" formula="( Sprzedaż Wartość= 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Sprzedaż Wartość)" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent z Dokumentu Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt z Dokumentu Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt z Dokumentu Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt z Dokumentu Opis"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Wartość" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent z Dokumentu Nazwa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt z Dokumentu Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt z Dokumentu Nazwa" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt z Dokumentu Opis" index="3" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Sprzedaży - Pełne dane z dokumentów wersja 37.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o sprzedaży w firmie. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Analizy oparte są o faktury sprzedaży, paragony nieskojarzone z fakturą sprzedaży i dokumenty &#xD;
skojarzone. Niebrane pod uwagę są natomiast następujące dokumenty pierwotne a także dokumenty anulowane.&#xD;
&#xD;
Dane dla kontrahentów i produktów pobierane są z poziomu dokumentu (Wymiary "z Dokumentu")</a:description><a:id>97</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.62 Raport Sprzedaży - Pełne dane z dokumentów</a:mainLinkName><a:modifiedOn>2025-05-30T14:44:18.707</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>3</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2013-01-23T11:37:57.807</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
/* RAPORT_INFO	&#xD;
* Sprzedaż wg. cen w zakresie dat&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
/*&#xD;
DECLARE --Parametry Raportu		&#xD;
		 @DATAOD DATE = '2010-01-01' &#xD;
		,@DATADO DATE = '2026-12-31';&#xD;
*/&#xD;
&#xD;
DECLARE --Zmienne pomocnicze	&#xD;
		@serwerKonf			VARCHAR(MAX) = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
		,@bazaKonf				VARCHAR(MAX) = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
		,@bazaFirmowa			VARCHAR(MAX) = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
		,@wal					VARCHAR(3)	 = cdn.Waluta('')&#xD;
		,@SQLPaczka1_Kolumny	VARCHAR(MAX) = N''&#xD;
		,@SQLPaczka1_Tabele		VARCHAR(MAX) = N''&#xD;
		,@SQLPaczka2_Kolumny	VARCHAR(MAX) = N''&#xD;
		,@SQLPaczka2_Tabele		VARCHAR(MAX) = N'';&#xD;
DECLARE	--Połączenia do tabel bazy konfiguracyjnej (bazy, operatorzy)	&#xD;
		 @Operatorzy	VARCHAR(MAX) = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]'&#xD;
		,@Bazy			VARCHAR(MAX) = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]';&#xD;
BEGIN	--Wyliczanie poziomów grup produktów							&#xD;
WITH g (&#xD;
    gid&#xD;
    ,gidTyp&#xD;
    ,kod&#xD;
    ,gidNumer&#xD;
    ,grONumer&#xD;
    ,poziom&#xD;
    ,sciezka&#xD;
    )&#xD;
AS (&#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,0 AS poziom&#xD;
        ,convert(NVARCHAR(1024), '') AS sciezka&#xD;
    FROM CDN.TwrGrupy&#xD;
    WHERE TwG_TwGID = 0&#xD;
    &#xD;
    UNION ALL&#xD;
    &#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,p.poziom + 1 AS poziom&#xD;
        ,convert(NVARCHAR(1024), p.sciezka + N'\' + c.TwG_Kod) AS sciezka&#xD;
    FROM g p&#xD;
    JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer&#xD;
    WHERE c.TwG_TwGID &lt;&gt; 0&#xD;
        AND c.TwG_GIDTyp = - 16&#xD;
    )&#xD;
SELECT *&#xD;
INTO #tmpTwrGr&#xD;
FROM g&#xD;
&#xD;
DECLARE @poziom INT&#xD;
DECLARE @poziom_max INT&#xD;
DECLARE @sql NVARCHAR(max)&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom)&#xD;
FROM #tmpTwrGr&#xD;
&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0&#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50), ONr' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50)'&#xD;
&#xD;
    EXEC (@sql)&#xD;
&#xD;
    IF @poziom = @poziom_max&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS NVARCHAR) + '= grONumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS NVARCHAR) + ' = kod'&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
    ELSE&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
&#xD;
DECLARE @kolumny VARCHAR(max)&#xD;
DECLARE @i INT&#xD;
&#xD;
SET @kolumny = ''&#xD;
SET @i = 0&#xD;
&#xD;
WHILE (@i &lt;= @poziom_max)&#xD;
BEGIN&#xD;
    SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' + LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    SET @i = @i + 1&#xD;
END&#xD;
END;&#xD;
BEGIN	--Wyliczanie Atrybutów Kontrahentów								&#xD;
DECLARE @atrybut_id INT&#xD;
    ,@atrybut_kod NVARCHAR(50)&#xD;
    ,@atrybut_typ INT&#xD;
    ,@atrybut_format INT&#xD;
    ,@atrybuty VARCHAR(max)&#xD;
    ,@sqlA NVARCHAR(max);&#xD;
DECLARE @wersja FLOAT;&#xD;
&#xD;
SET @wersja = (&#xD;
        SELECT CONVERT(FLOAT, SYS_Wartosc)&#xD;
        FROM CDN.SystemCDN&#xD;
        WHERE SYS_ID = 3&#xD;
        )&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId&#xD;
    ,KnA_PodmiotTyp&#xD;
INTO #tmpKonAtr&#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
END;&#xD;
BEGIN	--Wyliczanie Atrybutów Dokumentów								&#xD;
DECLARE @atrybutyDok VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId&#xD;
INTO #tmpDokAtr&#xD;
FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
END;&#xD;
BEGIN	--Wyliczanie Atrybutów Towarów									&#xD;
DECLARE @atrybutyTwr VARCHAR(max)&#xD;
    ,@atrybutyTwr2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId&#xD;
INTO #tmpTwrAtr&#xD;
FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
END;&#xD;
BEGIN	--Wyliczanie Atrybutów Pozycji									&#xD;
DECLARE @atrybutyPoz VARCHAR(max)&#xD;
    ,@atrybutyPoz2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId&#xD;
INTO #tmpPozAtr&#xD;
FROM CDN.TraElemAtr&#xD;
	JOIN CDN.TraElem ON TrA_TrEId = TrE_TrEID&#xD;
	JOIN CDN.TraNag ON TrE_TrNId = TrN_TrNID&#xD;
WHERE&#xD;
	TrN_TypDokumentu IN (-1,302,305)&#xD;
	AND TrN_Bufor&lt;&gt;-1&#xD;
	AND TrE_Aktywny&lt;&gt;0&#xD;
	AND TrN_DataOpe BETWEEN @DATAOD AND @DATADO&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
END;&#xD;
BEGIN	--Tworzenie tabeli z serią dokumentów							&#xD;
	SELECT	 [DDf_DDfID] = DDf_DDfID&#xD;
			,[seria]	 = CASE &#xD;
							WHEN DDf_Numeracja LIKE '@rejestr%' THEN 5&#xD;
							WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
							WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
							WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
							WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
							END &#xD;
	INTO #tmpSeria&#xD;
	FROM CDN.DokDefinicje&#xD;
END;&#xD;
BEGIN	--Tworzenie tabeli z kosztami granicznymi						&#xD;
SELECT SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TNFS.TrN_TrNID TransId&#xD;
INTO #tmpKosztyGraniczne&#xD;
FROM cdn.tranag TNKG&#xD;
JOIN cdn.traelem TEKG ON TEKG.tre_trnid = TNKG.TrN_TrNID&#xD;
JOIN cdn.Tranag TNFZ ON TNFZ.Trn_trnid = TNKG.TrN_ZwrId&#xD;
JOIN cdn.TranagRelacje ON TNFZ.Trn_trnid = TrR_TrNId&#xD;
    AND TrR_FaTyp IN (&#xD;
        302&#xD;
        ,305&#xD;
        )&#xD;
JOIN cdn.Tranag TNFS ON TNFS.TrN_TrNID = TrR_FaId&#xD;
JOIN cdn.TraElem TEFS ON TNFS.trn_trnid = TEFS.TrE_TrNId&#xD;
    AND TEKG.TrE_Lp = TEFS.TrE_LpPow&#xD;
WHERE TNKG.trn_rodzaj IN (&#xD;
        301008&#xD;
        ,301009&#xD;
        ,301018&#xD;
        )&#xD;
GROUP BY TEFS.TrE_TrEID&#xD;
    ,TNFS.TrN_TrNID&#xD;
&#xD;
	END;&#xD;
BEGIN	--Tworzenie tabelki pomocniczej do liczenia marży				&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
					 END;&#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @SQLPaczka1_Kolumny = N'			/* Paczka 1 | Faktury, Paragony */ SELECT	&#xD;
	 [Baza Firmowa]							= BAZ.Baz_Nazwa &#xD;
	,[Liczba Dokumentów]					= DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) &#xD;
	,[Dokument Numer]						= trn.TrN_NumerPelny &#xD;
	,[Dokument Opis]						= ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') &#xD;
	,[Dokument Symbol]						= dd.DDf_Symbol &#xD;
	,[Dokument Seria]						= CASE when isnull(ser.seria,0) = 5 then substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
												ELSE ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
												END &#xD;
	,[Dokument Godzina Wystawienia]			= CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' &#xD;
	,[Waluta]								= ISNULL(NULLIF(trn.TrN_Waluta, ''''),'''+@wal+''') &#xD;
	,[Forma Płatności]						= FPl_Nazwa &#xD;
	,[Kategoria Szczegółowa z Nagłówka]		= ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
	,[Kategoria Szczegółowa z Pozycji]		= ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
	,[Kategoria Ogólna z Nagłówka]			= ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') &#xD;
	,[Kategoria Ogólna z Pozycji]			= ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') &#xD;
	,[Kontrahent Pierwotny Nazwa]			= pod1.Pod_Nazwa1 &#xD;
	,[Kontrahent Pierwotny Kod]				= pod1.Pod_Kod &#xD;
	,[Kontrahent Pierwotny Województwo]		= ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
	,[Kontrahent Pierwotny Miasto]			= ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') &#xD;
	,[Kontrahent Pierwotny Kraj]			= ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') &#xD;
	,[Kontrahent Pierwotny NIP]				= ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') &#xD;
	,[Kontrahent Pierwotny Grupa]			= ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') &#xD;
	,[Kontrahent Pierwotny Kategoria]		= ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
	,[Kontrahent Pierwotny Opiekun]			= CASE knt1.Knt_OpiekunTyp&#xD;
												WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
												WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
												ELSE ''(NIEPRZYPISANE)'' &#xD;
												END &#xD;
	,[Kontrahent Pierwotny Rodzaj]			= reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
												(CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
												(CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
												(CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
												(CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
												(CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) &#xD;
	,[Liczba Kontrahentów]					= DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  &#xD;
	,[Kontrahent Nazwa]						= pod5.Pod_Nazwa1 &#xD;
	,[Kontrahent Kod]						= pod5.Pod_Kod &#xD;
	,[Kontrahent Województwo]				= ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
	,[Kontrahent Miasto]					= ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') &#xD;
	,[Kontrahent Kraj]						= ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') &#xD;
	,[Kontrahent NIP]						= ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') &#xD;
	,[Kontrahent Grupa]						= ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') &#xD;
	,[Kontrahent Kategoria]					= ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
	,[Kontrahent Opiekun]					= CASE knt3.Knt_OpiekunTyp&#xD;
												WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
												WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
												ELSE ''(NIEPRZYPISANE)'' &#xD;
												END &#xD;
	,[Kontrahent Rabat]						= CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' &#xD;
	,[Kontrahent Rodzaj]					= reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
												(CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
												(CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
												(CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
												(CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
												(CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) &#xD;
	,[Liczba Odbiorców]						= DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  &#xD;
	,[Odbiorca Nazwa]						= pod3.Pod_Nazwa1 &#xD;
	,[Odbiorca Kod]							= pod3.Pod_Kod &#xD;
	,[Odbiorca Województwo]					= ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
	,[Odbiorca Miasto]						= ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') &#xD;
	,[Odbiorca Kraj]						= ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') &#xD;
	,[Odbiorca Grupa]						= ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') &#xD;
	,[Odbiorca Opiekun]						=  CASE knt2.Knt_OpiekunTyp&#xD;
												WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
												WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
												ELSE ''(NIEPRZYPISANE)'' &#xD;
												END &#xD;
	,[Operator Wprowadzający]				= zal.Ope_Kod &#xD;
	,[Operator Modyfikujący]				= mod.Ope_Kod &#xD;
	,[Liczba Produktów]						= DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  &#xD;
	,[Produkt Kategoria]					= ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
	,[Produkt Nazwa]						= Twr_Nazwa &#xD;
	,[Produkt e-Sklep]						= CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END&#xD;
	,[Produkt Nazwa z Faktury]				= TR.Tre_TwrNazwa &#xD;
	,[Produkt PKWiU]						= CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END &#xD;
	,[Produkt Dostawca]						= ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  &#xD;
	,[Produkt Aktywny]						= CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END &#xD;
	,[Produkt Kod CN]						= KCN_Kod &#xD;
	,[Produkt Kod]							= Twr_Kod &#xD;
	,[Produkt Numer Katalogowy]				= Twr_NumerKat &#xD;
	,[Produkt Opis]							= CAST(Twr_Opis as VARCHAR(1024)) &#xD;
	,[Produkt Pełna Nazwa Grupy]			= poz.sciezka &#xD;
	,[Produkt Lp.]							= Tre_Lp &#xD;
	,[Produkt Kaucja]						= CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END &#xD;
	,[Jednostka Miary]						= Twr_Jm &#xD;
	,[Magazyn Nazwa]						= Mag_Symbol &#xD;
	,[Produkt Producent]					= ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') &#xD;
	,[Produkt Marka]						= ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') &#xD;
	,[Produkt Typ]							= CASE &#xD;
												WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
												WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
												WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
												WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
												END &#xD;
	,[Czas Aktualny Dziś]					= CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END &#xD;
	,[Czas Aktualny Wczoraj]				= CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END &#xD;
	,[Czas Aktualny Tydzień]				= CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
												THEN ''TAK'' &#xD;
												ELSE ''NIE'' &#xD;
												END &#xD;
	,[Czas Aktualny Miesiąc]				= CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END&#xD;
	,[Czas Aktualny Miesiąc Poprzedni]		= CASE &#xD;
												WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
												WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
												ELSE ''NIE'' &#xD;
												END &#xD;
	,[Czas Aktualny Data]					= GETDATE() &#xD;
	,[Sprzedaż Wartość]						= TR.TrE_WartoscNetto &#xD;
	,[Sprzedaż Wartość Brutto]				=  TR.TrE_WartoscBrutto &#xD;
	,[Sprzedaż Wartość Waluta]				=  TR.TrE_WartoscNettoWal &#xD;
	,[Sprzedaż Ilość]						= TR.TrE_Ilosc &#xD;
	,[Koszt Zakupu]							= (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) &#xD;
	,[Sprzedaż Marża]						= TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) &#xD;
	,[Sprzedaż Rabat]						= TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/ISNULL(NULLIF([TrE_JMPrzelicznikL],0),1)*[TrE_JMPrzelicznikM])) * TrE_KursL / ISNULL(NULLIF(TrE_KursM,0),1) &#xD;
	,[Jednostka Miary Pomocnicza]			= ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') &#xD;
	,[Produkt EAN]							= ISNULL(Twr_EAN,''(BRAK)'') &#xD;
	,[Produkt Kod Dostawcy]					= ISNULL(Twr_KodDostawcy,''(BRAK)'') &#xD;
    ,[Cena początkowa]						= TrE_Cena0WD &#xD;
    ,[Cena transakcyjna]					= TrE_CenaWWD&#xD;
	&#xD;
    ,[Sprzedaż Ilość Jednostka Pomocnicza]	= CAST(TR.TrE_Ilosc/ ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS DECIMAL(26,10)) &#xD;
    ,[Produkt Pozycja Dokumentu]			= TR.TrE_Lp  &#xD;
	,[Produkt Cena Nazwa]					= Cen.DfC_Nazwa &#xD;
	,[Produkt Cena Typ]						= IIF(Cen.DfC_Typ = 1,''Netto'',''Brutto'')&#xD;
	,[Produkt Cena Rodzaj]					= IIF(Cen.DfC_Lp  = 1,''Cena zakupu'',''Cena sprzedaży'')&#xD;
    ,[Koszt Zakupu Koszty Graniczne]		= KosztyGraniczne&#xD;
    ,[Waluta Koszt Zakupu]					= ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) &#xD;
    ,[Koszt Zakupu Waluta]					= ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1),TR.TrE_KosztUslugi)	&#xD;
    &#xD;
	/*&#xD;
    ----------DATY POINT&#xD;
    ,[Data Operacji]	= REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') &#xD;
    ,[Data Wystawienia] = REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') &#xD;
    ,[Termin Płatności] = REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin,  111), ''/'', ''-'')  &#xD;
    */&#xD;
&#xD;
    ----------DATY ANALIZY&#xD;
    ,[Data Operacji Dzień]				= REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') &#xD;
    ,[Data Operacji Tydzień Roku]		= (datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ &#xD;
    ,[Data Operacji Miesiąc]			= MONTH(trn.TrN_DataOpe) &#xD;
	,[Data Operacji Kwartał]			= DATEPART(quarter, trn.TrN_DataOpe) &#xD;
	,[Data Operacji Rok]				= YEAR(trn.TrN_DataOpe) &#xD;
    ,[Data Wystawienia Dzień]			= REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') &#xD;
    ,[Data Wystawienia Tydzień Roku]	= (datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/  &#xD;
    ,[Data Wystawienia Miesiąc]			= MONTH(trn.TrN_DataWys) &#xD;
	,[Data Wystawienia Kwartał]			= DATEPART(quarter, trn.TrN_DataWys) &#xD;
	,[Data Wystawienia Rok]				= YEAR(trn.TrN_DataWys) &#xD;
    ,[Termin Płatności Dzień]			= REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') &#xD;
    ,[Termin Płatności Tydzień Roku]	= (datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7  /*DATEPART(isowk, trn.TrN_Termin)*/ &#xD;
    ,[Termin Płatności Miesiąc]			= MONTH(trn.TrN_Termin) &#xD;
	,[Termin Płatności Kwartał]			= DATEPART(quarter, trn.TrN_Termin) &#xD;
	,[Termin Płatności Rok]				= YEAR(trn.TrN_Termin) &#xD;
    &#xD;
	----------KONTEKSTY&#xD;
    ,[Dokument Numer __PROCID__Sprzedaz__]		= CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END &#xD;
	,[Dokument Numer __ORGID__]					= trn.TrN_TrNId &#xD;
	,[Dokument Numer __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
    ,[Kontrahent Pierwotny Nazwa __PROCID__]	= 20201 &#xD;
	,[Kontrahent Pierwotny Nazwa __ORGID__]		= pod1.Pod_PodId &#xD;
	,[Kontrahent Pierwotny Nazwa __DATABASE__]  = '''+@bazaFirmowa+''' &#xD;
    ,[Kontrahent Pierwotny Kod __PROCID__]		= 20201 &#xD;
	,[Kontrahent Pierwotny Kod __ORGID__]		= pod1.Pod_PodId &#xD;
	,[Kontrahent Pierwotny Kod __DATABASE__]	= '''+@bazaFirmowa+''' &#xD;
    ,[Kontrahent Nazwa __PROCID__]				= 20201 &#xD;
	,[Kontrahent Nazwa __ORGID__]				= pod5.Pod_PodId &#xD;
	,[Kontrahent Nazwa __DATABASE__]			= '''+@bazaFirmowa+''' &#xD;
    ,[Kontrahent Kod __PROCID__Kontrahenci__]	= 20201 &#xD;
	,[Kontrahent Kod __ORGID__]					= pod5.Pod_PodId &#xD;
	,[Kontrahent Kod __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
    ,[Odbiorca Nazwa __PROCID__]				= 20201 &#xD;
	,[Odbiorca Nazwa __ORGID__]					= pod3.Pod_PodId &#xD;
	,[Odbiorca Nazwa __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
    ,[Odbiorca Kod __PROCID__]					= 20201 &#xD;
	,[Odbiorca Kod __ORGID__]					= pod3.Pod_PodId &#xD;
	,[Odbiorca Kod __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
    ,[Produkt Nazwa __PROCID__]					= 25003 &#xD;
	,[Produkt Nazwa __ORGID__]					= Twr_twrId &#xD;
	,[Produkt Nazwa __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
    ,[Produkt Kod __PROCID__Towary__]			= 25003 &#xD;
	,[Produkt Kod __ORGID__]					= Twr_twrId&#xD;
	,[Produkt Kod __DATABASE__]					= '''+@bazaFirmowa+''' &#xD;
    ,[Magazyn Nazwa __PROCID__Magazyny__]		= 29056 &#xD;
	,[Magazyn Nazwa __ORGID__]					= Mag_MagId &#xD;
	,[Magazyn Nazwa __DATABASE__]				= '''+@bazaFirmowa+'''  ' &#xD;
	+ @kolumny &#xD;
	+ @atrybuty &#xD;
	+ @atrybutyDok &#xD;
	+ @atrybutyTwr &#xD;
	+ @atrybutyPoz;&#xD;
SET @SQLPaczka1_Tabele	= N' FROM cdn.TraNag trn	&#xD;
			 	 JOIN cdn.TraElem			TR		ON TrE_TrNID=trn.TrN_TrNID &#xD;
				 JOIN cdn.DefCeny			Cen		ON TrE_TwCNumer = Cen.DfC_DfCid &#xD;
			LEFT JOIN #tmpSeria				ser		ON trn.TrN_DDfId = DDf_DDfID&#xD;
			LEFT JOIN CDN.DokDefinicje		dd		ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
			LEFT JOIN (select * from cdn	.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
      LEFT OUTER JOIN CDN.Kontrahenci		knt1	ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
      LEFT OUTER JOIN CDN.PodmiotyView		pod1	ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN CDN.PodmiotyView		pod3	ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN cdn.PodmiotyView		pod2	ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN CDN.Kontrahenci		knt2	ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
      LEFT OUTER JOIN cdn.PodmiotyView		pod4	ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
				 JOIN CDN.Towary					ON TrE_TwrId=Twr_TwrId&#xD;
			LEFT JOIN CDN.KodyCN					on Twr_KCNId = KCN_KCNId&#xD;
			LEFT JOIN CDN.Producenci				ON Prd_PrdId = Twr_PrdId&#xD;
			LEFT JOIN CDN.Marki						ON Mrk_MrkId = Twr_MrkId&#xD;
				 JOIN CDN.Magazyny					ON TrE_MagId=Mag_MagId &#xD;
      LEFT OUTER JOIN CDN.Kategorie			kat1	ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
      LEFT OUTER JOIN CDN.Kategorie			kat2	ON TrE_KatID=kat2.Kat_KatID&#xD;
      LEFT OUTER JOIN CDN.Kategorie			kat3	ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
      LEFT OUTER JOIN CDN.Kategorie			kat4	ON Twr_KatID=kat4.Kat_KatID&#xD;
      LEFT OUTER JOIN cdn.PodmiotyView		pod5	on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
      LEFT OUTER JOIN CDN.Kontrahenci		knt3	ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
			LEFT JOIN CDN.Rabaty					on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND trn.TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
      LEFT OUTER JOIN CDN.Kategorie			kat5	ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
      LEFT OUTER JOIN cdn.PodmiotyView		pod6	ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
			LEFT JOIN #tmpTwrGr				Poz		ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
			LEFT JOIN #tmpKonAtr			KonAtr	ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
			LEFT JOIN #tmpKonAtr			KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
			LEFT JOIN #tmpKonAtr			OdbAtr	ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
			LEFT JOIN #tmpDokAtr			DokAtr	ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
			LEFT JOIN #tmpTwrAtr			TwrAtr	ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
			LEFT JOIN #tmpPozatr			PozAtr	on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
			LEFT JOIN '+@Operatorzy+'		opk		ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
			LEFT JOIN '+@Operatorzy+'		opk2	ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
			LEFT JOIN '+@Operatorzy+'		zal		ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
			LEFT JOIN '+@Operatorzy+'		mod		ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
			LEFT JOIN '+@Operatorzy+'		opk3	ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
			LEFT JOIN CDN.FormyPlatnosci			ON trn.TrN_FPlId = FPl_FPlId&#xD;
			LEFT JOIN CDN.Kontrahenci		knt4	ON Twr_KntId = knt4.Knt_KntId&#xD;
			LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN #tmpKosztyGraniczne ON ElemId = TR.Tre_Treid&#xD;
    LEFT JOIN '+@Bazy+' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
		WHERE trn.TrN_TypDokumentu  IN (-1,302,305)&#xD;
		  AND trn.TrN_Bufor			&lt;&gt; -1&#xD;
		  AND TrE_Aktywny			&lt;&gt;  0&#xD;
		  AND TrE_UslugaZlozonaId	=   0&#xD;
		  AND trn.TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120) ';&#xD;
SET @SQLPaczka2_Kolumny	= N' UNION ALL	/* Paczka 2 | Korekty Zbiorcze  */ SELECT	&#xD;
				 [Baza Firmowa]							= BAZ.Baz_Nazwa &#xD;
				,[Liczba dokumentów]					= DB_NAME()+convert(Varchar(10),TrN_TrNID) &#xD;
				,[Dokument Numer]						= TrN_NumerPelny &#xD;
				,[Dokument Opis]						= ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') &#xD;
				,[Dokument Symbol]						= dd.DDf_Symbol &#xD;
				,[Dokument Seria]						= CASE &#xD;
															WHEN isnull(ser.seria,0) = 5 then substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
															ELSE ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
															END &#xD;
				,[Dokument Godzina Wystawienia] = CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' &#xD;
				,[Waluta] = ISNULL(NULLIF(TrN_Waluta, ''''),'''+@wal+''') &#xD;
				,[Forma Płatności]						= FPl_Nazwa &#xD;
				,[Kategoria Szczegółowa z Nagłówka]		= ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
				,[Kategoria Szczegółowa z Pozycji]		= ''(PUSTA)'' &#xD;
				,[Kategoria Ogólna z Nagłówka]			= ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') &#xD;
				,[Kategoria Ogólna z Pozycji]			= ''(PUSTA)'' &#xD;
				,[Kontrahent Pierwotny Nazwa]			= pod1.Pod_Nazwa1 &#xD;
				,[Kontrahent Pierwotny Kod]				= pod1.Pod_Kod &#xD;
				,[Kontrahent Pierwotny Województwo]		= ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
				,[Kontrahent Pierwotny Miasto]			= ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') &#xD;
				,[Kontrahent Pierwotny Kraj]			= ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') &#xD;
				,[Kontrahent Pierwotny NIP]				= ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') &#xD;
				,[Kontrahent Pierwotny Grupa]			= ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') &#xD;
				,[Kontrahent Pierwotny Kategoria]		= ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') &#xD;
				,[Kontrahent Pierwotny Opiekun]			= CASE knt1.Knt_OpiekunTyp&#xD;
															WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
															WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
															ELSE ''(NIEPRZYPISANE)'' &#xD;
															END &#xD;
				,[Kontrahent Pierwotny Rodzaj]			= reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
															(CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
															(CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
															(CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
															(CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
															(CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) &#xD;
				,[Liczba Kontrahentów]					= DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) &#xD;
				,[Kontrahent Nazwa]						= pod5.Pod_Nazwa1 &#xD;
				,[Kontrahent Kod]						= pod5.Pod_Kod &#xD;
				,[Kontrahent Województwo]				= ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
				,[Kontrahent Miasto]					= ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') &#xD;
				,[Kontrahent Kraj]						= ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') &#xD;
				,[Kontrahent NIP]						= ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') &#xD;
				,[Kontrahent Grupa]						= ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') &#xD;
				,[Kontrahent Kategoria]					=  ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'')&#xD;
				,[Kontrahent Opiekun]					= CASE knt3.Knt_OpiekunTyp&#xD;
															WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
															WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
															ELSE ''(NIEPRZYPISANE)'' &#xD;
															END &#xD;
				,[Kontrahent Rabat]						= CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' &#xD;
				,[Kontrahent Rodzaj]					= reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
															(CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
															(CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
															(CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
															(CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
															(CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, ''''))&#xD;
				,[Liczba Odbiorców]						= DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  &#xD;
				,[Odbiorca Nazwa]						= pod3.Pod_Nazwa1 &#xD;
				,[Odbiorca Kod]							= pod3.Pod_Kod &#xD;
				,[Odbiorca Województwo]					= ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') &#xD;
				,[Odbiorca Miasto]						= ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') &#xD;
				,[Odbiorca Kraj]						= ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') &#xD;
				,[Odbiorca Grupa]						= ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') &#xD;
				,[Odbiorca Opiekun]						= CASE knt2.Knt_OpiekunTyp&#xD;
															WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
															WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
															ELSE ''(NIEPRZYPISANE)'' &#xD;
															END &#xD;
				&#xD;
				,[Operator Modyfikujący]				= mod.Ope_Kod&#xD;
				,[Operator Wprowadzający]				= zal.Ope_Kod  &#xD;
				,[Liczba Produktów]						= null  &#xD;
				,[Produkt Kategoria]					= ''(PUSTA)'' &#xD;
				&#xD;
				--Produkt&#xD;
				,[Produkt Nazwa]						= ''Korekta zbiorcza'' &#xD;
				,[Produkt e-Sklep]						= ''Korekta zbiorcza'' &#xD;
				,[Produkt Nazwa z Faktury]				= ''Korekta zbiorcza'' &#xD;
				,[Produkt PKWiU]						= ''(BRAK)'' &#xD;
				,[Produkt Dostawca]						= ''(BRAK)'' &#xD;
				,[Produkt Aktywny]						= ''(BRAK)'' &#xD;
				,[Produkt Kod CN]						= ''(BRAK)'' &#xD;
				,[Produkt Kod]							= ''Korekta zbiorcza'' &#xD;
				,[Produkt Numer Katalogowy]				= ''Korekta zbiorcza'' &#xD;
				,[Produkt Opis]							= ''Korekta zbiorcza'' &#xD;
				,[Produkt Pełna Nazwa Grupy]			= ''Korekta zbiorcza'' &#xD;
				,[Produkt Lp.]							= NULL &#xD;
				,[Produkt Kaucja]						= ''NIE''&#xD;
				&#xD;
				--Jednostka miary&#xD;
				,[Jednostka Miary]						= ''(BRAK)'' &#xD;
				&#xD;
				--Magazyn&#xD;
				,[Magazyn Nazwa]						= ''(BRAK)'' &#xD;
				&#xD;
				&#xD;
				,[Produkt Producent]					= ''(BRAK)'' &#xD;
				,[Produkt Marka]						= ''(BRAK)'' &#xD;
				,[Produkt Typ]							= ''Korekta zbiorcza'' &#xD;
				&#xD;
				--Czas Aktualny&#xD;
				,[Czas Aktualny Dziś]					= CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END &#xD;
				,[Czas Aktualny Wczoraj]				= CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END &#xD;
				,[Czas Aktualny Tydzień]				= CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
															ELSE ''NIE'' &#xD;
															END &#xD;
				,[Czas Aktualny Miesiąc]				= CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END &#xD;
				,[Czas Aktualny Miesiąc Poprzedni]		= CASE &#xD;
															WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
															WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
															ELSE ''NIE'' &#xD;
															END &#xD;
				,[Czas Aktualny Data]					= GETDATE() &#xD;
				,[Sprzedaż Wartość]						= TrN_RazemNetto &#xD;
				,[Sprzedaż Wartość Brutto]				= TrN_RazemBrutto &#xD;
				,[Sprzedaż Wartość Waluta]				= TrN_RazemNettoWal &#xD;
				,[Sprzedaż Ilość]						= 0 &#xD;
				,[Koszt Zakupu]							= KosztWyliczony.Koszt &#xD;
				,[Sprzedaż Marża]						= TrN_RazemNetto - KosztWyliczony.Koszt &#xD;
				,[Sprzedaż Rabat]						= TrN_RabatWartosc &#xD;
				,[Jednostka Miary Pomocnicza]			= ''(BRAK)'' &#xD;
				,[Produkt EAN]							= ''(BRAK)'' &#xD;
				,[Produkt Kod Dostawcy]					= ''(BRAK)'' &#xD;
				,[Cena początkowa]						= NULL &#xD;
				,[Cena transakcyjna]					= NULL &#xD;
				,[Sprzedaż Ilość Jednostka Pomocnicza]	= 0 &#xD;
				,[Produkt Pozycja Dokumentu]			= NULL &#xD;
				,[Produkt Cena Nazwa]					= ''(BRAK)'' &#xD;
				,[Produkt Cena Typ]						= ''(BRAK)''&#xD;
				,[Produkt Cena Rodzaj]					= ''(BRAK)''&#xD;
				,[Koszt Zakupu Koszty Graniczne]		= KosztyGraniczne&#xD;
				,[Waluta Koszt Zakupu]					= KosztWyliczony.TRE_Waluta &#xD;
				,[Koszt Zakupu Waluta]					= (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0)) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1)&#xD;
				&#xD;
				/*&#xD;
				----------DATY POINT&#xD;
				,[Data Operacji]	= REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')  &#xD;
				,[Data Wystawienia] = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') &#xD;
				,[Termin Płatności] = REPLACE(CONVERT(VARCHAR(10), TrN_Termin,  111), ''/'', ''-'') &#xD;
				*/&#xD;
&#xD;
				----------DATY ANALIZY&#xD;
				,[Data Operacji Dzień]				= REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')  &#xD;
				,[Data Operacji Tydzień Roku]		= (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ &#xD;
				,[Data Operacji Miesiąc]			= MONTH(TrN_DataOpe) &#xD;
				,[Data Operacji Kwartał]			= DATEPART(quarter, TrN_DataOpe) &#xD;
				,[Data Operacji Rok]				= YEAR(TrN_DataOpe)  &#xD;
				,[Data Wystawienia Dzień]			= REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') &#xD;
				,[Data Wystawienia Tydzień Roku]	= (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ &#xD;
				,[Data Wystawienia Miesiąc]			= MONTH(TrN_DataWys) &#xD;
				,[Data Wystawienia Kwartał]			= DATEPART(quarter, TrN_DataWys) &#xD;
				,[Data Wystawienia Rok]				= YEAR(TrN_DataWys) &#xD;
				,[Termin Płatności Dzień]			= REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') &#xD;
				,[Termin Płatności Tydzień Roku]	= (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7	/*DATEPART(isowk, TrN_Termin)*/ &#xD;
				,[Termin Płatności Miesiąc]			= MONTH(TrN_Termin) &#xD;
				,[Termin Płatności Kwartał]			= DATEPART(quarter, TrN_Termin) &#xD;
				,[Termin Płatności Rok]				= YEAR(TrN_Termin)  &#xD;
				&#xD;
				----------KONTEKSTY&#xD;
				,[Dokument Numer __PROCID__Sprzedaz__]				= 30392 &#xD;
				,[Dokument Numer __ORGID__]							= TrN_TrNId &#xD;
				,[Dokument Numer __DATABASE__]						= '''+@bazaFirmowa+''' &#xD;
				,[Kontrahent Pierwotny Nazwa __PROCID__]			= 20201 &#xD;
				,[Kontrahent Pierwotny Nazwa __ORGID__]				= pod1.Pod_PodId &#xD;
				,[Kontrahent Pierwotny Nazwa __DATABASE__]			= '''+@bazaFirmowa+''' &#xD;
				,[Kontrahent Pierwotny Kod __PROCID__Kontrahenci__] = 20201 &#xD;
				,[Kontrahent Pierwotny Kod __ORGID__]				= pod1.Pod_PodId &#xD;
				,[Kontrahent Pierwotny Kod __DATABASE__]			= '''+@bazaFirmowa+''' &#xD;
				,[Kontrahent Nazwa __PROCID__]						= 20201 &#xD;
				,[Kontrahent Nazwa __ORGID__]						= pod5.Pod_PodId &#xD;
				,[Kontrahent Nazwa __DATABASE__]					= '''+@bazaFirmowa+''' &#xD;
				,[Kontrahent Kod __PROCID__Kontrahenci__]			= 20201 &#xD;
				,[Kontrahent Kod __ORGID__]							= pod5.Pod_PodId&#xD;
				,[Kontrahent Kod __DATABASE__]						= '''+@bazaFirmowa+''' &#xD;
				,[Odbiorca Nazwa __PROCID__]						= 20201 &#xD;
				,[Odbiorca Nazwa __ORGID__]							= pod3.Pod_PodId &#xD;
				,[Odbiorca Nazwa __DATABASE__]						= '''+@bazaFirmowa+'''&#xD;
				,[Odbiorca Kod __PROCID__]							= 20201 &#xD;
				,[Odbiorca Kod __ORGID__]							= pod3.Pod_PodId &#xD;
				,[Odbiorca Kod __DATABASE__]						= '''+@bazaFirmowa+''' &#xD;
				,[Produkt Nazwa __PROCID__]							= 30392 &#xD;
				,[Produkt Nazwa __ORGID__]							= TrN_TrNId &#xD;
				,[Produkt Nazwa __DATABASE__]						= '''+@bazaFirmowa+'''&#xD;
				,[Produkt Kod __PROCID__Towary__]					= 30392 &#xD;
				,[Produkt Kod __ORGID__]							= TrN_TrNId &#xD;
				,[Produkt Kod __DATABASE__]							= '''+@bazaFirmowa+''' &#xD;
				,[Magazyn Nazwa __PROCID__Magazyny__]				= 30392 &#xD;
				,[Magazyn Nazwa __ORGID__]							= TrN_TrNId &#xD;
				,[Magazyn Nazwa __DATABASE__]						= '''+@bazaFirmowa+''' ' &#xD;
				+ @kolumny &#xD;
				+ @atrybuty &#xD;
				+ @atrybutyDok &#xD;
				+ @atrybutyTwr2 &#xD;
				+ @atrybutyPoz2;&#xD;
SET @SQLPaczka2_Tabele	= N' FROM cdn.TraNag		&#xD;
			LEFT JOIN #tmpSeria				ser		ON TrN_DDfId = DDf_DDfID&#xD;
			LEFT JOIN CDN.DokDefinicje		dd		ON TrN_DDfId = dd.DDf_DDfID&#xD;
      LEFT OUTER JOIN CDN.Kontrahenci		knt1	ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
      LEFT OUTER JOIN CDN.PodmiotyView		pod1	ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN CDN.PodmiotyView		pod3	ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN cdn.PodmiotyView		pod2	ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN CDN.Kontrahenci		knt2	ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
      LEFT OUTER JOIN cdn.PodmiotyView		pod4	ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
      LEFT OUTER JOIN cdn.PodmiotyView		pod5	on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
      LEFT OUTER JOIN CDN.Kategorie			kat1	ON TrN_KatID=kat1.Kat_KatID&#xD;
      LEFT OUTER JOIN CDN.Kategorie			kat3	ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
      LEFT OUTER JOIN CDN.Kontrahenci		knt3	ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1 &#xD;
			LEFT JOIN CDN.Rabaty					on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
      LEFT OUTER JOIN CDN.Kategorie			kat5	ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
      LEFT OUTER JOIN cdn.PodmiotyView		pod6	ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
			LEFT JOIN #tmpKonAtr			KonAtr	ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
			LEFT JOIN #tmpKonAtr			KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
			LEFT JOIN #tmpKonAtr			OdbAtr	ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
			LEFT JOIN #tmpDokAtr			DokAtr	ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
			LEFT JOIN #tmpTwrGr				Poz		ON 0 = 1	/*Konieczne by nie było błędu przy kolumnach grup = null*/&#xD;
			LEFT JOIN '+@Operatorzy+'		opk		ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
			LEFT JOIN '+@Operatorzy+'		opk2	ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
			LEFT JOIN '+@Operatorzy+'		zal		ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
			LEFT JOIN '+@Operatorzy+'		mod		ON TrN_OpeModID = mod.Ope_OpeId&#xD;
			LEFT JOIN '+@Operatorzy+'		opk3	ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
			LEFT JOIN CDN.FormyPlatnosci			ON TrN_FPlId = FPl_FPlId&#xD;
			LEFT JOIN (SELECT  sum(KosztyGraniczne) AS KosztyGraniczne, TransID FROM #tmpKosztyGraniczne GROUP BY TransId) KosztyGran ON Trn_Trnid = TransID &#xD;
			LEFT JOIN '+@Bazy+'				BAZ		ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
			LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM,TRE.TrE_TrNId&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_trnid&#xD;
	WHERE TRN_Rodzaj = 302010&#xD;
	  AND TrN_Bufor	&lt;&gt; -1&#xD;
	  AND TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120) ';&#xD;
&#xD;
EXEC (@SQLPaczka1_Kolumny + @SQLPaczka1_Tabele + @SQLPaczka2_Kolumny + @SQLPaczka2_Tabele);&#xD;
&#xD;
/*DEBUG_PRINT*/&#xD;
PRINT CAST(@SQLPaczka1_Kolumny AS NTEXT);&#xD;
PRINT CAST(@SQLPaczka1_Tabele  AS NTEXT);&#xD;
PRINT CAST(@SQLPaczka2_Kolumny AS NTEXT);&#xD;
PRINT CAST(@SQLPaczka2_Tabele  AS NTEXT);&#xD;
&#xD;
DROP TABLE #tmpTwrGr;&#xD;
DROP TABLE #tmpKonAtr;&#xD;
DROP TABLE #tmpDokAtr;&#xD;
DROP TABLE #tmpTwrAtr;&#xD;
DROP TABLE #tmpSeria;&#xD;
DROP TABLE #tmppozatr;&#xD;
DROP TABLE #tmpKosztyGraniczne;&#xD;
DROP TABLE #tmpMarza;&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+Qzc0uNFb+LUJRKceV/p60KoxY3f4HysPC/wxlKO+C3QF1S9Kuc74x9ewfUXzBLUSR3Ouk+AN4GPB8A+k4Vdeyb2q2Q/wiDy3125YO9s0AztRtwqXa+iEYWTSBWeERLWu4POaelYdJHG6KG9/mmQAMfKKMmdnpqDgjHalKSFLKz6APtk1VCfBdximyEgbLh8TWddyhVocIsmLRsfWt/yoVElu33qhoCOm8=</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Data" caption="Czas Aktualny Data" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Cena Nazwa" caption="Produkt Cena Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Cena Typ" caption="Produkt Cena Typ" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Cena Rodzaj" caption="Produkt Cena Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Waluta Koszt Zakupu" caption="Waluta Koszt Zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Waluta" caption="Koszt Zakupu Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut REGION" caption="Dokument Atrybut REGION" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut USŁUGA SERWISOWA" caption="Produkt Atrybut USŁUGA SERWISOWA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut USŁUGA SERWISOWA" caption="Pozycja Atrybut USŁUGA SERWISOWA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[19f5c91f-3fc7-4a9a-ae4f-ce81b43d3c06]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data początkowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Początkowa data analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-08-21&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data końcowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Końcowa data analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-09-20&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAcAAAAEAAAABwIhW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2RldGFsaWN6bmFdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgMV0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDNdBAAAAAcCIVtQcm9kdWt0IENlbmEgTmF6d2FdLltkZXRhbGljem5hXQcCG1tQcm9kdWt0IENlbmEgVHlwXS5bQnJ1dHRvXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDFdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgM10HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXToAAAAHAiFbUHJvZHVrdCBDZW5hIE5hendhXS5bZGV0YWxpY3puYV0HAhtbUHJvZHVrdCBDZW5hIFR5cF0uW0JydXR0b10HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8xMC8yMDIyXQcCIVtQcm9kdWt0IENlbmEgTmF6d2FdLltkZXRhbGljem5hXQcCG1tQcm9kdWt0IENlbmEgVHlwXS5bQnJ1dHRvXQcCHFtEb2t1bWVudCBOdW1lcl0uW1BBLzIvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAxXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMS8yMDIyXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDFdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS8xLzIwMjNdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgMV0HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzEvMjAyNF0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAxXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMS8yMDI1XQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDFdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS8yLzIwMjNdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgMV0HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzIvMjAyNF0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAxXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjUvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAxXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjYvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAxXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjgvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAxXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMy8yMDIzXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDFdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8zMC8yMDIyXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDFdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8zMS8yMDIyXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDFdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAh1bRG9rdW1lbnQgTnVtZXJdLltGQS8zMi8yMDIyXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDFdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS80LzIwMjRdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgMV0HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzUvMjAyNF0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAxXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIeW0Rva3VtZW50IE51bWVyXS5bRktPUi8xLzIwMjJdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgMV0HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHltEb2t1bWVudCBOdW1lcl0uW0ZLT1IvMi8yMDI0XQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDFdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAhxbRG9rdW1lbnQgTnVtZXJdLltQQS8zLzIwMjRdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgMV0HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHFtEb2t1bWVudCBOdW1lcl0uW1BBLzUvMjAyNF0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTEvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTIvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTMvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTQvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTUvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTYvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTcvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTgvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMTkvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjAvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjIvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjQvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMjkvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvMy8yMDIyXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDJdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS80LzIwMjJdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgMl0HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzUvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvNi8yMDIyXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDJdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAhxbRG9rdW1lbnQgTnVtZXJdLltGQS83LzIwMjJdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgMl0HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzgvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvOS8yMDIyXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDJdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAh5bRG9rdW1lbnQgTnVtZXJdLltGS09SLzEvMjAyNF0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAyXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIeW0Rva3VtZW50IE51bWVyXS5bRktPUi8yLzIwMjJdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgM10HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHVtEb2t1bWVudCBOdW1lcl0uW0ZBLzEwLzIwMjRdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgM10HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHFtEb2t1bWVudCBOdW1lcl0uW0ZBLzMvMjAyNF0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAzXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMzAvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAzXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMzEvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAzXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIdW0Rva3VtZW50IE51bWVyXS5bRkEvMzIvMjAyMl0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAzXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIcW0Rva3VtZW50IE51bWVyXS5bRkEvOS8yMDI0XQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDNdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAiNbRG9rdW1lbnQgTnVtZXJdLltGQVVFLzAwMDAwMS8yMDIyXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDNdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAiNbRG9rdW1lbnQgTnVtZXJdLltGQVVFLzAwMDAwMi8yMDIyXQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDNdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAhxbRG9rdW1lbnQgTnVtZXJdLltQQS8xLzIwMjJdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgM10HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHFtEb2t1bWVudCBOdW1lcl0uW1BBLzEvMjAyNF0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAzXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIcW0Rva3VtZW50IE51bWVyXS5bUEEvMi8yMDI0XQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDNdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAhxbRG9rdW1lbnQgTnVtZXJdLltQQS8zLzIwMjJdBwIgW1Byb2R1a3QgQ2VuYSBOYXp3YV0uW2h1cnRvd2EgM10HAhpbUHJvZHVrdCBDZW5hIFR5cF0uW05ldHRvXQcCHFtEb2t1bWVudCBOdW1lcl0uW1BBLzMvMjAyNF0HAiBbUHJvZHVrdCBDZW5hIE5hendhXS5baHVydG93YSAzXQcCGltQcm9kdWt0IENlbmEgVHlwXS5bTmV0dG9dBwIcW0Rva3VtZW50IE51bWVyXS5bUEEvNC8yMDI0XQcCIFtQcm9kdWt0IENlbmEgTmF6d2FdLltodXJ0b3dhIDNdBwIaW1Byb2R1a3QgQ2VuYSBUeXBdLltOZXR0b10HAhxbRG9rdW1lbnQgTnVtZXJdLltQQS81LzIwMjRd/////wAAAAAAAAAAAAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="161" fieldListVisible="False" fieldListExpanded="False" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[19f5c91f-3fc7-4a9a-ae4f-ce81b43d3c06]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Lp."&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Ilość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Cena początkowa"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Cena transakcyjna"&gt;&lt;cells fontName="Segoe UI" fontSize="8" format="n2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Produkt Cena Nazwa"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Cena Typ"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="3" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Sprzedaż Ilość" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Cena początkowa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Cena transakcyjna" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Lp." index="3" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Cena Nazwa" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Cena Typ" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Produkt Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport umożliwia standardową analizę sprzedaży dla określonego podczas uruchamiania zakresu dat dokumentów sprzedaży w podziale na zdefiniowane ceny dla transakcji</a:description><a:id>98</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.63 Sprzedaż wg. cen w zakresie dat</a:mainLinkName><a:modifiedOn>2025-05-26T01:48:23.857</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2018-09-28T14:36:58.987</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/*&#xD;
* Raport Sprzedaży z analizą ABC&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje;&#xD;
&#xD;
--Grupowanie produktów pod Analizę ABC&#xD;
WITH ProdABC AS &#xD;
(&#xD;
SELECT&#xD;
[PodID] = TrE_PodID,&#xD;
[Sumsal] = SUM(TrE_WartoscNetto)&#xD;
FROM CDN.TraNag&#xD;
JOIN CDN.TraElem ON TrN_TrNID = TrE_TrNId&#xD;
 WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
GROUP BY&#xD;
TrE_PodID&#xD;
)&#xD;
&#xD;
SELECT [PodID],&#xD;
CASE&#xD;
    WHEN SUM(sumsal) OVER (ORDER BY sumsal DESC) / SUM(sumsal) OVER () &lt;= CAST(@A AS DECIMAL)/100 THEN 'A'&#xD;
    WHEN SUM(sumsal) OVER (ORDER BY sumsal DESC) / SUM(sumsal) OVER ()  &gt; CAST(@A AS DECIMAL)/100 AND SUM(sumsal) OVER (ORDER BY sumsal DESC) / SUM(sumsal) OVER () &lt; (100 - CAST(@C AS DECIMAL))/100 THEN 'B'&#xD;
    ELSE 'C'&#xD;
    END [abc]&#xD;
INTO #abc&#xD;
FROM ProdABC&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    abc [Analiza ABC],&#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/[TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM])) * TrE_KursL / TrE_KursM [Sprzedaż Rabat] &#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
*/      &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT JOIN #abc ON [PodID] = TrE_PodID &#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],   &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod],    &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],   &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],             &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    ''(BRAK)'' [Analiza ABC],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku] &#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	 &#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #abc&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jsd7hyuUyC8Sdgsl2n/BMjJgiNky53VdN6s+A30dZyDERDxjVxsQnjHChMl6Nve0YtI0skB0usVvB/MqySffaOuuZqCzq0pKnvsjpaKhxxPwZ/2+ghwDXEmC4OPJDAAQ9iKNBEB706qqf90ELy4akSOPWmjMA2j25</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Analiza ABC" caption="Analiza ABC" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut REGION" caption="Dokument Atrybut REGION" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut USŁUGA SERWISOWA" caption="Produkt Atrybut USŁUGA SERWISOWA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut USŁUGA SERWISOWA" caption="Pozycja Atrybut USŁUGA SERWISOWA" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;A&lt;/Name&gt;&#xD;
    &lt;Label&gt;A %&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Procentowy udział w skumulowanej sumie sprzedaży dla kategorii A.&lt;/ToolTip&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;1&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;100&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;80&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;C&lt;/Name&gt;&#xD;
    &lt;Label&gt;C %&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Procentowy udział w skumulowanej sumie sprzedaży dla kategorii C.&lt;/ToolTip&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;1&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;100&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;5&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="False" type="Bar" palette="In A Fog" paletteBaseColor="0" style="In A Fog" grandTotals="False" subTotals="False" onlySelected="False" showSeriesInSeparatePanes="False" fieldVisible="False" rotated="False" dataVertical="True" showParametersValues="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#C6D3EF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="False" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="Top" zeroValues="False" textIndent="2" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1" textOrientation="Horizontal"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="2" spacingHorizontal="4" limitsVertical="100" limitsHorizontal="100" location="{X=1190,Y=432}" isCustomLocation="False"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Analiza ABC" visible="True" dock="Top" alignment="Center" indent="5" location="{X=655,Y=5}" isCustomLocation="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="Black" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;pointOptions pointView="Values" pattern="{V}"&gt;&#xD;
    &lt;valueNumericOptions numericFormat="General" numericPrecision="2" /&gt;&#xD;
    &lt;valueDateTimeOptions dateTimeFormat="ShortDate" dateTimeFormatString="" /&gt;&#xD;
    &lt;argumentNumericOptions numericFormat="General" numericPrecision="2" /&gt;&#xD;
    &lt;argumentDateTimeOptions dateTimeFormat="ShortDate" dateTimeFormatString="" /&gt;&#xD;
  &lt;/pointOptions&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="[Analiza ABC].[A]|[Produkt Kod].[RÓŻA_PN]" rangeMax="[Analiza ABC].[C]|[Produkt Kod].[TOWARWOPAKOWANIU]" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="8" fontColor="Black" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="0" rangeMax="81159,012" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Analiza ABC"&gt;&lt;header fontName="Segoe UI" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Sprzedaż Wartość"&gt;&lt;cells fontName="Segoe UI" fontSize="8" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Segoe UI" fontSize="8" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Near" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Sprzedaż Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="True" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Analiza ABC" index="0" expanded="True" sortMode="displayText" order="descending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="True" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" imageHeight="100" imageWidth="100"&gt;&lt;sortBy dataFieldName="Sprzedaż Wartość" /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded&gt;&lt;value uniqueName="(BRAK)" /&gt;&lt;/excluded&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje kontrahentów wraz wartością ich sprzedaży w podziale na kategorie A,B i C. Domyślnie kategoria A obejmuje kontrahentów generujących 80% sprzedaży, kategoria C - 5% sprzedaży oraz kategoria B – pozostałe 15%. Możliwa jest edycja procentowych wartości parametrów A i C.</a:description><a:id>99</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>1.64 Analiza ABC Kontrahentów</a:mainLinkName><a:modifiedOn>2025-05-26T01:41:58.86</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>01. Sprzedaż</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context></a:contexts><a:connections/></a:Report></Reports><UsePasswordsEncryption>true</UsePasswordsEncryption></ReportsList>