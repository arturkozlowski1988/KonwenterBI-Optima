<ReportsList xmlns="http://schemas.datacontract.org/2004/07/Comarch.Msp.ReportsBook.BusinessLogic" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"><Reports xmlns:a="http://schemas.datacontract.org/2004/07/Comarch.Msp.ReportsBook.BusinessInterface.Entities"><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-14T10:12:16.243</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Płatności &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.5.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @atrybuty2 varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
SET @atrybuty2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'')  &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Podmiot Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybuty2 = @atrybuty2 + N', [Podmiot Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Podmiot Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybuty2 = @atrybuty2 + N', [Podmiot Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'  &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max), @atrybutyDok2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE (DAt_TrNId IS NOT NULL) OR (DAt_VaNId IS NOT NULL))&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT * INTO #tmpDokAtr FROM&#xD;
(SELECT DISTINCT DAt_TrNId FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL&#xD;
UNION&#xD;
SELECT DISTINCT DAt_VanId FROM CDN.DokAtrybuty WHERE DAt_VanId IS NOT NULL) a&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
SET @atrybutyDok2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END        &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON COALESCE(ATR.DAt_TrNId,ATR.DAt_VaNId) = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybutyDok2 = @atrybutyDok2 + N', [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Liczba zapisów na raport&#xD;
SELECT BZp_BRpID IDRaportu, COUNT(*) LiczbaZ&#xD;
into #ZapisyLiczba&#xD;
FROM &#xD;
cdn.BnkZapisy&#xD;
LEFT JOIN CDN.BnkRaporty R1 ON BZp_BRpID = R1.BRp_BRpID&#xD;
GROUP BY BZp_BRpID&#xD;
&#xD;
--Właściwe zapytanie&#xD;
&#xD;
DECLARE @select VARCHAR(MAX);&#xD;
&#xD;
&#xD;
SELECT * INTO #TmpPrzeciw FROM (&#xD;
SELECT &#xD;
BRKV_Numer1 Numer&#xD;
,BRKV_Numer2 NumerPrz&#xD;
,BRKV_PodmiotTyp1 PodTyp&#xD;
,BRKV_PodmiotID1 PodId&#xD;
,BRKV_Dokid1 DokId&#xD;
,BRKV_Kwota1 Kwota&#xD;
,BRKV_KwotaSys1 KwotaSys&#xD;
,BRKV_KwotaRozSys1 KwotaRozSys&#xD;
,BRKV_KwotaRozSys1 * (BRKV_KursM1/isnull(nullif(BRKV_KursL1,0),1)) KwotaRoz&#xD;
FROM CDN.BnkRozKwotyView&#xD;
UNION&#xD;
SELECT &#xD;
BRKV_Numer2 &#xD;
,BRKV_Numer1&#xD;
,BRKV_PodmiotTyp2 PodTyp&#xD;
,BRKV_PodmiotID2 PodId&#xD;
,BRKV_Dokid2 DokId&#xD;
,BRKV_Kwota2&#xD;
,BRKV_KwotaSys2&#xD;
,BRKV_KwotaRozSys2&#xD;
,BRKV_KwotaRozSys2 * (BRKV_KursM2/isnull(nullif(BRKV_KursL2,0),1)) KwotaRoz&#xD;
FROM CDN.BnkRozKwotyView&#xD;
)x&#xD;
&#xD;
SELECT COUNT(*) ilosc, Numer as Numer1,DokId dokid1 into #tmpIlosc from #TmpPrzeciw group by Numer,DokId&#xD;
&#xD;
SET @select =' &#xD;
Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT &#xD;
"BO Rachunku Waluta" = borachunekwal,&#xD;
"Waluta BO" = bowaluta,&#xD;
    "Baza Firmowa" = bf, &#xD;
    "Zapisy/Zdarzenia" = zap,&#xD;
    &#xD;
    "Dokument Numer" = nr,&#xD;
    "Dokument Symbol" = sy,  &#xD;
    "Dokument Numer Pełny" = nrPelny, &#xD;
    "Dokument Opis" = op, &#xD;
    "Dokument MPP" = CASE mpp WHEN 1 THEN ''Tak'' ELSE ''Nie'' END,&#xD;
&#xD;
    ds [Dokument Seria],&#xD;
    Waluta = waluta, "Status" = sta, "Forma Płatności" = fp,&#xD;
    "Raport KB" = raport, "BO Raportu" = boraportu, "BO Rachunku" = borachunku, "Raport KB Stan" = stanraportu, &#xD;
&#xD;
    "Dokument Ponaglenia Numer" = nrpon,&#xD;
    "Dokument Ponaglenia Data Wystawienia" = datpon,&#xD;
    &#xD;
    "Podmiot Pierwotny Nazwa" = kon, &#xD;
    "Podmiot Pierwotny Kod" = konKod, &#xD;
    "Podmiot Pierwotny Typ" = konTyp, "Podmiot Pierwotny Rodzaj" = konRodz, "Podmiot Pierwotny Status" = konStatus,&#xD;
    "Podmiot Pierwotny Grupa" = konGrupa, "Podmiot Pierwotny Opiekun" = konOpie,&#xD;
    "Planowane/Zrealizowane" = zz, Rejestr = rachunek,"Rejestr Akronim" = rachAkronim, "Rejestr Symbol" = rachSymbol, "Kategoria Szczegółowa" = kat, "Kategoria Ogólna" = kat2, "Podmiot Pierwotny Województwo" = woj, &#xD;
    "Podmiot Pierwotny Miasto" = miasto,&#xD;
    "Podmiot Pierwotny Kraj" = kraj,&#xD;
    "Podmiot Pierwotny NIP" = nip,&#xD;
    [Podmiot Nazwa],&#xD;
    [Podmiot Kod], &#xD;
    [Podmiot Województwo], [Podmiot Miasto], [Podmiot Kraj], [Podmiot NIP],&#xD;
    [Podmiot Grupa],  [Podmiot Kategoria], [Podmiot Opiekun], [Podmiot Status],&#xD;
    [Podmiot Rodzaj], [Podmiot Typ],&#xD;
    zakladSymbol as [Zakład Symbol],&#xD;
    zakladNazwa as [Zakład Nazwa Firmy],&#xD;
    opewkod as [Operator Wystawiający Kod],&#xD;
    opewnazwa as [Operator Wystawiający Nazwa],&#xD;
    opemkod as [Operator Modyfikujący Kod],&#xD;
    opemnazwa as [Operator Modyfikujący Nazwa],&#xD;
    "Stan" = stan, "Data Dokumentu" = dataD, "Data Rozliczenia" = dataRO, &#xD;
    "Data Realizacji" = dataRE, &#xD;
    "Termin Zapadalności" = termin, "Liczba Dni Przeterminowania" = liczbaDniP,&#xD;
    "Przychód" = przychod/Isnull(ilosc,1), "Rozchód" = rozchod/Isnull(ilosc,1), "Przychód Waluta" = przychodWal/Isnull(ilosc,1), "Rozchód Waluta" = rozchodWal/Isnull(ilosc,1), &#xD;
    Saldo = (ISNULL(przychod,0) - ISNULL(rozchod,0)) /Isnull(ilosc,1), "Saldo Waluta" = (ISNULL(przychodWal,0) - ISNULL(rozchodWal,0))/Isnull(ilosc,1),&#xD;
    "Przychód Nierozliczony" = (przychod/Isnull(ilosc,1)) - przychodNRoz, "Rozchód Nierozliczony" = (rozchod/Isnull(ilosc,1))-rozchodNRoz, "Saldo Nierozliczone" = ISNULL((przychod/Isnull(ilosc,1)) - przychodNRoz,0) - ISNULL((rozchod/Isnull(ilosc,1))-rozchodNRoz,0),&#xD;
    "Przychód Nierozliczony Waluta" = (przychodWal/Isnull(ilosc,1)) - przychodNRozWal, "Rozchód Nierozliczony Waluta" = (rozchodWal/Isnull(ilosc,1))-rozchodNrozWal, "Saldo Nierozliczone Waluta" = ISNULL((przychodWal/Isnull(ilosc,1)) - przychodNRozWal,0) - ISNULL((rozchodWal/Isnull(ilosc,1))-rozchodNRozWal,0)&#xD;
    ,"Różnica Kursowa Raportu" = RKursowaRaportu&#xD;
    ,"Dokument Przeciwstawny" = DokPrz&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), dataT, 111), ''/'', ''-'')&#xD;
    ,"Data Operacji" = data&#xD;
    */&#xD;
&#xD;
    ----------DATY ANALIZY&#xD;
    ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), dataT, 111), ''/'', ''-'')&#xD;
    ,"Termin Płatności Miesiąc" =  MONTH(dataT)&#xD;
    ,"Termin Płatności Kwartał" = DATEPART(quarter, dataT)&#xD;
    ,"Termin Płatności Rok" = YEAR(dataT)&#xD;
    ,"Data Operacji Dzień" = data&#xD;
    ,"Data Operacji Miesiąc" = miesiac, "Data Operacji Kwartał" = kwartal&#xD;
    ,"Data Operacji Rok" = rok, "Data Operacji Tydzień Roku" = tr&#xD;
    ,"Data Analizy" = analizadata&#xD;
    ----------KONTEKSTY&#xD;
    ,nr_procid [Dokument Numer __PROCID__Platnosci__], nr_orgid [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,kon_procid [Podmiot Pierwotny Nazwa __PROCID__], kon_orgid [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    ,kon_procid [Podmiot Pierwotny Kod __PROCID__], kon_orgid [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__]&#xD;
    ,[Podmiot Nazwa __PROCID__],  [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__]&#xD;
    ,[Podmiot Kod __PROCID__Kontrahenci__],  [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__]&#xD;
&#xD;
    ' + @atrybuty2 + @atrybutyDok2 + '&#xD;
FROM&#xD;
( SELECT&#xD;
id = bzp_bzpid,&#xD;
bf = BAZ.Baz_Nazwa,&#xD;
nr = BZp_Numer,&#xD;
zap = ''Zapisy'',&#xD;
&#xD;
nrpon = ''(BRAK)'',&#xD;
datpon = ''(BRAK)'',&#xD;
&#xD;
sy = dd.DDf_Symbol,&#xD;
op = ISNULL(NULLIF(BZp_Opis,''''),''(BRAK)''),&#xD;
nrPelny =  BZp_NumerPelny ,&#xD;
nr_procid = 23008, nr_orgid = BZp_BZpID,&#xD;
    CASE &#xD;
    WHEN BZp_NumerPelny &lt;&gt; '''' THEN &#xD;
      CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(BZp_NumerPelny,0,CHARINDEX(''/'',BZp_NumerPelny,0))&#xD;
      ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(BZp_NumerPelny,CHARINDEX(''/'',BZp_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
      END&#xD;
    ELSE ''(BRAK)'' &#xD;
    END as [ds], &#xD;
mpp = BZp_SplitPay, &#xD;
waluta = CASE WHEN BZp_Waluta = '''' THEN @Wal ELSE BZp_Waluta END, &#xD;
sta = CASE &#xD;
    WHEN BZp_Rozliczono2=2 AND BZp_Rozliczono=2 THEN ''Zapisy Rozliczone'' &#xD;
    WHEN BZp_Rozliczono=1 THEN ''Zapisy Nierozliczone'' &#xD;
    WHEN BZp_Rozliczono2=0 AND BZp_Rozliczono=0 THEN ''Zapisy Nie podlega rozliczeniu''&#xD;
    WHEN BZp_Rozliczono2=2 AND BZp_Rozliczono=1 THEN ''Zapisy Rozliczony częściowo'' END,&#xD;
fp = CASE&#xD;
    WHEN BZp_Typ = 1 THEN ''wpłata/wypłata gotówki'' &#xD;
    WHEN BZp_Typ = 2 THEN ''przelew na konto/z konta''&#xD;
    WHEN BZp_Typ = 3 THEN ''obciążenie/uznanie karty'' END, &#xD;
raport = BRp_NumerPelny, &#xD;
boraportu = CASE &#xD;
    WHEN BRp_Zamkniety = 1 THEN BRp_SaldoBOSys &#xD;
    ELSE ISNULL((&#xD;
        SELECT TOP 1 R2.BRp_SaldoBOSys + R2.BRp_PrzychodySys - R2.BRp_RozchodySys&#xD;
        FROM CDN.BnkRaporty R2 &#xD;
        WHERE R2.BRp_Zamkniety = 1 &#xD;
            AND R1.BRp_BRaID = R2.BRp_BRaID &#xD;
            AND R2.BRp_DataZam &lt;= R1.BRp_DataDok &#xD;
        ORDER BY R2.BRp_DataZam DESC&#xD;
        ), 0) &#xD;
        +&#xD;
        ISNULL((&#xD;
        SELECT SUM(R2.BRp_PrzychodySys - R2.BRp_RozchodySys)&#xD;
        FROM CDN.BnkRaporty R2 &#xD;
        WHERE R1.BRp_BRaID = R2.BRp_BRaID &#xD;
            AND R2.BRp_DataZam &lt;= R1.BRp_DataDok&#xD;
            AND R2.BRp_DataZam &gt; (SELECT TOP 1 R3.BRp_DataZam FROM CDN.BnkRaporty R3 WHERE R3.BRp_Zamkniety = 1 AND R1.BRp_BRaID = R3.BRp_BRaID AND R3.BRp_DataZam &lt;= R1.BRp_DataDok ORDER BY R3.BRp_DataZam DESC) &#xD;
        ),0) &#xD;
    END, &#xD;
RKursowaRaportu =  BRp_RoznicaKursowaSysMW/LiczbaZ,&#xD;
borachunku = BRa_SaldoBOSys, stanraportu = CASE WHEN BRp_Zamkniety = 0 THEN ''Otwarty'' ELSE ''Zamknięty'' END,&#xD;
data = REPLACE(CONVERT(VARCHAR(10), BZp_DataDok, 111), ''/'', ''-''), &#xD;
dataD = REPLACE(CONVERT(VARCHAR(10), BZp_DataDok, 111), ''/'', ''-''), &#xD;
dataRO = REPLACE(CONVERT(VARCHAR(10), BZp_DataRoz, 111), ''/'', ''-''), &#xD;
dataRE = REPLACE(CONVERT(VARCHAR(10), BZp_DataRoz, 111), ''/'', ''-''), &#xD;
dataT = BZp_DataRoz, &#xD;
miesiac = MONTH(BZp_DataDok), kwartal = DATEPART(quarter, BZp_DataDok), rok = YEAR(BZp_DataDok), tr = (datepart(DY, datediff(d, 0, BZp_DataDok) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, BZp_DataDok)*/,&#xD;
analizadata = GETDATE(),&#xD;
kon = CASE &#xD;
    WHEN BZp_PodmiotTyp IN (1,2,3,5) THEN pod.Pod_Nazwa1 + '' '' + pod.Pod_Nazwa2&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
kon_procid = CASE BZp_PodmiotTyp&#xD;
    WHEN 1 THEN 20201&#xD;
    WHEN 2 THEN 23002&#xD;
    WHEN 3 THEN 24001&#xD;
    WHEN 5 THEN 25005&#xD;
    ELSE 20201&#xD;
END, kon_orgid = BZp_PodmiotID,&#xD;
konKod = CASE &#xD;
    WHEN BZp_PodmiotTyp IN (1,2,3,4,5) THEN pod.Pod_Kod&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konTyp = CASE &#xD;
    WHEN BZp_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
    WHEN BZp_PodmiotTyp = 2 THEN ''Bank''&#xD;
    WHEN BZp_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
    WHEN BZp_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konRodz = CASE&#xD;
    WHEN BZp_PodmiotTyp = 2 THEN ''Bank''&#xD;
    WHEN BZp_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
    WHEN BZp_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konStatus = case knt1.knt_export&#xD;
    when 0 then ''krajowy''&#xD;
    when 1 then ''pozaunijny''&#xD;
    when 2 then ''pozaunijny (zwrot VAT)''&#xD;
    when 3 then ''wewnątrzunijny''&#xD;
    when 4 then ''wewnątrzunijny trójstronny''&#xD;
    when 5 then ''podatnikiem jest nabywca''&#xD;
    when 6 then ''poza terytorium kraju''&#xD;
    when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
    when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
    when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
    ELSE ''(NIEOKREŚLONY)'' end,&#xD;
konGrupa = CASE &#xD;
    WHEN BZp_PodmiotTyp = 1 THEN COALESCE(NULLIF(pod.Pod_Grupa, ''''), ''Pozostali'')   &#xD;
    WHEN BZp_PodmiotTyp = 2 THEN ''Banki''&#xD;
    WHEN BZp_PodmiotTyp = 3 THEN ''Pracownicy/Wspólnicy''&#xD;
    WHEN BZp_PodmiotTyp = 5 THEN ''Urzędy''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konOpie = CASE &#xD;
    WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
    WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
    ELSE ''(NIEPRZYPISANE)'' END,&#xD;
termin = ''1. Terminowe'', liczbaDniP = 0,&#xD;
woj = pod.Pod_Wojewodztwo, miasto = pod.Pod_Miasto, kraj = pod.Pod_Kraj, nip = pod.Pod_NIP,&#xD;
pod5.Pod_Nazwa1 [Podmiot Nazwa], &#xD;
    20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],&#xD;
    &#xD;
    pod5.Pod_Kod [Podmiot Kod], &#xD;
    20201 [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],&#xD;
&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Podmiot Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Podmiot NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Podmiot Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Podmiot Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Podmiot Opiekun],&#xD;
    case knt3.knt_export&#xD;
    when 0 then ''krajowy''&#xD;
    when 1 then ''pozaunijny''&#xD;
    when 2 then ''pozaunijny (zwrot VAT)''&#xD;
    when 3 then ''wewnątrzunijny''&#xD;
    when 4 then ''wewnątrzunijny trójstronny''&#xD;
    when 5 then ''podatnikiem jest nabywca''&#xD;
    when 6 then ''poza terytorium kraju''&#xD;
    when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
    when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
    when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
    ELSE ''(NIEOKREŚLONY)'' end [Podmiot Status],&#xD;
    CASE &#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [Podmiot Typ],&#xD;
    CASE&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [Podmiot Rodzaj],&#xD;
stan = ''Nie dotyczy'',&#xD;
zz = ''Zrealizowane'', rachunek = BRa_Nazwa, rachAkronim = BRa_Akronim, rachSymbol= BRa_Symbol, kat = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), kat2 = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''),&#xD;
zakladSymbol = isnull(Zak_Symbol,''(NIEPRZYPISANY)''), &#xD;
zakladNazwa = isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)''), &#xD;
przychod = CASE WHEN BZp_Kierunek &gt; 0 THEN ISNULL(KwotaSys,BZp_KwotaSys) ELSE NULL END, rozchod = CASE WHEN BZp_Kierunek &lt; 0 THEN ISNULL(KwotaSys,BZp_KwotaSys) ELSE NULL END,&#xD;
przychodWal = CASE WHEN BZp_Kierunek &gt; 0 THEN ISNULL(Kwota,BZp_Kwota) ELSE NULL END, rozchodWal = CASE WHEN BZp_Kierunek &lt; 0 THEN ISNULL(Kwota,BZp_Kwota) ELSE NULL END,&#xD;
przychodNRoz = CASE WHEN BZp_Kierunek &gt; 0 THEN ISNULL(KwotaRozSys,BZp_KwotaRozSys) ELSE NULL END, rozchodNroz = CASE WHEN BZp_Kierunek &lt; 0 THEN ISNULL(KwotaRozSys,BZp_KwotaRozSys) ELSE NULL END,&#xD;
przychodNRozWal = CASE WHEN BZp_Kierunek &gt; 0 THEN ISNULL(KwotaRoz,BZp_KwotaRoz) ELSE NULL END, rozchodNrozWal = CASE WHEN BZp_Kierunek &lt; 0 THEN ISNULL(KwotaRoz,BZp_KwotaRoz) ELSE NULL END,&#xD;
borachunekwal = BRa_SaldoBO,&#xD;
bowaluta = CASE WHEN Bra_Waluta = '''' THEN @Wal ELSE Bra_Waluta END,&#xD;
opewkod = ISNULL(ow.Ope_Kod, ''ID:''+CAST(Bzp_OpeZalId as VARCHAR)),&#xD;
opewnazwa = ISNULL(ow.Ope_Nazwisko, ''ID:''+CAST(Bzp_OpeZalId as VARCHAR)),&#xD;
opemkod = ISNULL(om.Ope_Kod, ''ID:''+CAST(Bzp_OpeModId as VARCHAR)),&#xD;
opemnazwa = ISNULL(om.Ope_Nazwisko, ''ID:''+CAST(Bzp_OpeModId as VARCHAR)),&#xD;
DokPrz = NumerPrz&#xD;
' + @atrybuty + @atrybutyDok + '&#xD;
FROM&#xD;
cdn.BnkZapisy&#xD;
LEFT JOIN #tmpSeria ser ON BZp_DDfId = DDf_DDfID&#xD;
LEFT JOIN CDN.DokDefinicje dd ON BZp_DDfId = dd.DDf_DDfID&#xD;
LEFT JOIN CDN.BnkRachunki ON BZp_BRaID = BRa_BRaID&#xD;
LEFT JOIN CDN.BnkRaporty R1 ON BZp_BRpID = R1.BRp_BRpID&#xD;
LEFT JOIN CDN.PodmiotyView pod ON BZp_PodmiotID = pod.Pod_PodId AND BZp_PodmiotTyp = pod.Pod_PodmiotTyp&#xD;
LEFT JOIN CDN.Kategorie kat1 ON BZp_KatID = kat1.Kat_KatID&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON pod.Pod_PodId = KonAtr.KnA_PodmiotId AND pod.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpDokAtr DokAtr ON 0  = 1&#xD;
LEFT JOIN CDN.Kontrahenci knt1 ON BZp_PodmiotID=knt1.Knt_KntId AND BZp_PodmiotTyp = 1&#xD;
LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8&#xD;
LEFT JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod.Pod_GlID = pod5.Pod_PodId and pod.Pod_GlKod = pod5.Pod_Kod&#xD;
LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = BZp_ZakID&#xD;
LEFT JOIN ' + @Operatorzy + ' ow on ow.Ope_OpeId = BZp_OpeZalId&#xD;
LEFT JOIN ' + @Operatorzy + ' om on om.Ope_OpeId = BZp_OpeModId&#xD;
LEFT JOIN  #ZapisyLiczba ON R1.BRp_BRpID = IDRaportu&#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
LEFT JOIN #TmpPrzeciw on &#xD;
PodTyp = bzP_podmiotTyp AND&#xD;
PodID = bzP_podmiotID AND&#xD;
Dokid = BZP_bzPid AND&#xD;
Numer =  BZP_Numer &#xD;
UNION ALL &#xD;
&#xD;
SELECT&#xD;
id = bzd_bzdid,&#xD;
bf = BAZ.Baz_Nazwa,&#xD;
nr = BZd_Numer,  -- Zdarzenia&#xD;
zap = ''Zdarzenia'',&#xD;
&#xD;
nrpon = ISNULL(pnr,''(BRAK)''),&#xD;
datpon = ISNULL(REPLACE(CONVERT(VARCHAR(10), pdat, 111), ''/'', ''-''),''(BRAK)''),&#xD;
&#xD;
sy = dd.DDf_Symbol,&#xD;
op = ISNULL(NULLIF(BZd_Opis,''''),''(BRAK)''),&#xD;
nrPelny =  BZd_NumerPelny ,&#xD;
nr_procid = 23014, nr_orgid = BZd_BZdID,&#xD;
 &#xD;
        CASE &#xD;
        WHEN BZd_NumerPelny &lt;&gt; '''' THEN &#xD;
         CASE when isnull(ser.seria,0) = 5 then &#xD;
           substring(BZd_NumerPelny,0,CHARINDEX(''/'',BZd_NumerPelny,0))&#xD;
         ELSE &#xD;
           ISNULL(PARSENAME(REPLACE(substring(BZd_NumerPelny,CHARINDEX(''/'',BZd_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
         END&#xD;
         ELSE ''(BRAK)'' &#xD;
         END as [ds], &#xD;
mpp = BZd_SplitPay, &#xD;
waluta = CASE WHEN BZd_Waluta = '''' THEN @Wal ELSE BZd_Waluta END, &#xD;
sta = CASE&#xD;
    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=1 THEN ''Zdarzenia Nierozliczone''&#xD;
    WHEN BZd_Rozliczono=2 THEN ''Zdarzenia Rozliczone''&#xD;
    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=2 THEN ''Zdarzenia Częściowo rozliczone''&#xD;
    WHEN BZd_Rozliczono=0 AND BZd_Rozliczono2=0 THEN ''Zdarzenia Nie podlega rozliczeniu'' &#xD;
    WHEN BZd_Rozliczono=2 AND BZd_Rozliczono2=2 THEN ''Zdarzenia w rozliczeniu całości'' END,&#xD;
fp = FPl_Nazwa, raport = ''Nie dotyczy'', boraportu = NULL, RKursowaRaportu =  null, borachunku = BRa_SaldoBOSys, stanraportu = ''Nie dotyczy'',&#xD;
data = REPLACE(CONVERT(VARCHAR(10), BZd_DataReal, 111), ''/'', ''-''), &#xD;
dataD = REPLACE(CONVERT(VARCHAR(10), BZd_DataDok, 111), ''/'', ''-''), &#xD;
dataRO = REPLACE(CONVERT(VARCHAR(10), BZd_DataRoz, 111), ''/'', ''-''), &#xD;
dataRE = REPLACE(CONVERT(VARCHAR(10), BZd_DataReal, 111), ''/'', ''-''), &#xD;
dataT = BZd_Termin,&#xD;
miesiac = MONTH(BZd_DataReal), kwartal = DATEPART(quarter, BZd_DataReal), rok = YEAR(BZd_DataReal), tr = (datepart(DY, datediff(d, 0, BZd_DataReal) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, BZd_DataReal)*/,&#xD;
analizadata = GETDATE(),&#xD;
kon = CASE &#xD;
    WHEN BZd_PodmiotTyp  IN (1,2,3,5) THEN pod.Pod_Nazwa1 + '' '' + pod.Pod_Nazwa2&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
kon_procid = CASE BZd_PodmiotTyp&#xD;
    WHEN 1 THEN 20201&#xD;
    WHEN 2 THEN 23002&#xD;
    WHEN 3 THEN 24001&#xD;
    WHEN 5 THEN 25005&#xD;
    ELSE 20201&#xD;
END, kon_orgid = BZd_PodmiotID,&#xD;
konKod = CASE &#xD;
    WHEN BZd_PodmiotTyp IN (1,2,3,4,5) THEN pod.Pod_Kod&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konTyp = CASE &#xD;
    WHEN BZd_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
    WHEN BZd_PodmiotTyp = 2 THEN ''Bank''&#xD;
    WHEN BZd_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
    WHEN BZd_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konRodz = CASE&#xD;
    WHEN BZd_PodmiotTyp = 2 THEN ''Bank''&#xD;
    WHEN BZd_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
    WHEN BZd_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konStatus = case knt1.knt_export&#xD;
    when 0 then ''krajowy''&#xD;
    when 1 then ''pozaunijny''&#xD;
    when 2 then ''pozaunijny (zwrot VAT)''&#xD;
    when 3 then ''wewnątrzunijny''&#xD;
    when 4 then ''wewnątrzunijny trójstronny''&#xD;
    when 5 then ''podatnikiem jest nabywca''&#xD;
    when 6 then ''poza terytorium kraju''&#xD;
    when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
    when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
    when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
    ELSE ''(NIEOKREŚLONY)'' end,&#xD;
konGrupa = CASE &#xD;
    WHEN BZd_PodmiotTyp = 1 THEN COALESCE(NULLIF(pod.Pod_Grupa, ''''), ''Pozostali'')   &#xD;
    WHEN BZd_PodmiotTyp = 2 THEN ''Banki''&#xD;
    WHEN BZd_PodmiotTyp = 3 THEN ''Pracownicy/Wspólnicy''&#xD;
    WHEN BZd_PodmiotTyp = 5 THEN ''Urzędy''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konOpie = CASE &#xD;
    WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
    WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
    ELSE ''(NIEPRZYPISANE)'' END,&#xD;
termin = CASE&#xD;
WHEN BZd_Rozliczono=1 THEN (CASE&#xD;
    WHEN DATEDIFF(day, BZd_Termin, GETDATE()) &lt; 1 THEN ''1. Terminowe''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, GETDATE()) BETWEEN 1 AND 5 THEN ''2. Przeterminowane nie więcej niż 5 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, GETDATE()) BETWEEN 6 AND 30 THEN ''3. Przeterminowane od 6 do 30 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, GETDATE()) BETWEEN 31 AND 60 THEN ''4. Przeterminowane od 31 do 60 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, GETDATE()) BETWEEN 61 AND 120 THEN ''5. Przeterminowane od 60 do 120 dni''&#xD;
    ELSE ''6. Przeterminowane powyżej 120 dni'' END)&#xD;
WHEN BZd_Rozliczono=2 THEN (CASE &#xD;
    WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) &lt; 1 THEN ''1. Terminowe''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) BETWEEN 1 AND 5 THEN ''2. Przeterminowane nie więcej niż 5 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) BETWEEN 6 AND 30 THEN ''3. Przeterminowane od 6 do 30 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) BETWEEN 31 AND 60 THEN ''4. Przeterminowane od 31 do 60 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) BETWEEN 61 AND 120 THEN ''5. Przeterminowane od 60 do 120 dni''&#xD;
    ELSE ''6. Przeterminowane powyżej 120 dni'' END)&#xD;
END,&#xD;
liczbaDniP = CASE&#xD;
    WHEN BZd_Rozliczono=1 THEN CASE WHEN DATEDIFF(day, BZd_Termin, GETDATE()) &lt; 0 THEN 0 ELSE DATEDIFF(day, BZd_Termin, GETDATE()) END&#xD;
    WHEN BZd_Rozliczono=2 THEN CASE WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) &lt; 0 THEN 0 ELSE DATEDIFF(day, BZd_Termin, BZd_DataRoz) END&#xD;
    ELSE 0 END,&#xD;
woj = pod.Pod_Wojewodztwo, miasto = pod.Pod_Miasto, kraj = pod.Pod_Kraj, nip = pod.Pod_NIP,     &#xD;
pod5.Pod_Nazwa1 [Podmiot Nazwa], &#xD;
    20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],&#xD;
    &#xD;
    pod5.Pod_Kod [Podmiot Kod], &#xD;
    20201 [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],&#xD;
&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Podmiot Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Podmiot NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Podmiot Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Podmiot Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Podmiot Opiekun],&#xD;
    case knt3.knt_export&#xD;
    when 0 then ''krajowy''&#xD;
    when 1 then ''pozaunijny''&#xD;
    when 2 then ''pozaunijny (zwrot VAT)''&#xD;
    when 3 then ''wewnątrzunijny''&#xD;
    when 4 then ''wewnątrzunijny trójstronny''&#xD;
    when 5 then ''podatnikiem jest nabywca''&#xD;
    when 6 then ''poza terytorium kraju''&#xD;
    when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
    when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
    when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
    ELSE ''(NIEOKREŚLONY)'' end [Podmiot Status],&#xD;
&#xD;
    CASE &#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [Podmiot Typ],&#xD;
    CASE&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [Podmiot Rodzaj],&#xD;
stan = CASE&#xD;
    WHEN BZd_Stan = 0 THEN ''Bufor''&#xD;
    WHEN BZd_Stan = 1 THEN ''Do realizacji''&#xD;
    WHEN BZd_Stan = 2 THEN ''Wysłane''&#xD;
    WHEN BZd_Stan = 3 THEN ''Zrealizowane''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
zz = ''Planowane'', rachunek = BRa_Nazwa, rachAkronim = BRa_Akronim, rachSymbol= BRa_Symbol, kat = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), kat2 = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''),&#xD;
zakladSymbol = ''(NIEPRZYPISANY)'', &#xD;
zakladNazwa = ''(NIEPRZYPISANY)'', &#xD;
przychod = CASE WHEN BZd_Kierunek &gt; 0 THEN ISNULL(KwotaSys,BZd_KwotaSys) ELSE NULL END, rozchod = CASE WHEN BZd_Kierunek &lt; 0 THEN ISNULL(KwotaSys,BZd_KwotaSys) ELSE NULL END,&#xD;
przychodWal = CASE WHEN BZd_Kierunek &gt; 0 THEN ISNULL(Kwota,BZd_Kwota) ELSE NULL END, rozchodWal = CASE WHEN BZd_Kierunek &lt; 0 THEN ISNULL(Kwota,BZd_Kwota) ELSE NULL END,&#xD;
przychodNRoz = CASE WHEN BZd_Kierunek &gt; 0 &#xD;
                    THEN ISNULL(KwotaRozSys,BZd_KwotaRozSys)                       &#xD;
                    ELSE NULL END, &#xD;
&#xD;
rozchodNRoz = CASE WHEN BZd_Kierunek &lt; 0 &#xD;
                    THEN ISNULL(KwotaRozSys,BZd_KwotaRozSys)&#xD;
&#xD;
                    ELSE NULL END, &#xD;
przychodNRozWal = CASE WHEN BZd_Kierunek &gt; 0&#xD;
                    THEN ISNULL(KwotaRoz,BZd_KwotaRoz)&#xD;
&#xD;
                    ELSE NULL END, &#xD;
rozchodNRozWal = CASE WHEN BZd_Kierunek &lt; 0 &#xD;
                    THEN ISNULL(KwotaRoz,BZd_KwotaRoz)&#xD;
&#xD;
                    ELSE NULL END ,&#xD;
borachunekwal = BRa_SaldoBO,&#xD;
bowaluta = CASE WHEN Bra_Waluta = '''' THEN @Wal ELSE Bra_Waluta END,&#xD;
opewkod = ISNULL(ow.Ope_Kod, ''ID:''+CAST(Bzd_OpeZalId as VARCHAR)),&#xD;
opewnazwa = ISNULL(ow.Ope_Nazwisko, ''ID:''+CAST(Bzd_OpeZalId as VARCHAR)),&#xD;
opemkod = ISNULL(om.Ope_Kod, ''ID:''+CAST(Bzd_OpeModId as VARCHAR)),&#xD;
opemnazwa = ISNULL(om.Ope_Nazwisko, ''ID:''+CAST(Bzd_OpeModId as VARCHAR)),&#xD;
DokPrz = NumerPrz&#xD;
' + @atrybuty + @atrybutyDok + '&#xD;
FROM&#xD;
cdn.BnkZdarzenia&#xD;
LEFT JOIN #tmpSeria ser ON BZd_DDfId = DDf_DDfID&#xD;
LEFT JOIN CDN.DokDefinicje dd ON BZd_DDfId = dd.DDf_DDfID&#xD;
LEFT JOIN CDN.BnkRachunki ON BZd_BRaID = BRa_BRaID &#xD;
LEFT JOIN CDN.PodmiotyView pod ON BZd_PodmiotID = pod.Pod_PodId AND BZd_PodmiotTyp = pod.Pod_PodmiotTyp&#xD;
LEFT JOIN CDN.Kategorie kat1 ON BZd_KatID = kat1.Kat_KatID&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON pod.Pod_PodId = KonAtr.KnA_PodmiotId AND pod.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpDokAtr DokAtr ON BZd_DokumentID  = DokAtr.DAt_TrNId AND BZd_DokumentTyp = 1&#xD;
LEFT JOIN CDN.Kontrahenci knt1 ON BZd_PodmiotID=knt1.Knt_KntId AND BZd_PodmiotTyp = 1&#xD;
LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8&#xD;
LEFT JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
LEFT JOIN CDN.FormyPlatnosci ON BZd_FPlId = FPl_FPlId&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod.Pod_GlID = pod5.Pod_PodId and pod.Pod_GlKod = pod5.Pod_Kod&#xD;
LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
LEFT JOIN ' + @Operatorzy + ' ow on ow.Ope_OpeId = BZd_OpeZalId&#xD;
LEFT JOIN ' + @Operatorzy + ' om on om.Ope_OpeId = BZd_OpeModId&#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
LEFT JOIN #TmpPrzeciw on &#xD;
PodTyp = bzD_podmiotTyp AND&#xD;
PodID = bzD_podmiotID AND&#xD;
Dokid = BZD_bzdid AND&#xD;
Numer =  BZD_Numer &#xD;
LEFT JOIN&#xD;
(&#xD;
SELECT&#xD;
BDE_DokId pzr,&#xD;
MAX(BDN_NumerPelny) pnr,&#xD;
MAX(BDN_DataDok) pdat&#xD;
FROM&#xD;
CDN.BnkDokElem &#xD;
JOIN CDN.BnkDokNag ON BDE_BDNId = BDN_BDNId AND BDN_Typ = 222 &#xD;
GROUP BY BDE_DokId&#xD;
) pon on pzr = BZd_DokumentID&#xD;
&#xD;
) AS Kalendar &#xD;
LEFT JOIN #tmpIlosc on Numer1 = nr and dokid1 = id&#xD;
&#xD;
'&#xD;
&#xD;
PRINT(@select)&#xD;
EXEC(@select)&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #ZapisyLiczba&#xD;
DROP TABLE #TmpPrzeciw&#xD;
DROP TABLE #tmpIlosc&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jcJmwCoYl15WzHxaW87BnyNdP2x8/CGcO7bORHqKJvs6K4Rc6WGUrqsFTohQnCixfCEZm86P9XmLvgtux+17xfMNWq24hKQ21Y6FZpZ5l4QjOINa5rreB8sackG/fPbGY3HWAzkEZBu0Hsrno1J2YHw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="BO Rachunku Waluta" caption="BO Rachunku Waluta" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Waluta BO" caption="Waluta BO" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zapisy/Zdarzenia" caption="Zapisy/Zdarzenia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer Pełny" caption="Dokument Numer Pełny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument MPP" caption="Dokument MPP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Status" caption="Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Raport KB" caption="Raport KB" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="BO Raportu" caption="BO Raportu" type="measure" formatString="c2" aggregate="Max" /&gt;&#xD;
    &lt;column name="BO Rachunku" caption="BO Rachunku" type="measure" formatString="c2" aggregate="Max" /&gt;&#xD;
    &lt;column name="Raport KB Stan" caption="Raport KB Stan" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Ponaglenia Numer" caption="Dokument Ponaglenia Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Ponaglenia Data Wystawienia" caption="Dokument Ponaglenia Data Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Nazwa" caption="Podmiot Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kod" caption="Podmiot Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Typ" caption="Podmiot Pierwotny Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Rodzaj" caption="Podmiot Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Status" caption="Podmiot Pierwotny Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Grupa" caption="Podmiot Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Opiekun" caption="Podmiot Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Planowane/Zrealizowane" caption="Planowane/Zrealizowane" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rejestr" caption="Rejestr" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Rejestr Akronim" caption="Rejestr Akronim" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rejestr Symbol" caption="Rejestr Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa" caption="Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna" caption="Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Województwo" caption="Podmiot Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Miasto" caption="Podmiot Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kraj" caption="Podmiot Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny NIP" caption="Podmiot Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Województwo" caption="Podmiot Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Miasto" caption="Podmiot Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kraj" caption="Podmiot Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot NIP" caption="Podmiot NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Grupa" caption="Podmiot Grupa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Kategoria" caption="Podmiot Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Opiekun" caption="Podmiot Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Status" caption="Podmiot Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Rodzaj" caption="Podmiot Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wystawiający Kod" caption="Operator Wystawiający Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wystawiający Nazwa" caption="Operator Wystawiający Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący Kod" caption="Operator Modyfikujący Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący Nazwa" caption="Operator Modyfikujący Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Stan" caption="Stan" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Dokumentu" caption="Data Dokumentu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia" caption="Data Rozliczenia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji" caption="Data Realizacji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Zapadalności" caption="Termin Zapadalności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania" caption="Liczba Dni Przeterminowania" type="measure" formatString="n0" aggregate="Average" /&gt;&#xD;
    &lt;column name="Przychód" caption="Przychód" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód" caption="Rozchód" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód Waluta" caption="Przychód Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód Waluta" caption="Rozchód Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo" caption="Saldo" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Waluta" caption="Saldo Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód Nierozliczony" caption="Przychód Nierozliczony" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód Nierozliczony" caption="Rozchód Nierozliczony" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Nierozliczone" caption="Saldo Nierozliczone" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód Nierozliczony Waluta" caption="Przychód Nierozliczony Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód Nierozliczony Waluta" caption="Rozchód Nierozliczony Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Nierozliczone Waluta" caption="Saldo Nierozliczone Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Różnica Kursowa Raportu" caption="Różnica Kursowa Raportu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Przeciwstawny" caption="Dokument Przeciwstawny" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Analizy" caption="Data Analizy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Atrybut KLUCZOWY" caption="Podmiot Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Atrybut KLUCZOWY" caption="Podmiot Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut REGION" caption="Dokument Atrybut REGION" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions /&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields /&gt;&#xD;
  &lt;rowFields /&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields /&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Płatności wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o wszystkich płatnościach zrealizowanych i planowanych w firmie. Wartości prezentowane są w walucie systemowej oraz walucie dokumentu.&#xD;
&#xD;
W analizach brane pod uwagę są wszystkie dokumenty płatności dla wszystkich rachunków. Dokumenty zrealizowane pobierane są z tabeli BnkZapisy natomiast planowane z BnkZdarzenia. Przychód, Rozchód i Saldo liczone są na podstawie wartości tabeli BnkRozKwoty. Przychód Niezrealizowany, Rozchód Niezrealizowany i Saldo Niezrealizowane liczone są na podstawie wartości tabel BZp_KwotaSys i BZd_KwotaSys pomniejszonej o wartość tabeli BZd_KwotaRozSys dla zdarzeń.&#xD;
&#xD;
Miarę bilansu otwarcia raportu należy analizować w kontekście danego raportu a nie dla ich grupy (np w wymiarze czasowym), Miara działa poprawnie dla raportów zamkniętych &#xD;
&#xD;
Raport oparty na tabelach:&#xD;
BnkZapisy - Tabela zawiera dokumenty w postaci wyciągów bankowych oraz innych dokumentów rejestrowanych w kasach gotówkowych. &#xD;
BnkZdarzenia - Tabela zawiera zdarzenia, które mają nastąpić w przyszłości (np. zapłata za fakturę).</a:description><a:id>1</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>01. Raport Płatności</a:mainLinkName><a:modifiedOn>2025-04-11T09:19:48.367</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-28T17:27:40.433</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g (&#xD;
    gid&#xD;
    ,gidTyp&#xD;
    ,kod&#xD;
    ,gidNumer&#xD;
    ,grONumer&#xD;
    ,poziom&#xD;
    ,sciezka&#xD;
    )&#xD;
AS (&#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,0 AS poziom&#xD;
        ,convert(NVARCHAR(1024), '') AS sciezka&#xD;
    FROM CDN.TwrGrupy&#xD;
    WHERE TwG_TwGID = 0&#xD;
    &#xD;
    UNION ALL&#xD;
    &#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,p.poziom + 1 AS poziom&#xD;
        ,convert(NVARCHAR(1024), p.sciezka + N'\' + c.TwG_Kod) AS sciezka&#xD;
    FROM g p&#xD;
    JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer&#xD;
    WHERE c.TwG_TwGID &lt;&gt; 0&#xD;
        AND c.TwG_GIDTyp = - 16&#xD;
    )&#xD;
SELECT *&#xD;
INTO #tmpTwrGr&#xD;
FROM g&#xD;
&#xD;
DECLARE @poziom INT&#xD;
DECLARE @poziom_max INT&#xD;
DECLARE @sql NVARCHAR(max)&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom)&#xD;
FROM #tmpTwrGr&#xD;
&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0&#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50), ONr' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50)'&#xD;
&#xD;
    EXEC (@sql)&#xD;
&#xD;
    IF @poziom = @poziom_max&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS NVARCHAR) + '= grONumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS NVARCHAR) + ' = kod'&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
    ELSE&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
DECLARE @select VARCHAR(max)&#xD;
DECLARE @select2 VARCHAR(max)&#xD;
DECLARE @select3 VARCHAR(max)&#xD;
DECLARE @kolumny VARCHAR(max)&#xD;
DECLARE @i INT&#xD;
&#xD;
SET @kolumny = ''&#xD;
SET @i = 0&#xD;
&#xD;
WHILE (@i &lt;= @poziom_max)&#xD;
BEGIN&#xD;
    SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' + LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    SET @i = @i + 1&#xD;
END&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id INT&#xD;
    ,@atrybut_kod NVARCHAR(50)&#xD;
    ,@atrybut_typ INT&#xD;
    ,@atrybut_format INT&#xD;
    ,@atrybuty VARCHAR(max)&#xD;
    ,@sqlA NVARCHAR(max);&#xD;
DECLARE @wersja FLOAT;&#xD;
&#xD;
SET @wersja = (&#xD;
        SELECT CONVERT(FLOAT, SYS_Wartosc)&#xD;
        FROM CDN.SystemCDN&#xD;
        WHERE SYS_ID = 3&#xD;
        )&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId&#xD;
    ,KnA_PodmiotTyp&#xD;
INTO #tmpKonAtr&#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId&#xD;
INTO #tmpDokAtr&#xD;
FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr VARCHAR(max)&#xD;
    ,@atrybutyTwr2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId&#xD;
INTO #tmpTwrAtr&#xD;
FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz VARCHAR(max)&#xD;
    ,@atrybutyPoz2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId&#xD;
INTO #tmpPozAtr&#xD;
FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID&#xD;
    ,CASE &#xD;
        WHEN DDf_Numeracja LIKE '@rejestr%'&#xD;
            THEN 5&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 1) = '@rejestr'&#xD;
            THEN 1&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 2) = '@rejestr'&#xD;
            THEN 2&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 3) = '@rejestr'&#xD;
            THEN 3&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 4) = '@rejestr'&#xD;
            THEN 4&#xD;
        END [seria]&#xD;
INTO #tmpSeria&#xD;
FROM CDN.DokDefinicje&#xD;
&#xD;
SELECT *  INTO #tmpKosztyGraniczne FROM (&#xD;
SELECT SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TNFS.TrN_TrNID TransId&#xD;
FROM cdn.tranag TNKG&#xD;
JOIN cdn.traelem TEKG ON TEKG.tre_trnid = TNKG.TrN_TrNID&#xD;
JOIN cdn.Tranag TNFZ ON TNFZ.Trn_trnid = TNKG.TrN_ZwrId&#xD;
JOIN cdn.TranagRelacje ON TNFZ.Trn_trnid = TrR_TrNId&#xD;
    AND TrR_FaTyp IN (&#xD;
        302&#xD;
        ,305&#xD;
        )&#xD;
JOIN cdn.Tranag TNFS ON TNFS.TrN_TrNID = TrR_FaId&#xD;
JOIN cdn.TraElem TEFS ON TNFS.trn_trnid = TEFS.TrE_TrNId&#xD;
    AND TEKG.TrE_Lp = TEFS.TrE_LpPow&#xD;
WHERE TNKG.trn_rodzaj IN (&#xD;
        301008&#xD;
        ,301009&#xD;
        ,301018&#xD;
        )&#xD;
GROUP BY TEFS.TrE_TrEID&#xD;
    ,TNFS.TrN_TrNID&#xD;
&#xD;
	UNION ALL&#xD;
	&#xD;
	 SELECT  SUM(TEKG.TrE_WartoscNetto) KosztyGraniczne&#xD;
    ,TEFS.TrE_TrEID ElemId&#xD;
    ,TEFS.TrE_TrNId TransId&#xD;
    FROM CDN.TraElem TEFS&#xD;
    JOIN CDN.tranagrelacje tr on tr.TrR_TrNID = TEFS.TrE_TrNID&#xD;
    JOIN CDN.traelem TEWZ on tr.TrR_FaId = TEWZ.TrE_TrNID AND TEFS.TrE_Lppow = TEWZ.TrE_LpPow&#xD;
    JOIN CDN.TraSElemDost TraSElemDost on TEWZ.TrE_TrEID = TsD_TrEID&#xD;
	JOIN  CDN.TraSElem ON TsD_TrSIdDost = trs_trsid&#xD;
	JOIN CDN.TraElem TEPZ on TrS_TrEId = TEPZ.TrE_TrEID&#xD;
	JOIN CDN.TraNag  TNPZ on TEPZ.TrE_TrNId = TrN_TrNID&#xD;
	JOIN CDN.TraNagRelacje TRFZ ON TRFZ.TrR_TrNId = TNPZ.TRN_TRNID &#xD;
	JOIN CDN.TraNag  TNFZ ON TNFZ.TrN_TrNID = TRFZ.TrR_FaId&#xD;
	JOIN CDN.TraNag  TNKG ON TNFZ.TrN_TrNID = TNKG.TrN_ZwrId AND TNKG.TrN_Rodzaj = 301009 -- Korekty Graniczne&#xD;
	join CDN.TraElem TEKG ON TEKG.TrE_TrNId = TNKG.TrN_TrNID AND TEKG.TrE_Lp = TEPZ.TrE_LpPow&#xD;
	GROUP BY TEFS.TrE_TrNId,TEFS.TrE_TrEID&#xD;
&#xD;
	)X&#xD;
&#xD;
&#xD;
--Tworzenie tabelki pomocniczej do liczenia marży&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @select = &#xD;
    'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),trn.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    trn.TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(trn.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(trn.TrN_NumerPelny,0,CHARINDEX(''/'',trn.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(trn.TrN_NumerPelny,CHARINDEX(''/'',trn.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,trn.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(trn.TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
        ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    &#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    Tre_Lp [Produkt Lp.],&#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary], &#xD;
    &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, trn.TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(trn.TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(trn.TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(trn.TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    &#xD;
    TR.TrE_WartoscNetto [Sprzedaż Wartość], TR.TrE_WartoscBrutto [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal [Sprzedaż Wartość Waluta], TR.TrE_Ilosc [Sprzedaż Ilość], &#xD;
    (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Koszt Zakupu], &#xD;
    TR.TrE_WartoscNetto - (CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Sprzedaż Marża],&#xD;
    TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/ISNULL(NULLIF([TrE_JMPrzelicznikL],0),1)*[TrE_JMPrzelicznikM])) * TrE_KursL / ISNULL(NULLIF(TrE_KursM,0),1) [Sprzedaż Rabat] ,&#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza],&#xD;
    ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
    ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy]&#xD;
    ,TrE_Cena0WD AS [Cena początkowa]&#xD;
    ,TrE_CenaWWD AS [Cena transakcyjna]&#xD;
	&#xD;
    ,CAST(TR.TrE_Ilosc/ ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS DECIMAL(26,10)) [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,ISNULL(KosztWyliczony.TRE_Waluta, TR.TRE_Waluta) [Waluta Koszt Zakupu]&#xD;
    ,ISNULL((CASE WHEN trn.TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1),TR.TrE_KosztUslugi)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, trn.TrN_DataOpe) [Data Operacji Kwartał], YEAR(trn.TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(trn.TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, trn.TrN_DataWys) [Data Wystawienia Kwartał], YEAR(trn.TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), trn.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, trn.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, trn.TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(trn.TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, trn.TrN_Termin) [Termin Płatności Kwartał], YEAR(trn.TrN_Termin) [Termin Płatności Rok]&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN trn.TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], trn.TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],''' + &#xD;
    @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
SET @select2 = &#xD;
    ' FROM cdn.TraNag trn&#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=trn.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON trn.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
     left join (select * from cdn.tranag where TrN_TypDokumentu = 302 and trn_faid is not null) spFA on trn.trn_trnid = spFA.trn_faid and trn.trn_faid = spFA.trn_trnid and trn.TrN_TypDokumentu = 305&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)=knt1.Knt_KntId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON ISNULL(spFA.Trn_PodID,TrE_PodID)= pod1.Pod_PodId AND ISNULL(spFA.Trn_PodmiotTyp,TrE_PodmiotTyp) = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON trn.TrN_OdbID= pod3.Pod_PodId AND trn.TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON trn.TrN_OdbId = knt2.Knt_KntId AND trn.TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON trn.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND trn.TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON trn.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON trn.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON trn.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + &#xD;
    ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON trn.TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
						   	,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN #tmpKosztyGraniczne ON ElemId = TR.Tre_Treid&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
&#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],&#xD;
    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    &#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    &#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(BRAK)'' [Produkt PKWiU], &#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],     &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy],&#xD;
    NULL [Produkt Lp.],&#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    TrN_RazemNetto [Sprzedaż Wartość], TrN_RazemBrutto [Sprzedaż Wartość Brutto], TrN_RazemNettoWal [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt [Koszt Zakupu], TrN_RazemNetto - KosztWyliczony.Koszt [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc [Sprzedaż Rabat],&#xD;
    ''(BRAK)'' [Jednostka Miary Pomocnicza],&#xD;
    ''(BRAK)'' [Produkt EAN],&#xD;
    ''(BRAK)'' [Produkt Kod Dostawcy]&#xD;
    ,NULL AS [Cena początkowa]&#xD;
    ,NULL AS [Cena transakcyjna]&#xD;
    ,0 [Sprzedaż Ilość Jednostka Pomocnicza]&#xD;
    ,NULL [Produkt Pozycja Dokumentu]&#xD;
    ,KosztyGraniczne AS [Koszt Zakupu Koszty Graniczne]&#xD;
    ,KosztWyliczony.TRE_Waluta [Waluta Koszt Zakupu]&#xD;
    ,(CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0)) / ISNULL(NULLIF((KursZakL/ISNULL(NULLIF(KursZakM,0),1)),0),1)[Koszt Zakupu Waluta]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok] &#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],''' &#xD;
    + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + &#xD;
    ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Magazyn Nazwa __DATABASE__]&#xD;
' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr2 + @atrybutyPoz2&#xD;
SET @select3 = &#xD;
    ' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod and pod5.Pod_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2 AND TrN_DataOpe BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
     LEFT JOIN ' &#xD;
    + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     lEFT JOIN (SELECT  sum(KosztyGraniczne) AS KosztyGraniczne, TransID FROM #tmpKosztyGraniczne GROUP BY TransId)KosztyGran ON Trn_Trnid = TransID &#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
&#xD;
'&#xD;
&#xD;
PRINT (@select + @select2 + @select3)&#xD;
&#xD;
EXEC (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
DROP TABLE #tmpKonAtr&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
&#xD;
DROP TABLE #tmpTwrAtr&#xD;
&#xD;
DROP TABLE #tmpSeria&#xD;
&#xD;
DROP TABLE #tmppozatr&#xD;
&#xD;
DROP TABLE #tmpKosztyGraniczne&#xD;
&#xD;
DROP TABLE #tmpMarza&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+Q9gXTX4eeGv2fSZXMlwqzoBe8qh5g1OTUWqhH+F8ftHNglKNdAzKn3IMffSC0Sqt2ynpe+2dfp58ssUsfM6jKcToBVdp6m4Utkt3D5eBb9TvbT5Qo3FcFO7cJvt/yuUCgIgHg2+NKckmlkHVlrApS52XE2itIgrMbMZ2LzEHRimA==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena początkowa" caption="Cena początkowa" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Cena transakcyjna" caption="Cena transakcyjna" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Jednostka Pomocnicza" caption="Sprzedaż Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Koszty Graniczne" caption="Koszt Zakupu Koszty Graniczne" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Waluta Koszt Zakupu" caption="Waluta Koszt Zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Koszt Zakupu Waluta" caption="Koszt Zakupu Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Dzień" caption="Data Analizy Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Tydzień Roku" caption="Data Analizy Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Miesiąc" caption="Data Analizy Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy Kwartał" caption="Data Analizy Kwartał" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Analizy Rok" caption="Data Analizy Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut TEST" caption="Kontrahent Pierwotny Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut TEST" caption="Kontrahent Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut TEST" caption="Odbiorca Atrybut TEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KLUCZOWY (K)" caption="Dokument Atrybut KLUCZOWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOLOR" caption="Dokument Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut CENA ATRYB" caption="Dokument Atrybut CENA ATRYB" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROWIZJA" caption="Dokument Atrybut PROWIZJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut MONTER KOSZT (K)" caption="Dokument Atrybut MONTER KOSZT (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut CENA2" caption="Produkt Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TESTZAS" caption="Produkt Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DIETA" caption="Produkt Atrybut DIETA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut CENA2" caption="Pozycja Atrybut CENA2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut TESTZAS" caption="Pozycja Atrybut TESTZAS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="275" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[79b4fd08-89fd-4e9c-8f36-800c2c9f6ec2]" caption="Sprzedaż Marża od stu %" formula="(Koszt Zakupu = 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Koszt Zakupu)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[cf798467-601e-4835-b799-360b5e6ee17d]" caption="Sprzedaż Rabat %" formula="((Sprzedaż Rabat + Sprzedaż Wartość) = 0 ? 0 : Sprzedaż Rabat/(Sprzedaż Rabat + Sprzedaż Wartość))" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[76670afd-9472-46ed-81d4-def4aca96164]" caption="Sprzedaż Marża w stu %" formula="( Sprzedaż Wartość= 0 ? 1 : (Sprzedaż Wartość-Koszt Zakupu)/Sprzedaż Wartość)" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Sprzedaży wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o sprzedaży w firmie. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Analizy oparte są o faktury sprzedaży, paragony nieskojarzone z fakturą sprzedaży i dokumenty &#xD;
skojarzone. Niebrane pod uwagę są natomiast następujące dokumenty pierwotne a także dokumenty anulowane.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (faktur, paragonów itp.). &#xD;
TraElem - Tabela z elementami dokumentów (faktur, paragonów itp.).</a:description><a:id>2</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>02. Raport Sprzedaży</a:mainLinkName><a:modifiedOn>2025-05-23T17:47:21.177</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-30T19:23:13.357</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Sprzedaży Rok Do Roku &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
;WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @kolumny2 varchar(max)&#xD;
declare @kolumny3 varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
set @kolumny3 = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = ISNULL(biezacy.Poziom' +LTRIM(@i) + ', ISNULL(poprzedni.Poziom' +LTRIM(@i) + ', ''(NIEPRZYPISANE)''))'&#xD;
    set @kolumny2 = @kolumny2 + ',Poz.Poziom' +LTRIM(@i) &#xD;
    set @kolumny3 = @kolumny3 + ',Poz.Poziom' +LTRIM(@i) + ' as Poziom' + +LTRIM(@i)&#xD;
    set @i = @i + 1&#xD;
end;&#xD;
&#xD;
--Właściwe Zapytanie&#xD;
set @select = &#xD;
'with BU as&#xD;
(&#xD;
select &#xD;
SUM(TR.TrE_WartoscNetto) as Wartosc, SUM(TR.TrE_Ilosc) as Ilosc, YEAR(TRN.TrN_DataOpe)*100+ MONTH(TRN.TrN_DataOpe) as MR, Twr_TwrId as Produkt, Twr_Kod as Kod, Twr_Nazwa as Nazwa ' + @kolumny3 +&#xD;
' from CDN.TraElem tr&#xD;
JOIN CDN.TraNag trn on trn.TrN_TrNID=TR.TrE_TrNId&#xD;
JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
LEFT OUTER JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = gidNumer&#xD;
WHERE&#xD;
(TrN_TypDokumentu=-1 OR CDN.TypSkojarzenia(TrN_TrNId)=302000 OR CDN.TypSkojarzenia(TrN_TrNId)=302306 OR CDN.TypSkojarzenia(TrN_TrNId)=305000 OR CDN.TypSkojarzenia(TrN_TrNId)=305302) &#xD;
AND TrN_Rodzaj NOT IN (302101,302102,302103)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TR.TrE_Aktywny&lt;&gt;0&#xD;
AND TR.TrE_UslugaZlozonaId = 0&#xD;
group by  YEAR(TRN.TrN_DataOpe)*100+ MONTH(TRN.TrN_DataOpe), Twr_TwrId, Twr_Kod, Twr_Nazwa' + @kolumny2 +&#xD;
') &#xD;
select &#xD;
"Baza Firmowa" = BAZ.Baz_Nazwa,&#xD;
"Data Operacji Rok" = ISNULL(Miesiace.Rok, SUBSTRING(convert(varchar,poprzedni.MR+100), 0, 5)),&#xD;
"Data Operacji Miesiąc" = ISNULL(Miesiace.Miesiac, SUBSTRING(convert(varchar,poprzedni.MR+100), 5,6)),&#xD;
"Data Analizy" = GETDATE(),&#xD;
"Sprzedaż Wartość Bieżący" = biezacy.Wartosc, "Sprzedaż Ilość Bieżący" = biezacy.Ilosc, "Sprzedaż Wartość Poprzedni" = poprzedni.Wartosc,   "Sprzedaż Ilość Poprzedni" = poprzedni.Ilosc, &#xD;
"Produkt Kod" = ISNULL(biezacy.Kod, ISNULL(poprzedni.Kod, ''(PUSTE)'')), &#xD;
"Produkt Nazwa" = ISNULL(biezacy.Nazwa, ISNULL(poprzedni.Nazwa, ''(PUSTE)''))&#xD;
----------KONTEKSTY&#xD;
,25003 [Produkt Kod __PROCID__Towary__], ISNULL(biezacy.Produkt,poprzedni.Produkt) [Produkt Kod __ORGID__], '''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
,25003 [Produkt Nazwa __PROCID__], ISNULL(biezacy.Produkt,poprzedni.Produkt) [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]'&#xD;
+ @kolumny +&#xD;
' from &#xD;
( &#xD;
    select &#xD;
            M.MR, SUBSTRING(convert(varchar,M.MR), 0, 5) as Rok, SUBSTRING(convert(varchar,M.MR), 5,6) as Miesiac&#xD;
    from&#xD;
            (&#xD;
                select distinct YEAR(TR.TrN_DataOpe)*100+ MONTH(TR.TrN_DataOpe) as MR  from CDN.TraNag tr&#xD;
                union&#xD;
                select distinct YEAR(TR.TrN_DataOpe)*100+ MONTH(TR.TrN_DataOpe)+100 as MR  from CDN.Tranag tr&#xD;
            )M&#xD;
            &#xD;
) as Miesiace&#xD;
left outer join bu as biezacy on biezacy.MR=Miesiace.MR&#xD;
full outer join bu as poprzedni on poprzedni.MR=Miesiace.MR-100 &#xD;
                and isNull(biezacy.Produkt,1) = case when biezacy.Produkt is null then 1 else poprzedni.Produkt end&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
&#xD;
'&#xD;
&#xD;
exec(@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKVD7xB2t0nsVId2gfbjGiwljBvDVQu0ZSrIJ1q9LUGkIB5kdG6Yodti03/WiTBwRH8eHa49Fb8l0Ifrlh/LhWNubowHzRiBE7vS3ktzz+CyxZe6iBMRamt3cq05ZSGhHVA52kBFqeB9BEaIrtKz7PUQ==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Bieżący" caption="Sprzedaż Wartość Bieżący" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Poprzedni" caption="Sprzedaż Wartość Poprzedni" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[b163b73c-dd7e-4bdb-b618-5a347803054c]" caption="Wzrost Sprzedaży" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[cb7b40f8-c862-41db-9223-e7dcd41d9ad7]" caption="Wzrost Sprzedaży %" type="measure" formatString="p2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[b163b73c-dd7e-4bdb-b618-5a347803054c]" caption="Wzrost Sprzedaży" formula="Sprzedaż Wartość Bieżący-Sprzedaż Wartość Poprzedni" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[cb7b40f8-c862-41db-9223-e7dcd41d9ad7]" caption="Wzrost Sprzedaży %" formula="(Sprzedaż Wartość Poprzedni = 0 ? 1 : (Sprzedaż Wartość Bieżący-Sprzedaż Wartość Poprzedni)/Sprzedaż Wartość Poprzedni)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Sprzedaży Rok do Roku wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o sprzedaży w firmie. Wartości prezentowane są w walucie systemowej. Raport posiada cztery miary: Sprzedaż Wartość Bieżący, Sprzedaż Wartość Poprzedni, Sprzedaż Ilość Bieżący, Sprzedaż Ilość Poprzedni umożliwiające &#xD;
porównywanie sprzedaży w analogicznych okresach wybranego roku i roku poprzedniego w rozbiciu na miesiące, produkty i grupy produktów.&#xD;
&#xD;
Analizy oparte są o faktury sprzedaży, paragony nieskojarzone z fakturą sprzedaży i dokumenty skojarzone. Niebrane pod uwagę są natomiast następujące dokumenty: Korekta ilościowa faktury sprzedaży pierwotna, Korekta wartościowa faktury sprzedaży pierwotna, Korekta stawki VAT faktury sprzedaży pierwotna, a także dokumenty anulowane.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (faktur, paragonów itp.). &#xD;
TraElem - Tabela z elementami dokumentów (faktur, paragonów itp.).</a:description><a:id>3</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>03. Raport Sprzedaży Rok do Roku</a:mainLinkName><a:modifiedOn>2025-02-04T12:04:35.117</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-06-30T14:17:08.037</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')  &#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, DB_NAME()+convert(Varchar(10),TN.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    "Dokument Numer" = TN.TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TN.TrN_Opis,''''), ''(BRAK)''),&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TN.TrN_NumerPelny,0,CHARINDEX(''/'',TN.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TN.TrN_NumerPelny,CHARINDEX(''/'',TN.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TN.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    Waluta = CASE WHEN TN.TrN_Waluta = '''' THEN @Wal ELSE TN.TrN_Waluta END, &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1, &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa,&#xD;
       CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
       "Produkt Kod" = Twr_Kod, &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
        "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
      "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc, "Numer Obcy " = TN.Trn_NumerObcy &#xD;
       ,ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza]&#xD;
       ,CAST(TrE_Ilosc/ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza]&#xD;
       ,CAST(TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
       ,WartosciGran AS [Zakupy Koszty Graniczne]&#xD;
&#xD;
       /*&#xD;
       ----------DATY POINT&#xD;
       ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-'')&#xD;
       */&#xD;
       ----------DATY ANALIZY&#xD;
       ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TN.TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TN.TrN_DataOpe), "Data Operacji Rok" = YEAR(TN.TrN_DataOpe)&#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataWys)*/ &#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TN.TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TN.TrN_DataWys), "Data Wystawienia Rok" = YEAR(TN.TrN_DataWys)&#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TN.TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TN.TrN_Termin), "Termin Płatności Rok" = YEAR(TN.TrN_Termin) &#xD;
       ,"Data Analizy" = GETDATE()&#xD;
       ----------KONTEKSTY&#xD;
        ,29047 [Dokument Numer __PROCID__Zakupy__], TN.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
        ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
        ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
        ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag TN&#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TN.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TN.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TN.TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TN.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TN.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TN.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TN.TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN (Select SUM(TE.TrE_WartoscNetto) WartosciGran, TE2.TRE_TREID elemID&#xD;
         From cdn.Tranag &#xD;
        LEFT JOIN cdn.Traelem TE ON  TRN_trnid = TE.TrE_TrNId&#xD;
        join cdn.TraElem TE2 ON te2.tre_treid=te.TrE_ZwrId&#xD;
         where trn_rodzaj IN (301008,301009,301018)&#xD;
         GROUP BY  TE2.TRE_TREID)KwoGran ON Tre_TreId = elemID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TN.TrN_TypDokumentu=301&#xD;
AND TN.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0 '&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJkozp/IvNnBLj39zwOKlDF6/xramB8AWZ/XTPqtZJQ5i+6mfBh+5s5cdoLpmwmYSfFRSp26rUQB5hdza5MeYOZ82zXD1F7ivhoDmIVH5/dDOxRL4wcAw44QEfTZkhlv3v</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Numer Obcy " caption="Numer Obcy " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DELIVERY_GLN (K)" caption="Dokument Atrybut DELIVERY_GLN (K)" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Zakupów wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o zakupach w firmie. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Analizy oparte są o faktury zakupu i dokumenty skojarzone.&#xD;
Niebrane pod uwagę są dokumenty anulowane.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (faktur, paragonów itp.). &#xD;
TraElem - Tabela z elementami dokumentów (faktur, paragonów itp.).</a:description><a:id>4</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>04. Raport Zakupów</a:mainLinkName><a:modifiedOn>2025-02-04T12:05:07.343</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-11-28T20:49:17.617</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Księgowości (ER) &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Połączenie do tabeli stawek i operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Stawki varchar(max), @Stawki2 varchar(max), @Operatorzy varchar(max), @sql varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @Stawki2 = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[CfgWartosci]'&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @sql =&#xD;
'SELECT * INTO #tmpStawki FROM [' +&#xD;
(SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001) + '].[' + &#xD;
(SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002) + '].[CDN].[CfgKlucze]&#xD;
&#xD;
SELECT  BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    CASE &#xD;
     WHEN (MONTH(RYC_DataPrz) = MONTH(GETDATE())-1) AND (YEAR(RYC_DataPrz) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(RYC_DataPrz) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(RYC_DataPrz) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Przychodu Miesiąc Poprzedni],&#xD;
   CASE &#xD;
     WHEN (MONTH(RYC_DataPrz) = MONTH(GETDATE())) AND (YEAR(RYC_DataPrz) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Przychodu Miesiąc Bieżący],&#xD;
&#xD;
    CASE &#xD;
     WHEN (MONTH(RYC_DataWpi) = MONTH(GETDATE())-1) AND (YEAR(RYC_DataWpi) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(RYC_DataWpi) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(RYC_DataWpi) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Wpisu Miesiąc Poprzedni],&#xD;
   CASE &#xD;
     WHEN (MONTH(RYC_DataWpi) = MONTH(GETDATE())) AND (YEAR(RYC_DataWpi) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Wpisu Miesiąc Bieżący],&#xD;
    RYC_Dokument AS [Dokument Numer], &#xD;
    ISNULL(RYC_Kategoria , ''(NIEPRZYPISANY)'') [Kategoria Opis], CASE WHEN RYC_Bufor = 0  THEN ''Ewidencja'' ELSE ''Bufor'' END AS [Ewidencja/Bufor], &#xD;
    CASE WHEN Kategorie.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE Kategorie.Kat_KodSzczegol END AS [Kategoria Szczegółowa],&#xD;
    CASE WHEN Kategorie.Kat_KodOgolny IS NULL THEN ''(PUSTA)'' ELSE Kategorie.Kat_KodOgolny END AS [Kategoria Ogólna],&#xD;
    ISNULL(op1.Ope_Kod, ''(NIEPRZYPISANY)'') AS [Operator Wprowadzający], ISNULL(op2.Ope_Kod, ''(NIEPRZYPISANY)'') AS [Operator Modyfikujący],&#xD;
    RYC_Przychod1 AS [Sprzedaż wg Stawki 3], RYC_Przychod2 AS [Sprzedaż wg Stawki 4], RYC_Przychod3 AS [Sprzedaż wg Stawki 5],&#xD;
    RYC_Przychod4 AS [Sprzedaż wg Stawki 1], RYC_Przychod5 AS [Sprzedaż wg Stawki 2], RYC_Przychod6 AS [Sprzedaż wg Stawki 6],&#xD;
    RYC_Przychod7 AS [Sprzedaż wg Stawki 7], RYC_Przychod8 AS [Sprzedaż wg Stawki 8], RYC_Przychod9 AS [Sprzedaż wg Stawki 9],&#xD;
    RYC_Przychod10 AS [Sprzedaż wg Stawki 10], RYC_Przychod11 AS [Sprzedaż wg Stawki 11],&#xD;
    RYC_Przychod1 + RYC_Przychod2 + RYC_Przychod3 + RYC_Przychod4 + RYC_Przychod5 + RYC_Przychod6 + RYC_Przychod7 + RYC_Przychod8 + RYC_Przychod9 + RYC_Przychod10 + RYC_Przychod11 AS [Przychód],&#xD;
    (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 1'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 1 Wartości],&#xD;
    (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 2'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 2 Wartości],&#xD;
    (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 3'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 3 Wartości],&#xD;
    (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 4'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 4 Wartości],            &#xD;
    (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 5'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 5 Wartości],&#xD;
    (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 6'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 6 Wartości],&#xD;
        (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 7'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 7 Wartości],&#xD;
        (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 8'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 8 Wartości],&#xD;
        (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 9'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 9 Wartości],&#xD;
        (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 10'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 10 Wartości],&#xD;
        (SELECT CFW_Wartosc FROM #tmpStawki&#xD;
         JOIN ' + @stawki2 + ' ON CFK_CfkId = CFW_CfkId &#xD;
     WHERE CFK_Nazwa = ''Ryczałt 11'' AND (RYC_DataPrz BETWEEN CFK_OkresOd AND (CFK_OkresDo - 1))) + ''%'' AS [Stawka 11 Wartości]  &#xD;
     /*&#xD;
     ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), RYC_DataPrz, 111), ''/'', ''-'') AS [Data Przychodu]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), RYC_DataWpi, 111), ''/'', ''-'') AS [Data Wpisu]&#xD;
    */&#xD;
     ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), RYC_DataPrz, 111), ''/'', ''-'') AS [Data Przychodu Dzień], YEAR(RYC_DataPrz) AS [Data Przychodu Rok]&#xD;
    ,DATEPART(quarter, RYC_DataPrz) AS [Data Przychodu Kwartał], MONTH(RYC_DataPrz) AS [Data Przychodu Miesiąc] &#xD;
    ,(datepart(DY, datediff(d, 0, RYC_DataPrz) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, RYC_DataPrz)*/ [Data Przychodu Tydzień Roku]   &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), RYC_DataWpi, 111), ''/'', ''-'') AS [Data Wpisu Dzień]&#xD;
    ,YEAR(RYC_DataWpi) AS [Data Wpisu Rok],     DATEPART(quarter, RYC_DataWpi) AS [Data Wpisu Kwartał], MONTH(RYC_DataWpi) AS [Data Wpisu Miesiąc]&#xD;
    ,(datepart(DY, datediff(d, 0, RYC_DataWpi) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, RYC_DataWpi)*/ [Data Wpisu Tydzień Roku]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
FROM CDN.Ryczalt&#xD;
    LEFT OUTER JOIN CDN.Kategorie Kategorie ON RYC_KatID = Kategorie.Kat_KatID&#xD;
    LEFT JOIN ' + @Operatorzy + ' op1 ON RYC_OpeZalID = op1.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' op2 ON RYC_OpeModID = op2.Ope_OpeId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
    RYC_Skreslony = 0&#xD;
&#xD;
DROP TABLE #tmpStawki'&#xD;
&#xD;
exec(@sql)&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QLNy8SvsWvjndP4rYWmIrmw65/eZ7QPiim3cKUThrJOp91uo2s2QytZVCI0ahIBHPzdhq77ZDLGeLB8+lbsStd7vm43X6LXAKL9w6h0FfZBf9Uj7s+3FidcUexdetSTV6vrf8rZMUIt1NhZ06gugvCRYqi8xvIguoxld2Vu7JmyrUlk9XwDSp1IKgy8vRqerWxEHnYLyhMFg==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Data Przychodu Dzień" caption="Data Przychodu Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Przychodu Rok" caption="Data Przychodu Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Przychodu Kwartał" caption="Data Przychodu Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Przychodu Miesiąc" caption="Data Przychodu Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Przychodu Tydzień Roku" caption="Data Przychodu Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wpisu Dzień" caption="Data Wpisu Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wpisu Rok" caption="Data Wpisu Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wpisu Kwartał" caption="Data Wpisu Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wpisu Miesiąc" caption="Data Wpisu Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wpisu Tydzień Roku" caption="Data Wpisu Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Opis" caption="Kategoria Opis" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Ewidencja/Bufor" caption="Ewidencja/Bufor" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Szegółowa" caption="Kategoria Szegółowa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna" caption="Kategoria Ogólna" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Sprzedaż wg Stawki 3" caption="Sprzedaż wg Stawki 3" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż wg Stawki 4" caption="Sprzedaż wg Stawki 4" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż wg Stawki 5" caption="Sprzedaż wg Stawki 5" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż wg Stawki 1" caption="Sprzedaż wg Stawki 1" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż wg Stawki 2" caption="Sprzedaż wg Stawki 2" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż wg Stawki 6" caption="Sprzedaż wg Stawki 6" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód" caption="Przychód" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Stawka 1 Wartości" caption="Stawka 1 Wartości" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Stawka 2 Wartości" caption="Stawka 2 Wartości" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Stawka 3 Wartości" caption="Stawka 3 Wartości" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Stawka 4 Wartości" caption="Stawka 4 Wartości" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Stawka 5 Wartości" caption="Stawka 5 Wartości" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Stawka 6 Wartości" caption="Stawka 6 Wartości" type="attribute" formatString="### ##0.00" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False"&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Księgowości (ER) wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje księgowe z firmy, która prowadzi księgowość za pomocą Ewidencji&#xD;
Ryczałtowej. Prezentowane są wszystkie dokumenty z ewidencji. Wartości prezentowane są&#xD;
w walucie systemowej.&#xD;
&#xD;
Raport oparty na tabeli:&#xD;
CDN.Ryczalt - tabela zawiera zapisy w ewidencji przychodów objętych zryczałtowanym&#xD;
podatkiem dochodowym</a:description><a:id>5</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>05. Raport Księgowości (ER)</a:mainLinkName><a:modifiedOn>2024-09-27T16:01:45.753</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-11-28T20:51:23.127</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Księgowości (KP) &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max), @sql varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]'  &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @sql=&#xD;
'SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    CASE &#xD;
     WHEN (MONTH(KPR_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(KPR_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(KPR_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(KPR_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Operacji Miesiąc Poprzedni],&#xD;
   CASE &#xD;
     WHEN (MONTH(KPR_DataOpe) = MONTH(GETDATE())) AND (YEAR(KPR_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Operacji Miesiąc Bieżący],&#xD;
    KPR_Dokument AS [Dokument Numer], &#xD;
    KPR_Kategoria AS [Kategoria Opis], CASE WHEN KPR_Bufor = 0  THEN ''KPiR Księga'' ELSE ''KPiR Bufor'' END AS [KPiR Księga/KPiR Bufor], &#xD;
    CASE WHEN Kategorie.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE Kategorie.Kat_KodSzczegol END AS [Kategoria Szeczegółowa],&#xD;
    CASE WHEN Kategorie.Kat_KodOgolny IS NULL THEN ''(PUSTA)'' ELSE Kategorie.Kat_KodOgolny END AS [Kategoria Ogólna],&#xD;
    ISNULL(op1.Ope_Kod, ''(NIEPRZYPISANY)'') AS [Operator Wprowadzający], ISNULL(op2.Ope_Kod, ''(NIEPRZYPISANY)'') AS [Operator Modyfikujący],&#xD;
    CASE WHEN KPR_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN KPR_PodmiotTyp = 2 THEN ''Bank''&#xD;
         WHEN KPR_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN KPR_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN KPR_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END AS [Podmiot Pierwotny Typ], &#xD;
    Podmioty.Pod_Kod AS [Podmiot Pierwotny Kod], &#xD;
    Podmioty.Pod_Nazwa1 AS [Podmiot Pierwotny Nazwa], &#xD;
    Podmioty.Pod_NIP AS [Podmiot Pierwotny NIP],    &#xD;
    Podmioty.Pod_Kraj AS [Podmiot Pierwotny Kraj],&#xD;
    Podmioty.Pod_Wojewodztwo AS [Podmiot Pierwotny Województwo], Podmioty.Pod_Powiat AS [Podmiot Pierwotny Powiat], Podmioty.Pod_Gmina AS [Podmiot Pierwotny Gmina],&#xD;
    Podmioty.Pod_Miasto AS [Podmiot Pierwotny Miasto],&#xD;
    CASE WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END AS [Podmiot Typ], &#xD;
    pod5.Pod_Nazwa1 [Podmiot Nazwa], &#xD;
    pod5.Pod_Kod [Podmiot Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Podmiot NIP],&#xD;
    pod5.Pod_Kraj AS [Podmiot Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo],&#xD;
    "Podmiot Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
    "Podmiot Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
    ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
    isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
    KPR_Sprzedaz AS [Sprzedaż], KPR_Pozostale AS [Pozostałe Przychody], KPR_Towary AS [Zakup Towarów], &#xD;
    KPR_Uboczne AS [Koszty Uboczne], KPR_Reklama AS [Reklama],  KPR_Wynagrodz AS [Wynagrodzenia], KPR_Inne AS [Pozostałe Koszty], KPR_Zaszlosci AS [Zaszłości],&#xD;
    KPR_Sprzedaz + KPR_Pozostale AS [Przychód],  KPR_Towary + KPR_Uboczne + KPR_Reklama + KPR_Wynagrodz + KPR_Inne AS [Rozchód], &#xD;
    (KPR_Sprzedaz + KPR_Pozostale) - (KPR_Towary + KPR_Uboczne + KPR_Reklama + KPR_Wynagrodz + KPR_Inne) AS [Saldo] &#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), KPR_DataOpe, 111), ''/'', ''-'') AS [Data Operacji]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), KPR_DataOpe, 111), ''/'', ''-'') AS [Data Operacji Dzień], YEAR(KPR_DataOpe) AS [Data Operacji Rok]&#xD;
    ,DATEPART(quarter, KPR_DataOpe) AS [Data Operacji Kwartał]&#xD;
    ,MONTH(KPR_DataOpe) AS [Data Operacji Miesiąc]&#xD;
    ,(datepart(DY, datediff(d, 0, KPR_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, KPR_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,20121 [Dokument Numer __PROCID__KP__], KPR_KPRID [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Podmioty.Pod_PodId [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Podmiot Pierwotny Nazwa __PROCID__], Podmioty.Pod_PodId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__]&#xD;
    ,20201 [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__]&#xD;
&#xD;
FROM CDN.ZapisyKPR&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView Podmioty ON KPR_PodID = Podmioty.Pod_PodId AND KPR_PodmiotTyp = Podmioty.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.Kategorie Kategorie ON KPR_KatID = Kategorie.Kat_KatID&#xD;
    LEFT JOIN ' + @Operatorzy + ' op1 ON KPR_OpeZalID = op1.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' op2 ON KPR_OpeModID = op2.Ope_OpeId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on Podmioty.Pod_GlID = pod5.Pod_PodId and Podmioty.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = KPR_ZakID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
    KPR_Skreslony = 0'&#xD;
&#xD;
EXEC(@sql)&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM3AIWZU/6OpQkKyN+6B1FNMEH/FHa55V/ecPXpX/BUjHjBX5lsAN2DEi1FztfFdymyQACbKc14AwHmvSXJWRlxmOlGUvVkuw7emTarqvqrboa47FkCfwjTI6S+1FbEFI6t6m3o8+TRbbJagg+OTYcvaOVbsvP9cNGs+Xn1fkmizPY57zUZAfsIeMmmWf+gLHzA==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc Poprzedni" caption="Data Operacji Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc Bieżący" caption="Data Operacji Miesiąc Bieżący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Opis" caption="Kategoria Opis" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="KPiR Księga/KPiR Bufor" caption="KPiR Księga/KPiR Bufor" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Szeczegółowa" caption="Kategoria Szeczegółowa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna" caption="Kategoria Ogólna" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Typ" caption="Podmiot Pierwotny Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kod" caption="Podmiot Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Nazwa" caption="Podmiot Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kraj" caption="Podmiot Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Województwo" caption="Podmiot Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Powiat" caption="Podmiot Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Gmina" caption="Podmiot Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Miasto" caption="Podmiot Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Kraj" caption="Podmiot Kraj" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Województwo" caption="Podmiot Województwo" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Powiat" caption="Podmiot Powiat" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Gmina" caption="Podmiot Gmina" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Miasto" caption="Podmiot Miasto" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż" caption="Sprzedaż" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pozostałe Przychody" caption="Pozostałe Przychody" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakup Towarów" caption="Zakup Towarów" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszty Uboczne" caption="Koszty Uboczne" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Reklama" caption="Reklama" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wynagrodzenia" caption="Wynagrodzenia" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pozostałe Koszty" caption="Pozostałe Koszty" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zaszłości" caption="Zaszłości" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód" caption="Przychód" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód" caption="Rozchód" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo" caption="Saldo" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Księgowości (KP) wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje księgowe z firmy, która prowadzi księgowość za pomocą Księgi Podatkowej. Prezentowane są wszystkie dokumenty z Księgi Przychodów i Rozchodów. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Raport oparty na tabeli:&#xD;
CDN.ZapisyKPR - tabela zawiera zapisy księgi przychodów i rozchodów</a:description><a:id>6</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>06. Raport Księgowości (KP)</a:mainLinkName><a:modifiedOn>2025-02-04T12:05:53.75</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-11-28T20:52:04.143</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Księgowości (KK) &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @String varchar(1024)&#xD;
DECLARE @Pos int&#xD;
CREATE TABLE #Keywords (string varchar(100)) &#xD;
DECLARE @Key varchar(100)&#xD;
SET @String = @OKRESOBRACHUNKOWY&#xD;
SET @Pos = 1&#xD;
WHILE (@Pos &gt; 0)&#xD;
BEGIN&#xD;
    SET @Pos = PATINDEX('%,%', @String)&#xD;
    SET @Key = SUBSTRING(@String, 0, @Pos)&#xD;
    IF (@Pos = 0)&#xD;
        BEGIN&#xD;
            INSERT INTO #Keywords (string) VALUES(@String)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN&#xD;
            INSERT INTO #Keywords (string) VALUES(@Key)&#xD;
        END&#xD;
    SET @String = SUBSTRING(@String, @Pos+1, (SELECT LEN(@String)))&#xD;
END &#xD;
&#xD;
&#xD;
SELECT *,OOb_OObID oobid INTO  #oob FROM(&#xD;
SELECT    SUBSTRING(string, 1, CHARINDEX(';', string) - 1) AS year,&#xD;
    SUBSTRING(string, CHARINDEX(';', string) + 1, LEN(string)) AS db  FROM #Keywords &#xD;
  )OB&#xD;
  JOIN CDN.OkresyObrach ON OOb_Symbol =  year &#xD;
  WHERE db = DB_NAME()&#xD;
&#xD;
  Drop table #Keywords&#xD;
&#xD;
--Wyliczanie poziomów kont&#xD;
;WITH g(gid, kod, naz, nazB, parId, poziom, nazwa)&#xD;
AS&#xD;
(&#xD;
      SELECT Acc_AccId, Acc_Segment, Acc_Nazwa,  Acc_Nazwa2, Acc_ParId, Acc_Poziom, convert(nvarchar(1024), Acc_Segment) as nazwa&#xD;
      FROM CDN.Konta&#xD;
      WHERE Acc_ParId IS NULL AND Acc_OObId IN (SELECT OOBID From #oob)&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT Acc_AccId, Acc_Segment, Acc_Nazwa, Acc_Nazwa2, Acc_ParId, Acc_Poziom, convert(nvarchar(1024), p.nazwa + N'-' + c.Acc_Segment) as nazwa&#xD;
      FROM g p&#xD;
             JOIN CDN.Konta c ON c.Acc_ParId = p.gid &#xD;
      WHERE c.Acc_ParId IS NOT NULL AND  C.Acc_OObId IN (SELECT OOBID From #oob)&#xD;
)     &#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt; 0  &#xD;
BEGIN&#xD;
       SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50), Nazwa' + CAST(@poziom AS nvarchar) + N' nvarchar(4000), NazwaB' + CAST(@poziom AS nvarchar) + N' nvarchar(4000)' &#xD;
    EXEC(@sql)&#xD;
&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
             BEGIN&#xD;
                    SET @sql = N'UPDATE #tmpTwrGr&#xD;
                           SET ONr' + CAST(@poziom AS nvarchar) +  '= parId '&#xD;
                    EXEC(@sql)&#xD;
                    &#xD;
                    SET @sql = N'UPDATE #tmpTwrGr&#xD;
                           SET Poziom' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + kod + '')'' ELSE kod END'&#xD;
                    EXEC(@sql)&#xD;
                    &#xD;
                    SET @sql = N'UPDATE #tmpTwrGr&#xD;
                           SET Nazwa' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + naz + '')'' ELSE naz END'&#xD;
                    EXEC(@sql)&#xD;
&#xD;
                    SET @sql = N'UPDATE #tmpTwrGr&#xD;
                           SET NazwaB' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + nazB + '')'' ELSE nazB END'&#xD;
                    EXEC(@sql)&#xD;
&#xD;
             END&#xD;
    ELSE&#xD;
             BEGIN &#xD;
             SET @sql = N'UPDATE c&#xD;
                           SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                                  CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                                        WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(c.kod AS nvarchar) + '')''&#xD;
                                        WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(p.kod AS nvarchar) + '')''&#xD;
                                  ELSE p.kod END)  &#xD;
                           FROM #tmpTwrGr c&#xD;
                           LEFT JOIN #tmpTwrGr p&#xD;
                           ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                    EXEC(@sql)&#xD;
                    &#xD;
                    SET @sql = N'UPDATE c&#xD;
                           SET c.Nazwa' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                                  CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN c.naz&#xD;
                                        WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + c.naz + '')''&#xD;
                                        WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + p.naz + '')''&#xD;
                                  ELSE p.naz END)  ,&#xD;
                                  c.NazwaB' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                                  CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN c.nazB&#xD;
                                        WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + c.nazB + '')''&#xD;
                                        WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + p.nazB + '')''&#xD;
                                  ELSE p.nazB END)  &#xD;
                           FROM #tmpTwrGr c&#xD;
                           LEFT JOIN #tmpTwrGr p&#xD;
                           ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                    EXEC(@sql)&#xD;
       &#xD;
                    SET @sql = N'UPDATE c&#xD;
                           SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                                  CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parId AS nvarchar)&#xD;
                                  ELSE CAST(p.parId AS nvarchar) END)  &#xD;
                           FROM #tmpTwrGr c&#xD;
                           LEFT JOIN #tmpTwrGr p&#xD;
                           ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                           EXEC(@sql)&#xD;
             END&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
declare @select varchar(max), @select2 varchar(max), @select3 varchar(max);&#xD;
declare @kolumny varchar(max), @kolumny2 varchar(max);&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
&#xD;
set @i=1&#xD;
if @i&lt;=@poziom_max  &#xD;
begin&#xD;
       set @kolumny = ', SUBSTRING(Poz.Poziom1, 1, 1) AS [Konto Grupa]'&#xD;
       set @kolumny2 = ', [Konto Grupa]'&#xD;
end&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
       set @kolumny = @kolumny + ', CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END [Konto Struktura Poziom ' + LTRIM(@i) + '] ' +&#xD;
                                                 ', CASE WHEN Poz.Nazwa' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Nazwa' + LTRIM(@i) + ' END [Konto Nazwa Poziom ' + LTRIM(@i) + '] ' +&#xD;
                                                 ', CASE WHEN Poz.NazwaB' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.NazwaB' + LTRIM(@i) + ' END [Konto Nazwa2 Poziom ' + LTRIM(@i) + '] '&#xD;
       set @kolumny2 = @kolumny2 + ', [Konto Struktura Poziom ' + LTRIM(@i) + '] ' + ', [Konto Nazwa Poziom ' + LTRIM(@i) + '] ' + ', [Konto Nazwa2 Poziom ' + LTRIM(@i) + '] '&#xD;
       set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]'  &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
SET @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT &#xD;
    [Baza Firmowa],&#xD;
    [Okres Obrachunkowy], &#xD;
    [Dokument Numer], &#xD;
    [Dokument Element Numer], [Dokument Bufor] [Zatwierdzone/Bufor], [Dziennik], [Dziennik Numer], [Identyfikator Księgowy],  [Konto Pełny Numer], &#xD;
    [Konto Przeciwstawne], [Kategoria Szczegółowa z Elementu], [Kategoria Szczegółowa z Nagłówka], [Kategoria Ogólna z Elementu], [Kategoria Ogólna z Nagłówka],&#xD;
    [Dokument Opis z Elementu], [Dokument Opis z Nagłówka],&#xD;
    [Podmiot Pierwotny Typ], &#xD;
    [Podmiot Pierwotny Kod],    &#xD;
    [Podmiot Pierwotny Nazwa], &#xD;
    [Podmiot Pierwotny NIP],&#xD;
    [Podmiot Pierwotny Kraj], [Podmiot Pierwotny Województwo], [Podmiot Pierwotny Powiat],  [Podmiot Pierwotny Gmina], [Podmiot Pierwotny Miasto], [Podmiot Pierwotny z Pozycji],&#xD;
    [Podmiot Typ], [Podmiot Nazwa],&#xD;
    [Podmiot Kod], &#xD;
    [Podmiot NIP],&#xD;
    [Podmiot Kraj], [Podmiot Województwo],&#xD;
    [Podmiot Powiat], [Podmiot Gmina],[Podmiot Miasto], [Podmiot z Pozycji],&#xD;
    [Operator Wprowadzający],[Operator Modyfikujący],  &#xD;
    [Rodzaj] [Bilans Otwarcia], [Konto Typ] [Typ Konta], [Konto Typy] [Typy Kont], [Kontrola budżetu] [Kontrola Budżetu], [Konto Rozrachunkowe], [Waluta],&#xD;
    [Obroty Winien] [Obroty Wn], [Obroty Ma], [Obroty Winien Waluta] [Obroty Wn Waluta], [Obroty Ma Waluta],    &#xD;
    [Bilans Otwarcia Ma], [Bilans Otwarcia Winien] [Bilans Otwarcia Wn], [Bilans Otwarcia Ma Waluta], [Bilans Otwarcia Winien Waluta] [Bilans Otwarcia Wn Waluta],&#xD;
    [Plan Wn], [Plan Ma] &#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,[Data Księgowania Dzień]&#xD;
    ,[Data Wystawienia Dzień]&#xD;
    ,[Data Operacji Dzień]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,[Data Księgowania Dzień], [Data Księgowania Rok], [Data Księgowania Kwartał], [Data Księgowania Miesiąc], [Data Księgowania Miesiąc Poprzedni], [Data Księgowania Miesiąc Bieżący]&#xD;
    ,[Data Księgowania Tydzień Roku]&#xD;
    ,[Data Wystawienia Dzień], [Data Wystawienia Rok], [Data Wystawienia Kwartał], [Data Wystawienia Miesiąc], [Data Wystawienia Miesiąc Poprzedni],[Data Wystawienia Miesiąc Bieżący]&#xD;
    ,[Data Wystawienia Tydzień Roku]&#xD;
    ,[Data Operacji Dzień], [Data Operacji Rok], [Data Operacji Kwartał], [Data Operacji Miesiąc], [Data Operacji Miesiąc Poprzedni],[Data Operacji Miesiąc Bieżący]&#xD;
    ,[Data Operacji Tydzień Roku]&#xD;
    ,[Data Analizy]&#xD;
    &#xD;
    ----------KONTEKSTY&#xD;
    ,[Dokument Numer __PROCID__KH__], [Dokument Numer __ORGID__],[Dokument Numer __DATABASE__]&#xD;
    ,[Podmiot Pierwotny Kod __PROCID__Kontrahenci__], [Podmiot Pierwotny Kod __ORGID__],[Podmiot Pierwotny Kod __DATABASE__]&#xD;
    ,[Podmiot Pierwotny Nazwa __PROCID__], [Podmiot Pierwotny Nazwa __ORGID__],[Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    ,[Podmiot Nazwa __PROCID__], [Podmiot Nazwa __ORGID__], [Podmiot Nazwa __DATABASE__]&#xD;
    ,[Podmiot Kod __PROCID__Kontrahenci__], [Podmiot Kod __ORGID__], [Podmiot Kod __DATABASE__]&#xD;
    &#xD;
    ' + @kolumny2 +&#xD;
' FROM &#xD;
(SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], REPLACE(CONVERT(VARCHAR(10), DeN_DataDok, 111), ''/'', ''-'') [Data Księgowania Dzień],  YEAR(DeN_DataDok) [Data Księgowania Rok], &#xD;
    DATEPART(quarter, DeN_DataDok) [Data Księgowania Kwartał], MONTH(DeN_DataDok) [Data Księgowania Miesiąc], &#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataDok) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataDok) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataDok) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataDok) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataDok) = MONTH(GETDATE())) AND (YEAR(DeN_DataDok) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Bieżący],&#xD;
&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataDok) / 7 * 7 + 3)+6) / 7 [Data Księgowania Tydzień Roku],&#xD;
    REPLACE(CONVERT(VARCHAR(10), DeN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień],  YEAR(DeN_DataWys) [Data Wystawienia Rok], &#xD;
    DATEPART(quarter, DeN_DataWys) [Data Wystawienia Kwartał], MONTH(DeN_DataWys) [Data Wystawienia Miesiąc], &#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataWys) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataWys) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataWys) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataWys) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Wystawienia Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataWys) = MONTH(GETDATE())) AND (YEAR(DeN_DataWys) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Wystawienia Miesiąc Bieżący],&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataWys) / 7 * 7 + 3)+6) / 7 [Data Wystawienia Tydzień Roku],&#xD;
    REPLACE(CONVERT(VARCHAR(10), DeN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień],  YEAR(DeN_DataOpe) [Data Operacji Rok], &#xD;
    DATEPART(quarter, DeN_DataOpe) [Data Operacji Kwartał], MONTH(DeN_DataOpe) [Data Operacji Miesiąc], &#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Operacji Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataOpe) = MONTH(GETDATE())) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Operacji Miesiąc Bieżący],&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Operacji Tydzień Roku],&#xD;
    GETDATE() [Data Analizy],&#xD;
    OOb_Symbol [Okres obrachunkowy], &#xD;
    &#xD;
    DeN_Dokument [Dokument Numer], &#xD;
    26002 [Dokument Numer __PROCID__KH__], DeN_DeNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__],&#xD;
&#xD;
    DeE_Dokument [Dokument Element Numer], CASE WHEN DeN_Bufor = 0  THEN ''Zatwierdzone'' ELSE ''Bufor'' END [Dokument Bufor], &#xD;
    Dzi_Symbol [Dziennik], CONVERT(VARCHAR(10),DeN_NrKsiegi) [Dziennik Numer],  DeN_IdentKsieg [Identyfikator Księgowy], poz.nazwa [Konto pełny numer], DeE_KontoMa [Konto Przeciwstawne],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Elementu], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], &#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Elementu], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka],&#xD;
    ISNULL(DeE_Kategoria, ''(PUSTY)'') [Dokument Opis z Elementu], ISNULL(DeN_Kategoria, ''(PUSTY)'') [Dokument Opis z Nagłówka],&#xD;
    CASE WHEN DeN_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN DeN_PodmiotTyp = 2 THEN ''Bank''&#xD;
         WHEN DeN_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN DeN_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN DeN_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END [Podmiot Pierwotny Typ], &#xD;
&#xD;
    ISNULL(Podmioty.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Kod],&#xD;
    20201 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Podmioty.Pod_PodId [Podmiot Pierwotny Kod __ORGID__], '''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__],&#xD;
    &#xD;
    ISNULL(Podmioty.Pod_Nazwa1, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Nazwa], &#xD;
    20201 [Podmiot Pierwotny Nazwa __PROCID__], Podmioty.Pod_PodId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__],&#xD;
    &#xD;
    ISNULL(Podmioty.Pod_NIP, ''(BRAK)'') [Podmiot Pierwotny NIP],&#xD;
    ISNULL(Podmioty.Pod_Kraj, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Kraj],&#xD;
    ISNULL(Podmioty.Pod_Wojewodztwo, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Województwo], ISNULL(Podmioty.Pod_Powiat, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Powiat], ISNULL(Podmioty.Pod_Gmina, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Gmina],&#xD;
    ISNULL(Podmioty.Pod_Miasto, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Miasto], ISNULL(PodPoz.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny z Pozycji],&#xD;
    CASE WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END AS [Podmiot Typ], &#xD;
&#xD;
    ISNULL(pod5.Pod_Nazwa1, ''(NIEPRZYPISANY)'')  [Podmiot Nazwa], &#xD;
    20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__],&#xD;
    &#xD;
    ISNULL(pod5.Pod_Kod, ''(NIEPRZYPISANY)'')  [Podmiot Kod], &#xD;
    20201 [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__],&#xD;
&#xD;
    ISNULL(pod5.Pod_NIP, ''(BRAK)'')  AS [Podmiot NIP],&#xD;
    ISNULL(pod5.Pod_Kraj, ''(NIEPRZYPISANY)'')  AS [Podmiot Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo],&#xD;
    "Podmiot Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
    "Podmiot Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
    ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot z Pozycji],&#xD;
&#xD;
    ISNULL(op1.Ope_Kod, ''(NIEPRZYPISANY)'') [Operator Wprowadzający], ISNULL(op2.Ope_Kod, ''(NIEPRZYPISANY)'') [Operator Modyfikujący],&#xD;
    ''NIE'' AS [Rodzaj],    &#xD;
    CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 THEN ''Koszty''&#xD;
         WHEN Acc_TypKonta = 4 THEN ''Przychody''&#xD;
         WHEN Acc_TypKonta = 3 THEN ''Aktywno pasywne''&#xD;
         WHEN Acc_TypKonta = 2 THEN ''Pasywa''&#xD;
         WHEN Acc_TypKonta = 1 THEN ''Aktywa''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typ],&#xD;
            CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 OR Acc_TypKonta = 4  THEN ''Wynikowe''&#xD;
         WHEN Acc_TypKonta = 3 OR Acc_TypKonta = 2 OR Acc_TypKonta = 1 THEN ''Bilansowe''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typy],&#xD;
    CASE WHEN Acc_KontrolaBudzetu = 0 THEN ''Brak''&#xD;
         WHEN Acc_KontrolaBudzetu = 1 THEN ''Obroty Wn'' &#xD;
         WHEN Acc_KontrolaBudzetu = 2 Then ''obroty Ma''&#xD;
    END [Kontrola budżetu],&#xD;
    CASE WHEN Acc_Rozrachunkowe = 1 THEN ''TAK'' ELSE ''NIE'' END AS [Konto Rozrachunkowe],&#xD;
    CASE WHEN DeE_Waluta = '''' THEN @Wal ELSE DeE_Waluta END [Waluta],&#xD;
    CASE WHEN DeE_AccWnId IS NOT NULL THEN DeE_Kwota ELSE NULL END [Obroty Winien], NULL [Obroty Ma],&#xD;
    CASE WHEN DeE_AccWnId IS NOT NULL THEN DeE_KwotaWal ELSE NULL END [Obroty Winien Waluta], NULL [Obroty Ma Waluta],&#xD;
    NULL AS [Bilans Otwarcia Ma], NULL  AS [Bilans Otwarcia Winien],&#xD;
    NULL [Bilans Otwarcia Ma Waluta], NULL [Bilans Otwarcia Winien Waluta],&#xD;
    NULL [Plan Wn], NULL [Plan Ma]  '&#xD;
    + @kolumny +&#xD;
' FROM CDN.DekretyNag&#xD;
    JOIN CDN.DekretyElem ON DeE_DeNId = DeN_DeNId AND DeE_AccWnId IS NOT NULL&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat1 ON DeE_KatId = kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat2 ON DeN_KatId = kat2.Kat_KatID&#xD;
    JOIN CDN.Dzienniki ON DeN_DziId = Dzi_DziId&#xD;
    LEFT OUTER JOIN #tmpTwrGr Poz ON DeE_AccWnId = Poz.gid &#xD;
    LEFT OUTER JOIN CDN.Konta ON DeE_AccWnId = Acc_AccId&#xD;
    JOIN CDN.OkresyObrach ON DeN_OObId = OOb_OObID&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView Podmioty ON DeN_PodmiotId = Podmioty.Pod_PodId AND DeN_PodmiotTyp = Podmioty.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView PodPoz ON DeE_SlownikId = PodPoz.Pod_PodId and DeE_SlownikTyp = PodPoz.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op1 ON DeN_OpeZalID = op1.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' op2 ON DeN_OpeModID = op2.Ope_OpeId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on Podmioty.Pod_GlID = pod5.Pod_PodId and Podmioty.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 on PodPoz.Pod_GlID = pod6.Pod_PodId and PodPoz.Pod_GlKod = pod6.Pod_Kod&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
  WHERE DeN_Typ &lt;&gt; 1&#xD;
  AND Oob_OobId IN (SELECt OOBID FROM #OOB)&#xD;
 &#xD;
UNION ALL &#xD;
&#xD;
SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], REPLACE(CONVERT(VARCHAR(10), DeN_DataDok, 111), ''/'', ''-'') [Data Księgowania Dzień],  YEAR(DeN_DataDok) [Data Księgowania Rok], &#xD;
    DATEPART(quarter, DeN_DataDok) [Data Księgowania Kwartał], MONTH(DeN_DataDok) [Data Księgowania Miesiąc], &#xD;
&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataDok) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataDok) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataDok) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataDok) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataDok) = MONTH(GETDATE())) AND (YEAR(DeN_DataDok) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Bieżący],&#xD;
&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataDok) / 7 * 7 + 3)+6) / 7 [Data Księgowania Tydzień Roku],&#xD;
    REPLACE(CONVERT(VARCHAR(10), DeN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień],  YEAR(DeN_DataWys) [Data Wystawienia Rok], &#xD;
    DATEPART(quarter, DeN_DataWys) [Data Wystawienia Kwartał], MONTH(DeN_DataWys) [Data Wystawienia Miesiąc], &#xD;
&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataWys) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataWys) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataWys) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataWys) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Wystawienia Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataWys) = MONTH(GETDATE())) AND (YEAR(DeN_DataWys) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Wystawienia Miesiąc Bieżący],&#xD;
&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataWys) / 7 * 7 + 3)+6) / 7 [Data Wystawienia Tydzień Roku],&#xD;
    REPLACE(CONVERT(VARCHAR(10), DeN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień],  YEAR(DeN_DataOpe) [Data Operacji Rok], &#xD;
    DATEPART(quarter, DeN_DataOpe) [Data Operacji Kwartał], MONTH(DeN_DataOpe) [Data Operacji Miesiąc], &#xD;
&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Operacji Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataOpe) = MONTH(GETDATE())) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Operacji Miesiąc Bieżący],&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Operacji Tydzień Roku],&#xD;
    GETDATE() [Data Analizy],&#xD;
    OOb_Symbol [Okres obrachunkowy], &#xD;
    &#xD;
    DeN_Dokument [Dokument Numer], &#xD;
    26002 [Dokument Numer __PROCID__KH__], DeN_DeNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__],&#xD;
&#xD;
    DeE_Dokument [Dokument Element Numer], CASE WHEN DeN_Bufor = 0  THEN ''Zatwierdzone'' ELSE ''Bufor'' END [Dokument Bufor],&#xD;
    Dzi_Symbol [Dziennik], CONVERT(VARCHAR(10),DeN_NrKsiegi) [Dziennik Numer], DeN_IdentKsieg [Identyfikator Księgowy], poz.nazwa [Konto pełny numer], DeE_KontoWn [Konto Przeciwstawne],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Elementu], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], &#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Elementu], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka],&#xD;
    ISNULL(DeE_Kategoria, ''(PUSTY)'') [Dokument Opis z Elementu], ISNULL(DeN_Kategoria, ''(PUSTY)'') [Dokument Opis z Nagłówka],&#xD;
    CASE WHEN DeN_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN DeN_PodmiotTyp = 2 THEN ''Bank''&#xD;
         WHEN DeN_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN DeN_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN DeN_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END [Podmiot Pierwotny Typ], &#xD;
&#xD;
    ISNULL(Podmioty.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Kod],&#xD;
    20201 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Podmioty.Pod_PodId [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__],&#xD;
    &#xD;
    ISNULL(Podmioty.Pod_Nazwa1, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Nazwa], &#xD;
    20201 [Podmiot Pierwotny Nazwa __PROCID__], Podmioty.Pod_PodId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__],&#xD;
    &#xD;
    ISNULL(Podmioty.Pod_NIP, ''(BRAK)'') [Podmiot Pierwotny NIP],&#xD;
    ISNULL(Podmioty.Pod_Kraj, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Kraj],&#xD;
    ISNULL(Podmioty.Pod_Wojewodztwo, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Województwo], ISNULL(Podmioty.Pod_Powiat, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Powiat], ISNULL(Podmioty.Pod_Gmina, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Gmina],&#xD;
    ISNULL(Podmioty.Pod_Miasto, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Miasto], ISNULL(PodPoz.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny z Pozycji], &#xD;
        CASE WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END AS [Podmiot Typ], &#xD;
&#xD;
    ISNULL(pod5.Pod_Nazwa1, ''(NIEPRZYPISANY)'') [Podmiot Nazwa], &#xD;
    20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__],&#xD;
    &#xD;
    ISNULL(pod5.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot Kod], &#xD;
    20201 [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__],&#xD;
&#xD;
    ISNULL(pod5.Pod_NIP, ''(BRAK)'') AS [Podmiot NIP],&#xD;
    ISNULL(pod5.Pod_Kraj, ''(NIEPRZYPISANY)'') AS [Podmiot Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo],&#xD;
    "Podmiot Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
    "Podmiot Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
    ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot z Pozycji],&#xD;
    ISNULL(op1.Ope_Kod, ''(NIEPRZYPISANY)'') [Operator Wprowadzający], ISNULL(op2.Ope_Kod, ''(NIEPRZYPISANY)'') [Operator Modyfikujący],&#xD;
    ''NIE'' AS [Rodzaj], &#xD;
    CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 THEN ''Koszty''&#xD;
         WHEN Acc_TypKonta = 4 THEN ''Przychody''&#xD;
         WHEN Acc_TypKonta = 3 THEN ''Aktywno pasywne''&#xD;
         WHEN Acc_TypKonta = 2 THEN ''Pasywa''&#xD;
         WHEN Acc_TypKonta = 1 THEN ''Aktywa''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typ],&#xD;
            CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 OR Acc_TypKonta = 4  THEN ''Wynikowe''&#xD;
         WHEN Acc_TypKonta = 3 OR Acc_TypKonta = 2 OR Acc_TypKonta = 1 THEN ''Bilansowe''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typy],&#xD;
    CASE WHEN Acc_KontrolaBudzetu = 0 THEN ''Brak''&#xD;
         WHEN Acc_KontrolaBudzetu = 1 THEN ''Obroty Wn'' &#xD;
         WHEN Acc_KontrolaBudzetu = 2 Then ''obroty Ma''&#xD;
    END [Kontrola budżetu],&#xD;
    CASE WHEN Acc_Rozrachunkowe = 1 THEN ''TAK'' ELSE ''NIE'' END AS [Konto Rozrachunkowe],&#xD;
    CASE WHEN DeE_Waluta = '''' THEN @Wal ELSE DeE_Waluta END [Waluta],&#xD;
    NULL [Obroty Winien], CASE WHEN DeE_AccMaId IS NOT NULL THEN DeE_Kwota ELSE NULL END [Obroty Ma],&#xD;
    NULL [Obroty Winien Waluta], CASE WHEN DeE_AccMaId IS NOT NULL THEN DeE_KwotaWal ELSE NULL END [Obroty Ma Waluta],&#xD;
    NULL AS [Bilans Otwarcia Ma], NULL  AS [Bilans Otwarcia Winien],&#xD;
    NULL [Bilans Otwarcia Ma Waluta], NULL [Bilans Otwarcia Winien Waluta],&#xD;
    NULL [Plan Wn], NULL [Plan Ma] '&#xD;
    + @kolumny +&#xD;
' FROM CDN.DekretyNag&#xD;
    JOIN CDN.DekretyElem ON DeE_DeNId = DeN_DeNId AND DeE_AccMaId IS NOT NULL&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat1 ON DeE_KatId = kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat2 ON DeN_KatId = kat2.Kat_KatID&#xD;
    JOIN CDN.Dzienniki ON DeN_DziId = Dzi_DziId&#xD;
    LEFT OUTER JOIN #tmpTwrGr Poz ON DeE_AccMaId = Poz.gid &#xD;
    LEFT OUTER JOIN CDN.Konta ON DeE_AccMaId = Acc_AccId &#xD;
    JOIN CDN.OkresyObrach ON DeN_OObId = OOb_OObID&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView Podmioty ON DeN_PodmiotId = Podmioty.Pod_PodId AND DeN_PodmiotTyp = Podmioty.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView PodPoz ON DeE_SlownikId = PodPoz.Pod_PodId and DeE_SlownikTyp = PodPoz.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op1 ON DeN_OpeZalID = op1.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' op2 ON DeN_OpeModID = op2.Ope_OpeId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on Podmioty.Pod_GlID = pod5.Pod_PodId and Podmioty.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 on PodPoz.Pod_GlID = pod6.Pod_PodId and PodPoz.Pod_GlKod = pod6.Pod_Kod&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
  WHERE DeN_Typ &lt;&gt; 1&#xD;
  AND Oob_OobId  IN (SELECT OOBID FROM #OOB)&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], NULL [Data Księgowania Dzień], ISNULL( SUBSTRING(convert(varchar,Obr_RokMies), 1,4), 0) [Data Księgowania Rok], &#xD;
    NULL [Data Księgowania Kwartał], ISNULL( SUBSTRING(convert(varchar,Obr_RokMies), 5,6), 0) [Data Księgowania Miesiąc], &#xD;
    CASE &#xD;
     WHEN (Obr_RokMies%100 = MONTH(GETDATE())-1) AND ((Obr_RokMies/100) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN (((Obr_RokMies%100) = 12) AND (MONTH(GETDATE()) = 1)) AND ((Obr_RokMies/100) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Poprzedni],&#xD;
&#xD;
    CASE WHEN Obr_RokMies = YEAR(GETDATE())*100 + MONTH(GETDATE()) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Bieżący],&#xD;
&#xD;
&#xD;
    NULL [Data Księgowania Tydzień Roku],&#xD;
    NULL [Data Wystawienia Dzień],  NULL [Data Wystawienia Rok], &#xD;
    NULL [Data Wystawienia Kwartał], NULL [Data Wystawienia Miesiąc], NULL [Data Wystawienia Miesiąc Poprzedni], NULL [Data Wystawienia Miesiąc Bieżący],&#xD;
    NULL [Data Wystawienia Tydzień Roku],&#xD;
    NULL [Data Operacji Dzień], NULL [Data Operacji Rok], &#xD;
    NULL [Data Operacji Kwartał], NULL [Data Operacji Miesiąc], NULL [Data Operacji Miesiąc Poprzedni], NULL [Data Operacji Miesiąc Bieżący], &#xD;
    NULL [Data operacji Tydzień Roku],&#xD;
    GETDATE() [Data Analizy],&#xD;
    OOb_Symbol [Okres obrachunkowy], &#xD;
&#xD;
    NULL [Dokument Numer], &#xD;
    26006 [Dokument Numer __PROCID__KH__], Acc_AccId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__],&#xD;
&#xD;
    NULL [Dokument Element Numer], CASE WHEN Obr_ObrotyWn = 0.0 AND Obr_ObrotyMa = 0.0 THEN ''Bufor'' ELSE ''Zatwierdzone'' END [Dokument Bufor],&#xD;
    NULL [Dziennik], NULL [Dziennik Numer], NULL [Identyfikator Księgowy], poz.nazwa [Konto pełny numer], NULL [Konto Przeciwstawne],&#xD;
    NULL [Kategoria Szczegółowa z Elementu], NULL [Kategoria Szczegółowa z Nagłówka], &#xD;
    NULL [Kategoria Ogólna z Elementu], NULL [Kategoria Ogólna z Nagłówka],&#xD;
    NULL [Dokument Opis z Elementu], NULL [Dokument Opis z Nagłówka],&#xD;
    NULL [Podmiot Pierwotny Typ], &#xD;
    &#xD;
    NULL [Podmiot Pierwotny Kod], &#xD;
    26006 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Acc_AccId [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__],&#xD;
    &#xD;
    NULL [Podmiot Pierwotny Nazwa], &#xD;
    26006 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Acc_AccId [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__],&#xD;
    &#xD;
    NULL [Podmiot Pierwotny NIP],&#xD;
    NULL [Podmiot Pierwotny Kraj],&#xD;
    NULL [Podmiot Pierwotny Województwo], NULL [Podmiot Pierwotny Powiat],NULL [Podmiot Pierwotny Gmina],&#xD;
    NULL [Podmiot Pierwotny Miasto], NULL [Podmiot Pierwotny z Pozycji],    &#xD;
&#xD;
    NULL [Podmiot Typ], &#xD;
    NULL [Podmiot Kod], &#xD;
    26006 [Podmiot Kod __PROCID__Kontrahenci__], Acc_AccId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__],&#xD;
    NULL [Podmiot Nazwa], &#xD;
    26006 [Podmiot Nazwa __PROCID__Kontrahenci__], Acc_AccId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__],&#xD;
    NULL [Podmiot NIP],&#xD;
    NULL [Podmiot Kraj],&#xD;
    NULL [Podmiot Województwo], NULL [Podmiot Powiat],NULL [Podmiot Gmina],&#xD;
    NULL [Podmiot Miasto], NULL [Podmiot z Pozycji],&#xD;
&#xD;
    NULL [Operator Wprowadzający], NULL [Operator Modyfikujący],&#xD;
    CASE WHEN Obr_Typ = 0 THEN ''NIE'' WHEN Obr_Typ = 1 THEN ''TAK'' ELSE ''Korekta Bilansu Zamknięcia'' END AS [Rodzaj],&#xD;
    CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 THEN ''Koszty''&#xD;
         WHEN Acc_TypKonta = 4 THEN ''Przychody''&#xD;
         WHEN Acc_TypKonta = 3 THEN ''Aktywno pasywne''&#xD;
         WHEN Acc_TypKonta = 2 THEN ''Pasywa''&#xD;
         WHEN Acc_TypKonta = 1 THEN ''Aktywa''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typ],&#xD;
            CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 OR Acc_TypKonta = 4  THEN ''Wynikowe''&#xD;
         WHEN Acc_TypKonta = 3 OR Acc_TypKonta = 2 OR Acc_TypKonta = 1 THEN ''Bilansowe''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typy],&#xD;
    CASE WHEN Acc_KontrolaBudzetu = 0 THEN ''Brak''&#xD;
         WHEN Acc_KontrolaBudzetu = 1 THEN ''Obroty Wn'' &#xD;
         WHEN Acc_KontrolaBudzetu = 2 Then ''obroty Ma''&#xD;
    END [Kontrola budżetu],&#xD;
    CASE WHEN Acc_Rozrachunkowe = 1 THEN ''TAK'' ELSE ''NIE'' END AS [Konto Rozrachunkowe],&#xD;
    CASE WHEN Acc_Waluta = '''' THEN @Wal ELSE Acc_Waluta END [Waluta],&#xD;
    NULL [Obroty Winien], NULL [Obroty Ma], NULL [Obroty Winien Waluta], NULL [Obroty Ma Waluta],&#xD;
    CASE WHEN Obr_Typ = 1 THEN &#xD;
    CASE &#xD;
        WHEN Obr_ObrotyMa &gt; 0 THEN Obr_ObrotyMa&#xD;
        ELSE Obr_ObrotyMaBufor&#xD;
    END &#xD;
    ELSE 0 END AS [Bilans Otwarcia Ma],&#xD;
    CASE WHEN Obr_Typ = 1 THEN &#xD;
    CASE &#xD;
        WHEN Obr_ObrotyWn &gt; 0 THEN Obr_ObrotyWn &#xD;
        ELSE Obr_ObrotyWnBufor&#xD;
    END  &#xD;
    ELSE 0 END  AS [Bilans Otwarcia Winien],&#xD;
    CASE WHEN Obr_Typ = 1 THEN &#xD;
    CASE &#xD;
        WHEN Obr_ObrotyMaWal &gt; 0 THEN Obr_ObrotyMaWal &#xD;
        ELSE Obr_ObrotyMaBuforWal&#xD;
    END &#xD;
    ELSE 0 END AS [Bilans Otwarcia Ma Waluta],&#xD;
    CASE WHEN Obr_Typ = 1 THEN &#xD;
    CASE &#xD;
        WHEN Obr_ObrotyWnWal &gt; 0 THEN Obr_ObrotyWnWal &#xD;
        ELSE Obr_ObrotyWnBuforWal&#xD;
    END  &#xD;
    ELSE 0 END  AS [Bilans Otwarcia Winien Waluta],&#xD;
    NULL [Plan Wn], &#xD;
    NULL [Plan Ma]&#xD;
    &#xD;
    ' + @kolumny +&#xD;
' FROM [CDN].[Obroty]&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Obr_AccId = Poz.gid&#xD;
    LEFT JOIN CDN.Konta ON Obr_AccId = Acc_AccId&#xD;
    LEFT JOIN CDN.OkresyObrach ON Acc_OObId = OOb_OObID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    WHERE Oob_OobId  IN (SELECT OOBID FROM #OOB)&#xD;
    &#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    CASE WHEN BuE_Miesiac IS NULL THEN NULL ELSE SUBSTRING(convert(varchar,BuE_Miesiac), 1,4) + ''-'' + SUBSTRING(convert(varchar,BuE_Miesiac), 5,6) + ''-01'' END [Data Księgowania Dzień],&#xD;
    ISNULL( SUBSTRING(convert(varchar,BuE_Miesiac), 1,4), 0) [Data Księgowania Rok], &#xD;
    NULL [Data Księgowania Kwartał], ISNULL( SUBSTRING(convert(varchar,BuE_Miesiac), 5,6), 0) [Data Księgowania Miesiąc], &#xD;
&#xD;
    CASE &#xD;
     WHEN (BuE_Miesiac%100 = MONTH(GETDATE())-1) AND ((BuE_Miesiac/100) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN (((BuE_Miesiac%100) = 12) AND (MONTH(GETDATE()) = 1)) AND ((BuE_Miesiac/100) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Poprzedni],&#xD;
&#xD;
    CASE WHEN BuE_Miesiac = YEAR(GETDATE())*100 + MONTH(GETDATE()) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Bieżący],&#xD;
&#xD;
    NULL [Data Księgowania Tydzień Roku],&#xD;
    NULL [Data Wystawienia Dzień],  NULL [Data Wystawienia Rok], &#xD;
    NULL [Data Wystawienia Kwartał], NULL [Data Wystawienia Miesiąc], NULL [Data Wystawienia Miesiąc Poprzedni], NULL [Data Wystawienia Miesiąc Bieżący],&#xD;
    NULL [Data Wystawienia Tydzień Roku],&#xD;
    NULL [Data Operacji Dzień], NULL [Data Operacji Rok], &#xD;
    NULL [Data Operacji Kwartał], NULL [Data Operacji Miesiąc], NULL [Data Operacji Miesiąc Poprzedni], NULL [Data Operacji Miesiąc Bieżący], &#xD;
    NULL [Data operacji Tydzień Roku],&#xD;
    GETDATE() [Data Analizy],&#xD;
    OOb_Symbol [Okres obrachunkowy], &#xD;
    &#xD;
    NULL [Dokument Numer], &#xD;
    26006 [Dokument Numer __PROCID__KH__], Acc_AccId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__],&#xD;
    &#xD;
    NULL [Dokument Element Numer], ''Zatwierdzone'' [Dokument Bufor],&#xD;
    NULL [Dziennik], NULL [Dziennik Numer], NULL [Identyfikator Księgowy], poz.nazwa [Konto pełny numer], NULL [Konto Przeciwstawne],&#xD;
    NULL [Kategoria Szczegółowa z Elementu], NULL [Kategoria Szczegółowa z Nagłówka], &#xD;
    NULL [Kategoria Ogólna z Elementu], NULL [Kategoria Ogólna z Nagłówka],&#xD;
    NULL [Dokument Opis z Elementu], NULL [Dokument Opis z Nagłówka],&#xD;
    NULL [Podmiot Pierwotny Typ], &#xD;
    &#xD;
    NULL [Podmiot Pierwotny Kod], &#xD;
    26006 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Acc_AccId [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__],&#xD;
    &#xD;
    NULL [Podmiot Pierwotny Nazwa], &#xD;
    26006 [Podmiot Pierwotny Nazwa __PROCID__Kontrahenci__], Acc_AccId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__],&#xD;
    &#xD;
    NULL [Podmiot Pierwotny NIP],&#xD;
    NULL [Podmiot Pierwotny Kraj],&#xD;
    NULL [Podmiot Pierwotny Województwo], NULL [Podmiot Pierwotny Powiat],NULL [Podmiot Pierwotny Gmina],&#xD;
    NULL [Podmiot Pierwotny Miasto], NULL [Podmiot Pierwotny z Pozycji],&#xD;
    NULL [Podmiot Typ], &#xD;
    NULL [Podmiot Kod], &#xD;
    26006 [Podmiot Kod __PROCID__Kontrahenci__], Acc_AccId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__],&#xD;
    NULL [Podmiot Nazwa], &#xD;
    26006 [Podmiot Nazwa __PROCID__Kontrahenci__], Acc_AccId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__],&#xD;
    NULL [Podmiot NIP],&#xD;
    NULL [Podmiot Kraj],&#xD;
    NULL [Podmiot Województwo], NULL [Podmiot Powiat],NULL [Podmiot Gmina],&#xD;
    NULL [Podmiot Miasto], NULL [Podmiot z Pozycji],&#xD;
    NULL [Operator Wprowadzający], NULL [Operator Modyfikujący],&#xD;
    ''TAK'' AS [Rodzaj],&#xD;
    CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 THEN ''Koszty''&#xD;
         WHEN Acc_TypKonta = 4 THEN ''Przychody''&#xD;
         WHEN Acc_TypKonta = 3 THEN ''Aktywno pasywne''&#xD;
         WHEN Acc_TypKonta = 2 THEN ''Pasywa''&#xD;
         WHEN Acc_TypKonta = 1 THEN ''Aktywa''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typ],&#xD;
    CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 OR Acc_TypKonta = 4  THEN ''Wynikowe''&#xD;
         WHEN Acc_TypKonta = 3 OR Acc_TypKonta = 2 OR Acc_TypKonta = 1 THEN ''Bilansowe''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typy],&#xD;
    CASE WHEN Acc_KontrolaBudzetu = 0 THEN ''Brak''&#xD;
         WHEN Acc_KontrolaBudzetu = 1 THEN ''Obroty Wn'' &#xD;
         WHEN Acc_KontrolaBudzetu = 2 Then ''obroty Ma''&#xD;
    END [Kontrola budżetu],&#xD;
    CASE WHEN Acc_Rozrachunkowe = 1 THEN ''TAK'' ELSE ''NIE'' END AS [Konto Rozrachunkowe],&#xD;
    CASE WHEN Acc_Waluta = '''' THEN @Wal ELSE Acc_Waluta END [Waluta],&#xD;
    NULL [Obroty Winien], NULL [Obroty Ma], NULL [Obroty Winien Waluta], NULL [Obroty Ma Waluta],&#xD;
    NULL AS [Bilans Otwarcia Ma], NULL  AS [Bilans Otwarcia Winien],&#xD;
    NULL [Bilans Otwarcia Ma Waluta], NULL [Bilans Otwarcia Winien Waluta],&#xD;
    CASE WHEN Acc_KontrolaBudzetu = 1 THEN BuE_Kwota ELSE NULL END [Plan Wn], &#xD;
    CASE WHEN Acc_KontrolaBudzetu = 2 THEN BuE_Kwota ELSE NULL END [Plan Ma]&#xD;
    ' + @kolumny +&#xD;
' FROM CDN.Konta&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Acc_AccId = Poz.gid&#xD;
    LEFT JOIN CDN.OkresyObrach ON Acc_OObId = OOb_OObID&#xD;
    JOIN CDN.BudzetNag ON Acc_AccId = BuN_AccId&#xD;
    JOIN CDN.BudzetElem ON BuE_BuNId = BuN_BuNId &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    WHERE BuN_Finalny = 1&#xD;
  AND Oob_OobId  IN (SELECT OOBID FROM #OOB)&#xD;
&#xD;
) AS ks'&#xD;
&#xD;
--print(@select)&#xD;
exec(@select)&#xD;
&#xD;
drop Table #tmpTwrGr    &#xD;
drop Table #oob&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poQuCD4Y/PQWEq9gUy3YO4JdSTPcJ3lGCq0U8mTS5SZODqzR/Ub78HQCf4QQkf1tzLxk0Ez4F/Mk82viFxjebTIZ7G2v34pgZbhTDqO2o2b8rajE2725c1qdHlJXv4L88dXdtLBsUcwPBaaD8jcLocig=</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Data Księgowania Dzień" caption="Data Księgowania Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Księgowania Rok" caption="Data Księgowania Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Księgowania Kwartał" caption="Data Księgowania Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Księgowania Miesiąc" caption="Data Księgowania Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Księgowania Tydzień Roku" caption="Data Księgowania Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Okres Obrachunkowy" caption="Okres Obrachunkowy" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Dokument Element Numer" caption="Dokument Element Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zatwierdzone/Bufor" caption="Zatwierdzone/Bufor" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Dziennik" caption="Dziennik" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Identyfikator Księgowy" caption="Identyfikator Księgowy" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Konto Pełny Numer" caption="Konto Pełny Numer" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Konto Przeciwstawne" caption="Konto Przeciwstawne" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Elementu" caption="Kategoria Szczegółowa z Elementu" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Elementu" caption="Kategoria Ogólna z Elementu" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Dokument Opis z Elementu" caption="Dokument Opis z Elementu" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Dokument Opis z Nagłówka" caption="Dokument Opis z Nagłówka" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Kraj" caption="Podmiot Kraj" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Województwo" caption="Podmiot Województwo" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Powiat" caption="Podmiot Powiat" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Gmina" caption="Podmiot Gmina" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Miasto" caption="Podmiot Miasto" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Bilans Otwarcia" caption="Bilans Otwarcia" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Typ Konta" caption="Typ Konta" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Typy Kont" caption="Typy Kont" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrola Budżetu" caption="Kontrola Budżetu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Rozrachunkowe" caption="Konto Rozrachunkowe" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Obroty Wn" caption="Obroty Wn" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obroty Ma" caption="Obroty Ma" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obroty Wn Waluta" caption="Obroty Wn Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obroty Ma Waluta" caption="Obroty Ma Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Bilans Otwarcia Ma" caption="Bilans Otwarcia Ma" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Bilans Otwarcia Wn" caption="Bilans Otwarcia Wn" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Bilans Otwarcia Ma Waluta" caption="Bilans Otwarcia Ma Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Bilans Otwarcia Wn Waluta" caption="Bilans Otwarcia Wn Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Ma M" caption="Saldo Ma M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Wn M" caption="Saldo Wn M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Ma OO" caption="Saldo Ma OO" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Wn OO" caption="Saldo Wn OO" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Ma M Waluta" caption="Saldo Ma M Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Wn M Waluta" caption="Saldo Wn M Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Ma OO Waluta" caption="Saldo Ma OO Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Wn OO Waluta" caption="Saldo Wn OO Waluta" type="measure" formatString="### ##0.00" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Persaldo M" caption="Persaldo M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Persaldo OO" caption="Persaldo OO" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Persaldo M Waluta" caption="Persaldo M Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Persaldo OO Waluta" caption="Persaldo OO Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Plan Wn" caption="Plan Wn" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Plan Ma" caption="Plan Ma" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Konto Grupa" caption="Konto Grupa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 1" caption="Konto Struktura Poziom 1" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 1" caption="Konto Nazwa Poziom 1" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 2" caption="Konto Struktura Poziom 2" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 2" caption="Konto Nazwa Poziom 2" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 3" caption="Konto Struktura Poziom 3" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 3" caption="Konto Nazwa Poziom 3" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 4" caption="Konto Struktura Poziom 4" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 4" caption="Konto Nazwa Poziom 4" type="attribute" formatString="### ##0.00" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;OKRESOBRACHUNKOWY&lt;/Name&gt;&#xD;
    &lt;Label&gt;Okres Obrachunkowy:&lt;/Label&gt;&#xD;
    &lt;Expression&gt;select distinct Oob_Symbol +';' +DB_NAME(), Oob_Symbol + ' ' + DB_NAME() from cdn.okresyobrach&lt;/Expression&gt;&#xD;
    &lt;Type&gt;SQL&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Sql&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;true&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="False" type="Line" palette="Nature Colors" paletteBaseColor="0" style="Domyślny" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False" rotated="False"&gt;&#xD;
  &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;border borderVisible="False" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="" angle="45" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Top" alignmentHorizontal="RightOutside" spacingVertical="0" spacingHorizontal="0" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="" fillMode="Empty" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles /&gt;&#xD;
  &lt;points kind="Circle" size="10" starPoints="5" borderVisible="True" borderColor="" visible="True" color=""&gt;&#xD;
    &lt;appearance color="" fillMode="Empty" /&gt;&#xD;
  &lt;/points&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="45" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="Min" rangeMax="Max" zeroLevel="True" margins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="0" rangeMax="1" zeroLevel="True" margins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport  Księgowości (KK) wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje księgowe z firmy, która prowadzi księgowość w formie Księgowości Kontowej. Prezentowane są wszystkie dekrety księgowe. Wartości prezentowane są w walucie systemowej oraz walucie dokumentu.&#xD;
&#xD;
W celu wyświetlania poprawnych danych należy wybrać odpowiedni okres obrachunkowy, dla którego ma być przeprowadzona analiza.&#xD;
&#xD;
Dla parametru okresu obrachunkowego możliwy jest wielowybór, umożliwia to wykonywanie raportów z więcej niż jednej bazy danych. &#xD;
W przypadku wyboru wielu okresów z jednej bazy danych w celu poprawnego wykonania raportu pod uwagę wzięty zostanie jedynie najwcześniejszy z nich.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.DekretyNag - tabela zawiera nagłówki dekretów księgowych &#xD;
CDN.DekretyElem - tabela zawiera elementy dekretów księgowych&#xD;
CDN.Obroty - tabela zawiera zagregowane obroty na kontach księgowych</a:description><a:id>7</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>07. Raport Księgowości (KK)</a:mainLinkName><a:modifiedOn>2025-04-09T14:01:58.517</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-11-28T20:53:59.633</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Rejestrów VAT&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @sqlA nvarchar(max), @atrybutyDok varchar(max), @atrybut_format int;&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_VaNID IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_VaNID INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END        &#xD;
        END &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_VaNID = TM.DAt_VaNID&#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
SELECT DISTINCT BZd_Rozliczono,  BZd_Rozliczono2,BZd_DokumentID,Bzd_Numer,bzd_waluta INTO #tmpRozliczenia FROM cdn.BnkZdarzenia&#xD;
&#xD;
--Właściwe zapytanie&#xD;
DECLARE @select varchar(max);&#xD;
&#xD;
SET @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    &#xD;
    VaN_Dokument AS [Dokument Numer],&#xD;
    CASE VaT_RodzajZakupu WHEN 1 THEN ''Towary'' WHEN 2 THEN ''Inne'' WHEN 3 THEN ''Środki Trwałe'' WHEN 4 THEN ''Usługi'' WHEN 5 THEN ''Środki Transportu'' WHEN 6 THEN ''Nieruchomości'' WHEN 7 THEN ''Paliwo'' END AS [Rodzaj],&#xD;
    CASE VaT_Flaga WHEN 1 THEN ''ZW'' WHEN 4 THEN ''NP'' ELSE convert(varchar,VaT_Stawka) + ''%'' END AS [Stawka VAT], VaN_Rejestr AS [Rejestr], &#xD;
    CASE Vat_Odliczenia WHEN 0 then ''Nie''  WHEN 1 then ''Tak'' WHEN 2 then ''Warunkowo''  END [Odliczenia], &#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Elementu], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria 2 Szczegółowa z Elementu],&#xD;
    ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka],&#xD;
    ISNULL(VaN_Kategoria, ''(PUSTA)'') [Kategoria Opis z Nagłówka], ISNULL(VaT_KatOpis, ''(PUSTA)'') [Kategoria Opis z Elementu], ISNULL(VaT_Kat2Opis, ''(PUSTA)'') [Kategoria 2 Opis z Elementu],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Elementu], ISNULL(kat3.Kat_KodOgolny, ''(PUSTA)'') [Kategoria 2 Ogólna z Elementu],&#xD;
    CASE WHEN VaN_RozliczacVat7 = 1 THEN ''TAK'' ELSE ''NIE'' END [Rozliczać do Deklaracji VAT], &#xD;
    ISNULL(SUBSTRING(convert(varchar,VaN_DeklRokMies), 1,4), ''(NIEPRZYPISANE)'') [Data Rozliczenia w Deklaracji Rok], &#xD;
    ISNULL(SUBSTRING(convert(varchar,VaN_DeklRokMies), 5,6), ''(NIEPRZYPISANE)'') [Data Rozliczenia w Deklaracji Miesiąc],&#xD;
    SUBSTRING(convert(varchar,&#xD;
    CASE VaN_DeklRokMiesKasa&#xD;
    WHEN 0 THEN NULL&#xD;
    ELSE VaN_DeklRokMiesKasa END&#xD;
    ), 1,4) [Data Rozliczenia wg Metody Kasowej Rok], &#xD;
 SUBSTRING(convert(varchar,&#xD;
    CASE VaN_DeklRokMiesKasa&#xD;
    WHEN 0 THEN NULL&#xD;
    ELSE VaN_DeklRokMiesKasa END&#xD;
    ), 5,6) [Data Rozliczenia wg Metody Kasowej Miesiąc], &#xD;
    CASE WHEN VaN_Waluta = '''' THEN @Wal ELSE VaN_Waluta END [Waluta],&#xD;
    CASE WHEN VaT_Flaga = 1 THEN ''Zwolniona''&#xD;
         WHEN VaT_Flaga = 2 THEN ''Opodatkowana''&#xD;
         WHEN VaT_Flaga = 3 THEN ''Zaniżona''&#xD;
         WHEN VaT_Flaga = 4 THEN ''Nie podlega''&#xD;
    ELSE ''(NIEPRZYPISANE)'' END AS [Typ Stawki],&#xD;
    CASE WHEN VaN_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN VaN_PodmiotTyp = 2 THEN ''Bank''&#xD;
         WHEN VaN_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN VaN_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN VaN_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END AS [Podmiot Pierwotny Typ], &#xD;
    Podmioty.Pod_Kod AS [Podmiot Pierwotny Kod], &#xD;
    Podmioty.Pod_Nazwa1 AS [Podmiot Pierwotny Nazwa], &#xD;
    Podmioty.Pod_NIP AS [Podmiot Pierwotny NIP],&#xD;
    Podmioty.Pod_Kraj AS [Podmiot Pierwotny Kraj],&#xD;
    Podmioty.Pod_Wojewodztwo AS [Podmiot Pierwotny Województwo], Podmioty.Pod_Powiat AS [Podmiot Pierwotny Powiat], Podmioty.Pod_Gmina AS [Podmiot Pierwotny Gmina],&#xD;
    Podmioty.Pod_Miasto AS [Podmiot Pierwotny Miasto],&#xD;
        CASE WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END AS [Podmiot Typ], &#xD;
    pod5.Pod_Nazwa1 [Podmiot Nazwa], &#xD;
    pod5.Pod_Kod [Podmiot Kod],&#xD;
    pod5.Pod_NIP AS [Podmiot NIP],&#xD;
    pod5.Pod_Kraj AS [Podmiot Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo],&#xD;
    "Podmiot Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
    "Podmiot Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
    ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
    isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
    VaN_IdentKsieg AS [Id. Księgowy],&#xD;
    CASE WHEN VaN_Typ = 1 THEN VaT_VATDoVAT ELSE NULL END AS [Kwota Zakupy VAT], CASE WHEN VaN_Typ = 2 THEN VaT_VATDoVAT ELSE NULL END AS [Kwota Sprzedaż VAT],&#xD;
    CASE WHEN VaN_Typ = 1 THEN VaT_NettoDoVAT + VaT_VATDoVAT ELSE NULL END AS [Kwota Zakupy Brutto], CASE WHEN VaN_Typ = 2 THEN VaT_VATDoVAT + VaT_NettoDoVAT ELSE NULL END AS [Kwota Sprzedaż Brutto],&#xD;
    CASE WHEN VaN_Typ = 1 THEN VaT_NettoDoVAT ELSE NULL END AS [Kwota Zakupy Netto], CASE WHEN VaN_Typ = 2 THEN VaT_NettoDoVAT ELSE NULL END AS [Kwota Sprzedaż Netto],&#xD;
    CASE WHEN VaN_Typ = 1 THEN VaT_VATWal ELSE NULL END AS [Kwota Zakupy VAT Waluta], CASE WHEN VaN_Typ = 2 THEN VaT_VATWal ELSE NULL END AS [Kwota Sprzedaż VAT Waluta],&#xD;
    CASE WHEN VaN_Typ = 1 THEN VaT_NettoWal + VaT_VATWal ELSE NULL END AS [Kwota Zakupy Brutto Waluta], CASE WHEN VaN_Typ = 2 THEN VaT_NettoWal + VaT_VATWal ELSE NULL END AS [Kwota Sprzedaż Brutto Waluta],&#xD;
    CASE WHEN VaN_Typ = 1 THEN VaT_NettoWal ELSE NULL END AS [Kwota Zakupy Netto Waluta], CASE WHEN VaN_Typ = 2 THEN VaT_NettoWal ELSE NULL END AS [Kwota Sprzedaż Netto Waluta],&#xD;
    CASE WHEN VaN_Typ = 2 AND VaN_Detal = 1 THEN ''Tak'' Else ''Nie'' END AS [Sprzedaż detaliczna],&#xD;
    CASE  &#xD;
    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=1 THEN ''Nie''&#xD;
    WHEN BZd_Rozliczono=2 THEN ''Tak''&#xD;
    WHEN BZd_Rozliczono=2 AND BZd_Rozliczono2=2 THEN ''Tak''&#xD;
    ELSE ''Nie''END [Dokument Rozliczony],&#xD;
    VaN_OpeModKod [Operator Modyfikujący],&#xD;
    VaN_OpeZalKod [Operator Wprowadzający]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataWys, 111), ''/'', ''-'') AS [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataZap, 111), ''/'', ''-'') AS [Data Zapisu]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataOpe, 111), ''/'', ''-'') AS [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_TS_Zal, 111), ''/'', ''-'') AS [Data Wprowadzenia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_TS_Mod, 111), ''/'', ''-'') AS [Data Modyfikacji]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataWys, 111), ''/'', ''-'') AS [Data Wystawienia Dzień], YEAR(VaN_DataWys) AS [Data Wystawienia Rok] &#xD;
    ,DATEPART(quarter, VaN_DataWys) AS [Data Wystawienia Kwartał], MONTH(VaN_DataWys) AS [Data Wystawienia Miesiąc], (datepart(DY, datediff(d, 0, VaN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, VaN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataZap, 111), ''/'', ''-'') AS [Data Zapisu Dzień], YEAR(VaN_DataZap) AS [Data Zapisu Rok]&#xD;
    ,DATEPART(quarter, VaN_DataZap) AS [Data Zapisu Kwartał], MONTH(VaN_DataZap) AS [Data Zapisu Miesiąc], (datepart(DY, datediff(d, 0, VaN_DataZap) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, VaN_DataZap)*/ [Data Zapisu Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataOpe, 111), ''/'', ''-'') AS [Data Operacji Dzień], YEAR(VaN_DataOpe) AS [Data Operacji Rok] &#xD;
    ,DATEPART(quarter, VaN_DataOpe) AS [Data Operacji Kwartał], MONTH(VaN_DataOpe) AS [Data Operacji Miesiąc], (datepart(DY, datediff(d, 0, VaN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, VaN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_TS_Zal, 111), ''/'', ''-'') AS [Data Wprowadzenia Dzień], YEAR(VaN_TS_Zal) AS [Data Wprowadzenia Rok] &#xD;
    ,DATEPART(quarter, VaN_TS_Zal) AS [Data Wprowadzenia Kwartał], MONTH(VaN_TS_Zal) AS [Data Wprowadzenia Miesiąc], (datepart(DY, datediff(d, 0, VaN_TS_Zal) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, VaN_TS_Zal)*/ [Data Wprowadzenia Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_TS_Mod, 111), ''/'', ''-'') AS [Data Modyfikacji Dzień], YEAR(VaN_TS_Mod) AS [Data Modyfikacji Rok] &#xD;
    ,DATEPART(quarter, VaN_TS_Mod) AS [Data Modyfikacji Kwartał], MONTH(VaN_TS_Mod) AS [Data Modyfikacji Miesiąc], (datepart(DY, datediff(d, 0, VaN_TS_Mod) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, VaN_TS_Mod)*/ [Data Modyfikacji Tydzień Roku]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
    ----------KONTEKSTY&#xD;
    ,20101 [Dokument Numer __PROCID__VAT__], VaN_VaNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,CASE Podmioty.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Podmioty.Pod_PodId [Podmiot Pierwotny Kod __ORGID__], '''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__]&#xD;
    ,CASE Podmioty.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Pierwotny Nazwa __PROCID__], Podmioty.Pod_PodId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__]&#xD;
    ,CASE pod5.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__]&#xD;
    &#xD;
    '&#xD;
    &#xD;
    + @atrybutyDok +&#xD;
' FROM CDN.VatNag&#xD;
    JOIN CDN.VatTab ON VaN_VaNID = VaT_VaNID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat1 ON VaT_KatID=kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat2 ON VaN_KatID=kat2.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat3 ON VaT_Kat2ID=kat3.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView Podmioty ON VaN_PodID = Podmioty.Pod_PodId AND VaN_PodmiotTyp = Podmioty.Pod_PodmiotTyp&#xD;
    LEFT JOIN #tmpDokAtr DokAtr ON VaT_VaNID  = DokAtr.DAt_VaNId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on Podmioty.Pod_GlID = pod5.Pod_PodId and Podmioty.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = VaN_ZakID&#xD;
	LEFT JOIN #tmpRozliczenia on VaN_VaNID=BZd_DokumentID AND Bzd_Numer=VaN_Dokument and Van_waluta = bzd_waluta&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0'&#xD;
exec(@select)&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpRozliczenia&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2ji2hPfAjFY4M+tyTN+WFbqesYguIRD4zhi2+XbPG4+IXlBAY1WtwNgyWhhgg2DLjiTmd8QWzd4S48umcSZUrrUqKFUikgGFuKUE6/c5LlVGtOckIiL+1rWVN9YoxYiyqr</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Rodzaj" caption="Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Stawka VAT" caption="Stawka VAT" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Rejestr" caption="Rejestr" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Odliczenia" caption="Odliczenia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Elementu" caption="Kategoria Szczegółowa z Elementu" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria 2 Szczegółowa z Elementu" caption="Kategoria 2 Szczegółowa z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Opis z Nagłówka" caption="Kategoria Opis z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Opis z Elementu" caption="Kategoria Opis z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria 2 Opis z Elementu" caption="Kategoria 2 Opis z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Elementu" caption="Kategoria Ogólna z Elementu" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria 2 Ogólna z Elementu" caption="Kategoria 2 Ogólna z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rozliczać do Deklaracji VAT" caption="Rozliczać do Deklaracji VAT" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Rozliczenia w Deklaracji Rok" caption="Data Rozliczenia w Deklaracji Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Rozliczenia w Deklaracji Miesiąc" caption="Data Rozliczenia w Deklaracji Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Rozliczenia wg Metody Kasowej Rok" caption="Data Rozliczenia wg Metody Kasowej Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia wg Metody Kasowej Miesiąc" caption="Data Rozliczenia wg Metody Kasowej Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Typ Stawki" caption="Typ Stawki" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Typ" caption="Podmiot Pierwotny Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kod" caption="Podmiot Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Nazwa" caption="Podmiot Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny NIP" caption="Podmiot Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kraj" caption="Podmiot Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Województwo" caption="Podmiot Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Powiat" caption="Podmiot Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Gmina" caption="Podmiot Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Miasto" caption="Podmiot Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot NIP" caption="Podmiot NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kraj" caption="Podmiot Kraj" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Województwo" caption="Podmiot Województwo" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Powiat" caption="Podmiot Powiat" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Gmina" caption="Podmiot Gmina" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Miasto" caption="Podmiot Miasto" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Id. Księgowy" caption="Id. Księgowy" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kwota Zakupy VAT" caption="Kwota Zakupy VAT" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż VAT" caption="Kwota Sprzedaż VAT" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Zakupy Brutto" caption="Kwota Zakupy Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż Brutto" caption="Kwota Sprzedaż Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Zakupy Netto" caption="Kwota Zakupy Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż Netto" caption="Kwota Sprzedaż Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Zakupy VAT Waluta" caption="Kwota Zakupy VAT Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż VAT Waluta" caption="Kwota Sprzedaż VAT Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Zakupy Brutto Waluta" caption="Kwota Zakupy Brutto Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż Brutto Waluta" caption="Kwota Sprzedaż Brutto Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Zakupy Netto Waluta" caption="Kwota Zakupy Netto Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż Netto Waluta" caption="Kwota Sprzedaż Netto Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż detaliczna" caption="Sprzedaż detaliczna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Rozliczony" caption="Dokument Rozliczony" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Zapisu Dzień" caption="Data Zapisu Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Zapisu Rok" caption="Data Zapisu Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Zapisu Kwartał" caption="Data Zapisu Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Zapisu Miesiąc" caption="Data Zapisu Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Zapisu Tydzień Roku" caption="Data Zapisu Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wprowadzenia Dzień" caption="Data Wprowadzenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wprowadzenia Rok" caption="Data Wprowadzenia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wprowadzenia Kwartał" caption="Data Wprowadzenia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wprowadzenia Miesiąc" caption="Data Wprowadzenia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wprowadzenia Tydzień Roku" caption="Data Wprowadzenia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Modyfikacji Dzień" caption="Data Modyfikacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Modyfikacji Rok" caption="Data Modyfikacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Modyfikacji Kwartał" caption="Data Modyfikacji Kwartał" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Modyfikacji Miesiąc" caption="Data Modyfikacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Modyfikacji Tydzień Roku" caption="Data Modyfikacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KODY PROJEKTÓW" caption="Dokument Atrybut KODY PROJEKTÓW" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PRACOWNICY" caption="Dokument Atrybut PRACOWNICY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Rejestrów VAT wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje z rejestrów VAT, zarówno zakupów jak i sprzedaży. Prezentowane są wszystkie dokumenty z rejestrów. Wartości prezentowane są w walucie systemowej oraz walucie dokumentu.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.VatNag - tabela nagłówków dokumentów w rejestrze VAT. Tabela VatNag zawiera informacje o dacie dokumentu, kontrahencie itp.&#xD;
CDN.VatTab - tabela elementów (pozycji) dokumentu w rejestrze VAT. Tabela zawiera informacje o pozycjach dokumentu, zagregowanych do poszczególnych stawek VAT.</a:description><a:id>8</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>08. Raport Rejestrów VAT</a:mainLinkName><a:modifiedOn>2025-06-04T10:39:43.19</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-11-28T20:54:48.557</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Kadr i Płac &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
DECLARE @bazaKonf varchar(max)&#xD;
SET @bazaKonf = (Select SYS_Wartosc from cdn.SystemCDN WHERE SYS_ID = 1002)&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Wyliczanie wymiaru etatu&#xD;
select PRE_PraId PrId,&#xD;
PRE_DataOd as PrData,&#xD;
PRE_EtaStawka PrStawka,&#xD;
CONVERT(VARCHAR(2),PRE_ETAEtatL) + '/' + CONVERT(VARCHAR(2),PRE_ETAEtatM) PrWymiar,&#xD;
PRE_WaznoscBadanOkres PrBad&#xD;
into #tmpetat&#xD;
from CDN.PracEtaty r&#xD;
join&#xD;
(select PRE_PraId PrId,&#xD;
MAX(PRE_DataOd) as PrData&#xD;
from CDN.PracEtaty&#xD;
where PRE_ETAEtatL &lt;&gt; 0 and PRE_ETAEtatM &lt;&gt; 0&#xD;
group by PRE_PraId ) e on e.PrId = r.PRE_PraId and e.PrData = r.PRE_DataOd&#xD;
order by PRE_PraId&#xD;
&#xD;
--Wybór dat obowiązywania z najnowszych umów&#xD;
SELECT DISTINCT * INTO #tmpUmowy FROM(&#xD;
SELECT WPL_WplId as UMW_WplId, UMW_PraId, UMW_UmwId, UMW_DataOd, UMW_DataDo, UMW_NumerPelny, RANK() OVER(PARTITION BY UMW_PraId, WPL_WplId ORDER BY UMW_UmwId DESC) rank&#xD;
FROM CDN.Wyplaty&#xD;
JOIN CDN.Umowy &#xD;
    ON WPL_PraId = UMW_PraId &#xD;
    AND CAST(UMW_DataOd AS Date) &lt;= CAST(WPL_DataDo AS Date) &#xD;
    AND CAST(UMW_DataDo AS Date) &gt;= CAST( WPL_DataOd AS Date)&#xD;
WHERE UMW_UmwId is not null) umowy WHERE rank = 1&#xD;
&#xD;
--Wyliczanie hierarchii wydziałów&#xD;
SELECT DZL_DzlId [gid], DZL_Kod [kod], DZL_ParentId [parId], DZL_Poziom [poziom] INTO #tmpTwrGr FROM CDN.Dzialy&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt; 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(100), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(100)'&#xD;
    EXEC(@sql)&#xD;
&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= parId '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + kod + '')'' ELSE kod END'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                         WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(c.kod AS nvarchar) + '')''&#xD;
                         WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(p.kod AS nvarchar) + '')''&#xD;
                    ELSE p.kod END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parId AS nvarchar)&#xD;
                    ELSE CAST(p.parId AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
declare @select varchar(max);&#xD;
declare @kolumny varchar(max);&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
&#xD;
set @i=1&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ', CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END [Wydział Poziom ' + LTRIM(@i) + '] '&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Pracowników&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(100), @atrybuty varchar(max), @sqlA nvarchar(max), @atrybut_Typ int, @atrybut_format nvarchar(21),&#xD;
@atrybutyDataOd varchar(max), @atrybutyDataDo varchar(max);&#xD;
&#xD;
DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DISTINCT OAT_AtkId, REPLACE(ATK_Nazwa, ']', '_'), ATK_Typ, ATK_Format&#xD;
FROM CDN.OAtrybuty&#xD;
JOIN CDN.OAtrybutyKlasy ON OAT_AtkId = ATK_AtkId&#xD;
WHERE OAT_PrcId IS NOT NULL;&#xD;
--AND OAT_AtkId IS NOT NULL;&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_Typ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT OAT_PrcId INTO #tmpKonAtr FROM CDN.OAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
SET @atrybutyDataOd = ''&#xD;
SET @atrybutyDataDo = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    SET @sqlA = @sqlA + N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N' Od] nvarchar(max)'&#xD;
    SET @sqlA = @sqlA + N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N' Do] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = &#xD;
         CASE WHEN ' + convert(varchar,@atrybut_Typ) + ' = 3  THEN REPLACE(ATR.ATH_Wartosc,'','',''.'') ELSE ATR.ATH_Wartosc END,&#xD;
        [' + CAST(@atrybut_kod AS nvarchar(50)) +  ' Od] = REPLACE(CONVERT(VARCHAR(10), OAT_OkresOd, 111), ''/'', ''-''),&#xD;
        [' + CAST(@atrybut_kod AS nvarchar(50)) +  ' Do] = REPLACE(CONVERT(VARCHAR(10), OAT_OkresDo, 111), ''/'', ''-'')&#xD;
        FROM CDN.OAtrybutyHist ATR &#xD;
        JOIN CDN.OAtrybuty OA ON OA.OAT_OatId = ATR.ATH_OatId AND ATR.ATH_DataDo = (SELECT MAX(A1.ATH_DataDo) FROM CDN.OAtrybutyHist A1 WHERE A1.ATH_OatId = ATR.ATH_OatId)&#xD;
        JOIN #tmpKonAtr TM ON OA.OAT_PrcId = TM.OAT_PrcId&#xD;
        WHERE ATR.ATH_AtkId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = &#xD;
          CASE WHEN ' + convert(varchar,@atrybut_Typ) + ' = 3 AND ''' + convert(varchar,@atrybut_Format) + ''' &lt;&gt; ''Data'' THEN REPLACE(ATR.ATH_Wartosc,'','',''.'') ELSE &#xD;
           CASE WHEN ' + convert(varchar,@atrybut_Typ) + ' = 3 AND ''' + convert(varchar,@atrybut_Format) + ''' = ''Data'' THEN &#xD;
             REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.ATH_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'')&#xD;
             ELSE ATR.ATH_Wartosc  END&#xD;
          END,&#xD;
        [' + CAST(@atrybut_kod AS nvarchar(50)) +  ' Od] = REPLACE(CONVERT(VARCHAR(10), OAT_OkresOd, 111), ''/'', ''-''),&#xD;
        [' + CAST(@atrybut_kod AS nvarchar(50)) +  ' Do] = REPLACE(CONVERT(VARCHAR(10), OAT_OkresDo, 111), ''/'', ''-'')&#xD;
        FROM CDN.OAtrybutyHist ATR &#xD;
        JOIN CDN.OAtrybuty OA ON OA.OAT_OatId = ATR.ATH_OatId AND ATR.ATH_DataDo = (SELECT MAX(A1.ATH_DataDo) FROM CDN.OAtrybutyHist A1 WHERE A1.ATH_OatId = ATR.ATH_OatId)&#xD;
        JOIN #tmpKonAtr TM ON OA.OAT_PrcId = TM.OAT_PrcId&#xD;
        WHERE ATR.ATH_AtkId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Pracownik Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybutyDataOd = @atrybutyDataOd + N', KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + ' Od] AS [Pracownik Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ' Data Od]'         &#xD;
    SET @atrybutyDataDo = @atrybutyDataDo + N', KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + ' Do] AS [Pracownik Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ' Data Do]'         &#xD;
    &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod,@atrybut_Typ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
SELECT PLN_praid,PLN_Rok, sum(PLN_WykorzystaneF) Wykorzystane, PLN_LnbId into #tmpLimityRoczne FROM Cdn.PracLimit group by PLN_praid, PLN_Rok, PLN_LnbId order by pln_praid asc, PLN_ROk asc&#xD;
SELECT TNB_TwpId,TNB_LnbId,TNB_TyuId,TNB_TnkId ,sum(tnb_TYP) as pomocnikGrupowania INTO #tmpLimity FROM CDN.TypNieobec   GROUP BY TNB_TwpId,TNB_LnbId,TNB_TyuId,TNB_TnkId   order by TNB_TwpId asc&#xD;
&#xD;
--Wyliczenie wypłaty&#xD;
SELECT &#xD;
    WPL_WplId [wyplataID],&#xD;
    SUM(CASE WHEN TWP_WchodziDoWyplaty = 1 OR TWP_Rodzajzrodla = 35 OR WPE_Nazwa like 'Przychód PPK dla umów%' THEN&#xD;
            CASE WHEN WPE_Wartosc &lt; 0&#xD;
                THEN 0 &#xD;
                ELSE WPE_Wartosc&#xD;
            END&#xD;
            ELSE 0&#xD;
        END) [brutto],&#xD;
    SUM(CASE WHEN WPE_Nazwa = 'Dni pobytu za granicą (liczba diet)' THEN WPE_Wartosc*WPL_OddelegowanyDieta*WPL_KursLNalDieta/ISNULL(NULLIF(WPL_KursMNalDieta,0),1) ELSE 0 END) [dieta],&#xD;
    SUM(CASE WHEN WPE_Nazwa = 'Podstawa ZUS opodatk. zagr.' or WPE_Nazwa = 'Wyrównanie podstawy ZUS opodatk. zagr.' THEN WPE_Wartosc ELSE 0 END ) [podstawaOpodatkowania]&#xD;
INTO #Wyplaty&#xD;
FROM CDN.PracEtaty &#xD;
    JOIN CDN.Wyplaty ON WPL_PraId = PRE_PraId AND CAST(Pre_DataOd AS Date) &lt;= CAST(GetDate() AS Date) AND CAST(Pre_DataDo AS Date) &gt;= CAST(GetDate() AS Date)&#xD;
    JOIN CDN.WypElementy ON WPE_WplId = WPL_WplId&#xD;
    JOIN CDN.TypWyplata ON WPE_TwpId = TWP_TwpId&#xD;
group by WPL_WplId&#xD;
&#xD;
SELECT *,&#xD;
Gotowka/Suma * 100.0 GotowkaProcent,&#xD;
Ror/Suma * 100.0 RorProcent&#xD;
INTO #ProcentRor from (SELECT BZd_DokumentID,SUM(BZd_KwotaSys) Suma, &#xD;
SUM(CASE WHEN BZd_FPlId = 1 then BZd_KwotaSys else 0 end) as Gotowka,&#xD;
SUM(CASE WHEN BZd_FPlId = 3 then BZd_KwotaSys else 0 end) as Ror &#xD;
FROM CDN.BnkZdarzenia WHERE BZd_DokumentTyp = 8 group by BZd_DokumentID)t&#xD;
--Właściwe zapytanie&#xD;
SET @select =&#xD;
'SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    WPL_NumerPelny [Dokument Numer],&#xD;
    CASE WHEN PRE_ZatrudnionyDo = convert(datetime,''29991231'',112) THEN DATEDIFF(d,PRE_ZatrudnionyOd, GETDATE())+1 ELSE DATEDIFF(d,PRE_ZatrudnionyOd, PRE_ZatrudnionyDo)+1 END [Okres Zatrudnienia w Dniach],&#xD;
    PRE_Kod [Pracownik Kod],&#xD;
    PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
    CASE WHEN PRE_ETARodzajUmowy = '''' THEN ''(NIEPRZYPISANE)'' ELSE PRE_ETARodzajUmowy END [Rodzaj Umowy], &#xD;
    CASE WHEN PRI_Archiwalny = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Archiwalny],&#xD;
    CASE WHEN pr1.PRI_Typ = 1 THEN ''Pracownik'' ELSE ''Własciciel/Współpracownik'' END [Pracownik Typ],&#xD;
    PrWymiar [Pracownik Etat],&#xD;
    CASE &#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 10 THEN ''Etat'' &#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 20 THEN ''Umowa''&#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 30 THEN ''Etat/Umowa''&#xD;
        ELSE ''Bez Zatrudnienia'' END [Typ Zatrudnienia], &#xD;
    CASE WHEN sta.DKM_Nazwa IS NULL THEN ''(NIEPRZYPISANE)'' ELSE sta.DKM_Nazwa END [Pracownik Stanowisko], &#xD;
    CASE WHEN zwo.DKM_Nazwa IS NULL THEN ''(NIEPRZYPISANE)'' ELSE zwo.DKM_Nazwa END [Pracownik Przyczyna Zwolnienia], &#xD;
    isnull(ZakPracownik.Zak_Symbol,''(NIEPRZYPISANY)'') as [Pracownik Zakład Symbol],&#xD;
    isnull(ZakPracownik.Zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Pracownik Zakład Nazwa Firmy],&#xD;
    isnull(ZakListPlac.Zak_Symbol,''(NIEPRZYPISANY)'') as [Wypłata Zakład Symbol],&#xD;
    isnull(ZakListPlac.Zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Wypłata Zakład Nazwa Firmy],&#xD;
    CNT_Kod [Centrum Kod],&#xD;
    CNT_Nazwa [Centrum Nazwa],&#xD;
&#xD;
    CAST(ISNULL(NULLIF(CAST(PRE_KodZawoduSymbol AS VARCHAR(15)),''''),''(NIEPRZYPISANY)'')AS Varchar(15)) [Kod Zawodu],&#xD;
    ISNULL(KZIS_Nazwa,''(NIEPRZYPISANY)'') AS [Kod Zawodu Nazwa],&#xD;
    ISNULL(PRE_StNiepelnosp,''(NIEPRZYPISANY)'') [Kod Stopnia Niepełnosprawności],&#xD;
    ISNULL(PRE_PrawoER,''(NIEPRZYPISANY)'') [Kod Prawa Do Emerytury/Renty],&#xD;
    CASE WHEN u2.TYU_TyUb4 IS NOT NULL  THEN u2.TYU_TyUb4&#xD;
    WHEN u1.TYU_TyUb4 IS NULL THEN ''(NIEPRZYPISANY)''&#xD;
    ELSE u1.TYU_TyUb4 END AS [Kod Tytułu Ubezpieczenia],    &#xD;
    CASE PRE_KodWyksztal&#xD;
    WHEN ''11'' THEN ''Wykształcenie niepełne podstawowe''&#xD;
    WHEN ''12'' THEN ''Wykształcenie podstawowe ukończone''&#xD;
    WHEN ''20'' THEN ''Wykształcenie zasadnicze zawodowe''&#xD;
    WHEN ''31'' THEN ''Wykształcenie średnie zawodowe/techniczne''&#xD;
    WHEN ''32'' THEN ''Wykształcenie średnie ogólnokształcące''&#xD;
    WHEN ''40'' THEN ''Wykształcenie policealne''&#xD;
    WHEN ''50'' THEN ''Wykształcenie wyższe (w tym licencjat)''&#xD;
    ELSE ''Brak danych'' END  [Pracownik Wykształcenie],&#xD;
&#xD;
    CASE WHEN WPS_RodzajZrodla=4 THEN ''Tak'' ELSE ''Nie'' END [Element z Listy Dodatków],&#xD;
    CASE TWP_AlgPotracenie WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Element Wypłaty Potrącenie],&#xD;
&#xD;
    DATEDIFF(hour, ''18991230'',WPS_OkresCzas)  [Element Wypłaty Liczba Godzin],&#xD;
    WPS_OkresDni [Element Wypłaty Liczba Dni],&#xD;
&#xD;
    CASE &#xD;
        WHEN PRE_ETARodzajZatrudnienia = 0 THEN ''Pracownik''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 1 THEN ''Właściciel''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 2 THEN ''Osoba współpracująca''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 4 THEN ''Uczeń I klasa''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 5 THEN ''Uczeń II klasa''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 6 THEN ''Uczeń III klasa''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 7 THEN ''Młodociany''&#xD;
    ELSE ''(NIEPRZYPISANE)'' END [Rodzaj Zatrudnienia], PRE_Kod [Liczba Pracowników],       &#xD;
    LPL_NumerPelny [Lista Płac],&#xD;
    DZL_Kod [Wydział z Wypłaty], Lok_Kod [Lokalizacja], DZL_AdresWezla [Wydział Adres Węzła], TWP_Nazwa [Element Wypłaty Typ], WPE_Nazwa [Element Wypłaty Nazwa],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') AS [Kategoria Szegółowa z Elementu], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') AS [Kategoria Szegółowa z Nagłówka], &#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') AS [Kategoria Ogólna z Elementu], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') AS [Kategoria Ogólna z Nagłówka], &#xD;
    CASE WHEN TWP_WchodziDoWyplaty = 0 AND TWP_OpisAnalitCzasPracy = 0&#xD;
        THEN ''NIE'' &#xD;
        ELSE ''TAK'' &#xD;
    END [Element Wypłaty Wpływ na Kwotę],&#xD;
 CASE WHEN TWP_RodzajFIS = 1&#xD;
        THEN ''NIE'' &#xD;
	WHEN TWP_RodzajFIS = 2 AND WPE_Wartosc = WPE_SwiadZwol&#xD;
	THEN ''NIE''&#xD;
	WHEN TWP_RodzajFIS = 2 AND WPE_Wartosc &lt;&gt; WPE_SwiadZwol&#xD;
	THEN ''TAK''&#xD;
        ELSE ''TAK'' &#xD;
    END [Element Wypłaty Opodatkowany],    &#xD;
/*  &#xD;
CASE WHEN TWP_WchodziDoWyplaty = 1 OR TWP_Rodzajzrodla = 35 OR WPE_Nazwa like ''Przychód PPK dla umów%'' THEN&#xD;
        CASE WHEN PRE_Oddelegowany = 0 THEN CASE WHEN TWP_Rodzajzrodla = 35 OR WPE_Nazwa like ''Przychód PPK dla umów%'' THEN 0 ELSE WPE_Wartosc END - WPE_SklEmerPrac-WPE_SklRentPrac-WPE_SklChorPrac-WPE_SklWypadPrac-WPE_ZalFis-WPE_SklZdrowPrac-WPE_SklZdrowSuma-WPE_SklPPKPrac1-WPE_SklPPKPrac2 ELSE&#xD;
            CASE WHEN TWP_RodzajZrodla IN (1, 14) THEN &#xD;
                CASE WHEN brutto - WPLE.dieta &lt; WPLE.podstawaOpodatkowania THEN&#xD;
                    WPE_Wartosc - (WPLE.podstawaOpodatkowania - WPLE.podstawaOpodatkowania*0.1371)*0.09 - WPLE.podstawaOpodatkowania*0.1371&#xD;
                ELSE&#xD;
                    WPE_Wartosc - (WPLE.brutto - WPLE.dieta - (WPLE.brutto - WPLE.dieta)*0.1371)*0.09 - (WPLE.brutto - WPLE.dieta)*0.1371&#xD;
                END ELSE WPE_Wartosc &#xD;
            END&#xD;
        END ELSE 0&#xD;
    END [Wypłata Wartość Netto],&#xD;
    CASE WHEN TWP_WchodziDoWyplaty = 1 OR TWP_Rodzajzrodla = 35 OR WPE_Nazwa like ''Przychód PPK dla umów%'' THEN WPE_Wartosc&#xD;
    ELSE 0 END [Suma Elementów Wypłaty],&#xD;
*/&#xD;
    CASE WHEN TWP_WchodziDoWyplaty = 1 THEN&#xD;
        WPE_Wartosc - WPE_SklEmerPrac-WPE_SklRentPrac-WPE_SklChorPrac-WPE_SklWypadPrac-WPE_ZalFis-WPE_SklZdrowPrac-WPE_SklZdrowSuma-WPE_SklPPKPrac1-WPE_SklPPKPrac2 &#xD;
    ELSE - WPE_SklEmerPrac-WPE_SklRentPrac-WPE_SklChorPrac-WPE_SklWypadPrac-WPE_ZalFis-WPE_SklZdrowPrac-WPE_SklZdrowSuma-WPE_SklPPKPrac1-WPE_SklPPKPrac2&#xD;
    END &#xD;
    [Wypłata Wartość Netto],&#xD;
&#xD;
    CASE WHEN PRE_Oddelegowany = 1 AND TWP_WchodziDoWyplaty = 0 THEN 0 ELSE&#xD;
    WPE_Wartosc &#xD;
    END [Suma Elementów Wypłaty],&#xD;
&#xD;
    CASE WHEN TWP_RodzajZrodla &lt;&gt; 1 or TWP_WchodziDoWyplaty = 0 THEN 0 ELSE WPE_Wartosc END [Wypłata Wynagrodzenie Zasadnicze],&#xD;
&#xD;
    WPE_SklEmerPrac + WPE_SklRentPrac + WPE_SklChorPrac + WPE_SklWypadPrac [Składka ZUS U], &#xD;
    WPE_SklEmerFirma + WPE_SklRentFirma + WPE_SklChorFirma + WPE_SklWypadFirma + WPE_SklFP + WPE_SklFGSP [Składka ZUS P],&#xD;
    CASE WHEN TWP_Nazwa LIKE ''Zasiłek wych%'' OR TWP_Nazwa LIKE ''Zasiłek mac%'' OR TWP_Nazwa LIKE ''Podwyższenie zasiłku mac%'' THEN NULL ELSE WPE_SklEmerFirma + WPE_SklRentFirma + WPE_SklChorFirma + WPE_SklWypadFirma + WPE_SklFP + WPE_SklFGSP END [Składka ZUS P bez Mac. i Wych.],&#xD;
    WPE_Koszty [Koszty Uzyskania], WPE_ZalFis + WPE_SklZdrowPrac + WPE_SklZdrowSuma [Zal. Podatku z Ubezp. Zdrow.],&#xD;
    WPE_Ulga [Ulga Podatkowa], WPE_ZalFis [Zaliczka Podatku do US], WPE_NalFis [Naliczona Zaliczka Podatku], WPE_PodstEmer [Podstawa Składki Emerytalnej], &#xD;
    WPE_SklEmerPrac [Składka Emerytalna U], WPE_SklEmerFirma [Składka Emerytalna P],    WPE_PodstRent [Podstawa Składki Rentowej],&#xD;
    WPE_SklRentPrac [Składka Rentowa U], WPE_SklRentFirma [Składka Rentowa P], WPE_PodstChor [Podstawa Składki Chorobowej], &#xD;
    WPE_SklChorPrac [Składka Chorobowa U], WPE_SklChorFirma [Składka Chorobowa P], WPE_PodstWypad [Podstawa Składki Wypadkowej],&#xD;
    WPE_SklWypadPrac [Składka Wypadkowa U],WPE_SklWypadFirma [Składka Wypadkowa P], WPE_PodstFP [Podstawa Składki na FP], &#xD;
    WPE_SklFP [Składka na FP], WPE_PodstFGSP [Podstawa Składki na FGŚP], WPE_SklFGSP [Składka na FGŚP], WPE_PodstFEP [Podstawa Składki na FEP],&#xD;
    WPE_SklFEP [Składka na FEP], WPE_PodstZdrow [Podstawa Składki Zdrowotnej], WPE_SklZdrowPrac [Składka Zdrowotna (odl.)],&#xD;
    WPE_SklZdrowSuma [Składka Zdrowotna (od netto)], WPE_SklZdrowPrac + WPE_SklZdrowSuma [Składka Zdrowotna (pob.) U], WPE_SklZdrowFirma [Składka Zdrowotna (pob.) P],&#xD;
    CASE WHEN TWP_Nazwa LIKE ''Zasiłek wych%'' OR TWP_Nazwa LIKE ''Zasiłek mac%'' OR TWP_Nazwa LIKE ''Podwyższenie zasiłku mac%'' THEN NULL ELSE WPE_SklEmerPrac END [Składka Emerytalna U bez Mac. i Wych.], &#xD;
    CASE WHEN TWP_Nazwa LIKE ''Zasiłek wych%'' OR TWP_Nazwa LIKE ''Zasiłek mac%'' OR TWP_Nazwa LIKE ''Podwyższenie zasiłku mac%'' THEN NULL ELSE WPE_SklEmerFirma END [Składka Emerytalna P bez Mac. i Wych.],&#xD;
    CASE WHEN TWP_Nazwa LIKE ''Zasiłek wych%'' OR TWP_Nazwa LIKE ''Zasiłek mac%'' OR TWP_Nazwa LIKE ''Podwyższenie zasiłku mac%'' THEN NULL ELSE WPE_SklRentPrac END [Składka Rentowa U bez Mac. i Wych.],&#xD;
    CASE WHEN TWP_Nazwa LIKE ''Zasiłek wych%'' OR TWP_Nazwa LIKE ''Zasiłek mac%'' OR TWP_Nazwa LIKE ''Podwyższenie zasiłku mac%'' THEN NULL ELSE WPE_SklRentFirma END [Składka Rentowa P bez Mac. i Wych.]&#xD;
    ,WEP_KWOTa2 [Stawka Wyliczona ze Składników Zmiennych], -- dla elementu wypłaty "Wynagrodzenie za czas urlopu"&#xD;
    --wg Barbary Maciołek z optimy,liczac koszty na pewno wyłączyć składki zapisane w elementach wypłaty mających kod ubezpieczenia (WPE_TyUb) 1211xx, 1240xx (gdzie te dwa ostanie znaki xx to dowolne dwie cyfry),&#xD;
    -- bo są finansowane przez budżet państwa, i być może dla kodów 05xxxx (zapisywane w wypłacie jako liczba 5 cyfrowa zaczynająca się od 5), bo to są wypłaty właścicieli i osób z nimi współpracujących, których składki są finansowane przez właściciela&#xD;
    CASE WHEN SUBSTRING(CAST(WPE_TyUb as nvarchar), 1,4) = ''1211'' OR SUBSTRING(CAST(WPE_TyUb as nvarchar), 1,4) = ''1240''  THEN 0 &#xD;
	when 	TWP_PdzId IN (332,334,336,311,312,313,314,212,214,215,216,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329) THEN 0&#xD;
	ELSE  IIF(TWP_KosztFirma = 1, WPE_Wartosc, 0)  + WPE_SklEmerFirma + WPE_SklRentFirma +  WPE_SklWypadFirma + WPE_SklFP + WPE_SklFGSP + WPE_SklFEP  END [Całkowity Koszt Zatrudnienia Pracownika],&#xD;
    case when zestaw.PZE_czasWolne is not null then  (DATEDIFF(hour, ''18991230'', zestaw.PZE_czasWolne)) &#xD;
    WHEN pzepraid IS NOT NULL THEN czasWolne else null end  as [Zestawienia Czas Wolny godziny], &#xD;
    case when zestaw.PZE_Nadgodziny50 is not null then  (DATEDIFF(hour, ''18991230'', zestaw.PZE_Nadgodziny50)) &#xD;
    WHEN pzepraid IS NOT NULL THEN Nadgodziny50 else null end  as [Zestawienia Nadgodziny 50 godziny],&#xD;
    case when zestaw.PZE_Nadgodziny100 is not null then  (DATEDIFF(hour, ''18991230'', zestaw.PZE_Nadgodziny100)) &#xD;
    WHEN pzepraid IS NOT NULL THEN Nadgodziny100 else null end  as [Zestawienia Nadgodziny 100 godziny],&#xD;
    case when zestaw.PZE_NadgodzinySW is not null then  (DATEDIFF(hour, ''18991230'', zestaw.PZE_NadgodzinySW)) &#xD;
    WHEN pzepraid IS NOT NULL THEN NadgodzinySW else null end  as [Zestawienia Nadgodziny Święta godziny],&#xD;
    case when zestaw.PZE_CzasSW is not null then  (DATEDIFF(hour, ''18991230'', zestaw.PZE_CzasSW)) &#xD;
    WHEN pzepraid IS NOT NULL THEN PZE_CzasSW else null end  as [Zestawienia Czas Święta godziny]&#xD;
    ,WPE_PodstPPK [Podstawa Składki PPK]&#xD;
    ,WPE_SklPPKPrac1 [Składka PPK Podstawowa U]&#xD;
    ,WPE_SklPPKPrac2 [Składka PPK Dodatkowa U]&#xD;
    ,WPE_SklPPKFirma1 [Składka PPK Podstawowa P]&#xD;
    ,WPE_SklPPKFirma2 [Składka PPK Dodatkowa P]&#xD;
    ,CASE WHEN (LPL_DekID is null and LPL_KPRID is null and LPL_PreDekID is null) THEN ''NIE'' ELSE ''TAK'' END [Lista Płac Zaksięgowana]&#xD;
    ,lpl.DDF_Symbol [Lista Płac Typ]&#xD;
    ,CASE WHEN PRE_ETAMinimalna = 0 THEN Cast(PRE_EtaStawka as varchar) ELSE CFW_Wartosc END [Pracownik Stawka]&#xD;
    ,CASE rob.DKM_Robotnicze WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Stanowisko Robotnicze]&#xD;
    ,CASE WHEN PRE_ZatrudnionyOd = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE CASE WHEN PRE_ZatrudnionyDo &gt; GetDate() THEN CASE WHEN datediff(yy,PRE_ZatrudnionyOd,GetDate()) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PRE_ZatrudnionyOd,GetDate()) AS VARCHAR(10)),''(BRAK)'') END ELSE CASE WHEN datediff(yy,PRE_ZatrudnionyOd,PRE_ZatrudnionyDo) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PRE_ZatrudnionyOd,PRE_ZatrudnionyDo) AS VARCHAR(10)),''(BRAK)'') END END END [Pracownik Lata Pracy]&#xD;
    ,ISNULL(CAST (datediff(yy,PRE_DataUr,GetDate()) AS VARCHAR(10)),''(BRAK)'') [Pracownik Wiek]&#xD;
    ,ISNULL(NULLIF(PRE_Pesel, ''''), ''(BRAK)'') [Pracownik PESEL]&#xD;
    ,CASE PRE_Plec &#xD;
        WHEN ''K'' THEN ''Kobieta''&#xD;
        WHEN ''M'' THEN ''Mężczyzna''&#xD;
        ELSE ''(BRAK)''&#xD;
    END [Pracownik Płeć]&#xD;
    ,CASE PRE_Plec&#xD;
        WHEN ''K'' THEN&#xD;
            CASE&#xD;
                WHEN CAST(datediff(yy,PRE_DataUr,GetDate()) AS INT) &gt;= 56 THEN ''Tak''&#xD;
                WHEN CAST(datediff(yy,PRE_DataUr,GetDate()) AS INT) &lt; 56 THEN ''Nie''&#xD;
                ELSE ''(BRAK)''&#xD;
            END&#xD;
        WHEN ''M'' THEN &#xD;
            CASE&#xD;
                WHEN CAST(datediff(yy,PRE_DataUr,GetDate()) AS INT) &gt;= 61 THEN ''Tak'' &#xD;
                WHEN CAST(datediff(yy,PRE_DataUr,GetDate()) AS INT) &lt; 61 THEN ''Nie''&#xD;
                ELSE ''(BRAK)''&#xD;
            END&#xD;
        ELSE ''(BRAK)''&#xD;
    END [Pracownik Wiek Przedemerytalny]&#xD;
    ,CASE WHEN PRE_ZatrudnionyDo = convert(datetime,''29991231'',112) THEN&#xD;
        CASE WHEN DATEDIFF(year,PRE_ZatrudnionyOd, GETDATE()) % 5 = 0 AND DATEDIFF(year,PRE_ZatrudnionyOd, GETDATE()) &gt;= 5&#xD;
            THEN CAST(DATEDIFF(year,PRE_ZatrudnionyOd, GETDATE()) AS VARCHAR(3))&#xD;
            ELSE ''(BRAK)''&#xD;
        END&#xD;
    ELSE&#xD;
        CASE WHEN DATEDIFF(year,PRE_ZatrudnionyOd, PRE_ZatrudnionyDo) % 5 = 0 AND DATEDIFF(year,PRE_ZatrudnionyOd, PRE_ZatrudnionyDo) &gt;= 5&#xD;
            THEN CAST(DATEDIFF(year,PRE_ZatrudnionyOd, PRE_ZatrudnionyDo) AS VARCHAR(3))&#xD;
            ELSE ''(BRAK)''&#xD;
        END&#xD;
    END [Pracownik Jubileusz]&#xD;
    ,ISNULL(NULLIF(PRE_RachunekNr, ''''), ''(BRAK)'') [Pracownik Nr Konta Bankowego]&#xD;
    ,ISNULL(NULLIF(PRE_Obywatelstwo, ''''), ''(BRAK)'') [Pracownik Obywatelstwo]&#xD;
    ,''ul. '' + ISNULL(NULLIF(PRE_MLDUlica, ''''), ''(BRAK)'')&#xD;
        + '' '' + ISNULL(NULLIF(PRE_MLDNrDomu, ''''), ''(BRAK)'')&#xD;
        + CASE WHEN NULLIF(PRE_MLDNrLokalu, '''') IS NULL THEN '''' ELSE ''/'' + PRE_MLDNrLokalu END&#xD;
        + '', '' + ISNULL(NULLIF(PRE_MLDKodPocztowy, ''''), ''(BRAK)'')&#xD;
        + '' '' +  ISNULL(NULLIF(PRE_MLDMiasto, ''''), ''(BRAK)'') [Pracownik Dane Adresowe]&#xD;
    ,ISNULL(NULLIF(PRE_HDKPrawoJazdyKat, ''''), ''(BRAK)'') [Pracownik Kategoria Prawa Jazdy]&#xD;
    ,CASE WHEN PRE_HDKPrawoJazdy = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Prawo Jazdy]&#xD;
    ,ISNULL(NULLIF(PRE_Opis, ''''), ''(BRAK)'') [Pracownik Opis]&#xD;
    ,ISNULL(NULLIF(PRE_HDKEmail, ''''), ''(BRAK)'') [Pracownik Dane Kontaktowe E-mail]&#xD;
    ,ISNULL(NULLIF(PRE_HDKTelefon1, ''''), ''(BRAK)'') [Pracownik Dane Kontaktowe Telefon]&#xD;
    ,ISNULL(NULLIF(PRE_NipE, ''''), ''(BRAK)'') [Pracownik NIP]&#xD;
    ,CASE PRE_PODKosztyTytul&#xD;
        WHEN 0 THEN ''(BRAK)''&#xD;
        WHEN 1 THEN ''Z jednego stosunku pracy''&#xD;
        WHEN 2 THEN ''Z więcej niż jednego stosunku pracy''&#xD;
        WHEN 3 THEN ''Z jednego stosunku pracy, podwyższone o 25%''&#xD;
        WHEN 4 THEN ''Z więcej niż jednego stosunku pracy, podwyższone o 25%''&#xD;
        WHEN 5 THEN ''Na podstawie wydatków faktycznie poniesionych''&#xD;
    END [Pracownik Koszty Uzyskania z Tytułu]&#xD;
    ,ISNULL(NULLIF(PRE_ETAMiejsce, ''''), ''(BRAK)'') [Pracownik Miejsce Pracy]&#xD;
    ,CASE PRE_ETAWymiar&#xD;
        WHEN 1 THEN ''Stawka miesięczna''&#xD;
        WHEN 2 THEN ''Stawka godzinowa''&#xD;
    END [Pracownik Rodzaj Stawki]&#xD;
    ,ISNULL(NULLIF(CONVERT(VARCHAR, PRE_KodKasyChorych), ''''), ''(BRAK)'') [Pracownik Kod NFZ]&#xD;
    ,CASE WHEN PRE_UBZJestEmerytal = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Ubezpieczenie Emerytalne]&#xD;
    ,CASE WHEN PRE_UBZJestRentowe = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Ubezpieczenie Rentowe]&#xD;
    ,CASE WHEN PRE_UBZJestChorobowe = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Ubezpieczenie Chorobowe]&#xD;
    ,CASE WHEN PRE_UBZJestWypad = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Ubezpieczenie Wypadkowe]&#xD;
    ,ISNULL(NULLIF(PRE_WarSzczegolne, ''''), ''(BRAK)'') [Pracownik Ubezpieczenie Kod Pracy w Warunkach Szczególnych]&#xD;
    ,CASE WHEN ISNULL(PRE_PrzekroczInformacja, 0) = 0 THEN ''Nie'' ELSE ''Tak'' END [Pracownik Ubezpieczenie Przekroczenie Podstawy Składek]&#xD;
    ,CASE WHEN PRE_HDKGUSGlowneMiejscePracy = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik GUS Główne Miejsce Pracy]&#xD;
    ,CASE WHEN PRE_HDKGUSPierwszaPraca = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik GUS Pierwsza Praca]&#xD;
    ,CASE WHEN PRE_HDKGUSPoraNocna = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik GUS Praca w Porze Nocnej]&#xD;
    ,CASE WHEN PRE_HDKGUSPracSezonowy = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik GUS Pracownik Sezonowy]&#xD;
    ,ISNULL(NULLIF(UMW_NumerPelny, ''''), ''(BRAK)'') [Umowa Numer],&#xD;
    WPE_SklEmerPrac + WPE_SklRentPrac + WPE_SklChorPrac + WPE_SklWypadPrac [Suma składek ZUS],&#xD;
    Case when (WPE_SklEmerPracOpodat + WPE_SklRentPracOpodat + WPE_SklChorPracOpodat) = 0 then WPE_SklEmerPrac + WPE_SklRentPrac + WPE_SklChorPrac + WPE_SklWypadPrac&#xD;
    ELSE (WPE_SklEmerPrac + WPE_SklRentPrac + WPE_SklChorPrac + WPE_SklWypadPrac)-((WPE_SklEmerPrac + WPE_SklRentPrac + WPE_SklChorPrac + WPE_SklWypadPrac)-(WPE_SklEmerPracOpodat + WPE_SklRentPracOpodat + WPE_SklChorPracOpodat)) END AS [Składki ZUS podlegające odliczeniu od podstawy opodatkowania]&#xD;
    ,WPS_Nazwa as [Składnik Wypłaty Nazwa]&#xD;
    ,WPS_Wartosc as [Składnik Wypłaty Wartość]&#xD;
    ,Datediff(hh,''1899-12-30 00:00:00.000'',WPS_OkresCzas) [Składnik Wypłaty Godziny]&#xD;
    ,WPL_ProcentPodat1 AS [Procent Podatku]&#xD;
    ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
    ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
    ,Case when TWP_Wskaznik = 1 then ''TAK'' ELSE ''NIE'' end as [Typ Wypłaty Wskaźnik]&#xD;
	,GotowkaProcent [Procent Wypłaty Gotówka]&#xD;
    ,RorProcent [Procent Wypłaty ROR]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), LPL_DataDok, 111), ''/'', ''-'') [Data]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), PRE_DataUr, 111), ''/'', ''-'') [Data Urodzenia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), WPL_DataOd, 111), ''/'', ''-'') [Data Od Wypłaty]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), WPL_Datado, 111), ''/'', ''-'') [Data Do Wypłaty]&#xD;
    ,CONVERT(VARCHAR(4), WPL_Rok) + ''-'' + RIGHT(''0'' + CONVERT(VARCHAR(2), WPL_Miesiac), 2) + ''-01'' [Data Deklaracji]&#xD;
    ,CASE WHEN PrBad &lt; PRE_ZatrudnionyOd THEN NULL ELSE REPLACE(CONVERT(VARCHAR(10), PrBad, 111), ''/'', ''-'') END [Data Ważności Badań]&#xD;
    ,CASE WHEN PRE_ZatrudnionyOd = convert(datetime,''18991230'',112) THEN NULL ELSE REPLACE(CONVERT(VARCHAR(10), PRE_ZatrudnionyOd, 111), ''/'', ''-'') END [Data Zatrudnienia]&#xD;
    ,CASE WHEN PRE_ZatrudnionyDo = convert(datetime,''29991231'',112) THEN NULL WHEN PRE_ZatrudnionyDo = convert(datetime,''18991230'',112) THEN NULL ELSE REPLACE(CONVERT(VARCHAR(10), PRE_ZatrudnionyDo, 111), ''/'', ''-'') END [Data Zwolnienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), UMW_DataOd, 111), ''/'', ''-'') [Data Rozpoczęcia Umowy]&#xD;
    ,CASE WHEN UMW_DataDo = convert(datetime,''29991231'',112) THEN NULL ELSE REPLACE(CONVERT(VARCHAR(10), UMW_DataDo, 111), ''/'', ''-'') END [Data Zakończenia Umowy]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), PRE_PPKOkresOd, 111), ''/'', ''-'') [Data Przystąpienia do PPK]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), PRE_PPKOkresDo, 111), ''/'', ''-'') [Data Rezygnacji z PPK]&#xD;
    */&#xD;
    &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), LPL_DataDok, 111), ''/'', ''-'') [Data Wypłaty Dzień]&#xD;
    ,MONTH(LPL_DataDok) [Data Wypłaty Miesiąc]&#xD;
    ,(datepart(DY, datediff(d, 0, LPL_DataDok) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, LPL_DataDok)*/ [Data Wypłaty Tydzień Roku]&#xD;
    ,DATEPART(quarter, LPL_DataDok) AS [Data Wypłaty Kwartał], YEAR(LPL_DataDok) [Data Wypłaty Rok]&#xD;
&#xD;
        ,REPLACE(CONVERT(VARCHAR(10), WPL_DataOd, 111), ''/'', ''-'') [Data Od Wypłaty Dzień]&#xD;
    ,MONTH(WPL_DataOd) [Data Od Wypłaty Miesiąc]&#xD;
    ,(datepart(DY, datediff(d, 0, WPL_DataOd) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, WPL_DataOd)*/ [Data Od Wypłaty Tydzień Roku]&#xD;
    ,DATEPART(quarter, WPL_DataOd) AS [Data Od Wypłaty Kwartał], YEAR(WPL_DataOd) [Data Od Wypłaty Rok]&#xD;
&#xD;
        ,REPLACE(CONVERT(VARCHAR(10), WPL_Datado, 111), ''/'', ''-'') [Data Do Wypłaty Dzień]&#xD;
    ,MONTH(WPL_Datado) [Data Do Wypłaty Miesiąc]&#xD;
    ,(datepart(DY, datediff(d, 0, WPL_Datado) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, WPL_Datado)*/ [Data Do Wypłaty Tydzień Roku]&#xD;
    ,DATEPART(quarter, WPL_Datado) AS [Data Do Wypłaty Kwartał], YEAR(WPL_Datado) [Data Do Wypłaty Rok]&#xD;
&#xD;
    ,WPL_Rok [Data Rok Deklaracji]&#xD;
    ,WPL_Miesiac [Data Miesiąc Deklaracji]&#xD;
    ,CASE WHEN PrBad &lt; PRE_ZatrudnionyOd THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PrBad) AS VARCHAR(10)),''(BRAK)'') END [Data Ważności Badań Miesiąc]&#xD;
    ,CASE WHEN PrBad &lt; PRE_ZatrudnionyOd THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PrBad) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PrBad)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Ważności Badań Tydzień Roku]&#xD;
    ,CASE WHEN PrBad &lt; PRE_ZatrudnionyOd THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PrBad) AS VARCHAR(10)),''(BRAK)'') END [Data Ważności Badań Kwartał]&#xD;
    ,CASE WHEN PrBad &lt; PRE_ZatrudnionyOd THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PrBad) AS VARCHAR(10)),''(BRAK)'') END [Data Ważności Badań Rok]&#xD;
    ,CASE WHEN PRE_ZatrudnionyOd = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PRE_ZatrudnionyOd, 111), ''/'', ''-''),''(BRAK)'') END [Data Zatrudnienia Dzień]&#xD;
    ,CASE WHEN PRE_ZatrudnionyOd = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PRE_ZatrudnionyOd) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Miesiąc]&#xD;
    ,CASE WHEN PRE_ZatrudnionyOd = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PRE_ZatrudnionyOd) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PRE_ZatrudnionyOd)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Tydzień Roku] &#xD;
    ,CASE WHEN PRE_ZatrudnionyOd = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PRE_ZatrudnionyOd) AS VARCHAR(10)),''(BRAK)'') END AS [Data Zatrudnienia Kwartał]&#xD;
    ,CASE WHEN PRE_ZatrudnionyOd = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PRE_ZatrudnionyOd) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Rok] &#xD;
    ,CASE WHEN PRE_ZatrudnionyDo = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PRE_ZatrudnionyDo = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PRE_ZatrudnionyDo, 111), ''/'', ''-''),''(BRAK)'') END [Data Zwolnienia Dzień]&#xD;
    ,CASE WHEN PRE_ZatrudnionyDo = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PRE_ZatrudnionyDo = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PRE_ZatrudnionyDo) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Miesiąc]&#xD;
    ,CASE WHEN PRE_ZatrudnionyDo = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PRE_ZatrudnionyDo = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PRE_ZatrudnionyDo) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PRE_ZatrudnionyDo)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Tydzień Roku]&#xD;
    ,CASE WHEN PRE_ZatrudnionyDo = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PRE_ZatrudnionyDo = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PRE_ZatrudnionyDo) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Kwartał]&#xD;
    ,CASE WHEN PRE_ZatrudnionyDo = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PRE_ZatrudnionyDo = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PRE_ZatrudnionyDo) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Rok]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
    ----------KONTEKSTY&#xD;
    ,24020 [Dokument Numer __PROCID__], WPL_WplId [Dokument Numer __ORGID__], '''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
    ,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__] &#xD;
    &#xD;
    ' + @kolumny + @atrybuty + @atrybutyDataOd + @atrybutyDataDo + '&#xD;
&#xD;
 FROM CDN.WypElementy&#xD;
    JOIN CDN.Wyplaty ON WPE_WplId = WPL_WplId&#xD;
    JOIN #Wyplaty WPLE On WPE_WplId = wyplataID&#xD;
    JOIN CDN.ListyPlac ON WPL_LplId = LPL_LplId &#xD;
    JOIN (SELECT * FROM (SELECT PRE.*, WPL_WplId Wpl, ROW_NUMBER() OVER(PARTITION BY WPL_WplID ORDER BY PRE_PreId DESC) as row&#xD;
        FROM CDN.Wyplaty WPL&#xD;
        JOIN CDN.PracEtaty PRE ON WPL_PraId = PRE_PraId &#xD;
            AND CAST(Pre_DataOd AS Date) &lt;= CAST(WPL_DataDo AS Date) &#xD;
            AND CAST(Pre_DataDo AS Date) &gt;= CAST(WPL_DataOd AS Date)) s WHERE row = 1) PRE ON WPL_WplId = Wpl AND CAST(Pre_DataOd AS Date) &lt;= CAST(WPL_DataDo AS Date) AND CAST(Pre_DataDo AS Date) &gt;= CAST(WPL_DataOd AS Date)&#xD;
    JOIN CDN.Pracidx pr1 ON PRE_PraId = pr1.PRI_PraId AND pr1.PRI_Typ &lt; 10&#xD;
    JOIN CDN.Dzialy ON WPL_DzlId = DZL_DzlId &#xD;
    JOIN CDN.Lokalizacje ON DZL_LokId = Lok_LokId&#xD;
    JOIN CDN.TypWyplata ON WPE_TwpId = TWP_TwpId&#xD;
    LEFT JOIN CDN.WypSkladniki ON WPE_WpeId = WPS_WpeId and PRE_PraId = WPS_PraId and TWP_TwpId = WPS_TwpId&#xD;
    LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko = sta.DKM_DkmId AND sta.DKM_Rodzaj = 1&#xD;
    LEFT JOIN CDN.DaneKadMod zwo ON PRE_ETADkmIdWypowPowod = zwo.DKM_DkmId AND zwo.DKM_Rodzaj = 3&#xD;
    LEFT JOIN CDN.Kategorie kat1 ON WPE_KatId = kat1.Kat_KatID&#xD;
    LEFT JOIN CDN.Kategorie kat2 ON WPL_KatId = kat2.Kat_KatID&#xD;
    LEFT JOIN CDN.PracZestaw zestaw ON zestaw.PZE_praid = wpl_praid AND wpl_dataod = zestaw.PZE_okresod AND wpl_datado = zestaw.PZE_okresdo AND wpe_twpid = 1 &#xD;
    LEFT JOIN ( select &#xD;
    SUM((DATEDIFF(hour, ''18991230'', PZE_czasWolne))) czasWolne&#xD;
    ,SUM((DATEDIFF(hour, ''18991230'', PZE_Nadgodziny50))) Nadgodziny50&#xD;
    ,SUM((DATEDIFF(hour, ''18991230'', PZE_Nadgodziny100))) Nadgodziny100&#xD;
    ,SUM((DATEDIFF(hour, ''18991230'', PZE_NadgodzinySW))) NadgodzinySW&#xD;
    ,SUM((DATEDIFF(hour, ''18991230'', PZE_CzasSW))) CzasSW&#xD;
     ,PZE_praid pzepraid&#xD;
     ,MONTH(PZE_okresod) okresodM,YEAR(PZE_okresod) okresodY&#xD;
     ,MONTH(PZE_okresdo) okresDoM,YEAR(PZE_okresdo) okresDoY&#xD;
     from cdn.PracZestaw &#xD;
    GROUP BY PZE_praid  ,MONTH(PZE_okresod),YEAR(PZE_okresod)&#xD;
     ,MONTH(PZE_okresdo),YEAR(PZE_okresdo)&#xD;
    )ZestGrp ON PZE_PzeID IS NULL AND  wpl_praid = pzepraid AND MONTH(wpl_dataod) = okresodM AND MONTH(wpl_datado) = okresDoM &#xD;
    AND YEAR(wpl_dataod) = okresodY AND YEAR(wpl_datado) = okresDoY&#xD;
    AND wpe_twpid = 1 &#xD;
    LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
    LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
    LEFT JOIN CDN.Zaklady ZakListPlac ON ZAkListPlac.ZAK_ZAkID = LPL_ZakId&#xD;
    LEFT JOIN CDN.Zaklady ZakPracownik ON ZakPracownik.ZAK_ZAkID = PRE_ZakId&#xD;
    LEFT JOIN CDN.WypElementyPodstawa ON WEP_WpeId = WPE_WpeId AND WPE_TwpID = 70&#xD;
    LEFT JOIN CDN.TyTUbezp u1 ON u1.TyU_TyUId = PRE_UBZTyuId&#xD;
    LEFT JOIN CDN.Centra ON CNT_CntId = PRE_CntId&#xD;
    LEFT JOIN #tmpetat ON PrId = Pre_PraId&#xD;
    LEFT JOIN cdn.DaneKadMod rob ON PRE_ETADkmIdStanowisko = rob.DKM_DkmId&#xD;
    LEFT JOIN cdn.DokDefinicje lpl ON LPL_DdfId = lpl.DDf_DDfID&#xD;
    LEFT JOIN #tmpUmowy umowy ON WPL_WplId = umowy.UMW_WplId    &#xD;
    LEFT JOIN #tmpLimityRoczne ON PLN_praid = WPL_PraId AND Wykorzystane &lt;&gt; 0 and WPL_Rok = PLN_Rok and pln_lnbid=1&#xD;
    LEFT JOIN #tmpLimity on (TNB_tyuid &lt;&gt; 99999 OR PLN_LnbId=TNB_LnbId) AND  TWP_TwpId = TNB_TwpId &#xD;
    LEFT JOIN CDN.TyTUbezp u2 ON TNB_TyuId = u2.TYU_TyuId &#xD;
    LEFT JOIN '+@bazaKonf+'.CDN.KZIS ON KZIS_Symbol = PRE_KodZawoduSymbol&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON WPL_OpeZalId = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON WPL_OpeModId = mod.Ope_OpeId&#xD;
	LEFT JOIN '+@bazaKonf+'.cdn.CfgKlucze ON LPL_DataDok Between CFK_OkresOd AND CFK_OkresDo  AND CFK_Nazwa = ''Najniższe wynagrodzenie''  &#xD;
	LEFT JOIN  '+@bazaKonf+'.cdn.cfgwartosci on CFW_CfkId=CFK_CfkId&#xD;
	LEFT JOIN #ProcentRor ON wpl_wplid = bzd_dokumentid&#xD;
&#xD;
WHERE&#xD;
    WPL_Tryb &lt;&gt; 1 &#xD;
    AND WPL_Tryb &lt;&gt; 2 &#xD;
'&#xD;
PRINT(@select)&#xD;
EXEC(@select)   &#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpetat&#xD;
DROP TABLE #tmpUmowy&#xD;
DROP TABLE #Wyplaty&#xD;
DROP TABLE #tmpLimityRoczne&#xD;
DROP TABLE #tmpLimity&#xD;
DROP TABLE #ProcentRor&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jzDwJgFJoAzREF9NpiTvD7JPaMMU+LfS6ewgmq9kAP6qcqvE25r7AOePFN3U68zd3f4ZCU/uYVcSX601vEYGiZ7T3be4TMftfLMkcbDZWuSOUcEuJiTAnk9R9Z5uxqTmH</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Okres Zatrudnienia w Dniach" caption="Okres Zatrudnienia w Dniach" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pracownik Kod" caption="Pracownik Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Pracownik Nazwa" caption="Pracownik Nazwa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Rodzaj Umowy" caption="Rodzaj Umowy" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Pracownik Archiwalny" caption="Pracownik Archiwalny" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Pracownik Typ" caption="Pracownik Typ" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Pracownik Etat" caption="Pracownik Etat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Typ Zatrudnienia" caption="Typ Zatrudnienia" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Pracownik Stanowisko" caption="Pracownik Stanowisko" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Pracownik Przyczyna Zwolnienia" caption="Pracownik Przyczyna Zwolnienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Zakład Symbol" caption="Pracownik Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Zakład Nazwa Firmy" caption="Pracownik Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wypłata Zakład Symbol" caption="Wypłata Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wypłata Zakład Nazwa Firmy" caption="Wypłata Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Centrum Kod" caption="Centrum Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Centrum Nazwa" caption="Centrum Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kod Zawodu" caption="Kod Zawodu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kod Zawodu Nazwa" caption="Kod Zawodu Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kod Stopnia Niepełnosprawności" caption="Kod Stopnia Niepełnosprawności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kod Prawa Do Emerytury/Renty" caption="Kod Prawa Do Emerytury/Renty" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kod Tytułu Ubezpieczenia" caption="Kod Tytułu Ubezpieczenia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Wykształcenie" caption="Pracownik Wykształcenie" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Element z Listy Dodatków" caption="Element z Listy Dodatków" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Element Wypłaty Potrącenie" caption="Element Wypłaty Potrącenie" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Element Wypłaty Liczba Godzin" caption="Element Wypłaty Liczba Godzin" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Element Wypłaty Liczba Dni" caption="Element Wypłaty Liczba Dni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rodzaj Zatrudnienia" caption="Rodzaj Zatrudnienia" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Liczba Pracowników" caption="Liczba Pracowników" type="measure" formatString="n0" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Lista Płac" caption="Lista Płac" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Wydział z Wypłaty" caption="Wydział z Wypłaty" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Lokalizacja" caption="Lokalizacja" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Wydział Adres Węzła" caption="Wydział Adres Węzła" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Element Wypłaty Typ" caption="Element Wypłaty Typ" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Element Wypłaty Nazwa" caption="Element Wypłaty Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kategoria Szegółowa z Elementu" caption="Kategoria Szegółowa z Elementu" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Szegółowa z Nagłówka" caption="Kategoria Szegółowa z Nagłówka" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Elementu" caption="Kategoria Ogólna z Elementu" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Element Wypłaty Wpływ na Kwotę" caption="Element Wypłaty Wpływ na Kwotę" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Element Wypłaty Opodatkowany" caption="Element Wypłaty Opodatkowany" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wypłata Wartość Netto" caption="Wypłata Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Suma Elementów Wypłaty" caption="Suma Elementów Wypłaty" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wypłata Wynagrodzenie Zasadnicze" caption="Wypłata Wynagrodzenie Zasadnicze" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka ZUS U" caption="Składka ZUS U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka ZUS P" caption="Składka ZUS P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka ZUS P bez Mac. i Wych." caption="Składka ZUS P bez Mac. i Wych." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszty Uzyskania" caption="Koszty Uzyskania" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zal. Podatku z Ubezp. Zdrow." caption="Zal. Podatku z Ubezp. Zdrow." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ulga Podatkowa" caption="Ulga Podatkowa" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zaliczka Podatku do US" caption="Zaliczka Podatku do US" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Naliczona Zaliczka Podatku" caption="Naliczona Zaliczka Podatku" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki Emerytalnej" caption="Podstawa Składki Emerytalnej" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Emerytalna U" caption="Składka Emerytalna U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Emerytalna P" caption="Składka Emerytalna P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki Rentowej" caption="Podstawa Składki Rentowej" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Rentowa U" caption="Składka Rentowa U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Rentowa P" caption="Składka Rentowa P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki Chorobowej" caption="Podstawa Składki Chorobowej" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Chorobowa U" caption="Składka Chorobowa U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Chorobowa P" caption="Składka Chorobowa P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki Wypadkowej" caption="Podstawa Składki Wypadkowej" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Wypadkowa U" caption="Składka Wypadkowa U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Wypadkowa P" caption="Składka Wypadkowa P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki na FP" caption="Podstawa Składki na FP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka na FP" caption="Składka na FP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki na FGŚP" caption="Podstawa Składki na FGŚP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka na FGŚP" caption="Składka na FGŚP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki na FEP" caption="Podstawa Składki na FEP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka na FEP" caption="Składka na FEP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki Zdrowotnej" caption="Podstawa Składki Zdrowotnej" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Zdrowotna (odl.)" caption="Składka Zdrowotna (odl.)" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Zdrowotna (od netto)" caption="Składka Zdrowotna (od netto)" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Zdrowotna (pob.) U" caption="Składka Zdrowotna (pob.) U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Zdrowotna (pob.) P" caption="Składka Zdrowotna (pob.) P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Emerytalna U bez Mac. i Wych." caption="Składka Emerytalna U bez Mac. i Wych." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Emerytalna P bez Mac. i Wych." caption="Składka Emerytalna P bez Mac. i Wych." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Rentowa U bez Mac. i Wych." caption="Składka Rentowa U bez Mac. i Wych." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Rentowa P bez Mac. i Wych." caption="Składka Rentowa P bez Mac. i Wych." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Stawka Wyliczona ze Składników Zmiennych" caption="Stawka Wyliczona ze Składników Zmiennych" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Całkowity Koszt Zatrudnienia Pracownika" caption="Całkowity Koszt Zatrudnienia Pracownika" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zestawienia Czas Wolny godziny" caption="Zestawienia Czas Wolny godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zestawienia Nadgodziny 50 godziny" caption="Zestawienia Nadgodziny 50 godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zestawienia Nadgodziny 100 godziny" caption="Zestawienia Nadgodziny 100 godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zestawienia Nadgodziny Święta godziny" caption="Zestawienia Nadgodziny Święta godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zestawienia Czas Święta godziny" caption="Zestawienia Czas Święta godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki PPK" caption="Podstawa Składki PPK" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka PPK Podstawowa U" caption="Składka PPK Podstawowa U" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka PPK Dodatkowa U" caption="Składka PPK Dodatkowa U" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka PPK Podstawowa P" caption="Składka PPK Podstawowa P" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka PPK Dodatkowa P" caption="Składka PPK Dodatkowa P" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Lista Płac Zaksięgowana" caption="Lista Płac Zaksięgowana" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Lista Płac Typ" caption="Lista Płac Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Stawka" caption="Pracownik Stawka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Stanowisko Robotnicze" caption="Pracownik Stanowisko Robotnicze" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Lata Pracy" caption="Pracownik Lata Pracy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Wiek" caption="Pracownik Wiek" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik PESEL" caption="Pracownik PESEL" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Płeć" caption="Pracownik Płeć" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Wiek Przedemerytalny" caption="Pracownik Wiek Przedemerytalny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Jubileusz" caption="Pracownik Jubileusz" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Nr Konta Bankowego" caption="Pracownik Nr Konta Bankowego" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Obywatelstwo" caption="Pracownik Obywatelstwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Dane Adresowe" caption="Pracownik Dane Adresowe" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Kategoria Prawa Jazdy" caption="Pracownik Kategoria Prawa Jazdy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Prawo Jazdy" caption="Pracownik Prawo Jazdy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Opis" caption="Pracownik Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Dane Kontaktowe E-mail" caption="Pracownik Dane Kontaktowe E-mail" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Dane Kontaktowe Telefon" caption="Pracownik Dane Kontaktowe Telefon" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik NIP" caption="Pracownik NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Koszty Uzyskania z Tytułu" caption="Pracownik Koszty Uzyskania z Tytułu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Miejsce Pracy" caption="Pracownik Miejsce Pracy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Rodzaj Stawki" caption="Pracownik Rodzaj Stawki" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Kod NFZ" caption="Pracownik Kod NFZ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Ubezpieczenie Emerytalne" caption="Pracownik Ubezpieczenie Emerytalne" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Ubezpieczenie Rentowe" caption="Pracownik Ubezpieczenie Rentowe" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Ubezpieczenie Chorobowe" caption="Pracownik Ubezpieczenie Chorobowe" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Ubezpieczenie Wypadkowe" caption="Pracownik Ubezpieczenie Wypadkowe" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Ubezpieczenie Kod Pracy w Warunkach Szczególnych" caption="Pracownik Ubezpieczenie Kod Pracy w Warunkach Szczególnych" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Ubezpieczenie Przekroczenie Podstawy Składek" caption="Pracownik Ubezpieczenie Przekroczenie Podstawy Składek" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik GUS Główne Miejsce Pracy" caption="Pracownik GUS Główne Miejsce Pracy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik GUS Pierwsza Praca" caption="Pracownik GUS Pierwsza Praca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik GUS Praca w Porze Nocnej" caption="Pracownik GUS Praca w Porze Nocnej" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik GUS Pracownik Sezonowy" caption="Pracownik GUS Pracownik Sezonowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Umowa Numer" caption="Umowa Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Suma składek ZUS" caption="Suma składek ZUS" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składki ZUS podlegające odliczeniu od podstawy opodatkowania" caption="Składki ZUS podlegające odliczeniu od podstawy opodatkowania" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składnik Wypłaty Nazwa" caption="Składnik Wypłaty Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Składnik Wypłaty Wartość" caption="Składnik Wypłaty Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składnik Wypłaty Godziny" caption="Składnik Wypłaty Godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Procent Podatku" caption="Procent Podatku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Typ Wypłaty Wskaźnik" caption="Typ Wypłaty Wskaźnik" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wypłaty Dzień" caption="Data Wypłaty Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wypłaty Miesiąc" caption="Data Wypłaty Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wypłaty Tydzień Roku" caption="Data Wypłaty Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wypłaty Kwartał" caption="Data Wypłaty Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wypłaty Rok" caption="Data Wypłaty Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Od Wypłaty Dzień" caption="Data Od Wypłaty Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Od Wypłaty Miesiąc" caption="Data Od Wypłaty Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Od Wypłaty Tydzień Roku" caption="Data Od Wypłaty Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Od Wypłaty Kwartał" caption="Data Od Wypłaty Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Od Wypłaty Rok" caption="Data Od Wypłaty Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Do Wypłaty Dzień" caption="Data Do Wypłaty Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Do Wypłaty Miesiąc" caption="Data Do Wypłaty Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Do Wypłaty Tydzień Roku" caption="Data Do Wypłaty Tydzień Roku" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Do Wypłaty Kwartał" caption="Data Do Wypłaty Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Do Wypłaty Rok" caption="Data Do Wypłaty Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rok Deklaracji" caption="Data Rok Deklaracji" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Miesiąc Deklaracji" caption="Data Miesiąc Deklaracji" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Ważności Badań Miesiąc" caption="Data Ważności Badań Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ważności Badań Tydzień Roku" caption="Data Ważności Badań Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ważności Badań Kwartał" caption="Data Ważności Badań Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ważności Badań Rok" caption="Data Ważności Badań Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia Dzień" caption="Data Zatrudnienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia Miesiąc" caption="Data Zatrudnienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia Tydzień Roku" caption="Data Zatrudnienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia Kwartał" caption="Data Zatrudnienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia Rok" caption="Data Zatrudnienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia Dzień" caption="Data Zwolnienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia Miesiąc" caption="Data Zwolnienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia Tydzień Roku" caption="Data Zwolnienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia Kwartał" caption="Data Zwolnienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia Rok" caption="Data Zwolnienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy" caption="Data Analizy" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Wydział Poziom 1" caption="Wydział Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Poziom 2" caption="Wydział Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Poziom 3" caption="Wydział Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut test" caption="Pracownik Atrybut test" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut dieta" caption="Pracownik Atrybut dieta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut test Data Od" caption="Pracownik Atrybut test Data Od" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut dieta Data Od" caption="Pracownik Atrybut dieta Data Od" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut test Data Do" caption="Pracownik Atrybut test Data Do" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut dieta Data Do" caption="Pracownik Atrybut dieta Data Do" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="402" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Kadr i Płac wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje na temat wypłat pracowników. Prezentowane są informacje z dokumentów wypłat i list płac. Wartości prezentowane są w walucie systemowej oraz walucie dokumentu.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.Wyplaty - tabela zawierająca wypłaty pracowników &#xD;
CDN.WypElementy - tabela zawierająca elementy wypłat pracowników&#xD;
CDN.PracEtaty - tabela zawierająca szczegółową ewidencję danych kadrowych pracowników</a:description><a:id>9</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>09. Raport Kadr i Płac</a:mainLinkName><a:modifiedOn>2025-04-14T14:16:24.567</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-02-21T11:59:56.097</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Płatności na Dzień &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @atrybuty2 varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
SET @atrybuty2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Podmiot Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybuty2 = @atrybuty2 + N', [Podmiot Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Podmiot Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'  &#xD;
    SET @atrybuty2 = @atrybuty2 + N', [Podmiot Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'       &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max), @atrybutyDok2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE (DAt_TrNId IS NOT NULL) OR (DAt_VaNId IS NOT NULL))&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT * INTO #tmpDokAtr FROM&#xD;
(SELECT DISTINCT DAt_TrNId, 1 as DokTyp FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL&#xD;
UNION&#xD;
SELECT DISTINCT DAt_VanId, 2 as DokTyp FROM CDN.DokAtrybuty WHERE DAt_VanId IS NOT NULL) a&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
SET @atrybutyDok2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON COALESCE(ATR.DAt_TrNId,ATR.DAt_VaNId) = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybutyDok2 = @atrybutyDok2 + N', [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Właściwe zapytanie&#xD;
DECLARE @select VARCHAR(MAX);&#xD;
DECLARE @select2 VARCHAR(MAX);&#xD;
DECLARE @select3 VARCHAR(MAX);&#xD;
DECLARE @select4 VARCHAR(MAX);&#xD;
DECLARE @select5 VARCHAR(MAX);&#xD;
&#xD;
SET @select =' &#xD;
DECLARE @Wal VARCHAR(3); SET @Wal = CDN.Waluta('''')&#xD;
&#xD;
SELECT &#xD;
    --Wymiary&#xD;
    bf [Baza Firmowa], &#xD;
    dokumentNumer [Dokument Numer], &#xD;
    dokumentSymbol [Dokument Symbol],&#xD;
    dokumentNumerPelny [Dokument Numer Pełny], &#xD;
    dokumentOpis [Dokument Opis],&#xD;
    CASE mpp WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Dokument MPP],&#xD;
&#xD;
    nrpon [Dokument Ponaglenia Numer],&#xD;
    datpon [Dokument Ponaglenia Data Wystawienia],&#xD;
&#xD;
    opewkod [Operator Wystawiający Kod],&#xD;
    opewnazwa [Operator Wystawiający Nazwa],&#xD;
    opemkod as [Operator Modyfikujący Kod],&#xD;
    opemnazwa as [Operator Modyfikujący Nazwa], &#xD;
    ds [Dokument Seria],&#xD;
    zapisyZdarzenia [Zapisy/Zdarzenia], waluta [Waluta], fp [Forma Płatności],&#xD;
    kontrahentNazwa [Podmiot Nazwa], &#xD;
    kontrahentKod [Podmiot Kod],&#xD;
    kontrahentLimit [Podmiot Limit],&#xD;
    kontrahentWartośćLimitu [Podmiot Wartość Limitu],&#xD;
    kontrahentTermin [Podmiot Termin],&#xD;
    kontrahentTyp [Podmiot Typ], kontrahentRodzaj [Podmiot Rodzaj], kontrahentStatus [Podmiot Status], kontrahentGrupa [Podmiot Grupa],&#xD;
    kontrahentWojewodztwo [Podmiot Województwo], kontrahentMiasto [Podmiot Miasto],kontrahentKraj [Podmiot Kraj], kontrahentNIP [Podmiot NIP],&#xD;
    kontrahentpierwotnyNazwa [Podmiot Pierwotny Nazwa],     &#xD;
    kontrahentPierwotnyKod [Podmiot Pierwotny Kod], &#xD;
    kontrahentPierwotnyTyp [Podmiot Pierwotny Typ], kontrahentPierwotnyRodzaj [Podmiot Pierwotny Rodzaj], kontrahentPierwotnyStatus [Podmiot Pierwotny Status], kontrahentPierwotnyGrupa [Podmiot Pierwotny Grupa],&#xD;
    kontrahentPierwotnyWojewodztwo [Podmiot Pierwotny Województwo], kontrahentPierwotnyMiasto [Podmiot Pierwotny Miasto],kontrahentPierwotnyKraj [Podmiot Pierwotny Kraj], kontrahentPierwotnyNIP [Podmiot Pierwotny NIP],&#xD;
    kategoriaSzczegolowa [Kategoria Szczegółowa], kategoriaOgolna [Kategoria Ogólna], rachunek [Rejestr], rachAkronim [Rejestr Akronim], rachSymbol [Rejestr Symbol] ,&#xD;
    statusDokumentu [Status Aktualny], &#xD;
    statusDokumentuDzien [Status na Dzień Analizy], &#xD;
    stanDokumentu [Stan Aktualny], &#xD;
    terminZapadalnosci [Termin Zapadalności],&#xD;
    zakladSymbol as [Zakład Symbol],&#xD;
    zakladNazwa as [Zakład Nazwa Firmy], &#xD;
    --Miary&#xD;
    CASE WHEN (liczbaDniPrzeterminowaniaNaleznosci &lt; 0)&#xD;
        THEN 0 &#xD;
        ELSE liczbaDniPrzeterminowaniaNaleznosci&#xD;
    END [Liczba Dni Przeterminowania Należności],&#xD;
    CASE WHEN (liczbaDniPrzeterminowaniaZobowiazania &lt; 0)&#xD;
        THEN 0 &#xD;
        ELSE liczbaDniPrzeterminowaniaZobowiazania&#xD;
    END [Liczba Dni Przeterminowania Zobowiązań],&#xD;
    case when convert(datetime,dataDokumentu, 120)  &lt; convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120) &#xD;
         and convert(datetime,dataDokumentu, 120) &gt; DATEADD(mm, DATEDIFF(m,0,convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)),0) &#xD;
         then naleznosci else null end  [Sprzedaż brutto],&#xD;
    NULLIF(naleznosci,0) [Należności],&#xD;
    NULLIF(zobowiazania,0) [Zobowiązania], &#xD;
    NULLIF(naleznosciWaluta,0) [Należności Waluta], &#xD;
    NULLIF(zobowiazaniaWaluta,0) [Zobowiązania Waluta], &#xD;
    NULLIF(naleznosciNieRozliczone,0) [Należności Nierozliczone], &#xD;
    NULLIF(zobowiazaniaNieRozliczone,0) [Zobowiązania Nierozliczone],&#xD;
    NULLIF(naleznosciNieRozliczoneWaluta,0) [Należności Nierozliczone Waluta], &#xD;
    NULLIF(zobowiazaniaNieRozliczoneWaluta,0) [Zobowiązania Nierozliczone Waluta] ,&#xD;
    czyRozliczony [Rozliczone/Nierozliczone]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,dataDokumentu [Data Dokumentu]&#xD;
    ,dataTerminPlatnosci [Data Termin Płatności]&#xD;
    ,dataRozliczenia [Data Rozliczenia], dataRealizacji [Data Realizacji]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,dataDokumentu [Data Dokumentu Dzień], dataDokumentuMiesiac [Data Dokumentu Miesiąc], dataDokumentuKwartal [Data Dokumentu Kwartał], dataDokumentuRok [Data Dokumentu Rok], dataDokumentuTydzienRoku [Data Dokumentu Tydzień Roku]&#xD;
    ,dataTerminPlatnosci [Data Termin Płatności Dzień], dataTerminPlatnosciMiesiac [Data Termin Płatności Miesiąc], dataTerminPlatnosciKwartal [Data Termin Płatności Kwartał], dataTerminPlatnosciRok [Data Termin Płatności Rok], dataTerminPlatnosciTydzienRoku [Data Termin Płatności Tydzień Roku]&#xD;
    ,dataRozliczenia [Data Rozliczenia Dzień], dataRealizacji [Data Realizacji Dzień] &#xD;
    ,analizaData [Data Analizy]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,dokumentNumer_procid [Dokument Numer __PROCID__Platnosci__], dokumentNumer_orgid [Dokument Numer __ORGID__], '''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,dokumentNumer_procid [Dokument Numer Pełny __PROCID__], dokumentNumer_orgid [Dokument Numer Pełny __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer Pełny __DATABASE__]&#xD;
    ,kon_procid [Podmiot Nazwa __PROCID__], kon_orgid [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__]&#xD;
    ,kon_procid [Podmiot Kod __PROCID__Kontrahenci__], kon_orgid [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__]&#xD;
    ,konPierwotny_procid [Podmiot Pierwotny Nazwa __PROCID__], konPierwotny_orgid [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    ,konPierwotny_procid [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], konPierwotny_orgid [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__]&#xD;
    &#xD;
    ' + @atrybuty2 + @atrybutyDok2 + '&#xD;
FROM ( &#xD;
    SELECT&#xD;
        BAZ.Baz_Nazwa bf, &#xD;
        &#xD;
        BZp_Numer [dokumentNumer], &#xD;
        dokumentNumer_procid = 23008, dokumentNumer_orgid = BZp_BZpID,&#xD;
&#xD;
        nrpon = ''(BRAK)'',&#xD;
        datpon = ''(BRAK)'',&#xD;
&#xD;
        opewkod = ISNULL(ow.Ope_Kod, ''ID:''+CAST(Bzp_OpeZalId as VARCHAR)),&#xD;
        opewnazwa = ISNULL(ow.Ope_Nazwisko, ''ID:''+CAST(Bzp_OpeZalId as VARCHAR)),&#xD;
        opemkod = ISNULL(om.Ope_Kod, ''ID:''+CAST(Bzp_OpeModId as VARCHAR)),&#xD;
        opemnazwa = ISNULL(om.Ope_Nazwisko, ''ID:''+CAST(Bzp_OpeModId as VARCHAR)),&#xD;
&#xD;
        dd.DDf_Symbol [dokumentSymbol], &#xD;
        BZp_NumerPelny [dokumentNumerPelny],&#xD;
        ISNULL(NULLIF(BZp_Opis,''''),''(BRAK)'') [dokumentOpis],&#xD;
        &#xD;
        CASE &#xD;
        WHEN BZp_NumerPelny &lt;&gt; '''' THEN &#xD;
         CASE when isnull(ser.seria,0) = 5 then &#xD;
           substring(BZp_NumerPelny,0,CHARINDEX(''/'',BZp_NumerPelny,0))&#xD;
          ELSE &#xD;
            ISNULL(PARSENAME(REPLACE(substring(BZp_NumerPelny,CHARINDEX(''/'',BZp_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
          END&#xD;
        ELSE ''(BRAK)''&#xD;
        END as [ds], &#xD;
        mpp = BZp_SplitPay,&#xD;
&#xD;
         ''Zapisy k/b'' [zapisyZdarzenia], CASE WHEN BZp_Waluta = '''' THEN @Wal ELSE BZp_Waluta END [waluta], &#xD;
        CASE&#xD;
            WHEN BZp_Typ = 1 THEN ''wpłata/wypłata gotówki'' &#xD;
            WHEN BZp_Typ = 2 THEN ''przelew na konto/z konta''&#xD;
            WHEN BZp_Typ = 3 THEN ''obciążenie/uznanie karty'' &#xD;
        END [fp], &#xD;
        REPLACE(CONVERT(VARCHAR(10), BZp_DataDok, 111), ''/'', ''-'') [dataDokumentu], MONTH(BZp_DataDok) [dataDokumentuMiesiac], DATEPART(quarter, BZp_DataDok) [dataDokumentuKwartal], YEAR(BZp_DataDok) [dataDokumentuRok], (datepart(DY, datediff(d, 0, BZp_DataDok) / 7 * 7 + 3)+6) / 7 [dataDokumentuTydzienRoku]/*DATEPART(isowk, BZp_DataDok)*/,&#xD;
        REPLACE(CONVERT(VARCHAR(10), BZp_DataDok, 111), ''/'', ''-'') [dataTerminPlatnosci], MONTH(BZp_DataDok) [dataTerminPlatnosciMiesiac], DATEPART(quarter, BZp_DataDok) [dataTerminPlatnosciKwartal], YEAR(BZp_DataDok) [dataTerminPlatnosciRok], (datepart(DY, datediff(d, 0, BZp_DataDok) / 7 * 7 + 3)+6) / 7 [dataTerminPlatnosciTydzienRoku]/*DATEPART(isowk, BZp_DataDok)*/,&#xD;
        REPLACE(CONVERT(VARCHAR(10), BZp_DataRoz, 111), ''/'', ''-'') [dataRozliczenia], REPLACE(CONVERT(VARCHAR(10), BZp_DataRoz, 111), ''/'', ''-'') [dataRealizacji],  &#xD;
        GETDATE() [analizaData],&#xD;
        CASE WHEN pod5.Pod_Nazwa1 IS NULL AND pod5.Pod_Nazwa2 IS NULL THEN ''(NIEOKREŚLONY)'' ELSE pod5.Pod_Nazwa1 + '' '' + pod5.Pod_Nazwa2 END [kontrahentNazwa], &#xD;
        kon_procid = CASE pod5.Pod_PodmiotTyp&#xD;
            WHEN 1 THEN 20201&#xD;
            WHEN 2 THEN 23002&#xD;
            WHEN 3 THEN 24001&#xD;
            WHEN 5 THEN 25005&#xD;
            ELSE 20201&#xD;
        END, kon_orgid = pod5.Pod_PodId,&#xD;
        &#xD;
&#xD;
        pod5.Pod_Kod [kontrahentKod],&#xD;
        CASE &#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentTyp],&#xD;
        CASE&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentRodzaj],&#xD;
&#xD;
        CASE WHEN knt3.Knt_LimitFlag = 1 THEN ''Tak'' ELSE ''Nie'' END [kontrahentLimit],&#xD;
        knt3.Knt_LimitKredytu [kontrahentWartośćLimitu],&#xD;
        CASE WHEN knt3.Knt_Termin &gt; 7 THEN ''ponad 7 dni'' ELSE ''mniej niż 7 dni'' END [kontrahentTermin],&#xD;
&#xD;
        case knt3.knt_export&#xD;
            when 0 then ''krajowy''&#xD;
            when 1 then ''pozaunijny''&#xD;
            when 2 then ''pozaunijny (zwrot VAT)''&#xD;
            when 3 then ''wewnątrzunijny''&#xD;
            when 4 then ''wewnątrzunijny trójstronny''&#xD;
            when 5 then ''podatnikiem jest nabywca''&#xD;
            when 6 then ''poza terytorium kraju''&#xD;
            when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
            when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
            when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        end [kontrahentStatus],&#xD;
        CASE &#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 THEN COALESCE(NULLIF(pod5.Pod_Grupa, ''''), ''Pozostali'') &#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Banki''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownicy/Wspólnicy''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urzędy''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentGrupa],&#xD;
        pod5.Pod_Wojewodztwo [kontrahentWojewodztwo], pod5.Pod_Miasto [kontrahentMiasto],pod5.Pod_Kraj [kontrahentKraj], pod5.Pod_NIP [kontrahentNIP],&#xD;
&#xD;
        CASE WHEN pod.Pod_Nazwa1 IS NULL AND pod.Pod_Nazwa2 IS NULL THEN ''(NIEOKREŚLONY)'' ELSE pod.Pod_Nazwa1 + '' '' + pod.Pod_Nazwa2 END [kontrahentPierwotnyNazwa], &#xD;
        konPierwotny_procid = CASE BZp_PodmiotTyp&#xD;
            WHEN 1 THEN 20201&#xD;
            WHEN 2 THEN 23002&#xD;
            WHEN 3 THEN 24001&#xD;
            WHEN 5 THEN 25005&#xD;
            ELSE 20201&#xD;
        END, konPierwotny_orgid = BZp_PodmiotID,&#xD;
        &#xD;
        pod.Pod_Kod [kontrahentPierwotnyKod],&#xD;
        CASE &#xD;
            WHEN BZp_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
            WHEN BZp_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN BZp_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN BZp_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentPierwotnyTyp],&#xD;
        CASE&#xD;
            WHEN BZp_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN BZp_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN BZp_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
            WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
            WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
            WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
            WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
            WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentPierwotnyRodzaj],&#xD;
        case knt1.knt_export&#xD;
            when 0 then ''krajowy''&#xD;
            when 1 then ''pozaunijny''&#xD;
            when 2 then ''pozaunijny (zwrot VAT)''&#xD;
            when 3 then ''wewnątrzunijny''&#xD;
            when 4 then ''wewnątrzunijny trójstronny''&#xD;
            when 5 then ''podatnikiem jest nabywca''&#xD;
            when 6 then ''poza terytorium kraju''&#xD;
            when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
            when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
            when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        end [kontrahentPierwotnyStatus],&#xD;
&#xD;
        CASE &#xD;
            WHEN BZp_PodmiotTyp = 1 THEN COALESCE(NULLIF(pod.Pod_Grupa, ''''), ''Pozostali'')   &#xD;
            WHEN BZp_PodmiotTyp = 2 THEN ''Banki''&#xD;
            WHEN BZp_PodmiotTyp = 3 THEN ''Pracownicy/Wspólnicy''&#xD;
            WHEN BZp_PodmiotTyp = 5 THEN ''Urzędy''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentPierwotnyGrupa],&#xD;
        pod.Pod_Wojewodztwo [kontrahentPierwotnyWojewodztwo], pod.Pod_Miasto [kontrahentPierwotnyMiasto],pod.Pod_Kraj [kontrahentPierwotnyKraj], pod.Pod_NIP [kontrahentPierwotnyNIP],&#xD;
&#xD;
        ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [kategoriaSzczegolowa], &#xD;
        zakladSymbol = isnull(Zak_Symbol,''(NIEPRZYPISANY)''), &#xD;
        zakladNazwa = isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)''), '&#xD;
SET @select2 = '&#xD;
        ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [kategoriaOgolna], BRa_Nazwa [rachunek], BRa_Akronim [rachAkronim], BRa_Symbol [rachSymbol],&#xD;
        CASE &#xD;
            WHEN BZp_Rozliczono2=2 AND BZp_Rozliczono=2 THEN ''Rozliczony'' &#xD;
            WHEN BZp_Rozliczono2=2 AND BZp_Rozliczono=1 THEN ''Częściowo Rozliczony'' &#xD;
            WHEN BZp_Rozliczono=1 THEN ''Nierozliczony'' &#xD;
            WHEN BZp_Rozliczono2=0 AND BZp_Rozliczono=0 THEN ''Nie Podlega Rozliczeniu''&#xD;
&#xD;
        END [statusDokumentu],&#xD;
        CASE&#xD;
            WHEN BZp_Rozliczono=0 AND BZp_Rozliczono2=0 THEN ''Nie Podlega Rozliczeniu'' &#xD;
            WHEN ISNULL(BRK_KwotaSys,0) = 0 THEN ''Nierozliczony''&#xD;
            ELSE ''Częściowo Rozliczony''                   &#xD;
        END [statusDokumentuDzien],&#xD;
        ''Nie dotyczy'' [stanDokumentu],&#xD;
        CASE&#xD;
            WHEN ''' + @ZAPISYWTERMINIE + ''' = ''T'' THEN ''1. Terminowe''&#xD;
            WHEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) &lt; 1 THEN ''1. Terminowe''&#xD;
            WHEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN 1 AND ' + convert(varchar, @PRZEDZIAL1) + ' THEN ''2. Przeterminowane do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL1) + ') + '' dni''&#xD;
            WHEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL1) + '+1 AND ' + convert(varchar, @PRZEDZIAL2) + ' THEN ''3. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL1) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL2) + ') + '' dni''&#xD;
            WHEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL2) + '+1 AND ' + convert(varchar, @PRZEDZIAL3) + ' THEN ''4. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL2) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL3) + ') + '' dni''&#xD;
            WHEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL3) + '+1 AND ' + convert(varchar, @PRZEDZIAL4) + ' THEN ''5. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL3) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL4) + ') + '' dni''&#xD;
            WHEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL4) + '+1 AND ' + convert(varchar, @PRZEDZIAL5) + ' THEN ''6. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL4) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL5) + ') + '' dni''&#xD;
            ELSE ''7. Przeterminowane powyżej '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL5) + ') + '' dni'' &#xD;
        END [terminZapadalnosci],&#xD;
        CASE&#xD;
            WHEN BZp_Kierunek &gt; 0 THEN NULL&#xD;
            WHEN ''' + @ZAPISYWTERMINIE + ''' = ''T'' THEN 0&#xD;
            WHEN BZp_Rozliczono=1 THEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
            WHEN BZp_Rozliczono2=2 AND BZp_Rozliczono=1 THEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
            WHEN BZp_Rozliczono2=0 AND BZp_Rozliczono=0 THEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
            WHEN BZp_Rozliczono2=2 AND BZp_Rozliczono=2 THEN &#xD;
                CASE &#xD;
                    WHEN BZp_DataRoz &gt; convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120) THEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    WHEN BZp_DataRoz &gt; BZp_DataDok THEN DATEDIFF(day, BZp_DataDok, BZp_DataRoz) &#xD;
                    ELSE 0&#xD;
                END&#xD;
            ELSE 0&#xD;
        END [liczbaDniPrzeterminowaniaNaleznosci],&#xD;
        CASE&#xD;
            WHEN BZp_Kierunek &lt; 0 THEN NULL&#xD;
            WHEN ''' + @ZAPISYWTERMINIE + ''' = ''T'' THEN 0&#xD;
            WHEN BZp_Rozliczono=1 THEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
            WHEN BZp_Rozliczono2=2 AND BZp_Rozliczono=1 THEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
            WHEN BZp_Rozliczono2=0 AND BZp_Rozliczono=0 THEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
            WHEN BZp_Rozliczono2=2 AND BZp_Rozliczono=2 THEN &#xD;
                CASE &#xD;
                    WHEN BZp_DataRoz &gt; convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120) THEN DATEDIFF(day, BZp_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    WHEN BZp_DataRoz &gt; BZp_DataDok THEN DATEDIFF(day, BZp_DataDok, BZp_DataRoz) &#xD;
                    ELSE 0&#xD;
                END&#xD;
            ELSE 0&#xD;
        END [liczbaDniPrzeterminowaniaZobowiazania],&#xD;
CASE WHEN BZp_Kierunek &lt; 0 THEN BZp_KwotaSys ELSE NULL END [naleznosci], &#xD;
CASE WHEN BZp_Kierunek &gt; 0 THEN BZp_KwotaSys ELSE NULL END [zobowiazania],&#xD;
CASE WHEN BZp_Kierunek &lt; 0 THEN BZp_Kwota ELSE NULL END [naleznosciWaluta], &#xD;
CASE WHEN BZp_Kierunek &gt; 0 THEN BZp_Kwota ELSE NULL END [zobowiazaniaWaluta],&#xD;
CASE WHEN BZp_Kierunek &lt; 0 THEN ISNULL(BZp_KwotaSys - IsNull(BRK_KwotaSys,0),0) ELSE NULL END [naleznosciNieRozliczone], &#xD;
CASE WHEN BZp_Kierunek &gt; 0 THEN ISNULL(BZp_KwotaSys - IsNull(BRK_KwotaSys,0),0) ELSE NULL END [zobowiazaniaNieRozliczone],&#xD;
CASE WHEN BZp_Kierunek &lt; 0 THEN ISNULL(BZp_Kwota - IsNull(BRK_Kwota,0),0) ELSE NULL END [naleznosciNieRozliczoneWaluta], &#xD;
CASE WHEN BZp_Kierunek &gt; 0 THEN ISNULL(BZp_Kwota - IsNull(BRK_Kwota,0),0) ELSE NULL END [zobowiazaniaNieRozliczoneWaluta],&#xD;
CASE WHEN BZp_KwotaSys - BRK_KwotaSys = 0 THEN ''Tak'' ELSE ''Nie'' END [czyRozliczony]&#xD;
        ' + @atrybuty + @atrybutyDok + '&#xD;
    FROM&#xD;
        CDN.BnkZapisy&#xD;
        LEFT JOIN #tmpSeria ser ON BZp_DDfId = DDf_DDfID&#xD;
        LEFT JOIN CDN.DokDefinicje dd ON BZp_DDfId = dd.DDf_DDfID&#xD;
        LEFT JOIN CDN.BnkRachunki ON BZp_BRaID = BRa_BRaID&#xD;
        LEFT JOIN CDN.PodmiotyView pod ON BZp_PodmiotID = pod.Pod_PodId AND BZp_PodmiotTyp = pod.Pod_PodmiotTyp&#xD;
        LEFT JOIN CDN.Kontrahenci knt1 ON BZp_PodmiotID=knt1.Knt_KntId AND BZp_PodmiotTyp = 1&#xD;
        LEFT JOIN CDN.Kategorie kat1 ON BZp_KatID = kat1.Kat_KatID&#xD;
        LEFT OUTER JOIN (&#xD;
            SELECT&#xD;
                BRK_KwotaSys = SUM(CASE WHEN BRR_ZDokTyp = BRK_LDokTyp AND BRR_ZDokID = BRK_LDokID THEN BRK_KwotaSysL ELSE BRK_KwotaSysP END),&#xD;
                BRK_Kwota = SUM(CASE WHEN BRR_ZDokTyp = BRK_LDokTyp AND BRR_ZDokID = BRK_LDokID THEN BRK_Kwota ELSE BRK_Kwota END),&#xD;
                BRR_ZDokId, BRR_ZDokTyp&#xD;
            FROM CDN.BnkRozKwoty JOIN CDN.BnkRozRelacje ON BRK_BRKId = BRR_BRKId&#xD;
            WHERE BRK_DataDok &lt;= convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)&#xD;
            GROUP BY BRR_ZDokId, BRR_ZDokTyp&#xD;
        ) AS Rozliczenia ON BRR_ZDokTyp = BZp_TypDokumentuKB AND BRR_ZDokId = BZp_BZpID&#xD;
        LEFT JOIN #tmpKonAtr KonAtr ON pod.Pod_PodId = KonAtr.KnA_PodmiotId AND pod.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
        LEFT JOIN #tmpDokAtr DokAtr ON 0  = 1&#xD;
        LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod.Pod_GlID = pod5.Pod_PodId and pod.Pod_GlKod = pod5.Pod_Kod&#xD;
        LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
        LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
        LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = BZp_ZakID&#xD;
        LEFT JOIN ' + @Operatorzy + ' ow on ow.Ope_OpeId = BZp_OpeZalId&#xD;
        LEFT JOIN ' + @Operatorzy + ' om on om.Ope_OpeId = BZp_OpeModId&#xD;
        LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')'&#xD;
&#xD;
SET @select3='&#xD;
UNION ALL &#xD;
&#xD;
    SELECT&#xD;
        BAZ.Baz_Nazwa bf, &#xD;
    &#xD;
        BZd_Numer [dokumentNumer], &#xD;
        dokumentNumer_procid = 23014, dokumentNumer_orgid = BZd_BZdID,&#xD;
        nrpon = ISNULL(pnr,''(BRAK)''),&#xD;
        datpon = ISNULL(REPLACE(CONVERT(VARCHAR(10), pdat, 111), ''/'', ''-''),''(BRAK)''),&#xD;
        opewkod = ISNULL(ow.Ope_Kod, ''ID:''+CAST(Bzd_OpeZalId as VARCHAR)),&#xD;
        opewnazwa = ISNULL(ow.Ope_Nazwisko, ''ID:''+CAST(Bzd_OpeZalId as VARCHAR)),&#xD;
        opemkod = ISNULL(om.Ope_Kod, ''ID:''+CAST(Bzd_OpeModId as VARCHAR)),&#xD;
        opemnazwa = ISNULL(om.Ope_Nazwisko, ''ID:''+CAST(Bzd_OpeModId as VARCHAR)),&#xD;
&#xD;
        dd.DDf_Symbol [Dokument Symbol],&#xD;
        BZd_NumerPelny [dokumentNumerPelny],&#xD;
        ISNULL(NULLIF(BZd_Opis,''''), ''(BRAK)'') [dokumentOpis],&#xD;
        &#xD;
        CASE &#xD;
        WHEN BZd_NumerPelny &lt;&gt; '''' THEN &#xD;
         CASE when isnull(ser.seria,0) = 5 then &#xD;
           substring(BZd_NumerPelny,0,CHARINDEX(''/'',BZd_NumerPelny,0))&#xD;
         ELSE &#xD;
           ISNULL(PARSENAME(REPLACE(substring(BZd_NumerPelny,CHARINDEX(''/'',BZd_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
         END&#xD;
         ELSE ''(BRAK)''&#xD;
         END as [ds], &#xD;
         mpp = BZd_SplitPay,&#xD;
&#xD;
        ''Zdarzenia k/b'' [zapisyZdarzenia], CASE WHEN BZd_Waluta = '''' THEN @Wal ELSE BZd_Waluta END [waluta], fp = FPl_Nazwa,&#xD;
        REPLACE(CONVERT(VARCHAR(10), BZd_DataDok, 111), ''/'', ''-'') [dataDokumentu], MONTH(BZd_DataDok) [dataDokumentuMiesiac], DATEPART(quarter, BZd_DataDok) [dataDokumentuKwartal], YEAR(BZd_DataDok) [dataDokumentuRok], (datepart(DY, datediff(d, 0, BZd_DataDok) / 7 * 7 + 3)+6) / 7 [dataDokumentuTydzienRoku]/*DATEPART(isowk, BZp_DataDok)*/,&#xD;
        REPLACE(CONVERT(VARCHAR(10), BZd_Termin, 111), ''/'', ''-'') [dataTerminPlatnosci], MONTH(BZd_Termin) [dataTerminPlatnosciMiesiac], DATEPART(quarter, BZd_Termin) [dataTerminPlatnosciKwartal], YEAR(BZd_Termin) [dataTerminPlatnosciRok], (datepart(DY, datediff(d, 0, BZd_Termin) / 7 * 7 + 3)+6) / 7 [dataTerminPlatnosciTydzienRoku]/*DATEPART(isowk, BZp_DataDok)*/,&#xD;
        REPLACE(CONVERT(VARCHAR(10), BZd_DataRoz, 111), ''/'', ''-'') [dataRozliczenia], REPLACE(CONVERT(VARCHAR(10), BZd_DataReal, 111), ''/'', ''-'') [dataRealizacji],  &#xD;
        GETDATE() [analizaData],&#xD;
                CASE WHEN pod5.Pod_Nazwa1 IS NULL AND pod5.Pod_Nazwa2 IS NULL THEN ''(NIEOKREŚLONY)'' ELSE pod5.Pod_Nazwa1 + '' '' + pod5.Pod_Nazwa2 END [kontrahentNazwa], &#xD;
        kon_procid = CASE pod5.Pod_PodmiotTyp&#xD;
            WHEN 1 THEN 20201&#xD;
            WHEN 2 THEN 23002&#xD;
            WHEN 3 THEN 24001&#xD;
            WHEN 5 THEN 25005&#xD;
            ELSE 20201&#xD;
        END, kon_orgid = pod5.Pod_PodId,&#xD;
        &#xD;
        pod5.Pod_Kod [kontrahentKod],&#xD;
        CASE &#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentTyp],&#xD;
        CASE&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentRodzaj],&#xD;
        &#xD;
        CASE WHEN knt3.Knt_LimitFlag = 1 THEN ''Tak'' ELSE ''Nie'' END [kontrahentLimit],&#xD;
        knt3.Knt_LimitKredytu [kontrahentWartośćLimitu],&#xD;
        CASE WHEN knt3.Knt_Termin &gt; 7 THEN ''ponad 7 dni'' ELSE ''mniej niż 7 dni'' END [kontrahentTermin],&#xD;
&#xD;
        case knt3.knt_export&#xD;
            when 0 then ''krajowy''&#xD;
            when 1 then ''pozaunijny''&#xD;
            when 2 then ''pozaunijny (zwrot VAT)''&#xD;
            when 3 then ''wewnątrzunijny''&#xD;
            when 4 then ''wewnątrzunijny trójstronny''&#xD;
            when 5 then ''podatnikiem jest nabywca''&#xD;
            when 6 then ''poza terytorium kraju''&#xD;
            when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
            when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
            when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        end [kontrahentStatus],&#xD;
        CASE &#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 THEN COALESCE(NULLIF(pod5.Pod_Grupa, ''''), ''Pozostali'') &#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Banki''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownicy/Wspólnicy''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urzędy''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentGrupa],&#xD;
        pod5.Pod_Wojewodztwo [kontrahent\Wojewodztwo], pod5.Pod_Miasto [kontrahentMiasto],pod5.Pod_Kraj [kontrahentKraj], pod5.Pod_NIP [kontrahentNIP],&#xD;
        &#xD;
        CASE WHEN pod.Pod_Nazwa1 IS NULL AND pod.Pod_Nazwa2 IS NULL THEN ''(NIEOKREŚLONY)'' ELSE pod.Pod_Nazwa1 + '' '' + pod.Pod_Nazwa2 END [kontrahentPierwotnyNazwa], &#xD;
        konPierwotny_procid = CASE BZd_PodmiotTyp&#xD;
            WHEN 1 THEN 20201&#xD;
            WHEN 2 THEN 23002&#xD;
            WHEN 3 THEN 24001&#xD;
            WHEN 5 THEN 25005&#xD;
            ELSE 20201&#xD;
        END, konPierwotny_orgid = BZd_PodmiotID,&#xD;
        &#xD;
        pod.Pod_Kod [kontrahentPierwotnyKod],&#xD;
        CASE &#xD;
            WHEN BZd_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
            WHEN BZd_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN BZd_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN BZd_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentPierwotnyTyp],&#xD;
        CASE&#xD;
            WHEN BZd_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN BZd_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN BZd_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
            WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
            WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
            WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
            WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
            WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentPierwotnyRodzaj],&#xD;
        case knt1.knt_export&#xD;
            when 0 then ''krajowy''&#xD;
            when 1 then ''pozaunijny''&#xD;
            when 2 then ''pozaunijny (zwrot VAT)''&#xD;
            when 3 then ''wewnątrzunijny''&#xD;
            when 4 then ''wewnątrzunijny trójstronny''&#xD;
            when 5 then ''podatnikiem jest nabywca''&#xD;
            when 6 then ''poza terytorium kraju''&#xD;
            when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
            when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
            when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        end [kontrahentPierwotnyStatus],&#xD;
        CASE &#xD;
            WHEN BZd_PodmiotTyp = 1 THEN COALESCE(NULLIF(pod.Pod_Grupa, ''''), ''Pozostali'')   &#xD;
            WHEN BZd_PodmiotTyp = 2 THEN ''Banki''&#xD;
            WHEN BZd_PodmiotTyp = 3 THEN ''Pracownicy/Wspólnicy''&#xD;
            WHEN BZd_PodmiotTyp = 5 THEN ''Urzędy''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [kontrahentPierwotnyGrupa],&#xD;
        pod.Pod_Wojewodztwo [kontrahentPierwotnyWojewodztwo], pod.Pod_Miasto [kontrahentPierwotnyMiasto],pod.Pod_Kraj [kontrahentPierwotnyKraj], pod.Pod_NIP [kontrahentPierwotnyNIP],&#xD;
        ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [kategoriaSzczegolowa], &#xD;
        zakladSymbol = ''(NIEPRZYPISANY)'', &#xD;
        zakladNazwa = ''(NIEPRZYPISANY)'', &#xD;
        ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [kategoriaOgolna], BRa_Nazwa [rachunek], BRa_Akronim [rachAkronim], BRa_Symbol [rachSymbol],&#xD;
        CASE&#xD;
            WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=1 THEN ''Nierozliczony''&#xD;
            WHEN BZd_Rozliczono=2 THEN ''Rozliczony''&#xD;
            WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=2 THEN ''Częściowo Rozliczony''&#xD;
            WHEN BZd_Rozliczono=0 AND BZd_Rozliczono2=0 THEN ''Nie Podlega Rozliczeniu'' &#xD;
            WHEN BZd_Rozliczono=2 AND BZd_Rozliczono2=2 THEN ''W Rozliczeniu Całości''&#xD;
        END [statusDokumentu],&#xD;
        CASE&#xD;
            WHEN BZd_Rozliczono=0 AND BZd_Rozliczono2=0 THEN ''Nie Podlega Rozliczeniu'' &#xD;
            WHEN ISNULL(BRK_KwotaSys,0) = 0 THEN ''Nierozliczony''&#xD;
            ELSE ''Częściowo Rozliczony''&#xD;
        END [statusDokumentuDzien],&#xD;
        CASE&#xD;
            WHEN BZd_Stan = 0 THEN ''Bufor''&#xD;
            WHEN BZd_Stan = 1 THEN ''Do Realizacji''&#xD;
            WHEN BZd_Stan = 2 THEN ''Wysłane''&#xD;
            WHEN BZd_Stan = 3 THEN ''Zrealizowane''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [stanDokumentu],'&#xD;
SET @select4 = '&#xD;
        CASE &#xD;
            WHEN ''' + @TERMINDATA + ''' = ''D'' THEN&#xD;
                CASE&#xD;
                    WHEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) &lt; 1 THEN ''1. Terminowe''&#xD;
                    WHEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN 1 AND ' + convert(varchar, @PRZEDZIAL1) + ' THEN ''2. Przeterminowane do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL1) + ') + '' dni''&#xD;
                    WHEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL1) + '+1 AND ' + convert(varchar, @PRZEDZIAL2) + ' THEN ''3. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL1) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL2) + ') + '' dni''&#xD;
                    WHEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL2) + '+1 AND ' + convert(varchar, @PRZEDZIAL3) + ' THEN ''4. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL2) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL3) + ') + '' dni''&#xD;
                    WHEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL3) + '+1 AND ' + convert(varchar, @PRZEDZIAL4) + ' THEN ''5. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL3) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL4) + ') + '' dni''&#xD;
                    WHEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL4) + '+1 AND ' + convert(varchar, @PRZEDZIAL5) + ' THEN ''6. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL4) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL5) + ') + '' dni''&#xD;
                    ELSE ''7. Przeterminowane powyżej '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL5) + ') + '' dni'' &#xD;
                END&#xD;
            ELSE&#xD;
                CASE&#xD;
                    WHEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) &lt; 1 THEN ''1. Terminowe''&#xD;
                    WHEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN 1 AND ' + convert(varchar, @PRZEDZIAL1) + ' THEN ''2. Przeterminowane do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL1) + ') + '' dni''&#xD;
                    WHEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL1) + '+1 AND ' + convert(varchar, @PRZEDZIAL2) + ' THEN ''3. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL1) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL2) + ') + '' dni''&#xD;
                    WHEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL2) + '+1 AND ' + convert(varchar, @PRZEDZIAL3) + ' THEN ''4. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL2) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL3) + ') + '' dni''&#xD;
                    WHEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL3) + '+1 AND ' + convert(varchar, @PRZEDZIAL4) + ' THEN ''5. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL3) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL4) + ') + '' dni''&#xD;
                    WHEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)) BETWEEN ' + convert(varchar, @PRZEDZIAL4) + '+1 AND ' + convert(varchar, @PRZEDZIAL5) + ' THEN ''6. Przeterminowane od '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL4) + ' + 1) + '' do '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL5) + ') + '' dni''&#xD;
                    ELSE ''7. Przeterminowane powyżej '' + CONVERT(VARCHAR,' + convert(varchar, @PRZEDZIAL5) + ') + '' dni'' &#xD;
                END &#xD;
        END [terminZapadalnosci],&#xD;
        CASE &#xD;
            WHEN ''' + @TERMINDATA + ''' = ''D'' THEN       &#xD;
                CASE&#xD;
                    WHEN BZd_Kierunek &lt; 0 THEN NULL&#xD;
                    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=1 THEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    WHEN BZd_Rozliczono=2 THEN &#xD;
                        CASE&#xD;
                            WHEN BZd_DataRoz &gt; convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120) THEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                            WHEN BZd_DataRoz &gt; BZd_DataDok THEN DATEDIFF(day, BZd_DataDok, BZd_DataRoz) &#xD;
                            ELSE 0 &#xD;
                        END&#xD;
                    WHEN BZd_Rozliczono=2 AND BZd_Rozliczono2=2 THEN DATEDIFF(day, BZd_DataDok, BZd_DataRoz)&#xD;
                    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=2 THEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    WHEN BZd_Rozliczono=0 AND BZd_Rozliczono2=0 THEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    ELSE 0 &#xD;
                END &#xD;
            ELSE&#xD;
                CASE&#xD;
                    WHEN BZd_Kierunek &lt; 0 THEN NULL&#xD;
                    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=1 THEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    WHEN BZd_Rozliczono=2 THEN &#xD;
                        CASE&#xD;
                            WHEN BZd_DataRoz &gt; convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120) THEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                            WHEN BZd_DataRoz &gt; BZd_Termin THEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) &#xD;
                            ELSE 0 &#xD;
                        END&#xD;
                    WHEN BZd_Rozliczono=2 AND BZd_Rozliczono2=2 THEN DATEDIFF(day, BZd_Termin, BZd_DataRoz)&#xD;
                    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=2 THEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    WHEN BZd_Rozliczono=0 AND BZd_Rozliczono2=0 THEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    ELSE 0&#xD;
                END &#xD;
        END [liczbaDniPrzeterminowaniaNaleznosci],'&#xD;
SET @select5 = '&#xD;
&#xD;
        CASE &#xD;
            WHEN ''' + @TERMINDATA + ''' = ''D'' THEN               &#xD;
                CASE&#xD;
                    WHEN BZd_Kierunek &gt; 0 THEN NULL&#xD;
                    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=1 THEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    WHEN BZd_Rozliczono=2 THEN &#xD;
                        CASE&#xD;
                            WHEN BZd_DataRoz &gt; convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120) THEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                            WHEN BZd_DataRoz &gt; BZd_DataDok THEN DATEDIFF(day, BZd_DataDok, BZd_DataRoz)                         &#xD;
                            ELSE 0&#xD;
                        END&#xD;
                    WHEN BZd_Rozliczono=2 AND BZd_Rozliczono2=2 THEN DATEDIFF(day, BZd_DataDok, BZd_DataRoz)&#xD;
                    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=2 THEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    WHEN BZd_Rozliczono=0 AND BZd_Rozliczono2=0 THEN DATEDIFF(day, BZd_DataDok, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    ELSE 0 &#xD;
                END&#xD;
            ELSE&#xD;
                CASE&#xD;
                    WHEN BZd_Kierunek &gt; 0 THEN NULL&#xD;
                    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=1 THEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    WHEN BZd_Rozliczono=2 THEN &#xD;
                        CASE&#xD;
                            WHEN BZd_DataRoz &gt; convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120) THEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                            WHEN BZd_DataRoz &gt; BZd_Termin THEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) &#xD;
                            ELSE 0&#xD;
                        END&#xD;
                    WHEN BZd_Rozliczono=2 AND BZd_Rozliczono2=2 THEN DATEDIFF(day, BZd_Termin, BZd_DataRoz)&#xD;
                    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=2 THEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    WHEN BZd_Rozliczono=0 AND BZd_Rozliczono2=0 THEN DATEDIFF(day, BZd_Termin, convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120))&#xD;
                    ELSE 0 &#xD;
                END&#xD;
        END [liczbaDniPrzeterminowaniaZobowiazania],&#xD;
        CASE WHEN BZd_Kierunek &gt; 0 THEN BZd_KwotaSys ELSE NULL END [naleznosci], &#xD;
        CASE WHEN BZd_Kierunek &lt; 0 THEN BZd_KwotaSys ELSE NULL END [zobowiazania],&#xD;
        CASE WHEN BZd_Kierunek &gt; 0 THEN BZd_Kwota ELSE NULL END [naleznosciWaluta], &#xD;
        CASE WHEN BZd_Kierunek &lt; 0 THEN BZd_Kwota ELSE NULL END [zobowiazaniaWaluta],&#xD;
        CASE WHEN BZd_Kierunek &gt; 0 THEN ISNULL(BZd_KwotaSys - IsNull(BRK_KwotaSys,0),0) ELSE NULL END [naleznosciNieRozliczone], &#xD;
        CASE WHEN BZd_Kierunek &lt; 0 THEN ISNULL(BZd_KwotaSys - IsNull(BRK_KwotaSys,0),0) ELSE NULL END [zobowiazaniaNieRozliczone],&#xD;
        CASE WHEN BZd_Kierunek &gt; 0 THEN ISNULL(BZd_Kwota - IsNull(BRK_Kwota,0),0) ELSE NULL END [naleznosciNieRozliczoneWaluta], &#xD;
        CASE WHEN BZd_Kierunek &lt; 0 THEN ISNULL(BZd_Kwota - IsNull(BRK_Kwota,0),0) ELSE NULL END [zobowiazaniaNieRozliczoneWaluta],&#xD;
        CASE WHEN BZd_KwotaSys - BRK_KwotaSys = 0 THEN ''Tak'' ELSE ''Nie'' END [czyRozliczony]&#xD;
        ' + @atrybuty + @atrybutyDok + '&#xD;
    FROM&#xD;
        CDN.BnkZdarzenia&#xD;
        LEFT JOIN #tmpSeria ser ON BZd_DDfId = DDf_DDfID&#xD;
        LEFT JOIN CDN.DokDefinicje dd ON BZd_DDfId = dd.DDf_DDfID&#xD;
        LEFT JOIN CDN.BnkRachunki ON BZd_BRaID = BRa_BRaID&#xD;
        LEFT JOIN CDN.PodmiotyView pod ON BZd_PodmiotID = pod.Pod_PodId AND BZd_PodmiotTyp = pod.Pod_PodmiotTyp&#xD;
        LEFT JOIN CDN.Kontrahenci knt1 ON BZd_PodmiotID=knt1.Knt_KntId AND BZd_PodmiotTyp = 1&#xD;
        LEFT JOIN CDN.Kategorie kat1 ON BZd_KatID = kat1.Kat_KatID&#xD;
        LEFT OUTER JOIN (&#xD;
            SELECT&#xD;
                BRK_KwotaSys = SUM(CASE WHEN BRR_ZDokTyp = BRK_LDokTyp AND BRR_ZDokID = BRK_LDokID THEN BRK_KwotaSysL ELSE BRK_KwotaSysP END),&#xD;
                BRK_Kwota = SUM(CASE WHEN BRR_ZDokTyp = BRK_LDokTyp AND BRR_ZDokID = BRK_LDokID THEN BRK_Kwota ELSE BRK_Kwota END),&#xD;
                BRR_ZDokId, BRR_ZDokTyp&#xD;
            FROM CDN.BnkRozKwoty JOIN CDN.BnkRozRelacje ON BRK_BRKId = BRR_BRKId&#xD;
            WHERE BRK_DataDok &lt;= convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)&#xD;
            GROUP BY BRR_ZDokId, BRR_ZDokTyp&#xD;
        ) AS Rozliczenia ON BRR_ZDokTyp = BZd_TypDokumentuKB AND BRR_ZDokId = BZd_BZdID&#xD;
        LEFT JOIN #tmpKonAtr KonAtr ON pod.Pod_PodId = KonAtr.KnA_PodmiotId AND pod.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
        LEFT JOIN #tmpDokAtr DokAtr ON BZd_DokumentID  = DokAtr.DAt_TrNId AND BZd_DokumentTyp = DokAtr.DokTyp&#xD;
        LEFT JOIN CDN.FormyPlatnosci ON BZd_FPlId = FPl_FPlId&#xD;
        LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod.Pod_GlID = pod5.Pod_PodId and pod.Pod_GlKod = pod5.Pod_Kod&#xD;
        LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
        LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
        LEFT JOIN (&#xD;
SELECT&#xD;
BDE_DokId pzr,&#xD;
MAX(BDN_NumerPelny) pnr,&#xD;
MAX(BDN_DataDok) pdat&#xD;
FROM&#xD;
CDN.BnkDokElem &#xD;
JOIN CDN.BnkDokNag ON BDE_BDNId = BDN_BDNId AND BDN_Typ = 222 &#xD;
GROUP BY BDE_DokId&#xD;
) pon on pzr = BZd_DokumentID&#xD;
LEFT JOIN ' + @Operatorzy + ' ow on ow.Ope_OpeId = BZd_OpeZalId&#xD;
LEFT JOIN ' + @Operatorzy + ' om on om.Ope_OpeId = BZd_OpeModId&#xD;
LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'')&#xD;
) AS Kalendar &#xD;
WHERE convert(datetime,dataDokumentu, 111) &lt;= convert(datetime,''' + convert(varchar, @DATA, 120) + ''', 120)'&#xD;
&#xD;
IF @ROZLICZONE = 'NIE' SET @select5 = @select5 + &#xD;
' AND ((NULLIF(naleznosciNieRozliczone,0) IS NOT NULL) OR (NULLIF(zobowiazaniaNieRozliczone,0) IS NOT NULL))'&#xD;
&#xD;
EXEC(@select + @select2 + @select3 + @select4 + @select5)&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpSeria  &#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2ji2hPfAjFY4M+tyTN+WFbqesYguIRD4zhi2+XbPG4+IXlBAY1WtwNgyWhhgg2DLjiTmd8QWzd4S48umcSZUrrUqKFUikgGFuKUE6/c5LlVGtOckIiL+1rWVN9YoxYiyqr</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer Pełny" caption="Dokument Numer Pełny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument MPP" caption="Dokument MPP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Ponaglenia Numer" caption="Dokument Ponaglenia Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Ponaglenia Data Wystawienia" caption="Dokument Ponaglenia Data Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wystawiający Kod" caption="Operator Wystawiający Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wystawiający Nazwa" caption="Operator Wystawiający Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący Kod" caption="Operator Modyfikujący Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący Nazwa" caption="Operator Modyfikujący Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Zapisy/Zdarzenia" caption="Zapisy/Zdarzenia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Limit" caption="Podmiot Limit" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Wartość Limitu" caption="Podmiot Wartość Limitu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podmiot Termin" caption="Podmiot Termin" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Rodzaj" caption="Podmiot Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Status" caption="Podmiot Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Grupa" caption="Podmiot Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Województwo" caption="Podmiot Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Miasto" caption="Podmiot Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kraj" caption="Podmiot Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot NIP" caption="Podmiot NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Nazwa" caption="Podmiot Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kod" caption="Podmiot Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Typ" caption="Podmiot Pierwotny Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Rodzaj" caption="Podmiot Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Status" caption="Podmiot Pierwotny Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Grupa" caption="Podmiot Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Województwo" caption="Podmiot Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Miasto" caption="Podmiot Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kraj" caption="Podmiot Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny NIP" caption="Podmiot Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa" caption="Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna" caption="Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rejestr" caption="Rejestr" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rejestr Akronim" caption="Rejestr Akronim" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rejestr Symbol" caption="Rejestr Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Status Aktualny" caption="Status Aktualny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Status na Dzień Analizy" caption="Status na Dzień Analizy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Stan Aktualny" caption="Stan Aktualny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Zapadalności" caption="Termin Zapadalności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania Należności" caption="Liczba Dni Przeterminowania Należności" type="measure" formatString="n0" aggregate="Average" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania Zobowiązań" caption="Liczba Dni Przeterminowania Zobowiązań" type="measure" formatString="n0" aggregate="Average" /&gt;&#xD;
    &lt;column name="Sprzedaż brutto" caption="Sprzedaż brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Należności" caption="Należności" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zobowiązania" caption="Zobowiązania" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Należności Waluta" caption="Należności Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zobowiązania Waluta" caption="Zobowiązania Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Należności Nierozliczone" caption="Należności Nierozliczone" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zobowiązania Nierozliczone" caption="Zobowiązania Nierozliczone" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Należności Nierozliczone Waluta" caption="Należności Nierozliczone Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zobowiązania Nierozliczone Waluta" caption="Zobowiązania Nierozliczone Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Dokumentu Dzień" caption="Data Dokumentu Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Miesiąc" caption="Data Dokumentu Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Kwartał" caption="Data Dokumentu Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Rok" caption="Data Dokumentu Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Tydzień Roku" caption="Data Dokumentu Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Dzień" caption="Data Termin Płatności Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Miesiąc" caption="Data Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Kwartał" caption="Data Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Rok" caption="Data Termin Płatności Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Tydzień Roku" caption="Data Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Dzień" caption="Data Rozliczenia Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Realizacji Dzień" caption="Data Realizacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy" caption="Data Analizy" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATA&lt;/Name&gt;&#xD;
    &lt;Label&gt;Analiza na dzień:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data, dla której wykonana zostanie analiza&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-09-20&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL1&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 1 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;30&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL2&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 2 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;60&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL3&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 3 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;90&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;TERMINDATA&lt;/Name&gt;&#xD;
    &lt;Label&gt;Według: (T)ermin Płatności, (D)ata Dokumentu&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Parametr określający czy struktura wiekowa ma być liczona na podstawie terminu płatności (wpisz T) czy daty dokumentu (wpisz D)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Tekst&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Text&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;1&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;true&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;T&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;ZAPISYWTERMINIE&lt;/Name&gt;&#xD;
    &lt;Label&gt;Zapisy k/b zawsze "Terminowe": (T)ak, (N)ie&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Parametr określający czy traktować zapisy k/b zawsze jako terminowe. Jeśli tak wpisz T, jeśli nie wpisz N&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Tekst&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Text&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;1&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;true&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;N&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL4&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 4 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;180&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL5&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 5 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;365&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;ROZLICZONE&lt;/Name&gt;&#xD;
    &lt;Label&gt;Uwzględniać dokumenty rozliczone:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Czy uwzględniać w raporcie dokumenty rozliczone&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;'TAK';'NIE'&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;'NIE'&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="299" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Płatności na Dzień wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o należnościach i zobowiązaniach firmy w danym dniu. &#xD;
Wartości prezentowane są w walucie systemowej oraz walucie dokumentu.&#xD;
&#xD;
Raport zawiera następujące parametry:&#xD;
Data Analizy - Data, dla której wykonana zostanie analiza&#xD;
Przedział 1, 2, 3 - Górna granica (w dniach) przedziałów, do których zostaną przypisane dokumenty. &#xD;
Górna granica przedziału wcześniejszego jest dolną późniejszego.&#xD;
Termin/Data - Parametr określający czy struktura wiekowa ma być liczona na podstawie terminu &#xD;
płatności (wpisz T) czy daty dokumentu (wpisz D)&#xD;
Zapisy k/b zawsze "Terminowe" - Parametr określający czy traktować zapisy k/b zawsze jako &#xD;
terminowe. Jeśli tak wpisz T, jeśli nie wpisz N&#xD;
&#xD;
W analizach brane pod uwagę są wszystkie dokumenty płatności dla wszystkich rachunków. &#xD;
Dokumenty zapisów pobierane są z tabeli BnkZapisy natomiast zdarzeń z BnkZdarzenia.&#xD;
Przychód, Rozchód i Saldo liczone są na podstawie wartości tabel BZp_KwotaSys i BZd_KwotaSys.&#xD;
Przychód Niezrealizowany, Rozchód Niezrealizowany i Saldo Niezrealizowane liczone są na podstawie &#xD;
wartości tabel BZp_KwotaSys i BZd_KwotaSys pomniejszonej o wartość tabeli BZd_KwotaRozSys dla&#xD;
 zdarzeń.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
BnkZapisy - Tabela zawiera dokumenty w postaci wyciągów bankowych oraz innych dokumentów&#xD;
rejestrowanych w kasach gotówkowych. &#xD;
BnkZdarzenia - Tabela zawiera zdarzenia, które mają nastąpić w przyszłości (np. zapłata za fakturę).</a:description><a:id>10</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>10. Raport Płatności na Dzień</a:mainLinkName><a:modifiedOn>2025-02-06T17:55:05.717</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-03-19T15:39:56.783</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
/* RAPORT_INFO &#xD;
* Raport Dokumentów Magazynowych &#xD;
* Wersja raportu:			38.0&#xD;
* Wersja baz OPTIMY:		2025.3706&#xD;
* Wersja aplikacji OPTIMA:	2025.3.1&#xD;
*/&#xD;
&#xD;
DECLARE  @SqlKolumny	VARCHAR(MAX)&#xD;
		,@SqlTabele		VARCHAR(MAX);&#xD;
&#xD;
&#xD;
BEGIN /* Wyliczanie poziomów grup produktów		*/ &#xD;
	WITH g (		  gid,     gidTyp,     kod,     gidNumer,     grONumer,      poziom, sciezka)&#xD;
	AS ( SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
	      FROM CDN.TwrGrupy&#xD;
	      WHERE TwG_TwGID = 0&#xD;
	      UNION ALL&#xD;
	      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
	      FROM g p&#xD;
	      JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer &#xD;
	      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
		)     &#xD;
	SELECT * INTO #tmpTwrGr FROM g&#xD;
	&#xD;
	DECLARE  @poziom		INT&#xD;
			,@poziom_max	INT&#xD;
			,@sql			NVARCHAR(MAX)&#xD;
	SET @poziom_max = (SELECT MAX(poziom) FROM #tmpTwrGr)&#xD;
	SET @poziom		= @poziom_max&#xD;
	SET @sql		= N''&#xD;
	&#xD;
	WHILE @poziom &gt;= 0  &#xD;
	BEGIN&#xD;
		SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
	    EXEC(@sql)&#xD;
	    &#xD;
	    IF @poziom = @poziom_max &#xD;
			BEGIN&#xD;
				SET @sql = N'UPDATE #tmpTwrGr SET ONr'	  + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
				EXEC(@sql)&#xD;
				&#xD;
				SET @sql = N'UPDATE #tmpTwrGr SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
				EXEC(@sql)&#xD;
			END&#xD;
	    ELSE&#xD;
			BEGIN &#xD;
	    		SET @sql = N'  UPDATE c SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (CASE &#xD;
									WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
									ELSE CAST(p.kod AS nvarchar) &#xD;
									END)  &#xD;
								 FROM #tmpTwrGr c&#xD;
							LEFT JOIN #tmpTwrGr p ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		&#xD;
				SET @sql = N'  UPDATE c SET c.ONr'	  + CAST(@poziom AS nvarchar) + N' = (CASE &#xD;
									WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
									ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
								 FROM #tmpTwrGr c&#xD;
							LEFT JOIN #tmpTwrGr p ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
					EXEC(@sql)&#xD;
			END&#xD;
	    SET @poziom = @poziom - 1&#xD;
	END     &#xD;
&#xD;
	DECLARE  @kolumny	VARCHAR(MAX)&#xD;
			,@i			INT&#xD;
&#xD;
	SET @kolumny = ''&#xD;
	SET @i = 0&#xD;
	WHILE (@i &lt;= @poziom_max)&#xD;
	BEGIN&#xD;
		SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) &#xD;
					+ '" = CASE WHEN Poz.Poziom' +LTRIM(@i) &#xD;
					+ ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
		SET @i = @i + 1&#xD;
	END&#xD;
END&#xD;
BEGIN /* Wyliczanie Atrybutów Kontrahentów		*/ &#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
		 ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
		END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'     &#xD;
	SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'      &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
END&#xD;
BEGIN /* Wyliczanie Atrybutów Dokumentów		*/ &#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
		  ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
		END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
END&#xD;
BEGIN /* Wyliczanie Atrybutów Towarów			*/ &#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
		 ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
		END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
END&#xD;
BEGIN /* Wyliczanie Atrybutów Pozycji			*/ &#xD;
	DECLARE  @atrybutyPoz	VARCHAR(MAX)&#xD;
			,@atrybutyPoz2	VARCHAR(MAX);&#xD;
&#xD;
	SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
					SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
					  FROM CDN.DefAtrybuty&#xD;
					 WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
					   AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
	IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
	EXEC(@sqlA)&#xD;
&#xD;
	OPEN atrybut_cursor;&#xD;
		SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
		&#xD;
		SET @atrybutyPoz = ''&#xD;
		SET @atrybutyPoz2 = ''&#xD;
&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
			   INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
	WHILE @@FETCH_STATUS = 0&#xD;
	BEGIN&#xD;
		IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
		IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
		SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
		EXEC(@sqlA)    &#xD;
		SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
			SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
			 ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
			END	 &#xD;
			FROM CDN.TraElemAtr ATR &#xD;
			JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
		WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
		EXEC(@sqlA)    &#xD;
		&#xD;
		SET @atrybutyPoz	= @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
		SET @atrybutyPoz2	= @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
		FETCH NEXT FROM atrybut_cursor&#xD;
				   INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
	END	&#xD;
&#xD;
	CLOSE atrybut_cursor;&#xD;
	DEALLOCATE atrybut_cursor;&#xD;
END&#xD;
BEGIN /* Połączenie do tabeli operatorów		*/ &#xD;
	DECLARE  @serwerKonf	VARCHAR(MAX)&#xD;
			,@bazaKonf		VARCHAR(MAX)&#xD;
			,@bazaFirmowa	VARCHAR(MAX)&#xD;
			,@Operatorzy	VARCHAR(MAX)&#xD;
			,@Bazy	VARCHAR(MAX);&#xD;
	SET @serwerKonf		= (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
	SET @bazaKonf		= (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
	SET @bazaFirmowa	= (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
	SET @Operatorzy		= '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]'&#xD;
	SET @Bazy			= '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' ;&#xD;
END&#xD;
BEGIN /* Tworzenie tabeli z serią dokumentów	*/ &#xD;
	SELECT	 DDf_DDfID&#xD;
			,CASE &#xD;
				WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
				WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
				WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
				WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
				WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
				END [seria]&#xD;
	 INTO #tmpSeria &#xD;
	 FROM CDN.DokDefinicje&#xD;
END&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
SET @SqlKolumny = &#xD;
'Declare @Wal	VarChar(3);&#xD;
	 Set @Wal = cdn.Waluta('''');&#xD;
&#xD;
SELECT &#xD;
-----MIARY&#xD;
	 [Cena Domyślna]				= TwC_Wartosc&#xD;
	,[Ilość]						= TR.TrE_Ilosc&#xD;
	,[Ilość Jednostka Pomocnicza]	= CAST(TR.TrE_Ilosc/(Twr_JMPrzelicznikL/Twr_JMPrzelicznikM) AS Decimal(26,10))&#xD;
	,[Koszt Zakupu]					= ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi&#xD;
	,[Marża]						= TR.TrE_WartoscNetto - (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)&#xD;
	,[Wartość Brutto]				= TR.TrE_WartoscBrutto&#xD;
	,[Wartość Netto]				= TR.TrE_WartoscNetto&#xD;
	,[Wartość Waluta]				= TR.TrE_WartoscNettoWal&#xD;
	,[Liczba Dokumentów]			= CONCAT(BAZ.Baz_Nazwa,''_'',TrN_NumerPelny) &#xD;
	&#xD;
-----WYMIARY&#xD;
	,[Baza Firmowa]		= BAZ.Baz_Nazwa&#xD;
&#xD;
	--DOKUMENT&#xD;
	,[Dokument Numer]	= TrN_NumerPelny&#xD;
	,[Dokument Symbol]	= dd.DDf_Symbol&#xD;
	,[Dokument Opis]	= ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'')&#xD;
	,[Dokument Typ]		= CASE								&#xD;
							WHEN TrN_TypDokumentu = 312 THEN ''MM''&#xD;
							WHEN TrN_TypDokumentu = 303 THEN ''PW''&#xD;
							WHEN TrN_TypDokumentu = 317 THEN ''PWP''&#xD;
							WHEN TrN_TypDokumentu = 307 THEN ''PZ''&#xD;
							WHEN TrN_TypDokumentu = 304 THEN ''RW''&#xD;
							WHEN TrN_TypDokumentu = 318 THEN ''RWS''&#xD;
							WHEN TrN_TypDokumentu = 306 THEN ''WZ''&#xD;
							WHEN TrN_TypDokumentu = 313 THEN ''PKA''&#xD;
							WHEN TrN_TypDokumentu = 314 THEN ''WKA''&#xD;
							ELSE ''(NIEPRZYPISANY)'' &#xD;
							END&#xD;
	,[Dokument Seria] = CASE &#xD;
							WHEN ISNULL(ser.seria, 0) = 5 then SUBSTRING(TrN_NumerPelny, 0, CHARINDEX(''/'', TrN_NumerPelny, 0))&#xD;
							ELSE ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
							END&#xD;
	--WALUTA&#xD;
	,[Waluta]			= ISNULL(NULLIF(TrN_Waluta, ''''), @Wal)&#xD;
&#xD;
	--KONTRAHENT PIERWOTNY&#xD;
	,[Kontrahent Pierwotny Nazwa]		= pod1.Pod_Nazwa1&#xD;
	,[Kontrahent Pierwotny Kod]			= pod1.Pod_Kod	&#xD;
	,[Kontrahent Pierwotny Województwo] = ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'')&#xD;
	,[Kontrahent Pierwotny Powiat]		= ISNULL(NULLIF(pod1.Pod_Powiat		, ''''), ''(NIEPRZYPISANE)'')&#xD;
	,[Kontrahent Pierwotny Miasto]		= ISNULL(NULLIF(pod1.Pod_Miasto		, ''''), ''(NIEPRZYPISANE)'')&#xD;
	,[Kontrahent Pierwotny Kraj]		= ISNULL(NULLIF(pod1.Pod_Kraj		, ''''), ''(NIEPRZYPISANE)'') &#xD;
	,[Kontrahent Pierwotny NIP]			= ISNULL(NULLIF(pod1.Pod_NIP		, ''''), ''(BRAK)''			)&#xD;
	,[Kontrahent Pierwotny Grupa]		= ISNULL(NULLIF(pod1.Pod_Grupa		, ''''), ''Pozostali''		)&#xD;
    ,[Kontrahent Pierwotny Opiekun]		= CASE &#xD;
											WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
											WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod , ''(NIEPRZYPISANE)'')&#xD;
											ELSE ''(NIEPRZYPISANE)'' &#xD;
											END&#xD;
	,[Kontrahent Pierwotny Rodzaj] = REVERSE(STUFF(REVERSE(CONVERT(VARCHAR(100),RTRIM(&#xD;
										(CASE knt1.Knt_Rodzaj_Dostawca		WHEN 1 THEN ''Dostawca, ''			ELSE '''' END) +&#xD;
										(CASE knt1.Knt_Rodzaj_Odbiorca		WHEN 1 THEN ''Odbiorca, ''			ELSE '''' END) +&#xD;
										(CASE knt1.Knt_Rodzaj_Konkurencja	WHEN 1 THEN ''Konkurencja, ''		ELSE '''' END) +&#xD;
										(CASE knt1.Knt_Rodzaj_Partner		WHEN 1 THEN ''Partner, ''			ELSE '''' END) +&#xD;
										(CASE knt1.Knt_Rodzaj_Potencjalny	WHEN 1 THEN ''Klient potencjalny,'' ELSE '''' END)&#xD;
										))), 1, 1, ''''))&#xD;
	--KONTRAHENT&#xD;
	,[Kontrahent Nazwa]			= pod5.Pod_Nazwa1	&#xD;
	,[Kontrahent Kod]			= pod5.Pod_Kod&#xD;
	,[Kontrahent Województwo]	= ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'')&#xD;
	,[Kontrahent Miasto]			= ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'')&#xD;
	,[Kontrahent Powiat]			= ISNULL(NULLIF(pod5.Pod_Powiat, ''''),''(NIEPRZYPISANE)'')&#xD;
	,[Kontrahent Kraj]			= ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'')&#xD;
	,[Kontrahent NIP]			= ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'')&#xD;
	,[Kontrahent Grupa]			= ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'')&#xD;
	,[Kontrahent Opiekun]		= CASE knt3.Knt_OpiekunTyp&#xD;
									WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
									WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
									ELSE ''(NIEPRZYPISANE)'' &#xD;
									END &#xD;
	,[Kontrahent Rodzaj]		= reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
									(CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
									(CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
									(CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
									(CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
									(CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, ''''))&#xD;
	--ODBIORCA&#xD;
	,[Odbiorca Nazwa]			= pod7.Pod_Nazwa1&#xD;
	,[Odbiorca Kod]				= pod7.Pod_Kod &#xD;
	,[Odbiorca Województwo]		= ISNULL(NULLIF(pod7.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'')&#xD;
	,[Odbiorca Powiat]			= ISNULL(NULLIF(pod7.Pod_Powiat, ''''),''(NIEPRZYPISANE)'')&#xD;
	,[Odbiorca Miasto]			= ISNULL(NULLIF(pod7.Pod_Miasto, ''''),''(NIEPRZYPISANE)'')&#xD;
	,[Odbiorca Kraj]			=  ISNULL(NULLIF(pod7.Pod_Kraj, ''''),''(NIEPRZYPISANE)'')&#xD;
	,[Odbiorca NIP]				= ISNULL(NULLIF(pod7.Pod_NIP, ''''),''(BRAK)'')&#xD;
	,[Odbiorca Grupa]			= ISNULL(NULLIF(pod7.Pod_Grupa, ''''),''Pozostali'')&#xD;
	,[Operator Wprowadzający]	= zal.Ope_Kod &#xD;
	,[Operator Modyfikujący]	= mod.Ope_Kod&#xD;
&#xD;
	--KATEGORIA SZCZEGÓŁOWA&#xD;
	,[Kategoria Szczegółowa z Nagłówka] = ISNULL(kat1.Kat_KodSzczegol,	''(PUSTA)'')&#xD;
	,[Kategoria Szczegółowa z Elementu] = ISNULL(kat2.Kat_KodSzczegol,	''(PUSTA)'')&#xD;
	&#xD;
	--KATEGORIA OGÓLNA&#xD;
	,[Kategoria Ogólna z Nagłówka]		= ISNULL(kat1.Kat_KodOgolny,	''(PUSTA)'') &#xD;
	,[Kategoria Ogólna z Elementu]		= ISNULL(kat2.Kat_KodOgolny,	''(PUSTA)'') &#xD;
	&#xD;
	--PRODUKT&#xD;
	,[Produkt Nazwa]					= Twr_Nazwa &#xD;
	,[Produkt PKWiU]					= CASE TWR_SWW &#xD;
											WHEN '' '' THEN ''(NIEPRZYPISANE)'' &#xD;
											ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') &#xD;
											END&#xD;
	,[Produkt Dostawca]					= ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'') &#xD;
	,[Produkt Aktywny]					= CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END&#xD;
	,[Produkt Kod]						= Twr_Kod&#xD;
	,[Produkt Pełna Nazwa Grupy]		= poz.sciezka &#xD;
	,[Produkt Opis]						= CAST(Twr_Opis as VARCHAR(1024))&#xD;
	,[Produkt Waga KG]					= Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'')&#xD;
	,[Produkt Producent]				= ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'')&#xD;
	,[Produkt Marka]					= ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'')&#xD;
	,[Produkt Typ]						= CASE&#xD;
											WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
											WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
											WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
											WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
											ELSE ''(NIEOKREŚLONY)''&#xD;
										END &#xD;
&#xD;
&#xD;
	&#xD;
	,[Magazyn Kod]						= ISNULL(Mag.Mag_Symbol, ''(NIEPRZYPISANE)'')&#xD;
	,[Magazyn Docelowy Kod]				= ISNULL(MagDoc.Mag_Symbol, ''(NIEPRZYPISANE)'')&#xD;
	&#xD;
	,[Jednostka Miary]					= Twr_Jm&#xD;
	,[Jednostka Miary Pomocnicza]		= ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'')&#xD;
	&#xD;
	,[Czas Aktualny Miesiąc]			= CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END&#xD;
	,[Czas Aktualny Miesiąc Poprzedni]	= CASE &#xD;
											WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
											WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
											ELSE ''NIE'' &#xD;
											END&#xD;
&#xD;
/*--------DATY POINT&#xD;
	,[Data Operacji]	= REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
	,[Data Wystawienia] = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
*/&#xD;
&#xD;
----------DATY ANALIZY&#xD;
	,[Data Operacji Dzień]				= REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') &#xD;
	,[Data Operacji Tydzień Roku]		= (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ &#xD;
    ,[Data Operacji Miesiąc]			= MONTH(TrN_DataOpe) &#xD;
	,[Data Operacji Kwartał]			= DATEPART(quarter, TrN_DataOpe) &#xD;
	,[Data Operacji Rok]				= YEAR(TrN_DataOpe)&#xD;
	,[Data Wystawienia Dzień]			= REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') &#xD;
	,[Data Wystawienia Tydzień Roku]	= (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ &#xD;
    ,[Data Wystawienia Miesiąc]			= MONTH(TrN_DataWys) &#xD;
	,[Data Wystawienia Kwartał]			= DATEPART(quarter, TrN_DataWys)&#xD;
	,[Data Wystawienia Rok]				= YEAR(TrN_DataWys)&#xD;
&#xD;
----------KONTEKSTY&#xD;
	,[Dokument Numer __PROCID__WZ__] = CASE								&#xD;
											WHEN TrN_TypDokumentu = 312 THEN 25034&#xD;
											WHEN TrN_TypDokumentu = 303 THEN 25032&#xD;
											WHEN TrN_TypDokumentu = 317 THEN 25045&#xD;
											WHEN TrN_TypDokumentu = 307 THEN 25024&#xD;
											WHEN TrN_TypDokumentu = 304 THEN 25030&#xD;
											WHEN TrN_TypDokumentu = 318 THEN 25046&#xD;
											WHEN TrN_TypDokumentu = 306 THEN 25022&#xD;
											WHEN TrN_TypDokumentu = 313 THEN 25079&#xD;
											WHEN TrN_TypDokumentu = 314 THEN 25078&#xD;
										END&#xD;
	,[Dokument Numer __ORGID__]						= TrN_TrNId &#xD;
	,[Dokument Numer __DATABASE__]					= '''+@bazaFirmowa+'''&#xD;
	,[Kontrahent Pierwotny Nazwa __PROCID__]		= 20201 &#xD;
	,[Kontrahent Pierwotny Nazwa __ORGID__]			= pod1.Pod_PodId&#xD;
	,[Kontrahent Pierwotny Nazwa __DATABASE__]		= '''+@bazaFirmowa+''' &#xD;
	,[Kontrahent Pierwotny Kod __PROCID__]			= 20201 &#xD;
	,[Kontrahent Pierwotny Kod __ORGID__]			= pod1.Pod_PodId&#xD;
	,[Kontrahent Pierwotny Kod __DATABASE__]		= '''+@bazaFirmowa+''' &#xD;
	,[Kontrahent Nazwa __PROCID__]					= 20201 &#xD;
	,[Kontrahent Nazwa __ORGID__]					= pod5.Pod_PodId&#xD;
	,[Kontrahent Nazwa __DATABASE__]				= '''+@bazaFirmowa+''' &#xD;
	,[Kontrahent Kod __PROCID__Kontrahenci__]		= 20201 &#xD;
	,[Kontrahent Kod __ORGID__]						= pod5.Pod_PodId&#xD;
	,[Kontrahent Kod __DATABASE__]					= '''+@bazaFirmowa+'''&#xD;
	,[Produkt Nazwa __PROCID__]						= 25003&#xD;
	,[Produkt Nazwa __ORGID__]						= Twr_twrId&#xD;
	,[Produkt Nazwa __DATABASE__]					= '''+@bazaFirmowa+''' &#xD;
	,[Produkt Kod __PROCID__Towary__]				= 25003&#xD;
	,[Produkt Kod __ORGID__]						= Twr_twrId&#xD;
	,[Produkt Kod __DATABASE__]						='''+@bazaFirmowa+'''&#xD;
    ,[Magazyn Kod __PROCID__Magazyny__]				= 29056 &#xD;
	,[Magazyn Kod __ORGID__]						= Mag.Mag_MagId &#xD;
	,[Magazyn Kod __DATABASE__]						= '''+@bazaFirmowa+''' &#xD;
    ,[Magazyn Docelowy Kod __PROCID__Magazyny__]	= 29056&#xD;
	,[Magazyn Docelowy Kod __ORGID__]				= MagDoc.Mag_MagId&#xD;
	,[Magazyn Docelowy Kod __DATABASE__]			= '''+@bazaFirmowa+'''  &#xD;
	'&#xD;
    + @kolumny &#xD;
	+ @atrybuty &#xD;
	+ @atrybutyDok &#xD;
	+ @atrybutyTwr &#xD;
	+ @atrybutyPoz&#xD;
set @SqlTabele  = &#xD;
'			FROM cdn.TraNag &#xD;
			JOIN cdn.TraElem		TR		ON TrE_TrNID = TrN_TrNID &#xD;
	   LEFT JOIN #tmpSeria			ser		ON TrN_DDfId = DDf_DDfID&#xD;
	   LEFT JOIN CDN.DokDefinicje	dd		ON TrN_DDfId = dd.DDf_DDfID&#xD;
 LEFT OUTER JOIN CDN.Kontrahenci	knt1	ON TrE_PodID = Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
 LEFT OUTER JOIN CDN.PodmiotyView	pod1	ON TrE_PodID = pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
 LEFT OUTER JOIN cdn.PodmiotyView	pod2	ON Knt_OpiekunId = pod2.Pod_PodId AND Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
 LEFT OUTER JOIN CDN.Towary					ON TrE_TwrId = Twr_TwrId&#xD;
	   LEFT JOIN CDN.Producenci				ON Prd_PrdId = Twr_PrdId&#xD;
	   LEFT JOIN CDN.Marki					ON Mrk_MrkId = Twr_MrkId&#xD;
	   LEFT JOIN CDN.TwrCeny				ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
 LEFT OUTER JOIN CDN.Magazyny		Mag		ON (CASE WHEN TrN_TypDokumentu = 318 THEN TrN_MagZrdId ELSE ISNULL(TrE_MagId,TrN_MagZrdId) END) = Mag.Mag_MagId &#xD;
 LEFT OUTER JOIN CDN.Magazyny		MagDoc	ON MagDoc.Mag_MagId = TrN_MagDocId&#xD;
 LEFT OUTER JOIN CDN.Kategorie		kat1	ON TrN_KatID = kat1.Kat_KatID&#xD;
 LEFT OUTER JOIN CDN.Kategorie		kat2	ON TrE_KatID = kat2.Kat_KatID&#xD;
	   LEFT JOIN #tmpTwrGr			Poz		ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
	   LEFT JOIN #tmpKonAtr			KonAtr	ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
	   LEFT JOIN #tmpDokAtr			DokAtr	ON TrN_TrNID = DokAtr.DAt_TrNId&#xD;
	   LEFT JOIN #tmpTwrAtr			TwrAtr	ON TrE_TwrId = TwrAtr.TwA_TwrId&#xD;
	   LEFT JOIN #tmpPozatr			PozAtr	ON PozAtr.TrA_TrEId = TrE_TrEId  &#xD;
	   LEFT JOIN '+@Operatorzy+'	opk		ON Knt_OpiekunId = opk.Ope_OpeId AND Knt_OpiekunTyp = 8 &#xD;
	   LEFT JOIN '+@Operatorzy+'	zal		ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	   LEFT JOIN '+@Operatorzy+'	mod		ON TrN_OpeModID = mod.Ope_OpeId&#xD;
 LEFT OUTER JOIN cdn.PodmiotyView	pod5	ON pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
 LEFT OUTER JOIN CDN.Kontrahenci	knt3	ON pod5.Pod_PodID = knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
 LEFT OUTER JOIN CDN.Kategorie		kat5	ON knt3.Knt_KatID = kat5.Kat_KatID&#xD;
 LEFT OUTER JOIN cdn.PodmiotyView	pod6	ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
	   LEFT JOIN #tmpKonAtr			KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
 LEFT OUTER JOIN CDN.PodmiotyView	pod7	ON TrN_OdbID = pod7.Pod_PodId AND TrN_OdbiorcaTyp = pod7.Pod_PodmiotTyp&#xD;
	   LEFT JOIN '+@Operatorzy+'	opk3	ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
	   LEFT JOIN CDN.Kontrahenci	knt4	ON Twr_KntId = knt4.Knt_KntId&#xD;
	   LEFT JOIN '+@Bazy+'			BAZ		ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
WHERE TrN_TypDokumentu IN (303, 304, 306, 307, 312, 313, 314, 317, 318)&#xD;
						 /* PW,  RW,  WZ,  PZ,  MM, PKA, WKA, PWP, RWS */&#xD;
  AND TrN_Bufor	  &lt;&gt; -1&#xD;
  AND TrE_Aktywny &lt;&gt;  0'&#xD;
exec (@SqlKolumny + @SqlTabele)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
  DROP TABLE #tmpMarza</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8sJ7a+Ib5ljeiB+o1CVa8K09VmwT3LHj3ChZA6BezNBwrS1BzJzaTn10QuwI3PMujIBT6U16yWR6Gt6rBj6xMh0cN/xE38i+czy1N+qeZhEJwbJdTVWZo7RtrWNzjM6tZzQ9zLMJBf27+HoUEnugUTGHfv8cmn1LqYI8l10yxoVu/5+89jLa2Ai</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Cena Domyślna" caption="Cena Domyślna" type="measure" formatString="c2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Ilość" caption="Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Jednostka Pomocnicza" caption="Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Marża" caption="Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Brutto" caption="Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Netto" caption="Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Waluta" caption="Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Typ" caption="Dokument Typ" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Powiat" caption="Odbiorca Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca NIP" caption="Odbiorca NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Elementu" caption="Kategoria Szczegółowa z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Elementu" caption="Kategoria Ogólna z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Waga KG" caption="Produkt Waga KG" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Kod" caption="Magazyn Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Magazyn Docelowy Kod" caption="Magazyn Docelowy Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut EMAIL" caption="Kontrahent Pierwotny Atrybut EMAIL" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut EMAIL" caption="Kontrahent Atrybut EMAIL" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut NUMER SERYJNY" caption="Dokument Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut EMAIL (K)" caption="Dokument Atrybut EMAIL (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut WAGA" caption="Produkt Atrybut WAGA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NUMER SERYJNY" caption="Pozycja Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="False" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions /&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields /&gt;&#xD;
  &lt;rowFields /&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields /&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Dokumentów Magazynowych wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o sprzedaży i zakupach w firmie na podstawie dokumentów magazynowych. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Analizy oparte są o dokumenty PW, RW, PZ, WZ, MM, PKA, WKA, PWP, RWS. Niebrane pod uwagę są dokumenty anulowane. Do poprawnej analizy należy wybrać typ dokumentu, dla którego ma zostać wyświetlony raport.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (WZ, PZ itp.). &#xD;
TraElem - Tabela z elementami dokumentów (WZ, PZ itp.).</a:description><a:id>11</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>11. Raport Dokumentów Magazynowych</a:mainLinkName><a:modifiedOn>2025-05-26T02:41:24.837</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-03-16T09:39:07.55</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
&#xD;
/*&#xD;
* Raport Stanów Magazynowych na Dzień&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @sqlA nvarchar(max), @atrybutyTwr varchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Liczenie ostatniej daty w bazie&#xD;
SELECT TwI_TwrId [TwI_TId], ISNULL(TwI_MagId,0) [TwI_MId], MAX(TwI_Data) [TwI_OstatniaData] INTO #TwrIlosci&#xD;
FROM CDN.TwrIlosci&#xD;
WHERE TwI_Data &lt;= @DATA&#xD;
GROUP BY TwI_TwrId, TwI_MagId&#xD;
&#xD;
--Liczenie korekty braków&#xD;
SELECT TwI_TwrId [TwI_TId], SUM((CASE WHEN TwI_MagId IS NULL THEN 1 ELSE -1 END)*TwI_Braki) [Braki] INTO #TwrBraki&#xD;
FROM CDN.TwrIlosci&#xD;
JOIN #TwrIlosci TI ON TI.TwI_TId = TwI_TwrId AND TI.TwI_MId=ISNULL(TwI_MagId,0) AND TI.TwI_OstatniaData = TwI_Data&#xD;
GROUP BY TwI_TwrId&#xD;
&#xD;
--Tworzenie tabeli tymczasowej z warością sprzedaży&#xD;
SELECT TrE_MagId, TrE_TwrId, SUM(TrE_WartoscNetto) SprzedazWartosc, SUM(TrE_Ilosc) SprzedazIlosc&#xD;
INTO #tmpSprzedaz &#xD;
FROM CDN.TraElem&#xD;
WHERE TrE_Aktywny &lt;&gt; 0 &#xD;
    AND TrE_TypDokumentu IN (-1, 302, 305) &#xD;
    AND TrE_DataOpe = @Data&#xD;
GROUP BY TrE_MagId, TrE_TwrId   &#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select =&#xD;
'SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
&#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_Nazwa [Produkt Nazwa], &#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
    Twr_JM [Produkt Jednostka Miary], ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis],&#xD;
    Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'') [Produkt Waga KG],&#xD;
    Mag_Symbol [Magazyn Kod],&#xD;
    CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
    END [Produkt Typ], TwC_Wartosc [Cena Domyślna], ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    ISNULL(kat.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria Szczegółowa], ISNULL(kat.Kat_KodOgolny, ''(PUSTA)'') [Produkt Kategoria Ogólna], &#xD;
    ISNULL(TwI_Ilosc, 0) [Ilość], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),ISNULL(TwI_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL, 0)) ELSE 0 END [Ilość Jednostka Pomocnicza], &#xD;
    ISNULL(TwI_Rezerwacje, 0) [Rezerwacje], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),ISNULL(TwI_Rezerwacje*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL, 0)) ELSE 0 END  [Rezerwacje Jednostka Pomocnicza], &#xD;
    ISNULL(TwI_Braki, 0) [Braki], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),ISNULL(TwI_Braki*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL, 0)) ELSE 0 END [Braki Jednostka Pomocnicza], &#xD;
    ISNULL(TwI_Zamowienia, 0) [Zamówienia],&#xD;
    ISNULL(TwI_Wartosc, 0) [Zamówienia Wartość], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),ISNULL(TwI_Zamowienia*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL, 0)) ELSE 0 END [Zamówienia Jednostka Pomocnicza],&#xD;
    ISNULL(TwI_Wartosc, 0) [Wartość Netto], ISNULL(TwI_Wartosc, 0 ) * (1 + Twr_Stawka/100) [Wartość Brutto],&#xD;
    NULLIF(Twr_IloscMin,0) [Ilość Minimalna], NULLIF(Twr_IloscMax,0) [Ilość Maksymalna],&#xD;
    SprzedazWartosc [Sprzedaż Wartość Netto], SprzedazIlosc [Sprzedaż Ilość]&#xD;
    ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
    ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
/*&#xD;
    ----------KONTEKSTY&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,29056 [Magazyn Kod __PROCID__Magazyny__], Mag_MagId [Magazyn Kod __ORGID__],'''+@bazaFirmowa+''' [Magazyn Kod __DATABASE__]&#xD;
*/&#xD;
    ' + @kolumny + @atrybutyTwr + '&#xD;
FROM CDN.TwrIlosci&#xD;
    LEFT OUTER JOIN CDN.Magazyny ON Mag_MagId = TwI_MagId&#xD;
    JOIN CDN.Towary ON TwI_TwrId = Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
    LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat ON Twr_KatId=kat.Kat_KatID&#xD;
    JOIN #TwrIlosci ON TwI_TId = TwI_TwrId AND TwI_OstatniaData = TwI_Data AND TwI_MId = TwI_MagId&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
    LEFT JOIN #tmpTwrAtr TwrAtr ON TwI_TwrId  = TwrAtr.TwA_TwrId&#xD;
    LEFT OUTER JOIN #tmpSprzedaz ON TwI_MagId = TrE_MagId AND TwI_TwrId = TrE_TwrId&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
'&#xD;
&#xD;
IF @ZEROWE = 'NIE' SET @select = @select + ' WHERE ISNULL(TwI_Ilosc, 0) &lt;&gt; 0'&#xD;
&#xD;
SET @select = @select + '&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    &#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
    Twr_JM [Produkt Jednostka Miary], ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis],&#xD;
    Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'') [Produkt Waga KG],&#xD;
    ''(Korekta Braków)'' [Magazyn Kod],&#xD;
    CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
    END [Produkt Typ], TwC_Wartosc [Cena Domyślna], ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    ISNULL(kat.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria Szczegółowa], ISNULL(kat.Kat_KodOgolny, ''(PUSTA)'') [Produkt Kategoria Ogólna], &#xD;
    NULL [Ilość], &#xD;
    NULL [Ilość Jednostka Pomocnicza], &#xD;
    NULL [Rezerwacje], &#xD;
    NULL  [Rezerwacje Jednostka Pomocnicza], &#xD;
    Braki [Braki], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),ISNULL(Braki*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL, 0)) ELSE 0 END [Braki Jednostka Pomocnicza], &#xD;
    NULL[Zamówienia], &#xD;
    NULL [Zamówienia Wartość], &#xD;
    NULL [Zamówienia Jednostka Pomocnicza],&#xD;
    NULL [Wartość Netto], NULL [Wartość Brutto],&#xD;
    NULLIF(Twr_IloscMin,0) [Ilość Minimalna], NULLIF(Twr_IloscMax,0) [Ilość Maksymalna],&#xD;
    NULL [Sprzedaż Wartość Netto], NULL [Sprzedaż Ilość]&#xD;
    ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
    ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
/*&#xD;
    ----------KONTEKSTY&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,29056 [Magazyn Kod __PROCID__Magazyny__], 1 [Magazyn Kod __ORGID__],'''+@bazaFirmowa+''' [Magazyn Kod __DATABASE__]&#xD;
*/&#xD;
    ' + @kolumny + @atrybutyTwr + '&#xD;
FROM CDN.Towary&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
    LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat ON Twr_KatId=kat.Kat_KatID&#xD;
    JOIN #TwrBraki ON TwI_TId = Twr_TwrId AND Braki &lt;&gt; 0&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
    LEFT JOIN #tmpTwrAtr TwrAtr ON Twr_TwrId  = TwrAtr.TwA_TwrId&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
'&#xD;
&#xD;
    IF @ZEROWE = 'TAK' SET @select = @select +&#xD;
'&#xD;
UNION ALL&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
    Twr_JM [Produkt Jednostka Miary], ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis],&#xD;
    Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'') [Produkt Waga KG],&#xD;
    ''(Korekta Braków)'' [Magazyn Kod],&#xD;
    CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
    END [Produkt Typ], TwC_Wartosc [Cena Domyślna], ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    ISNULL(kat.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria Szczegółowa], ISNULL(kat.Kat_KodOgolny, ''(PUSTA)'') [Produkt Kategoria Ogólna], &#xD;
    0 [Ilość], &#xD;
    0 [Ilość Jednostka Pomocnicza], &#xD;
    0 [Rezerwacje], &#xD;
    0  [Rezerwacje Jednostka Pomocnicza], &#xD;
    0 AS [Braki], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),ISNULL(0*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL, 0)) ELSE 0 END [Braki Jednostka Pomocnicza], &#xD;
    0[Zamówienia], &#xD;
    0 [Zamówienia Wartość], &#xD;
    0 [Zamówienia Jednostka Pomocnicza],&#xD;
    0 [Wartość Netto], 0 [Wartość Brutto],&#xD;
    NULLIF(Twr_IloscMin,0) [Ilość Minimalna], NULLIF(Twr_IloscMax,0) [Ilość Maksymalna],&#xD;
    NULL [Sprzedaż Wartość Netto], NULL [Sprzedaż Ilość]&#xD;
    ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
    ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
,GETDATE() [Data Analizy]&#xD;
/*&#xD;
    ----------KONTEKSTY&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,29056 [Magazyn Kod __PROCID__Magazyny__], 1 [Magazyn Kod __ORGID__],'''+@bazaFirmowa+''' [Magazyn Kod __DATABASE__]&#xD;
*/&#xD;
    ' + @kolumny + @atrybutyTwr + '&#xD;
FROM CDN.Towary&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
    LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat ON Twr_KatId=kat.Kat_KatID&#xD;
    LEFT OUTER JOIN #tmpSprzedaz s ON  Twr_TwrId = s.TrE_TwrId&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN #tmpTwrAtr TwrAtr ON Twr_TwrId  = TwrAtr.TwA_TwrId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
WHERE Twr_TwrId NOT IN (SELECT TwI_TwrId  FROM CDN.TwrIlosci)&#xD;
'&#xD;
--IF @ZEROWE = 'NIE' SET @select = @select + ' WHERE ISNULL(TwI_Ilosc, 0) &lt;&gt; 0'&#xD;
    &#xD;
EXEC(@select)&#xD;
&#xD;
DROP TABLE #TwrIlosci&#xD;
DROP TABLE #TwrBraki&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSprzedaz&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QLNy8SvsWvjndP4rYWmIrmw65/eZ7QPiim3cKUThrJOp91uo2s2QytZVCI0ahIBHPzdhq77ZDLGS8LuZiEj0zYsIgS5K2HrbyaqCJT/6WDiznZVF9elSOhzVl2dH/e0c9PnG3YSMpcSF3Y8x5vWCkpLScwlLQEW3Qqe7R0u8VkZs9N9mOdplX8Q/6cokntZkj4+ymM9XCT/A==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary" caption="Produkt Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Kod" caption="Magazyn Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena Domyślna" caption="Cena Domyślna" type="measure" formatString="c2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Szczegółowa" caption="Produkt Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Ogólna" caption="Produkt Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ilość" caption="Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Jednostka Pomocnicza" caption="Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rezerwacje" caption="Rezerwacje" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rezerwacje Jednostka Pomocnicza" caption="Rezerwacje Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Braki" caption="Braki" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Braki Jednostka Pomocnicza" caption="Braki Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zamówienia" caption="Zamówienia" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zamówienia Jednostka Pomocnicza" caption="Zamówienia Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Netto" caption="Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Brutto" caption="Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Minimalna" caption="Ilość Minimalna" type="measure" formatString="" aggregate="Min" /&gt;&#xD;
    &lt;column name="Ilość Maksymalna" caption="Ilość Maksymalna" type="measure" formatString="" aggregate="Max" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Netto" caption="Sprzedaż Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[8e707a04-4bc8-4d29-aed2-bf24728889d8]" caption="Wskaźnik Wartość" type="measure" formatString="n4" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[3f4a04bb-805c-479e-bad1-459095d518ab]" caption="Wskaźnik Ilość" type="measure" formatString="n4" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATA&lt;/Name&gt;&#xD;
    &lt;Label&gt;Stan magazynów na dzień:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data, dla której zostanie wykonana analiza.&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-09-18&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;ZEROWE&lt;/Name&gt;&#xD;
    &lt;Label&gt;Pokazuj stany zerowe:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Parametr określający czy w raporcie mają być widoczne stany zerowe&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;'TAK';'NIE'&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;'NIE'&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="381" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[8e707a04-4bc8-4d29-aed2-bf24728889d8]" caption="Wskaźnik Wartość" formula="IIF(Wartość Netto = 0.0,&amp;#xD;&amp;#xA;999999999.9999,&amp;#xD;&amp;#xA;Sprzedaż Wartość Netto/Wartość Netto&amp;#xD;&amp;#xA;)" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[3f4a04bb-805c-479e-bad1-459095d518ab]" caption="Wskaźnik Ilość" formula="IIF(Ilość = 0.0,&amp;#xD;&amp;#xA;999999999.9999,&amp;#xD;&amp;#xA;Sprzedaż Ilość/Ilość&amp;#xD;&amp;#xA;)" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Stanów Magazynowych na Dzień wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport prezentuje stany ilościowe i wartościowe magazynów w zadanym dniu. Dzień, na który ma zostać wykonana analiza należy podać podczas uruchamiania raportu. Wartości prezentowane są w walucie systemowej w cenie zakupu.&#xD;
&#xD;
Raport oparty na tabeli:&#xD;
CDN.TwrIlosci - tabela przechowująca agregaty zawierające stany magazynowe</a:description><a:id>12</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>12. Raport Stanów Magazynowych na Dzień</a:mainLinkName><a:modifiedOn>2025-02-04T12:12:32.723</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-03-19T10:35:53.25</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/*&#xD;
* Raport Stanów Magazynowych w Zakresie Dat &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @sqlA nvarchar(max), @atrybutyTwr varchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Tworzenie tabeli tymczasowej dat&#xD;
DECLARE @tmpDataOd DATETIME;&#xD;
SET @tmpDataOd = @DataOd&#xD;
CREATE TABLE #TmpDates (Data DATETIME)&#xD;
&#xD;
WHILE @tmpDataOd&lt;=@DataDo&#xD;
BEGIN&#xD;
    INSERT INTO #TmpDates VALUES (@tmpDataOd)&#xD;
    SET @tmpDataOd = @tmpDataOd + 1&#xD;
END                 &#xD;
    &#xD;
CREATE UNIQUE CLUSTERED INDEX bu ON #TmpDates ([Data])&#xD;
&#xD;
--Tworzenie tabeli tymczasowej z warością sprzedaży&#xD;
SELECT TrE_MagId, TrE_TwrId, TrE_DataOpe, SUM(TrE_WartoscNetto) SprzedazWartosc, SUM(TrE_Ilosc) SprzedazIlosc&#xD;
INTO #tmpSprzedaz &#xD;
FROM CDN.TraElem&#xD;
WHERE TrE_Aktywny &lt;&gt; 0 &#xD;
    AND TrE_TypDokumentu IN (-1, 302, 305) &#xD;
    AND TrE_DataOpe BETWEEN @DataOd AND @DataDo&#xD;
GROUP BY TrE_MagId, TrE_TwrId, TrE_DataOpe  &#xD;
&#xD;
SELECT TrE_MagId AS MagazynID, TrE_TwrId AS TowarID, Max(TrE_DataOpe) [Data Ostatniego Wydania]&#xD;
INTO #tmpDataWydania &#xD;
FROM CDN.TraElem&#xD;
WHERE TrE_Aktywny &lt;&gt; 0 &#xD;
    AND TrE_TypDokumentu IN (-1, 302,304, 305, 314,306,318, 320,321,322 ) &#xD;
GROUP BY TrE_TwrId ,TrE_MagId   &#xD;
&#xD;
SELECT TrE_MagId AS MagazynID, TrE_TwrId AS TowarID, Max(TrE_DataOpe) [Data Ostatniego Przyjęcia]&#xD;
INTO #tmpDataDostawy&#xD;
FROM CDN.TraElem&#xD;
WHERE TrE_Aktywny &lt;&gt; 0 &#xD;
    AND TrE_TypDokumentu IN ( 303,307,312,313,317,350, 301) &#xD;
GROUP BY TrE_TwrId ,TrE_MagId   &#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Właściwe zapytanie    &#xD;
set @select =&#xD;
'DECLARE @IloscDni INT; SET @IloscDni = DATEDIFF ( D, ''' + convert(varchar, @DataOd) + ''', ''' + convert(varchar, @DataDo) + ''') + 1;                    &#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
    Twr_JM [Produkt Jednostka Miary], ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis],&#xD;
    Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'') [Produkt Waga KG],&#xD;
    Mag_Symbol [Magazyn Kod],&#xD;
    CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
    END [Produkt Typ], TwC_Wartosc [Cena Domyślna], ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    ISNULL(NULLIF(Twr_EAN, ''''), ''(BRAK)'')  [Produkt EAN],&#xD;
    ISNULL(kat.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria Szczegółowa], ISNULL(kat.Kat_KodOgolny, ''(PUSTA)'') [Produkt Kategoria Ogólna], &#xD;
    ISNULL(TWI.TwI_Ilosc, 0) [Ilość], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),ISNULL(TWI.TwI_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL, 0)) ELSE 0 END [Ilość Jednostka Pomocnicza], &#xD;
    ISNULL(TWI.TwI_Rezerwacje, 0) [Rezerwacje], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),ISNULL(TWI.TwI_Rezerwacje*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL, 0)) ELSE 0 END [Rezerwacje Jednostka Pomocnicza], &#xD;
    ISNULL(TWI.TwI_Braki, 0) [Braki], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),ISNULL(TWI.TwI_Braki*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL, 0)) ELSE 0 END [Braki Jednostka Pomocnicza], &#xD;
    ISNULL(TWI.TwI_Zamowienia, 0) [Zamówienia], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),ISNULL(TWI.TwI_Zamowienia*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL, 0)) ELSE 0 END [Zamówienia Jednostka Pomocnicza],&#xD;
    ISNULL(TWI.TwI_Wartosc, 0) [Wartość Netto], &#xD;
    ISNULL(TWI.TwI_Wartosc, 0 ) * (1 + Twr_Stawka/100) [Wartość Brutto], @IloscDni [Liczba Dni],&#xD;
    NULLIF(Twr_IloscMin,0) [Ilość Minimalna], NULLIF(Twr_IloscMax,0) [Ilość Maksymalna],&#xD;
    CASE WHEN twi3.data = convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120) THEN TWI.TwI_Ilosc ELSE 0 END [Ilość Ostatni Dzień],&#xD;
    SprzedazWartosc [Sprzedaż Wartość Netto], SprzedazIlosc [Sprzedaż Ilość], NULL [Ilość Sztuk Aktualnie Otwartych Zamówień u Dostawców],&#xD;
    CASE WHEN twi3.data = eom.eom THEN TWI.TwI_Ilosc ELSE 0 END [Ilość M],&#xD;
    CASE WHEN twi3.data = eom.eom THEN ISNULL(TWI.TwI_Wartosc, 0) ELSE 0 END [Wartość Netto M],&#xD;
    CASE WHEN twi3.data = eom.eom THEN ISNULL(TWI.TwI_Wartosc, 0 ) * (1 + Twr_Stawka/100) ELSE 0 END [Wartość Brutto M],&#xD;
    CASE WHEN twi3.data = eow.eow THEN TWI.TwI_Ilosc ELSE 0 END [Ilość T],&#xD;
    CASE WHEN twi3.data = eow.eow THEN ISNULL(TWI.TwI_Wartosc, 0) ELSE 0 END [Wartość Netto T],&#xD;
    CASE WHEN twi3.data = eow.eow THEN ISNULL(TWI.TwI_Wartosc, 0 ) * (1 + Twr_Stawka/100) ELSE 0 END [Wartość Brutto T],&#xD;
    [Data Ostatniego Wydania],&#xD;
    [Data Ostatniego Przyjęcia]&#xD;
    ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
    ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
    /*&#xD;
    ----------DATA POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), twi3.data, 111), ''/'', ''-'') [Data]&#xD;
*/&#xD;
    ----------DATA ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), twi3.data, 111), ''/'', ''-'') [Data Dzień], (datepart(DY, datediff(d, 0, twi3.data) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, twi3.data)*/ [Data Tydzień Roku]&#xD;
    ,MONTH(twi3.data) [Data Miesiąc], DATEPART(quarter, twi3.data) [Data Kwartał], YEAR(twi3.data) [Data Rok] &#xD;
    ,GETDATE() [Data Analizy]&#xD;
    ----------KONTEKSTY&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,29056 [Magazyn Kod __PROCID__Magazyny__], Mag_MagId [Magazyn Kod __ORGID__],'''+@bazaFirmowa+''' [Magazyn Kod __DATABASE__]&#xD;
&#xD;
    ' + @kolumny + @atrybutyTwr + '                                     &#xD;
FROM cdn.TwrIlosci TWI&#xD;
    JOIN (&#xD;
        SELECT MAX(TwI_Data) as MaxData, TwI_MagId, TwI_TwrId, Data &#xD;
        FROM CDN.TwrIlosci TWI2&#xD;
        CROSS JOIN #TmpDates &#xD;
        WHERE TWI2.TwI_MagId IS NOT NULL AND TWI2.TwI_Data &lt;= Data&#xD;
        GROUP BY  TWI2.TwI_MagId, TWI2.TwI_TwrId, data &#xD;
    )TWI3 ON TWI3.TwI_TwrId = TWI.TwI_TwrId AND TWI3.TwI_MagId = TWI.TwI_MagId AND TWI3.MaxData = TWI.TwI_Data  &#xD;
    JOIN CDN.Towary ON TWI.TwI_TwrId = Twr_TwrId    &#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
    LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
    JOIN CDN.Magazyny ON TWI.TwI_MagId = Mag_MagId  &#xD;
    LEFT OUTER JOIN CDN.Kategorie kat ON Twr_KatId=kat.Kat_KatID&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
    LEFT JOIN #tmpTwrAtr TwrAtr ON TWI.TwI_TwrId  = TwrAtr.TwA_TwrId &#xD;
    LEFT OUTER JOIN #tmpSprzedaz ON TWI.TwI_MagId = TrE_MagId AND TWI.TwI_TwrId = TrE_TwrId AND twi3.data = TrE_DataOpe&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN &#xD;
    (select distinct eomonth(data) eom from #TmpDates) eom on eom.eom = twi3.data&#xD;
    LEFT JOIN&#xD;
    (select distinct DATEADD(wk, DATEDIFF(wk, 6, data), 6) eow from #TmpDates) eow on eow.eow = twi3.data&#xD;
    LEFT JOIN #tmpDataWydania dw on TWI.TwI_TwrId = dw.TowarID AND TWI.Twi_MagID = dw.MagazynID&#xD;
    LEFT JOIN #tmpDataDostawy  dd on TWI.TwI_TwrId = dd.TowarID AND TWI.Twi_MagID = dd.MagazynID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
WHERE TWI.TwI_MagId IS NOT NULL'&#xD;
&#xD;
IF @ZEROWE = 'NIE' SET @select = @select + ' AND (ISNULL(TwI_Ilosc, 0) &lt;&gt; 0 OR SprzedazWartosc &lt;&gt; 0)&#xD;
&#xD;
union all&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_Nazwa [Produkt Nazwa], &#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
    Twr_JM [Produkt Jednostka Miary], ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis],&#xD;
    Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'') [Produkt Waga KG],&#xD;
    Mag_Symbol [Magazyn Kod],&#xD;
    CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
    END [Produkt Typ], TwC_Wartosc [Cena Domyślna], ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    ISNULL(NULLIF(Twr_EAN, ''''), ''(BRAK)'')  [Produkt EAN],&#xD;
    ISNULL(kat.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria Szczegółowa], ISNULL(kat.Kat_KodOgolny, ''(PUSTA)'') [Produkt Kategoria Ogólna], &#xD;
    NULL [Ilość], &#xD;
    NULL [Ilość Jednostka Pomocnicza], &#xD;
    NULL [Rezerwacje], &#xD;
    NULL [Rezerwacje Jednostka Pomocnicza], &#xD;
    NULL [Braki], &#xD;
    NULL [Braki Jednostka Pomocnicza], &#xD;
    NULL [Zamówienia], &#xD;
    NULL [Zamówienia Jednostka Pomocnicza],&#xD;
    NULL [Wartość Netto], &#xD;
    NULL [Wartość Brutto], NULL [Liczba Dni],&#xD;
    NULL [Ilość Minimalna],&#xD;
    NULL [Ilość Maksymalna],&#xD;
    NULL [Ilość Ostatni Dzień],&#xD;
    NULL [Sprzedaż Wartość Netto], NULL [Sprzedaż Ilość],&#xD;
     TrE_Ilosc [Ilość Sztuk Aktualnie Otwartych Zamówień u Dostawców],&#xD;
        NULL [Ilość M],&#xD;
    NULL [Wartość Netto M],&#xD;
    NULL [Wartość Brutto M],&#xD;
    NULL [Ilość T],&#xD;
    NULL [Wartość Netto T],&#xD;
    NULL [Wartość Brutto T],&#xD;
    NULL [Data Ostatniego Wydania],&#xD;
    NULL [Data Ostatniego Przyjęcia]&#xD;
    ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
    ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120), 111), ''/'', ''-'') [Data]&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120), 111), ''/'', ''-'') [Data Dzień], (datepart(DY, datediff(d, 0, convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120)) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120))*/ [Data Tydzień Roku] &#xD;
    ,MONTH(convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120)) [Data Miesiąc], DATEPART(quarter, convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120)) [Data Kwartał], YEAR(convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120)) [Data Rok]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
    ----------KONTEKSTY&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,29056 [Magazyn Kod __PROCID__Magazyny__], Mag_MagId [Magazyn Kod __ORGID__],'''+@bazaFirmowa+''' [Magazyn Kod __DATABASE__]&#xD;
&#xD;
    ' + @kolumny + @atrybutyTwr + '                                         &#xD;
FROM  (select TrE_TwrId,TrE_MagId,sum(TrE_Ilosc) TrE_Ilosc from cdn.TraNag &#xD;
left join cdn.TraElem on TrN_TrNID = TrE_TrNId&#xD;
where TrN_DataDok &lt;= convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120)&#xD;
and TrN_TypDokumentu = 309 and TrN_ZwroconoCalaIlosc &lt;3&#xD;
group by TrE_TwrId,TrE_MagId&#xD;
) a&#xD;
left join cdn.Towary on a.TrE_TwrId = Twr_TwrId&#xD;
left join cdn.Magazyny on Mag_MagId = a.TrE_MagId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
    LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat ON Twr_KatId=kat.Kat_KatID&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
    LEFT JOIN #tmpTwrAtr TwrAtr ON a.TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
'&#xD;
&#xD;
    IF @ZEROWE = 'TAK' SET @select = @select +&#xD;
    ' &#xD;
    union all&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_Nazwa [Produkt Nazwa], &#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
    Twr_JM [Produkt Jednostka Miary], ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis],&#xD;
    Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'') [Produkt Waga KG],&#xD;
    NULL AS [Magazyn Kod],&#xD;
    CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
    END [Produkt Typ], TwC_Wartosc [Cena Domyślna], ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    ISNULL(NULLIF(Twr_EAN, ''''), ''(BRAK)'')  [Produkt EAN],&#xD;
    ISNULL(kat.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria Szczegółowa], ISNULL(kat.Kat_KodOgolny, ''(PUSTA)'') [Produkt Kategoria Ogólna], &#xD;
    0 [Ilość], &#xD;
    0 [Ilość Jednostka Pomocnicza], &#xD;
    0 [Rezerwacje], &#xD;
    0 [Rezerwacje Jednostka Pomocnicza], &#xD;
    0 [Braki], &#xD;
    0 [Braki Jednostka Pomocnicza], &#xD;
    0 [Zamówienia], &#xD;
    0 [Zamówienia Jednostka Pomocnicza],&#xD;
    0 [Wartość Netto], &#xD;
    0 [Wartość Brutto], NULL [Liczba Dni],&#xD;
    NULLIF(Twr_IloscMin,0) [Ilość Minimalna],&#xD;
    NULLIF(Twr_IloscMax,0) [Ilość Maksymalna],&#xD;
    0 [Ilość Ostatni Dzień],&#xD;
    NULL [Sprzedaż Wartość Netto], NULL [Sprzedaż Ilość],&#xD;
     NULL [Ilość Sztuk Aktualnie Otwartych Zamówień u Dostawców],&#xD;
        NULL [Ilość M],&#xD;
    0 [Wartość Netto M],&#xD;
    0 [Wartość Brutto M],&#xD;
    0 [Ilość T],&#xD;
    0 [Wartość Netto T],&#xD;
    0 [Wartość Brutto T],&#xD;
    NULL [Data Ostatniego Wydania],&#xD;
    NULL [Data Ostatniego Przyjęcia]&#xD;
    ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
    ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120), 111), ''/'', ''-'') [Data]&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120), 111), ''/'', ''-'') [Data Dzień], (datepart(DY, datediff(d, 0, convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120)) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120))*/ [Data Tydzień Roku] &#xD;
    ,MONTH(convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120)) [Data Miesiąc], DATEPART(quarter, convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120)) [Data Kwartał], YEAR(convert(datetime,''' + convert(varchar, @DataDo, 120) + ''', 120)) [Data Rok]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
    ----------KONTEKSTY&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,29056 [Magazyn Kod __PROCID__Magazyny__], 1 [Magazyn Kod __ORGID__],'''+@bazaFirmowa+''' [Magazyn Kod __DATABASE__]&#xD;
&#xD;
    ' + @kolumny + @atrybutyTwr + '                                         &#xD;
FROM CDN.Towary&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
    LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat ON Twr_KatId=kat.Kat_KatID&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
    LEFT JOIN #tmpTwrAtr TwrAtr ON tWR_TwrId  = TwrAtr.TwA_TwrId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
WHERE Twr_TwrId NOT IN (SELECT TwI_TwrId  FROM CDN.TwrIlosci)&#xD;
'&#xD;
&#xD;
EXEC(@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #TmpDates&#xD;
DROP TABLE #tmpSprzedaz&#xD;
DROP TABLE #tmpDataWydania&#xD;
DROP TABLE #tmpDataDostawy&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QLNy8SvsWvjndP4rYWmIrmw65/eZ7QPiim3cKUThrJOp91uo2s2QytZVCI0ahIBHPzdhq77ZDLGS8LuZiEj0zYsIgS5K2HrbyaqCJT/6WDiznZVF9elSOhzVl2dH/e0c9PnG3YSMpcSF3Y8x5vWCkpLScwlLQEW3Qqe7R0u8VkZs9N9mOdplX8Q/6cokntZkj4+ymM9XCT/A==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dzień" caption="Data Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Tydzień Roku" caption="Data Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miesiąc" caption="Data Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Kwartał" caption="Data Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rok" caption="Data Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary" caption="Produkt Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Waga KG" caption="Produkt Waga KG" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Kod" caption="Magazyn Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena Domyślna" caption="Cena Domyślna" type="measure" formatString="c2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Szczegółowa" caption="Produkt Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Ogólna" caption="Produkt Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ilość" caption="Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Jednostka Pomocnicza" caption="Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rezerwacje" caption="Rezerwacje" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rezerwacje Jednostka Pomocnicza" caption="Rezerwacje Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Braki" caption="Braki" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Braki Jednostka Pomocnicza" caption="Braki Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zamówienia" caption="Zamówienia" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zamówienia Jednostka Pomocnicza" caption="Zamówienia Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Netto" caption="Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Brutto" caption="Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Liczba Dni" caption="Liczba Dni" type="measure" formatString="n0" aggregate="Max" /&gt;&#xD;
    &lt;column name="Ilość Minimalna" caption="Ilość Minimalna" type="measure" formatString="n2" aggregate="Min" /&gt;&#xD;
    &lt;column name="Ilość Maksymalna" caption="Ilość Maksymalna" type="measure" formatString="n2" aggregate="Max" /&gt;&#xD;
    &lt;column name="Ilość Ostatni Dzień" caption="Ilość Ostatni Dzień" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Netto" caption="Sprzedaż Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Sztuk Aktualnie Otwartych Zamówień u Dostawców" caption="Ilość Sztuk Aktualnie Otwartych Zamówień u Dostawców" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[452b9904-d21e-4bf6-ab5b-281968a025d7]" caption="Wskaźnik Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[9357f616-9b71-4aef-99e9-8e92c080a4bb]" caption="Wskaźnik Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[48297393-873c-490e-9506-55cc4454cba4]" caption="Rotacja w Dniach" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[eff0cd0e-9a7f-40f2-af1e-aafe3b5fbedc]" caption="DOS w Okresie" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[eb825a47-dc0c-49e5-92d0-58459afd22ff]" caption="Rotacja w Razach" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Stany magazynów od:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początkowa, od której będą wyświetlane stany magazynów&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-08-19&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Stany magazynów do:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data końcowa, do której będą wyświetlane stany magazynów&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-09-18&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;ZEROWE&lt;/Name&gt;&#xD;
    &lt;Label&gt;Pokazuj stany zerowe:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Parametr określający czy w raporcie mają być widoczne stany zerowe&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;'TAK';'NIE'&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;'NIE'&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="310" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[452b9904-d21e-4bf6-ab5b-281968a025d7]" caption="Wskaźnik Ilość" formula="IIF(Ilość = 0.0,&amp;#xD;&amp;#xA;999999999.9999,&amp;#xD;&amp;#xA;Sprzedaż Ilość/Ilość&amp;#xD;&amp;#xA;)" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[9357f616-9b71-4aef-99e9-8e92c080a4bb]" caption="Wskaźnik Wartość" formula="IIF(Wartość Netto = 0.0,&amp;#xD;&amp;#xA;999999999.9999,&amp;#xD;&amp;#xA;Sprzedaż Wartość Netto/Wartość Netto&amp;#xD;&amp;#xA;)" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[eb825a47-dc0c-49e5-92d0-58459afd22ff]" caption="Rotacja w Razach" formula="IIF(Wartość Netto = 0.0,&amp;#xD;&amp;#xA;999999999.99,&amp;#xD;&amp;#xA;Sprzedaż Wartość Netto*Liczba Dni/Wartość Netto)&amp;#xD;&amp;#xA;" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[48297393-873c-490e-9506-55cc4454cba4]" caption="Rotacja w Dniach" formula="IIF(Sprzedaż Wartość Netto = 0.0,&amp;#xD;&amp;#xA;999999999.99,&amp;#xD;&amp;#xA;Wartość Netto/Sprzedaż Wartość Netto)" description="" summaryType="Default" /&gt;&lt;whatifMeasure uniqueName="[Measures].[eff0cd0e-9a7f-40f2-af1e-aafe3b5fbedc]" caption="DOS w Okresie" formula="IIF(Sprzedaż Ilość = 0.0,&amp;#xD;&amp;#xA;999999999.99,&amp;#xD;&amp;#xA;Ilość Ostatni Dzień*Liczba Dni/Sprzedaż Ilość)" description="" summaryType="Default" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Stanów Magazynowych w Zakresie Dat wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport prezentuje stany ilościowe i wartościowe magazynów w zadanym okresie czasu. Wyliczane są stany na każdy dzień z podanym przedziale. Zakres dat, w którym ma zostać wykonana analiza należy podać podczas uruchamiania raportu. Wartości prezentowane są w walucie systemowej w cenie zakupu.&#xD;
&#xD;
Raport oparty na tabeli:&#xD;
CDN.TwrIlosci - tabela przechowująca agregaty zawierające stany magazynowe</a:description><a:id>13</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>13. Raport Stanów Magazynowych w Zakresie Dat</a:mainLinkName><a:modifiedOn>2025-02-04T12:12:25.817</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-04-05T16:29:46.497</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/*&#xD;
* Raport Zasobów Magazynowych z Dostaw&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @sqlA nvarchar(max), @atrybutyTwr varchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Zasobów&#xD;
DECLARE @atrybutyZas varchar(max);&#xD;
DECLARE @atrybutyZas2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in &#xD;
(&#xD;
SELECT DISTINCT TsC_Cecha1_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha2_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha3_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha4_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha5_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha6_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha7_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha8_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha9_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha10_DeAId FROM CDN.TraSElemCechy&#xD;
)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TsC_TrSID INTO #tmpZasAtr FROM CDN.TraSElemCechy&#xD;
&#xD;
SET @atrybutyZas = ''&#xD;
SET @atrybutyZas2 = ''&#xD;
declare @sqlb varchar(max)&#xD;
declare @sqlc varchar(max)&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
       IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
       IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
       SET @sqlA = N'ALTER TABLE #tmpZasAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
       SET @sqlA = N'UPDATE #tmpZasAtr&#xD;
             SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = &#xD;
             CASE&#xD;
                WHEN ATR.TsC_Cecha1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,CASE WHEN ATR.TsC_Cecha1_Wartosc &lt; 0 THEN 0 ELSE ATR.TsC_Cecha1_Wartosc END),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    else  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha1_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha1_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,CASE WHEN ATR.TsC_Cecha2_Wartosc &lt; 0 THEN 0 ELSE ATR.TsC_Cecha2_Wartosc END),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha2_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha2_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,CASE WHEN ATR.TsC_Cecha3_Wartosc &lt; 0 THEN 0 ELSE ATR.TsC_Cecha3_Wartosc END),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha3_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha3_Wartosc END END &#xD;
                WHEN ATR.TsC_Cecha4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,CASE WHEN ATR.TsC_Cecha4_Wartosc &lt; 0 THEN 0 ELSE ATR.TsC_Cecha4_Wartosc END),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha4_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha4_Wartosc END END &#xD;
                WHEN ATR.TsC_Cecha5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,CASE WHEN ATR.TsC_Cecha5_Wartosc &lt; 0 THEN 0 ELSE ATR.TsC_Cecha5_Wartosc END),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha5_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha5_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha6_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,CASE WHEN ATR.TsC_Cecha6_Wartosc &lt; 0 THEN 0 ELSE ATR.TsC_Cecha6_Wartosc END),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha6_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha6_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha7_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,CASE WHEN ATR.TsC_Cecha7_Wartosc &lt; 0 THEN 0 ELSE ATR.TsC_Cecha7_Wartosc END),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha7_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha7_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha8_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,CASE WHEN ATR.TsC_Cecha8_Wartosc &lt; 0 THEN 0 ELSE ATR.TsC_Cecha8_Wartosc END),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha8_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha8_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha9_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,CASE WHEN ATR.TsC_Cecha9_Wartosc &lt; 0 THEN 0 ELSE ATR.TsC_Cecha9_Wartosc END),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha9_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha9_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha10_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,CASE WHEN ATR.TsC_Cecha10_Wartosc &lt; 0 THEN 0 ELSE ATR.TsC_Cecha10_Wartosc END),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha10_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha10_Wartosc END END&#xD;
             ELSE ''(NIEPRZYPISANE)'' END&#xD;
 'SET @SQLB='&#xD;
             FROM CDN.TraSElemCechy ATR &#xD;
             JOIN #tmpZasAtr TM ON ATR.TsC_TrSID = TM.TsC_TrSID&#xD;
             WHERE ATR.TsC_Cecha1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha6_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha7_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha8_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha9_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR '&#xD;
            set @sqlc = ' ATR.TsC_Cecha10_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
       EXEC(@sqlA+@sqlb+@sqlc)    &#xD;
    &#xD;
    SET @atrybutyZas = @atrybutyZas + N', ISNULL(ZasAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Zasoby Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
&#xD;
       FETCH NEXT FROM atrybut_cursor&#xD;
       INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE&#xD;
    WHEN DDf_Numeracja like '@rejestr%' THEN 5 &#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
    WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Dostawy Numer], &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    Twr_Kod [Produkt Kod],  &#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
    Twr_JM [Produkt Jednostka Miary], ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis],&#xD;
    CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
    END [Produkt Typ],&#xD;
    CASE&#xD;
        WHEN DATEDIFF(day, TwZ_Data, GETDATE()) &lt; 0 THEN ''1. Poniżej 0 dni''&#xD;
        WHEN DATEDIFF(day, TwZ_Data, GETDATE()) BETWEEN 0 AND ' + CONVERT(VARCHAR,@PRZEDZIAL1) + ' THEN ''2. Do ' + CONVERT(VARCHAR,@PRZEDZIAL1) + ' dni''&#xD;
        WHEN DATEDIFF(day, TwZ_Data, GETDATE()) BETWEEN ' + CONVERT(VARCHAR,@PRZEDZIAL1) + ' + 1 AND ' + CONVERT(VARCHAR,@PRZEDZIAL2) + ' THEN ''3. Od ' + CONVERT(VARCHAR,@PRZEDZIAL1) + ' do ' + CONVERT(VARCHAR,@PRZEDZIAL2) + ' dni''&#xD;
        WHEN DATEDIFF(day, TwZ_Data, GETDATE()) BETWEEN ' + CONVERT(VARCHAR,@PRZEDZIAL2) + ' + 1 AND ' + CONVERT(VARCHAR,@PRZEDZIAL3) + ' THEN ''4. Od ' + CONVERT(VARCHAR,@PRZEDZIAL2) + ' do ' + CONVERT(VARCHAR,@PRZEDZIAL3) + ' dni''&#xD;
        ELSE ''5. Powyżej ' + CONVERT(VARCHAR,@PRZEDZIAL3) + ' dni'' &#xD;
    END [Produkt Zaleganie],&#xD;
    TwC_Wartosc [Cena Domyślna], ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    ISNULL(kat.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria Szczegółowa], ISNULL(kat.Kat_KodOgolny, ''(PUSTA)'') [Produkt Kategoria Ogólna], &#xD;
    Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'') [Produkt Waga KG],&#xD;
    Mag_Symbol [Magazyn Kod],&#xD;
    ISNULL(knt.KnT_Kod, ''(NIEPRZYPISANY)'') [Dostawca Pierwotny Kod], &#xD;
    ISNULL(knt.Knt_Nazwa1, ''(NIEPRZYPISANY)'') [Dostawca Pierwotny Nazwa], &#xD;
    ISNULL(knt3.KnT_Kod, ''(NIEPRZYPISANY)'') [Dostawca Kod],   &#xD;
    ISNULL(knt3.Knt_Nazwa1, ''(NIEPRZYPISANY)'') [Dostawca Nazwa], &#xD;
    TwZ_Ilosc [Ilość], &#xD;
    CASE WHEN Twr_JMPrzelicznikL &lt;&gt; 0 THEN CONVERT(DECIMAL(20,4),TwZ_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL) ELSE 0 END [Ilość Jednostka Pomocnicza], &#xD;
    TrE_Ilosc [Ilość w Dostawie],   NULLIF(Twr_IloscMin,0) [Ilość Minimalna], NULLIF(Twr_IloscMax,0) [Ilość Maksymalna],&#xD;
    TwZ_Wartosc [Wartość Netto], TwZ_Wartosc * (1 + Twr_Stawka/100) [Wartość Brutto], TwZ_Cena [Cena Zakupu],&#xD;
    DATEDIFF(day, TwZ_Data, GETDATE()) AS [Liczba dni zalegania]&#xD;
    ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
    ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TwZ_Data, 111), ''/'', ''-'') [Data Dostawy]&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TwZ_Data, 111), ''/'', ''-'') [Data Dostawy Dzień], (datepart(DY, datediff(d, 0, TwZ_Data) / 7 * 7 + 3)+6) / 7 [Data Dostawy Tydzień Roku]&#xD;
    ,MONTH(TwZ_Data) [Data Dostawy Miesiąc],    DATEPART(quarter, TwZ_Data) [Data Dostawy Kwartał], YEAR(TwZ_Data) [Data Dostawy Rok]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE                               &#xD;
        WHEN TrN_TypDokumentu = 312 THEN 25034&#xD;
        WHEN TrN_TypDokumentu = 303 THEN 25032&#xD;
        WHEN TrN_TypDokumentu = 317 THEN 25045&#xD;
        WHEN TrN_TypDokumentu = 307 THEN 25024&#xD;
        WHEN TrN_TypDokumentu = 313 THEN 25079&#xD;
    END [Dokument Dostawy Numer __PROCID__PZ__], TrN_TrNId [Dokument Dostawy Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Dostawy Numer __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,29056 [Magazyn Kod __PROCID__Magazyny__], Mag_MagId [Magazyn Kod __ORGID__],'''+@bazaFirmowa+''' [Magazyn Kod __DATABASE__]&#xD;
    ,20201 [Dostawca Pierwotny Kod __PROCID__Kontrahenci__], knt.Knt_KntId [Dostawca Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Dostawca Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Dostawca Pierwotny Nazwa __PROCID__], knt.Knt_KntId [Dostawca Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Dostawca Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Dostawca Kod __PROCID__Kontrahenci__], knt3.Knt_KntId [Dostawca Kod __ORGID__],'''+@bazaFirmowa+''' [Dostawca Kod __DATABASE__]&#xD;
    ,20201 [Dostawca Nazwa __PROCID__], knt3.Knt_KntId [Dostawca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Dostawca Nazwa __DATABASE__]&#xD;
&#xD;
    ' + @kolumny + @atrybutyTwr + @atrybutyZas + '&#xD;
 FROM CDN.TwrZasoby&#xD;
    JOIN CDN.Towary ON TwZ_TwrId = Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
    LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat ON Twr_KatId=kat.Kat_KatID&#xD;
    JOIN CDN.Magazyny ON TwZ_MagId = Mag_MagId&#xD;
    JOIN CDN.TraSElem ON TwZ_TrSIdDost = TrS_TrSID&#xD;
    JOIN CDN.TraElem ON TrS_TrEId = TrE_TrEID&#xD;
    JOIN CDN.TraNag ON TrE_TrNId = TrN_TrNID&#xD;
LEFT JOIN #tmpSeria  Ser ON TrN_DDfId = DDf_DDfID&#xD;
    LEFT JOIN CDN.Kontrahenci knt ON TrN_PodId = KnT_KnTId AND TrN_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Kontrahenci knt3 ON knt.Knt_GlID=knt3.Knt_KntId &#xD;
    LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
    LEFT JOIN #tmpTwrAtr TwrAtr ON TwR_TwrId  = TwrAtr.TwA_TwrId&#xD;
    LEFT JOIN #tmpZasAtr ZasAtr ON Trs_TrSId = ZasAtr.TsC_TrSID&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
'&#xD;
&#xD;
exec (@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpZasAtr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QLNy8SvsWvjndP4rYWmIrmw65/eZ7QPiim3cKUThrJOp91uo2s2QytZVCI0ahIBHPzdhq77ZDLGV416eqisuhRvsBchYe/0nZ1nxm0MvuxGuMSkybFYJKikIyc3Jy8uSmQ13fU8LlOUnG1yBgPjtNfudwNqxTra3BFd8CawZLzfbHViM3udhwwi65LCa8cKtSBlCg2ZSO0nA==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dostawy Dzień" caption="Data Dostawy Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dostawy Tydzień Roku" caption="Data Dostawy Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dostawy Miesiąc" caption="Data Dostawy Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dostawy Kwartał" caption="Data Dostawy Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dostawy Rok" caption="Data Dostawy Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Dostawy Numer" caption="Dokument Dostawy Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary" caption="Produkt Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Zaleganie" caption="Produkt Zaleganie" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena Domyślna" caption="Cena Domyślna" type="measure" formatString="c2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Szczegółowa" caption="Produkt Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Ogólna" caption="Produkt Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Waga KG" caption="Produkt Waga KG" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Kod" caption="Magazyn Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dostawca Pierwotny Kod" caption="Dostawca Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dostawca Pierwotny Nazwa" caption="Dostawca Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dostawca Kod" caption="Dostawca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dostawca Nazwa" caption="Dostawca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ilość" caption="Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Jednostka Pomocnicza" caption="Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość w Dostawie" caption="Ilość w Dostawie" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Ilość Minimalna" caption="Ilość Minimalna" type="measure" formatString="n2" aggregate="Min" /&gt;&#xD;
    &lt;column name="Ilość Maksymalna" caption="Ilość Maksymalna" type="measure" formatString="n2" aggregate="Max" /&gt;&#xD;
    &lt;column name="Wartość Netto" caption="Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Brutto" caption="Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Cena Zakupu" caption="Cena Zakupu" type="measure" formatString="c2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Liczba dni zalegania" caption="Liczba dni zalegania" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR FS" caption="Produkt Atrybut NR FS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut WILGOTNOSC" caption="Produkt Atrybut WILGOTNOSC" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ASDSADASDSADSADASD" caption="Produkt Atrybut ASDSADASDSADSADASD" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TEST ATR ZALEZ OD KO" caption="Produkt Atrybut TEST ATR ZALEZ OD KO" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut SBITEST" caption="Produkt Atrybut SBITEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zasoby Atrybut NR FS" caption="Zasoby Atrybut NR FS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zasoby Atrybut WILGOTNOSC" caption="Zasoby Atrybut WILGOTNOSC" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL1&lt;/Name&gt;&#xD;
    &lt;Label&gt;1 przedział do (liczba dni):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Granica pierwszego przedziału zalegania. Do 1 przedziału wpadną towary zalegające od 0 dni do podanej wartości tego parametru&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;1000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;30&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL2&lt;/Name&gt;&#xD;
    &lt;Label&gt;2 przedział do (liczba dni):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica drugiego przedziału zalegania. Do 2 przedziału wpadną towary zalegające od granicy pierwszego przedziału do podanej wartości tego parametru&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;1000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;60&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL3&lt;/Name&gt;&#xD;
    &lt;Label&gt;3 przedział do (liczba dni):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica trzeciego przedziału zalegania. Do 3 przedziału wpadną towary zalegające od granicy drugiego przedziału do podanej wartości tego parametru&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;1000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;90&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="False" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Zasobów Magazynowych z Dostaw wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport prezentuje aktualny stan zasobów magazynowych.Za pomocą raportu można analizować zaleganie towarów. Na podstawie dokumentów dostaw wyliczany jest czas zalegania towaru na magazynie. Towary przydzielane są do odpowiednich przedziałów czasu zalegania. Granice przedziałów należy podać podczas uruchamiania raportu. Wartości prezentowane są w walucie systemowej w cenie zakupu.&#xD;
&#xD;
Raport oparty na tabeli:&#xD;
CDN.TwrZasoby - tabela zawierająca ilości towarów z poszczególnych dostaw z podziałem na magazyny</a:description><a:id>14</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>14. Raport Zasobów Magazynowych z Dostaw</a:mainLinkName><a:modifiedOn>2025-02-04T12:15:08.807</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-04-11T14:34:30.663</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Serwisu&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('')&#xD;
&#xD;
--Wyliczanie Atrybutów Urządzeń&#xD;
DECLARE @atrybutySrsU varchar(max), @atrybutySrsU2 varchar(max), @sqlA varchar(max), @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int;&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_SrUId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_SrUId INTO #tmpUrzAtr &#xD;
FROM CDN.TwrAtrybuty&#xD;
JOIN CDN.SrsUrzadzenia on SrU_SrUId = TwA_SrUId&#xD;
&#xD;
SET @atrybutySrsU = ''&#xD;
SET @atrybutySrsU2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpUrzAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpUrzAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END&#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpUrzAtr TM ON ATR.TwA_SrUId  = TM.TwA_SrUId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutySrsU = @atrybutySrsU + N', ISNULL(SrsUAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Urządzenie Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutySrsU2 = @atrybutySrsU2 + N', ''(NIEPRZYPISANE)'' [Urządzenie Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
print @atrybutySrsU&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
-- atrybuty czynnosci&#xD;
DECLARE   @atrybutyCzy varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId,DeA_Kod , DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT Tra_DeAId FROM cdn.TraElemAtr)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_DokId, Tra_Doktyp,TrA_DeAId  INTO #tmpCzyAtr FROM CDN.TraElemAtr &#xD;
&#xD;
SET @atrybutyCzy = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @sqlA = N'ALTER TABLE #tmpCzyAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpCzyAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.Tra_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.Tra_Wartosc,'','',''.'') ELSE ATR.Tra_Wartosc END&#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpCzyAtr TM ON ATR.TrA_DokId = TM.TrA_DokId  AND ATR.TrA_DokTyp = TM.TrA_DokTyp AND ATR.TrA_DeAId = TM.TrA_DeAId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyCzy = @atrybutyCzy + N', ISNULL(cza.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
          &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE   @atrybuty varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END&#xD;
        END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Podmiot Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Podmiot Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'  &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(Odb.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'            &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_SrZId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_SrZId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END&#xD;
        END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_SrZId = TM.DAt_SrZId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
SELECT COUNT(*) AS IloscAtr, TrA_DokTyp as TYP,TrA_DokId  AS idatr INTO #TmpAtrybutyIlosc FROM cdn.TraElemAtr JOIN CDN.DefAtrybuty on TrA_DeAId =DeA_DeAId where  DeA_AnalizyBI = 1  GROUP BY TrA_DokTyp,TrA_DokId&#xD;
&#xD;
select  DoR_ParentID, TrE_TwrId, count(*)  as Ilosc&#xD;
INTO #DokPowiazaneIlosc&#xD;
from cdn.DokRelacje&#xD;
JOIN cdn.TraNag ON TrN_TypDokumentu = DoR_DokumentTyp AND &#xD;
TrN_TrNId = DoR_DokumentId&#xD;
JOIN&#xD;
(select TrE_TrNId,TrE_TwrId, count(*) iloscd&#xD;
FROM CDN.TraElem&#xD;
GROUP BY TrE_TrNId,TrE_TwrId&#xD;
)x on x.TrE_TrNId =TrN_TrNID&#xD;
WHERE DoR_ParentTyp =900&#xD;
GROUP BY  DoR_ParentId, TrE_TwrId&#xD;
&#xD;
--Właściwe zapytanie&#xD;
DECLARE @select varchar(max);&#xD;
set @select = &#xD;
'SELECT&#xD;
&#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
''Czynność'' [Produkt Typ],&#xD;
CASE&#xD;
    WHEN SrY_SerwisantTyp = 3 THEN ISNULL(p1.PRA_Kod, ''(NIEPRZYPISANE)'')&#xD;
    WHEN SrY_SerwisantTyp = 8 THEN ISNULL(o1.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
    ELSE ''(NIEPRZYPISANE)''&#xD;
END [Serwisant Kod], &#xD;
ISNULL(SrY_TwrKod,Twr_Kod) [Produkt Kod], ISNULL(SrY_TwrNazwa,Twr_Nazwa) [Produkt Nazwa],&#xD;
ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis],&#xD;
CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
Mag_Symbol [Magazyn Kod],&#xD;
SrZ_NumerPelny [Dokument Zlecenia Numer], SrZ_Opis [Dokument Zlecenia Opis], &#xD;
CASE WHEN (SrY_Fakturowac = 0 AND SrZ_ZbiorczeFaCzesci = 0) THEN ''NIE'' ELSE ''TAK'' END  [Produkt Fakturowanie],&#xD;
Sry_Lp AS [Produkt Lp],&#xD;
CASE&#xD;
    WHEN SrZ_Stan = 0 THEN ''Do Realizacji''&#xD;
    WHEN SrZ_Stan = 1 THEN ''W Realizacji''&#xD;
    WHEN SrZ_Stan = 2 THEN ''Zrealizowane''&#xD;
END [Dokument Zlecenia Stan],&#xD;
CASE&#xD;
    WHEN SrZ_ProwadzacyTyp = 3 THEN ISNULL(p2.PRA_Kod, ''(NIEPRZYPISANE)'')&#xD;
    WHEN SrZ_ProwadzacyTyp = 8 THEN ISNULL(o2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
    ELSE ''(NIEPRZYPISANE)''&#xD;
END [Opiekun Kod], &#xD;
ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Dokument Zlecenia Kategoria Szczegółowa], ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Dokument Zlecenia Kategoria Ogólna],&#xD;
pod1.Pod_Nazwa1 [Podmiot Pierwotny Nazwa], pod1.Pod_Kod [Podmiot Pierwotny Kod], &#xD;
pod5.Pod_Nazwa1 [Podmiot Nazwa], pod5.Pod_Kod [Podmiot Kod], &#xD;
CONVERT(DECIMAL(10,4),(SrY_WartoscNettoPLN/ISNULL(dokPow.Ilosc, 1)/ISNULL(il.iloscAtr,1))) [Wartość Netto], &#xD;
CONVERT(DECIMAL(10,4),(SrY_WartoscBruttoPLN/ISNULL(dokPow.Ilosc, 1)/ISNULL(il.iloscAtr,1))) [Wartość Brutto], &#xD;
CONVERT(DECIMAL(10,4),(SrY_WartoscNetto/ISNULL(dokPow.Ilosc, 1) /ISNULL(il.iloscAtr,1)))[Wartość Netto Waluta],&#xD;
CONVERT(DECIMAL(10,4),( SrY_WartoscBrutto/ISNULL(dokPow.Ilosc, 1)/ISNULL(il.iloscAtr,1))) [Wartość Brutto Waluta], &#xD;
CASE when isnull(SrY_Waluta,'''')='''' THEN '''+@wal+''' ELSE SrY_Waluta END [Waluta],&#xD;
CONVERT(DECIMAL(10,4),(SrY_Ilosc/ISNULL(dokPow.Ilosc, 1) /ISNULL(il.iloscAtr,1)))[Ilość], &#xD;
NULL [Ilość Pobrana],&#xD;
NULL [Ilość Wydana],&#xD;
CONVERT(DECIMAL(10,4),(SrY_KosztUslugi/ISNULL(dokPow.Ilosc, 1) /ISNULL(il.iloscAtr,1)))[Koszt Własny], &#xD;
CONVERT(DECIMAL(10,4),((SrY_WartoscNetto - SrY_KosztUslugi)/ISNULL(dokPow.Ilosc, 1) /ISNULL(il.iloscAtr,1)))[Marża Netto],&#xD;
ISNULL(SrY_TwrKod,Twr_Kod) [Częstotliwość],&#xD;
&#xD;
CASE WHEN SrY_Zakonczona = 0 THEN ''NIE'' ELSE ''TAK'' END [Czynność Zakończona],&#xD;
ISNULL(REPLACE(CONVERT(VARCHAR(10), SrY_DataWykonania, 111), ''/'', ''-''), ''(BRAK)'') [Data Realizacji Czynności],&#xD;
REPLACE(CONVERT(VARCHAR(10), SrY_TerminOd, 111), ''/'', ''-'') [Data Rozpoczęcia Czynności], &#xD;
REPLACE(CONVERT(VARCHAR(10), SrY_TerminDo, 111), ''/'', ''-'') [Data Zakończenia Czynności],&#xD;
CONVERT (DECIMAL(15,2), (DATEDIFF(day, CONVERT(DATETIME,''1899-12-30'',120), SrY_CzasTrwania ) * 24 * 60&#xD;
+ DATEPART(hh, SRY_CzasTrwania)*60 + DATEPART(mi, SrY_CzasTrwania) )/ISNULL(dokPow.Ilosc, 1)/ISNULL(il.iloscAtr, 1) ,2)[Czas Trwania Czynności],&#xD;
sru_kod [Urządzenie Kod],&#xD;
sru_nazwa [Urządzenie Nazwa], &#xD;
SrR_Kod [Urządzenie Rodzaj] &#xD;
,pod6.Pod_Nazwa1 as [Odbiorca Nazwa] &#xD;
,pod6.Pod_Kod  as [Odbiorca Kod] &#xD;
&#xD;
,SrZ_ZlecajacyNazwisko [Osoba Zlecająca Nazwa]&#xD;
,SrZ_ZlecajacyTelefon [Osoba Zlecająca Telefon]&#xD;
,''Nie Dotyczy'' [Status Pobrania]&#xD;
,''Nie Dotyczy'' [Status Wydania]&#xD;
,''Nie Dotyczy'' [Fakturować]&#xD;
,DEt_Kod [Dokument Zlecenia Status]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataPrzyjecia, 111), ''/'', ''-'') [Data Przyjęcia Zlecenia] &#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataRealizacji, 111), ''/'', ''-'') [Data Realizacji Zlecenia] &#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataZamkniecia, 111), ''/'', ''-'') [Data Zamknięcia Zlecenia] &#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataPrzyjecia, 111), ''/'', ''-'') [Data Przyjęcia Zlecenia Dzień] &#xD;
,MONTH(SrZ_DataPrzyjecia) [Data Przyjęcia Zlecenia Miesiąc], (datepart(DY, datediff(d, 0, SrZ_DataPrzyjecia) / 7 * 7 + 3)+6) / 7 [Data Przyjęcia Zlecenia Tydzień Roku] &#xD;
,DATEPART(quarter, SrZ_DataPrzyjecia) AS [Data Przyjęcia Zlecenia Kwartał], YEAR(SrZ_DataPrzyjecia) [Data Przyjęcia Zlecenia Rok]&#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataRealizacji, 111), ''/'', ''-'') [Data Realizacji Zlecenia Dzień] &#xD;
,MONTH(SrZ_DataRealizacji) [Data Realizacji Zlecenia Miesiąc], (datepart(DY, datediff(d, 0, SrZ_DataRealizacji) / 7 * 7 + 3)+6) / 7 [Data Realizacji Zlecenia Tydzień Roku] &#xD;
,DATEPART(quarter, SrZ_DataRealizacji) AS [Data Realizacji Zlecenia Kwartał], YEAR(SrZ_DataRealizacji) [Data Realizacji Zlecenia Rok] &#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataZamkniecia, 111), ''/'', ''-'') [Data Zamknięcia Zlecenia Dzień] &#xD;
,MONTH(SrZ_DataZamkniecia) [Data Zamknięcia Zlecenia Miesiąc], (datepart(DY, datediff(d, 0, SrZ_DataZamkniecia) / 7 * 7 + 3)+6) / 7 [Data Zamknięcia Zlecenia Tydzień Roku]&#xD;
,DATEPART(quarter, SrZ_DataZamkniecia) AS [Data Zamknięcia Zlecenia Kwartał], YEAR(SrZ_DataZamkniecia) [Data Zamknięcia Zlecenia Rok]&#xD;
,GETDATE() [Data Analizy]&#xD;
,TrN_NumerPelny [Dokument Powiązany Numer],&#xD;
CDN.TypDokumentu(TrN_TypDokumentu)  [Dokument Powiązany Typ]&#xD;
' + @atrybutySrsU + @atrybuty + @atrybutyDok  + @atrybutyCzy + &#xD;
'&#xD;
&#xD;
FROM CDN.SrSZlecenia&#xD;
JOIN CDN.SrSCzynnosci ON SrZ_SrZId = SrY_SrZId&#xD;
LEFT JOIN CDN.Towary ON SrY_TwrId = Twr_TwrId&#xD;
LEFT JOIN CDN.PracKod p1 ON (SrY_SerwisantId = p1.Pra_PraId AND SrY_SerwisantTyp  = 3)&#xD;
LEFT JOIN ' + @Operatorzy + ' o1 ON (SrY_SerwisantID = o1.Ope_OpeId AND SrY_SerwisantTyp = 8)&#xD;
LEFT JOIN CDN.PracKod p2 ON (SrZ_ProwadzacyId = p2.Pra_PraId AND SrZ_ProwadzacyTyp  = 3)&#xD;
LEFT JOIN ' + @Operatorzy + ' o2 ON (SrZ_ProwadzacyID = o2.Ope_OpeId AND SrZ_ProwadzacyTyp = 8)&#xD;
LEFT JOIN CDN.Kategorie kat1 ON SrZ_KatID=kat1.Kat_KatID&#xD;
LEFT JOIN CDN.PodmiotyView pod1 ON SrZ_PodmiotId= pod1.Pod_PodId AND Srz_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
LEFT JOIN CDN.Magazyny ON SrZ_MagId = Mag_MagId&#xD;
LEFT JOIN CDN.SrsUrzadzenia on SrZ_SrUId = SrU_SrUId&#xD;
LEFT JOIN CDN.SrsRodzajeU on SrR_SrRId = SrU_SrRId&#xD;
LEFT JOIN #tmpUrzAtr as SrsUAtr on SrsUAtr.TwA_SrUId = SrU_SrUId&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpDokAtr DokAtr ON SrZ_SrZId  = DokAtr.DAt_SrZId&#xD;
left join cdn.defetapy on srz_etapid=DEt_DEtId&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod6 on  SrZ_OdbID = pod6.Pod_PodId and SrZ_OdbiorcaTyp = pod6.Pod_PodmiotTyp&#xD;
LEFT JOIN #tmpKonAtr Odb ON pod6.Pod_PodId = Odb.KnA_PodmiotId AND pod6.Pod_PodmiotTyp = Odb.KnA_PodmiotTyp&#xD;
LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
LEFT JOIN (&#xD;
    select  DoR_ParentID, TrE_TwrId, TrN_NumerPelny , TrN_TypDokumentu, TrN_Opis&#xD;
    from cdn.DokRelacje&#xD;
    JOIN cdn.TraNag ON TrN_TypDokumentu = DoR_DokumentTyp AND &#xD;
    TrN_TrNId = DoR_DokumentId&#xD;
    JOIN CDN.TraElem ON &#xD;
     TrE_TrNId = TrN_TrNID&#xD;
    WHERE DoR_ParentTyp = 900&#xD;
) dokPowiazane ON dokPowiazane.DoR_ParentID = SrZ_SrZId &#xD;
    AND dokPowiazane.TrE_TwrId = SrY_TwrId&#xD;
LEFT JOIN  #DokPowiazaneIlosc dokPow ON dokPow.DoR_ParentId = dokPowiazane.DoR_ParentID AND dokPow.TrE_TwrId = twr_twrid&#xD;
    AND dokPow.TrE_TwrId = SrY_TwrId&#xD;
        LEFT JOIN #tmpCzyAtr  cza ON SrY_sryid = cza.TrA_DOKID AND cza.TrA_DokTyp = 901&#xD;
        LEFT JOIN #TmpAtrybutyIlosc il on il.idatr = SrY_sryid and il.TYP = 901&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
        LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
        LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
        WHERE SrZ_DataPrzyjecia BETWEEN convert(datetime,''' + convert(varchar, @Dataod, 120) + ''', 120) and convert(datetime,''' + convert(varchar, @DataDO, 120) + ''', 120)&#xD;
&#xD;
UNION&#xD;
 &#xD;
SELECT&#xD;
&#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
''Część'' [Produkt Typ],&#xD;
CASE&#xD;
    WHEN SrC_SerwisantTyp = 3 THEN ISNULL(p1.PRA_Kod, ''(NIEPRZYPISANE)'')&#xD;
    WHEN SrC_SerwisantTyp = 8 THEN ISNULL(o1.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
    ELSE ''(NIEPRZYPISANE)''&#xD;
END [Serwisant Kod], &#xD;
ISNULL(SrC_TwrKod,Twr_Kod) [Produkt Kod], ISNULL(SrC_TwrNazwa,Twr_Nazwa) [Produkt Nazwa],&#xD;
ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis],&#xD;
CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
Mag_Symbol [Magazyn Kod],&#xD;
SrZ_NumerPelny [Dokument Zlecenia Numer], SrZ_Opis [Dokument Zlecenia Opis], &#xD;
CASE WHEN (SrC_Fakturowac = 0 AND SrZ_ZbiorczeFaCzesci = 0) THEN ''NIE'' ELSE ''TAK'' END [Produkt Fakturowanie],&#xD;
Src_Lp AS [Produkt Lp],&#xD;
CASE&#xD;
    WHEN SrZ_Stan = 0 THEN ''Do Realizacji''&#xD;
    WHEN SrZ_Stan = 1 THEN ''W Realizacji''&#xD;
    WHEN SrZ_Stan = 2 THEN ''Zrealizowane''&#xD;
END [Dokument Zlecenia Stan],&#xD;
CASE&#xD;
    WHEN SrZ_ProwadzacyTyp = 3 THEN ISNULL(p2.PRA_Kod, ''(NIEPRZYPISANE)'')&#xD;
    WHEN SrZ_ProwadzacyTyp = 8 THEN ISNULL(o2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
    ELSE ''(NIEPRZYPISANE)''&#xD;
END [Opiekun Kod], &#xD;
ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Dokument Zlecenia Kategoria Szczegółowa], ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Dokument Zlecenia Kategoria Ogólna],&#xD;
pod1.Pod_Nazwa1 [Podmiot Pierwotny Nazwa], pod1.Pod_Kod [Podmiot Pierwotny Kod], &#xD;
pod5.Pod_Nazwa1 [Podmiot Nazwa], pod5.Pod_Kod [Podmiot Kod], &#xD;
CONVERT(DECIMAL(10,4),(SrC_WartoscNettoPLN/ISNULL(dokPow.Ilosc, 1) /ISNULL(il.iloscAtr,1)))[Wartość Netto], &#xD;
CONVERT(DECIMAL(10,4),(SrC_WartoscBruttoPLN/ISNULL(dokPow.Ilosc, 1)/ISNULL(il.iloscAtr,1))) [Wartość Brutto], &#xD;
CONVERT(DECIMAL(10,4),(SrC_WartoscNetto/ISNULL(dokPow.Ilosc, 1) /ISNULL(il.iloscAtr,1)))[Wartość Netto Waluta],&#xD;
CONVERT(DECIMAL(10,4),( SrC_WartoscBrutto/ISNULL(dokPow.Ilosc, 1)/ISNULL(il.iloscAtr,1))) [Wartość Brutto Waluta], &#xD;
CASE when isnull(SrC_Waluta,'''')='''' THEN '''+@wal+''' ELSE SrC_Waluta END [Waluta],&#xD;
CONVERT(DECIMAL(10,4),(SrC_Ilosc/ISNULL(dokPow.Ilosc, 1) /ISNULL(il.iloscAtr,1)))[Ilość],&#xD;
CONVERT(DECIMAL(10,4),(SrC_IloscPobieranaDisp/ISNULL(dokPow.Ilosc, 1) /ISNULL(il.iloscAtr,1)))[Ilość Pobrana],&#xD;
CONVERT(DECIMAL(10,4),(SRC_IloscWydanaDisp/ISNULL(dokPow.Ilosc, 1) /ISNULL(il.iloscAtr,1)))[Ilość Wydana],&#xD;
CONVERT(DECIMAL(10,4), (SrC_WartoscZakupu/ISNULL(dokPow.Ilosc, 1) /ISNULL(il.iloscAtr,1)))[Koszt Własny], &#xD;
CONVERT(DECIMAL(10,4), ((SrC_WartoscNetto - SrC_WartoscZakupu)/ISNULL(dokPow.Ilosc, 1)/ISNULL(il.iloscAtr,1))) [Marża Netto],&#xD;
ISNULL(SrC_TwrKod,Twr_Kod) [Częstotliwość],&#xD;
&#xD;
''Nie Dotyczy'' [Czynność Zakończona],&#xD;
''Nie Dotyczy'' [Data Realizacji Czynności],&#xD;
''Nie Dotyczy'' [Data Rozpoczęcia Czynności] ,&#xD;
''Nie Dotyczy'' [Data Zakończenia Czynności],&#xD;
NULL [Czas Trwania Czynności],&#xD;
sru_kod [Urządzenie Kod],&#xD;
sru_nazwa [Urządzenie Nazwa], &#xD;
SrR_Kod [Urządzenie Rodzaj] &#xD;
,pod6.Pod_Nazwa1 as [Odbiorca Nazwa] &#xD;
,pod6.Pod_Kod  as [Odbiorca Kod] &#xD;
,SrZ_ZlecajacyNazwisko [osoba Zlecająca Nazwa]&#xD;
,SrZ_ZlecajacyTelefon [Osoba Zlecająca Telefon]&#xD;
,CASE SrC_Status&#xD;
WHEN 0 THEN ''Nie pobrano''&#xD;
WHEN 1 THEN ''Pobrano''&#xD;
WHEN 2 THEN ''Nie pobrano, zamówiono''&#xD;
WHEN 3 THEN ''Pobrano, zamówiono'' END [Status pobrania],&#xD;
CASE WHEN CDN.TeRStatusString(902, Src_srcID, 0) Like ''%WZ''&#xD;
THEN&#xD;
''WZ''&#xD;
ELSE &#xD;
''Nie wydano''END&#xD;
 [Status Wydania]&#xD;
 ,CASE SrC_Fakturowac &#xD;
WHEN 0 THEN ''Nie''&#xD;
ELSE ''Tak'' END [Fakturować]&#xD;
,DEt_Kod [Dokument Zlecenia Status]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataPrzyjecia, 111), ''/'', ''-'') [Data Przyjęcia Zlecenia] &#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataRealizacji, 111), ''/'', ''-'') [Data Realizacji Zlecenia] &#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataZamkniecia, 111), ''/'', ''-'') [Data Zamknięcia Zlecenia]&#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataPrzyjecia, 111), ''/'', ''-'') [Data Przyjęcia Zlecenia Dzień] &#xD;
,MONTH(SrZ_DataPrzyjecia) [Data Przyjęcia Zlecenia Miesiąc], (datepart(DY, datediff(d, 0, SrZ_DataPrzyjecia) / 7 * 7 + 3)+6) / 7 [Data Przyjęcia Zlecenia Tydzień Roku]&#xD;
,DATEPART(quarter, SrZ_DataPrzyjecia) AS [Data Przyjęcia Zlecenia Kwartał], YEAR(SrZ_DataPrzyjecia) [Data Przyjęcia Zlecenia Rok]&#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataRealizacji, 111), ''/'', ''-'') [Data Realizacji Zlecenia Dzień] &#xD;
,MONTH(SrZ_DataRealizacji) [Data Realizacji Zlecenia Miesiąc], (datepart(DY, datediff(d, 0, SrZ_DataRealizacji) / 7 * 7 + 3)+6) / 7 [Data Realizacji Zlecenia Tydzień Roku]&#xD;
,DATEPART(quarter, SrZ_DataRealizacji) AS [Data Realizacji Zlecenia Kwartał], YEAR(SrZ_DataRealizacji) [Data Realizacji Zlecenia Rok] &#xD;
,REPLACE(CONVERT(VARCHAR(10), SrZ_DataZamkniecia, 111), ''/'', ''-'') [Data Zamknięcia Zlecenia Dzień]&#xD;
,MONTH(SrZ_DataZamkniecia) [Data Zamknięcia Zlecenia Miesiąc], (datepart(DY, datediff(d, 0, SrZ_DataZamkniecia) / 7 * 7 + 3)+6) / 7 [Data Zamknięcia Zlecenia Tydzień Roku]&#xD;
,DATEPART(quarter, SrZ_DataZamkniecia) AS [Data Zamknięcia Zlecenia Kwartał], YEAR(SrZ_DataZamkniecia) [Data Zamknięcia Zlecenia Rok]&#xD;
,GETDATE() [Data Analizy]&#xD;
,TrN_NumerPelny [Dokument Powiązany Numer],&#xD;
CDN.TypDokumentu(TrN_TypDokumentu)  [Dokument Powiązany Typ]&#xD;
' + @atrybutySrsU + @atrybuty + @atrybutyDok + @atrybutyCzy +&#xD;
'&#xD;
&#xD;
FROM CDN.SrSZlecenia&#xD;
JOIN CDN.SrSCzesci ON SrZ_SrZId = SrC_SrZId&#xD;
LEFT JOIN CDN.Towary ON SrC_TwrId = Twr_TwrId&#xD;
LEFT JOIN CDN.PracKod p1 ON (SrC_SerwisantId = p1.Pra_PraId AND SrC_SerwisantTyp  = 3)&#xD;
LEFT JOIN ' + @Operatorzy + ' o1 ON (SrC_SerwisantId = o1.Ope_OpeId AND SrC_SerwisantTyp = 8)&#xD;
LEFT JOIN CDN.PracKod p2 ON (SrZ_ProwadzacyId = p2.Pra_PraId AND SrZ_ProwadzacyTyp  = 3)&#xD;
LEFT JOIN ' + @Operatorzy + ' o2 ON (SrZ_ProwadzacyID = o2.Ope_OpeId AND SrZ_ProwadzacyTyp = 8)&#xD;
LEFT JOIN CDN.Kategorie kat1 ON SrZ_KatID=kat1.Kat_KatID&#xD;
LEFT JOIN CDN.PodmiotyView pod1 ON SrZ_PodmiotId= pod1.Pod_PodId AND Srz_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
LEFT JOIN CDN.Magazyny ON SrC_MagId = Mag_MagId&#xD;
LEFT JOIN CDN.SrsUrzadzenia on SrZ_SrUId = SrU_SrUId&#xD;
LEFT JOIN CDN.SrsRodzajeU as rodzurz on SrR_SrRId = SrU_SrRId&#xD;
LEFT JOIN #tmpUrzAtr as SrsUAtr on SrsUAtr.TwA_SrUId = SrU_SrUId&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpDokAtr DokAtr ON SrZ_SrZId  = DokAtr.DAt_SrZId&#xD;
left join cdn.defetapy on srz_etapid=DEt_DEtId&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod6 on  SrZ_OdbID = pod6.Pod_PodId and SrZ_OdbiorcaTyp = pod6.Pod_PodmiotTyp&#xD;
LEFT JOIN #tmpKonAtr Odb ON pod6.Pod_PodId = Odb.KnA_PodmiotId AND pod6.Pod_PodmiotTyp = Odb.KnA_PodmiotTyp&#xD;
LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
LEFT JOIN (&#xD;
    select  DoR_ParentID, TrE_TwrId, TrN_NumerPelny , TrN_TypDokumentu, TrN_Opis, tre_treid&#xD;
    from cdn.DokRelacje&#xD;
    JOIN cdn.TraNag ON TrN_TypDokumentu = DoR_DokumentTyp AND &#xD;
    TrN_TrNId = DoR_DokumentId&#xD;
    JOIN CDN.TraElem ON &#xD;
     TrE_TrNId = TrN_TrNID&#xD;
    WHERE DoR_ParentTyp = 900&#xD;
) dokPowiazane ON dokPowiazane.DoR_ParentID = SrZ_SrZId&#xD;
    AND dokPowiazane.TrE_TwrId = SrC_TwrId &#xD;
LEFT JOIN  #DokPowiazaneIlosc dokPow ON dokPow.DoR_ParentId = dokPowiazane.DoR_ParentID &#xD;
    AND dokPow.TrE_TwrId = SrC_TwrId AND dokPow.TrE_TwrId = twr_twrid&#xD;
        LEFT JOIN #tmpCzyAtr  cza ON SrC_srcid = cza.TrA_DOKID AND cza.TrA_DokTyp = 902&#xD;
    LEFT JOIN #TmpAtrybutyIlosc il on il.idatr = SrC_srcid and il.TYP = 902&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
    WHERE SrZ_DataPrzyjecia BETWEEN convert(datetime,''' + convert(varchar, @Dataod, 120) + ''', 120) and convert(datetime,''' + convert(varchar, @DataDO, 120) + ''', 120)&#xD;
'&#xD;
&#xD;
PRINT(@select);&#xD;
EXEC(@select);&#xD;
DROP TABLE #tmpUrzAtr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #DokPowiazaneIlosc&#xD;
DROP TABLE #TmpAtrybutyIlosc&#xD;
DROP TABLE #tmpCzyAtr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QLNy8SvsWvjndP4rYWmIrmw65/eZ7QPiim3cKUThrJOp91uo2s2QytZVCI0ahIBHPzdhq77ZDLGUiitSfcKm3Ekit3K1tJrHEOUzyDdGANbwJ01xHN31jIkIKK2tnJrrAP28/YieGJfe/OoKqvIKRJL6MDHcW3mKuEMYI6BrIH/wQEhYLXRYCFzjmpkMplPW/5KOi0zJ5mJg==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Serwisant Kod" caption="Serwisant Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Kod" caption="Magazyn Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Zlecenia Numer" caption="Dokument Zlecenia Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Zlecenia Opis" caption="Dokument Zlecenia Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Fakturowanie" caption="Produkt Fakturowanie" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Zlecenia Stan" caption="Dokument Zlecenia Stan" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Opiekun Kod" caption="Opiekun Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Zlecenia Kategoria Szczegółowa" caption="Dokument Zlecenia Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Zlecenia Kategoria Ogólna" caption="Dokument Zlecenia Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Nazwa" caption="Podmiot Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kod" caption="Podmiot Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Przyjęcia Zlecenia Dzień" caption="Data Przyjęcia Zlecenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Przyjęcia Zlecenia Miesiąc" caption="Data Przyjęcia Zlecenia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Przyjęcia Zlecenia Tydzień Roku" caption="Data Przyjęcia Zlecenia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Przyjęcia Zlecenia Kwartał" caption="Data Przyjęcia Zlecenia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Przyjęcia Zlecenia Rok" caption="Data Przyjęcia Zlecenia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Zlecenia Dzień" caption="Data Realizacji Zlecenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Zlecenia Miesiąc" caption="Data Realizacji Zlecenia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Zlecenia Tydzień Roku" caption="Data Realizacji Zlecenia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Zlecenia Kwartał" caption="Data Realizacji Zlecenia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Zlecenia Rok" caption="Data Realizacji Zlecenia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zamknięcia Zlecenia Dzień" caption="Data Zamknięcia Zlecenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zamknięcia Zlecenia Miesiąc" caption="Data Zamknięcia Zlecenia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zamknięcia Zlecenia Tydzień Roku" caption="Data Zamknięcia Zlecenia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zamknięcia Zlecenia Kwartał" caption="Data Zamknięcia Zlecenia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zamknięcia Zlecenia Rok" caption="Data Zamknięcia Zlecenia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wartość Netto" caption="Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Brutto" caption="Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Netto Waluta" caption="Wartość Netto Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Brutto Waluta" caption="Wartość Brutto Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ilość" caption="Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Własny" caption="Koszt Własny" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Marża Netto" caption="Marża Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Częstotliwość" caption="Częstotliwość" type="measure" formatString="n2" aggregate="Count" /&gt;&#xD;
    &lt;column name="Czynność Zakończona" caption="Czynność Zakończona" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Czynności" caption="Data Realizacji Czynności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozpoczęcia Czynności" caption="Data Rozpoczęcia Czynności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zakończenia Czynności" caption="Data Zakończenia Czynności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Trwania Czynności" caption="Czas Trwania Czynności" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Urządzenie Kod" caption="Urządzenie Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Urządzenie Nazwa" caption="Urządzenie Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Urządzenie Rodzaj" caption="Urządzenie Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Osoba Zlecająca Nazwa" caption="Osoba Zlecająca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Osoba Zlecająca Telefon" caption="Osoba Zlecająca Telefon" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Zlecenia Status" caption="Dokument Zlecenia Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Urządzenie Atrybut PIELĘGNACJA" caption="Urządzenie Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Urządzenie Atrybut KOLOR" caption="Urządzenie Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Urządzenie Atrybut REZLIZACJA" caption="Urządzenie Atrybut REZLIZACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Urządzenie Atrybut NR SERYJNY" caption="Urządzenie Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Urządzenie Atrybut ROZMIAR" caption="Urządzenie Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Atrybut KLUCZOWY" caption="Podmiot Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Atrybut KLUCZOWY" caption="Podmiot Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut KLUCZOWY" caption="Odbiorca Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Atrybut PROJEKTY PARKI" caption="Podmiot Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Atrybut PROJEKTY PARKI" caption="Podmiot Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut PROJEKTY PARKI" caption="Odbiorca Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Atrybut STATUS" caption="Podmiot Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Atrybut STATUS" caption="Podmiot Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut STATUS" caption="Odbiorca Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DATA" caption="Dokument Atrybut DATA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KOSZT" caption="Dokument Atrybut KOSZT" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[04b950c4-a496-4109-8c72-8bd497067a76]" caption="Czas Trwania Czynności Godziny" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[d3289352-6c7d-498f-82d0-0841d2d1c093]" caption="Czas Trwania Czynności Minuty" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przyjęcie zlecenia od:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Pierwszy dzień zakresu daty przyjęcia&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT dateadd(month,DateDiff(month,0,Getdate()),0)
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przyjęcie zlecenia do:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Ostatni dzień zakresu dat przyjęcia&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;Select Getdate()
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="507" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[04b950c4-a496-4109-8c72-8bd497067a76]" caption="Czas Trwania Czynności Godziny" formula="Math.Floor(Czas Trwania Czynności/60)" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[d3289352-6c7d-498f-82d0-0841d2d1c093]" caption="Czas Trwania Czynności Minuty" formula="Czas Trwania Czynności%60" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Serwisu wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport prezentuje informacje na temat zleceń i czynności serwisowych. Na jego podstawie można analizować działalność serwisu i skuteczność serwisantów w firmie. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.SrSZlecenia - tabela zawierająca listę zleceń serwisowych&#xD;
CDN.SrSCzynnosci - tabela zawierająca czynności przypisane do zleceń</a:description><a:id>15</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>15. Raport Serwisu</a:mainLinkName><a:modifiedOn>2024-10-04T15:19:02.063</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-04-16T15:24:34.653</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Środków Trwałych&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.1.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie Atrybutów Środków Trwałych&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @atrybuty2 varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT SrA_DeAid FROM CDN.TrwaleAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT ISNULL(SrA_SrTId, SrA_WypId) SrA_SrTId, SrA_Typ INTO #tmpKonAtr FROM CDN.TrwaleAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
SET @atrybuty2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.SrA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.SrA_WartoscTxt,'','',''.'') ELSE ATR.SrA_WartoscTxt END&#xD;
         END&#xD;
        FROM CDN.TrwaleAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ISNULL(ATR.SrA_SrTId, ATR.SrA_WypId) = TM.SrA_SrTId AND ATR.SrA_Typ = TM.SrA_Typ&#xD;
        WHERE ATR.SrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'  &#xD;
    SET @atrybuty2 = @atrybuty2 + N', KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + ']'       &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
DECLARE @select varchar(max);&#xD;
SET @select = &#xD;
'SELECT&#xD;
BAZ.Baz_Nazwa [Baza Firmowa], SrT_Nazwa [Produkt Nazwa], SrT_NrInwent [Produkt Numer Inwentarzowy], SrT_KRST [KŚT],&#xD;
REPLACE(CONVERT(VARCHAR(10), SrT_DataPrz, 111), ''/'', ''-'') [Data Przyjęcia Dzień], &#xD;
ISNULL(REPLACE(CONVERT(VARCHAR(10), SrT_DataLikw, 111), ''/'', ''-''), ''W użyciu'') [Data Likwidacji Dzień],&#xD;
h1.SrH_Grupa [Produkt Grupa], YEAR(h1.SrH_DataOpe) [Data Amortyzacji Rok], MONTH(h1.SrH_DataOpe) [Data Amortyzacji Miesiąc], &#xD;
ISNULL((SELECT TOP 1 OO.SrOO_PrcImieNazwisko &#xD;
FROM CDN.TrwaleOsobyOdpowiedzialne OO &#xD;
WHERE OO.SrOO_SrTID = h1.SrH_SrTID&#xD;
    AND 100*ISNULL(YEAR(SrOO_DataOd),0)+ISNULL(MONTH(SrOO_DataOd),0) &lt;= 100*YEAR(h1.SrH_DataOpe)+MONTH(h1.SrH_DataOpe)&#xD;
    AND 100*ISNULL(YEAR(SrOO_DataDo),9999)+ISNULL(MONTH(SrOO_DataDo),99) &gt;= 100*YEAR(h1.SrH_DataOpe)+MONTH(h1.SrH_DataOpe)&#xD;
ORDER BY OO.SrOO_DataOd DESC), ''Nieprzypisany'') [Osoba Odpowiedzialna],&#xD;
ISNULL((SELECT TOP 1 MU.SrMU_Nazwa &#xD;
FROM CDN.TrwaleMiejscaUzytkowania MU&#xD;
WHERE MU.SrMU_SrTID = h1.SrH_SrTID&#xD;
    AND 100*ISNULL(YEAR(SrMU_DataOd),0)+ISNULL(MONTH(SrMU_DataOd),0) &lt;= 100*YEAR(h1.SrH_DataOpe)+MONTH(h1.SrH_DataOpe)&#xD;
    AND 100*ISNULL(YEAR(SrMU_DataDo),9999)+ISNULL(MONTH(SrMU_DataDo),99) &gt;= 100*YEAR(h1.SrH_DataOpe)+MONTH(h1.SrH_DataOpe)&#xD;
ORDER BY MU.SrMU_DataOd DESC), ''Nieprzypisany'') [Miejsce Użytkowania],&#xD;
CASE &#xD;
    WHEN h1.SrH_Typ = 11 THEN ''Środek Trwały''&#xD;
    WHEN h1.SrH_Typ = 12 THEN ''WNP''&#xD;
    ELSE ''Inny'' &#xD;
END [Produkt Typ],&#xD;
CASE &#xD;
    WHEN SrT_Stan = 0 THEN ''W użyciu''&#xD;
    WHEN SrT_Stan = 1 THEN ''Zlikwidowany''&#xD;
    WHEN SrT_Stan = 2 THEN ''Zbyty''&#xD;
    ELSE ''Inny''&#xD;
END [Produkt Stan], &#xD;
CASE&#xD;
    WHEN SrH_Metoda = 0 THEN ''Nie amortyzować''&#xD;
    WHEN SrH_Metoda = 1 THEN ''Metoda liniowa''&#xD;
    WHEN SrH_Metoda = 2 THEN ''Metoda degresywna''&#xD;
    WHEN SrH_Metoda = 3 THEN ''Odpis jednorazowy''&#xD;
    WHEN SrH_Metoda = 4 THEN ''Metoda naturalna''&#xD;
    ELSE ''Inna''&#xD;
END [Metoda Amortyzacji],&#xD;
isnull(ZakladStr.Zak_Symbol,''(NIEPRZYPISANY)'') as [Produkt Zakład Symbol],&#xD;
isnull(ZakladStr.zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Produkt Zakład Nazwa Firmy],&#xD;
isnull(ZakladDok.Zak_Symbol,''(NIEPRZYPISANY)'') as [Dokument Zakład Symbol],&#xD;
isnull(ZakladDok.zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Dokument Zakład Nazwa Firmy],&#xD;
 1 [Ilość],&#xD;
IsNull(kat1.Kat_KodSzczegol,''NIEOKREŚLONA'') [Produkt Kategoria Amortyzacja], IsNull(kat2.Kat_KodSzczegol,''NIEOKREŚLONA'') [Produkt Kategoria],  &#xD;
NULL [Wartość Nabycia], NULL [Wartość Nabycia Kosztowa], CASE WHEN SrH_TypDokumentu = 3 THEN h1.SrH_KwotaAm ELSE NULL END [Koszty Amortyzacji], NULL [Wartość Netto], NULL [Wartość Brutto],&#xD;
(SELECT SUM(IsNull(h2.SrH_KwotaBilan - h2.SrH_KwotaUm, 0)) FROM CDN.TrwaleHist h2 WHERE h2.SrH_SrTID = h1.SrH_SrTID AND 100*YEAR(h2.SrH_DataOpe)+MONTH(h2.SrH_DataOpe) &lt;= 100*YEAR(h1.SrH_DataOpe)+MONTH(h1.SrH_DataOpe)) [Wartość w Czasie Netto],&#xD;
(SELECT SUM(IsNull(h2.SrH_KwotaBilan, 0)) FROM CDN.TrwaleHist h2 WHERE h2.SrH_SrTID = h1.SrH_SrTID AND 100*YEAR(h2.SrH_DataOpe)+MONTH(h2.SrH_DataOpe) &lt;= 100*YEAR(h1.SrH_DataOpe)+MONTH(h1.SrH_DataOpe)) [Wartość w Czasie Brutto]&#xD;
,cast(SrT_Stawka as nvarchar(50)) [Stawka amortyzacji Kosztowa]&#xD;
,cast(SrT_StawkaBil as nvarchar(50)) [Stawka amortyzacji Bilansowa]&#xD;
,cast(SrT_Wspolczynnik as nvarchar(50)) [Współczynnik amortyzacji Kosztowy]&#xD;
,cast(SrT_WspolczynnikBil as nvarchar(50)) [Współczynnik amortyzacji Bilansowy]&#xD;
,CASE WHEN SrH_TypDokumentu = 3 THEN h1.SrH_KwotaUm ELSE NULL END [Koszty Amortyzacji Bilansowe]&#xD;
' + @atrybuty + '&#xD;
,GETDATE() [Data Analizy]&#xD;
  ,REPLACE(CONVERT(VARCHAR(10), SrH_DataOpe, 111), ''/'', ''-'') [Data Dokumentu Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, SrH_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Dokumentu Tydzień Roku]&#xD;
    ,MONTH(SrH_DataOpe) [Data Dokumentu Miesiąc], DATEPART(quarter, SrH_DataOpe) [Data Dokumentu Kwartał], YEAR(SrH_DataOpe) [Data Dokumentu Rok] &#xD;
 FROM CDN.TrwaleHist h1&#xD;
LEFT OUTER JOIN CDN.Trwale ON h1.SrH_SrTID = SrT_SrTID&#xD;
LEFT OUTER JOIN CDN.Kategorie kat1 ON kat1.Kat_KatId = h1.SrH_KatId&#xD;
LEFT OUTER JOIN CDN.Kategorie kat2 ON kat2.Kat_KatId = SrT_KatId&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON SrT_SrTID = KonAtr.SrA_SrTId AND SrT_Typ = KonAtr.SrA_Typ&#xD;
LEFT OUTER JOIN CDN.Zaklady ZakladDok on ZakladDok.ZAK_ZAkID = h1.SrH_ZakID&#xD;
LEFT OUTER JOIN CDN.Zaklady ZakladStr on ZakladStr.ZAK_ZAkID = SrT_ZakID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE h1.SrH_DataOpe &gt;= SrT_DataZak  and SrH_TypDokumentu NOT IN (4,6)&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT&#xD;
BAZ.Baz_Nazwa [Baza Firmowa], SrT_Nazwa [Produkt Nazwa], SrT_NrInwent [Produkt Numer Inwentarzowy], SrT_KRST [KŚT],&#xD;
REPLACE(CONVERT(VARCHAR(10), SrT_DataPrz, 111), ''/'', ''-'') [Data Przyjęcia Dzień],&#xD;
ISNULL(REPLACE(CONVERT(VARCHAR(10), SrT_DataLikw, 111), ''/'', ''-''), ''W użyciu'') [Data Likwidacji Dzień],&#xD;
SrT_Grupa [Produkt Grupa], NULL [Data Amortyzacji Rok], NULL [Data Amortyzacji Miesiąc], &#xD;
ISNULL((SELECT TOP 1 OO.SrOO_PrcImieNazwisko &#xD;
 FROM CDN.TrwaleOsobyOdpowiedzialne OO &#xD;
 WHERE OO.SrOO_SrTID = MAX(h1.SrH_SrTID) &#xD;
 ORDER BY OO.SrOO_DataOd DESC), ''Nieprzypisany'') [Osoba Odpowiedzialna], &#xD;
ISNULL((SELECT TOP 1 MU.SrMU_Nazwa &#xD;
 FROM CDN.TrwaleMiejscaUzytkowania MU &#xD;
 WHERE MU.SrMU_SrTID = MAX(h1.SrH_SrTID) &#xD;
 ORDER BY MU.SrMU_DataOd DESC), ''Nieprzypisany'') [Miejsce Użytkowania], &#xD;
CASE &#xD;
    WHEN SrT_Typ = 11 THEN ''Środek Trwały''&#xD;
    WHEN SrT_Typ = 12 THEN ''WNP''&#xD;
    ELSE ''Inny'' &#xD;
END [Produkt Typ],&#xD;
CASE &#xD;
    WHEN SrT_Stan = 0 THEN ''W użyciu''&#xD;
    WHEN SrT_Stan = 1 THEN ''Zlikwidowany''&#xD;
    WHEN SrT_Stan = 2 THEN ''Zbyty''&#xD;
    ELSE ''Inny''&#xD;
END [Produkt Stan], &#xD;
CASE&#xD;
    WHEN SrT_Metoda = 0 THEN ''Nie amortyzować''&#xD;
    WHEN SrT_Metoda = 1 THEN ''Metoda liniowa''&#xD;
    WHEN SrT_Metoda = 2 THEN ''Metoda degresywna''&#xD;
    WHEN SrT_Metoda = 3 THEN ''Odpis jednorazowy''&#xD;
    WHEN SrT_Metoda = 4 THEN ''Metoda naturalna''&#xD;
    ELSE ''Inna''&#xD;
END [Metoda Amortyzacji],&#xD;
isnull(ZakladStr.Zak_Symbol,''(NIEPRZYPISANY)'') as [Produkt Zakład Symbol],&#xD;
isnull(ZakladStr.zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Produkt Zakład Nazwa Firmy],&#xD;
isnull(ZakladDok.Zak_Symbol,''(NIEPRZYPISANY)'') as [Dokument Zakład Symbol],&#xD;
isnull(ZakladDok.zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Dokument Zakład Nazwa Firmy],&#xD;
 1 [Ilość],&#xD;
NULL [Produkt Kategoria Amortyzacja], IsNull(kat2.Kat_KodSzczegol,''NIEOKREŚLONA'') [Produkt Kategoria],  &#xD;
case when SrH_TypDokumentu IN (4,6) THEN NULL else  MAX(SrT_WartoscBilan) END [Wartość Nabycia] , &#xD;
case when SrH_TypDokumentu IN (4,6) THEN NULL else MAX(SrT_WartoscKoszt) END [Wartość Nabycia Kosztowa], &#xD;
NULL [Koszty Amortyzacji],&#xD;
case when SrH_TypDokumentu IN (4,6) THEN NULL else SUM(IsNull(h1.SrH_KwotaBilan - h1.SrH_KwotaUm, 0)) END [Wartość Netto], &#xD;
case when SrH_TypDokumentU IN (4,6) THEN NULL else SUM(IsNull(h1.SrH_KwotaBilan, 0)) END [Wartość Brutto],&#xD;
NULL [Wartość w Czasie Netto], NULL [Wartość w Czasie Brutto]&#xD;
,case when SrH_TypDokumentu IN (4,6) THEN NULL else cast(SrT_Stawka as nvarchar(50)) END [Stawka amortyzacji Kosztowa]&#xD;
,case when SrH_TypDokumentu IN (4,6) THEN NULL else cast(SrT_StawkaBil as nvarchar(50)) END [Stawka amortyzacji Bilansowa]&#xD;
,case when SrH_TypDokumentu IN (4,6) THEN NULL else cast(SrT_Wspolczynnik as nvarchar(50)) END [Współczynnik amortyzacji Kosztowy]&#xD;
,case when SrH_TypDokumentu IN (4,6) THEN NULL else cast(SrT_WspolczynnikBil as nvarchar(50)) END [Współczynnik amortyzacji Bilansowy]&#xD;
, NULL  [Koszty Amortyzacji Bilansowe]&#xD;
&#xD;
' + @atrybuty + '&#xD;
,GETDATE() [Data Analizy]&#xD;
  ,REPLACE(CONVERT(VARCHAR(10), SrH_DataOpe, 111), ''/'', ''-'') [Data Dokumentu Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, SrH_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Dokumentu Tydzień Roku]&#xD;
    ,MONTH(SrH_DataOpe) [Data Dokumentu Miesiąc], DATEPART(quarter, SrH_DataOpe) [Data Dokumentu Kwartał], YEAR(SrH_DataOpe) [Data Dokumentu Rok] &#xD;
FROM CDN.TrwaleHist h1&#xD;
LEFT OUTER JOIN CDN.Trwale ON h1.SrH_SrTID = SrT_SrTID&#xD;
LEFT OUTER JOIN CDN.Kategorie kat2 ON kat2.Kat_KatId = SrT_KatId&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON SrT_SrTID = KonAtr.SrA_SrTId AND SrT_Typ = KonAtr.SrA_Typ&#xD;
&#xD;
LEFT OUTER JOIN CDN.Zaklady ZakladDok on ZakladDok.ZAK_ZAkID = h1.SrH_ZakID&#xD;
LEFT OUTER JOIN CDN.Zaklady ZakladStr on ZakladStr.ZAK_ZAkID = SrT_ZakID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
&#xD;
&#xD;
GROUP BY BAZ.Baz_Nazwa, SrT_Nazwa, SrT_NrInwent, SrT_KRST, SrT_DataPrz, SrT_DataLikw, SrT_Grupa, SrT_Typ, SrT_Stan, SrT_Metoda, kat2.Kat_KodSzczegol, &#xD;
ZakladDok.Zak_Symbol,ZakladDok.zak_NazwaFirmy,ZakladStr.Zak_Symbol,ZakladStr.zak_NazwaFirmy,SrT_Stawka,SrT_StawkaBil,SrT_Wspolczynnik,SrT_WspolczynnikBil,&#xD;
SrH_TypDokumentu,SrH_DataOpe ' + @atrybuty2 + '&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT&#xD;
BAZ.Baz_Nazwa [Baza Firmowa], Wyp_Nazwa [Produkt Nazwa], Wyp_NrInwent [Produkt Numer Inwentarzowy], ''Nie dotyczy'' [KŚT],&#xD;
REPLACE(CONVERT(VARCHAR(10), Wyp_DataZak, 111), ''/'', ''-'') [Data Przyjęcia Dzień],&#xD;
ISNULL(REPLACE(CONVERT(VARCHAR(10), Wyp_DataLikw, 111), ''/'', ''-''), ''W użyciu'') [Data Likwidacji Dzień],&#xD;
''Nie dotyczy'' [Produkt Grupa], NULL [Data Amortyzacji Rok], NULL [Data Amortyzacji Miesiąc], &#xD;
ISNULL((SELECT TOP 1 OO.WyOO_PrcImieNazwisko &#xD;
 FROM CDN.WyposazenieOsobyOdpowiedzialne OO &#xD;
 WHERE OO.WyOO_WypID = Wyp_WypID&#xD;
 ORDER BY OO.WyOO_DataOd DESC), ''Nieprzypisany'') [Osoba Odpowiedzialna], &#xD;
ISNULL((SELECT TOP 1 MU.WyMU_Nazwa &#xD;
 FROM CDN.WyposazenieMiejscaUzytkowania MU &#xD;
 WHERE MU.WyMU_WypID = Wyp_WypID &#xD;
 ORDER BY MU.WyMU_DataOd DESC), ''Nieprzypisany'') [Miejsce Użytkowania], &#xD;
''Wyposażenie'' [Produkt Typ],&#xD;
CASE &#xD;
    WHEN Wyp_Stan = 0 THEN ''W użyciu''&#xD;
    WHEN Wyp_Stan = 1 THEN ''Zlikwidowany''&#xD;
    WHEN Wyp_Stan = 2 THEN ''Zbyty''&#xD;
    ELSE ''Inny''&#xD;
END [Produkt Stan], &#xD;
''Nie dotyczy'' [Metoda Amortyzacji], &#xD;
''(NIEPRZYPISANY)'' as [Produkt Zakład Symbol],&#xD;
''(NIEPRZYPISANY)'' as [Produkt Zakład Nazwa Firmy],&#xD;
''(NIEPRZYPISANY)'' as [Dokument Zakład Symbol],&#xD;
''(NIEPRZYPISANY)'' as [Dokument Zakład Nazwa Firmy],&#xD;
&#xD;
Wyp_Ilosc [Ilość],&#xD;
NULL [Produkt Kategoria Amortyzacja], IsNull(kat2.Kat_KodSzczegol,''NIEOKREŚLONA'') [Produkt Kategoria],  &#xD;
Wyp_WartoscZakup [Wartość Nabycia], Wyp_WartoscZakup [Wartość Nabycia Kosztowa], NULL [Koszty Amortyzacji],&#xD;
Wyp_WartoscZakup [Wartość Netto], Wyp_WartoscZakup [Wartość Brutto],&#xD;
NULL [Wartość w Czasie Netto], NULL [Wartość w Czasie Brutto]&#xD;
,cast(''&lt;BRAK&gt;'' as nvarchar(50)) [Stawka amortyzacji Kosztowa]&#xD;
,cast(''&lt;BRAK&gt;'' as nvarchar(50)) [Stawka amortyzacji Bilansowa]&#xD;
,cast(''&lt;BRAK&gt;'' as nvarchar(50)) [Współczynnik amortyzacji Kosztowy]&#xD;
,cast(''&lt;BRAK&gt;'' as nvarchar(50)) [Współczynnik amortyzacji Bilansowy]&#xD;
, NULL  [Koszty Amortyzacji Bilansowe]&#xD;
&#xD;
' + @atrybuty + '&#xD;
,GETDATE() [Data Analizy]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), WyP_DataZak, 111), ''/'', ''-'') [Data Dokumentu Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, WyP_DataZak) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Dokumentu Tydzień Roku]&#xD;
    ,MONTH(WyP_DataZak) [Data Dokumentu Miesiąc], DATEPART(quarter, WyP_DataZak) [Data Dokumentu Kwartał], YEAR(WyP_DataZak) [Data Dokumentu Rok] &#xD;
 FROM CDN.Wyposazenie&#xD;
LEFT OUTER JOIN CDN.Kategorie kat2 ON kat2.Kat_KatId = Wyp_KatId&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON Wyp_WypID  = KonAtr.SrA_SrTId AND 13 = KonAtr.SrA_Typ&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
&#xD;
'&#xD;
&#xD;
EXEC(@select)&#xD;
DROP TABLE #tmpKonAtr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jsd7hyuUyC8Sdgsl2n/BMjJgiNky53VdN6s+A30dZyDERDxjVxsQnjHChMl6Nve0YtI0skB0usVvB/MqySffaOuuZqCzq0pKnvsjpaKhxxPwZ/2+ghwDXEmC4OPJDAAQ9iKNBEB706qqf90ELy4akSOPWmjMA2j25</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Numer Inwentarzowy" caption="Produkt Numer Inwentarzowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="KŚT" caption="KŚT" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Przyjęcia Dzień" caption="Data Przyjęcia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Likwidacji Dzień" caption="Data Likwidacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa" caption="Produkt Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Amortyzacji Rok" caption="Data Amortyzacji Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Amortyzacji Miesiąc" caption="Data Amortyzacji Miesiąc" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Stan" caption="Produkt Stan" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Metoda Amortyzacji" caption="Metoda Amortyzacji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Zakład Symbol" caption="Produkt Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Zakład Nazwa Firmy" caption="Produkt Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Zakład Symbol" caption="Dokument Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Zakład Nazwa Firmy" caption="Dokument Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ilość" caption="Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Amortyzacja" caption="Produkt Kategoria Amortyzacja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wartość Nabycia" caption="Wartość Nabycia" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Nabycia Kosztowa" caption="Wartość Nabycia Kosztowa" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszty Amortyzacji" caption="Koszty Amortyzacji" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Netto" caption="Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Brutto" caption="Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość w Czasie Netto" caption="Wartość w Czasie Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość w Czasie Brutto" caption="Wartość w Czasie Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Stawka amortyzacji Kosztowa" caption="Stawka amortyzacji Kosztowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Stawka amortyzacji Bilansowa" caption="Stawka amortyzacji Bilansowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Współczynnik amortyzacji Kosztowy" caption="Współczynnik amortyzacji Kosztowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Współczynnik amortyzacji Bilansowy" caption="Współczynnik amortyzacji Bilansowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Koszty Amortyzacji Bilansowe" caption="Koszty Amortyzacji Bilansowe" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Analizy" caption="Data Analizy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Dzień" caption="Data Dokumentu Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Tydzień Roku" caption="Data Dokumentu Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Miesiąc" caption="Data Dokumentu Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Kwartał" caption="Data Dokumentu Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Rok" caption="Data Dokumentu Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Osoba Odpowiedzialna Od Dzień" caption="Data Osoba Odpowiedzialna Od Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Osoba Odpowiedzialna Od Tydzień Roku" caption="Data Osoba Odpowiedzialna Od Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Osoba Odpowiedzialna Od Miesiąc" caption="Data Osoba Odpowiedzialna Od Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Osoba Odpowiedzialna Od Kwartał" caption="Data Osoba Odpowiedzialna Od Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Osoba Odpowiedzialna Od Rok" caption="Data Osoba Odpowiedzialna Od Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Osoba Odpowiedzialna Do Dzień" caption="Data Osoba Odpowiedzialna Do Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Osoba Odpowiedzialna Do Tydzień Roku" caption="Data Osoba Odpowiedzialna Do Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Osoba Odpowiedzialna Do Miesiąc" caption="Data Osoba Odpowiedzialna Do Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Osoba Odpowiedzialna Do Kwartał" caption="Data Osoba Odpowiedzialna Do Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Osoba Odpowiedzialna Do Rok" caption="Data Osoba Odpowiedzialna Do Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miejsce Użytkowania Od Dzień" caption="Data Miejsce Użytkowania Od Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miejsce Użytkowania Od Tydzień Roku" caption="Data Miejsce Użytkowania Od Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miejsce Użytkowania Od Miesiąc" caption="Data Miejsce Użytkowania Od Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miejsce Użytkowania Od Kwartał" caption="Data Miejsce Użytkowania Od Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miejsce Użytkowania Od Rok" caption="Data Miejsce Użytkowania Od Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miejsce Użytkowania Do Dzień" caption="Data Miejsce Użytkowania Do Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miejsce Użytkowania Do Tydzień Roku" caption="Data Miejsce Użytkowania Do Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miejsce Użytkowania Do Miesiąc" caption="Data Miejsce Użytkowania Do Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miejsce Użytkowania Do Kwartał" caption="Data Miejsce Użytkowania Do Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miejsce Użytkowania Do Rok" caption="Data Miejsce Użytkowania Do Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Miejsce Użytkowania" caption="Miejsce Użytkowania" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Osoba Odpowiedzialna" caption="Osoba Odpowiedzialna" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ilość Środków Trwałych" caption="Ilość Środków Trwałych" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="261" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Środków Trwałych wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje na temat środków trwałych i wyposażenia w firmie. Umożliwia analizę kosztów amortyzacji i zmian wartości środków trwałych w czasie. W przypadku jeśli w ciągu miesiąca nastąpiła zmiana osoby odpowiedzialnej lub miejsca użytkowania środka trwałego pokazywana jest osoba i miejsce przypisane na początku danego miesiąca.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.Trwale - tabela zawierająca kartoteki środków trwałych oraz wartości niematerialnych i prawnych. &#xD;
CDN.TrwaleHist - tabela zawiera wszystkie dokumenty związane ze środkiem trwałym: amortyzacje, przeszacowania i ulepszenia (zmiany wartości) &#xD;
CDN.Wyposazenie - tabela zawierająca ewidencję wyposażenia</a:description><a:id>16</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>16. Raport Środków Trwałych</a:mainLinkName><a:modifiedOn>2025-05-22T16:33:44.757</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-04-20T11:46:44.297</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/*&#xD;
* Raport Handlowy&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
declare @wartosc1 varchar(20);&#xD;
set @wartosc1 = case when @wartosc = 'Wartość Netto' then 'Tre_WartoscNetto' else 'Tre_WartoscZakupu' end;&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @kolumny2 varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @kolumny2 = @kolumny2 + ',Poz.Poziom' +LTRIM(@i)&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select =&#xD;
'SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    MAX(Twr_Kod) [Produkt Kod], &#xD;
    MAX(Twr_Nazwa) [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
    MAX(CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
    END) [Produkt Typ],&#xD;
    --ISNULL(Mag_Symbol,''(BRAK)'') [Magazyn Nazwa],&#xD;
    ISNULL(MAX(Kat_KodOgolny),''(NIEOKREŚLONA)'')  [Produkt Kategoria Ogólna], ISNULL(MAX(Kat_KodSzczegol),''(NIEOKREŚLONA)'') [Produkt Kategoria Szczegółowa], MAX(Twr_JM) [Jednostka Miary], &#xD;
    "Ilość Stan Początkowy H"=0, "Ilość Stan Początkowy M"=0, &#xD;
    "Ilość FZ"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
    "Ilość FS"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
    "Ilość PA"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
    "Ilość PZ"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
    "Ilość PKA"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
    "Ilość PW"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
    "Ilość MM OL"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
    "Ilość WZ"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
    "Ilość WKA"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
    "Ilość RW"=SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
    "Ilość MM LO"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
    "Ilość MM"= SUM( IsNull(TrE_Ilosc,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
    "Ilość Stan Początkowy H Jednostka Pomocnicza"=0, "Ilość Stan Początkowy M Jednostka Pomocnicza"=0, &#xD;
    "Ilość FZ Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
    "Ilość FS Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
    "Ilość PA Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
    "Ilość PZ Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
    "Ilość PKA Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
    "Ilość PW Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
    "Ilość MM OL Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
    "Ilość WZ Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
    "Ilość WKA Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
    "Ilość RW Jednostka Pomocnicza"=SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
    "Ilość MM LO Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
    "Ilość MM Jednostka Pomocnicza"= SUM( IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
    "Wartość Stan Początkowy H"=0, "Wartość Stan Początkowy M"=0, &#xD;
    "Wartość FZ"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 ELSE 0 END), &#xD;
    "Wartość FS"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=302 THEN 1 ELSE 0 END), &#xD;
    "Wartość PA"=SUM(IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=305 THEN 1 ELSE 0 END), &#xD;
    "Wartość PZ"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=307 THEN 1 ELSE 0 END),&#xD;
    "Wartość PKA"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=313 THEN 1 ELSE 0 END),&#xD;
    "Wartość PW"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu IN (310,303,317) THEN 1 ELSE 0 END),&#xD;
    "Wartość MM OL"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312010 THEN 1 ELSE 0 END),&#xD;
    "Wartość WZ"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=306 THEN 1 ELSE 0 END),&#xD;
    "Wartość WKA"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu=314 THEN 1 ELSE 0 END),&#xD;
    "Wartość RW"=SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu IN (304,318) THEN 1 ELSE 0 END),&#xD;
    "Wartość MM LO"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj = 312100 THEN 1 ELSE 0 END),&#xD;
    "Wartość MM"= SUM( IsNull(' + @wartosc1 + ',0)*CASE WHEN TrE_TypDokumentu = 312 AND TrN_Rodzaj IN (312000,312001,312008) THEN 1 ELSE 0 END),&#xD;
    "Operator Wprowadzający" = zal.Ope_Kod,&#xD;
    "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
    "Data Analizy" = GETDATE()&#xD;
    ----------KONTEKSTY&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__], '''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
&#xD;
' + @kolumny + &#xD;
' FROM CDN.Towary&#xD;
    LEFT OUTER JOIN cdn.TraElem ON TrE_TwrID=Twr_TwrID&#xD;
    LEFT OUTER JOIN cdn.TraNag  ON TrN_TrNID=TrE_TrNID&#xD;
    LEFT OUTER JOIN cdn.Magazyny ON Mag_MagID=ISNULL([TrN_MagDocId],TrN_MagZrdID)&#xD;
    LEFT OUTER JOIN cdn.Kategorie ON Kat_KatID=Twr_KatID&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
WHERE (TrN_Bufor&lt;&gt;-1  &#xD;
--AND TrN_Korekta IN (0,1) &#xD;
OR TrN_TrNID IS NULL)&#xD;
    AND (((TrE_TypDokumentu IN (302,304,305,306,314,318) OR TrN_Rodzaj IN (312100)&#xD;
    OR ((TrE_TypDokumentu IN (301,310,303,307,313,317) OR TrN_Rodzaj IN (312010) OR TrN_Rodzaj IN (312000,312001,312008)) AND TrN_Bufor=0)) &#xD;
    AND TrE_Aktywny&lt;&gt;0) OR TrE_TrEID IS NULL)&#xD;
    AND (TrN_DataOpe BETWEEN CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD,120) + ''',120) AND CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATADO,120) + ''',120) OR TrE_TrEID IS NULL)  &#xD;
GROUP BY BAZ.Baz_Nazwa, Twr_TwrID, Twr_NieAktywny, TWR_SWW, knt4.Knt_Kod, Twr_JMZ, Mag_Symbol, Mag_MagId, zal.Ope_Kod, mod.Ope_Kod' + @kolumny2 + '&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    MAX(Twr_Kod) [Produkt Kod], &#xD;
    MAX(Twr_Nazwa) [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Produkt Jednostka Miary Pomocnicza],&#xD;
    MAX(CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
    END) [Produkt Typ],&#xD;
    --ISNULL(Mag_Symbol,''(BRAK)'') [Magazyn Nazwa],&#xD;
    ISNULL(MAX(Kat_KodOgolny),''(NIEOKREŚLONA)'') [Produkt Kategoria Ogólna], ISNULL(MAX(Kat_KodSzczegol),''(NIEOKREŚLONA)'')  [Produkt Kategoria Szczegółowa], MAX(Twr_JM) [Jednostka Miary], &#xD;
    "Ilość Stan Początkowy H"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TRN_Rodzaj = 312010 then 1  WHEN TRN_Rodzaj = 312100 THEN -1 WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END), &#xD;
    "Ilość Stan Początkowy M"=SUM(IsNull(TrE_Ilosc,0)*CASE WHEN TRN_Rodzaj = 312010 then 1  WHEN TRN_Rodzaj = 312100 THEN -1 WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305,312) THEN 0 ELSE -1 END), &#xD;
    "Ilość FZ"=0, "Ilość FS"=0, "Ilość PA"=0, "Ilość PZ"=0, "Ilość PKA"=0, "Ilość PW"=0, "Ilość MM OL"=0, "Ilość WZ"=0, "Ilość WKA"=0, "Ilość RW"=0, "Ilość MM LO"=0,&#xD;
    "Ilość MM" = 0,&#xD;
    "Ilość Stan Początkowy H Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END),&#xD;
     "Ilość Stan Początkowy M Jednostka Pomocnicza"=SUM(IsNull(TrE_Ilosc*Twr_JMPrzelicznikM/Twr_JMPrzelicznikL,0)*CASE WHEN TRN_Rodzaj = 312010 then 1  WHEN TRN_Rodzaj = 312100 THEN -1  WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305,312) THEN 0 ELSE -1 END),  &#xD;
    "Ilość FZ Jednostka Pomocnicza"=0, "Ilość FS Jednostka Pomocnicza"=0,   "Ilość PA Jednostka Pomocnicza"=0, "Ilość PZ Jednostka Pomocnicza"=0,   "Ilość PKA Jednostka Pomocnicza"=0, "Ilość PW Jednostka Pomocnicza"=0, "Ilość MM OL Jednostka Pomocnicza"=0, &#xD;
    "Ilość WZ Jednostka Pomocnicza"=0,  "Ilość WKA Jednostka Pomocnicza"=0, "Ilość RW Jednostka Pomocnicza"=0, "Ilość MM LO Jednostka Pomocnicza"=0,&#xD;
    "Ilość MM Jednostka Pomocnicza" = 0,&#xD;
    "Wartość Stan Początkowy H"=SUM(IsNull(' + @wartosc1 + ',''0'')*CASE WHEN TrE_TypDokumentu=301 THEN 1 WHEN TrE_TypDokumentu IN (302,305) THEN -1 ELSE 0 END), &#xD;
    "Wartość Stan Początkowy M"=SUM(IsNull(' + @wartosc1 + ',''0'')*CASE WHEN TRN_Rodzaj = 312010 then 1  WHEN TRN_Rodzaj = 312100 THEN -1 WHEN TrE_TypDokumentu IN (310,303,307,313,317) THEN 1 WHEN TrE_TypDokumentu IN (301,302,305,312) THEN 0 ELSE -1 END), &#xD;
    "Wartość FZ"=0, "Wartość FS"=0, "Wartość PA"=0, "Wartość PZ"=0, "Wartość PKA"=0, "Wartość PW"=0, "Wartość MM OL"=0, "Wartość WZ"=0, "Wartość WKA"=0, "Wartość RW"=0, "Wartość MM LO"=0,&#xD;
    "Wartość MM"=0,&#xD;
    "Operator Wprowadzający" = zal.Ope_Kod,&#xD;
    "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
    "Data Analizy" = GETDATE()&#xD;
    ----------KONTEKSTY&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__], '''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__], '''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
&#xD;
' + @kolumny + &#xD;
' FROM CDN.Towary&#xD;
    LEFT OUTER JOIN cdn.TraElem ON TrE_TwrID=Twr_TwrID&#xD;
    LEFT OUTER JOIN cdn.TraNag  ON TrN_TrNID=TrE_TrNID&#xD;
    LEFT OUTER JOIN cdn.Magazyny ON Mag_MagID=TrN_MagZrdID&#xD;
    LEFT OUTER JOIN cdn.Kategorie ON Kat_KatID=Twr_KatID&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON Twr_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON Twr_OpeModID = mod.Ope_OpeId&#xD;
WHERE (TrN_Bufor&lt;&gt;-1 &#xD;
--AND TrN_Korekta IN (0,1) &#xD;
OR TrN_TrNID IS NULL)&#xD;
    AND (((TrE_TypDokumentu IN (302,304,305,306,314,318) OR TrN_Rodzaj IN (312100)&#xD;
    OR ((TrE_TypDokumentu IN (301,310,303,307,313,317) OR TrN_Rodzaj IN (312010) OR TrN_Rodzaj IN (312000,312001,312008)) AND TrN_Bufor=0)) &#xD;
    AND TrE_Aktywny&lt;&gt;0) OR TrE_TrEID IS NULL)&#xD;
    AND (TrN_DataOpe &lt; CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD, 120) + ''',120) OR TrE_TrEID IS NULL)  &#xD;
GROUP BY BAZ.Baz_Nazwa, Twr_TwrID, Twr_NieAktywny, TWR_SWW, knt4.Knt_Kod, Twr_JMZ, zal.Ope_Kod, mod.Ope_Kod' + @kolumny2&#xD;
&#xD;
exec (@select)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QHRUwalZ8pMVJl4bnvAvbQJZcV6Wn+9eyurT5z7pvsx453uBpU8ZVZBU3sxojq0nr7SEb6pIcBltbZneCkQXihh2PJK4OnljQYqeZz6oFgeKpqUN1a0P8/X1EVgEjUyAynh2e+VUqmLaTxvo2adC1y/WjNl2Vo5HaL2i46mtibOu7HvVCLZ13K</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Jednostka Miary Pomocnicza" caption="Produkt Jednostka Miary Pomocnicza" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Ogólna" caption="Produkt Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria Szczegółowa" caption="Produkt Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy H" caption="Ilość Stan Początkowy H" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy M" caption="Ilość Stan Początkowy M" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FZ" caption="Ilość FZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FS" caption="Ilość FS" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PA" caption="Ilość PA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PZ" caption="Ilość PZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PKA" caption="Ilość PKA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PW" caption="Ilość PW" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM OL" caption="Ilość MM OL" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WZ" caption="Ilość WZ" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WKA" caption="Ilość WKA" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość RW" caption="Ilość RW" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM LO" caption="Ilość MM LO" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM" caption="Ilość MM" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy H Jednostka Pomocnicza" caption="Ilość Stan Początkowy H Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość Stan Początkowy M Jednostka Pomocnicza" caption="Ilość Stan Początkowy M Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FZ Jednostka Pomocnicza" caption="Ilość FZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość FS Jednostka Pomocnicza" caption="Ilość FS Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PA Jednostka Pomocnicza" caption="Ilość PA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PZ Jednostka Pomocnicza" caption="Ilość PZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PKA Jednostka Pomocnicza" caption="Ilość PKA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość PW Jednostka Pomocnicza" caption="Ilość PW Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM OL Jednostka Pomocnicza" caption="Ilość MM OL Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WZ Jednostka Pomocnicza" caption="Ilość WZ Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość WKA Jednostka Pomocnicza" caption="Ilość WKA Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość RW Jednostka Pomocnicza" caption="Ilość RW Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM LO Jednostka Pomocnicza" caption="Ilość MM LO Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość MM Jednostka Pomocnicza" caption="Ilość MM Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Stan Początkowy H" caption="Wartość Stan Początkowy H" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Stan Początkowy M" caption="Wartość Stan Początkowy M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość FZ" caption="Wartość FZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość FS" caption="Wartość FS" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PA" caption="Wartość PA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PZ" caption="Wartość PZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PKA" caption="Wartość PKA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość PW" caption="Wartość PW" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM OL" caption="Wartość MM OL" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość WZ" caption="Wartość WZ" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość WKA" caption="Wartość WKA" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość RW" caption="Wartość RW" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM LO" caption="Wartość MM LO" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość MM" caption="Wartość MM" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" caption="Ilość Stan Końcowy M" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" caption="Ilość Stan Końcowy H" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" caption="Wartość Stan Końcowy M" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" caption="Wartość Stan Końcowy H" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[181be47b-ee11-4e2b-8156-9ec187b983f3]" caption="Przychód Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[e6485a6b-23c5-49c8-b320-480299d8f79a]" caption="Przychód Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[d4bad69d-ee14-4b67-82f4-be5b58801ce0]" caption="Rozchód Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[4e2d8baf-1300-45d7-b7f7-bbe999e66809]" caption="Rozchód Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[e0755fa4-408d-45d3-a3cc-c3fdd16114a0]" caption="Ilość Stan Końcowy H Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[756f4713-3261-4d56-85f3-4fd748ffefc3]" caption="Ilość Stan Końcowy M Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[6c5b0e50-b645-4138-85c5-9f68085ed4b2]" caption="Przychód Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[dcaef927-08f6-429b-9c3f-64c44a9ce98f]" caption="Rozchód Ilość Jednostka Pomocnicza" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Od dnia:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początkowa okresu analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-04-09&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Do dnia:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data końcowa okresu analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-05-09&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;WARTOSC&lt;/Name&gt;&#xD;
    &lt;Label&gt;Wartość&lt;/Label&gt;&#xD;
    &lt;Expression&gt;'Wartość Netto'; 'Wartość Zakupu'
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue /&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="244" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[e299e4a1-cd1d-4a6c-98f5-00c35807c5aa]" caption="Ilość Stan Końcowy M" formula="Ilość Stan Początkowy M + Ilość PZ + Ilość PKA + Ilość PW + Ilość MM OL - Ilość WZ - Ilość WKA - Ilość RW - Ilość MM LO" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[a2752ad6-8d52-4e47-ba81-3fe3c00c84d0]" caption="Ilość Stan Końcowy H" formula="Ilość Stan Początkowy H + Ilość FZ - Ilość FS - Ilość PA" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[ce8a10fb-2870-482e-9d12-4b26cf157915]" caption="Wartość Stan Końcowy M" formula="Wartość Stan Początkowy M + Wartość PZ + Wartość PKA + Wartość PW + Wartość MM OL - Wartość WZ - Wartość WKA - Wartość RW - Wartość MM LO" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[f2f58138-2ade-41e6-921e-fe1c7b9688f6]" caption="Wartość Stan Końcowy H" formula="Wartość Stan Początkowy H + Wartość FZ - Wartość FS - Wartość PA" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[181be47b-ee11-4e2b-8156-9ec187b983f3]" caption="Przychód Ilość" formula="Ilość Stan Początkowy M + Ilość PZ + Ilość PKA + Ilość PW + Ilość MM OL +&amp;#xD;&amp;#xA;Ilość MM" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[e6485a6b-23c5-49c8-b320-480299d8f79a]" caption="Przychód Wartość" formula="Wartość Stan Początkowy M + Wartość PZ + Wartość PKA + Wartość PW + Wartość MM OL + Wartość MM" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[d4bad69d-ee14-4b67-82f4-be5b58801ce0]" caption="Rozchód Ilość" formula="Ilość WZ + Ilość WKA + Ilość RW + Ilość MM LO +&amp;#xD;&amp;#xA;Ilość MM" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[4e2d8baf-1300-45d7-b7f7-bbe999e66809]" caption="Rozchód Wartość" formula="Wartość WZ + Wartość WKA + Wartość RW + Wartość MM LO + Wartość MM" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[e0755fa4-408d-45d3-a3cc-c3fdd16114a0]" caption="Ilość Stan Końcowy H Jednostka Pomocnicza" formula="Ilość Stan Początkowy H Jednostka Pomocnicza + Ilość FZ Jednostka Pomocnicza - Ilość FS Jednostka Pomocnicza - Ilość PA Jednostka Pomocnicza" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[756f4713-3261-4d56-85f3-4fd748ffefc3]" caption="Ilość Stan Końcowy M Jednostka Pomocnicza" formula="Ilość Stan Początkowy M Jednostka Pomocnicza + Ilość PZ Jednostka Pomocnicza + Ilość PKA Jednostka Pomocnicza + Ilość PW Jednostka Pomocnicza + Ilość MM OL Jednostka Pomocnicza - Ilość WZ Jednostka Pomocnicza - Ilość WKA Jednostka Pomocnicza - Ilość RW Jednostka Pomocnicza - Ilość MM LO Jednostka Pomocnicza" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[6c5b0e50-b645-4138-85c5-9f68085ed4b2]" caption="Przychód Ilość Jednostka Pomocnicza" formula="Ilość Stan Początkowy M Jednostka Pomocnicza + Ilość PZ Jednostka Pomocnicza + Ilość PKA Jednostka Pomocnicza + Ilość PW Jednostka Pomocnicza + Ilość MM OL Jednostka Pomocnicza +&amp;#xD;&amp;#xA;Ilość MM Jednostka Pomocnicza" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[dcaef927-08f6-429b-9c3f-64c44a9ce98f]" caption="Rozchód Ilość Jednostka Pomocnicza" formula="Ilość WZ Jednostka Pomocnicza + Ilość WKA Jednostka Pomocnicza + Ilość RW Jednostka Pomocnicza + Ilość MM LO Jednostka Pomocnicza +&amp;#xD;&amp;#xA;Ilość MM Jednostka Pomocnicza" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Handlowy wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera zbiorcze informacje ze wszystkich dokumentów handlowych i magazynowych dla danego produktu. Na jego podstawie można analizować sprzedaż i zakupy towarów dla poszczególnych typów dokumentów handlowych i magazynowych. Raport wykonywany jest dla dokumentów z zadanego okresu czasu. Datę początkową i końcową okresu należy podać za pomocą parametrów podczas uruchamiania raportu.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (faktur, paragonów itp.). &#xD;
TraElem - Tabela z elementami dokumentów (faktur, paragonów itp.).</a:description><a:id>17</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>17. Raport Handlowy</a:mainLinkName><a:modifiedOn>2025-04-11T08:50:52.743</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-05-15T10:49:45.443</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport CRM&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
       IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
       IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
       SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
       SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
             SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
               ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END&#xD;
              END  &#xD;
             FROM CDN.KntAtrybuty ATR &#xD;
             JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
             WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
       EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'        &#xD;
       SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'      &#xD;
       FETCH NEXT FROM atrybut_cursor&#xD;
       INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_crkId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_crkId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
       IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
       IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
       SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
       SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
             SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
               ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END&#xD;
              END  &#xD;
             FROM CDN.DokAtrybuty ATR &#xD;
             JOIN #tmpDokAtr TM ON ATR.DAt_crkId = TM.DAt_crkId &#xD;
             WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
       EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
       FETCH NEXT FROM atrybut_cursor&#xD;
       INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
select count(*) as Ilosc, DoR_ParentId&#xD;
INTO #DokPowiazaneIlosc&#xD;
from cdn.DokRelacje&#xD;
WHERE DoR_ParentTyp=700 &#xD;
GROUP BY  DoR_ParentId&#xD;
&#xD;
-- &#xD;
--Właściwe zapytanie&#xD;
DECLARE @select varchar(max);&#xD;
SET @select =&#xD;
'SELECT  &#xD;
       BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
       pod1.Pod_NIP [Kontrahent Pierwotny NIP],       &#xD;
       pod1.Pod_Kod [Kontrahent Pierwotny Kod],     &#xD;
       pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
       pod5.Pod_NIP [Kontrahent NIP],  &#xD;
       pod5.Pod_Kod [Kontrahent Kod],        &#xD;
       pod5.Pod_Nazwa1 [Kontrahent Nazwa],        &#xD;
       k1.CRK_NumerPelny [Dokument Numer],      &#xD;
       k1.CRK_OsobaNazwisko [Kontrahent Pierwotny Osoba Kontaktowa],&#xD;
       k1.CRK_OsobaNazwisko [Kontrahent Osoba Kontaktowa],&#xD;
       k1.CRK_Temat [Dokument Temat], ISNULL(DEt_Kod, ''(NIEPRZYPISANY)'') [Etap Realizacji], COALESCE(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa],&#xD;
       COALESCE(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa],&#xD;
       CASE &#xD;
             WHEN k1.CRK_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANY)'')&#xD;
             WHEN k1.CRK_OpiekunTyp = 8 THEN ISNULL(ope.Ope_Kod, ''(NIEPRZYPISANY)'')&#xD;
             ELSE ''(NIEPRZYPISANE)'' &#xD;
       END [Kontrahent Pierwotny Opiekun],&#xD;
       CASE &#xD;
             WHEN k1.CRK_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANY)'')&#xD;
             WHEN k1.CRK_OpiekunTyp = 8 THEN ISNULL(ope.Ope_Kod, ''(NIEPRZYPISANY)'')&#xD;
             ELSE ''(NIEPRZYPISANE)'' &#xD;
       END [Kontrahent Opiekun],&#xD;
       isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
       isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
       CASE&#xD;
             WHEN k1.CRK_Priorytet = 1 THEN ''Najwyższy'' &#xD;
              WHEN k1.CRK_Priorytet = 2 THEN ''Wysoki'' &#xD;
             WHEN k1.CRK_Priorytet = 3 THEN ''Niski''&#xD;
             ELSE ''Najniższy''&#xD;
       END [Zadanie Priorytet],&#xD;
       CASE &#xD;
             WHEN k1.CRK_Zadanie = 1 THEN ''Zadanie''&#xD;
             ELSE ''Kontakt''&#xD;
       END [Rodzaj],&#xD;
       CASE&#xD;
             WHEN k1.CRK_Obsluga = 0 THEN ''Przed Sprzedażą''&#xD;
             ELSE ''Po Sprzedaży''&#xD;
       END [Obsługa],&#xD;
       CASE&#xD;
             WHEN k1.CRK_Bufor = -1 THEN ''Anulowany''&#xD;
             WHEN k1.CRK_Bufor = 0 THEN ''Zamknięty''&#xD;
             ELSE ''Niezamknięty''&#xD;
       END [Dokument Realizacja],&#xD;
       CASE&#xD;
             WHEN DATEDIFF(day, k1.CRK_TerminOd, GETDATE()) = 0 THEN ''Dziejsze''&#xD;
             WHEN DATEDIFF(day, k1.CRK_TerminOd, GETDATE() + 1) = 0 THEN ''Jutrzejsze''&#xD;
             WHEN DATEDIFF(day, k1.CRK_TerminOd, GETDATE()) &gt; 0 THEN ''Przeterminowane''&#xD;
             ELSE ''Późniejsze''&#xD;
       END [Termin Zadania],&#xD;
       k2.CRK_NumerPelny [Wątek Numer], k2.CRK_Temat [Wątek Temat], &#xD;
        REPLACE(CONVERT(VARCHAR(10), k1.CRK_TerminOd, 111), ''/'', ''-'') [Termin Od Dzień], SUBSTRING(CONVERT(VARCHAR,k1.CRK_TerminOd,108),1,5) [Termin Od Godzina],&#xD;
       REPLACE(CONVERT(VARCHAR(10), k1.CRK_TerminDo, 111), ''/'', ''-'') [Termin Do Dzień], SUBSTRING(CONVERT(VARCHAR,k1.CRK_TerminDo,108),1,5) [Termin Do Godzina],&#xD;
       (DATEDIFF(mi, CONVERT(DATETIME,''1899-12-30'',120), k1.CRK_CzasKontaktu) +  DATEDIFF(mi, CONVERT(DATETIME,''1899-12-30'',120), k1.CRK_CzasOpracow ) + DATEDIFF(mi, CONVERT(DATETIME,''1899-12-30'',120), k1.CRK_CzasPrzygot))/(24*60) [Czas Kontaktu Dni],&#xD;
       ((DATEDIFF(mi, CONVERT(DATETIME,''1899-12-30'',120), k1.CRK_CzasKontaktu) +  DATEDIFF(mi, CONVERT(DATETIME,''1899-12-30'',120), k1.CRK_CzasOpracow ) + DATEDIFF(mi, CONVERT(DATETIME,''1899-12-30'',120), k1.CRK_CzasPrzygot))/60)%24 [Czas Kontaktu Godziny],&#xD;
       (DATEPART(mi, k1.CRK_CzasPrzygot) + DATEPART(mi, k1.CRK_CzasOpracow) + DATEPART(mi, k1.CRK_CzasKontaktu))%60 [Czas Kontaktu Minuty],&#xD;
       DATEDIFF(day, CONVERT(DATETIME,''1899-12-30'',120), k1.CRK_CzasPrzygot ) [Czas Przygotowania Dni],&#xD;
       DATEPART(hh, k1.CRK_CzasPrzygot)%24 [Czas Przygotowania Godziny],&#xD;
       DATEPART(mi, k1.CRK_CzasPrzygot)%60 [Czas Przygotowania Minuty],&#xD;
       DATEDIFF(day, CONVERT(DATETIME,''1899-12-30'',120), k1.CRK_CzasOpracow ) [Czas Opracowania Dni],&#xD;
       DATEPART(hh, k1.CRK_CzasOpracow)%24 [Czas Opracowania Godziny],&#xD;
       DATEPART(mi, k1.CRK_CzasOpracow)%60 [Czas Opracowania Minuty],&#xD;
       DATEDIFF(day, CONVERT(DATETIME,''1899-12-30'',120), k1.CRK_CzasKontaktu ) [Czas Rozmowy Dni],&#xD;
       DATEPART(hh, k1.CRK_CzasKontaktu)%24 [Czas Rozmowy Godziny],&#xD;
       DATEPART(mi, k1.CRK_CzasKontaktu)%60 [Czas Rozmowy Minuty],&#xD;
       1.0/ISNULL(ilosc,1) [Liczba Dokumentów],&#xD;
       case when dor_dokumenttyp=700 then k3.crk_numerpelny &#xD;
           when dor_dokumenttyp=1007 then srh_numer&#xD;
           when dor_dokumenttyp=999 then  van_dokument&#xD;
           when dor_dokumenttyp=900 then srz_numerpelny&#xD;
           when dor_dokumenttyp=302 then trn_numerpelny&#xD;
           when dor_dokumenttyp=304 then trn_numerpelny&#xD;
           when dor_dokumenttyp=303 then trn_numerpelny&#xD;
             when dor_dokumenttyp=301 then trn_numerpelny&#xD;
             when dor_dokumenttyp=305 then trn_numerpelny&#xD;
             when dor_dokumenttyp=320 then trn_numerpelny&#xD;
             when dor_dokumenttyp=308 then trn_numerpelny&#xD;
             when dor_dokumenttyp=309 then trn_numerpelny&#xD;
             when dor_dokumenttyp=322 then trn_numerpelny&#xD;
             when dor_dokumenttyp=321 then trn_numerpelny&#xD;
             when dor_dokumenttyp=350 then trn_numerpelny&#xD;
             when dor_dokumenttyp=345 then trn_numerpelny&#xD;
             when dor_dokumenttyp=306 then trn_numerpelny&#xD;
             when dor_dokumenttyp=307 then trn_numerpelny&#xD;
             when dor_dokumenttyp=304 then trn_numerpelny&#xD;
             when dor_dokumenttyp=303 then trn_numerpelny&#xD;
             when dor_dokumenttyp=312 then trn_numerpelny&#xD;
             when dor_dokumenttyp=310 then trn_numerpelny&#xD;
             when dor_dokumenttyp=311 then trn_numerpelny&#xD;
             when dor_dokumenttyp=317 then trn_numerpelny&#xD;
             when dor_dokumenttyp=318 then trn_numerpelny&#xD;
             when dor_dokumenttyp=314 then trn_numerpelny&#xD;
             when dor_dokumenttyp=313 then trn_numerpelny&#xD;
           else ''Brak Powiązanych''  end  [Dokumenty Powiazane],&#xD;
       case &#xD;
           when dor_dokumenttyp=1007 then convert(float,SrH_KwotaAm)&#xD;
           when dor_dokumenttyp=999 then  convert(float,van_razemnetto)&#xD;
           when dor_dokumenttyp=900 then convert(float,srz_wartoscnetto)&#xD;
             when dor_dokumenttyp=302 then convert(float,trn_razemnetto)&#xD;
           when dor_dokumenttyp=304 then convert(float,trn_razemnetto)&#xD;
           when dor_dokumenttyp=303 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=301 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=305 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=320 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=308 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=309 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=322 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=321 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=350 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=345 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=306 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=307 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=304 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=303 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=312 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=310 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=311 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=317 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=318 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=314 then convert(float,trn_razemnetto)&#xD;
             when dor_dokumenttyp=313 then convert(float,trn_razemnetto)&#xD;
         else null end [Dokumenty Powiązane Wartość]&#xD;
       ,CASE when dor_dokumenttyp=700 then 1&#xD;
             when dor_dokumenttyp=1007 then 1&#xD;
             when dor_dokumenttyp=999 then  1&#xD;
             when dor_dokumenttyp=900 then 1&#xD;
             when dor_dokumenttyp=302 then 1&#xD;
             when dor_dokumenttyp=304 then 1&#xD;
             when dor_dokumenttyp=303 then 1&#xD;
             when dor_dokumenttyp=301 then 1&#xD;
             when dor_dokumenttyp=305 then 1&#xD;
             when dor_dokumenttyp=320 then 1&#xD;
             when dor_dokumenttyp=308 then 1&#xD;
             when dor_dokumenttyp=309 then 1&#xD;
             when dor_dokumenttyp=322 then 1&#xD;
             when dor_dokumenttyp=321 then 1&#xD;
             when dor_dokumenttyp=350 then 1&#xD;
             when dor_dokumenttyp=345 then 1&#xD;
             when dor_dokumenttyp=306 then 1&#xD;
             when dor_dokumenttyp=307 then 1&#xD;
             when dor_dokumenttyp=304 then 1&#xD;
             when dor_dokumenttyp=303 then 1&#xD;
             when dor_dokumenttyp=312 then 1&#xD;
             when dor_dokumenttyp=310 then 1&#xD;
             when dor_dokumenttyp=311 then 1&#xD;
             when dor_dokumenttyp=317 then 1&#xD;
             when dor_dokumenttyp=318 then 1&#xD;
             when dor_dokumenttyp=314 then 1&#xD;
             when dor_dokumenttyp=313 then 1&#xD;
     else NULL end  [Dokumenty Powiązane Liczba] &#xD;
     ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
     ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
     /*&#xD;
     ----------DATY POINT&#xD;
      ,REPLACE(CONVERT(VARCHAR(10), k1.CRK_DataDok, 111), ''/'', ''-'') [Data Dokumentu]&#xD;
     */&#xD;
     ----------DATY ANALIZY&#xD;
      ,REPLACE(CONVERT(VARCHAR(10), k1.CRK_DataDok, 111), ''/'', ''-'') [Data Dokumentu Dzień], (datepart(DY, datediff(d, 0, k1.CRK_DataDok) / 7 * 7 + 3)+6) / 7 [Data Dokumentu Tydzień Roku]&#xD;
      ,MONTH(k1.CRK_DataDok) [Data Dokumentu Miesiąc], DATEPART(quarter, k1.CRK_DataDok) [Data Dokumentu Kwartał], YEAR(k1.CRK_DataDok) [Data Dokumentu Rok]&#xD;
      ,GETDATE() [Data Analizy]&#xD;
     ----------KONTEKSTY&#xD;
       ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
       ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
       ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
       ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
       ,29095 [Dokument Numer __PROCID__Sprzedaz__], k1.CRK_CRKId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    &#xD;
     ' + @atrybuty + @atrybutyDok + '              &#xD;
       FROM &#xD;
       cdn.CRMKontakty k1 &#xD;
       JOIN cdn.PodmiotyView pod1 ON pod1.Pod_PodmiotTyp = k1.CrK_PodmiotTyp AND pod1.Pod_PodId = k1.CrK_PodId&#xD;
       LEFT OUTER JOIN cdn.PodmiotyView pod2 ON CRK_OpiekunId = pod2.Pod_PodId AND k1.CRK_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
       LEFT JOIN ' + @Operatorzy + ' ope ON k1.CRK_OpiekunId = Ope_OpeId AND k1.CRK_OpiekunTyp = 8&#xD;
       LEFT JOIN CDN.DefEtapy on k1.CRK_EtapRealizacji = DEt_DEtId AND DEt_Typ = 2&#xD;
       LEFT JOIN cdn.CRMKontakty k2 ON k1.CRK_WatekId = k2.CRK_CRKId    &#xD;
       LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
       LEFT JOIN #tmpDokAtr DokAtr ON k1.CRK_CRKId  = DokAtr.DAt_crkId&#xD;
       left join cdn.DokRelacje d1 on d1.DoR_ParentId=k1.Crk_WatekId and d1.DoR_ParentTyp=700 &#xD;
    left join cdn.tranag on d1.dor_dokumentid=trn_trnid and dor_dokumenttyp &lt;&gt;999  and dor_dokumenttyp &lt;&gt;1007  and dor_dokumenttyp &lt;&gt;900 and dor_dokumenttyp &lt;&gt;700&#xD;
    left join cdn.vatnag on d1.dor_dokumentid=van_vanid AND dor_dokumenttyp = 999&#xD;
    left join CDN.TrwaleHist on d1.dor_dokumentid=srh_srhid AND dor_dokumenttyp = 1007&#xD;
    left join CDN.srszlecenia on d1.dor_dokumentid=srz_srzid AND dor_dokumenttyp = 900&#xD;
    left join cdn.CRMKontakty k3 on d1.dor_dokumentid=k3.CRK_CRKId AND dor_dokumenttyp = 700&#xD;
    LEFT JOIN #DokPowiazaneIlosc as dokpowI on dokpowI.DoR_ParentId = k1.Crk_WatekId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = coalesce(VaN_ZakID,srh_zakID)&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON k1.CRK_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON k1.CRK_OpeModID = mod.Ope_OpeId&#xD;
    WHERE k1.CRK_Anulowany = 0' &#xD;
&#xD;
EXEC(@select)&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #DokPowiazaneIlosc&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+Tr5gVLalud6wtEq69ZjcyU1k3jNJx1KUqUU+GI9ry1DjHHBwnD2v0pv3nBiBns6VIWErQL/+yqHJLn6kQD0Ga0puwyZsL+fkcVm4ZRX6d4NXTaJiQWXlHMaI5a+iSKaLLvjJFwJmCsqE2RkMHYUzPe/b5LTvcG6z0Koc55a3ErM/ItKIEY/mIb</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Osoba Kontaktowa" caption="Kontrahent Pierwotny Osoba Kontaktowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Osoba Kontaktowa" caption="Kontrahent Osoba Kontaktowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Temat" caption="Dokument Temat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Etap Realizacji" caption="Etap Realizacji" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zadanie Priorytet" caption="Zadanie Priorytet" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rodzaj" caption="Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Obsługa" caption="Obsługa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Realizacja" caption="Dokument Realizacja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Zadania" caption="Termin Zadania" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Wątek Numer" caption="Wątek Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wątek Temat" caption="Wątek Temat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Od Dzień" caption="Termin Od Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Termin Od Godzina" caption="Termin Od Godzina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Do Dzień" caption="Termin Do Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Do Godzina" caption="Termin Do Godzina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Kontaktu Dni" caption="Czas Kontaktu Dni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Kontaktu Godziny" caption="Czas Kontaktu Godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Kontaktu Minuty" caption="Czas Kontaktu Minuty" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Przygotowania Dni" caption="Czas Przygotowania Dni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Przygotowania Godziny" caption="Czas Przygotowania Godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Przygotowania Minuty" caption="Czas Przygotowania Minuty" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Opracowania Dni" caption="Czas Opracowania Dni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Opracowania Godziny" caption="Czas Opracowania Godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Opracowania Minuty" caption="Czas Opracowania Minuty" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Rozmowy Dni" caption="Czas Rozmowy Dni" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Rozmowy Godziny" caption="Czas Rozmowy Godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Rozmowy Minuty" caption="Czas Rozmowy Minuty" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokumenty Powiazane" caption="Dokumenty Powiazane" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokumenty Powiązane Wartość" caption="Dokumenty Powiązane Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokumenty Powiązane Liczba" caption="Dokumenty Powiązane Liczba" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Dokumentu Dzień" caption="Data Dokumentu Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Dokumentu Tydzień Roku" caption="Data Dokumentu Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Miesiąc" caption="Data Dokumentu Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Kwartał" caption="Data Dokumentu Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Rok" caption="Data Dokumentu Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[7c846ea4-544a-49a6-9a61-e60d3ad083be]" caption="Średni Czas Kontaktu Dni" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[129a0c30-19db-4609-9f29-cac78f2a1186]" caption="Średni Czas Kontaktu Godziny" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[ace0d1b0-5188-49ad-920f-1032ae354ef2]" caption="Średni Czas Kontaktu Minuty" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[7c846ea4-544a-49a6-9a61-e60d3ad083be]" caption="Średni Czas Kontaktu Dni" formula="Czas Kontaktu Dni/Liczba Dokumentów" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[129a0c30-19db-4609-9f29-cac78f2a1186]" caption="Średni Czas Kontaktu Godziny" formula="Czas Kontaktu Godziny/Liczba Dokumentów" description="" summaryType="Sum" /&gt;&lt;whatifMeasure uniqueName="[Measures].[ace0d1b0-5188-49ad-920f-1032ae354ef2]" caption="Średni Czas Kontaktu Minuty" formula="Czas Kontaktu Minuty/Liczba Dokumentów" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport CRM wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje na podstawie kontaktów i zadań. Pozwala na analizowanie czasu i ilości kontaktów z kontrahentami dla każdego opiekuna.&#xD;
&#xD;
Raport oparty na tabeli:&#xD;
cdn.CRMKontakty - tabela zawierająca listę kontaktów z klientami</a:description><a:id>18</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>18. Raport CRM</a:mainLinkName><a:modifiedOn>2025-02-04T12:16:41.213</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-07-19T16:47:10.833</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/*&#xD;
* Raport Rozrachunków Księgowych na Dzień &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.1.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
&#xD;
DECLARE @kontoodidx VARCHAR(200) = (SELECT Acc_NumerIdx from CDN.Konta WHERE Acc_AccId = @KONTOOD)&#xD;
DECLARE @kontodoidx VARCHAR(200) = (SELECT Acc_NumerIdx from CDN.Konta WHERE Acc_AccId = @KONTODO);&#xD;
--Wyliczanie poziomów kont&#xD;
WITH g(gid, kod, naz, parId, poziom, nazwa)&#xD;
AS&#xD;
(&#xD;
      SELECT Acc_AccId, Acc_Segment, Acc_Nazwa, Acc_ParId, Acc_Poziom, convert(nvarchar(1024), Acc_Segment) as nazwa&#xD;
      FROM CDN.Konta&#xD;
      WHERE Acc_ParId IS NULL&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT Acc_AccId, Acc_Segment, Acc_Nazwa, Acc_ParId, Acc_Poziom, convert(nvarchar(1024), p.nazwa + N'-' + c.Acc_Segment) as nazwa&#xD;
      FROM g p&#xD;
        JOIN CDN.Konta c ON c.Acc_ParId = p.gid &#xD;
      WHERE c.Acc_ParId IS NOT NULL &#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt; 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50), Nazwa' + CAST(@poziom AS nvarchar) + N' nvarchar(4000)'&#xD;
    EXEC(@sql)&#xD;
&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= parId '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + kod + '')'' ELSE kod END'&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Nazwa' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + naz + '')'' ELSE naz END'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                         WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(c.kod AS nvarchar) + '')''&#xD;
                         WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(p.kod AS nvarchar) + '')''&#xD;
                    ELSE p.kod END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Nazwa' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN c.naz&#xD;
                         WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + c.naz + '')''&#xD;
                         WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + p.naz + '')''&#xD;
                    ELSE p.naz END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parId AS nvarchar)&#xD;
                    ELSE CAST(p.parId AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
declare @select varchar(max);&#xD;
declare @select1 varchar(max);&#xD;
declare @select2 varchar(max);&#xD;
declare @select3 varchar(max);&#xD;
declare @select4 varchar(max);&#xD;
declare @kolumny varchar(max);&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
&#xD;
set @i=1&#xD;
if @i&lt;=@poziom_max  &#xD;
begin&#xD;
    set @kolumny = ', SUBSTRING(Poz.Poziom1, 1, 1) AS [Konto Grupa]'&#xD;
end&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ', CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END [Konto Struktura Poziom ' + LTRIM(@i) + '] ' +&#xD;
                              ', CASE WHEN Poz.Nazwa' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Nazwa' + LTRIM(@i) + ' END [Konto Nazwa Poziom ' + LTRIM(@i) + '] '&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
CREATE UNIQUE CLUSTERED INDEX in1 ON #tmpTwrGr(gid)&#xD;
&#xD;
--Właściwe zapytanie&#xD;
DECLARE @DATAINT INT; &#xD;
SET @DATAINT = CONVERT(int, @DATA)&#xD;
DECLARE @DATAODINT INT; &#xD;
SET @DATAODINT = CONVERT(int, @DATAOD)&#xD;
DECLARE @DATADOINT INT; &#xD;
SET @DATADOINT = CONVERT(int, @DATADO)&#xD;
DECLARE @TYPDATY INT;&#xD;
SET @TYPDATY = (CASE WHEN @TERMINDATA = 'Terminu Płatności' THEN 1 ELSE 2 END)&#xD;
DECLARE @OOID INT;&#xD;
SET @OOID = (SELECT OOb_OObID FROM CDN.OkresyObrach WHERE OOb_Symbol=@OKRESOBRACHUNKOWY)&#xD;
DECLARE @DATAANALIZY VARCHAR(MAX);&#xD;
SET @DATAANALIZY = CONVERT(VARCHAR, @DATA);&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
SET @select = &#xD;
'SELECT &#xD;
&#xD;
BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    Dokument [Dokument Numer], &#xD;
    Opis [Dokument Opis], IdentKsieg [Identyfikator Księgowy], CASE WHEN Bufor = 1 THEN ''TAK'' ELSE ''NIE'' END [Dokument Bufor],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Elementu], ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Elementu],&#xD;
    NrKsiegi [Dziennik Numer], NrDziennika [Dziennik Cząstkowy Numer], OOb_Symbol [Okres Obrachunkowy], Waluta [Waluta], &#xD;
    CASE WHEN ''' + @TERMINDATA + ''' = ''Terminu Płatności''&#xD;
    THEN CASE&#xD;
            WHEN DATEDIFF(day, TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) &lt; 1 THEN ''1. W terminie''&#xD;
            WHEN DATEDIFF(day, TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 AND ' + CONVERT(varchar, @PRZEDZIAL1) + ' THEN ''2.  Do ' + CONVERT(varchar, @PRZEDZIAL1) + ' dni''&#xD;
            WHEN DATEDIFF(day, TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL1) + ' AND ' + CONVERT(varchar, @PRZEDZIAL2) + ' THEN ''3. Od ' + CONVERT(varchar, @PRZEDZIAL1 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL2) + ' dni''&#xD;
            WHEN DATEDIFF(day, TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL2) + ' AND ' + CONVERT(varchar, @PRZEDZIAL3) + ' THEN ''4. Od ' + CONVERT(varchar, @PRZEDZIAL2 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL3) + ' dni''&#xD;
            WHEN DATEDIFF(day, TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL3) + ' AND ' + CONVERT(varchar, @PRZEDZIAL4) + ' THEN ''5. Od ' + CONVERT(varchar, @PRZEDZIAL3 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL4) + ' dni''&#xD;
            WHEN DATEDIFF(day, TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL4) + ' AND ' + CONVERT(varchar, @PRZEDZIAL5) + ' THEN ''6. Od ' + CONVERT(varchar, @PRZEDZIAL4 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
            ELSE ''7. Powyżej ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
        END&#xD;
    ELSE CASE&#xD;
            WHEN DATEDIFF(day, DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) &lt; 1 THEN ''1. W terminie''&#xD;
            WHEN DATEDIFF(day, DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 AND ' + CONVERT(varchar, @PRZEDZIAL1) + ' THEN ''2.  Do ' + CONVERT(varchar, @PRZEDZIAL1) + ' dni''&#xD;
            WHEN DATEDIFF(day, DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL1) + ' AND ' + CONVERT(varchar, @PRZEDZIAL2) + ' THEN ''3. Od ' + CONVERT(varchar, @PRZEDZIAL1 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL2) + ' dni''&#xD;
            WHEN DATEDIFF(day, DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL2) + ' AND ' + CONVERT(varchar, @PRZEDZIAL3) + ' THEN ''4. Od ' + CONVERT(varchar, @PRZEDZIAL2 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL3) + ' dni''&#xD;
            WHEN DATEDIFF(day, DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL3) + ' AND ' + CONVERT(varchar, @PRZEDZIAL4) + ' THEN ''5. Od ' + CONVERT(varchar, @PRZEDZIAL3 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL4) + ' dni''&#xD;
            WHEN DATEDIFF(day, DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL4) + ' AND ' + CONVERT(varchar, @PRZEDZIAL5) + ' THEN ''6. Od ' + CONVERT(varchar, @PRZEDZIAL4 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
            ELSE ''7. Powyżej ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
        END&#xD;
    END [Termin Zapadalności], &#xD;
    KontoNumer [Konto Pełny Numer], KontoNazwa [Konto Nazwa], KontoPrzeciw [Konto Przeciwstawne],&#xD;
    CASE WHEN PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN PodmiotTyp = 2 THEN ''Bank''&#xD;
         WHEN PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END [Podmiot Pierwotny Typ], &#xD;
    pod.Pod_NIP [Podmiot Pierwotny NIP],&#xD;
    PodmiotKod [Podmiot Pierwotny Kod], &#xD;
    PodmiotNazwa [Podmiot Pierwotny Nazwa],&#xD;
    CASE WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN pod5.Pod_PodmiotTyp= 2 THEN ''Bank''&#xD;
         WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN pod5.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END [Podmiot Typ], &#xD;
    pod5.Pod_NIP [Podmiot NIP],&#xD;
    pod5.Pod_Kod [Podmiot Kod], &#xD;
    pod5.Pod_Nazwa1 [Podmiot Nazwa],&#xD;
    KwotaDok [Kwota Dokumentu], --KwotaDokWal [Kwota Dokumentu Waluta],&#xD;
    NULLIF(PozostajeWN,0) [Kwota Pozostała Wn], --NULLIF(PozostajeWN_Wal,0) [Kwota Pozostała Wn Waluta], &#xD;
    NULLIF(PozostajeMA,0) [Kwota Pozostała Ma], --NULLIF(PozostajeMA_Wal,0) [Kwota Pozostała Ma Waluta],&#xD;
    CASE WHEN PozostajeWN = 0 THEN NULL ELSE Zwloka END [Liczba Dni Przeterminowania Wn], &#xD;
    CASE WHEN PozostajeMA = 0 THEN NULL ELSE Zwloka END [Liczba Dni Przeterminowania Ma]&#xD;
    ,CASE DeE_FPlID&#xD;
    WHEN 1 THEN ''gotówka''&#xD;
    WHEN 2 THEN ''czek''&#xD;
    WHEN 3 THEN ''przelew''&#xD;
    WHEN 4 THEN ''kredyt''&#xD;
    ELSE ''inna'' END [Forma Płatności]&#xD;
    ,''Przeterminowany'' AS [Status]&#xD;
    ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
    ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), DataDokumentu, 111), ''/'', ''-'') [Data Dokumentu]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TerminPlatnosci, 111), ''/'', ''-'') [Data Termin Płatności]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), DataWystawienia, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), DataDokumentu, 111), ''/'', ''-'') [Data Dokumentu Dzień], YEAR(DataDokumentu) [Data Dokumentu Rok]&#xD;
    ,DATEPART(quarter, DataDokumentu) [Data Dokumentu Kwartał], MONTH(DataDokumentu) [Data Dokumentu Miesiąc]&#xD;
    ,(datepart(DY, datediff(d, 0, DataDokumentu) / 7 * 7 + 3)+6) / 7 [Data Dokumentu Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TerminPlatnosci, 111), ''/'', ''-'') [Data Termin Płatności Dzień], YEAR(TerminPlatnosci) [Data Termin Płatności Rok] &#xD;
    ,DATEPART(quarter, TerminPlatnosci) [Data Termin Płatności Kwartał], MONTH(TerminPlatnosci) [Data Termin Płatności Miesiąc]&#xD;
    ,(datepart(DY, datediff(d, 0, TerminPlatnosci) / 7 * 7 + 3)+6) / 7 [Data Termin Płatności Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), DataWystawienia, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
    ----------KONTEKSTY&#xD;
    ,26002 [Dokument Numer __PROCID__Rozrachunki__], DeE_DeNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,CASE pod.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], pod.Pod_PodId [Podmiot Pirwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__]&#xD;
    ,CASE pod.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Pierwotny Nazwa __PROCID__], pod.Pod_PodId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    ,CASE pod5.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__]&#xD;
    ,CASE pod5.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Nazwa __PROCID__], pod.Pod_PodId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__]&#xD;
    &#xD;
    ' + @kolumny &#xD;
    SET @select1 = &#xD;
N' FROM CDN.RozrachunkiNaDzien('&#xD;
+ Convert(varchar,@DATAINT)&#xD;
+ N', ' + Convert(varchar,@DATAODINT) + N', ' + Convert(varchar,@DATADOINT)&#xD;
+ N', 1, 99999, '&#xD;
+ Convert(varchar,@KONTOOD)&#xD;
+ N','&#xD;
+ Convert(varchar,@KONTODO)&#xD;
+ N', 1, 3, ''-wszystkie-'','&#xD;
+ Convert(varchar,@TYPDATY)&#xD;
+','+Convert(varchar,@OOID)+')'&#xD;
&#xD;
    SET @select2 =' &#xD;
    LEFT JOIN CDN.OkresyObrach ON IdOkresuObr = OOb_OObID&#xD;
    LEFT JOIN CDN.DekretyElem ON DeE_DeEId = DeEId&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat1 ON DeE_KatId = kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Konta k1 ON KontoIdx = k1.Acc_NumerIdx AND IdOkresuObr = k1.Acc_OObId&#xD;
    LEFT OUTER JOIN CDN.Konta k2 ON KontoIdx = k2.Acc_NumerIdx AND IdOkresuObr + 1 = k2.Acc_OObId&#xD;
    LEFT JOIN #tmpTwrGr Poz ON ISNULL(k1.Acc_AccId, k2.Acc_AccId) = Poz.gid &#xD;
    LEFT JOIN CDN.PodmiotyView pod ON k1.Acc_SlownikTyp = pod.Pod_PodmiotTyp And k1.Acc_SlownikId = pod.Pod_PodId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod.Pod_GlID = pod5.Pod_PodId and pod.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON k1.Acc_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON k1.Acc_OpeModID = mod.Ope_OpeId&#xD;
WHERE DataDokumentu &lt;= CONVERT(DATETIME,''' + @DATAANALIZY + ''')&#xD;
&#xD;
'&#xD;
SET @select3 ='&#xD;
UNION ALL &#xD;
SELECT &#xD;
BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    KRo_Dokument [Dokument Numer], &#xD;
    KRo_Opis [Dokument Opis], KRo_IdentKsieg [Identyfikator Księgowy], CASE WHEN KRo_Bufor = 1 THEN ''TAK'' ELSE ''NIE'' END [Dokument Bufor],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Elementu], ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Elementu],&#xD;
    KRo_NrKsiegi [Dziennik Numer], KRo_NrDziennika [Dziennik Cząstkowy Numer], OOb_Symbol [Okres Obrachunkowy], KRo_Waluta [Waluta], &#xD;
    CASE WHEN ''' + @TERMINDATA + ''' = ''Terminu Płatności''&#xD;
    THEN CASE&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) &lt; 1 THEN ''1. W terminie''&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 AND ' + CONVERT(varchar, @PRZEDZIAL1) + ' THEN ''2.  Do ' + CONVERT(varchar, @PRZEDZIAL1) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL1) + ' AND ' + CONVERT(varchar, @PRZEDZIAL2) + ' THEN ''3. Od ' + CONVERT(varchar, @PRZEDZIAL1 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL2) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL2) + ' AND ' + CONVERT(varchar, @PRZEDZIAL3) + ' THEN ''4. Od ' + CONVERT(varchar, @PRZEDZIAL2 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL3) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL3) + ' AND ' + CONVERT(varchar, @PRZEDZIAL4) + ' THEN ''5. Od ' + CONVERT(varchar, @PRZEDZIAL3 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL4) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL4) + ' AND ' + CONVERT(varchar, @PRZEDZIAL5) + ' THEN ''6. Od ' + CONVERT(varchar, @PRZEDZIAL4 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
            ELSE ''7. Powyżej ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
        END&#xD;
    ELSE CASE&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) &lt; 1 THEN ''1. W terminie''&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 AND ' + CONVERT(varchar, @PRZEDZIAL1) + ' THEN ''2.  Do ' + CONVERT(varchar, @PRZEDZIAL1) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL1) + ' AND ' + CONVERT(varchar, @PRZEDZIAL2) + ' THEN ''3. Od ' + CONVERT(varchar, @PRZEDZIAL1 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL2) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL2) + ' AND ' + CONVERT(varchar, @PRZEDZIAL3) + ' THEN ''4. Od ' + CONVERT(varchar, @PRZEDZIAL2 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL3) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL3) + ' AND ' + CONVERT(varchar, @PRZEDZIAL4) + ' THEN ''5. Od ' + CONVERT(varchar, @PRZEDZIAL3 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL4) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL4) + ' AND ' + CONVERT(varchar, @PRZEDZIAL5) + ' THEN ''6. Od ' + CONVERT(varchar, @PRZEDZIAL4 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
            ELSE ''7. Powyżej ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
        END&#xD;
    END [Termin Zapadalności], &#xD;
    KRo_Konto [Konto Pełny Numer], k1.Acc_Nazwa [Konto Nazwa], KRo_KontoPrzeciw [Konto Przeciwstawne],&#xD;
    CASE WHEN DeN_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN DeN_PodmiotTyp = 2 THEN ''Bank''&#xD;
         WHEN DeN_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN DeN_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN DeN_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END [Podmiot Pierwotny Typ], &#xD;
    pod.Pod_NIP [Podmiot Pierwotny NIP],&#xD;
    pod.Pod_Kod [Podmiot Pierwotny Kod], &#xD;
    pod.Pod_Nazwa1 [Podmiot Pierwotny Nazwa],&#xD;
    CASE WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN pod5.Pod_PodmiotTyp= 2 THEN ''Bank''&#xD;
         WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN pod5.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END [Podmiot Typ], &#xD;
    pod5.Pod_NIP [Podmiot NIP],&#xD;
    pod5.Pod_Kod [Podmiot Kod], &#xD;
    pod5.Pod_Nazwa1 [Podmiot Nazwa],&#xD;
    KRo_KwotaDok [Kwota Dokumentu], --KwotaDokWal [Kwota Dokumentu Waluta],&#xD;
    0 [Kwota Pozostała Wn], --NULLIF(PozostajeWN_Wal,0) [Kwota Pozostała Wn Waluta], &#xD;
    0 [Kwota Pozostała Ma], --NULLIF(PozostajeMA_Wal,0) [Kwota Pozostała Ma Waluta],&#xD;
    NULL [Liczba Dni Przeterminowania Wn], &#xD;
    NULL [Liczba Dni Przeterminowania Ma]&#xD;
    ,CASE DeE_FPlID&#xD;
    WHEN 1 THEN ''gotówka''&#xD;
    WHEN 2 THEN ''czek''&#xD;
    WHEN 3 THEN ''przelew''&#xD;
    WHEN 4 THEN ''kredyt''&#xD;
    ELSE ''inna'' END [Forma Płatności]&#xD;
    ,''Rozrachowany'' AS [Status]&#xD;
    ,zal.Ope_Kod [Operator Wprowadzający] &#xD;
    ,mod.Ope_Kod [Operator Modyfikujący]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), KRo_DataDokumentu, 111), ''/'', ''-'') [Data Dokumentu]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), KRo_TerminPlatnosci, 111), ''/'', ''-'') [Data Termin Płatności]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), KRo_DataOperacji, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), KRo_DataOperacji, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), KRo_DataDokumentu, 111), ''/'', ''-'') [Data Dokumentu Dzień], YEAR(KRo_DataDokumentu) [Data Dokumentu Rok]&#xD;
    ,DATEPART(quarter, KRo_DataDokumentu) [Data Dokumentu Kwartał], MONTH(KRo_DataDokumentu) [Data Dokumentu Miesiąc]&#xD;
    ,(datepart(DY, datediff(d, 0, KRo_DataDokumentu) / 7 * 7 + 3)+6) / 7 [Data Dokumentu Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), KRo_TerminPlatnosci, 111), ''/'', ''-'') [Data Termin Płatności Dzień], YEAR(KRo_TerminPlatnosci) [Data Termin Płatności Rok] &#xD;
    ,DATEPART(quarter, KRo_TerminPlatnosci) [Data Termin Płatności Kwartał], MONTH(KRo_TerminPlatnosci) [Data Termin Płatności Miesiąc]&#xD;
    ,(datepart(DY, datediff(d, 0, KRo_TerminPlatnosci) / 7 * 7 + 3)+6) / 7 [Data Termin Płatności Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), KRo_DataOperacji, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), KRo_DataOperacji, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
    ----------KONTEKSTY&#xD;
    ,26002 [Dokument Numer __PROCID__Rozrachunki__], DeE_DeNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,CASE DeN_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], pod.Pod_PodId [Podmiot Pirwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__]&#xD;
    ,CASE DeN_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Pierwotny Nazwa __PROCID__], pod.Pod_PodId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    ,CASE pod5.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__]&#xD;
    ,CASE pod5.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Nazwa __PROCID__], pod.Pod_PodId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__]&#xD;
    &#xD;
    ' + @kolumny + '&#xD;
 FROM CDN.KsiRozrachunki&#xD;
    LEFT JOIN CDN.OkresyObrach ON KRo_OObId = OOb_OObID&#xD;
    LEFT JOIN CDN.DekretyElem ON DeE_DeEId = KRo_DeEId&#xD;
    LEFT JOIN CDN.DekretyNag on DeE_DeNId = DeN_DeNId&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat1 ON DeE_KatId = kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Konta k1 ON KRo_KontoIdx = k1.Acc_NumerIdx AND KRo_OObId = k1.Acc_OObId &#xD;
    LEFT OUTER JOIN CDN.Konta k2 ON KRo_KontoIdx = k2.Acc_NumerIdx AND KRo_OObId + 1 = k2.Acc_OObId&#xD;
    LEFT JOIN #tmpTwrGr Poz ON ISNULL(k1.Acc_AccId, k2.Acc_AccId) = Poz.gid &#xD;
    LEFT JOIN CDN.PodmiotyView pod ON DeN_PodmiotId = pod.Pod_PodId AND DeN_PodmiotTyp = pod.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod.Pod_GlID = pod5.Pod_PodId and pod.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON k1.Acc_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON k1.Acc_OpeModID = mod.Ope_OpeId&#xD;
    WHERE KRo_KwotaDok-KRo_SumRozliczen = 0&#xD;
    AND OOb_OObID = '+Convert(varchar,@OOID)+'&#xD;
    AND k1.Acc_NumerIdx BETWEEN '''+ Convert(varchar,@kontoodidx)+ ''' AND '''+ Convert(varchar,@kontodoidx)+'''&#xD;
'&#xD;
&#xD;
print(@select)&#xD;
EXEC(@select+@select1+@select2+@select3)&#xD;
DROP TABLE #tmpTwrGr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5vCxSmgondMfdtmo6sliIgTWPbj17BviVUXyPzdkotJkq7igEVPx67QBSiMcx5zyeTJgrs/t+z/BIjq9oHQl3dL1vDiIZ84Ys7b36fBxBgdA</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Identyfikator Księgowy" caption="Identyfikator Księgowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Bufor" caption="Dokument Bufor" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Elementu" caption="Kategoria Szczegółowa z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Elementu" caption="Kategoria Ogólna z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dziennik Numer" caption="Dziennik Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dziennik Cząstkowy Numer" caption="Dziennik Cząstkowy Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Okres Obrachunkowy" caption="Okres Obrachunkowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Dzień" caption="Data Dokumentu Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Rok" caption="Data Dokumentu Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Kwartał" caption="Data Dokumentu Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Miesiąc" caption="Data Dokumentu Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Tydzień Roku" caption="Data Dokumentu Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Dzień" caption="Data Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Rok" caption="Data Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Kwartał" caption="Data Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Miesiąc" caption="Data Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Tydzień Roku" caption="Data Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Zapadalności" caption="Termin Zapadalności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Pełny Numer" caption="Konto Pełny Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Nazwa" caption="Konto Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Przeciwstawne" caption="Konto Przeciwstawne" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kwota Dokumentu" caption="Kwota Dokumentu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Pozostała Wn" caption="Kwota Pozostała Wn" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Pozostała Ma" caption="Kwota Pozostała Ma" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania Wn" caption="Liczba Dni Przeterminowania Wn" type="measure" formatString="n0" aggregate="Max" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania Ma" caption="Liczba Dni Przeterminowania Ma" type="measure" formatString="n0" aggregate="Max" /&gt;&#xD;
    &lt;column name="Konto Grupa" caption="Konto Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 1" caption="Konto Struktura Poziom 1" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 1" caption="Konto Nazwa Poziom 1" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 2" caption="Konto Struktura Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 2" caption="Konto Nazwa Poziom 2" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 3" caption="Konto Struktura Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 3" caption="Konto Nazwa Poziom 3" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 4" caption="Konto Struktura Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 4" caption="Konto Nazwa Poziom 4" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 5" caption="Konto Struktura Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 5" caption="Konto Nazwa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATA&lt;/Name&gt;&#xD;
    &lt;Label&gt;Analiza na dzień:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data, dla której wykonana zostanie analiza&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;select getdate()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-05-07&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL1&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 1 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;30&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL2&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 2 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;60&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL3&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 3 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;90&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL4&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 4 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;180&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL5&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 5 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;360&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;TERMINDATA&lt;/Name&gt;&#xD;
    &lt;Label&gt;Obliczenia według:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Parametr określający czy struktura wiekowa ma być liczona na podstawie terminu płatności czy daty księgowania&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;'Terminu Płatności';'Daty Księgowania'&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;'Terminu Płatności'&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;KONTOOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Od konta:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Pierwsze konto zakresu analizowanych kont&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;DECLARE @przedzial1 int;

set @przedzial1 = (SELECT OOb_OObID FROM CDN.OkresyObrach WHERE OOb_Symbol=CONVERT(nvarchar(5),'@OKRESOBRACHUNKOWY'));


;WITH g(gid, nazwa)
AS
(
SELECT Acc_AccId, convert(nvarchar(1024), Acc_Segment) as nazwa
FROM CDN.Konta
WHERE Acc_ParId IS NULL
AND Acc_OObId = @przedzial1

UNION ALL

SELECT Acc_AccId, convert(nvarchar(1024), p.nazwa + N'-' + c.Acc_Segment) as nazwa
FROM g p
JOIN CDN.Konta c ON c.Acc_ParId = p.gid
WHERE c.Acc_ParId IS NOT NULL
AND Acc_OObId = @przedzial1
) SELECT MAX(gid) gid, nazwa FROM g GROUP BY nazwa ORDER BY nazwa 
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;SQL&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Sql&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;KONTODO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Do konta:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Ostatnie konto analizowanego zakresu kont&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;DECLARE @przedzial1 int;

set @przedzial1 = (SELECT OOb_OObID FROM CDN.OkresyObrach WHERE OOb_Symbol=CONVERT(nvarchar(5),'@OKRESOBRACHUNKOWY'));


;WITH g(gid, nazwa)
AS
(
SELECT Acc_AccId, convert(nvarchar(1024), Acc_Segment) as nazwa
FROM CDN.Konta
WHERE Acc_ParId IS NULL
AND Acc_OObId = @przedzial1

UNION ALL

SELECT Acc_AccId, convert(nvarchar(1024), p.nazwa + N'-' + c.Acc_Segment) as nazwa
FROM g p
JOIN CDN.Konta c ON c.Acc_ParId = p.gid
WHERE c.Acc_ParId IS NOT NULL
AND Acc_OObId = @przedzial1
) SELECT MAX(gid) gid, nazwa FROM g GROUP BY nazwa ORDER BY nazwa 
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;SQL&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Sql&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Za okres od:&lt;/Label&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2010-01-01&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Za okres do:&lt;/Label&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-05-07&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;OKRESOBRACHUNKOWY&lt;/Name&gt;&#xD;
    &lt;Label&gt;Okres Obrachunkowy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Okres obrachunkowy analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT OOb_Symbol, Oob_Symbol + ' ' + DB_NAME() FROM CDN.OkresyObrach
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;SQL&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Sql&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Rozrachunków Księgowych wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o stanie rozrachunków księgowych (należności i zobowiązania) firmy w danym dniu. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Raport zawiera następujące parametry:&#xD;
Data Analizy - Data, dla której wykonana zostanie analiza&#xD;
Przedział 1, 2, 3, 4, 5 - Górna granica (w dniach) przedziałów, do których zostaną przypisane dokumenty. &#xD;
Górna granica przedziału wcześniejszego jest dolną późniejszego.&#xD;
Obliczenia według: - Parametr określający czy struktura wiekowa ma być liczona na podstawie terminu płatności czy daty księgowania.&#xD;
&#xD;
W celu wyświetlania poprawnych danych należy wybrać odpowiedni okres obrachunkowy, dla którego ma być przeprowadzona analiza.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.DekretyNag - tabela zawiera nagłówki dekretów księgowych &#xD;
CDN.DekretyElem - tabela zawiera elementy dekretów księgowych&#xD;
CDN.KsiRozrachunki - tabela zawiera rozrachunki dokumentów księgowych</a:description><a:id>19</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>19. Raport Rozrachunków Księgowych na Dzień</a:mainLinkName><a:modifiedOn>2025-03-20T16:32:11.643</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2014-05-07T13:54:41.903</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/** Raport Czasu Pracy&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.1.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
&#xD;
--Współczynnik urlopowy&#xD;
DECLARE @Wspol VARCHAR(10)&#xD;
SET @Wspol = CONVERT(VARCHAR(10), cast(@Wsp as decimal (10,2)))&#xD;
&#xD;
--Wyliczanie hierarchii wydziałów&#xD;
SELECT DZL_DzlId [gid], DZL_Kod [kod], DZL_ParentId [parId], DZL_Poziom [poziom] INTO #tmpTwrGr FROM CDN.Dzialy&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt; 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(100), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(100)'&#xD;
    EXEC(@sql)&#xD;
&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= parId '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + kod + '')'' ELSE kod END'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
						 WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(c.kod AS nvarchar) + '')''&#xD;
						 WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(p.kod AS nvarchar) + '')''&#xD;
					ELSE p.kod END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parId AS nvarchar)&#xD;
					ELSE CAST(p.parId AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
&#xD;
declare @select varchar(max);&#xD;
declare @kolumny varchar(max);&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
&#xD;
set @i=1&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ', CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END [Wydział Pracownika Poziom ' + LTRIM(@i) + '] '&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Pracowników&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(100), @atrybuty varchar(max), @sqlA nvarchar(max), @atrybut_Typ int, @atrybut_format nvarchar(21);&#xD;
&#xD;
DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DISTINCT OAT_AtkId, REPLACE(ATK_Nazwa, ']', '_'), ATK_Typ, ATK_Format&#xD;
FROM CDN.OAtrybuty&#xD;
JOIN CDN.OAtrybutyKlasy ON OAT_AtkId = ATK_AtkId&#xD;
WHERE OAT_PrcId IS NOT NULL&#xD;
&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_Typ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT OAT_PrcId INTO #tmpKonAtr FROM CDN.OAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [atr + ' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [atr + ' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = &#xD;
		  CASE WHEN ' + convert(varchar,@atrybut_Typ) + ' = 3 AND ''' + convert(varchar,@atrybut_Format) + ''' &lt;&gt; ''Data'' THEN REPLACE(ATR.ATH_Wartosc,'','',''.'') ELSE &#xD;
		   CASE WHEN ' + convert(varchar,@atrybut_Typ) + ' = 3 AND ''' + convert(varchar,@atrybut_Format) + ''' = ''Data'' THEN &#xD;
		     REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.ATH_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'')&#xD;
			 ELSE ATR.ATH_Wartosc  END&#xD;
		  END		&#xD;
		FROM CDN.OAtrybutyHist ATR &#xD;
		JOIN CDN.OAtrybuty OA ON OA.OAT_OatId = ATR.ATH_OatId AND ATR.ATH_DataDo = (SELECT MAX(A1.ATH_DataDo) FROM CDN.OAtrybutyHist A1 WHERE A1.ATH_OatId = ATR.ATH_OatId)&#xD;
		JOIN #tmpKonAtr TM ON OA.OAT_PrcId = TM.OAT_PrcId&#xD;
		WHERE ATR.ATH_AtkId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[atr + ' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Pracownik Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_Typ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Liczenie dni pracy pracownika&#xD;
SELECT DISTINCT [Data], [PreId], [PraId] INTO #Daty&#xD;
FROM(&#xD;
	SELECT KAD_Data [Data], PRE_PreId [PreId], PRE_PraId [PraId]&#xD;
	FROM CDN.KalendDni&#xD;
	LEFT JOIN CDN.PracEtaty ON PRE_KalId = KAD_KalId AND KAD_Data &gt;= PRE_DataOd AND KAD_Data &lt;= PRE_DataDo&#xD;
	WHERE KAD_Data BETWEEN @DATAOD AND @DATADO&#xD;
&#xD;
	UNION ALL&#xD;
&#xD;
	SELECT  PPL_Data [Data], PRE_PreId [PreId], PRE_PraId [PraId]&#xD;
	FROM CDN.PracPlanDni&#xD;
	LEFT JOIN CDN.PracEtaty ON PRE_PraId = PPL_PraId AND PPL_Data &gt;= PRE_DataOd AND PPL_Data &lt;= PRE_DataDo&#xD;
	WHERE PPL_Data BETWEEN @DATAOD AND @DATADO&#xD;
&#xD;
	UNION ALL&#xD;
&#xD;
	SELECT  PPR_Data [Data], PRE_PreId [PreId], PRE_PraId [PraId]&#xD;
	FROM CDN.PracPracaDni&#xD;
	LEFT JOIN CDN.PracEtaty ON PRE_PraId = PPR_PraId AND PPR_Data &gt;= PRE_DataOd AND PPR_Data &lt;= PRE_DataDo&#xD;
	WHERE PPR_Data BETWEEN @DATAOD AND @DATADO&#xD;
)AS Daty&#xD;
&#xD;
--Sprawdzenie ważności umów&#xD;
select data [UData], praid [UPraId], count(umw_umwid) [UUmw] into #Umowy from #daty&#xD;
left join cdn.umowy on umw_praid = praid and data &gt;= UMW_DataOd and data &lt;= umw_datado&#xD;
group by data, PraId&#xD;
&#xD;
--Daty zwolnienia i zatrudnienia&#xD;
SELECT MAX(pre_zatrudnionydo) PZZwol, min(pre_zatrudnionyod) PZZat,pre_praid [PZPraId] into #PracZat from cdn.pracetaty where @DATAOD &lt;= PRE_DataDo AND @DATADO &gt;= PRE_DataOd group by pre_praid&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Wyliczanie wypłat&#xD;
SELECT &#xD;
	WPL_WplId [wyplataID],&#xD;
	SUM(CASE WHEN TWP_WchodziDoWyplaty = 1 OR TWP_Rodzajzrodla = 35 THEN&#xD;
			CASE WHEN WPE_Wartosc &lt; 0&#xD;
				THEN 0 &#xD;
				ELSE WPE_Wartosc&#xD;
			END&#xD;
			ELSE 0&#xD;
		END) [brutto],&#xD;
	SUM(CASE WHEN WPE_Nazwa = 'Dni pobytu za granicą (liczba diet)' THEN WPE_Wartosc*WPL_OddelegowanyDieta*ISNULL(NULLIF(WPL_KursLNalDieta,0),1)/ISNULL(NULLIF(WPL_KursMNalDieta,0),1) ELSE 0 END) [dieta],&#xD;
	SUM(CASE WHEN WPE_Nazwa = 'Podstawa ZUS opodatk. zagr.' or WPE_Nazwa = 'Wyrównanie podstawy ZUS opodatk. zagr.' THEN WPE_Wartosc ELSE 0 END ) [podstawaOpodatkowania]&#xD;
INTO #Wyplaty&#xD;
FROM CDN.PracEtaty &#xD;
	JOIN CDN.Wyplaty ON WPL_PraId = PRE_PraId AND CAST(Pre_DataOd AS Date) &lt;= CAST(GetDate() AS Date) AND CAST(Pre_DataDo AS Date) &gt;= CAST(GetDate() AS Date)&#xD;
 	JOIN CDN.WypElementy ON WPE_WplId = WPL_WplId&#xD;
	JOIN CDN.TypWyplata ON WPE_TwpId = TWP_TwpId&#xD;
group by WPL_WplId&#xD;
&#xD;
&#xD;
SELECT  TOP (DATEDIFF(DAY, @DATAOD, @DATADO) + 1)&#xD;
        Date = DATEADD(DAY, ROW_NUMBER() OVER(ORDER BY a.object_id) - 1, @DATAOD)&#xD;
		into #WszystkieDaty&#xD;
FROM    sys.all_objects a&#xD;
        CROSS JOIN sys.all_objects b&#xD;
		;&#xD;
&#xD;
WITH cte AS&#xD;
(&#xD;
   SELECT *,&#xD;
         ROW_NUMBER() OVER (PARTITION BY PLN_PRAID,PLN_Lnbid ORDER BY PLN_Waznyod DESC) AS rn&#xD;
   FROM Cdn.PracLimit WHERE PLN_WaznyOd &lt; @DATADO AND PLN_Rok = YEAR(@DATADO)  &#xD;
)&#xD;
SELECT * INTO #AktualneLimity&#xD;
FROM cte &#xD;
WHERE rn = 1&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
DECLARE @DataPocz DATETIME&#xD;
SET @DataPocz =   DATEADD(yy, DATEDIFF(yy, 0, @DATADO), 0) &#xD;
&#xD;
SELECT  TOP (DATEDIFF(DAY, @DataPocz, @DATADO) + 1)&#xD;
        Date = DATEADD(DAY, ROW_NUMBER() OVER(ORDER BY a.object_id) - 1, @DataPocz)&#xD;
		into #WszystkieDatyDo&#xD;
FROM    sys.all_objects a&#xD;
        CROSS JOIN sys.all_objects b&#xD;
		;&#xD;
&#xD;
select DISTINCT Dzien into #Swieta from #WszystkieDatyDo  CROSS apply  cdn.DniSwiateczne(YEAR(Date))&#xD;
&#xD;
&#xD;
		SELECT  (MONTH(@Datado) - MONTH(PLN_OkresOd) + 1.0) /12.0 IlMies, PLN_PlnId PLNID INTO #tmpmies FROM CDN.PRAClIMIT x&#xD;
WHERE  (X.PLN_OkresOd BETWEEN  @DATAOD AND   @DATADO ) OR (X.PLN_OkresDo BETWEEN  @DATAOD AND  @DATADO)&#xD;
	OR &#xD;
	(( @DATAOD  BETWEEN X.PLN_OkresOd AND X.PLN_OkresDo) OR ( @DATADO BETWEEN X.PLN_OkresOd AND X.PLN_OkresDo))&#xD;
&#xD;
;WITH RankedData AS (&#xD;
    SELECT &#xD;
        PLN_Praid, &#xD;
        Pln_lnbid, &#xD;
	PLN_PlnId,&#xD;
        PLN_WaznyOd, &#xD;
        PLN_OkresOd, &#xD;
        PLN_OkresDo,&#xD;
	LAG(PLN_OkresDo) OVER (PARTITION BY PLN_Praid, Pln_lnbid ORDER BY PLN_OkresDo) AS PrevValidTo,&#xD;
        LEAD(PLN_WaznyOd) OVER (PARTITION BY PLN_Praid, Pln_lnbid ORDER BY PLN_WaznyOd) AS NextValidFrom&#xD;
    FROM CDN.PracLimit&#xD;
)&#xD;
SELECT &#xD;
    PLN_Praid RzPra, &#xD;
    Pln_lnbid RzLNB, &#xD;
	PLN_PlnId RzPLN,&#xD;
    PLN_WaznyOd AS ValidFrom, &#xD;
	NextValidFrom,&#xD;
	PrevValidTo,&#xD;
	ABS(datediff(day,lag(COALESCE(DATEADD(DAY, -1, NextValidFrom), PLN_OkresDo)) OVER (PARTITION BY PLN_Praid, Pln_lnbid ORDER BY COALESCE(DATEADD(DAY, -1, NextValidFrom), PLN_OkresDo)),PLN_WaznyOd)) as Roznica,&#xD;
    COALESCE(DATEADD(DAY, -1, NextValidFrom), PLN_OkresDo) AS ValidTo  INTO #RzeczywisteObowiazywanieLimitow&#xD;
FROM RankedData WHeRE YEAR(PLN_WaznyOd) = YEAR(@DATAOD) &#xD;
&#xD;
&#xD;
		SELECT COUNT(*) DniLim ,SUM(DATEPART(hour,pnb_Godz)) GodzLim,PNB_PraId Lim_praId,PLN_plnid Lim_PLNId,PLN_LNBId LIM_LNBId ,Roznica INTO #WykorzystaneDoDnia FROM #WszystkieDatyDo JOIN  CDN.PracNieobec on Date BETWEEN PNB_OkresOd and PNB_OkresDo&#xD;
		JOIN cdn.TypNieobec ON TNB_TnbId = PNB_TnbId&#xD;
		JOIN  CDN.PracLimit ON PLN_WaznyOd &lt; @DATADO  AND PLN_Rok = YEAR(  @DATADO )  and PLN_PraId = PNB_PraId AND PLN_LnbId = TNB_LnbId&#xD;
		LEFT JOIN CDN.PracEtaty ON PLN_PraId = PRE_PraId AND Date BETWEEN PRE_DataOd AND PRE_DataDo &#xD;
		LEFT JOIN CDN.PracPlanDni ON PPL_PraId = PNB_PraId AND PPL_Data = Date&#xD;
		LEFT JOIN CDN.KalendDni ON Date = KAD_Data AND PRE_KalId = KAD_KalId&#xD;
		LEFT JOIN #RzeczywisteObowiazywanieLimitow ON PLN_PlnId = RzPLN&#xD;
		WHERE ( ISNULL(PPL_TypDnia,KAD_TypDnia) = 1 OR (ISNULL(PPL_TypDnia,KAD_TypDnia) is null and (DATEPART(dw,Date) NOT IN (1,7) ) AND DATE NOT IN (select dzien from #Swieta)))&#xD;
		 and Date &lt;=  ValidTo AND ValidFrom &lt;&gt; @DATAOD &#xD;
		and NOT((Date  BETWEEN @DATAOD AND @DATADO) and (Date  BETWEEN ValidFrom and ValidTo)) AND Roznica = 1 and PrevValidTo &lt;&gt; PRE_ZatrudnionyDo&#xD;
		GROUP BY PNB_PraId, PLN_plnid,PLN_LNBId,Roznica&#xD;
&#xD;
SELECT * INTO #IloscPrzedzialowPracy FROM (&#xD;
SELECT COUNT(*) IloscKal ,Count(Case when DST_UwzglCzasPracy = 1 then 1 else null end) IloscStrefa,KDG_KadId PPrID,1 PPrTyp FROM CDN.KalendDniGodz  JOIN CDN.DefinicjeStref SPR ON SPR.DST_DstId = KDG_Strefa JOIN CDN.KalendDni ON KDG_KadId = KAD_KadId WHERE KAD_Data  BETWEEN @DATAOD AND @DATADO GROUP BY KDG_KadId&#xD;
UNION ALL &#xD;
SELECT COUNT(*),Count(Case when DST_UwzglCzasPracy = 1 then 1 else null end)ilosc2,PGL_PplId,2 FROM CDN.PracPlanDniGodz JOIN CDN.DefinicjeStref  SPR ON SPR.DST_DstId =PGL_Strefa JOIN CDN.PracPlanDni on PGL_PplId = PPL_PplId WHERE PPL_Data BETWEEN @DATAOD AND @DATADO GROUP BY PGL_PplId&#xD;
UNION ALL &#xD;
SELECT COUNT(*),Count(Case when DST_UwzglCzasPracy = 1 then 1 else null end)ilosc2,PGR_PprId,3 FROM CDN.PracPracaDniGodz JOIN CDN.DefinicjeStref SPR ON SPR.DST_DstId=PGR_Strefa JOIN CDN.PracPracaDni on PGR_PprId = PPR_PprId WHERE PPR_Data BETWEEN @DATAOD AND @DATADO GROUP BY PGR_PprId&#xD;
)PPr&#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @select =&#xD;
'&#xD;
DECLARE @Wspolczynnik DECIMAL(10,2)&#xD;
SET @Wspolczynnik = ' +@wspol+';&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], KAL_Akronim [Kalendarz], &#xD;
 case Isnull(PRA_Archiwalny,0)&#xD;
 when 0 then ''NIE''&#xD;
 else ''TAK''&#xD;
 end [Pracownik Archiwalny],&#xD;
PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
PRE_Kod [Pracownik Kod],&#xD;
ISNULL(sta.DKM_Nazwa,''(NIEPRZYPISANE)'') [Pracownik Stanowisko],&#xD;
	isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
	isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
CONVERT(VARCHAR(5), COALESCE(PGL_OdGodziny,KDG_OdGodziny),108) [Data Godzina Od], CONVERT(VARCHAR(5), COALESCE(PGL_DoGodziny,KDG_DoGodziny),108)  [Data Godzina Do],&#xD;
GETDATE() [Data Analizy],&#xD;
SPL.DST_Akronim [Strefa],&#xD;
CASE WHEN SPL.DST_Nazwa = '''' THEN ''(NIEPRZEPISANA)'' ELSE SPL.DST_Nazwa END [Strefa Nazwa],&#xD;
DPL.DZL_Kod [Wydział], PPL.PRJ_Kod [Projekt],&#xD;
--CASE WHEN PPL_TypDnia = 1 OR (PPL_PplId IS NULL AND KAD_TypDnia = 1) THEN ''TAK'' ELSE ''NIE'' END [Obecność],&#xD;
CASE COALESCE(PPL_TypDnia,KAD_TypDnia)&#xD;
	WHEN 1 THEN ''Pracy''&#xD;
	WHEN 2 THEN ''Wolny''&#xD;
	WHEN 3 THEN ''Święto''&#xD;
END [Typ Dnia],&#xD;
&#xD;
CASE WHEN SPL.DST_UwzglCzasPracy = 0 THEN NULL WHEN (KDG_OdGodziny=KDG_DoGodziny AND DATEPART(hour,KDG_OdGodziny)&lt;&gt;0) OR (PGL_OdGodziny=PGL_DoGodziny AND DATEPART(hour,PGL_OdGodziny) &lt;&gt;0) THEN&#xD;
	24.0 ELSE&#xD;
NULLIF((CASE WHEN PGL_OdGodziny IS NULL&#xD;
	THEN case when KAL_UwzglWymiarEtatu = 1 THEN(Cast(PRE_ETAEtatL as decimal)/ISNULL(NULLIF(Pre_etaetatM,0),1)) else 1.0 end * 1.0*DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END))/60&#xD;
	ELSE 1.0*DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END))/60&#xD;
END),0) END [Wymiar Pracy w Godzinach],&#xD;
&#xD;
CASE WHEN SPL.DST_UwzglCzasPracy = 0 THEN NULL WHEN(KDG_OdGodziny=KDG_DoGodziny AND DATEPART(hour,KDG_OdGodziny)&lt;&gt;0) OR (PGL_OdGodziny=PGL_DoGodziny AND DATEPART(hour,PGL_OdGodziny) &lt;&gt;0) THEN&#xD;
	24.0*60 ELSE&#xD;
NULLIF((CASE WHEN PGL_OdGodziny IS NULL&#xD;
	THEN case when KAL_UwzglWymiarEtatu = 1 THEN(Cast(PRE_ETAEtatL as decimal)/ISNULL(NULLIF(Pre_etaetatM,0),1)) else 1.0 end * DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END))&#xD;
	ELSE DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END))&#xD;
END),0) END [Wymiar Pracy w Minutach],&#xD;
&#xD;
CASE WHEN  SPL.DST_UwzglCzasPracy = 0 THEN NULL WHEN (KDG_OdGodziny=KDG_DoGodziny AND DATEPART(hour,KDG_OdGodziny)&lt;&gt;0) OR (PGL_OdGodziny=PGL_DoGodziny AND DATEPART(hour,PGL_OdGodziny) &lt;&gt;0) THEN&#xD;
	''24:00'' ELSE&#xD;
NULLIF((CASE WHEN PGL_OdGodziny IS NULL&#xD;
	THEN CONVERT(VARCHAR, cast((case when KAL_UwzglWymiarEtatu = 1 THEN(Cast(PRE_ETAEtatL as decimal)/ISNULL(NULLIF(Pre_etaetatM,0),1)) else 1.0 end) * DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END))/60 as int)) + '':'' + (CASE WHEN DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END))%60 &lt; 10 THEN ''0'' ELSE '''' END) + CONVERT(VARCHAR,DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END))%60)&#xD;
	ELSE CONVERT(VARCHAR,DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END))/60) + '':'' + (CASE WHEN DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END))%60 &lt; 10 THEN ''0'' ELSE '''' END) + CONVERT(VARCHAR,DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END))%60)&#xD;
END),''0:00'') END [Wymiar Pracy],&#xD;
&#xD;
CASE WHEN SPL.DST_UwzglCzasPracy = 0 THEN NULL WHEN (DATEDIFF(minute, PGL_OdGodziny, PGL_DoGodziny) &lt;&gt; 0) OR ((PGL_OdGodziny IS NULL) AND DATEDIFF(minute, KDG_OdGodziny, KDG_DoGodziny) &lt;&gt; 0)&#xD;
	THEN 1.0/(CASE WHEN PGL_OdGodziny IS NULL&#xD;
					THEN case when Pre_etaetatM IS NULL OR Pre_etaetatM = 0  THEN (SELECT COUNT(KDG_KdgId) FROM CDN.KalendDniGodz WHERE KDG_KadId = KAD_KadId) else (case when KAL_UwzglWymiarEtatu = 1 THEN(Cast(ISNULL(NULLIF(PRE_ETAEtatL,0),1) as decimal)/ISNULL(NULLIF(Pre_etaetatM,0),1)) else 1.0 end) END&#xD;
					ELSE (SELECT COUNT(PGL_PglId) FROM CDN.PracPlanDniGodz WHERE PPL_PplId = PGL_PplId)&#xD;
				  END)&#xD;
	WHEN (KDG_OdGodziny=KDG_DoGodziny AND DATEPART(hour,KDG_OdGodziny)&lt;&gt;0) OR (PGL_OdGodziny=PGL_DoGodziny AND DATEPART(hour,PGL_OdGodziny) &lt;&gt;0) THEN 1.0&#xD;
	ELSE NULL&#xD;
END [Wymiar Pracy w Dniach],&#xD;
&#xD;
NULL [Czas Pracy w Godzinach],  NULL [Czas Pracy w Minutach], ''Wymiar Pracy'' [Czas Pracy], NULL [Czas Pracy w Dniach],&#xD;
ISNULL(TNB_Nazwa, ''Nie dotyczy'') [Nieobecność Typ], CASE WHEN TNB_Typ = 2 THEN ''NIE'' ELSE ''TAK'' END [Nieobecność Usprawiedliwiona],&#xD;
CASE PNB_Przyczyna&#xD;
	WHEN 1 THEN ''Nie dotyczy''&#xD;
	WHEN 2 THEN ''Zwolnienie lekarskie''&#xD;
	WHEN 3 THEN ''Wypadek w pracy/choroba zawodowa''&#xD;
	WHEN 4 THEN ''Wypadek w drodze do/z pracy''&#xD;
	WHEN 5 THEN ''Zwolnienie w okresie ciąży''&#xD;
	WHEN 6 THEN ''Zwolnienie spowodowane gruźlicą''&#xD;
	WHEN 7 THEN ''Nadużycie alkoholu''&#xD;
	WHEN 8 THEN ''Przestępstwa/wykroczenie''&#xD;
	WHEN 9 THEN ''Opieka nad dzieckiem do lat 14''&#xD;
	WHEN 10 THEN ''Opieka nad inną osobą''&#xD;
	WHEN 11 THEN ''Leczenie szpitalne''&#xD;
	WHEN 12 THEN ''Badanie dawcy/pobranie organów'' &#xD;
	WHEN 13 THEN ''Urlop macierzyński 100%''&#xD;
	WHEN 14 THEN ''Urlop macierzyński 80%''&#xD;
	WHEN 15 THEN ''Urlop rodzicielski 80%''&#xD;
	WHEN 16 THEN ''Urlop rodzicielski 60%''&#xD;
	WHEN 17 THEN ''Urlop rodzicielski 100%''&#xD;
	WHEN 19 THEN ''Niezdolność do pracy/kwarantanna służb medycznych''&#xD;
	WHEN 20 THEN ''Niepoprawne wykorzystanie zwolnienia''&#xD;
	WHEN 21 THEN ''Urlop macierzyński 81,5%''&#xD;
	WHEN 22 THEN ''Urlop rodzicielski 81,5%''&#xD;
	WHEN 23 THEN ''Urlop rodzicielski 70%''&#xD;
	WHEN 24 THEN ''Urlop rodzicielski 70% (do 9 tygodni)''&#xD;
	WHEN 25 THEN ''Urlop rodzicielski 70% (ustawa "Za życiem")''&#xD;
	WHEN 22 THEN ''Urlop rodzicielski 81.5%''&#xD;
	WHEN 26 THEN ''Urlop rodzicielski 81.5% (ustawa "Za życiem")''&#xD;
	ELSE ''Nie dotyczy''&#xD;
END [Nieobecność Przyczyna], &#xD;
CASE PNB_Tryb &#xD;
	WHEN 0 THEN ''Podstawowa''&#xD;
	WHEN 1 THEN ''Anulowana''&#xD;
	WHEN 2 THEN ''Korygująca''&#xD;
	ELSE ''Nie dotyczy''&#xD;
END [Nieobecność Status], &#xD;
CASE PNB_UrlopNaZadanie &#xD;
	WHEN 0 THEN ''NIE'' &#xD;
	WHEN 1 THEN ''TAK''&#xD;
	ELSE ''Nie dotyczy''&#xD;
END [Nieobecność Na Żądanie],&#xD;
NULL [Nieobecności w Godzinach], NULL [Nieobecności w Dniach Kalendarzowych], NULL [Nieobecności w Dniach Pracy],&#xD;
''Nie dotyczy'' [Limit Nieobecności Typ], &#xD;
''Nie dotyczy'' [Limit Nieobecności Od], ''Nie dotyczy'' [Limit Nieobecności Do],&#xD;
''Nie dotyczy'' [Nieobecność Od], ''Nie dotyczy'' [Nieobecność Do],&#xD;
NULL [Limit Nieobecności Należny Dni],&#xD;
NULL [Limit Nieobecności Należny Godziny],&#xD;
NULL [Limit Nieobecności Wykorzystany Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Godziny],&#xD;
NULL [Limit Nieobecności Pozostały Dni],&#xD;
NULL [Limit Nieobecności Pozostały Godziny],&#xD;
NULL [Limit Nieobecności Zaległy Dni],&#xD;
NULL [Limit Nieobecności Zaległy Godziny],&#xD;
NULL [Wypłata Wartość Netto], NULL [Suma Elementów Wypłaty], NULL [Wypłata Wynagrodzenie Zasadnicze],&#xD;
NULL [Urlop Planowany Dni],&#xD;
NULL [Urlop Wypoczynkowy Należny Dni],&#xD;
NULL [Urlop Wypoczynkowy Pozostało Dni],&#xD;
NULL [Przybliżona Rezerwa Urlopowa],&#xD;
NULL  [Obowiązujący Limit Nieobecności Należny Dni ],&#xD;
NULL[Obowiązujący Limit Nieobecności Należny Godziny ],&#xD;
NULL [Obowiązujący Limit Nieobecności Wykorzystany Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Wykorzystany Godziny ], &#xD;
NULL  [Obowiązujący Limit Nieobecności Pozostały Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Pozostały Godziny ],&#xD;
NULL  [Obowiązujący Limit Nieobecności Zaległy Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Zaległy Godziny ],&#xD;
NULL [Obowiązujący Urlop Planowany Dni ],&#xD;
NULL [Obowiązujący Urlop Wypoczynkowy Należny Dni ],&#xD;
NULL[Obowiązujący Urlop Wypoczynkowy Pozostało Dni ],&#xD;
NULL [Obowiązujący Limit Przybliżona Rezerwa Urlopowa ],&#xD;
NULL [Limit Nieobecności Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Pozostały Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Pozostały Cały Okres Dni],&#xD;
PRE_Kod [Liczba Pracowników]&#xD;
,DZPR.DZL_Kod AS [Pracownik Wydział]&#xD;
,CASE rob.DKM_Robotnicze WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Stanowisko Robotnicze]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZat, 111), ''/'', ''-''),''(BRAK)'') END [Data Zatrudnienia Dzień]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZat) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZat)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Tydzień Roku] &#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZat) AS VARCHAR(10)),''(BRAK)'') END AS [Data Zatrudnienia Kwartał]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Rok] &#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZwol, 111), ''/'', ''-''),''(BRAK)'') END [Data Zwolnienia Dzień]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZwol) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZwol)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Tydzień Roku]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Kwartał]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Rok]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE CASE WHEN PZZwol &gt; GetDate() THEN CASE WHEN datediff(yy,PZZat,GetDate()) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,GetDate()) AS VARCHAR(10)),''(BRAK)'') END ELSE CASE WHEN datediff(yy,PZZat,PZZwol) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,PZZwol) AS VARCHAR(10)),''(BRAK)'') END END END [Pracownik Lata Pracy]&#xD;
	  ,ISNULL(CAST (datediff(yy,PRE_DataUr,Data) AS VARCHAR(10)),''(BRAK)'') [Pracownik Wiek]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), Data, 111), ''/'', ''-'') [Data]&#xD;
*/&#xD;
&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), Data, 111), ''/'', ''-'') [Data Dzień], MONTH(Data) [Data Miesiąc], YEAR(Data) [Data Rok]&#xD;
,CASE when MONTH(Data) &lt;7 THEN ''I'' else ''II'' END AS [Data Półrocze]&#xD;
,DATEPART(quarter, Data) AS [Data Kwartał] &#xD;
&#xD;
----------KONTEKSTY&#xD;
,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__]&#xD;
,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
&#xD;
&#xD;
&#xD;
' + @kolumny + @atrybuty + '&#xD;
FROM #Daty&#xD;
	LEFT JOIN CDN.PracEtaty ON PRE_PreId = PreId&#xD;
	LEFT JOIN #PracZat on PZPraId = PRE_PraID&#xD;
	LEFT JOIN #Umowy ON UPraId = PraId AND UData = Data&#xD;
	LEFT JOIN CDN.KalendDni ON Data = KAD_Data AND PRE_KalId = KAD_KalId AND ((Data &lt;= PZZwol AND Data &gt;= PZZat) OR UUmw &gt; 0)&#xD;
	LEFT JOIN CDN.Kalendarze ON KAD_KalId = KAL_KalId&#xD;
	LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko =  sta.DKM_DkmId AND  sta.DKM_Rodzaj = 1&#xD;
	LEFT JOIN CDN.PracPlanDni ON PPL_PraId = PRE_PraId AND PPL_Data = Data&#xD;
	LEFT JOIN CDN.KalendDniGodz ON KDG_KadId = KAD_KadId AND PPL_PplId IS NULL&#xD;
	LEFT JOIN CDN.PracPlanDniGodz ON PPL_PplId = PGL_PplId&#xD;
	LEFT JOIN CDN.DefinicjeStref SPL ON COALESCE(PGL_Strefa,KDG_Strefa) = SPL.DST_DstId&#xD;
	LEFT JOIN CDN.Dzialy DPL ON COALESCE(PGL_DzlId,KDG_DzlId) = DPL.DZL_DzlId &#xD;
	LEFT JOIN CDN.DefProjekty PPL ON COALESCE(PGL_PrjId,KDG_PrjId) = PPL.PRJ_PrjId&#xD;
	LEFT JOIN CDN.PracNieobec ON PNB_PraId = PRE_PraId AND Data &gt;= PNB_OkresOd AND Data &lt;= PNB_OkresDo AND PNB_Tryb &lt;&gt; 1&#xD;
	LEFT JOIN CDN.TypNieobec ON PNB_TnbId = TNB_TnbId&#xD;
	LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
	LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
	LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = PRE_ZakId&#xD;
	LEFT JOIN CDN.PracKod on PRA_PraId = PRE_PraId&#xD;
	LEFT JOIN cdn.DaneKadMod rob on PRE_ETADkmIdStanowisko = rob.DKM_DkmId&#xD;
	LEFT JOIN cdn.Dzialy DZPR ON PRE_DzlId = DZPR.DZL_DzlId &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	LEFT JOIN ' + @Operatorzy + ' zal ON PRE_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON PRE_OpeModID = mod.Ope_OpeId&#xD;
    WHERE ((PZZat &lt;= convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)&#xD;
	AND PZZwol &gt;= convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)) OR UUmw &gt; 0)&#xD;
	AND Data &gt;= PZZat AND Data &lt;= PZZwol&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], KAL_Akronim [Kalendarz], &#xD;
case Isnull(PRA_Archiwalny,0)&#xD;
 when 0 then ''NIE''&#xD;
 else ''TAK''&#xD;
 end [Pracownik Archiwalny],&#xD;
PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
PRE_Kod [Pracownik Kod], &#xD;
ISNULL(sta.DKM_Nazwa,''(NIEPRZYPISANE)'') [Pracownik Stanowisko],&#xD;
	isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
	isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
CONVERT(VARCHAR(5), COALESCE(PGR_OdGodziny,PGL_OdGodziny,KDG_OdGodziny),108) [Data Godzina Od], CONVERT(VARCHAR(5), COALESCE(PGR_DoGodziny,PGL_DoGodziny,KDG_DoGodziny),108) [Data Godzina Do],&#xD;
GETDATE() [Data Analizy],&#xD;
CASE WHEN Data &gt; GETDATE() THEN NULL ELSE SPR.DST_Akronim END [Strefa], &#xD;
CASE WHEN Data &gt; GETDATE() THEN NULL ELSE CASE WHEN SPR.DST_Nazwa = '''' THEN ''(NIEPRZEPISANA)'' ELSE SPR.DST_Nazwa END END [Strefa Nazwa], &#xD;
CASE WHEN Data &gt; GETDATE() THEN NULL ELSE DPR.DZL_Kod END [Wydział], &#xD;
CASE WHEN Data &gt; GETDATE() THEN NULL ELSE PPR.PRJ_Kod END [Projekt],&#xD;
--CASE WHEN (PPL_TypDnia = 1 OR (PPL_PplId IS NULL AND KAD_TypDnia = 1)) AND (ISNULL(PNB_Calodzienna,0) = 0) THEN ''TAK'' ELSE ''NIE'' END [Obecność],&#xD;
CASE COALESCE(PPL_TypDnia,KAD_TypDnia)&#xD;
	WHEN 1 THEN ''Pracy''&#xD;
	WHEN 2 THEN ''Wolny''&#xD;
	WHEN 3 THEN ''Święto''&#xD;
END [Typ Dnia],&#xD;
NULL [Wymiar Pracy w Godzinach], NULL [Wymiar Pracy w Minutach],&#xD;
''Czas Pracy'' [Wymiar Pracy],&#xD;
 NULL [Wymiar Pracy w Dniach],&#xD;
CASE WHEN Data &gt; GETDATE() OR (PNB_Calodzienna = 1) OR SPR.DST_UwzglCzasPracy = 0  THEN NULL&#xD;
ELSE NULLIF(CASE WHEN PGR_OdGodziny IS NULL&#xD;
	THEN CASE WHEN PGL_OdGodziny IS NULL&#xD;
			THEN&#xD;
				CASE WHEN KDG_OdGodziny &lt;&gt; KDG_DoGodziny THEN&#xD;
				case when KAL_UwzglWymiarEtatu = 1 THEN(Cast(PRE_ETAEtatL as decimal)/ISNULL(NULLIF(Pre_etaetatM,0),1)) else 1.0 end * 1.0*DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END))/60&#xD;
				WHEN DATEPART(hour,KDG_OdGodziny)&lt;&gt;0 THEN 24.0 END&#xD;
			ELSE &#xD;
				CASE WHEN PGL_OdGodziny &lt;&gt; PGL_DoGodziny THEN&#xD;
				1.0*DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END))/60&#xD;
				WHEN DATEPART(hour,PGL_OdGodziny)&lt;&gt;0 THEN 24.0 END&#xD;
		END&#xD;
	ELSE&#xD;
		CASE WHEN PGR_OdGodziny &lt;&gt; PGR_DoGodziny THEN&#xD;
		 1.0*DATEDIFF(minute,PGR_OdGodziny,(CASE WHEN PGR_OdGodziny &gt; PGR_DoGodziny THEN DATEADD(day,1,PGR_DoGodziny) ELSE PGR_DoGodziny END))/60&#xD;
		WHEN DATEPART(hour,PGR_OdGodziny)&lt;&gt;0 THEN 24.0 END&#xD;
	END,0) &#xD;
END - CASE WHEN PGR_OdGodziny IS NULL THEN ISNULL(datediff(MI,CONVERT(DATETIME,''1899-12-30 00:00:00.000'',120),PNB_Godz),0)/60.0  else 0 end [Czas Pracy w Godzinach], &#xD;
CASE WHEN Data &gt; GETDATE() OR (PNB_Calodzienna = 1) OR SPR.DST_UwzglCzasPracy = 0  THEN NULL&#xD;
ELSE NULLIF(CASE WHEN PGR_OdGodziny IS NULL&#xD;
	THEN CASE WHEN PGL_OdGodziny IS NULL&#xD;
			THEN&#xD;
				CASE WHEN KDG_OdGodziny &lt;&gt; KDG_DoGodziny THEN&#xD;
				case when KAL_UwzglWymiarEtatu = 1 THEN(Cast(PRE_ETAEtatL as decimal)/ISNULL(NULLIF(Pre_etaetatM,0),1)) else 1.0 end * DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END))&#xD;
				WHEN DATEPART(hour,KDG_OdGodziny) &lt;&gt; 0 THEN 24.0*60 END&#xD;
			ELSE &#xD;
				CASE WHEN PGL_OdGodziny &lt;&gt; PGL_DoGodziny THEN&#xD;
				DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END))&#xD;
				WHEN DATEPART(hour,PGL_OdGodziny)&lt;&gt;0 THEN 24.0*60 END&#xD;
		END&#xD;
	ELSE &#xD;
		CASE WHEN PGR_OdGodziny &lt;&gt; PGR_DoGodziny THEN&#xD;
		DATEDIFF(minute,PGR_OdGodziny,(CASE WHEN PGR_OdGodziny &gt; PGR_DoGodziny THEN DATEADD(day,1,PGR_DoGodziny) ELSE PGR_DoGodziny END)) &#xD;
		WHEN DATEPART(hour,PGR_OdGodziny)&lt;&gt;0 THEN 24.0*60 END&#xD;
	END,0) &#xD;
END - CASE WHEN PGR_OdGodziny IS NULL THEN ISNULL(datediff(MI,CONVERT(DATETIME,''1899-12-30 00:00:00.000'',120),PNB_Godz),0) ELSE 0 END [Czas Pracy w Minutach],&#xD;
CASE WHEN Data &gt; GETDATE() OR (PNB_Calodzienna = 1) OR SPR.DST_UwzglCzasPracy = 0  THEN NULL&#xD;
	ELSE &#xD;
	CASE WHEN (PGR_OdGodziny=PGR_DoGodziny AND DATEPART(hour,PGR_OdGodziny)&lt;&gt;0) OR (PGL_OdGodziny=PGL_DoGodziny AND DATEPART(hour,PGL_OdGodziny)&lt;&gt;0) OR (KDG_OdGodziny=KDG_DoGodziny AND DATEPART(hour,KDG_OdGodziny)&lt;&gt;0) THEN&#xD;
	''24:00'' ELSE&#xD;
	NULLIF((CASE &#xD;
					WHEN PGR_OdGodziny IS NOT NULL THEN CONVERT(VARCHAR,DATEDIFF(minute,PGR_OdGodziny,(CASE WHEN PGR_OdGodziny &gt; PGR_DoGodziny THEN DATEADD(day,1,PGR_DoGodziny) ELSE PGR_DoGodziny END))/60) + '':'' + (CASE WHEN DATEDIFF(minute,PGR_OdGodziny,(CASE WHEN PGR_OdGodziny &gt; PGR_DoGodziny THEN DATEADD(day,1,PGR_DoGodziny) ELSE PGR_DoGodziny END))%60 &lt; 10 THEN ''0'' ELSE '''' END) + CONVERT(VARCHAR,DATEDIFF(minute,PGR_OdGodziny,(CASE WHEN PGR_OdGodziny &gt; PGR_DoGodziny THEN DATEADD(day,1,PGR_DoGodziny) ELSE PGR_DoGodziny END))%60)&#xD;
					WHEN PGL_OdGodziny IS NOT NULL THEN CONVERT(VARCHAR,DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END))/60-(ISNULL(datediff(MI,CONVERT(DATETIME,''1899-12-30 00:00:00.000'',120),PNB_Godz),0))/60) + '':'' + (CASE WHEN DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END))%60 &lt; 10 THEN ''0'' ELSE '''' END) + CONVERT(VARCHAR,DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END)-(ISNULL(datediff(MI,CONVERT(DATETIME,''1899-12-30 00:00:00.000'',120),PNB_Godz),0)))%60)&#xD;
					ELSE  CONVERT(VARCHAR,CAST((case when KAL_UwzglWymiarEtatu = 1 THEN(Cast(PRE_ETAEtatL as decimal)/ISNULL(NULLIF(Pre_etaetatM,0),1)) else 1.0 end) * DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END))/60 -(ISNULL(datediff(MI,CONVERT(DATETIME,''1899-12-30 00:00:00.000'',120),PNB_Godz),0))/60 AS INT))  + '':'' + (CASE WHEN DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END))%60 &lt; 10 THEN ''0'' ELSE '''' END) + CONVERT(VARCHAR,DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END)-(ISNULL(datediff(MI,CONVERT(DATETIME,''1899-12-30 00:00:00.000'',120),PNB_Godz),0)))%60) &#xD;
				END),''0:00'') &#xD;
				END&#xD;
END [Czas Pracy],&#xD;
CASE &#xD;
	WHEN Data &gt; GETDATE() OR (PNB_Calodzienna = 1)  OR SPR.DST_UwzglCzasPracy = 0  THEN NULL&#xD;
	WHEN (DATEDIFF(minute, PGR_OdGodziny, PGR_DoGodziny) &lt;&gt; 0) OR ((PGR_OdGodziny IS NULL) AND (DATEDIFF(minute, PGL_OdGodziny, PGL_DoGodziny) &lt;&gt; 0)) OR ((PGR_OdGodziny IS NULL) AND (PGL_OdGodziny IS NULL) AND (DATEDIFF(minute, KDG_OdGodziny, KDG_DoGodziny) &lt;&gt; 0)) THEN 1.0/&#xD;
		(CASE &#xD;
			WHEN PGR_OdGodziny IS NOT NULL THEN (SELECT COUNT(PGR_PgrId) FROM CDN.PracPracaDniGodz WHERE PPR_PprId = PGR_PprId)&#xD;
			WHEN PGL_OdGodziny IS NOT NULL THEN (SELECT COUNT(PGL_PglId) FROM CDN.PracPlanDniGodz WHERE PPL_PplId = PGL_PplId)&#xD;
			ELSE  case when Pre_etaetatM IS NULL OR Pre_etaetatM = 0  THEN (SELECT COUNT(KDG_KdgId) FROM CDN.KalendDniGodz WHERE KDG_KadId = KAD_KadId) else (case when KAL_UwzglWymiarEtatu = 1 THEN(Cast(ISNULL(NULLIF(PRE_ETAEtatL,0),1) as decimal)/ISNULL(NULLIF(Pre_etaetatM,0),1)) else 1.0 end) END&#xD;
		END)&#xD;
	WHEN (PGR_OdGodziny=PGR_DoGodziny AND DATEPART(hour,PGR_OdGodziny)&lt;&gt;0) OR (PGL_OdGodziny=PGL_DoGodziny AND DATEPART(hour,PGL_OdGodziny)&lt;&gt;0) OR (KDG_OdGodziny=KDG_DoGodziny AND DATEPART(hour,KDG_OdGodziny)&lt;&gt;0) THEN 1.0&#xD;
	ELSE NULL&#xD;
END - CASE WHEN PGR_OdGodziny IS NULL THEN (ISNULL(datediff(MI,CONVERT(DATETIME,''1899-12-30 00:00:00.000'',120),PNB_Godz),0)/60.0)/8.0 ELSE 0 END [Czas Pracy w Dniach],&#xD;
ISNULL(TNB_Nazwa, ''Nie dotyczy'') [Nieobecność Typ], CASE WHEN TNB_Typ = 2 THEN ''NIE'' ELSE ''TAK'' END [Nieobecność Usprawiedliwiona],&#xD;
CASE PNB_Przyczyna&#xD;
	WHEN 1 THEN ''Nie dotyczy''&#xD;
	WHEN 2 THEN ''Zwolnienie lekarskie''&#xD;
	WHEN 3 THEN ''Wypadek w pracy/choroba zawodowa''&#xD;
	WHEN 4 THEN ''Wypadek w drodze do/z pracy''&#xD;
	WHEN 5 THEN ''Zwolnienie w okresie ciąży''&#xD;
	WHEN 6 THEN ''Zwolnienie spowodowane gruźlicą''&#xD;
	WHEN 7 THEN ''Nadużycie alkoholu''&#xD;
	WHEN 8 THEN ''Przestępstwa/wykroczenie''&#xD;
	WHEN 9 THEN ''Opieka nad dzieckiem do lat 14''&#xD;
	WHEN 10 THEN ''Opieka nad inną osobą''&#xD;
	WHEN 11 THEN ''Leczenie szpitalne''&#xD;
	WHEN 12 THEN ''Badanie dawcy/pobranie organów'' &#xD;
	WHEN 13 THEN ''Urlop macierzyński 100%''&#xD;
	WHEN 14 THEN ''Urlop macierzyński 80%''&#xD;
	WHEN 15 THEN ''Urlop rodzicielski 80%''&#xD;
	WHEN 16 THEN ''Urlop rodzicielski 60%''&#xD;
	WHEN 17 THEN ''Urlop rodzicielski 100%''&#xD;
	WHEN 19 THEN ''Niezdolność do pracy/kwarantanna służb medycznych''&#xD;
	WHEN 20 THEN ''Niepoprawne wykorzystanie zwolnienia''&#xD;
	WHEN 21 THEN ''Urlop macierzyński 81,5%''&#xD;
	WHEN 22 THEN ''Urlop rodzicielski 81,5%''&#xD;
	WHEN 23 THEN ''Urlop rodzicielski 70%''&#xD;
	WHEN 24 THEN ''Urlop rodzicielski 70% (do 9 tygodni)''&#xD;
	WHEN 25 THEN ''Urlop rodzicielski 70% (ustawa "Za życiem")''&#xD;
	WHEN 22 THEN ''Urlop rodzicielski 81.5%''&#xD;
	WHEN 26 THEN ''Urlop rodzicielski 81.5% (ustawa "Za życiem")''&#xD;
	ELSE ''Nie dotyczy''&#xD;
END [Nieobecność Przyczyna],&#xD;
CASE PNB_Tryb &#xD;
	WHEN 0 THEN ''Podstawowa''&#xD;
	WHEN 1 THEN ''Anulowana''&#xD;
	WHEN 2 THEN ''Korygująca''&#xD;
	ELSE ''Nie dotyczy''&#xD;
END [Nieobecność Status],&#xD;
CASE PNB_UrlopNaZadanie &#xD;
	WHEN 0 THEN ''NIE'' &#xD;
	WHEN 1 THEN ''TAK''&#xD;
	ELSE ''Nie dotyczy''&#xD;
END [Nieobecność Na Żądanie],&#xD;
NULL [Nieobecności w Godzinach],&#xD;
NULL [Nieobecności w Dniach Kalendarzowych],&#xD;
NULL [Nieobecności w Dniach Pracy],&#xD;
''Nie dotyczy'' [Limit Nieobecności Typ], &#xD;
''Nie dotyczy'' [Limit Nieobecności Od], ''Nie dotyczy'' [Limit Nieobecności Do],&#xD;
''Nie dotyczy'' [Nieobecność Od], ''Nie dotyczy'' [Nieobecność Do],&#xD;
NULL [Limit Nieobecności Należny Dni],&#xD;
NULL [Limit Nieobecności Należny Godziny],&#xD;
NULL [Limit Nieobecności Wykorzystany Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Godziny],&#xD;
NULL [Limit Nieobecności Pozostały Dni],&#xD;
NULL [Limit Nieobecności Pozostały Godziny],&#xD;
NULL [Limit Nieobecności Zaległy Dni],&#xD;
NULL [Limit Nieobecności Zaległy Godziny],&#xD;
NULL [Wypłata Wartość Netto], NULL [Suma Elementów Wypłaty], NULL [Wypłata Wynagrodzenie Zasadnicze],&#xD;
NULL [Urlop Planowany Dni],&#xD;
NULL [Urlop Wypoczynkowy Należny Dni],&#xD;
NULL [Urlop Wypoczynkowy Pozostało Dni],&#xD;
NULL [Przybliżona Rezerwa Urlopowa],&#xD;
NULL  [Obowiązujący Limit Nieobecności Należny Dni ],&#xD;
NULL[Obowiązujący Limit Nieobecności Należny Godziny ],&#xD;
NULL [Obowiązujący Limit Nieobecności Wykorzystany Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Wykorzystany Godziny ], &#xD;
NULL  [Obowiązujący Limit Nieobecności Pozostały Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Pozostały Godziny ],&#xD;
NULL  [Obowiązujący Limit Nieobecności Zaległy Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Zaległy Godziny ],&#xD;
NULL [Obowiązujący Urlop Planowany Dni ],&#xD;
NULL [Obowiązujący Urlop Wypoczynkowy Należny Dni ],&#xD;
NULL[Obowiązujący Urlop Wypoczynkowy Pozostało Dni ],&#xD;
NULL [Obowiązujący Przybliżona Rezerwa Urlopowa ],&#xD;
NULL [Limit Nieobecności Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Pozostały Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Pozostały Cały Okres Dni],&#xD;
PRE_Kod [Liczba Pracowników]&#xD;
,DZPR.DZL_Kod AS [Pracownik Wydział]&#xD;
,CASE rob.DKM_Robotnicze WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Stanowisko Robotnicze]&#xD;
	 ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZat, 111), ''/'', ''-''),''(BRAK)'') END [Data Zatrudnienia Dzień]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZat) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZat)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Tydzień Roku] &#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZat) AS VARCHAR(10)),''(BRAK)'') END AS [Data Zatrudnienia Kwartał]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Rok] &#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZwol, 111), ''/'', ''-''),''(BRAK)'') END [Data Zwolnienia Dzień]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZwol) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZwol)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Tydzień Roku]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Kwartał]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Rok]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE CASE WHEN PZZwol &gt; GetDate() THEN CASE WHEN datediff(yy,PZZat,GetDate()) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,GetDate()) AS VARCHAR(10)),''(BRAK)'') END ELSE CASE WHEN datediff(yy,PZZat,PZZwol) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,PZZwol) AS VARCHAR(10)),''(BRAK)'') END END END [Pracownik Lata Pracy]&#xD;
	  ,ISNULL(CAST (datediff(yy,PRE_DataUr,Data) AS VARCHAR(10)),''(BRAK)'') [Pracownik Wiek]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), Data, 111), ''/'', ''-'') [Data]&#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), Data, 111), ''/'', ''-'') [Data Dzień], MONTH(Data) [Data Miesiąc], YEAR(Data) [Data Rok]&#xD;
,CASE when MONTH(Data) &lt;7 THEN ''I'' else ''II'' END AS [Data Półrocze]&#xD;
,DATEPART(quarter, Data) AS [Data Kwartał] &#xD;
&#xD;
----------KONTEKSTY&#xD;
,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__]&#xD;
,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
&#xD;
&#xD;
' + @kolumny + @atrybuty + '&#xD;
FROM #Daty&#xD;
	LEFT JOIN CDN.PracEtaty ON PRE_PreId = PreId&#xD;
	LEFT JOIN #PracZat on PZPraId = PRE_PraID&#xD;
	LEFT JOIN #Umowy ON UPraId = PraId AND UData = Data&#xD;
	LEFT JOIN CDN.KalendDni ON Data = KAD_Data AND PRE_KalId = KAD_KalId AND ((Data &lt;= PZZwol AND Data &gt;= PZZat) OR UUmw &gt; 0)&#xD;
	LEFT JOIN CDN.Kalendarze ON KAD_KalId = KAL_KalId &#xD;
	LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko =  sta.DKM_DkmId AND  sta.DKM_Rodzaj = 1&#xD;
	LEFT JOIN CDN.PracPlanDni ON PPL_PraId = PRE_PraId AND PPL_Data = Data&#xD;
	LEFT JOIN CDN.PracPracaDni ON PPR_PraId = PRE_PraId AND PPR_Data = Data&#xD;
	LEFT JOIN CDN.KalendDniGodz ON KDG_KadId = KAD_KadId AND PPL_PplId IS NULL AND PPR_PprId IS NULL&#xD;
	LEFT JOIN CDN.PracPlanDniGodz ON PPL_PplId = PGL_PplId AND PPR_PprId IS NULL&#xD;
	LEFT JOIN CDN.PracPracaDniGodz ON PPR_PprId = PGR_PprId&#xD;
	LEFT JOIN CDN.DefinicjeStref SPR ON COALESCE(PGR_Strefa,PGL_Strefa,KDG_Strefa) = SPR.DST_DstId&#xD;
	LEFT JOIN CDN.Dzialy DPR ON COALESCE(PGR_DzlId,PGL_DzlId,KDG_DzlId) = DPR.DZL_DzlId &#xD;
	LEFT JOIN CDN.DefProjekty PPR ON COALESCE(PGR_PrjId,PGL_PrjId,KDG_PrjId) = PPR.PRJ_PrjId&#xD;
	LEFT JOIN CDN.PracNieobec ON PNB_PraId = PRE_PraId AND Data &gt;= PNB_OkresOd AND Data &lt;= PNB_OkresDo AND PNB_Tryb &lt;&gt; 1&#xD;
	LEFT JOIN CDN.TypNieobec ON PNB_TnbId = TNB_TnbId&#xD;
	LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
	LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
	LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = PRE_ZakId&#xD;
	LEFT JOIN CDN.PracKod on PRA_PraId = PRE_PraId&#xD;
	LEFT JOIN cdn.DaneKadMod rob on PRE_ETADkmIdStanowisko = rob.DKM_DkmId&#xD;
	LEFT JOIN cdn.Dzialy DZPR ON PRE_DzlId = DZPR.DZL_DzlId &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	LEFT JOIN ' + @Operatorzy + ' zal ON PRE_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON PRE_OpeModID = mod.Ope_OpeId&#xD;
	LEFT JOIN #IloscPrzedzialowPracy  ON (PPRID = KAD_KadId AND PPL_PplId IS NULL AND PPR_PprId IS NULL AND PPRTYP = 1)or( PPL_PplId = PPRID AND PPR_PprId IS NULL and PPRTYP = 2 ) OR ( PPR_PprId = PPRID and PPRTYP = 3)&#xD;
    WHERE ((PZZat &lt;= convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)&#xD;
	AND PZZwol &gt;= convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)) OR UUmw &gt; 0)&#xD;
		AND Data &gt;= PZZat AND Data &lt;= PZZwol&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], ''Nie dotyczy'' [Kalendarz],&#xD;
case Isnull(PRA_Archiwalny,0)&#xD;
 when 0 then ''NIE''&#xD;
 else ''TAK''&#xD;
 end [Pracownik Archiwalny],&#xD;
PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
PRE_Kod [Pracownik Kod], &#xD;
ISNULL(sta.DKM_Nazwa,''(NIEPRZYPISANE)'') [Pracownik Stanowisko],&#xD;
	isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
	isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
''Nie dotyczy'' [Data Godzina Od], ''Nie dotyczy'' [Data Godzina Do], GETDATE() [Data Analizy], ''Nie dotyczy'' [Strefa],''Nie dotyczy'' [Strefa Nazwa],''Nie dotyczy'' [Wydział], ''Nie dotyczy'' [Projekt],&#xD;
--CASE WHEN (PPL_TypDnia = 1 OR (PPL_PplId IS NULL AND KAD_TypDnia = 1)) AND (ISNULL(PNB_Calodzienna,0) = 0) THEN ''TAK'' ELSE ''NIE'' END [Obecność],&#xD;
''Nie dotyczy'' [Typ Dnia], NULL [Wymiar Pracy w Godzinach], NULL [Wymiar Pracy w Minutach], NULL [Wymiar Pracy], NULL [Wymiar Pracy w Dniach],&#xD;
NULL [Czas Pracy w Godzinach], NULL [Czas Pracy w Minutach], NULL [Czas Pracy], NULL [Czas Pracy w Dniach],&#xD;
''Nie dotyczy'' [Nieobecność Typ], ''Nie dotyczy'' [Nieobecność Usprawiedliwiona], ''Nie dotyczy'' [Nieobecność Przyczyna], ''Nie dotyczy'' [Nieobecność Status],&#xD;
''Nie dotyczy'' [Nieobecność Na Żądanie], NULL [Nieobecności w Godzinach], NULL [Nieobecności w Dniach Kalendarzowych], NULL [Nieobecności w Dniach Pracy],&#xD;
LNB_Nazwa [Limit Nieobecności Typ], &#xD;
REPLACE(CONVERT(VARCHAR(10), X.PLN_OkresOd, 111), ''/'', ''-'') [Limit Nieobecności Od], REPLACE(CONVERT(VARCHAR(10), X.PLN_OkresDo, 111), ''/'', ''-'') [Limit Nieobecności Do],&#xD;
''Nie dotyczy'' [Nieobecność Od], ''Nie dotyczy'' [Nieobecność Do],&#xD;
&#xD;
ISNULL(Y.PLN_NalezneLacznieF, X.PLN_NalezneLacznieF) [Limit Nieobecności Należny Dni],&#xD;
DATEDIFF(hour,convert(datetime,''18991230'',112),ISNULL(Y.PLN_NalezneLacznieCzas,X.PLN_NalezneLacznieCzas)) [Limit Nieobecności Należny Godziny],&#xD;
&#xD;
NULL [Limit Nieobecności Wykorzystany Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Godziny],&#xD;
&#xD;
ISNULL(Y.PLN_NalezneLacznieF, X.PLN_NalezneLacznieF) - ISNULL(ISNULL(DNILIM,0),0) - CASE WHEN GodzLIM IS NULL THEN 0 ELSE (GodzLIM/8)/isnull(NUllif((cast(PRE_ETAEtatL as decimal)/cast(isnull(NUllif(PRE_ETAEtatM,0),1) as decimal)),0),1) END - X.PLN_EkwiwalentF [Limit Nieobecności Pozostały Dni],&#xD;
DATEDIFF(hour,convert(datetime,''18991230'',112),ISNULL(Y.PLN_NalezneLacznieCzas,X.PLN_NalezneLacznieCzas)) - isnull(GodzLim,0)  - case when ISNULL(DNILIM,0) IS NULL THEN 0 ELSE (ISNULL(DNILIM,0) * 8 / ISNULL(NULLIF(cast(PRE_ETAEtatL as decimal)/cast(ISNULL(NULLIF(PRE_ETAEtatM,0),1) as decimal),0),1)) END  -  DATEDIFF(hour, convert(datetime,''1899-12-30 00:00:00.000'',120),X.PLN_EkwiwalentCzas) [Limit Nieobecności Pozostały Godziny],&#xD;
ISNULL(Y.PLN_PrzeniesienieF,X.PLN_PrzeniesienieF) [Limit Nieobecności Zaległy Dni],&#xD;
DATEDIFF(hour,convert(datetime,''18991230'',112),ISNULL(Y.PLN_PrzeniesienieCzas,X.PLN_PrzeniesienieCzas))[Limit Nieobecności Zaległy Godziny],&#xD;
NULL [Wypłata Wartość Netto], NULL [Suma Elementów Wypłaty], NULL [Wypłata Wynagrodzenie Zasadnicze], &#xD;
ISNULL(X.PLN_PlanowanyF, Y.PLN_PlanowanyF) [Urlop Planowany Dni],&#xD;
CASE &#xD;
WHEN  ISNULL(Y.PLN_LNBId, X.PLN_LNBId)  NOT IN (1,3,6) OR ISNULL(Y.PLN_LNBId, X.PLN_LNBId) IS NULL THEN NULL&#xD;
ELSE ISNULL(X.PLN_NalezneLacznieF, Y.PLN_NalezneLacznieF) END AS [Urlop Wypoczynkowy Należny Dni],&#xD;
CASE &#xD;
WHEN  ISNULL(Y.PLN_LNBId, X.PLN_LNBId)  NOT IN (1,3,6) OR ISNULL(Y.PLN_LNBId, X.PLN_LNBId) IS NULL THEN NULL&#xD;
ELSE ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF) END &#xD;
- CASE WHEN LIM_LNBID NOT IN (1,3,6) or LIM_LNBID IS NULL THEN 0 ELSE &#xD;
ISNULL(DNILIM,0) + (CASE WHEN GodzLIM IS NULL THEN 0 ELSE (GodzLIM/8)/ISNULL(NULLIF((cast(PRE_ETAEtatL as decimal)/cast(ISNULL(NULLIF(PRE_ETAEtatM,0),1) as decimal)),0),1) end) END - X.PLN_EkwiwalentF&#xD;
AS [Urlop Wypoczynkowy Pozostało Dni],&#xD;
CASE &#xD;
WHEN  ISNULL(Y.PLN_LNBId, X.PLN_LNBId)  NOT IN (1,3,6) THEN 0&#xD;
When Rezerwa = 0 THEN 0&#xD;
WHEN PRE_ETAEtatL=3 AND PRE_ETAEtatM=4 THEN ((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0) - X.PLN_EkwiwalentF)*IlMies)/'+ @wspol +'/0.75 * NULLIF(Rezerwa,0)&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=2 THEN ((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0))*IlMies - X.PLN_EkwiwalentF)/'+ @wspol +'/0.5 * NULLIF(Rezerwa,0)&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=3 THEN ((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0))*IlMies - X.PLN_EkwiwalentF)/'+ @wspol +'/0.33 * NULLIF(Rezerwa,0)&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=4 THEN ((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0))*IlMies- X.PLN_EkwiwalentF )/'+ @wspol +'/0.25 * NULLIF(Rezerwa,0)&#xD;
ELSE  ((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)*IlMies)/'+ @wspol +' * NULLIF(Rezerwa,0) END [Przybliżona Rezerwa Urlopowa],&#xD;
NULL  [Obowiązujący Limit Nieobecności Należny Dni ],&#xD;
NULL[Obowiązujący Limit Nieobecności Należny Godziny ],&#xD;
NULL [Obowiązujący Limit Nieobecności Wykorzystany Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Wykorzystany Godziny ], &#xD;
NULL  [Obowiązujący Limit Nieobecności Pozostały Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Pozostały Godziny ],&#xD;
NULL  [Obowiązujący Limit Nieobecności Zaległy Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Zaległy Godziny ],&#xD;
NULL [Obowiązujący Urlop Planowany Dni ],&#xD;
NULL [Obowiązujący Urlop Wypoczynkowy Należny Dni ],&#xD;
NULL[Obowiązujący Urlop Wypoczynkowy Pozostało Dni ],&#xD;
NULL [Obowiązujący Przybliżona Rezerwa Urlopowa ],&#xD;
NULL [Limit Nieobecności Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Pozostały Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Pozostały Cały Okres Dni],&#xD;
&#xD;
PRE_Kod [Liczba Pracowników]&#xD;
,DZPR.DZL_Kod AS [Pracownik Wydział]&#xD;
,CASE rob.DKM_Robotnicze WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Stanowisko Robotnicze]&#xD;
		,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZat, 111), ''/'', ''-''),''(BRAK)'') END [Data Zatrudnienia Dzień]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZat) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZat)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Tydzień Roku] &#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZat) AS VARCHAR(10)),''(BRAK)'') END AS [Data Zatrudnienia Kwartał]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Rok] &#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZwol, 111), ''/'', ''-''),''(BRAK)'') END [Data Zwolnienia Dzień]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZwol) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZwol)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Tydzień Roku]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Kwartał]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Rok]&#xD;
	 ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE CASE WHEN PZZwol &gt; GetDate() THEN CASE WHEN datediff(yy,PZZat,GetDate()) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,GetDate()) AS VARCHAR(10)),''(BRAK)'') END ELSE CASE WHEN datediff(yy,PZZat,PZZwol) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,PZZwol) AS VARCHAR(10)),''(BRAK)'') END END END [Pracownik Lata Pracy]&#xD;
	  ,ISNULL(CAST (datediff(yy,PRE_DataUr,X.PLN_WaznyOd) AS VARCHAR(10)),''(BRAK)'') [Pracownik Wiek]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), X.PLN_WaznyOd, 111), ''/'', ''-'') [Data]&#xD;
*/&#xD;
&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), X.PLN_WaznyOd, 111), ''/'', ''-'') [Data Dzień], MONTH(X.PLN_WaznyOd) [Data Miesiąc], YEAR(X.PLN_WaznyOd) [Data Rok]&#xD;
,CASE when MONTH( X.PLN_WaznyOd) &lt;7 THEN ''I'' else ''II'' END AS [Data Półrocze]&#xD;
,DATEPART(quarter,  X.PLN_WaznyOd) AS [Data Kwartał] &#xD;
&#xD;
----------KONTEKSTY&#xD;
,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__]&#xD;
,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + '&#xD;
FROM CDN.LimitNieobec&#xD;
	JOIN CDN.PracLimit X ON X.PLN_LnbId = LNB_LnbId  AND X.PLN_PierwszaPraca = 0&#xD;
	LEFT JOIN CDN.PracLimit Y ON X.PLN_PlnId = Y.PLN_ParentId  AND y.PLN_PierwszaPraca = 0&#xD;
	LEFT JOIN CDN.PracEtaty ON PRE_PreId = (SELECT TOP 1 PRE_PreId FROM CDN.PracEtaty WHERE PRE_PraId = X.PLN_PraId AND &#xD;
	((((PRE_DataOd Between X.PLN_WaznyOd AND X.PLN_OkresDo) AND (PRE_DataDo Between X.PLN_WaznyOd AND X.PLN_OkresDo ))&#xD;
	OR ((X.PLN_WaznyOd BETWEEN PRE_DataOd AND PRE_DataDo)AND(X.PLN_OkresDo BETWEEN PRE_DataOd AND PRE_DataDo)))&#xD;
	OR (YEAR(X.PLN_OkresDo) = YEAR (PRE_DataDo) )&#xD;
	OR (YEAR(X.PLN_WAZNYOD) = YEAR (PRE_Dataod) )&#xD;
	) ORDER BY PRE_PreId DESC)		LEFT JOIN #PracZat on PZPraId = PRE_PraID&#xD;
	LEFT JOIN CDN.PracKod on PRA_PraId = PRE_PraId&#xD;
	LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko =  sta.DKM_DkmId AND  sta.DKM_Rodzaj = 1&#xD;
	LEFT JOIN (&#xD;
		SELECT AVG(Rezerwa) Rezerwa, WPL_PraId from	&#xD;
		(	&#xD;
		SELECT SUM(WPE_Wartosc) [Rezerwa], WPL_PraId, WPL_DataDok FROM CDN.Wyplaty&#xD;
	LEFT JOIN CDN.WypElementy ON WPL_WplId = WPE_WplId &#xD;
	JOIN CDN.TypWyplata ON WPE_TwpId = TWP_TwpId AND TWP_AlgPotracenie = 0 AND TWP_WchodziDoWyplaty = 1	and TWP_WliczEkwiwal IN (1,3)&#xD;
	WHERE WPL_DataDok &gt; DATEADD(m, -3, convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)) and WPL_DataDok &lt;= convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120) GROUP BY WPL_PraId, WPL_DataDok	&#xD;
	) x group by WPL_PraId	&#xD;
	)R ON R.WPL_PraId = X.PLN_PraId&#xD;
	LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
	LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
	LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = PRE_ZakId&#xD;
	LEFT JOIN cdn.DaneKadMod rob on PRE_ETADkmIdStanowisko = rob.DKM_DkmId&#xD;
	LEFT JOIN cdn.Dzialy DZPR ON PRE_DzlId = DZPR.DZL_DzlId &#xD;
	LEFT JOIN (SELECT COUNT(*) IloscLimitow,PLN_PraId Prac FROM CDN.PracLimit JOIN CDN.PracKod on PLN_PraId = PRA_PraId WHERE PLN_LNBId in (1,3,6) and (PLN_OkresOd BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) AND  convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)  OR PLN_OkresDo BETWEEN  convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) AND  convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)) GROUP BY PLN_PraId)illim ON Prac = PRE_PraID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON PRE_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON PRE_OpeModID = mod.Ope_OpeId&#xD;
	LEFT JOIN #WykorzystaneDoDnia ON LIM_plnid = X.pln_plnid AND  Lim_praId = X.PLN_PraId AND X.PLN_LNBId = LIM_lnbid&#xD;
	LEFT JOIN #tmpmies mies on X.PLN_PlnID = mies.PLNID&#xD;
	WHERE  ((X.PLN_OkresOd BETWEEN convert(datetime, ''' + convert(varchar, @DATAOD, 120) + ''', 120) AND  convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120))  OR (X.PLN_OkresDo BETWEEN  convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) AND  convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)))&#xD;
	OR (( convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) BETWEEN X.PLN_OkresOd AND X.PLN_OkresDo) OR ( convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120) BETWEEN X.PLN_OkresOd AND X.PLN_OkresDo))&#xD;
&#xD;
		UNION ALL&#xD;
		&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], ''Nie dotyczy'' [Kalendarz],&#xD;
case Isnull(PRA_Archiwalny,0)&#xD;
 when 0 then ''NIE''&#xD;
 else ''TAK''&#xD;
 end [Pracownik Archiwalny],&#xD;
PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
PRE_Kod [Pracownik Kod], &#xD;
ISNULL(sta.DKM_Nazwa,''(NIEPRZYPISANE)'') [Pracownik Stanowisko],&#xD;
	isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
	isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
''Nie dotyczy'' [Data Godzina Od], ''Nie dotyczy'' [Data Godzina Do], GETDATE() [Data Analizy], ''Nie dotyczy'' [Strefa],''Nie dotyczy'' [Strefa Nazwa],''Nie dotyczy'' [Wydział], ''Nie dotyczy'' [Projekt],&#xD;
--CASE WHEN (PPL_TypDnia = 1 OR (PPL_PplId IS NULL AND KAD_TypDnia = 1)) AND (ISNULL(PNB_Calodzienna,0) = 0) THEN ''TAK'' ELSE ''NIE'' END [Obecność],&#xD;
''Nie dotyczy'' [Typ Dnia], NULL [Wymiar Pracy w Godzinach], NULL [Wymiar Pracy w Minutach], NULL [Wymiar Pracy], NULL [Wymiar Pracy w Dniach],&#xD;
NULL [Czas Pracy w Godzinach], NULL [Czas Pracy w Minutach], NULL [Czas Pracy], NULL [Czas Pracy w Dniach],&#xD;
''Nie dotyczy'' [Nieobecność Typ], ''Nie dotyczy'' [Nieobecność Usprawiedliwiona], ''Nie dotyczy'' [Nieobecność Przyczyna], ''Nie dotyczy'' [Nieobecność Status],&#xD;
''Nie dotyczy'' [Nieobecność Na Żądanie], NULL [Nieobecności w Godzinach], NULL [Nieobecności w Dniach Kalendarzowych], NULL [Nieobecności w Dniach Pracy],&#xD;
LNB_Nazwa [Limit Nieobecności Typ], &#xD;
REPLACE(CONVERT(VARCHAR(10), PP.PLN_OkresOd, 111), ''/'', ''-'') [Limit Nieobecności Od], REPLACE(CONVERT(VARCHAR(10), PP.PLN_OkresDo, 111), ''/'', ''-'') [Limit Nieobecności Do],&#xD;
''Nie dotyczy'' [Nieobecność Od], ''Nie dotyczy'' [Nieobecność Do],&#xD;
&#xD;
CASE WHEN PLN_PierwszaPraca = 1 THEN  PP.PLN_NalezneLacznieF else null end as [Limit Nieobecności Należny Dni],&#xD;
CASE WHEN PLN_PierwszaPraca = 1 THEN  DATEDIFF(hour,convert(datetime,''18991230'',112),PP.PLN_NalezneLacznieCzas) else null end as [Limit Nieobecności Należny Godziny],&#xD;
&#xD;
NULL [Limit Nieobecności Wykorzystany Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Godziny],&#xD;
&#xD;
CASE WHEN PLN_PierwszaPraca = 1 THEN PP.PLN_NalezneLacznieF else null end - ISNULL(ISNULL(DNILIM,0),0) - CASE WHEN GodzLIM IS NULL THEN 0 ELSE (GodzLIM/8)/(cast(ISNULL(NULLIF(PRE_ETAEtatL,0),1) as decimal)/cast(ISNULL(NULLIF(PRE_ETAEtatM,0),1) as decimal)) END - PP.PLN_EkwiwalentF as [Limit Nieobecności Pozostały Dni],&#xD;
CASE WHEN PLN_PierwszaPraca = 1 THEN DATEDIFF(hour,convert(datetime,''18991230'',112),PP.PLN_NalezneLacznieCzas) else null end - ISNULL(Godzlim,0) -  DATEDIFF(hour, convert(datetime,''1899-12-30 00:00:00.000'',120),PP.PLN_EkwiwalentCzas) as [Limit Nieobecności Pozostały Godziny],&#xD;
CASE WHEN PLN_PierwszaPraca = 1 THEN PP.PLN_PrzeniesienieF else null end as [Limit Nieobecności Zaległy Dni],&#xD;
CASE WHEN PLN_PierwszaPraca = 1 THEN DATEDIFF(hour,convert(datetime,''18991230'',112),PP.PLN_PrzeniesienieCzas) else null end as [Limit Nieobecności Zaległy Godziny],&#xD;
NULL [Wypłata Wartość Netto], NULL [Suma Elementów Wypłaty], NULL [Wypłata Wynagrodzenie Zasadnicze], &#xD;
CASE WHEN PLN_PierwszaPraca = 1 THEN PP.PLN_PlanowanyF  else null end as [Urlop Planowany Dni],&#xD;
&#xD;
CASE &#xD;
WHEN  PP.PLN_LNBId NOT IN (1,3,6)  THEN NULL&#xD;
WHEN  PP.PLN_PierwszaPraca = 1 THEN PP.PLN_NalezneLacznieF&#xD;
else  NULL end AS [Urlop Wypoczynkowy Należny Dni],&#xD;
CASE &#xD;
WHEN  PP.PLN_LNBId NOT IN (1,3,6)  THEN NULL&#xD;
WHEN  PP.PLN_PierwszaPraca = 1 THEN PP.PLN_NalezneLacznieF&#xD;
else  NULL end&#xD;
-&#xD;
CASE WHEN lim_lnbid not in (1,3,6) then 0 ELSE ISNULL(DNILIM,0) END &#xD;
- CASE  WHEN lim_lnbid not in (1,3,6) then 0 &#xD;
WHEN GodzLIM IS NULL THEN 0 &#xD;
ELSE (GodzLIM/8)/ISNULL(NULLIF((cast(PRE_ETAEtatL as decimal)/cast(ISNULL(NULLIF(PRE_ETAEtatM,0),1) as decimal)),0),1) END -PP.PLN_EkwiwalentF&#xD;
AS [Urlop Wypoczynkowy Pozostało Dni],&#xD;
&#xD;
CASE &#xD;
WHEN  PP.PLN_LNBId  NOT IN (1,3,6) THEN 0&#xD;
WHEN PP.PLN_PierwszaPraca = 0 then null&#xD;
When Rezerwa = 0 THEN 0&#xD;
WHEN PRE_ETAEtatL=3 AND PRE_ETAEtatM=4 THEN ((PLN_NalezneLacznieF-ISNULL(DNILIM,0)- PLN_EkwiwalentF)*IlMies)/'+ @wspol +'/0.75 * nullif(Rezerwa,0)&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=2 THEN ((PLN_NalezneLacznieF-ISNULL(DNILIM,0)- PLN_EkwiwalentF)*IlMies)/'+ @wspol +'/0.5 * nullif(Rezerwa,0)&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=3 THEN ((PLN_NalezneLacznieF-ISNULL(DNILIM,0)- PLN_EkwiwalentF)*IlMies)/'+ @wspol +'/0.33 * nullif(Rezerwa,0)&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=4 THEN((PLN_NalezneLacznieF-ISNULL(DNILIM,0)- PLN_EkwiwalentF)*IlMies)/'+ @wspol +'/0.25 * nullif(Rezerwa,0)&#xD;
ELSE ((PLN_NalezneLacznieF-ISNULL(DNILIM,0)- PLN_EkwiwalentF)*IlMies) /'+ @wspol +' * nullif(Rezerwa,0) END [Przybliżona Rezerwa Urlopowa],&#xD;
&#xD;
PLN_NalezneLacznieF  [Obowiązujący Limit Nieobecności Należny Dni ],&#xD;
DATEDIFF(hour,convert(datetime,''18991230'',112),PP.PLN_NalezneLacznieCzas) [Obowiązujący Limit Nieobecności Należny Godziny ],&#xD;
DniLim [Obowiązujący Limit Nieobecności Wykorzystany Dni ],&#xD;
GodzLIM [Obowiązujący Limit Nieobecności Wykorzystany Godziny ], &#xD;
PP.PLN_NalezneLacznieF - isnull(ISNULL(DNILIM,0),0)  - CASE WHEN GodzLIM IS NULL THEN 0 ELSE (GodzLIM/8)/(cast(ISNULL(NULLIF(PRE_ETAEtatL,0),1) as decimal)/cast(ISNULL(NULLIF(PRE_ETAEtatm,0),1) as decimal)) END - PP.PLN_EkwiwalentF [Obowiązujący Limit Nieobecności Pozostały Dni ],&#xD;
DATEDIFF(hour,convert(datetime,''18991230'',112),PP.PLN_NalezneLacznieCzas )  - ISNULL(GodzLIM,0) - case when ISNULL(DNILIM,0) IS NULL THEN 0 ELSE (ISNULL(DNILIM,0) * 8 / cast(ISNULL(NULLIF(PRE_ETAEtatL,0),1) as decimal)/cast(ISNULL(NULLIF(PRE_ETAEtatM,0),1) as decimal)) END - DATEDIFF(hour, convert(datetime,''1899-12-30 00:00:00.000'',120),PP.PLN_EkwiwalentCzas) [Obowiązujący Limit Nieobecności Pozostały Godziny ],&#xD;
PP.PLN_PrzeniesienieF  [Obowiązujący Limit Nieobecności Zaległy Dni ],&#xD;
DATEDIFF(hour,convert(datetime,''18991230'',112),PP.PLN_PrzeniesienieCzas) [Obowiązujący Limit Nieobecności Zaległy Godziny ],&#xD;
PP.PLN_PlanowanyF [Obowiązujący Urlop Planowany Dni ],&#xD;
CASE &#xD;
WHEN  PP.PLN_LNBId NOT IN (1,3,6)  THEN NULL&#xD;
else  PP.PLN_NalezneLacznieF end  -PP.PLN_EkwiwalentF AS [Obowiązujący  Urlop Wypoczynkowy Należny Dni ],&#xD;
CASE &#xD;
WHEN  PP.PLN_LNBId NOT IN (1,3,6)  THEN NULL&#xD;
else PP.PLN_NalezneLacznieF end - &#xD;
CASE WHEN LIM_LNBID NOT IN (1,3,6) or LIM_LNBID IS NULL THEN 0 ELSE &#xD;
ISNULL(DNILIM,0) + (case when GodzLim is null then 0 else (GodzLIM/8)/(cast(ISNULL(NULLIF(PRE_ETAEtatL,0),1) as decimal)/cast(ISNULL(NULLIF(PRE_ETAEtatm,0),1) as decimal)) END) END&#xD;
AS [Obowiązujący Urlop Wypoczynkowy Pozostało Dni ],&#xD;
&#xD;
CASE &#xD;
WHEN  PP.PLN_LNBId  NOT IN (1,3,6) THEN 0&#xD;
When Rezerwa = 0 THEN 0&#xD;
WHEN PRE_ETAEtatL=3 AND PRE_ETAEtatM=4 THEN ((PLN_NalezneLacznieF-ISNULL(DNILIM,0)- PLN_EkwiwalentF)*IlMies)/'+ @wspol +'/0.75 * nullif(Rezerwa,0)&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=2 THEN ((PLN_NalezneLacznieF-ISNULL(DNILIM,0)- PLN_EkwiwalentF)*IlMies)/'+ @wspol +'/0.5 * nullif(Rezerwa,0)&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=3 THEN ((PLN_NalezneLacznieF-ISNULL(DNILIM,0)- PLN_EkwiwalentF)*IlMies)/'+ @wspol +'/0.33 * nullif(Rezerwa,0)&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=4 THEN ((PLN_NalezneLacznieF-ISNULL(DNILIM,0)- PLN_EkwiwalentF)*IlMies)/'+ @wspol +'/0.25 * nullif(Rezerwa,0)&#xD;
ELSE ((PLN_NalezneLacznieF-ISNULL(DNILIM,0)- PLN_EkwiwalentF)*IlMies) /'+ @wspol +' * nullif(Rezerwa,0) END [Obowiązujący Przybliżona Rezerwa Urlopowa ],&#xD;
PLN_NalezneLacznieF [Limit Nieobecności Należny Cały Okres Dni],&#xD;
PLN_WykorzystaneF [Limit Nieobecności Wykorzystany Cały Okres Dni],&#xD;
PLN_PozostaloF [Limit Nieobecności Pozostały Cały Okres Dni],&#xD;
CASE &#xD;
WHEN  PP.PLN_LNBId  NOT IN (1,3,6) THEN 0 ELSE PLN_NalezneLacznieF END[Limit Nieobecności Urlop Wypoczynkowy Należny Cały Okres Dni],&#xD;
CASE &#xD;
WHEN  PP.PLN_LNBId  NOT IN (1,3,6) THEN 0 ELSE PLN_WykorzystaneF END[Limit Nieobecności Urlop Wypoczynkowy Wykorzystany Cały Okres Dni],&#xD;
CASE &#xD;
WHEN  PP.PLN_LNBId  NOT IN (1,3,6) THEN 0 ELSE PLN_PozostaloF END[Limit Nieobecności Urlop Wypoczynkowy Pozostały Cały Okres Dni],&#xD;
PRE_Kod [Liczba Pracowników]&#xD;
,DZPR.DZL_Kod AS [Pracownik Wydział]&#xD;
,CASE rob.DKM_Robotnicze WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Stanowisko Robotnicze]&#xD;
		,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZat, 111), ''/'', ''-''),''(BRAK)'') END [Data Zatrudnienia Dzień]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZat) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZat)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Tydzień Roku] &#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZat) AS VARCHAR(10)),''(BRAK)'') END AS [Data Zatrudnienia Kwartał]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Rok] &#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZwol, 111), ''/'', ''-''),''(BRAK)'') END [Data Zwolnienia Dzień]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZwol) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZwol)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Tydzień Roku]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Kwartał]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Rok]&#xD;
	 ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE CASE WHEN PZZwol &gt; GetDate() THEN CASE WHEN datediff(yy,PZZat,GetDate()) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,GetDate()) AS VARCHAR(10)),''(BRAK)'') END ELSE CASE WHEN datediff(yy,PZZat,PZZwol) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,PZZwol) AS VARCHAR(10)),''(BRAK)'') END END END [Pracownik Lata Pracy]&#xD;
	  ,ISNULL(CAST (datediff(yy,PRE_DataUr,PP.PLN_OkresOd) AS VARCHAR(10)),''(BRAK)'') [Pracownik Wiek]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), PLN_WaznyOd, 111), ''/'', ''-'') [Data]&#xD;
*/&#xD;
&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), PLN_WaznyOd, 111), ''/'', ''-'') [Data Dzień], MONTH(PLN_WaznyOd) [Data Miesiąc], YEAR(PLN_WaznyOd) [Data Rok]&#xD;
,CASE when MONTH( PLN_WaznyOd) &lt;7 THEN ''I'' else ''II'' END AS [Data Półrocze]&#xD;
,DATEPART(quarter,  PLN_WaznyOd) AS [Data Kwartał] &#xD;
&#xD;
----------KONTEKSTY&#xD;
,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__]&#xD;
,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
&#xD;
&#xD;
' + @kolumny + @atrybuty + '&#xD;
FROM #AktualneLimity PP&#xD;
JOIN CDN.LimitNieobec ON PLN_LnbID = LNB_LNBID&#xD;
	JOIN CDN.PracEtaty ON PRE_PreId = (SELECT TOP 1 PRE_PreId FROM CDN.PracEtaty WHERE PRE_PraId = PP.PLN_PraId AND &#xD;
	((((PRE_DataOd Between PP.PLN_WaznyOd AND PP.PLN_OkresDo) AND (PRE_DataDo Between PP.PLN_WaznyOd AND PP.PLN_OkresDo ))&#xD;
	OR ((PP.PLN_WaznyOd BETWEEN PRE_DataOd AND PRE_DataDo)AND(PP.PLN_OkresDo BETWEEN PRE_DataOd AND PRE_DataDo)))&#xD;
	OR (YEAR(PP.PLN_OkresDo) = YEAR (PRE_DataDo) )&#xD;
	OR (YEAR(PP.PLN_WAZNYOD) = YEAR (PRE_Dataod) )&#xD;
	) ORDER BY PRE_PreId DESC)		&#xD;
	&#xD;
	LEFT JOIN #PracZat on PZPraId = PRE_PraID&#xD;
	LEFT JOIN CDN.PracKod on PRA_PraId = PRE_PraId&#xD;
	LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko =  sta.DKM_DkmId AND  sta.DKM_Rodzaj = 1&#xD;
	LEFT JOIN (&#xD;
		SELECT AVG(Rezerwa) Rezerwa, WPL_PraId from	&#xD;
		(	&#xD;
		SELECT SUM(WPE_Wartosc) [Rezerwa], WPL_PraId, WPL_DataDok FROM CDN.Wyplaty&#xD;
	LEFT JOIN CDN.WypElementy ON WPL_WplId = WPE_WplId &#xD;
	JOIN CDN.TypWyplata ON WPE_TwpId = TWP_TwpId AND TWP_AlgPotracenie = 0 AND TWP_WchodziDoWyplaty = 1	and TWP_WliczEkwiwal IN (1,3)&#xD;
	WHERE WPL_DataDok &gt; DATEADD(m, -3, convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)) and WPL_DataDok &lt;= convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120) GROUP BY WPL_PraId, WPL_DataDok	&#xD;
	) x group by WPL_PraId	&#xD;
	)R ON R.WPL_PraId = PP.PLN_PraId &#xD;
	LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
	LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
	LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = PRE_ZakId&#xD;
	LEFT JOIN cdn.DaneKadMod rob on PRE_ETADkmIdStanowisko = rob.DKM_DkmId&#xD;
	LEFT JOIN cdn.Dzialy DZPR ON PRE_DzlId = DZPR.DZL_DzlId &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	LEFT JOIN ' + @Operatorzy + ' zal ON PRE_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON PRE_OpeModID = mod.Ope_OpeId&#xD;
	LEFT JOIN #WykorzystaneDoDnia ON LIM_plnid = pln_plnid AND  Lim_praId = PLN_PraId AND PLN_LNBId = LIM_lnbid&#xD;
	LEFT JOIN #tmpmies mies on PP.PLN_PlnID = mies.PLNID&#xD;
   WHERE  (PLN_OkresOd BETWEEN  convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) AND  convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120))  OR (PLN_OkresDo BETWEEN  convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120))&#xD;
   	OR (( convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) BETWEEN PLN_OkresOd AND PLN_OkresDo) OR ( convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120) BETWEEN PLN_OkresOd AND PLN_OkresDo))&#xD;
&#xD;
UNION ALL&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], ''Nie dotyczy'' [Kalendarz],&#xD;
case Isnull(PRA_Archiwalny,0)&#xD;
 when 0 then ''NIE''&#xD;
 else ''TAK''&#xD;
 end [Pracownik Archiwalny],&#xD;
PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
PRE_Kod [Pracownik Kod], &#xD;
ISNULL(sta.DKM_Nazwa,''(NIEPRZYPISANE)'') [Pracownik Stanowisko],&#xD;
	isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
	isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
''Nie dotyczy'' [Data Godzina Od], ''Nie dotyczy'' [Data Godzina Do], GETDATE() [Data Analizy], ''Nie dotyczy'' [Strefa],''Nie dotyczy'' [Strefa Nazwa],''Nie dotyczy'' [Wydział], ''Nie dotyczy'' [Projekt],&#xD;
--CASE WHEN (PPL_TypDnia = 1 OR (PPL_PplId IS NULL AND KAD_TypDnia = 1)) AND (ISNULL(PNB_Calodzienna,0) = 0) THEN ''TAK'' ELSE ''NIE'' END [Obecność],&#xD;
''Nie dotyczy'' [Typ Dnia], NULL [Wymiar Pracy w Godzinach], NULL [Wymiar Pracy w Minutach], NULL [Wymiar Pracy], NULL [Wymiar Pracy w Dniach],&#xD;
NULL [Czas Pracy w Godzinach], NULL [Czas Pracy w Minutach], NULL [Czas Pracy], NULL [Czas Pracy w Dniach],&#xD;
''Nie dotyczy'' [Nieobecność Typ], ''Nie dotyczy'' [Nieobecność Usprawiedliwiona], ''Nie dotyczy'' [Nieobecność Przyczyna], ''Nie dotyczy'' [Nieobecność Status],&#xD;
''Nie dotyczy'' [Nieobecność Na Żądanie], NULL [Nieobecności w Godzinach], NULL [Nieobecności w Dniach Kalendarzowych], NULL [Nieobecności w Dniach Pracy],&#xD;
LNB_Nazwa [Limit Nieobecności Typ], &#xD;
REPLACE(CONVERT(VARCHAR(10), isnull(X.PLN_OkresOd,OkresOd), 111), ''/'', ''-'') [Limit Nieobecności Od], REPLACE(CONVERT(VARCHAR(10), ISNULL(X.PLN_OkresDo,OkresDo), 111), ''/'', ''-'') [Limit Nieobecności Do],&#xD;
''Nie dotyczy'' [Nieobecność Od], ''Nie dotyczy'' [Nieobecność Do],&#xD;
&#xD;
NULL [Limit Nieobecności Należny Dni],&#xD;
NULL [Limit Nieobecności Należny Godziny],&#xD;
&#xD;
CASE WHEN Dni IS NULL THEN 0 &#xD;
WHEN Godziny &lt;&gt; 0 THEN 1.0/(8.0/isnull(NULLIF(Godziny,0),1))&#xD;
ELSE CAST(sumGodz/8.0 AS DECIMAL(18,4)) END AS [Limit Nieobecności Wykorzystany Dni],&#xD;
CASE WHEN Godziny IS NOT NULL AND Godziny &lt;&gt; 0 &#xD;
THEN Godziny&#xD;
ELSE CAST(sumGodz AS DECIMAL(18,4)) END AS [Limit Nieobecności Wykorzystany Godziny],&#xD;
&#xD;
CASE WHEN Dni IS NULL THEN 0 &#xD;
WHEN Godziny &lt;&gt; 0 THEN -1.0/(8.0/isnull(NULLIF(Godziny,0),1))&#xD;
ELSE -CAST(sumGodz/8.0 AS DECIMAL(18,4)) END AS  [Limit Nieobecności Pozostały Dni],&#xD;
CASE WHEN Godziny IS NOT NULL AND Godziny &lt;&gt; 0 &#xD;
THEN -Godziny&#xD;
ELSE -CAST(sumGodz AS DECIMAL(18,4)) END AS [Limit Nieobecności Pozostały Godziny],&#xD;
NULL [Limit Nieobecności Zaległy Dni],&#xD;
NULL [Limit Nieobecności Zaległy Godziny],&#xD;
NULL [Wypłata Wartość Netto], NULL [Suma Elementów Wypłaty], NULL [Wypłata Wynagrodzenie Zasadnicze], &#xD;
NULL [Urlop Planowany Dni],&#xD;
NULL [Urlop Wypoczynkowy Należny Dni],&#xD;
CASE WHEN Dni IS NULL THEN 0 &#xD;
WHEN  ISNULL(Y.PLN_LNBId, X.PLN_LNBId)  NOT IN (1,3,6) OR ISNULL(Y.PLN_LNBId, X.PLN_LNBId) IS NULL THEN null&#xD;
WHEN Godziny &lt;&gt; 0 THEN -1.0/(8.0/isnull(NULLIF(Godziny,0),1))&#xD;
ELSE -CAST(sumGodz/8.0 AS DECIMAL(18,4)) END AS  [Urlop Wypoczynkowy Pozostało Dni],&#xD;
CASE &#xD;
WHEN  ISNULL(Y.PLN_LNBId, X.PLN_LNBId)  NOT IN (1,3,6) OR ISNULL(Y.PLN_LNBId, X.PLN_LNBId) IS NULL THEN 0&#xD;
WHEN Dni IS NULL THEN 0&#xD;
WHEN Rezerwa = 0 THEN 0&#xD;
WHEN ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF) = 0 THEN 0 &#xD;
WHEN Godziny &lt;&gt; 0 THEN - (((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +'* 1.0/(8.0/isnull(NULLIF(Godziny,0),1)) * Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0)) * IlMies&#xD;
WHEN PRE_ETAEtatL=3 AND PRE_ETAEtatM=4 THEN -(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +' *Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0))* IlMies&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=2 THEN -(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +' *Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0))* IlMies&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=3 THEN -(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +'* Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0))* IlMies&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=4 THEN -(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +' *Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0))* IlMies&#xD;
ELSE- (((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +' * Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0)) * IlMies  END AS[Przybliżona Rezerwa Urlopowa],&#xD;
NULL  [Limit Nieobecności Należny Dni ],&#xD;
NULL[Limit Nieobecności Należny Godziny ],&#xD;
CASE&#xD;
when akt.PLN_PLNID IS NULL THEN NULL &#xD;
WHEN Dni IS NULL THEN 0 &#xD;
WHEN Godziny &lt;&gt; 0 THEN 1.0/(8.0/isnull(NULLIF(Godziny,0),1))&#xD;
ELSE CAST(sumGodz/8.0 AS DECIMAL(18,4)) END AS [Obowiązujący Limit Nieobecności Wykorzystany Dni ],&#xD;
CASE when akt.PLN_PLNID IS NULL THEN NULL&#xD;
WHEN Godziny IS NOT NULL AND Godziny &lt;&gt; 0 &#xD;
THEN Godziny&#xD;
ELSE CAST(sumGodz AS DECIMAL(18,4)) END AS [Obowiązujący Limit Nieobecności Wykorzystany Godziny ], &#xD;
&#xD;
CASE when akt.PLN_PLNID IS NULL THEN NULL&#xD;
WHEN Dni IS NULL THEN 0 &#xD;
WHEN Godziny &lt;&gt; 0 THEN -1.0/(8.0/isnull(NULLIF(Godziny,0),1))&#xD;
ELSE -CAST(sumGodz/8.0 AS DECIMAL(18,4)) END  AS  [Obowiązujący Limit Nieobecności Pozostały Dni ],&#xD;
CASE when akt.PLN_PLNID IS NULL THEN NULL&#xD;
WHEN Godziny IS NOT NULL AND Godziny &lt;&gt; 0 &#xD;
THEN -Godziny&#xD;
ELSE -CAST(sumGodz AS DECIMAL(18,4)) END  AS [Obowiązujący Limit Nieobecności Pozostały Godziny ],&#xD;
NULL  [Obowiązujący Limit Nieobecności Zaległy Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Zaległy Godziny ],&#xD;
NULL [Obowiązujący Urlop Planowany Dni ],&#xD;
NULL [Obowiązujący Urlop Wypoczynkowy Należny Dni ],&#xD;
CASE WHEN  ISNULL(Y.PLN_LNBId, X.PLN_LNBId)  NOT IN (1,3,6) OR ISNULL(Y.PLN_LNBId, X.PLN_LNBId) IS NULL THEN NULL &#xD;
when akt.PLN_PLNID IS NULL THEN NULL&#xD;
WHEN Dni IS NULL THEN 0 &#xD;
WHEN Godziny &lt;&gt; 0 THEN -1.0/(8.0/isnull(NULLIF(Godziny,0),1))&#xD;
ELSE -CAST(sumGodz/8.0 AS DECIMAL(18,4)) END &#xD;
[Obowiązujący Urlop Wypoczynkowy Pozostało Dni ],&#xD;
CASE &#xD;
WHEN  akt.PLN_PLNID IS NULL THEN 0 &#xD;
WHEN ISNULL(Y.PLN_LNBId, X.PLN_LNBId)  NOT IN (1,3,6) OR ISNULL(Y.PLN_LNBId, X.PLN_LNBId) IS NULL THEN 0&#xD;
WHEN Dni IS NULL THEN 0&#xD;
WHEN Rezerwa = 0 THEN 0&#xD;
WHEN ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF) = 0 THEN 0 &#xD;
WHEN Godziny &lt;&gt; 0 THEN - (((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +'* 1.0/(8.0/isnull(NULLIF(Godziny,0),1)) * Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0)) * IlMies&#xD;
WHEN PRE_ETAEtatL=3 AND PRE_ETAEtatM=4 THEN -(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +' *Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0)) * IlMies&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=2 THEN -(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +' *Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0)) * IlMies&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=3 THEN -(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +' *Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0)) * IlMies&#xD;
WHEN PRE_ETAEtatL=1 AND PRE_ETAEtatM=4 THEN -(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +' *Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0)) * IlMies&#xD;
ELSE- (((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF))/'+ @wspol +' * Rezerwa/NULLIF(((ISNULL(Y.PLN_NalezneLacznieF,X.PLN_NalezneLacznieF)-ISNULL(DNILIM,0)- X.PLN_EkwiwalentF)),0)) * IlMies  END AS   [Obowiązujący Przybliżona Rezerwa Urlopowa ],&#xD;
NULL [Limit Nieobecności Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Pozostały Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Pozostały Cały Okres Dni],&#xD;
PRE_Kod [Liczba Pracowników]&#xD;
,DZPR.DZL_Kod AS [Pracownik Wydział]&#xD;
,CASE rob.DKM_Robotnicze WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Stanowisko Robotnicze]&#xD;
		,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZat, 111), ''/'', ''-''),''(BRAK)'') END [Data Zatrudnienia Dzień]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZat) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZat)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Tydzień Roku] &#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZat) AS VARCHAR(10)),''(BRAK)'') END AS [Data Zatrudnienia Kwartał]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Rok] &#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZwol, 111), ''/'', ''-''),''(BRAK)'') END [Data Zwolnienia Dzień]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZwol) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZwol)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Tydzień Roku]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Kwartał]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Rok]&#xD;
	 ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE CASE WHEN PZZwol &gt; GetDate() THEN CASE WHEN datediff(yy,PZZat,GetDate()) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,GetDate()) AS VARCHAR(10)),''(BRAK)'') END ELSE CASE WHEN datediff(yy,PZZat,PZZwol) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,PZZwol) AS VARCHAR(10)),''(BRAK)'') END END END [Pracownik Lata Pracy]&#xD;
	  ,ISNULL(CAST (datediff(yy,PRE_DataUr,Date) AS VARCHAR(10)),''(BRAK)'') [Pracownik Wiek]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), Date, 111), ''/'', ''-'') [Data]&#xD;
&#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), Date, 111), ''/'', ''-'') [Data Dzień], MONTH(Date) [Data Miesiąc], YEAR(Date) [Data Rok]&#xD;
,CASE when MONTH(Date) &lt;7 THEN ''I'' else ''II'' END AS [Data Półrocze]&#xD;
,DATEPART(quarter, Date) AS [Data Kwartał] &#xD;
&#xD;
----------KONTEKSTY&#xD;
,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__]&#xD;
,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + '&#xD;
FROM&#xD;
(SELECT  PNB_PraId,TNB_lnbId,COUNT(*) AS dni, SUM(Godziny) AS Godziny, Date,&#xD;
CASE WHEN ISNULL(PGL_OdGodziny,KDG_OdGodziny) &gt; ISNULL(PGL_DoGodziny,KDG_DoGodziny)&#xD;
THEN SUM(DATEDIFF(MINUTE,ISNULL(PGL_OdGodziny,KDG_OdGodziny),ISNULL(Dateadd(day,1,PGL_DoGodziny),Dateadd(day,1,KDG_DoGodziny))))&#xD;
ELSE SUM(DATEDIFF(MINUTE,ISNULL(PGL_OdGodziny,KDG_OdGodziny),ISNULL(PGL_DoGodziny,KDG_DoGodziny))) END  /60.0 AS sumGodz,&#xD;
CASE WHEN ISNULL(PGL_OdGodziny,KDG_OdGodziny) &gt; ISNULL(PGL_DoGodziny,KDG_DoGodziny)&#xD;
THEN SUM(DATEDIFF(MINUTE,ISNULL(PGL_OdGodziny,KDG_OdGodziny),ISNULL(Dateadd(day,1,PGL_DoGodziny),Dateadd(day,1,KDG_DoGodziny))))&#xD;
ELSE SUM(DATEDIFF(MINUTE,ISNULL(PGL_OdGodziny,KDG_OdGodziny),ISNULL(PGL_DoGodziny,KDG_DoGodziny))) END AS sumMin&#xD;
 FROM&#xD;
		(&#xD;
		 select DISTINCT&#xD;
				Date,&#xD;
				nieob.PNB_PraId,&#xD;
				typ.TNB_lnbId,&#xD;
				nieob.PNB_OkresOd AS OkresOd,&#xD;
				nieob.PNB_OkresDo AS OkresDo,&#xD;
				isnull(DATEDIFF(n,convert(datetime ,''1899-12-30 00:00:00.000'',120),nieob.PNB_Godz)/(60), 0) Godziny&#xD;
&#xD;
				&#xD;
			from&#xD;
				#WszystkieDaty  &#xD;
				join CDN.PracNieobec nieob ON [Date] between nieob.PNB_OkresOd and nieob.PNB_OkresDo &#xD;
				join CDN.TypNieobec typ ON nieob.Pnb_TnbId = typ.TNB_TnbId&#xD;
			where&#xD;
				(nieob.PNB_Tryb = 0 or nieob.PNB_Tryb = 2) &#xD;
		&#xD;
		)Lmt &#xD;
		LEFT JOIN CDN.PracEtaty ON PRE_PraId = PNB_PraId  AND Date Between  PRE_DataOd AND  PRE_DataDo&#xD;
		LEFT JOIN CDN.PracPlanDni ON PPL_PraId = PNB_PraId AND PPL_Data = Date&#xD;
		LEFT JOIN CDN.PracPlanDniGodz on PPL_PplId = PGL_PplId&#xD;
		LEFT JOIN CDN.KalendDni ON Date = KAD_Data AND PRE_KalId = KAD_KalId&#xD;
		LEFT JOIN CDN.KalendDniGodz ON  KAD_KadId = KDG_KadId&#xD;
		WHERE ISNULL(PPL_TypDnia,KAD_TypDnia) = 1 OR (ISNULL(PPL_TypDnia,KAD_TypDnia) is null and (DATEPART(dw,Date) NOT IN (1,7) ) AND DATE NOT IN (select dzien from #Swieta))&#xD;
		GROUP BY PNB_PraId,TNB_lnbId,Date,PGL_OdGodziny,KDG_OdGodziny,PGL_DoGodziny,KDG_DoGodziny)LmtSum &#xD;
		LEFT JOIN CDN.LimitNieobec ON LmtSum.TNB_lnbId =lnb_lnbid &#xD;
		LEFT JOIN CDN.PracLimit X ON X.PLN_LnbId = LNB_LnbId AND (X.PLN_OkresOd &lt;= date AND X.PLN_OkresDo &gt;= date) AND X.PLN_PraId = PNB_PraId AND (X.PLN_PierwszaPraca = 0 or date between X.PLN_WaznyOd  AND X.PLN_OkresDo  )&#xD;
		LEFT JOIN CDN.PracEtaty ON LmtSum.PNB_PraId = PRE_PraID AND PRE_PreId = (SELECT TOP 1 PRE_PreId FROM CDN.PracEtaty WHERE PRE_PraId = LmtSum.PNB_PraId AND  Date Between  PRE_DataOd AND  PRE_DataDo ORDER BY PRE_PreId DESC)&#xD;
		LEFT JOIN CDN.PracLimit Y ON X.PLN_PlnId = Y.PLN_ParentId AND (Y.PLN_OkresOd &lt;= date AND Y.PLN_OkresDo &gt;= date) AND Y.PLN_PraId = PNB_PraId&#xD;
		LEFT JOIN #PracZat on PZPraId = PRE_PraID&#xD;
		LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko =  sta.DKM_DkmId AND  sta.DKM_Rodzaj = 1&#xD;
		LEFT JOIN cdn.DaneKadMod rob on PRE_ETADkmIdStanowisko = rob.DKM_DkmId&#xD;
		LEFT JOIN cdn.Dzialy DZPR ON PRE_DzlId = DZPR.DZL_DzlId &#xD;
		LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
		LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
		LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = PRE_ZakId&#xD;
		LEFT JOIN CDN.PracKod on PRA_PraId = PRE_PraId&#xD;
		LEFT JOIN (&#xD;
		SELECT AVG(Rezerwa) Rezerwa, WPL_PraId from	&#xD;
		(	&#xD;
		SELECT SUM(WPE_Wartosc) [Rezerwa], WPL_PraId, WPL_DataDok FROM CDN.Wyplaty&#xD;
	LEFT JOIN CDN.WypElementy ON WPL_WplId = WPE_WplId &#xD;
	JOIN CDN.TypWyplata ON WPE_TwpId = TWP_TwpId AND TWP_AlgPotracenie = 0 AND TWP_WchodziDoWyplaty = 1	and TWP_WliczEkwiwal IN (1,3)&#xD;
	WHERE WPL_DataDok &gt; DATEADD(m, -3, convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)) and WPL_DataDok &lt;= convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120) GROUP BY WPL_PraId, WPL_DataDok	&#xD;
	) x group by WPL_PraId	&#xD;
	)R ON R.WPL_PraId = PRE_PraId&#xD;
	LEFT JOIN (SELECT COUNT(*) IloscLimitow,PLN_PraId Prac FROM CDN.PracLimit JOIN CDN.PracKod on PLN_PraId = PRA_PraId WHERE PLN_LNBId in (1,3,6) and (PLN_OkresOd BETWEEN  convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) AND  convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)  OR PLN_OkresDo BETWEEN  convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)) AND PLN_PierwszaPraca = 0 GROUP BY PLN_PraId)illim ON Prac = PRE_PraID&#xD;
	LEFT JOIN (select MIN(PLN_OkresOd) OkresOd ,MAX(PLN_OkresDo) OkresDo ,PLN_PraId PPraid ,PLN_LnbId PLnbId from cdn.PracLimit WHERE PLN_PierwszaPraca = 1 AND (PLN_OkresOd BETWEEN  convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) AND  convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)  OR PLN_OkresDo BETWEEN  convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120))  GROUP BY PLN_PraId,PLN_LnbId) Pprac ON lnb_lnbid = PLnbId and PRE_PraID = PPraid&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON PRE_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON PRE_OpeModID = mod.Ope_OpeId&#xD;
	LEFT JOIN #AktualneLimity AKT on X.PLN_Plnid = AKT.PLN_plnid&#xD;
	LEFT JOIN #WykorzystaneDoDnia ON LIM_plnid = X.pln_plnid AND  Lim_praId = X.PLN_PraId AND X.PLN_LNBId = LIM_lnbid&#xD;
    LEFT JOIN #tmpmies mies on X.PLN_PlnID = mies.PLNID&#xD;
	LEFT JOIN #RzeczywisteObowiazywanieLimitow on X.PLN_PlnId = RzPLN&#xD;
	WHERE   &#xD;
		LmtSum.TNB_lnbId IS NOT NULL  And Date Between ValidFrom AND ValidTo &#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], ''Nie dotyczy'' [Kalendarz], &#xD;
case Isnull(PRA_Archiwalny,0)&#xD;
 when 0 then ''NIE''&#xD;
 else ''TAK''&#xD;
 end [Pracownik Archiwalny],&#xD;
PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
PRE_Kod [Pracownik Kod], &#xD;
ISNULL(sta.DKM_Nazwa,''(NIEPRZYPISANE)'') [Pracownik Stanowisko],&#xD;
	isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
	isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
''Nie dotyczy'' [Data Godzina Od], ''Nie dotyczy'' [Data Godzina Do], GETDATE() [Data Analizy], ''Nie dotyczy'' [Strefa],''Nie dotyczy'' [Strefa Nazwa], DZL.DZL_Kod [Wydział], ''Nie dotyczy'' [Projekt],&#xD;
--CASE WHEN (PPL_TypDnia = 1 OR (PPL_PplId IS NULL AND KAD_TypDnia = 1)) AND (ISNULL(PNB_Calodzienna,0) = 0) THEN ''TAK'' ELSE ''NIE'' END [Obecność],&#xD;
''Nie dotyczy'' [Typ Dnia], NULL [Wymiar Pracy w Godzinach], NULL [Wymiar Pracy w Minutach], NULL [Wymiar Pracy], NULL [Wymiar Pracy w Dniach],&#xD;
NULL [Czas Pracy w Godzinach], NULL [Czas Pracy w Minutach], NULL [Czas Pracy], NULL [Czas Pracy w Dniach],&#xD;
''Nie dotyczy'' [Nieobecność Typ], ''Nie dotyczy'' [Nieobecność Usprawiedliwiona], ''Nie dotyczy'' [Nieobecność Przyczyna], ''Nie dotyczy'' [Nieobecność Status],&#xD;
''Nie dotyczy'' [Nieobecność Na Żądanie], NULL [Nieobecności w Godzinach], NULL [Nieobecności w Dniach Kalendarzowych], NULL [Nieobecności w Dniach Pracy],&#xD;
''Nie dotyczy'' [Limit Nieobecności Typ], &#xD;
''Nie dotyczy'' [Limit Nieobecności Od], ''Nie dotyczy'' [Limit Nieobecności Do],&#xD;
''Nie dotyczy'' [Nieobecność Od], ''Nie dotyczy'' [Nieobecność Do],&#xD;
NULL [Limit Nieobecności Należny Dni],&#xD;
NULL [Limit Nieobecności Należny Godziny],&#xD;
NULL [Limit Nieobecności Wykorzystany Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Godziny],&#xD;
NULL [Limit Nieobecności Pozostały Dni],&#xD;
NULL [Limit Nieobecności Pozostały Godziny],&#xD;
NULL [Limit Nieobecności Zaległy Dni],&#xD;
NULL [Limit Nieobecności Zaległy Godziny],&#xD;
&#xD;
CASE WHEN TWP_WchodziDoWyplaty = 1 OR TWP_Rodzajzrodla = 35 THEN&#xD;
		CASE WHEN PRE_Oddelegowany = 0 THEN CASE WHEN TWP_Rodzajzrodla = 35 THEN 0 ELSE WPE_Wartosc END - WPE_SklEmerPrac-WPE_SklRentPrac-WPE_SklChorPrac-WPE_SklWypadPrac-WPE_ZalFis-WPE_SklZdrowPrac-WPE_SklZdrowSuma-WPE_SklPPKPrac1-WPE_SklPPKPrac2 ELSE&#xD;
			CASE WHEN TWP_RodzajZrodla = 1  THEN &#xD;
				CASE WHEN brutto - dieta &lt; podstawaOpodatkowania THEN&#xD;
					WPE_Wartosc - (podstawaOpodatkowania - podstawaOpodatkowania*0.1371)*0.09 - podstawaOpodatkowania*0.1371&#xD;
				ELSE&#xD;
					WPE_Wartosc - (brutto - dieta - (brutto - dieta)*0.1371)*0.09 - (brutto - dieta)*0.1371&#xD;
				END ELSE WPE_Wartosc &#xD;
			END&#xD;
		END ELSE 0&#xD;
	END [Wypłata Wartość Netto],&#xD;
	CASE WHEN TWP_WchodziDoWyplaty = 1 OR TWP_Rodzajzrodla = 35 THEN&#xD;
		CASE WHEN WPE_Wartosc &lt; 0&#xD;
			THEN 0 &#xD;
			ELSE WPE_Wartosc&#xD;
		END&#xD;
	ELSE 0 END [Suma Elementów Wypłaty],&#xD;
	CASE WHEN TWP_RodzajZrodla &lt;&gt; 1 or TWP_WchodziDoWyplaty = 0 THEN 0 ELSE WPE_Wartosc END [Wypłata Wynagrodzenie Zasadnicze],&#xD;
NULL [Urlop Planowany Dni],&#xD;
NULL [Urlop Wypoczynkowy Należny Dni],&#xD;
NULL [Urlop Wypoczynkowy Pozostało Dni],&#xD;
NULL [Przybliżona Rezerwa Urlopowa],&#xD;
NULL  [Obowiązujący Limit Nieobecności Należny Dni ],&#xD;
NULL[Obowiązujący Limit Nieobecności Należny Godziny ],&#xD;
NULL [Obowiązujący Limit Nieobecności Wykorzystany Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Wykorzystany Godziny ], &#xD;
NULL  [Obowiązujący Limit Nieobecności Pozostały Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Pozostały Godziny ],&#xD;
NULL  [Obowiązujący Limit Nieobecności Zaległy Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Zaległy Godziny ],&#xD;
NULL [Obowiązujący Urlop Planowany Dni ],&#xD;
NULL [Obowiązujący Urlop Wypoczynkowy Należny Dni ],&#xD;
NULL[Obowiązujący Urlop Wypoczynkowy Pozostało Dni ],&#xD;
NULL [Obowiązujący Przybliżona Rezerwa Urlopowa ],&#xD;
NULL [Limit Nieobecności Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Pozostały Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Pozostały Cały Okres Dni],&#xD;
PRE_Kod [Liczba Pracowników]&#xD;
,DZPR.DZL_Kod AS [Pracownik Wydział]&#xD;
,CASE rob.DKM_Robotnicze WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Stanowisko Robotnicze]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZat, 111), ''/'', ''-''),''(BRAK)'') END [Data Zatrudnienia Dzień]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZat) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZat)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Tydzień Roku] &#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZat) AS VARCHAR(10)),''(BRAK)'') END AS [Data Zatrudnienia Kwartał]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Rok] &#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZwol, 111), ''/'', ''-''),''(BRAK)'') END [Data Zwolnienia Dzień]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZwol) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZwol)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Tydzień Roku]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Kwartał]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Rok]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE CASE WHEN PZZwol &gt; GetDate() THEN CASE WHEN datediff(yy,PZZat,GetDate()) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,GetDate()) AS VARCHAR(10)),''(BRAK)'') END ELSE CASE WHEN datediff(yy,PZZat,PZZwol) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,PZZwol) AS VARCHAR(10)),''(BRAK)'') END END END [Pracownik Lata Pracy]&#xD;
	  ,ISNULL(CAST (datediff(yy,PRE_DataUr,WPL_DataDok) AS VARCHAR(10)),''(BRAK)'') [Pracownik Wiek]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
,NULL [Data]&#xD;
*/&#xD;
&#xD;
----------DATY ANALIZY&#xD;
,''Nie dotyczy'' [Data Dzień], WPL_Miesiac [Data Miesiąc], WPL_Rok [Data Rok]&#xD;
, CASE WHEN WPL_Miesiac &lt; 7 THEN ''I'' else ''II'' END AS [Data Półrocze]&#xD;
,DATEPART(quarter, WPL_DataDok) AS [Data Kwartał] &#xD;
&#xD;
----------KONTEKSTY&#xD;
,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__]&#xD;
,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
&#xD;
&#xD;
' + @kolumny + @atrybuty + '&#xD;
FROM CDN.WypElementy&#xD;
JOIN #Wyplaty On WPE_WplId = wyplataID&#xD;
	JOIN CDN.Wyplaty ON WPE_WplId = WPL_WplId&#xD;
	JOIN CDN.TypWyplata ON WPE_TwpId = TWP_TwpId&#xD;
	JOIN CDN.PracEtaty ON WPL_PraId = PRE_PraId AND WPL_DataDok &gt;= PRE_DataOd AND WPL_DataDok &lt;= PRE_DataDo&#xD;
	LEFT JOIN #PracZat on PZPraId = PRE_PraID&#xD;
	LEFT JOIN CDN.PracKod on PRA_PraId = PRE_PraId&#xD;
	LEFT JOIN CDN.Dzialy DZL ON WPL_DzlId = DZL_DzlId&#xD;
	LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko =  sta.DKM_DkmId AND  sta.DKM_Rodzaj = 1&#xD;
	LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
	LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
	LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = PRE_ZakId&#xD;
	LEFT JOIN cdn.DaneKadMod rob on PRE_ETADkmIdStanowisko = rob.DKM_DkmId&#xD;
	LEFT JOIN cdn.Dzialy DZPR ON PRE_DzlId = DZPR.DZL_DzlId &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON PRE_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON PRE_OpeModID = mod.Ope_OpeId&#xD;
WHERE&#xD;
	WPL_DataOd &gt;= convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120) &#xD;
	AND WPL_DataDo &lt;= convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)&#xD;
&#xD;
		UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], KAL_Akronim [Kalendarz], &#xD;
case Isnull(PRA_Archiwalny,0)&#xD;
 when 0 then ''NIE''&#xD;
 else ''TAK''&#xD;
 end [Pracownik Archiwalny],&#xD;
PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
PRE_Kod [Pracownik Kod], &#xD;
ISNULL(sta.DKM_Nazwa,''(NIEPRZYPISANE)'') [Pracownik Stanowisko],&#xD;
	isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
	isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
&#xD;
CONVERT(VARCHAR(5), COALESCE(PGR_OdGodziny,PGL_OdGodziny,KDG_OdGodziny),108) [Data Godzina Od], CONVERT(VARCHAR(5), COALESCE(PGR_DoGodziny,PGL_DoGodziny,KDG_DoGodziny),108) [Data Godzina Do],&#xD;
GETDATE() [Data Analizy],&#xD;
CASE WHEN Data &gt; GETDATE() THEN NULL ELSE SPR.DST_Akronim END [Strefa], &#xD;
CASE WHEN Data &gt; GETDATE() THEN NULL ELSE CASE WHEN SPR.DST_Nazwa = '''' THEN ''(NIEPRZEPISANA)'' ELSE SPR.DST_Nazwa END END [Strefa Nazwa], &#xD;
CASE WHEN Data &gt; GETDATE() THEN NULL ELSE DPR.DZL_Kod END [Wydział], &#xD;
CASE WHEN Data &gt; GETDATE() THEN NULL ELSE PPR.PRJ_Kod END [Projekt],&#xD;
--CASE WHEN (PPL_TypDnia = 1 OR (PPL_PplId IS NULL AND KAD_TypDnia = 1)) AND (ISNULL(PNB_Calodzienna,0) = 0) THEN ''TAK'' ELSE ''NIE'' END [Obecność],&#xD;
CASE COALESCE(PPL_TypDnia,KAD_TypDnia)&#xD;
	WHEN 1 THEN ''Pracy''&#xD;
	WHEN 2 THEN ''Wolny''&#xD;
	WHEN 3 THEN ''Święto''&#xD;
END [Typ Dnia],&#xD;
NULL [Wymiar Pracy w Godzinach], NULL [Wymiar Pracy w Minutach],&#xD;
''Czas Pracy'' [Wymiar Pracy],&#xD;
 NULL [Wymiar Pracy w Dniach],&#xD;
NULL [Czas Pracy w Godzinach], &#xD;
NULL [Czas Pracy w Minutach],&#xD;
NULL [Czas Pracy],&#xD;
NULL [Czas Pracy w Dniach],&#xD;
ISNULL(TNB_Nazwa, ''Nie dotyczy'') [Nieobecność Typ], CASE WHEN TNB_Typ = 2 THEN ''NIE'' ELSE ''TAK'' END [Nieobecność Usprawiedliwiona],&#xD;
CASE PNB_Przyczyna&#xD;
	WHEN 1 THEN ''Nie dotyczy''&#xD;
	WHEN 2 THEN ''Zwolnienie lekarskie''&#xD;
	WHEN 3 THEN ''Wypadek w pracy/choroba zawodowa''&#xD;
	WHEN 4 THEN ''Wypadek w drodze do/z pracy''&#xD;
	WHEN 5 THEN ''Zwolnienie w okresie ciąży''&#xD;
	WHEN 6 THEN ''Zwolnienie spowodowane gruźlicą''&#xD;
	WHEN 7 THEN ''Nadużycie alkoholu''&#xD;
	WHEN 8 THEN ''Przestępstwa/wykroczenie''&#xD;
	WHEN 9 THEN ''Opieka nad dzieckiem do lat 14''&#xD;
	WHEN 10 THEN ''Opieka nad inną osobą''&#xD;
	WHEN 11 THEN ''Leczenie szpitalne''&#xD;
	WHEN 12 THEN ''Badanie dawcy/pobranie organów'' &#xD;
	WHEN 13 THEN ''Urlop macierzyński 100%''&#xD;
	WHEN 14 THEN ''Urlop macierzyński 80%''&#xD;
	WHEN 15 THEN ''Urlop rodzicielski 80%''&#xD;
	WHEN 16 THEN ''Urlop rodzicielski 60%''&#xD;
	WHEN 17 THEN ''Urlop rodzicielski 100%''&#xD;
	WHEN 19 THEN ''Niezdolność do pracy/kwarantanna służb medycznych''&#xD;
	WHEN 20 THEN ''Niepoprawne wykorzystanie zwolnienia''&#xD;
	WHEN 21 THEN ''Urlop macierzyński 81,5%''&#xD;
	WHEN 22 THEN ''Urlop rodzicielski 81,5%''&#xD;
	WHEN 23 THEN ''Urlop rodzicielski 70%''&#xD;
	WHEN 24 THEN ''Urlop rodzicielski 70% (do 9 tygodni)''&#xD;
	WHEN 25 THEN ''Urlop rodzicielski 70% (ustawa "Za życiem")''&#xD;
	WHEN 22 THEN ''Urlop rodzicielski 81.5%''&#xD;
	WHEN 26 THEN ''Urlop rodzicielski 81.5% (ustawa "Za życiem")''&#xD;
&#xD;
	ELSE ''Nie dotyczy''&#xD;
END [Nieobecność Przyczyna],&#xD;
CASE PNB_Tryb &#xD;
	WHEN 0 THEN ''Podstawowa''&#xD;
	WHEN 1 THEN ''Anulowana''&#xD;
	WHEN 2 THEN ''Korygująca''&#xD;
	ELSE ''Nie dotyczy''&#xD;
END [Nieobecność Status],&#xD;
CASE PNB_UrlopNaZadanie &#xD;
	WHEN 0 THEN ''NIE'' &#xD;
	WHEN 1 THEN ''TAK''&#xD;
	ELSE ''Nie dotyczy''&#xD;
END [Nieobecność Na Żądanie],&#xD;
CASE WHEN SPR.DST_UwzglCzasPracy = 0 THEN NULL&#xD;
	WHEN PNB_Calodzienna = 0 THEN DATEDIFF(MI,convert(datetime,''18991230''),PNB_Godz)  / 60.0&#xD;
	WHEN PNB_Calodzienna = 1 AND COALESCE(PPL_TypDnia,KAD_TypDnia) &lt;&gt; 1 THEN NULL&#xD;
	WHEN PNB_Calodzienna = 1 THEN NULLIF(CASE WHEN PGR_OdGodziny IS NULL&#xD;
	THEN CASE WHEN PGL_OdGodziny IS NULL&#xD;
			THEN 1.0*DATEDIFF(minute,KDG_OdGodziny,(CASE WHEN KDG_OdGodziny &gt; KDG_DoGodziny THEN DATEADD(day,1,KDG_DoGodziny) ELSE KDG_DoGodziny END))/60&#xD;
			ELSE 1.0*DATEDIFF(minute,PGL_OdGodziny,(CASE WHEN PGL_OdGodziny &gt; PGL_DoGodziny THEN DATEADD(day,1,PGL_DoGodziny) ELSE PGL_DoGodziny END))/60&#xD;
		END&#xD;
	ELSE 1.0*DATEDIFF(minute,PGR_OdGodziny,(CASE WHEN PGR_OdGodziny &gt; PGR_DoGodziny THEN DATEADD(day,1,PGR_DoGodziny) ELSE PGR_DoGodziny END))/60&#xD;
	END,0)&#xD;
	ELSE NULL&#xD;
END /isnull(nullif(IloscStrefa,0),1) [Nieobecności w Godzinach],&#xD;
CASE WHEN PNB_PnbId IS NULL THEN NULL&#xD;
WHEN PNB_Calodzienna = 1 THEN 1.0&#xD;
ELSE (1/(8*(Cast(PRE_ETAEtatL as decimal)/ISNULL(NULLIF(Pre_etaetatM,0),1))))*((datepart(MINUTE,PNB_Godz)/60.0) + (datepart(HOUR,PNB_Godz))) &#xD;
END /isnull(nullif(IloscKal,0),1) [Nieobecności w Dniach Kalendarzowych],&#xD;
CASE WHEN PNB_PnbId IS NULL THEN NULL&#xD;
WHEN SPR.DST_UwzglCzasPracy = 0 THEN NULL &#xD;
WHEN PNB_Calodzienna = 1 THEN 1.0&#xD;
ELSE (1/(8*(Cast(PRE_ETAEtatL as decimal)/ISNULL(NULLIF(Pre_etaetatM,0),1))))*((datepart(MINUTE,PNB_Godz)/60.0) + (datepart(HOUR,PNB_Godz))) &#xD;
END /isnull(nullif(IloscStrefa,0),1) [Nieobecności w Dniach Pracy],&#xD;
''Nie dotyczy'' [Limit Nieobecności Typ], &#xD;
''Nie dotyczy'' [Limit Nieobecności Od], ''Nie dotyczy'' [Limit Nieobecności Do],&#xD;
REPLACE(CONVERT(VARCHAR(10), PNB_OkresOd, 111), ''/'', ''-'') [Nieobecność Od], REPLACE(CONVERT(VARCHAR(10), PNB_OkresDo, 111), ''/'', ''-'')  [Nieobecność Do],&#xD;
NULL [Limit Nieobecności Należny Dni],&#xD;
NULL [Limit Nieobecności Należny Godziny],&#xD;
NULL [Limit Nieobecności Wykorzystany Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Godziny],&#xD;
NULL [Limit Nieobecności Pozostały Dni],&#xD;
NULL [Limit Nieobecności Pozostały Godziny],&#xD;
NULL [Limit Nieobecności Zaległy Dni],&#xD;
NULL [Limit Nieobecności Zaległy Godziny],&#xD;
NULL [Wypłata Wartość Netto], NULL [Suma Elementów Wypłaty], NULL [Wypłata Wynagrodzenie Zasadnicze],&#xD;
NULL [Urlop Planowany Dni],&#xD;
NULL [Urlop Wypoczynkowy Należny Dni],&#xD;
NULL [Urlop Wypoczynkowy Pozostało Dni],&#xD;
NULL [Przybliżona Rezerwa Urlopowa],&#xD;
NULL  [Obowiązujący Limit Nieobecności Należny Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Należny Godziny],&#xD;
NULL [Obowiązujący Limit Nieobecności Wykorzystany Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Wykorzystany Godziny ], &#xD;
NULL  [Obowiązujący Limit Nieobecności Pozostały Dni ],&#xD;
NULL [Obowiązujący Limit Nieobecności Pozostały Godziny ],&#xD;
NULL  [Obowiązujący Limit Nieobecności Zaległy Dni ],&#xD;
NULL [Obowiązujący  Limit Nieobecności Zaległy Godziny ],&#xD;
NULL [Obowiązujący Urlop Planowany Dni ],&#xD;
NULL [Obowiązujący  Urlop Wypoczynkowy Należny Dni ],&#xD;
NULL[Obowiązujący  Urlop Wypoczynkowy Pozostało Dni ],&#xD;
NULL [Obowiązujący Limit Przybliżona Rezerwa Urlopowa ],&#xD;
NULL [Limit Nieobecności Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Pozostały Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Należny Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Wykorzystany Cały Okres Dni],&#xD;
NULL [Limit Nieobecności Urlop Wypoczynkowy Pozostały Cały Okres Dni],&#xD;
&#xD;
PRE_Kod [Liczba Pracowników]&#xD;
,DZPR.DZL_Kod AS [Pracownik Wydział]&#xD;
,CASE rob.DKM_Robotnicze WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Stanowisko Robotnicze]&#xD;
	 ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZat, 111), ''/'', ''-''),''(BRAK)'') END [Data Zatrudnienia Dzień]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZat) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZat)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Tydzień Roku] &#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZat) AS VARCHAR(10)),''(BRAK)'') END AS [Data Zatrudnienia Kwartał]&#xD;
	  ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZat) AS VARCHAR(10)),''(BRAK)'') END [Data Zatrudnienia Rok] &#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(REPLACE(CONVERT(VARCHAR(10), PZZwol, 111), ''/'', ''-''),''(BRAK)'') END [Data Zwolnienia Dzień]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(MONTH(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Miesiąc]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST((datepart(DY, datediff(d, 0, PZZwol) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, PZZwol)*/ AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Tydzień Roku]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(DATEPART(quarter, PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Kwartał]&#xD;
	  ,CASE WHEN PZZwol = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' WHEN PZZwol = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE ISNULL(CAST(YEAR(PZZwol) AS VARCHAR(10)),''(BRAK)'') END [Data Zwolnienia Rok]&#xD;
	 ,CASE WHEN PZZat = convert(datetime,''18991230'',112) THEN ''(BRAK)'' ELSE CASE WHEN PZZwol &gt; GetDate() THEN CASE WHEN datediff(yy,PZZat,GetDate()) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,GetDate()) AS VARCHAR(10)),''(BRAK)'') END ELSE CASE WHEN datediff(yy,PZZat,PZZwol) = 0 THEN ''Poniżej roku'' ELSE ISNULL(CAST(datediff(yy,PZZat,PZZwol) AS VARCHAR(10)),''(BRAK)'') END END END [Pracownik Lata Pracy]&#xD;
	  ,ISNULL(CAST (datediff(yy,PRE_DataUr,Data) AS VARCHAR(10)),''(BRAK)'') [Pracownik Wiek]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
&#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), Data, 111), ''/'', ''-'') [Data]&#xD;
*/&#xD;
&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), Data, 111), ''/'', ''-'') [Data Dzień], MONTH(Data) [Data Miesiąc], YEAR(Data) [Data Rok]&#xD;
,CASE when MONTH(Data) &lt;7 THEN ''I'' else ''II'' END AS [Data Półrocze]&#xD;
,DATEPART(quarter, Data) AS [Data Kwartał] &#xD;
&#xD;
----------KONTEKSTY&#xD;
,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__]&#xD;
,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + '&#xD;
FROM #Daty&#xD;
	LEFT JOIN CDN.PracEtaty ON PRE_PreId = PreId&#xD;
	LEFT JOIN #PracZat on PZPraId = PRE_PraID&#xD;
	LEFT JOIN #Umowy ON UPraId = PraId AND UData = Data&#xD;
	LEFT JOIN CDN.KalendDni ON Data = KAD_Data AND PRE_KalId = KAD_KalId&#xD;
	LEFT JOIN CDN.Kalendarze ON KAD_KalId = KAL_KalId&#xD;
	LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko =  sta.DKM_DkmId AND  sta.DKM_Rodzaj = 1&#xD;
	LEFT JOIN CDN.PracPlanDni ON PPL_PraId = PRE_PraId AND PPL_Data = Data&#xD;
	LEFT JOIN CDN.PracPracaDni ON PPR_PraId = PRE_PraId AND PPR_Data = Data&#xD;
	LEFT JOIN CDN.KalendDniGodz ON KDG_KadId = KAD_KadId AND PPL_PplId IS NULL AND PPR_PprId IS NULL&#xD;
	LEFT JOIN CDN.PracPlanDniGodz ON PPL_PplId = PGL_PplId AND PPR_PprId IS NULL&#xD;
	LEFT JOIN CDN.PracPracaDniGodz ON PPR_PprId = PGR_PprId&#xD;
	LEFT JOIN CDN.DefinicjeStref SPR ON COALESCE(PGR_Strefa,PGL_Strefa,KDG_Strefa) = SPR.DST_DstId&#xD;
	LEFT JOIN CDN.Dzialy DPR ON COALESCE(PGR_DzlId,PGL_DzlId,KDG_DzlId) = DPR.DZL_DzlId &#xD;
	LEFT JOIN CDN.DefProjekty PPR ON COALESCE(PGR_PrjId,PGL_PrjId,KDG_PrjId) = PPR.PRJ_PrjId&#xD;
	LEFT JOIN CDN.PracNieobec ON PNB_PraId = PRE_PraId AND Data &gt;= PNB_OkresOd AND Data &lt;= PNB_OkresDo AND PNB_Tryb &lt;&gt; 1&#xD;
	LEFT JOIN CDN.TypNieobec ON PNB_TnbId = TNB_TnbId&#xD;
	LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
	LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
	LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = PRE_ZakId&#xD;
	LEFT JOIN CDN.PracKod on PRA_PraId = PRE_PraId&#xD;
	LEFT JOIN cdn.DaneKadMod rob on PRE_ETADkmIdStanowisko = rob.DKM_DkmId&#xD;
	LEFT JOIN cdn.Dzialy DZPR ON PRE_DzlId = DZPR.DZL_DzlId &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON PRE_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON PRE_OpeModID = mod.Ope_OpeId&#xD;
	LEFT JOIN #IloscPrzedzialowPracy  ON (PPRID = KAD_KadId AND PPL_PplId IS NULL AND PPR_PprId IS NULL AND PPRTYP = 1)or( PPL_PplId = PPRID AND PPR_PprId IS NULL and PPRTYP = 2 ) OR ( PPR_PprId = PPRID and PPRTYP = 3)&#xD;
	WHERE ((Data &lt;= PZZwol AND Data &gt;= PZZat) OR UUmw &gt; 0) &#xD;
&#xD;
&#xD;
	'&#xD;
&#xD;
PRINT(@Select)&#xD;
EXEC(@select)	&#xD;
&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #Daty&#xD;
DROP TABLE #Umowy&#xD;
DROP TABLE #PracZat&#xD;
DROP TABLE #Wyplaty&#xD;
DROP TABLE #WszystkieDaty&#xD;
DROP TABLE #AktualneLimity&#xD;
DROP TABLE #Swieta&#xD;
DROP TABLE #WszystkieDatyDo&#xD;
DROP TABLE #WykorzystaneDoDnia&#xD;
DROP TABLE #tmpmies&#xD;
DROP TABLE #RzeczywisteObowiazywanieLimitow&#xD;
DROP TABLE #IloscPrzedzialowPracy&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jcJmwCoYl15WzHxaW87BnyNdP2x8/CGcO7bORHqKJvs6K4Rc6WGUrqsFTohQnCixfCEZm86P9XmLvgtux+17xfMNWq24hKQ21Y6FZpZ5l4QjOINa5rreB8sackG/fPbGY3HWAzkEZBu0Hsrno1J2YHw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kalendarz" caption="Kalendarz" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Pracownik Archiwalny" caption="Pracownik Archiwalny" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Pracownik Nazwa" caption="Pracownik Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Pracownik Kod" caption="Pracownik Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Pracownik Stanowisko" caption="Pracownik Stanowisko" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Godzina Od" caption="Data Godzina Od" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Godzina Do" caption="Data Godzina Do" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy" caption="Data Analizy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Strefa" caption="Strefa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Strefa Nazwa" caption="Strefa Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział" caption="Wydział" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Projekt" caption="Projekt" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Typ Dnia" caption="Typ Dnia" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Wymiar Pracy w Godzinach" caption="Wymiar Pracy w Godzinach" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wymiar Pracy w Minutach" caption="Wymiar Pracy w Minutach" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wymiar Pracy" caption="Wymiar Pracy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wymiar Pracy w Dniach" caption="Wymiar Pracy w Dniach" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Pracy w Godzinach" caption="Czas Pracy w Godzinach" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Pracy w Minutach" caption="Czas Pracy w Minutach" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Czas Pracy" caption="Czas Pracy" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Czas Pracy w Dniach" caption="Czas Pracy w Dniach" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Nieobecność Typ" caption="Nieobecność Typ" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Nieobecność Usprawiedliwiona" caption="Nieobecność Usprawiedliwiona" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nieobecność Przyczyna" caption="Nieobecność Przyczyna" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Nieobecność Status" caption="Nieobecność Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nieobecność Na Żądanie" caption="Nieobecność Na Żądanie" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nieobecności w Godzinach" caption="Nieobecności w Godzinach" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Nieobecności w Dniach Kalendarzowych" caption="Nieobecności w Dniach Kalendarzowych" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Nieobecności w Dniach Pracy" caption="Nieobecności w Dniach Pracy" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Typ" caption="Limit Nieobecności Typ" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Od" caption="Limit Nieobecności Od" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Do" caption="Limit Nieobecności Do" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nieobecność Od" caption="Nieobecność Od" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nieobecność Do" caption="Nieobecność Do" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Należny Dni" caption="Limit Nieobecności Należny Dni" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Należny Godziny" caption="Limit Nieobecności Należny Godziny" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Wykorzystany Dni" caption="Limit Nieobecności Wykorzystany Dni" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Wykorzystany Godziny" caption="Limit Nieobecności Wykorzystany Godziny" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Pozostały Dni" caption="Limit Nieobecności Pozostały Dni" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Pozostały Godziny" caption="Limit Nieobecności Pozostały Godziny" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Zaległy Dni" caption="Limit Nieobecności Zaległy Dni" type="measure" formatString="" aggregate="Min" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Zaległy Godziny" caption="Limit Nieobecności Zaległy Godziny" type="measure" formatString="" aggregate="Min" /&gt;&#xD;
    &lt;column name="Wypłata Wartość Netto" caption="Wypłata Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Suma Elementów Wypłaty" caption="Suma Elementów Wypłaty" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wypłata Wynagrodzenie Zasadnicze" caption="Wypłata Wynagrodzenie Zasadnicze" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Urlop Planowany Dni" caption="Urlop Planowany Dni" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Urlop Wypoczynkowy Należny Dni" caption="Urlop Wypoczynkowy Należny Dni" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Urlop Wypoczynkowy Pozostało Dni" caption="Urlop Wypoczynkowy Pozostało Dni" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przybliżona Rezerwa Urlopowa" caption="Przybliżona Rezerwa Urlopowa" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Limit Nieobecności Należny Dni " caption="Obowiązujący Limit Nieobecności Należny Dni " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Limit Nieobecności Należny Godziny " caption="Obowiązujący Limit Nieobecności Należny Godziny " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Limit Nieobecności Wykorzystany Dni " caption="Obowiązujący Limit Nieobecności Wykorzystany Dni " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Limit Nieobecności Wykorzystany Godziny " caption="Obowiązujący Limit Nieobecności Wykorzystany Godziny " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Limit Nieobecności Pozostały Dni " caption="Obowiązujący Limit Nieobecności Pozostały Dni " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Limit Nieobecności Pozostały Godziny " caption="Obowiązujący Limit Nieobecności Pozostały Godziny " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Limit Nieobecności Zaległy Dni " caption="Obowiązujący Limit Nieobecności Zaległy Dni " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Limit Nieobecności Zaległy Godziny " caption="Obowiązujący Limit Nieobecności Zaległy Godziny " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Urlop Planowany Dni " caption="Obowiązujący Urlop Planowany Dni " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Urlop Wypoczynkowy Należny Dni " caption="Obowiązujący Urlop Wypoczynkowy Należny Dni " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Urlop Wypoczynkowy Pozostało Dni " caption="Obowiązujący Urlop Wypoczynkowy Pozostało Dni " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obowiązujący Limit Przybliżona Rezerwa Urlopowa " caption="Obowiązujący Limit Przybliżona Rezerwa Urlopowa " type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Należny Cały Okres Dni" caption="Limit Nieobecności Należny Cały Okres Dni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Wykorzystany Cały Okres Dni" caption="Limit Nieobecności Wykorzystany Cały Okres Dni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Pozostały Cały Okres Dni" caption="Limit Nieobecności Pozostały Cały Okres Dni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Urlop Wypoczynkowy Należny Cały Okres Dni" caption="Limit Nieobecności Urlop Wypoczynkowy Należny Cały Okres Dni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Urlop Wypoczynkowy Wykorzystany Cały Okres Dni" caption="Limit Nieobecności Urlop Wypoczynkowy Wykorzystany Cały Okres Dni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Limit Nieobecności Urlop Wypoczynkowy Pozostały Cały Okres Dni" caption="Limit Nieobecności Urlop Wypoczynkowy Pozostały Cały Okres Dni" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Liczba Pracowników" caption="Liczba Pracowników" type="measure" formatString="n0" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Pracownik Wydział" caption="Pracownik Wydział" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Stanowisko Robotnicze" caption="Pracownik Stanowisko Robotnicze" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia Dzień" caption="Data Zatrudnienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia Miesiąc" caption="Data Zatrudnienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia Tydzień Roku" caption="Data Zatrudnienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia Kwartał" caption="Data Zatrudnienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia Rok" caption="Data Zatrudnienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia Dzień" caption="Data Zwolnienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia Miesiąc" caption="Data Zwolnienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia Tydzień Roku" caption="Data Zwolnienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia Kwartał" caption="Data Zwolnienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia Rok" caption="Data Zwolnienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Lata Pracy" caption="Pracownik Lata Pracy" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Pracownik Wiek" caption="Pracownik Wiek" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dzień" caption="Data Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miesiąc" caption="Data Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rok" caption="Data Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Półrocze" caption="Data Półrocze" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Kwartał" caption="Data Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Pracownika Poziom 1" caption="Wydział Pracownika Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Pracownika Poziom 2" caption="Wydział Pracownika Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Pracownika Poziom 3" caption="Wydział Pracownika Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut aTRE" caption="Pracownik Atrybut aTRE" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="[Measures].[112b0d76-1b9d-4af8-88ca-37bf99eae94b]" caption="Czas Pracy Godziny" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="[Measures].[f21a3349-723f-495b-8533-ca6f66f213a0]" caption="Czas Pracy Minuty" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data początkowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Pierwszy dzień zakresu dat czasu pracy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT DATEADD(month, DATEDIFF(month, 0, GETDATE()), 0)&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-05-01&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data końcowa analizy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Ostatni dzień zakresu dat czasu pracy.&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2020-05-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;WSP&lt;/Name&gt;&#xD;
    &lt;Label&gt;Współczynnik urlopowy:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Współczynnik urlopowy&lt;/ToolTip&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;100&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;2&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0.01&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;21,00&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;whatifMeasures&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[112b0d76-1b9d-4af8-88ca-37bf99eae94b]" caption="Czas Pracy Godziny" formula="Math.Floor(Czas Pracy w Minutach/60)" description="" summaryType="Sum" /&gt;&#xD;
    &lt;whatifMeasure uniqueName="[Measures].[f21a3349-723f-495b-8533-ca6f66f213a0]" caption="Czas Pracy Minuty" formula="Czas Pracy w Minutach%60" description="" summaryType="Default" /&gt;&#xD;
  &lt;/whatifMeasures&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions /&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields /&gt;&#xD;
  &lt;rowFields /&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields /&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Czasu Pracy wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport prezentuje dane związane z czasem pracy pracowników firmy. Znajdują się w nim szczególowe informacje dotyczące obecności, nieobecności, urlopów i limitów urlopowych z dokładnością do minuty dla każdego dnia przedziału. Dane pobierane są z kalendarza pracy każdego pracownika.&#xD;
&#xD;
W przypadku wielu limitów nieobecności tego samego typu w roku gdy są one ustalane proporcjonalnie należy korzystać z standardowych miar limitów urlopowych. W sytuacji gdy limity ustalane są w taki sposób że nowszy limit zastępuje starszy należy korzystać  z miar zaczynających się od 'Obowiązujący'.&#xD;
&#xD;
Raport musi być wykonywany z parametrami będącymi w tym samym roku &#xD;
&#xD;
Raport nie bierze pod uwagę planowanych urlopów poza parametrami datowymi&#xD;
&#xD;
Raport zawiera następujące parametry:&#xD;
Data początkowa analizy - Data okreslająca początek zakresu, dla którego wykonana zostanie analiza&#xD;
Data końcowa analizy - Data okreslająca koniec zakresu, dla którego wykonana zostanie analiza&#xD;
&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.KalendDni - tabela zawiera plany pracy dla każdego dnia wszystkich kalendarzy zdefiniowanych w programie&#xD;
CDN.PracPlanDni - tabela zawiera ręczne zmiany planu pracy pracownika w stosunku do standarodwego kalendarza&#xD;
CDN.PracPracaDni - tabela zawiera dane o rzeczywistym czasie pracy pracownika jeśli są one różne od planu&#xD;
CDN.PracNieobec - tabela zawiera informacje o nieobecnościach pracownika&#xD;
CDN.LimitNieobec - tabela zawiera informacje o limitach nieobecności przysługujących danemu pracownikowi</a:description><a:id>20</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>20. Raport Czasu Pracy</a:mainLinkName><a:modifiedOn>2025-05-29T17:07:27.147</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2016-10-20T18:26:02.41</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Wyników Ankiet &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie hierarchii wydziałów&#xD;
SELECT DZL_DzlId [gid], DZL_Kod [kod], DZL_ParentId [parId], DZL_Poziom [poziom] INTO #tmpTwrGr FROM CDN.Dzialy&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt; 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(100), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(100)'&#xD;
    EXEC(@sql)&#xD;
&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= parId '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + kod + '')'' ELSE kod END'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                         WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(c.kod AS nvarchar) + '')''&#xD;
                         WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(p.kod AS nvarchar) + '')''&#xD;
                    ELSE p.kod END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parId AS nvarchar)&#xD;
                    ELSE CAST(p.parId AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
declare @select varchar(max);&#xD;
declare @kolumny varchar(max);&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
&#xD;
set @i=1&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ', CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END [Wydział Poziom ' + LTRIM(@i) + '] '&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Pracowników&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(100), @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DISTINCT OAT_AtkId, REPLACE(OAT_NazwaKlasy, ']', '_')&#xD;
FROM CDN.OAtrybuty&#xD;
WHERE OAT_PrcId IS NOT NULL&#xD;
AND OAT_AtkId IS NOT NULL;&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod;&#xD;
&#xD;
SELECT DISTINCT OAT_PrcId INTO #tmpKonAtr FROM CDN.OAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = ATR.ATH_Wartosc &#xD;
        FROM CDN.OAtrybutyHist ATR &#xD;
        JOIN CDN.OAtrybuty OA ON OA.OAT_OatId = ATR.ATH_OatId AND ATR.ATH_DataDo = (SELECT MAX(A1.ATH_DataDo) FROM CDN.OAtrybutyHist A1 WHERE A1.ATH_OatId = ATR.ATH_OatId)&#xD;
        JOIN #tmpKonAtr TM ON OA.OAT_PrcId = TM.OAT_PrcId&#xD;
        WHERE ATR.ATH_AtkId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Pracownik Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
-- zapytanie właściwe&#xD;
SET @select =&#xD;
' select &#xD;
 BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
 PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
 PRE_Kod [Pracownik Kod], &#xD;
 PRE_Plec as [Pracownik Płeć],&#xD;
CASE WHEN Prc.PRI_Archiwalny = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Archiwalny],&#xD;
CASE WHEN PRE_ETARodzajUmowy = '''' THEN ''(NIEPRZYPISANE)'' ELSE PRE_ETARodzajUmowy END [Rodzaj Umowy], &#xD;
CASE WHEN Prc.PRI_Typ = 1 THEN ''Pracownik'' ELSE ''Własciciel/Współpracownik'' END [Pracownik Typ],&#xD;
    CASE &#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 10 THEN ''Etat''&#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 20 THEN ''Umowa''&#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 30 THEN ''Etat/Umowa''&#xD;
        ELSE ''Bez Zatrudnienia'' END [Pracownik Typ Zatrudnienia], &#xD;
CASE WHEN sta.DKM_Nazwa IS NULL THEN ''(NIEPRZYPISANE)'' ELSE sta.DKM_Nazwa END [Pracownik Stanowisko], &#xD;
CNT_Kod as [Pracownik Centrum Kod] , &#xD;
CNT_Nazwa as [Pracownik Centrum Nazwa] , &#xD;
Kier.PRI_Kod as [Kierownik Kod],&#xD;
Kier.PRI_Imie1 as [Kierownik Imię],&#xD;
Kier.PRI_Nazwisko as [Kierownik Nazwisko],&#xD;
A.SBL_Nazwa as [Ankieta Nazwa], &#xD;
SOB_Nazwa as [Ankieta Obszar Nazwa] ,&#xD;
SSK_Nazwa as [Ankieta Skala Nagłówek],&#xD;
NULL as [Ocena Pracownika Symbol],&#xD;
NULL as [Ocena Kierownika Symbol],&#xD;
--miary&#xD;
SKF_SumaWag as [Ankieta Waga],&#xD;
SAS_Nazwa as [Ankieta Sekcja], &#xD;
SAE_NazwaPozycji as [Ankieta Pytanie], &#xD;
SAE_Waga as [Ankieta Pytanie Waga],&#xD;
SAE_Samoocena as [Ocena Pracownika Pozycji Ankiety Wartość] , &#xD;
case when SKF_SumaWag&lt;&gt;0 then (SAE_Samoocena*SAE_Waga)/SKF_SumaWag ELSE NULL END as [Ocena Pracownika Pozycji Ankiety] , &#xD;
(select SSE_Wartosc from [CDN].[EP_SzablonySkalaElem] where SSE_SkalaId = SN.SSK_Id and SSE_Waga = SAE_Samoocena) as [Ocena Pracownika Pozycji Symbol], &#xD;
SAE_OcenaKierownika as [Ocena Kierownika Pozycji Ankiety Wartość],&#xD;
case when SKF_SumaWag&lt;&gt;0 then (SAE_OcenaKierownika*SAE_Waga)/SKF_SumaWag ELSE NULL END as [Ocena Kierownika Pozycji Ankiety] , &#xD;
(select SSE_Wartosc from [CDN].[EP_SzablonySkalaElem] where SSE_SkalaId = SN.SSK_Id and SSE_Waga = SAE_OcenaKierownika) as [Ocena Kierownika Pozycji Symbol], &#xD;
NULL as [Ocena Pracownika],&#xD;
NULL as [Ocena Kierownika],&#xD;
REPLACE(CONVERT(VARCHAR(10), POP_OkresOd, 111), ''/'', ''-'') as [Ankieta Za Okres OD],&#xD;
REPLACE(CONVERT(VARCHAR(10), POP_OkresDo, 111), ''/'', ''-'') as [Ankieta Za Okres DO],&#xD;
REPLACE(CONVERT(VARCHAR(10), POP_Termin, 111), ''/'', ''-'') as [Ankieta Termin Wykonania Dzień],&#xD;
datepart(YEAR,POP_Termin) as [Ankieta Termin Wykonania Rok],&#xD;
datepart(QUARTER, POP_Termin) as [Ankieta Termin Wykonania Kwartał],&#xD;
datepart(MONTH, POP_Termin) as [Ankieta Termin Wykonania Miesiąc],&#xD;
SAR_Id [Ankiety Ilość],&#xD;
CASE WHEN POP_SamoocenaKompletna= 1 THEN SAR_Id ELSE NULL END [Ankiety Pracownik Ilość zatwierdzonych],&#xD;
CASe WHEN POP_OcenaKierownikaKompletna= 1 THEN SAR_Id ELSE NULL END [Ankiety Kierownik Ilość zatwierdzonych],&#xD;
case POP_StatusKierownik &#xD;
 when 0 then ''przypisane arkusze''&#xD;
 when 1 then ''zatwierdzone przez przełożonego''&#xD;
 when 2 then ''do zatwierdzenia''&#xD;
 when 3 then ''zamknięte''&#xD;
end as [Ankiety Kierownik Status],&#xD;
case POP_StatusPracownik &#xD;
 when 0 then ''przypisane arkusze''&#xD;
 when 1 then ''zatwierdzone przez podwladnego''&#xD;
 when 2 then ''do zatwierdzenia''&#xD;
 when 3 then ''zamknięte''&#xD;
end as [Ankiety Pracownik Status]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
,GETDATE() [Data Analizy]&#xD;
----------KONTEKSTY&#xD;
,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__]&#xD;
,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + '&#xD;
from  &#xD;
[CDN].[EP_PracOcenaPracownicza]&#xD;
join [CDN].[Pracidx] Prc on POP_PrcId = Prc.PRI_PraId and Prc.PRI_Typ in (1,2)&#xD;
join [CDN].[PracEtaty] on PRE_PraId = Prc.PRI_PraId and year(pre_datado) = 2999&#xD;
LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko = sta.DKM_DkmId AND sta.DKM_Rodzaj = 1&#xD;
join [CDN].[Centra] on  CNT_CntId = PRE_CntId&#xD;
join [CDN].[CentraKierownicy] on  CNK_CntId = PRE_CntId&#xD;
join [CDN].[Pracidx] as Kier on CNK_PraId = Kier.PRI_PraId and Kier.PRI_Typ in (1,2)&#xD;
left outer join [CDN].[EP_PrcOcenaPracowniczaWagi] on OPW_PrcId = Prc.PRI_PraId&#xD;
join [CDN].[EP_Szablony] as A on SBL_Id = POP_SzablonId&#xD;
join [CDN].[EP_SzablonyObszar] on sbl_obszarid = SOB_Id&#xD;
join [CDN].[EP_SzablonyKonfiguracja] on SKF_SzablonId = SBL_Id&#xD;
join [CDN].[EP_SzablonySkalaNag] SN on SN.SSK_Id = SKF_SkalaId&#xD;
join [CDN].[EP_SzablonyArkusze] on SAR_SzablonId = SBL_Id&#xD;
join [CDN].[EP_SzablonyArkuszeSekcje] on SAS_ArkuszId = SAR_Id&#xD;
join [CDN].[EP_SzablonyArkuszeSekcjeElem] on sae_sekcjaid = SAS_Id&#xD;
    LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
    LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON PRE_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON PRE_OpeModID = mod.Ope_OpeId&#xD;
&#xD;
union all -- ocena ankiety&#xD;
&#xD;
 select &#xD;
 BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
 PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
 PRE_Kod [Pracownik Kod], &#xD;
PRE_Plec as [Pracownik Płeć],&#xD;
CASE WHEN Prc.PRI_Archiwalny = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Archiwalny],&#xD;
CASE WHEN PRE_ETARodzajUmowy = '''' THEN ''(NIEPRZYPISANE)'' ELSE PRE_ETARodzajUmowy END [Rodzaj Umowy], &#xD;
CASE WHEN Prc.PRI_Typ = 1 THEN ''Pracownik'' ELSE ''Własciciel/Współpracownik'' END [Pracownik Typ],&#xD;
    CASE &#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 10 THEN ''Etat''&#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 20 THEN ''Umowa''&#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 30 THEN ''Etat/Umowa''&#xD;
        ELSE ''Bez Zatrudnienia'' END [Pracownik Typ Zatrudnienia], &#xD;
CASE WHEN sta.DKM_Nazwa IS NULL THEN ''(NIEPRZYPISANE)'' ELSE sta.DKM_Nazwa END [Pracownik Stanowisko], &#xD;
CNT_Kod as [Pracownik Centrum Kod] , &#xD;
CNT_Nazwa as [Pracownik Centrum Nazwa] , &#xD;
Kier.PRI_Kod as [Kierownik Kod],&#xD;
Kier.PRI_Imie1 as [Kierownik Imię],&#xD;
Kier.PRI_Nazwisko as [Kierownik Nazwisko],&#xD;
A.SBL_Nazwa as [Ankieta Nazwa], &#xD;
SOB_Nazwa as [Ankieta Obszar Nazwa] ,&#xD;
SSK_Nazwa as [Ankieta Skala Nagłówek],&#xD;
POP_SamoocenaSlownie as [Ocena Pracownika Symbol],&#xD;
POP_OcenaKierownikaSlownie as [Ocena Kierownika Symbol],&#xD;
--miary&#xD;
SKF_SumaWag as [Ankieta Waga],&#xD;
'' Ocena ankiety'' [Ankieta Sekcja], &#xD;
NULL as [Ankieta Pytanie], &#xD;
NULL as [Ankieta Pytanie Waga],&#xD;
NULL as [Ocena Pracownika Pozycji Ankiety Wartość] , &#xD;
NULL as [Ocena Pracownika Pozycji Ankiety] , &#xD;
NULL as [Ocena Pracownika Pozycji Symbol], &#xD;
NULL as [Ocena Kierownika Pozycji Ankiety Wartość],&#xD;
NULL as [Ocena Kierownika Pozycji Ankiety] , &#xD;
NULL as [Ocena Kierownika Pozycji Symbol], &#xD;
POP_Samoocena as [Ocena Pracownika],&#xD;
POP_OcenaKierownika as [Ocena Kierownika],&#xD;
REPLACE(CONVERT(VARCHAR(10), POP_OkresOd, 111), ''/'', ''-'') as [Ankieta Za Okres OD],&#xD;
REPLACE(CONVERT(VARCHAR(10), POP_OkresDo, 111), ''/'', ''-'') as [Ankieta Za Okres DO],&#xD;
REPLACE(CONVERT(VARCHAR(10), POP_Termin, 111), ''/'', ''-'') as [Ankieta Termin Wykonania Dzień],&#xD;
datepart(YEAR,POP_Termin) as [Ankieta Termin Wykonania Rok],&#xD;
datepart(QUARTER, POP_Termin) as [Ankieta Termin Wykonania Kwartał],&#xD;
datepart(MONTH, POP_Termin) as [Ankieta Termin Wykonania Miesiąć],&#xD;
NULL [Ankiety Ilość],&#xD;
NULL [Ankiety Pracownik Ilość zatwierdzonych],&#xD;
NULL [Ankiety Kierownik Ilość zatwierdzonych],&#xD;
case POP_StatusKierownik &#xD;
 when 0 then ''przypisane arkusze''&#xD;
 when 1 then ''zatwierdzone przez przełożonego''&#xD;
 when 2 then ''do zatwierdzenia''&#xD;
 when 3 then ''zamknięte''&#xD;
end as [Ankiety Kierownik Status],&#xD;
case POP_StatusPracownik &#xD;
 when 0 then ''przypisane arkusze''&#xD;
 when 1 then ''zatwierdzone przez podwladnego''&#xD;
 when 2 then ''do zatwierdzenia''&#xD;
 when 3 then ''zamknięte''&#xD;
end as [Ankiety Pracownik Status]&#xD;
,zal.Ope_Kod [Operator Wprowadzający] &#xD;
,mod.Ope_Kod [Operator Modyfikujący]&#xD;
,GETDATE() [Data Analizy]&#xD;
----------KONTEKSTY&#xD;
,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__]&#xD;
,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty + '&#xD;
from  &#xD;
[CDN].[EP_PracOcenaPracownicza]&#xD;
join [CDN].[Pracidx] Prc on POP_PrcId = Prc.PRI_PraId and Prc.PRI_Typ in (1,2)&#xD;
join [CDN].[PracEtaty] on PRE_PraId = Prc.PRI_PraId and year(pre_datado) = 2999&#xD;
LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko = sta.DKM_DkmId AND sta.DKM_Rodzaj = 1&#xD;
join [CDN].[Centra] on  CNT_CntId = PRE_CntId&#xD;
join [CDN].[CentraKierownicy] on  CNK_CntId = PRE_CntId&#xD;
join [CDN].[Pracidx] as Kier on CNK_PraId = Kier.PRI_PraId and Kier.PRI_Typ in (1,2)&#xD;
left outer join [CDN].[EP_PrcOcenaPracowniczaWagi] on OPW_PrcId = Prc.PRI_PraId&#xD;
join [CDN].[EP_Szablony] as A on SBL_Id = POP_SzablonId&#xD;
join [CDN].[EP_SzablonyObszar] on sbl_obszarid = SOB_Id&#xD;
join [CDN].[EP_SzablonyKonfiguracja] on SKF_SzablonId = SBL_Id&#xD;
join [CDN].[EP_SzablonySkalaNag] SN on SN.SSK_Id = SKF_SkalaId&#xD;
LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON PRE_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON PRE_OpeModID = mod.Ope_OpeId&#xD;
'&#xD;
&#xD;
PRINT(@Select)&#xD;
EXEC(@select)   &#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKVD7xB2t0nsVId2gfbjGiwljBvDVQu0ZSrIJ1q9LUGkIB5kdG6Yodti03/WiTBwRH8eHa49Fb8l0Ifrlh/LhWNubowHzRiBE7vS3ktzz+CyxZe6iBMRamt3cq05ZSGhHVA52kBFqeB9BEaIrtKz7PUQ==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Nazwa" caption="Pracownik Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Kod" caption="Pracownik Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Pracownik Płeć" caption="Pracownik Płeć" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Archiwalny" caption="Pracownik Archiwalny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rodzaj Umowy" caption="Rodzaj Umowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Typ" caption="Pracownik Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Typ Zatrudnienia" caption="Pracownik Typ Zatrudnienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Stanowisko" caption="Pracownik Stanowisko" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Centrum Kod" caption="Pracownik Centrum Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Centrum Nazwa" caption="Pracownik Centrum Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kierownik Kod" caption="Kierownik Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kierownik Imię" caption="Kierownik Imię" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kierownik Nazwisko" caption="Kierownik Nazwisko" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ankieta Nazwa" caption="Ankieta Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ankieta Obszar Nazwa" caption="Ankieta Obszar Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ankieta Skala Nagłówek" caption="Ankieta Skala Nagłówek" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ocena Pracownika Symbol" caption="Ocena Pracownika Symbol" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ocena Kierownika Symbol" caption="Ocena Kierownika Symbol" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ankieta Waga" caption="Ankieta Waga" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ankieta Sekcja" caption="Ankieta Sekcja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ankieta Pytanie" caption="Ankieta Pytanie" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ankieta Pytanie Waga" caption="Ankieta Pytanie Waga" type="measure" formatString="n0" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ocena Pracownika Pozycji Ankiety Wartość" caption="Ocena Pracownika Pozycji Ankiety Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ocena Pracownika Pozycji Ankiety" caption="Ocena Pracownika Pozycji Ankiety" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ocena Pracownika Pozycji Symbol" caption="Ocena Pracownika Pozycji Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ocena Kierownika Pozycji Ankiety Wartość" caption="Ocena Kierownika Pozycji Ankiety Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ocena Kierownika Pozycji Ankiety" caption="Ocena Kierownika Pozycji Ankiety" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ocena Kierownika Pozycji Symbol" caption="Ocena Kierownika Pozycji Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ocena Pracownika" caption="Ocena Pracownika" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Ocena Kierownika" caption="Ocena Kierownika" type="measure" formatString="n2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Ankieta Za Okres OD" caption="Ankieta Za Okres OD" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ankieta Za Okres DO" caption="Ankieta Za Okres DO" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ankieta Termin Wykonania Dzień" caption="Ankieta Termin Wykonania Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ankieta Termin Wykonania Rok" caption="Ankieta Termin Wykonania Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ankieta Termin Wykonania Kwartał" caption="Ankieta Termin Wykonania Kwartał" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Ankieta Termin Wykonania Miesiąc" caption="Ankieta Termin Wykonania Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Ankiety Ilość" caption="Ankiety Ilość" type="measure" formatString="n0" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Ankiety Pracownik Ilość zatwierdzonych" caption="Ankiety Pracownik Ilość zatwierdzonych" type="measure" formatString="n0" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Ankiety Kierownik Ilość zatwierdzonych" caption="Ankiety Kierownik Ilość zatwierdzonych" type="measure" formatString="n0" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Wydział Poziom 1" caption="Wydział Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Poziom 2" caption="Wydział Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Poziom 3" caption="Wydział Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut Klasa atrybutu pracownika" caption="Pracownik Atrybut Klasa atrybutu pracownika" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut Klasa 3" caption="Pracownik Atrybut Klasa 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut Klasa 4" caption="Pracownik Atrybut Klasa 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut Klasa 5" caption="Pracownik Atrybut Klasa 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut LICZBA_H_ZLECENIE_WIZYTA_INTER" caption="Pracownik Atrybut LICZBA_H_ZLECENIE_WIZYTA_INTER" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut STAWKA_ZLECENIE_WIZYTA_INTERWE" caption="Pracownik Atrybut STAWKA_ZLECENIE_WIZYTA_INTERWE" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="386" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Wyników Ankiet wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport prezentuje dane z Okresowej Oceny Pracownika, które rejestrowane są w programie e-Pracownik.&#xD;
Znajdują się w nim szczegółowe dany dotyczące każdej ankiety: pytania, ocena własna pracownika, ocena przełożonego, podsumowanie oceny wykonanej przez pracownika, podsumowanie oceny przełożonego.&#xD;
&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.EP_PracOcenaPracownicza - tabela zawiera podsumowanie oceny pracownika i przełożonego dla całej ankiety&#xD;
CDN.EP_PrcOcenaPracowniczaWagi - tabela zawiera wartość wag poszczególnych pracowników&#xD;
CDN.EP_Szablony - tabela zawiera dane o nagłówkach ankiet - zarówno dla szablonów jak i konkretnych ankiet przypisanych do pracownika&#xD;
CDN.EP_SzablonyObszar - tabela zawiera informacje o grupach pytań dla szablonów ankiet&#xD;
CDN.EP_SzablonyKonfiguracja - tabela zawiera informacje o parametrach szablonów miedzy innymi o sposobie punktowania, zakresie udostępniania&#xD;
CDN.EP_SzablonySkalaNag - tabela zawiera wskazanie na rodzaj punktacji (literowa, punktowa, zdefiniowana przez użytkownika)&#xD;
CDN.EP_SzablonyArkusze - tabela zawiera informacje o arkuszach ankiety&#xD;
CDN.EP_SzablonyArkuszeSekcje - tabela zawiera informacje o sekcjach ankiety - grupach pytań&#xD;
CDN.EP_SzablonyArkuszeSekcjeElem - tabela zawiera informacje o poszczególnych pytaniach ankiety - ocenie pytania pracownika i przełożonego</a:description><a:id>21</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>21. Raport Wyników Ankiet</a:mainLinkName><a:modifiedOn>2025-02-04T12:17:30.553</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2017-05-11T14:32:07.92</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Operatorów&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
DECLARE @sql nvarchar(max)&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @BazModulyOperatora varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @BazZakazy varchar(max);&#xD;
&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @BazModulyOperatora = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[BazModulyOperatora]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @BazZakazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[BazZakazy]' &#xD;
&#xD;
SET @sql = N'&#xD;
SELECT&#xD;
    OPE.Ope_OpeID AS ''Ilość Wystapień'',&#xD;
    OPE.Ope_Nazwisko AS ''Operator Imię i Nazwisko'',&#xD;
    OPE.Ope_kod AS ''Operator Kod'',&#xD;
    BMO.Baz_Nazwa AS ''Baza firmowa'',&#xD;
    BMO.BMO_SerwerKlucza AS ''Serwer klucza'',&#xD;
    CASE&#xD;
        WHEN OPE.Ope_Administrator=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Administrator'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_Nieaktywny=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Niektywny'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulKB=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Kasa Bank '',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulKBP=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Kasa Bank Plus '',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulFA=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Faktury'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulMAG=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Handel'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulHAP=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Handel Plus'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulCRM=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł CRM'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulCRMP=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł CRM Plus'',&#xD;
    CASE &#xD;
        WHEN BMO.ope_ModulSRW=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Serwis'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulOBD=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Obieg dokumentów'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulKP=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Księga Podatkowa'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulST=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Środki Trwałe'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulKH=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Księga Handlowa'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulKHP=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Księga Handlowa Plus'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulPK=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Płace i Kadry'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulPKXL=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Płace i Kadry Plus'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulANL=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Analizy'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_PelneMenu=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Pełne menu dla modułu Analizy'',&#xD;
    CASE &#xD;
        WHEN BMO.Ope_ModulBIU=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Moduł Biuro Rachunkowe'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_PrawoZmianyZapKBZamRapKB=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo zmiany zapisów k/b w zamkniętych raportach'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_AkceptacjaDelegacji=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo do akceptowanie poleceń wyjazdu i rozliczenia delegacji'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_KsiegaGlowna=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawa operacji na księdze głównej'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BuforVATSpr=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Księgowanie rejestrów sprzedaży przez bufor '',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BuforVATZak=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Księgowanie rejestrów zakupów przez bufor '',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BuforAmortyz=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Księgowanie amortyzacji przez bufor '',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BuforPlace=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Księgowanie wypłat przez bufor '',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BuforEwid=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Księgowanie innych ewidencji przez bufor'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_ZmianyOffLine=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo zmiany dokumentów wyeksportowanych'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_PrawoImportuZapKBOtwRapKB=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo importu zapisów k/b do otwartych raportów'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_ModyfikacjaProcesow=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo modyfikacji procesów'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_DostepDoSkrzynkiInnychOperatorow=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo dostępu do skrzynki innych operatorów'',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_KontrolaPlatnosciWZ=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Kontrola płatności na dokumentach WZ'',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_AnalizyBI_Administrator=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Administrator Analiz BI'',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_AnalizyBI_Subskrypcje=1 THEN ''Tak'' &#xD;
        WHEN OPE.Ope_AnalizyBI_Administrator=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Dostęp do subskrypcji Analiz BI'',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_AnalizyBI_DodawaniePol=1 THEN ''Tak''&#xD;
        WHEN OPE.Ope_AnalizyBI_Administrator=1 THEN ''Tak''  &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo dodawania pól do Analiz BI '',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_AnalizyBI_Drukowanie=1 THEN ''Tak''&#xD;
        WHEN OPE.Ope_AnalizyBI_Administrator=1 THEN ''Tak''  &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo drukowania Analiz BI '',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_AnalizyBI_Eksport=1 THEN ''Tak'' &#xD;
        WHEN OPE.Ope_AnalizyBI_Administrator=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo eksportu Analiz BI'',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_AnalizyBI_ModyfikacjaZapytania=1 THEN ''Tak''&#xD;
        WHEN OPE.Ope_AnalizyBI_Administrator=1 THEN ''Tak''  &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo do modyfikacji treści zapytania Analizy BI'',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_AnalizyBI_ImportRaportu=1 THEN ''Tak'' &#xD;
        WHEN OPE.Ope_AnalizyBI_Administrator=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo do importu definicji raportu Analiz BI'',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_PrawoUsuwaniaMaili=1 THEN ''Tak'' &#xD;
        WHEN OPE.Ope_AnalizyBI_Administrator=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo do usuwania e-maili'',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_DostepDoKontInnychOperatorow=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Czy operator ma prawo dostępu do kont email innych operatorów'',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_OdblokowanieZlecen=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo do odblokowania zleceń'',&#xD;
        CASE &#xD;
        WHEN OPE.Ope_KotrolaCzesciPobranych=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Kontrola części pobranych'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_PrawoDoPobrCzesciMagSerw=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo do pobrania części z mag. serwisowego'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_PrawoDoPobrCzesciMagLok=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo do pobrania części z mag. lokalnych'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaDokMMzMagMob=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada wystawiania dokumentów MM z magazynu mobilnego'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_PrawoEksportuJPK=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo eksportu plików JPK'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_PrawoScalaniaKnt=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo do łączenia kart kontrahentów'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_ZmianaAtrNaZatwDok=1 THEN ''Tak'' &#xD;
        ELSE ''Nie''&#xD;
    END AS ''Zmiana atrybutów na zatwierdzonym dokumencie '',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaVatDoVat7=1 THEN ''ostrzeżenie''&#xD;
        WHEN OPE.Ope_BlokadaVatDoVat7=1 THEN ''blokada''  &#xD;
        ELSE ''brak''&#xD;
    END AS ''Blokada zmiany dokumentów z VAT-7'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_ZmianaProcesuDomyslnego=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Prawo zamiany procesu domyślnego'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_AktualizacjaKntHaMag=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Aktualizacja kontrahenta na dokumencie'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaAnulowaniaHaMag=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada anulowania dokumentu'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaPonownejFiskFAPA=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada ponownej fiskalizacji FA i PA'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaFAPAdoBufora=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada zapisu FA i PA do bufora'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaZmianCenFA=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada zmiany cen FA, WZ, WKA'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaZmianCenFPF=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada zmiany cen PF'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaZmianCenFZ=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada zmiany cen FZ, PZ, PKA'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaZmianCenPA=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada zmiany cen PA'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaZmianCenRO=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada zmiany cen RO'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaZmianCenZD=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada zmiany cen ZD'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_ZakazCenyZak=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Zakaz dostępu do cen zakupu'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_BlokadaZmianyKwotyWplaty=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Blokada zmiany kwoty wpłaty do dokumentów '',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_RozliczanieZListyHaMag=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Rozliczanie dokumentów z poziomu listy'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_PlatnoscNaWZ=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Płatność do WZ '',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_MinMarzaHaMag=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Sprzedaż poniżej min. marży / maks. marży'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_ZapisFAPApoWydruku=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Zapisywanie FA i PA po wydruku na trwałe'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_ZmianaLimituKred=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Zmiana Limitu kredytu na karcie kontrahenta'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_ZmianaOpisuHaMag=1 THEN ''Tak''&#xD;
        ELSE ''Nie''&#xD;
    END AS ''Zmiana opisu i osoby odbierającej na dok.'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_PlatnosciSprzedazTrwaly=0 THEN ''Ostrzeżenie''&#xD;
        ELSE ''Blokada''&#xD;
    END AS ''Kontrola płatności - Zapis na trwałe'',&#xD;
    CASE &#xD;
        WHEN OPE.Ope_PlatnosciSprzedazBufor=0 THEN ''Ostrzeżenie''&#xD;
        WHEN OPE.Ope_PlatnosciSprzedazBufor=1 THEN ''Blokada''&#xD;
        ELSE ''Brak''&#xD;
    END AS ''Kontrola płatności - Zapis do bufora'',&#xD;
    GETDATE() AS ''Data Analizy''&#xD;
FROM ' +@Operatorzy +' OPE&#xD;
LEFT JOIN (&#xD;
SELECT  OPE.Ope_OpeID,&#xD;
        null as Bmo_SerwerKlucza,&#xD;
        BAZ.Baz_Nazwa,&#xD;
        OPE.Ope_ModulKB,&#xD;
        OPE.Ope_ModulKBP,&#xD;
        OPE.Ope_ModulFA,&#xD;
        OPE.Ope_ModulMAG,&#xD;
        OPE.Ope_ModulHAP,&#xD;
        OPE.Ope_ModulCRM,&#xD;
        OPE.Ope_ModulCRMP,&#xD;
        OPE.ope_ModulSRW,&#xD;
        OPE.Ope_ModulOBD,&#xD;
        OPE.Ope_ModulKP,&#xD;
        OPE.Ope_ModulST,&#xD;
        OPE.Ope_ModulKH,&#xD;
        OPE.Ope_ModulKHP,&#xD;
        OPE.Ope_ModulPK,&#xD;
        OPE.Ope_ModulPKXL,&#xD;
        OPE.Ope_ModulANL,&#xD;
        OPE.Ope_PelneMenu,&#xD;
        OPE.Ope_ModulBIU&#xD;
&#xD;
FROM ' +@Operatorzy +' OPE&#xD;
CROSS JOIN '+ @Bazy +' BAZ&#xD;
LEFT JOIN '+ @BazZakazy +' BZA ON OPE.Ope_OpeID = BZA.BZa_OpeID AND BAZ.Baz_BazID = BZA.BZa_BazID&#xD;
LEFT JOIN '+ @BazModulyOperatora +' BMO ON OPE.Ope_OpeID = BMO.Bmo_OpeID AND BAZ.Baz_BazID = BMO.Bmo_BazID&#xD;
WHERE BZA.BZa_BZaID IS NULL AND BMO_BmoId IS NULL&#xD;
&#xD;
UNION &#xD;
&#xD;
SELECT  OPE.Ope_OpeID,&#xD;
        BMO.BMO_SerwerKlucza,&#xD;
        BAZ.Baz_Nazwa,&#xD;
        BMO.Bmo_ModulKB,&#xD;
        BMO.Bmo_ModulKBP,&#xD;
        BMO.Bmo_ModulFA,&#xD;
        BMO.BMO_ModulHA,&#xD;
        BMO.Bmo_ModulHAP,&#xD;
        BMO.Bmo_ModulCRM,&#xD;
        BMO.Bmo_ModulCRMP,&#xD;
        BMO.Bmo_ModulSRW,&#xD;
        BMO.Bmo_ModulOBD,&#xD;
        BMO.Bmo_ModulKP,&#xD;
        BMO.Bmo_ModulST,&#xD;
        BMO.Bmo_ModulKH,&#xD;
        BMO.Bmo_ModulKHP,&#xD;
        BMO.Bmo_ModulPK,&#xD;
        BMO.BMO_ModulPKP,&#xD;
        BMO.BMO_ModulANL,&#xD;
        BMO.BMO_ModulANLP,&#xD;
        OPE.Ope_ModulBIU&#xD;
&#xD;
FROM ' +@Operatorzy +' OPE&#xD;
JOIN '+ @BazModulyOperatora +' BMO ON OPE.Ope_OpeID = BMO.Bmo_OpeID&#xD;
JOIN '+ @Bazy +' BAZ ON BMO.BMO_BazID = BAZ.Baz_BazID&#xD;
) BMO ON OPE.Ope_OpeID = BMO.Ope_OpeID'&#xD;
&#xD;
PRINT(@SQL)&#xD;
EXEC(@SQL)&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QLNy8SvsWvjndP4rYWmIrmw65/eZ7QPiim3cKUThrJOp91uo2s2QytZVCI0ahIBHPzdhq77ZDLGRNSgOfEiR3jlpVwvy8aMkH6D7Mll/DUKeUpEytYiMEuLvbIn5xaiIgG2BnywjWl2wxHyPhFcde0IDBPjD9fe6frUcHEqLqHbYqnC/e0UAXPHsaaSxo5szyYRG9qWqaUJQ==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Ilość Wystapień" caption="Ilość Wystapień" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Operator Imię i Nazwisko" caption="Operator Imię i Nazwisko" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Kod" caption="Operator Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Baza firmowa" caption="Baza firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Serwer klucza" caption="Serwer klucza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Administrator" caption="Administrator" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Niektywny" caption="Niektywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Moduł Kasa Bank " caption="Moduł Kasa Bank " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Moduł Kasa Bank Plus " caption="Moduł Kasa Bank Plus " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Moduł Faktury" caption="Moduł Faktury" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Moduł Handel Plus" caption="Moduł Handel Plus" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Moduł CRM" caption="Moduł CRM" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Moduł CRM Plus" caption="Moduł CRM Plus" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Moduł Serwis" caption="Moduł Serwis" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Moduł Obieg dokumentów" caption="Moduł Obieg dokumentów" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Moduł Książka Podatkowa" caption="Moduł Książka Podatkowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Moduł Środki Trwałe" caption="Moduł Środki Trwałe" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Moduł Księga Handlowa" caption="Moduł Księga Handlowa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Moduł Księga Handlowa Plus" caption="Moduł Księga Handlowa Plus" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Moduł Płace i Kadry" caption="Moduł Płace i Kadry" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Prawo zmiany zapisów k/b w zamkniętych raportach" caption="Prawo zmiany zapisów k/b w zamkniętych raportach" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo do akceptowanie poleceń wyjazdu i rozliczenia delegacji" caption="Prawo do akceptowanie poleceń wyjazdu i rozliczenia delegacji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawa operacji na księdze głównej" caption="Prawa operacji na księdze głównej" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Księgowanie rejestrów sprzedaży przez bufor " caption="Księgowanie rejestrów sprzedaży przez bufor " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Księgowanie rejestrów zakupów przez bufor " caption="Księgowanie rejestrów zakupów przez bufor " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Księgowanie amortyzacji przez bufor " caption="Księgowanie amortyzacji przez bufor " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Księgowanie wypłat przez bufor " caption="Księgowanie wypłat przez bufor " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Księgowanie innych ewidencji przez bufor" caption="Księgowanie innych ewidencji przez bufor" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo zmiany dokumentów wyeksportowanych" caption="Prawo zmiany dokumentów wyeksportowanych" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo importu zapisów k/b do otwartych raportów" caption="Prawo importu zapisów k/b do otwartych raportów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo modyfikacji procesów" caption="Prawo modyfikacji procesów" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Prawo dostępu do skrzynki innych operatorów" caption="Prawo dostępu do skrzynki innych operatorów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrola płatności na dokumentach WZ" caption="Kontrola płatności na dokumentach WZ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Administrator Analiz BI" caption="Administrator Analiz BI" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dostęp do subskrypcji Analiz BI" caption="Dostęp do subskrypcji Analiz BI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo dodawania pól do Analiz BI " caption="Prawo dodawania pól do Analiz BI " type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Prawo drukowania Analiz BI " caption="Prawo drukowania Analiz BI " type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Prawo eksportu Analiz BI" caption="Prawo eksportu Analiz BI" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Prawo do modyfikacji treści zapytania Analizy BI" caption="Prawo do modyfikacji treści zapytania Analizy BI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo do importu definicji raportu Analiz BI" caption="Prawo do importu definicji raportu Analiz BI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo do usuwania e-maili" caption="Prawo do usuwania e-maili" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czy operator ma prawo dostępu do kont email innych operatorów" caption="Czy operator ma prawo dostępu do kont email innych operatorów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo do odblokowania zleceń" caption="Prawo do odblokowania zleceń" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrola części pobranych" caption="Kontrola części pobranych" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo do pobrania części z mag. serwisowego" caption="Prawo do pobrania części z mag. serwisowego" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo do pobrania części z mag. lokalnych" caption="Prawo do pobrania części z mag. lokalnych" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada wystawiania dokumentów MM z magazynu mobilnego" caption="Blokada wystawiania dokumentów MM z magazynu mobilnego" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo eksportu plików JPK" caption="Prawo eksportu plików JPK" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo do łączenia kart kontrahentów" caption="Prawo do łączenia kart kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zmiana atrybutów na zatwierdzonym dokumencie " caption="Zmiana atrybutów na zatwierdzonym dokumencie " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada zmiany dokumentów z VAT-7" caption="Blokada zmiany dokumentów z VAT-7" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Prawo zamiany procesu domyślnego" caption="Prawo zamiany procesu domyślnego" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Aktualizacja kontrahenta na dokumencie" caption="Aktualizacja kontrahenta na dokumencie" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada anulowania dokumentu" caption="Blokada anulowania dokumentu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada ponownej fiskalizacji FA i PA" caption="Blokada ponownej fiskalizacji FA i PA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada zapisu FA i PA do bufora" caption="Blokada zapisu FA i PA do bufora" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada zmiany cen FA, WZ, WKA" caption="Blokada zmiany cen FA, WZ, WKA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada zmiany cen PF" caption="Blokada zmiany cen PF" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada zmiany cen FZ, PZ, PKA" caption="Blokada zmiany cen FZ, PZ, PKA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada zmiany cen PA" caption="Blokada zmiany cen PA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada zmiany cen RO" caption="Blokada zmiany cen RO" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada zmiany cen ZD" caption="Blokada zmiany cen ZD" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakaz dostępu do cen zakupu" caption="Zakaz dostępu do cen zakupu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Blokada zmiany kwoty wpłaty do dokumentów " caption="Blokada zmiany kwoty wpłaty do dokumentów " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rozliczanie dokumentów z poziomu listy" caption="Rozliczanie dokumentów z poziomu listy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Płatność do WZ " caption="Płatność do WZ " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż poniżej min. marży / maks. marży" caption="Sprzedaż poniżej min. marży / maks. marży" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zapisywanie FA i PA po wydruku na trwałe" caption="Zapisywanie FA i PA po wydruku na trwałe" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zmiana Limitu kredytu na karcie kontrahenta" caption="Zmiana Limitu kredytu na karcie kontrahenta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zmiana opisu i osoby odbierającej na dok." caption="Zmiana opisu i osoby odbierającej na dok." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrola płatności - Zapis na trwałe" caption="Kontrola płatności - Zapis na trwałe" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrola płatności - Zapis do bufora" caption="Kontrola płatności - Zapis do bufora" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport operatorów wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport prezentuje uprawnienia Operatorów do modułów na poszczególnych bazach oraz uprawnienia ustawione w parametrach karty Operatora.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.Operatorzy - tabela zawierająca operatorów wraz z parametrami oraz ogólnymi uprawnieniami&#xD;
CDN.BazModulyOperatora - tabela zawierająca uprawnienia do modułów poszczególnych baz&#xD;
CDN.Bazy - tabela zawierająca informację o bazach&#xD;
CDN.BazZakazy - tabela zawierająca zakazy operatorów na poszczególnych bazach</a:description><a:id>22</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>22. Raport Operatorów</a:mainLinkName><a:modifiedOn>2024-09-27T17:59:15.207</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2017-10-19T15:39:37.437</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/*&#xD;
* Raport Sprzedaży  z Opisem Analitycznym&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @selectwymiary varchar(max)&#xD;
declare @select4 varchar(max)&#xD;
declare @select5 varchar(max)&#xD;
declare @select6 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'      &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'  &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]'&#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Wyliczanie wymiarow na dokumentach&#xD;
SELECT Wyy_wyyid ID,isnull(wyy_nazwa,Wyy_Kod) Nazwa INTO #tmproots from cdn.Wymiary  where wyy_parentid = 0&#xD;
declare @wymiary varchar(max)&#xD;
SET @wymiary = ''&#xD;
&#xD;
;WITH g(nazwa, kod, ID,parent,RootID,Wyy_D002,aktywny, poziom, sciezka,typ)&#xD;
AS&#xD;
(&#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,Wyy_D002,Wyy_aktywny, 0 as poziom, convert(nvarchar(1024), '') as sciezka,Wyy_TypWymiaru&#xD;
      FROM cdn.Wymiary &#xD;
      WHERE Wyy_ParentID = 0 &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,p.Wyy_D002,Wyy_aktywny, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.wyy_kod) as sciezka,Wyy_TypWymiaru&#xD;
      FROM g p&#xD;
      JOIN cdn.Wymiary c&#xD;
      ON c.Wyy_ParentID = p.ID &#xD;
      WHERE c.Wyy_ParentID &lt;&gt; 0 &#xD;
)     &#xD;
SELECT  g.*,WyW_SlownikId, WyW_DokumentId, WyW_LpPozycji, WYW_GUID, WyW_DokumentTyp,WyW_Procent,WyW_Kwota&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where  W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
INTO #tmpWymiary FROM g LEFT JOIN cdn.WymiaryWartosci W ON ID = WyW_WyyId&#xD;
WHERE  Wyy_D002 = 1 And WyW_DokumentTyp IN (2,6)&#xD;
&#xD;
insert into #tmpWymiary &#xD;
SELECT Coalesce(Knt_Nazwa1,Kat_KodSzczegol,Acc_Nazwa) nazwa ,Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) kod,ID-10000000,ID,RootID,Wyy_D002,aktywny,poziom + 1,sciezka +'\'+Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) sciezka,typ,wyw_slownikid,WyW_DokumentId,WyW_LpPozycji,WyW_GUID,WyW_DokumentTyp,wyw_procent,wyw_kwota,IloscPozycji &#xD;
FROM #tmpWymiary &#xD;
LEFT JOIN cdn.Konta on Typ = 3 and WyW_SlownikId = acc_accid&#xD;
LEFT JOIN cdn.Kontrahenci on typ = 4 and WyW_SlownikId = Knt_KntId&#xD;
Left join cdn.Kategorie on typ = 2 and WyW_SlownikId = kat_katid&#xD;
WHERE typ &lt;&gt; 1 and Wyw_SlownikId &lt;&gt;0&#xD;
&#xD;
&#xD;
update X&#xD;
set X.IloscPozycji = (select count(*) from #tmpWymiary X1 where X1.WYW_GUID = X.WYW_GUID) --X.IloscPozycji * &#xD;
from  #tmpWymiary X&#xD;
where WyW_LpPozycji = 0&#xD;
&#xD;
update X&#xD;
set X.IloscPozycji = 1&#xD;
from  #tmpWymiary X&#xD;
where  X.IloscPozycji = 0&#xD;
&#xD;
while exists (select * from #tmproots)&#xD;
begin&#xD;
declare @TableID int&#xD;
declare @TableName Varchar(100)&#xD;
&#xD;
    select top 1 @TableID = ID&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
     Select top 1 @TableName = Nazwa&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpWymiary&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
&#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= Parent WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ ' = kod WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
						SET @sql = N' ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path Varchar(200)'&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path = sciezka WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + '= p.ID &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
                SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parent AS nvarchar)&#xD;
                    ELSE CAST(p.parent AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= p.id &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
                EXEC(@sql)&#xD;
&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
&#xD;
SET @wymiary =concat(@wymiary,',"',CAST(@TableName AS nvarchar),' Poziom ', LTRIM(@i),'" = CASE WHEN Wym.Poziom',LTRIM(@i),'_',CAST(@TableID AS nvarchar),' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Wym.Poziom',LTRIM(@i),'_',CAST(@TableID AS nvarchar),' END')&#xD;
&#xD;
IF (@i=@poziom_max) &#xD;
	set @wymiary =CONCAT (@wymiary, ',"',@TableName,' Kompletny ', '" = CASE WHEN Wym.Poziom' ,LTRIM(@i) ,'_',@TableID ,'_path',' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Wym.Poziom' , LTRIM(@i)  ,'_',@TableID ,'_path', ' END')&#xD;
      &#xD;
   set @i = @i + 1&#xD;
end&#xD;
    delete #tmproots&#xD;
    where ID = @TableID&#xD;
&#xD;
end&#xD;
DROP TABLE #tmproots&#xD;
&#xD;
delete from #tmpWymiary  where ID &gt; 0 and typ &lt;&gt; 1 and WyW_SlownikId &lt;&gt; 0&#xD;
&#xD;
ALTER TABLE #tmpWymiary&#xD;
DROP COLUMN nazwa,aktywny,kod,id,parent,rootID,Wyy_D002,poziom,sciezka,Wyw_DokumentTyp,typ,wyw_slownikid&#xD;
ALTER TABLE #tmpWymiary&#xD;
ADD  [Ver] INT&#xD;
UPDATE #tmpWymiary SET [Ver] = 1&#xD;
&#xD;
&#xD;
DECLARE @ColNames VARCHAR(MAX)&#xD;
DECLARE @SQLGrouper VARCHAR(MAX) &#xD;
SELECT @ColNames = COALESCE (@ColNames + ', ', '') + 'MAX(' + name +') AS ' +name&#xD;
FROM    tempdb.sys.columns &#xD;
WHERE  object_id = Object_id('tempdb..#tmpWymiary')&#xD;
AND column_id &gt;18&#xD;
and name &lt;&gt; 'Ver'&#xD;
&#xD;
SET @SQLGrouper = 'SELECT Wyw_DokumentID,Wyw_LPPozycji,Wyw_Guid,Wyw_Procent,Wyw_Kwota,IloscPozYcji, '+ @ColNames+' , ver+1  FROM #tmpWymiary &#xD;
GROUP BY Wyw_Guid,Wyw_DokumentID,Wyw_LPPozycji,Wyw_Procent,Wyw_Kwota,IloscPozYcji,ver'&#xD;
INSERT  INTO #tmpWymiary exec (@SQLGrouper)&#xD;
&#xD;
DELETE FROM #tmpWymiary WHERE [Ver] = 1&#xD;
&#xD;
 SELECT TRE.TrE_TrEId TRE, TRERel.TrE_TreId TRERel&#xD;
                   INTO #tmpMarza   FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = tre.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu  NOT IN (&#xD;
					318&#xD;
						,309&#xD;
						,308&#xD;
						,301&#xD;
						,304&#xD;
						,317&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 307&#xD;
						AND TrR_TrNTyp = 306&#xD;
						)&#xD;
					AND NOT (&#xD;
						TrR_FaTyp = 306&#xD;
						AND TrR_TrNTyp = 307&#xD;
						)&#xD;
					AND TrR_FaTyp != 320&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa],  DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Pozycji],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa], &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
    ISNULL(kat4.Kat_KodSzczegol, ''(PUSTA)'') [Produkt Kategoria],&#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
    TR.Tre_TwrNazwa [Produkt Nazwa z Faktury],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    KCN_Kod [Produkt Kod CN],&#xD;
    Twr_Kod [Produkt Kod], &#xD;
    Twr_NumerKat [Produkt Numer Katalogowy], CAST(Twr_Opis as VARCHAR(1024)) [Produkt Opis], poz.sciezka [Produkt Pełna Nazwa Grupy], &#xD;
    Tre_Lp [Produkt Lp.],&#xD;
    CASE WHEN TrE_Kaucja = 1 THEN ''TAK'' ELSE ''NIE'' END [Produkt Kaucja], Twr_Jm [Jednostka Miary],  &#xD;
    Mag_Symbol [Magazyn Nazwa],&#xD;
    ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
    CASE &#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
    END [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
        'set @select2='&#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    TR.TrE_WartoscNetto*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Wartość], TR.TrE_WartoscBrutto*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Wartość Brutto], TR.TrE_WartoscNettoWal*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Wartość Waluta], TR.TrE_Ilosc*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Ilość], &#xD;
    ((CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END) * (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) )* coalesce(Wym.IloscPozycji,1.0) [Koszt Zakupu], &#xD;
    (TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)))*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Marża],&#xD;
    (TrE_Ilosc * (TrE_Cena0WD - ([TrE_CenaWWD]/ISNULL(NULLIF(([TrE_JMPrzelicznikL]*[TrE_JMPrzelicznikM]),0),1))) * TrE_KursL / ISNULL(NULLIF(TrE_KursM,0),1))*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Rabat] &#xD;
    ,TR.TrE_Lp  [Produkt Pozycja Dokumentu]&#xD;
        ,wym.Wyw_Procent AS [Wymiar Procent]&#xD;
    ,wym.WyW_Kwota AS [Wymiar Wartość]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności]&#xD;
*/  &#xD;
&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Nazwa __PROCID__Magazyny__], Mag_MagId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
set @selectwymiary = CONCAT(  @kolumny, @atrybuty,  @atrybutyDok, @atrybutyTwr, @atrybutyPoz, @wymiary)&#xD;
       &#xD;
set @select3 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=knt1.Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.KodyCN on Twr_KCNId = KCN_KCNId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
    LEFT JOIN #tmpWymiary wym on wym.WyW_DokumentId = TrN_TrNID and (wym.WyW_LpPozycji =  Tre_Lp or wym.WyW_LpPozycji = 0) &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
&#xD;
     LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN (-1,302,305)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrE_UslugaZlozonaId = 0&#xD;
'set @select4 = '&#xD;
UNION ALL&#xD;
&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba dokumentów],&#xD;
    TrN_NumerPelny [Dokument Numer], &#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
    dd.DDf_Symbol [Dokument Symbol],    &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    ISNULL(NULLIF(TrN_Waluta, ''''),@Wal) [Waluta], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ''(PUSTA)'' [Kategoria Szczegółowa z Pozycji],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ''(PUSTA)'' [Kategoria Ogólna z Pozycji],    &#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],   &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(pod1.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto],&#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], ISNULL(NULLIF(pod1.Pod_NIP, ''''),''(BRAK)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Pierwotny Kategoria],&#xD;
    CASE knt1.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId) [Liczba Kontrahentów], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod],&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    DB_NAME()+''_''+convert(Varchar(10),pod3.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod3.Pod_PodId)  [Liczba Odbiorców], &#xD;
    pod3.Pod_Nazwa1 [Odbiorca Nazwa], &#xD;
    pod3.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod3.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo], ISNULL(NULLIF(pod3.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod3.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod3.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa], &#xD;
    CASE knt2.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod4.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk2.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Odbiorca Opiekun],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    null  [Liczba Produktów], &#xD;
    ''(PUSTA)'' [Produkt Kategoria],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa],&#xD;
    ''Korekta zbiorcza'' [Produkt e-Sklep],&#xD;
    ''Korekta zbiorcza'' [Produkt Nazwa z Faktury],&#xD;
    ''(NIEPRZYPISANE)'' [Produkt PKWiU],&#xD;
    ''(BRAK)'' [Produkt Dostawca],&#xD;
    ''(BRAK)'' [Produkt Aktywny],&#xD;
    ''(BRAK)'' [Produkt Kod CN],&#xD;
    ''Korekta zbiorcza'' [Produkt Kod],             &#xD;
    ''Korekta zbiorcza'' [Produkt Numer Katalogowy], ''Korekta zbiorcza'' [Produkt Opis], ''Korekta zbiorcza'' [Produkt Pełna Nazwa Grupy], &#xD;
    NULL [Produkt Lp.],&#xD;
    ''NIE'' [Produkt Kaucja], ''(BRAK)'' [Jednostka Miary], &#xD;
    ''(BRAK)'' [Magazyn Nazwa], &#xD;
    ''(BRAK)'' [Produkt Producent], ''(BRAK)'' [Produkt Marka], ''Korekta zbiorcza'' [Produkt Typ],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Dziś],&#xD;
    CASE WHEN DATEDIFF(day, TrN_DataOpe, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3)+6) / 7) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(TrN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(TrN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(TrN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Aktualny Miesiąc Poprzedni],&#xD;
    GETDATE() [Czas Aktualny Data],&#xD;
    TrN_RazemNetto*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Wartość], TrN_RazemBrutto*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Wartość Brutto], TrN_RazemNettoWal*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Wartość Waluta], &#xD;
    0 [Sprzedaż Ilość], KosztWyliczony.Koszt*coalesce(Wym.wyw_procent*0.01,1.0) [Koszt Zakupu], (TrN_RazemNetto - KosztWyliczony.Koszt)*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Marża],&#xD;
    TrN_RabatWartosc*coalesce(Wym.wyw_procent*0.01,1.0) [Sprzedaż Rabat]&#xD;
    ,NULL [Produkt Pozycja Dokumentu]&#xD;
    ,wym.Wyw_Procent AS [Wymiar Procent]&#xD;
    ,wym.WyW_Kwota AS [Wymiar Wartość]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
*/  &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku] &#xD;
    ,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień]&#xD;
    ,(datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
    ,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ [Termin Płatności Tydzień Roku]&#xD;
    ,MONTH(TrN_Termin) [Termin Płatności Miesiąc], DATEPART(quarter, TrN_Termin) [Termin Płatności Kwartał], YEAR(TrN_Termin) [Termin Płatności Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], pod3.Pod_PodId [Odbiorca Nazwa __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], pod3.Pod_PodId [Odbiorca Kod __ORGID__],'''+@bazaFirmowa+''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], TrN_TrNId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], TrN_TrNId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,30392 [Magazyn Nazwa __PROCID__Magazyny__], TrN_TrNId [Magazyn Nazwa __ORGID__],'''+@bazaFirmowa+''' [Magazyn Nazwa __DATABASE__]&#xD;
'&#xD;
       SET @sELECT5 = concat( @kolumny, @atrybuty, @atrybutyDok, @atrybutyTwr2, @atrybutyPoz2,  @wymiary)&#xD;
       &#xD;
set @select6 = &#xD;
' FROM cdn.TraNag &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrN_PodID=knt1.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrN_PodID= pod1.Pod_PodId AND TrN_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod3 ON TrN_OdbID= pod3.Pod_PodId AND TrN_OdbiorcaTyp = pod3.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
         LEFT OUTER JOIN CDN.Kontrahenci knt2 ON TrN_OdbId = knt2.Knt_KntId AND TrN_OdbiorcaTyp = 1&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod4 ON knt2.Knt_OpiekunId = pod4.Pod_PodId AND knt2.Knt_OpiekunTyp = pod4.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON knt1.Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr OdbAtr ON pod3.Pod_PodId = OdbAtr.KnA_PodmiotId AND pod3.Pod_PodmiotTyp = OdbAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON 0 = 1    &#xD;
    LEFT JOIN #tmpWymiary wym on wym.WyW_DokumentId = TrN_TrNID &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk2 ON knt2.Knt_OpiekunId = opk2.Ope_OpeId AND knt2.Knt_OpiekunTyp = 8&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.FormyPlatnosci ON TrN_FPlId = FPl_FPlId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	&#xD;
 LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE  WHEN TrS_Rodzaj IN (&#xD;
                            312000&#xD;
                            ,312008&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        AND TrS_ZwrId IS NULL&#xD;
                        THEN 0&#xD;
                    WHEN (&#xD;
                            TrS_Rodzaj = 308000&#xD;
                            OR TrS_Rodzaj = 308011&#xD;
                            )&#xD;
                        AND TrS_Ilosc &lt; 0&#xD;
                        THEN 0&#xD;
                    ELSE TrS_Wartosc&#xD;
                    END), 0) AS Koszt&#xD;
						   	,TRE.TrE_TrNId&#xD;
							,TREWAL.TRE_Waluta&#xD;
							,TREWAL.TrE_KursL KursZakL&#xD;
							,TREWAL.Tre_KursM KursZakM&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE, TRERel&#xD;
                     FROM #tmpMarza TRE&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
			JOIN CDN.TraElem	AS TREWAL	ON TREWAL.TrE_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_Trnid,TREWAL.TRE_Waluta,TREWAL.TrE_KursL,TREWAL.Tre_KursM&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrNId = Trn_Trnid&#xD;
WHERE&#xD;
TRN_Rodzaj = 302010&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
&#xD;
--print (@select5)&#xD;
exec (@select + @select2+@selectwymiary + @select3 +@select4 + @select5 +@select6 )&#xD;
&#xD;
--select * from #tmpWymiary&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
drop table #tmpWymiary&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jzDwJgFJoAzREF9NpiTvD7JPaMMU+LfS6ewgmq9kAP6qcqvE25r7AOePFN3U68zd3f4ZCU/uYVcSX601vEYGiZ7T3be4TMftfLMkcbDZWuSOUcEuJiTAnk9R9Z5uxqTmH</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Odbiorców" caption="Liczba Odbiorców" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Opiekun" caption="Odbiorca Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod CN" caption="Produkt Kod CN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Numer Katalogowy" caption="Produkt Numer Katalogowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Lp." caption="Produkt Lp." type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kaucja" caption="Produkt Kaucja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Dziś" caption="Czas Aktualny Dziś" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Wczoraj" caption="Czas Aktualny Wczoraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Tydzień" caption="Czas Aktualny Tydzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc" caption="Czas Aktualny Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Czas Aktualny Miesiąc Poprzedni" caption="Czas Aktualny Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość" caption="Sprzedaż Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta" caption="Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża" caption="Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Rabat" caption="Sprzedaż Rabat" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR PARTII" caption="Produkt Atrybut NR PARTII" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAZNOSCI" caption="Produkt Atrybut DATA WAZNOSCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR PARTII" caption="Pozycja Atrybut NR PARTII" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAZNOSCI" caption="Pozycja Atrybut DATA WAZNOSCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wymiar Wartość" caption="Wymiar Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wymiar Procent" caption="Wymiar Procent" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Sprzedaży z Opisami analitycznymi wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o sprzedaży w firmie. Uwzględnione są opisy analityczne dokumentów. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Analizy oparte są o faktury sprzedaży, paragony nieskojarzone z fakturą sprzedaży i dokumenty &#xD;
skojarzone. Niebrane pod uwagę są natomiast następujące dokumenty pierwotne a także dokumenty anulowane.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (faktur, paragonów itp.). &#xD;
TraElem - Tabela z elementami dokumentów (faktur, paragonów itp.).&#xD;
WymiaryWartosci - Tabela z wartościami opisu analitycznego dokumentów.</a:description><a:id>23</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>23. Raport Sprzedaży z Opisem Analitycznym</a:mainLinkName><a:modifiedOn>2025-05-23T17:49:07.337</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2017-10-19T15:40:01.117</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów z Opisami Analitycznymi&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.1.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Wyliczanie wymiarow na dokumentach&#xD;
&#xD;
declare @dokumentTyp int&#xD;
&#xD;
SELECT Wyy_wyyid ID, isnull(wyy_nazwa,Wyy_Kod) Nazwa INTO #tmproots from cdn.Wymiary  where wyy_parentid = 0&#xD;
declare @wymiary varchar(max)&#xD;
SET @wymiary = ''&#xD;
&#xD;
;WITH g(nazwa, kod, ID,parent,RootID,Wyy_D001,aktywny, poziom, sciezka,typ)&#xD;
AS&#xD;
(&#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,Wyy_D001,wyy_aktywny, 0 as poziom, convert(nvarchar(1024), '') as sciezka,Wyy_TypWymiaru&#xD;
      FROM cdn.Wymiary &#xD;
      WHERE Wyy_ParentID = 0&#xD;
      --and wyy_wyyid = @TableID&#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,p.Wyy_D001,wyy_aktywny, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.wyy_kod) as sciezka,Wyy_TypWymiaru&#xD;
      FROM g p&#xD;
      JOIN cdn.Wymiary c&#xD;
      ON c.Wyy_ParentID = p.ID &#xD;
      WHERE c.Wyy_ParentID &lt;&gt; 0 &#xD;
)     &#xD;
SELECT  g.*,WyW_SlownikId, WyW_DokumentId, WyW_LpPozycji, WYW_GUID, WyW_DokumentTyp,WyW_Procent,WyW_Kwota&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where  W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
INTO #tmpWymiary FROM g LEFT JOIN cdn.WymiaryWartosci W ON ID = WyW_WyyId&#xD;
WHERE Wyy_D001 = 1&#xD;
&#xD;
insert into #tmpWymiary &#xD;
SELECT Coalesce(Knt_Nazwa1,Kat_KodSzczegol,Acc_Nazwa) nazwa ,Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) kod,ID-10000000,ID,RootID,Wyy_D001,aktywny,poziom + 1,sciezka +'\'+Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) sciezka,typ,wyw_slownikid,WyW_DokumentId,WyW_LpPozycji,WyW_GUID,WyW_DokumentTyp,wyw_procent,wyw_kwota,IloscPozycji &#xD;
FROM #tmpWymiary &#xD;
LEFT JOIN cdn.Konta on Typ = 3 and WyW_SlownikId = acc_accid&#xD;
LEFT JOIN cdn.Kontrahenci on typ = 4 and WyW_SlownikId = Knt_KntId&#xD;
Left join cdn.Kategorie on typ = 2 and WyW_SlownikId = kat_katid&#xD;
WHERE typ &lt;&gt; 1 and Wyw_SlownikId &lt;&gt;0&#xD;
&#xD;
update X&#xD;
set X.IloscPozycji = (select count(*) from #tmpWymiary X1 where X1.WYW_GUID = X.WYW_GUID) --X.IloscPozycji * &#xD;
from  #tmpWymiary X&#xD;
where WyW_LpPozycji = 0&#xD;
&#xD;
update X&#xD;
set X.IloscPozycji = 1&#xD;
from  #tmpWymiary X&#xD;
where  X.IloscPozycji = 0&#xD;
&#xD;
while exists (select * from #tmproots)&#xD;
begin&#xD;
declare @TableID int&#xD;
declare @TableName Varchar(100)&#xD;
&#xD;
    select top 1 @TableID = ID&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
     Select top 1 @TableName = Nazwa&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpWymiary&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
&#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= Parent WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ ' = kod WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N' ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path Varchar(200)'&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path = sciezka WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + '= p.ID &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
                SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parent AS nvarchar)&#xD;
                    ELSE CAST(p.parent AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= p.id &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
                EXEC(@sql)&#xD;
&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
&#xD;
    SET @wymiary = CONCAT(@wymiary,',"',@TableName,' Poziom ',LTRIM(@i),'" = CASE WHEN Wym.Poziom',LTRIM(@i),'_',@TableID,' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Wym.Poziom', LTRIM(@i),'_',@TableID,' END')&#xD;
IF (@i=@poziom_max) &#xD;
	set @wymiary=CONCAT (@wymiary, ',"',@TableName,' Kompletny ', '" = CASE WHEN Wym.Poziom' ,LTRIM(@i) ,'_',@TableID ,'_path',' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Wym.Poziom' , LTRIM(@i)  ,'_',@TableID ,'_path', ' END')&#xD;
       &#xD;
    set @i = @i + 1&#xD;
end&#xD;
    delete #tmproots&#xD;
    where ID = @TableID&#xD;
&#xD;
end&#xD;
DROP TABLE #tmproots&#xD;
&#xD;
delete from #tmpWymiary  where ID &gt; 0 and typ &lt;&gt; 1 and WyW_SlownikId &lt;&gt; 0&#xD;
&#xD;
ALTER TABLE #tmpWymiary&#xD;
DROP COLUMN nazwa,aktywny,kod,id,parent,rootID,Wyy_D001,poziom,sciezka,Wyw_DokumentTyp,typ,wyw_slownikid&#xD;
ALTER TABLE #tmpWymiary&#xD;
ADD  [Ver] INT&#xD;
UPDATE #tmpWymiary SET [Ver] = 1&#xD;
&#xD;
&#xD;
DECLARE @ColNames VARCHAR(MAX)&#xD;
DECLARE @SQLGrouper VARCHAR(MAX) &#xD;
SELECT @ColNames = COALESCE (@ColNames + ', ', '') + 'MAX(' + name +') AS ' +name&#xD;
FROM    tempdb.sys.columns &#xD;
WHERE  object_id = Object_id('tempdb..#tmpWymiary')&#xD;
AND column_id &gt;18&#xD;
and name &lt;&gt; 'Ver'&#xD;
&#xD;
SET @SQLGrouper = 'SELECT Wyw_DokumentID,Wyw_LPPozycji,Wyw_Guid,Wyw_Procent,Wyw_Kwota,IloscPozYcji, '+ @ColNames+' , ver+1  FROM #tmpWymiary &#xD;
GROUP BY Wyw_Guid,Wyw_DokumentID,Wyw_LPPozycji,Wyw_Procent,Wyw_Kwota,IloscPozYcji,ver'&#xD;
INSERT  INTO #tmpWymiary exec (@SQLGrouper)&#xD;
&#xD;
DELETE FROM #tmpWymiary WHERE [Ver] = 1&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT  DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    "Dokument Numer" = TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)''),&#xD;
    "Dokument Symbol" = dd.DDf_Symbol,  &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END,     &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1, &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
&#xD;
                                reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
        ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa,&#xD;
         CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],    &#xD;
       "Produkt Kod" = Twr_Kod,        &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
       "Zakupy Wartość" = TrE_WartoscNetto*coalesce(Wym.Wyw_procent*0.01,1.0), "Zakupy Wartość Brutto" = TrE_WartoscBrutto*coalesce(Wym.Wyw_procent*0.01,1.0),&#xD;
        "Zakupy Wartość Waluta" = TrE_WartoscNettoWal*coalesce(Wym.Wyw_procent*0.01,1.0), "Zakupy Ilość" = TrE_Ilosc*coalesce(Wym.Wyw_procent*0.01,1.0),&#xD;
        ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza]&#xD;
        ,CAST(TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
        ,wym.Wyw_Procent AS [Wymiar Procent]&#xD;
        ,wym.WyW_Kwota AS [Wymiar Wartość]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
    ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
    ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'')&#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ &#xD;
    ,"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe)  &#xD;
    ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/&#xD;
    ,"Data Wystawienia Miesiąc" = MONTH(TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TrN_DataWys), "Data Wystawienia Rok" = YEAR(TrN_DataWys)      &#xD;
    ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/&#xD;
    ,"Termin Płatności Miesiąc" = MONTH(TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TrN_Termin), "Termin Płatności Rok" = YEAR(TrN_Termin)      &#xD;
    ,"Data Analizy" = GETDATE()&#xD;
        ----------KONTEKSTY&#xD;
    ,29047 [Dokument Numer __PROCID__Zakupy__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
        ' + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz + @wymiary &#xD;
      &#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN #tmpWymiary wym on wym.WyW_DokumentId = TrN_TrNID and (wym.WyW_LpPozycji =  Tre_Lp  or  wym.WyW_LpPozycji = 0)&#xD;
WHERE TrN_TypDokumentu=301 AND TrN_Bufor&lt;&gt;-1 AND TrE_Aktywny&lt;&gt;0&#xD;
--and TrN_TRNID = 16870&#xD;
'&#xD;
&#xD;
exec (@select  + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
drop table #tmpWymiary&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wymiar OPIS" caption="Wymiar OPIS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wymiar SŁOWNIK_KONTRAHENT" caption="Wymiar SŁOWNIK_KONTRAHENT" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wymiar Wartość" caption="Wymiar Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wymiar Procent" caption="Wymiar Procent" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Zakupów z Opisami analitycznymi wersja 38.0 (OPTIMA 2025.3.0).&#xD;
&#xD;
Raport zawiera informacje o zakupach w firmie. Uwzględnione są opisy analityczne dokumentów. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Analizy oparte są o faktury zakupu i dokumenty skojarzone.&#xD;
Niebrane pod uwagę są dokumenty anulowane.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (faktur, paragonów itp.). &#xD;
TraElem - Tabela z elementami dokumentów (faktur, paragonów itp.).&#xD;
WymiaryWartosci - Tabela z wartościami opisu analitycznego dokumentów.</a:description><a:id>24</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>24. Raport Zakupów z Opisem Analitycznym</a:mainLinkName><a:modifiedOn>2025-04-14T13:59:11.077</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2017-10-19T15:44:21.2</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Rejestrów Księgowości (KK) z Opisami analitycznymi&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @String varchar(1024)&#xD;
DECLARE @Pos int&#xD;
CREATE TABLE #Keywords (string varchar(100)) &#xD;
DECLARE @Key varchar(100)&#xD;
SET @String = @OKRESOBRACHUNKOWY&#xD;
SET @Pos = 1&#xD;
WHILE (@Pos &gt; 0)&#xD;
BEGIN&#xD;
    SET @Pos = PATINDEX('%,%', @String)&#xD;
    SET @Key = SUBSTRING(@String, 0, @Pos)&#xD;
    IF (@Pos = 0)&#xD;
        BEGIN&#xD;
            INSERT INTO #Keywords (string) VALUES(@String)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN&#xD;
            INSERT INTO #Keywords (string) VALUES(@Key)&#xD;
        END&#xD;
    SET @String = SUBSTRING(@String, @Pos+1, (SELECT LEN(@String)))&#xD;
END &#xD;
&#xD;
SELECT    SUBSTRING(string, 1, CHARINDEX(';', string) - 1) AS year,&#xD;
    SUBSTRING(string, CHARINDEX(';', string) + 1, LEN(string)) AS db into #oob FROM #Keywords &#xD;
&#xD;
DECLARE @Okresobrachunkowy1 VARCHAR(MAX) =&#xD;
(SELECT &#xD;
    STUFF((&#xD;
        SELECT ',' +  CAST(OOb_OObID AS varchar(5))&#xD;
        FROM CDN.OkresyObrach WHERE OOb_OObID in (select year from #oob where db = db_name())&#xD;
        FOR XML PATH(''), TYPE&#xD;
    ).value('.', 'NVARCHAR(MAX)'), 1, 1, '') AS Okresobrachunkowy1)&#xD;
&#xD;
Drop table #oob&#xD;
DROP TABLE #Keywords;&#xD;
&#xD;
--Wyliczanie poziomów kont&#xD;
WITH g(gid, kod, naz, nazB, parId, poziom, nazwa)&#xD;
AS&#xD;
(&#xD;
      SELECT Acc_AccId, Acc_Segment, Acc_Nazwa,  Acc_Nazwa2, Acc_ParId, Acc_Poziom, convert(nvarchar(1024), Acc_Segment) as nazwa&#xD;
      FROM CDN.Konta&#xD;
      WHERE Acc_ParId IS NULL AND cast(Acc_OObId as varchar)  IN ( @Okresobrachunkowy1)&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT Acc_AccId, Acc_Segment, Acc_Nazwa, Acc_Nazwa2, Acc_ParId, Acc_Poziom, convert(nvarchar(1024), p.nazwa + N'-' + c.Acc_Segment) as nazwa&#xD;
      FROM g p&#xD;
             JOIN CDN.Konta c ON c.Acc_ParId = p.gid &#xD;
      WHERE c.Acc_ParId IS NOT NULL AND cast(c.Acc_OObId as varchar)  IN ( @Okresobrachunkowy1)&#xD;
)     &#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt; 0  &#xD;
BEGIN&#xD;
       SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50), Nazwa' + CAST(@poziom AS nvarchar) + N' nvarchar(4000), NazwaB' + CAST(@poziom AS nvarchar) + N' nvarchar(4000)' &#xD;
    EXEC(@sql)&#xD;
&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
             BEGIN&#xD;
                    SET @sql = N'UPDATE #tmpTwrGr&#xD;
                           SET ONr' + CAST(@poziom AS nvarchar) +  '= parId '&#xD;
                    EXEC(@sql)&#xD;
                    &#xD;
                    SET @sql = N'UPDATE #tmpTwrGr&#xD;
                           SET Poziom' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + kod + '')'' ELSE kod END'&#xD;
                    EXEC(@sql)&#xD;
                    &#xD;
                    SET @sql = N'UPDATE #tmpTwrGr&#xD;
                           SET Nazwa' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + naz + '')'' ELSE naz END'&#xD;
                    EXEC(@sql)&#xD;
&#xD;
                    SET @sql = N'UPDATE #tmpTwrGr&#xD;
                           SET NazwaB' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + nazB + '')'' ELSE nazB END'&#xD;
                    EXEC(@sql)&#xD;
&#xD;
             END&#xD;
    ELSE&#xD;
             BEGIN &#xD;
             SET @sql = N'UPDATE c&#xD;
                           SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                                  CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                                        WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(c.kod AS nvarchar) + '')''&#xD;
                                        WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(p.kod AS nvarchar) + '')''&#xD;
                                  ELSE p.kod END)  &#xD;
                           FROM #tmpTwrGr c&#xD;
                           LEFT JOIN #tmpTwrGr p&#xD;
                           ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                    EXEC(@sql)&#xD;
                    &#xD;
                    SET @sql = N'UPDATE c&#xD;
                           SET c.Nazwa' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                                  CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN c.naz&#xD;
                                        WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + c.naz + '')''&#xD;
                                        WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + p.naz + '')''&#xD;
                                  ELSE p.naz END)  ,&#xD;
                                  c.NazwaB' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                                  CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN c.nazB&#xD;
                                        WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + c.nazB + '')''&#xD;
                                        WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + p.nazB + '')''&#xD;
                                  ELSE p.nazB END)  &#xD;
                           FROM #tmpTwrGr c&#xD;
                           LEFT JOIN #tmpTwrGr p&#xD;
                           ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                    EXEC(@sql)&#xD;
       &#xD;
                    SET @sql = N'UPDATE c&#xD;
                           SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                                  CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parId AS nvarchar)&#xD;
                                  ELSE CAST(p.parId AS nvarchar) END)  &#xD;
                           FROM #tmpTwrGr c&#xD;
                           LEFT JOIN #tmpTwrGr p&#xD;
                           ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                           EXEC(@sql)&#xD;
             END&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
declare @select varchar(max), @select2 varchar(max), @select3 varchar(max);&#xD;
declare @kolumny varchar(max), @kolumny2 varchar(max);&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @kolumny2 = ''&#xD;
&#xD;
set @i=1&#xD;
if @i&lt;=@poziom_max  &#xD;
begin&#xD;
       set @kolumny = ', SUBSTRING(Poz.Poziom1, 1, 1) AS [Konto Grupa]'&#xD;
       set @kolumny2 = ', [Konto Grupa]'&#xD;
end&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
       set @kolumny = @kolumny + ', CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END [Konto Struktura Poziom ' + LTRIM(@i) + '] ' +&#xD;
                                                 ', CASE WHEN Poz.Nazwa' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Nazwa' + LTRIM(@i) + ' END [Konto Nazwa Poziom ' + LTRIM(@i) + '] ' +&#xD;
                                                 ', CASE WHEN Poz.NazwaB' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.NazwaB' + LTRIM(@i) + ' END [Konto Nazwa2 Poziom ' + LTRIM(@i) + '] '&#xD;
       set @kolumny2 = @kolumny2 + ', [Konto Struktura Poziom ' + LTRIM(@i) + '] ' + ', [Konto Nazwa Poziom ' + LTRIM(@i) + '] ' + ', [Konto Nazwa2 Poziom ' + LTRIM(@i) + '] '&#xD;
       set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]'  &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Wyliczanie wymiarow na dekretach&#xD;
SELECT Wyy_wyyid ID,isnull(wyy_nazwa,Wyy_Kod) Nazwa INTO #tmproots from cdn.Wymiary  where wyy_parentid = 0&#xD;
declare @wymiary varchar(max)&#xD;
SET @wymiary = ''&#xD;
&#xD;
;WITH g(nazwa, kod, ID,parent,RootID,Wyy_D019,aktywny, poziom, sciezka,typ)&#xD;
AS&#xD;
(&#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,Wyy_D019,wyy_aktywny, 0 as poziom, convert(nvarchar(1024), '') as sciezka,Wyy_TypWymiaru&#xD;
      FROM cdn.Wymiary &#xD;
      WHERE Wyy_ParentID = 0      &#xD;
      --and wyy_wyyid = @TableID&#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,p.Wyy_D019,wyy_aktywny, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.wyy_kod) as sciezka,Wyy_TypWymiaru&#xD;
      FROM g p&#xD;
      JOIN cdn.Wymiary c&#xD;
      ON c.Wyy_ParentID = p.ID &#xD;
      WHERE c.Wyy_ParentID &lt;&gt; 0 &#xD;
)     &#xD;
SELECT  g.*,WyW_SlownikId, WyW_DokumentId, WyW_LpPozycji, WYW_GUID, WyW_DokumentTyp,WyW_Procent,WyW_Kwota,DeE_DeNId DENID,DeE_Lp DeELP,W.WyW_SlownikId kontoID&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where  W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
INTO #tmpWymiary FROM g LEFT JOIN cdn.WymiaryWartosci W ON ID = WyW_WyyId&#xD;
LEFT JOIN CDN.DekretyElem ON DeE_DeNId = W.WyW_DokumentId and DeE_Lp = W.WyW_LpPozycji&#xD;
where   Wyy_D019 = 1&#xD;
&#xD;
insert into #tmpWymiary &#xD;
SELECT Coalesce(Knt_Nazwa1,Kat_KodSzczegol,Acc_Nazwa) nazwa ,Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) kod,ID-10000000,ID,RootID,Wyy_D019,aktywny,poziom + 1,sciezka +'\'+Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) sciezka,typ,wyw_slownikid,WyW_DokumentId,WyW_LpPozycji,WyW_GUID,WyW_DokumentTyp,wyw_procent,wyw_kwota, DENID, DeELP, kontoID,IloscPozycji &#xD;
FROM #tmpWymiary &#xD;
LEFT JOIN cdn.Konta on Typ = 3 and WyW_SlownikId = acc_accid&#xD;
LEFT JOIN cdn.Kontrahenci on typ = 2 and WyW_SlownikId = Knt_KntId&#xD;
Left join cdn.Kategorie on typ = 4 and WyW_SlownikId = kat_katid&#xD;
WHERE typ &lt;&gt; 1 and Wyw_SlownikId &lt;&gt;0&#xD;
&#xD;
&#xD;
&#xD;
update X&#xD;
set X.IloscPozycji = (select count(*) from #tmpWymiary X1 where X1.WYW_GUID = X.WYW_GUID) --X.IloscPozycji * &#xD;
from  #tmpWymiary X&#xD;
--where WyW_LpPozycji = 0&#xD;
&#xD;
update X&#xD;
set X.IloscPozycji = 1&#xD;
from  #tmpWymiary X&#xD;
where  X.IloscPozycji = 0&#xD;
while exists (select * from #tmproots)&#xD;
begin&#xD;
declare @TableID int&#xD;
declare @TableName Varchar(100)&#xD;
&#xD;
    select top 1 @TableID = ID&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
     Select top 1 @TableName = Nazwa&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpWymiary&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
&#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= Parent WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ ' = kod WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N' ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path Varchar(200)'&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path = sciezka WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + '= p.ID &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
                SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parent AS nvarchar)&#xD;
                    ELSE CAST(p.parent AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= p.id &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
                EXEC(@sql)&#xD;
&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
&#xD;
    set @wymiary = CONCAT(@wymiary, ',"',@TableName,' Poziom ', LTRIM(@i), '" = CASE WHEN WymDE.Poziom' ,LTRIM(@i) ,'_',@TableID , ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE WymDe.Poziom' , LTRIM(@i) ,'_',@TableID, ' END')&#xD;
IF (@i=@poziom_max) &#xD;
	set @wymiary=CONCAT (@wymiary, ',"',@TableName,' Kompletny ', '" = CASE WHEN WymDE.Poziom' ,LTRIM(@i) ,'_',@TableID ,'_path',' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE WymDE.Poziom' , LTRIM(@i)  ,'_',@TableID ,'_path', ' END')&#xD;
           &#xD;
	set @i = @i + 1&#xD;
end&#xD;
    delete #tmproots&#xD;
    where ID = @TableID&#xD;
&#xD;
end&#xD;
DROP TABLE #tmproots&#xD;
&#xD;
delete from #tmpWymiary  where ID &gt; 0 and typ &lt;&gt; 1 and WyW_SlownikId &lt;&gt; 0&#xD;
&#xD;
ALTER TABLE #tmpWymiary&#xD;
DROP COLUMN nazwa,kod,id,parent,rootID,Wyy_D019,aktywny,poziom,sciezka,Wyw_DokumentTyp,typ,WyW_SlownikId,kontoid&#xD;
ALTER TABLE #tmpWymiary&#xD;
ADD  [Ver] INT&#xD;
UPDATE #tmpWymiary SET [Ver] = 1&#xD;
&#xD;
DECLARE @ColNames VARCHAR(MAX)&#xD;
DECLARE @SQLGrouper VARCHAR(MAX) &#xD;
SELECT @ColNames = COALESCE (@ColNames + ', ', '') + 'MAX(' + name +') AS ' +name&#xD;
FROM    tempdb.sys.columns &#xD;
WHERE  object_id = Object_id('tempdb..#tmpWymiary')&#xD;
AND column_id &gt;21&#xD;
and name &lt;&gt; 'Ver'&#xD;
&#xD;
SET @SQLGrouper = 'SELECT Wyw_DokumentID,Wyw_LPPozycji,Wyw_Guid,Wyw_Procent,Wyw_Kwota,DENID,DeELP,IloscPozYcji, '+ @ColNames+' , ver+1  FROM #tmpWymiary &#xD;
GROUP BY Wyw_Guid,Wyw_DokumentID,Wyw_LPPozycji,Wyw_Procent,Wyw_Kwota,IloscPozYcji,DENID,DeELP,ver'&#xD;
&#xD;
INSERT  INTO #tmpWymiary exec (@SQLGrouper)&#xD;
&#xD;
DELETE FROM #tmpWymiary WHERE [Ver] = 1&#xD;
&#xD;
SET @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT &#xD;
    [Baza Firmowa],  [Data Księgowania Miesiąc Poprzedni], [Data Księgowania Miesiąc Bieżący] ,&#xD;
    [Data Wystawienia Miesiąc Poprzedni],[Data Wystawienia Miesiąc Bieżący],[Data Operacji Miesiąc Poprzedni],[Data Operacji Miesiąc Bieżący],&#xD;
    [Okres Obrachunkowy], &#xD;
    [Dokument Numer], &#xD;
    [Dokument Element Numer], [Dokument Bufor] [Zatwierdzone/Bufor], [Dziennik], [Dziennik Numer], [Identyfikator Księgowy],  [Konto Pełny Numer], &#xD;
    [Konto Przeciwstawne], [Kategoria Szczegółowa z Elementu], [Kategoria Szczegółowa z Nagłówka], [Kategoria Ogólna z Elementu], [Kategoria Ogólna z Nagłówka],&#xD;
    [Dokument Opis z Elementu], [Dokument Opis z Nagłówka],&#xD;
    [Podmiot Pierwotny Typ], &#xD;
    [Podmiot Pierwotny Kod], &#xD;
    [Podmiot Pierwotny Nazwa], &#xD;
    [Podmiot Pierwotny NIP],&#xD;
    [Podmiot Pierwotny Kraj], [Podmiot Pierwotny Województwo], [Podmiot Pierwotny Powiat],  [Podmiot Pierwotny Gmina], [Podmiot Pierwotny Miasto], [Podmiot Pierwotny z Pozycji],&#xD;
    [Podmiot Typ], [Podmiot Nazwa],&#xD;
    [Podmiot Kod], [Podmiot NIP],&#xD;
    [Podmiot Kraj], [Podmiot Województwo],&#xD;
    [Podmiot Powiat], [Podmiot Gmina],[Podmiot Miasto], [Podmiot z Pozycji],&#xD;
    [Operator Wprowadzający],[Operator Modyfikujący],  &#xD;
    [Rodzaj] [Bilans Otwarcia], [Konto Typ] [Typ Konta], [Konto Typy] [Typy Kont], [Kontrola budżetu] [Kontrola Budżetu], [Konto Rozrachunkowe], [Waluta],&#xD;
    [Obroty Winien]*ISNULL((Wyw_Procent * 0.01),1) [Obroty Wn], &#xD;
	[Obroty Ma]*ISNULL((Wyw_Procent * 0.01),1) [Obroty Ma],&#xD;
	[Obroty Winien Waluta]*ISNULL((Wyw_Procent * 0.01),1) [Obroty Wn Waluta], &#xD;
	[Obroty Ma Waluta]*ISNULL((Wyw_Procent * 0.01),1) [Obroty Ma Waluta],  &#xD;
    [Bilans Otwarcia Ma]*ISNULL((Wyw_Procent * 0.01),1) [Bilans Otwarcia Ma], &#xD;
	[Bilans Otwarcia Winien]*ISNULL((Wyw_Procent * 0.01),1) [Bilans Otwarcia Wn], &#xD;
	[Bilans Otwarcia Ma Waluta]*ISNULL((Wyw_Procent * 0.01),1) [Bilans Otwarcia Ma Waluta],&#xD;
	[Bilans Otwarcia Winien Waluta]*ISNULL((Wyw_Procent * 0.01),1) [Bilans Otwarcia Wn Waluta],&#xD;
    [Plan Wn], [Plan Ma]&#xD;
    ,Wyw_Procent as [Wymiar Procent]&#xD;
    ,Wyw_Kwota as [Wymiar Wartość]&#xD;
&#xD;
    &#xD;
    ----------DATY POINT&#xD;
    ,[Data Księgowania Dzień]&#xD;
    ,[Data Wystawienia Dzień]&#xD;
    ,[Data Operacji Dzień]&#xD;
    /*&#xD;
    ----------DATY ANALIZY&#xD;
    ,[Data Księgowania Dzień], [Data Księgowania Rok], [Data Księgowania Kwartał], [Data Księgowania Miesiąc], [Data Księgowania Tydzień Roku]&#xD;
    ,[Data Wystawienia Dzień], [Data Wystawienia Rok], [Data Wystawienia Kwartał], [Data Wystawienia Miesiąc], [Data Wystawienia Tydzień Roku]&#xD;
    ,[Data Operacji Dzień], [Data Operacji Rok], [Data Operacji Kwartał], [Data Operacji Miesiąc], [Data Operacji Tydzień Roku]&#xD;
    ,[Data Analizy]&#xD;
    ----------KONTEKSTY&#xD;
    ,[Podmiot Nazwa __PROCID__], [Podmiot Nazwa __ORGID__], [Podmiot Nazwa __DATABASE__]&#xD;
    ,[Podmiot Kod __PROCID__Kontrahenci__], [Podmiot Kod __ORGID__], [Podmiot Kod __DATABASE__]&#xD;
    ,[Dokument Numer __PROCID__KH__], [Dokument Numer __ORGID__],[Dokument Numer __DATABASE__]&#xD;
    ,[Podmiot Pierwotny Kod __PROCID__Kontrahenci__], [Podmiot Pierwotny Kod __ORGID__],[Podmiot Pierwotny Kod __DATABASE__]&#xD;
    ,[Podmiot Pierwotny Nazwa __PROCID__], [Podmiot Pierwotny Nazwa __ORGID__],[Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    */&#xD;
    &#xD;
    ' + @kolumny2 + @wymiary +&#xD;
' FROM &#xD;
(SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], REPLACE(CONVERT(VARCHAR(10), DeN_DataDok, 111), ''/'', ''-'') [Data Księgowania Dzień],  YEAR(DeN_DataDok) [Data Księgowania Rok], &#xD;
    DATEPART(quarter, DeN_DataDok) [Data Księgowania Kwartał], MONTH(DeN_DataDok) [Data Księgowania Miesiąc], &#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataDok) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataDok) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataDok) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataDok) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataDok) = MONTH(GETDATE())) AND (YEAR(DeN_DataDok) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Bieżący],&#xD;
&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataDok) / 7 * 7 + 3)+6) / 7 [Data Księgowania Tydzień Roku],&#xD;
    REPLACE(CONVERT(VARCHAR(10), DeN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień],  YEAR(DeN_DataWys) [Data Wystawienia Rok], &#xD;
    DATEPART(quarter, DeN_DataWys) [Data Wystawienia Kwartał], MONTH(DeN_DataWys) [Data Wystawienia Miesiąc], &#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataWys) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataWys) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataWys) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataWys) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Wystawienia Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataWys) = MONTH(GETDATE())) AND (YEAR(DeN_DataWys) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Wystawienia Miesiąc Bieżący],&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataWys) / 7 * 7 + 3)+6) / 7 [Data Wystawienia Tydzień Roku],&#xD;
    REPLACE(CONVERT(VARCHAR(10), DeN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień],  YEAR(DeN_DataOpe) [Data Operacji Rok], &#xD;
    DATEPART(quarter, DeN_DataOpe) [Data Operacji Kwartał], MONTH(DeN_DataOpe) [Data Operacji Miesiąc], &#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Operacji Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataOpe) = MONTH(GETDATE())) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Operacji Miesiąc Bieżący],&#xD;
&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Operacji Tydzień Roku],&#xD;
    GETDATE() [Data Analizy],&#xD;
    OOb_Symbol [Okres obrachunkowy], &#xD;
    &#xD;
    DeN_Dokument [Dokument Numer], &#xD;
    26002 [Dokument Numer __PROCID__KH__], DeN_DeNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__],&#xD;
&#xD;
    DeE_Dokument [Dokument Element Numer], CASE WHEN DeN_Bufor = 0  THEN ''Zatwierdzone'' ELSE ''Bufor'' END [Dokument Bufor], &#xD;
    Dzi_Symbol [Dziennik], CONVERT(VARCHAR(10),DeN_NrKsiegi) [Dziennik Numer], DeN_IdentKsieg [Identyfikator Księgowy], poz.nazwa [Konto pełny numer], DeE_KontoMa [Konto Przeciwstawne],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Elementu], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], &#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Elementu], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka],&#xD;
    ISNULL(DeE_Kategoria, ''(PUSTY)'') [Dokument Opis z Elementu], ISNULL(DeN_Kategoria, ''(PUSTY)'') [Dokument Opis z Nagłówka],&#xD;
    CASE WHEN DeN_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN DeN_PodmiotTyp = 2 THEN ''Bank''&#xD;
         WHEN DeN_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN DeN_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN DeN_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END [Podmiot Pierwotny Typ], &#xD;
&#xD;
    ISNULL(Podmioty.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Kod],&#xD;
    20201 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Podmioty.Pod_PodId [Podmiot Pierwotny Kod __ORGID__], '''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__],&#xD;
    &#xD;
    ISNULL(Podmioty.Pod_Nazwa1, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Nazwa], &#xD;
    20201 [Podmiot Pierwotny Nazwa __PROCID__], Podmioty.Pod_PodId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__],&#xD;
    &#xD;
    ISNULL(Podmioty.Pod_NIP, ''(BRAK)'') [Podmiot Pierwotny NIP],&#xD;
    ISNULL(Podmioty.Pod_Kraj, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Kraj],&#xD;
    ISNULL(Podmioty.Pod_Wojewodztwo, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Województwo], ISNULL(Podmioty.Pod_Powiat, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Powiat], ISNULL(Podmioty.Pod_Gmina, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Gmina],&#xD;
    ISNULL(Podmioty.Pod_Miasto, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Miasto], ISNULL(PodPoz.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny z Pozycji],&#xD;
    CASE WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END AS [Podmiot Typ], &#xD;
&#xD;
    ISNULL(pod5.Pod_Nazwa1, ''(NIEPRZYPISANY)'')  [Podmiot Nazwa], &#xD;
    20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__],&#xD;
    &#xD;
    ISNULL(pod5.Pod_Kod, ''(NIEPRZYPISANY)'')  [Podmiot Kod], &#xD;
    20201 [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__],&#xD;
&#xD;
    ISNULL(pod5.Pod_NIP, ''(BRAK)'')  AS [Podmiot NIP],&#xD;
    ISNULL(pod5.Pod_Kraj, ''(NIEPRZYPISANY)'')  AS [Podmiot Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo],&#xD;
    "Podmiot Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
    "Podmiot Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
    ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot z Pozycji],&#xD;
&#xD;
    ISNULL(op1.Ope_Kod, ''(NIEPRZYPISANY)'') [Operator Wprowadzający], ISNULL(op2.Ope_Kod, ''(NIEPRZYPISANY)'') [Operator Modyfikujący],&#xD;
    ''NIE'' AS [Rodzaj],    &#xD;
    CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 THEN ''Koszty''&#xD;
         WHEN Acc_TypKonta = 4 THEN ''Przychody''&#xD;
         WHEN Acc_TypKonta = 3 THEN ''Aktywno pasywne''&#xD;
         WHEN Acc_TypKonta = 2 THEN ''Pasywa''&#xD;
         WHEN Acc_TypKonta = 1 THEN ''Aktywa''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typ],&#xD;
            CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 OR Acc_TypKonta = 4  THEN ''Wynikowe''&#xD;
         WHEN Acc_TypKonta = 3 OR Acc_TypKonta = 2 OR Acc_TypKonta = 1 THEN ''Bilansowe''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typy],&#xD;
    CASE WHEN Acc_KontrolaBudzetu = 0 THEN ''Brak''&#xD;
         WHEN Acc_KontrolaBudzetu = 1 THEN ''Obroty Wn'' &#xD;
         WHEN Acc_KontrolaBudzetu = 2 Then ''obroty Ma''&#xD;
    END [Kontrola budżetu],&#xD;
    CASE WHEN Acc_Rozrachunkowe = 1 THEN ''TAK'' ELSE ''NIE'' END AS [Konto Rozrachunkowe],&#xD;
    CASE WHEN DeE_Waluta = '''' THEN @Wal ELSE DeE_Waluta END [Waluta],&#xD;
    CASE WHEN DeE_AccWnId IS NOT NULL THEN DeE_Kwota ELSE NULL END [Obroty Winien], NULL [Obroty Ma],&#xD;
    CASE WHEN DeE_AccWnId IS NOT NULL THEN DeE_KwotaWal ELSE NULL END [Obroty Winien Waluta], NULL [Obroty Ma Waluta],&#xD;
    NULL AS [Bilans Otwarcia Ma], NULL  AS [Bilans Otwarcia Winien],&#xD;
    NULL [Bilans Otwarcia Ma Waluta], NULL [Bilans Otwarcia Winien Waluta],&#xD;
    NULL [Plan Wn], NULL [Plan Ma],&#xD;
    DeN_DeNId as DENID, DeE_lp as DeELP '&#xD;
    + @kolumny + &#xD;
' FROM CDN.DekretyNag&#xD;
    JOIN CDN.DekretyElem ON DeE_DeNId = DeN_DeNId AND DeE_AccWnId IS NOT NULL&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat1 ON DeE_KatId = kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat2 ON DeN_KatId = kat2.Kat_KatID&#xD;
    JOIN CDN.Dzienniki ON DeN_DziId = Dzi_DziId&#xD;
    LEFT OUTER JOIN #tmpTwrGr Poz ON DeE_AccWnId = Poz.gid     &#xD;
    LEFT OUTER JOIN CDN.Konta ON DeE_AccWnId = Acc_AccId&#xD;
    JOIN CDN.OkresyObrach ON DeN_OObId = OOb_OObID&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView Podmioty ON DeN_PodmiotId = Podmioty.Pod_PodId AND DeN_PodmiotTyp = Podmioty.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView PodPoz ON DeE_SlownikId = PodPoz.Pod_PodId and DeE_SlownikTyp = PodPoz.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op1 ON DeN_OpeZalID = op1.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' op2 ON DeN_OpeModID = op2.Ope_OpeId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on Podmioty.Pod_GlID = pod5.Pod_PodId and Podmioty.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 on PodPoz.Pod_GlID = pod6.Pod_PodId and PodPoz.Pod_GlKod = pod6.Pod_Kod&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
  WHERE DeN_Typ &lt;&gt; 1 AND Oob_OobId IN ( '+@OKRESOBRACHUNKOWY1+')&#xD;
 &#xD;
UNION ALL &#xD;
&#xD;
SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], REPLACE(CONVERT(VARCHAR(10), DeN_DataDok, 111), ''/'', ''-'') [Data Księgowania Dzień],  YEAR(DeN_DataDok) [Data Księgowania Rok], &#xD;
    DATEPART(quarter, DeN_DataDok) [Data Księgowania Kwartał], MONTH(DeN_DataDok) [Data Księgowania Miesiąc], &#xD;
&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataDok) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataDok) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataDok) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataDok) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataDok) = MONTH(GETDATE())) AND (YEAR(DeN_DataDok) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Bieżący],&#xD;
&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataDok) / 7 * 7 + 3)+6) / 7 [Data Księgowania Tydzień Roku],&#xD;
    REPLACE(CONVERT(VARCHAR(10), DeN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień],  YEAR(DeN_DataWys) [Data Wystawienia Rok], &#xD;
    DATEPART(quarter, DeN_DataWys) [Data Wystawienia Kwartał], MONTH(DeN_DataWys) [Data Wystawienia Miesiąc], &#xD;
&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataWys) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataWys) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataWys) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataWys) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Wystawienia Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataWys) = MONTH(GETDATE())) AND (YEAR(DeN_DataWys) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Wystawienia Miesiąc Bieżący],&#xD;
&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataWys) / 7 * 7 + 3)+6) / 7 [Data Wystawienia Tydzień Roku],&#xD;
    REPLACE(CONVERT(VARCHAR(10), DeN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień],  YEAR(DeN_DataOpe) [Data Operacji Rok], &#xD;
    DATEPART(quarter, DeN_DataOpe) [Data Operacji Kwartał], MONTH(DeN_DataOpe) [Data Operacji Miesiąc], &#xD;
&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataOpe) = MONTH(GETDATE())-1) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN ((MONTH(DeN_DataOpe) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Operacji Miesiąc Poprzedni],&#xD;
    CASE &#xD;
     WHEN (MONTH(DeN_DataOpe) = MONTH(GETDATE())) AND (YEAR(DeN_DataOpe) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Operacji Miesiąc Bieżący],&#xD;
&#xD;
    (datepart(DY, datediff(d, 0, DeN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Operacji Tydzień Roku],&#xD;
    GETDATE() [Data Analizy],&#xD;
    OOb_Symbol [Okres obrachunkowy], &#xD;
    &#xD;
    DeN_Dokument [Dokument Numer], &#xD;
    26002 [Dokument Numer __PROCID__KH__], DeN_DeNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__],&#xD;
&#xD;
    DeE_Dokument [Dokument Element Numer], CASE WHEN DeN_Bufor = 0  THEN ''Zatwierdzone'' ELSE ''Bufor'' END [Dokument Bufor],&#xD;
    Dzi_Symbol [Dziennik], CONVERT(VARCHAR(10),DeN_NrKsiegi) [Dziennik Numer], DeN_IdentKsieg [Identyfikator Księgowy], poz.nazwa [Konto pełny numer], DeE_KontoWn [Konto Przeciwstawne],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Elementu], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], &#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Elementu], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka],&#xD;
    ISNULL(DeE_Kategoria, ''(PUSTY)'') [Dokument Opis z Elementu], ISNULL(DeN_Kategoria, ''(PUSTY)'') [Dokument Opis z Nagłówka],&#xD;
    CASE WHEN DeN_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN DeN_PodmiotTyp = 2 THEN ''Bank''&#xD;
         WHEN DeN_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN DeN_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN DeN_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END [Podmiot Pierwotny Typ], &#xD;
&#xD;
    ISNULL(Podmioty.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Kod],&#xD;
    20201 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Podmioty.Pod_PodId [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__],&#xD;
    &#xD;
    ISNULL(Podmioty.Pod_Nazwa1, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Nazwa], &#xD;
    20201 [Podmiot Pierwotny Nazwa __PROCID__], Podmioty.Pod_PodId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__],&#xD;
    &#xD;
    ISNULL(Podmioty.Pod_NIP, ''(BRAK)'') [Podmiot Pierwotny NIP],&#xD;
    ISNULL(Podmioty.Pod_Kraj, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Kraj],&#xD;
    ISNULL(Podmioty.Pod_Wojewodztwo, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Województwo], ISNULL(Podmioty.Pod_Powiat, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Powiat], ISNULL(Podmioty.Pod_Gmina, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Gmina],&#xD;
    ISNULL(Podmioty.Pod_Miasto, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny Miasto], ISNULL(PodPoz.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot Pierwotny z Pozycji], &#xD;
        CASE WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END AS [Podmiot Typ], &#xD;
&#xD;
    ISNULL(pod5.Pod_Nazwa1, ''(NIEPRZYPISANY)'') [Podmiot Nazwa], &#xD;
    20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__],&#xD;
    &#xD;
    ISNULL(pod5.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot Kod], &#xD;
    20201 [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__],&#xD;
&#xD;
    ISNULL(pod5.Pod_NIP, ''(BRAK)'') AS [Podmiot NIP],&#xD;
    ISNULL(pod5.Pod_Kraj, ''(NIEPRZYPISANY)'') AS [Podmiot Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo],&#xD;
    "Podmiot Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
    "Podmiot Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
    ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANY)'') [Podmiot z Pozycji],&#xD;
    ISNULL(op1.Ope_Kod, ''(NIEPRZYPISANY)'') [Operator Wprowadzający], ISNULL(op2.Ope_Kod, ''(NIEPRZYPISANY)'') [Operator Modyfikujący],&#xD;
    ''NIE'' AS [Rodzaj], &#xD;
    CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 THEN ''Koszty''&#xD;
         WHEN Acc_TypKonta = 4 THEN ''Przychody''&#xD;
         WHEN Acc_TypKonta = 3 THEN ''Aktywno pasywne''&#xD;
         WHEN Acc_TypKonta = 2 THEN ''Pasywa''&#xD;
         WHEN Acc_TypKonta = 1 THEN ''Aktywa''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typ],&#xD;
            CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 OR Acc_TypKonta = 4  THEN ''Wynikowe''&#xD;
         WHEN Acc_TypKonta = 3 OR Acc_TypKonta = 2 OR Acc_TypKonta = 1 THEN ''Bilansowe''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typy],&#xD;
    CASE WHEN Acc_KontrolaBudzetu = 0 THEN ''Brak''&#xD;
         WHEN Acc_KontrolaBudzetu = 1 THEN ''Obroty Wn'' &#xD;
         WHEN Acc_KontrolaBudzetu = 2 Then ''obroty Ma''&#xD;
    END [Kontrola budżetu],&#xD;
    CASE WHEN Acc_Rozrachunkowe = 1 THEN ''TAK'' ELSE ''NIE'' END AS [Konto Rozrachunkowe],&#xD;
    CASE WHEN DeE_Waluta = '''' THEN @Wal ELSE DeE_Waluta END [Waluta],&#xD;
    NULL [Obroty Winien], CASE WHEN DeE_AccMaId IS NOT NULL THEN DeE_Kwota ELSE NULL END [Obroty Ma],&#xD;
    NULL [Obroty Winien Waluta], CASE WHEN DeE_AccMaId IS NOT NULL THEN DeE_KwotaWal ELSE NULL END [Obroty Ma Waluta],&#xD;
    NULL AS [Bilans Otwarcia Ma], NULL  AS [Bilans Otwarcia Winien],&#xD;
    NULL [Bilans Otwarcia Ma Waluta], NULL [Bilans Otwarcia Winien Waluta],&#xD;
    NULL [Plan Wn], NULL [Plan Ma] &#xD;
    ,DeN_DeNId as DENID, DeE_lp as DeELP'&#xD;
    + @kolumny +&#xD;
' FROM CDN.DekretyNag&#xD;
    JOIN CDN.DekretyElem ON DeE_DeNId = DeN_DeNId AND DeE_AccMaId IS NOT NULL&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat1 ON DeE_KatId = kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat2 ON DeN_KatId = kat2.Kat_KatID&#xD;
    JOIN CDN.Dzienniki ON DeN_DziId = Dzi_DziId&#xD;
    LEFT OUTER JOIN #tmpTwrGr Poz ON DeE_AccMaId = Poz.gid  &#xD;
    LEFT OUTER JOIN CDN.Konta ON DeE_AccMaId = Acc_AccId &#xD;
    JOIN CDN.OkresyObrach ON DeN_OObId = OOb_OObID&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView Podmioty ON DeN_PodmiotId = Podmioty.Pod_PodId AND DeN_PodmiotTyp = Podmioty.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView PodPoz ON DeE_SlownikId = PodPoz.Pod_PodId and DeE_SlownikTyp = PodPoz.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op1 ON DeN_OpeZalID = op1.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' op2 ON DeN_OpeModID = op2.Ope_OpeId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on Podmioty.Pod_GlID = pod5.Pod_PodId and Podmioty.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 on PodPoz.Pod_GlID = pod6.Pod_PodId and PodPoz.Pod_GlKod = pod6.Pod_Kod&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
  WHERE DeN_Typ &lt;&gt; 1 AND Oob_OobId IN ( '+@OKRESOBRACHUNKOWY1+')&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], NULL [Data Księgowania Dzień], ISNULL( SUBSTRING(convert(varchar,Obr_RokMies), 1,4), 0) [Data Księgowania Rok], &#xD;
    NULL [Data Księgowania Kwartał], ISNULL( SUBSTRING(convert(varchar,Obr_RokMies), 5,6), 0) [Data Księgowania Miesiąc], &#xD;
    CASE &#xD;
     WHEN (Obr_RokMies%100 = MONTH(GETDATE())-1) AND ((Obr_RokMies/100) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN (((Obr_RokMies%100) = 12) AND (MONTH(GETDATE()) = 1)) AND ((Obr_RokMies/100) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Poprzedni],&#xD;
&#xD;
    CASE WHEN Obr_RokMies = YEAR(GETDATE())*100 + MONTH(GETDATE()) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Bieżący],&#xD;
&#xD;
    NULL [Data Księgowania Tydzień Roku],&#xD;
    NULL [Data Wystawienia Dzień],  NULL [Data Wystawienia Rok], &#xD;
    NULL [Data Wystawienia Kwartał], NULL [Data Wystawienia Miesiąc], NULL [Data Wystawienia Miesiąc Poprzedni], NULL [Data Wystawienia Miesiąc Bieżący],&#xD;
    NULL [Data Wystawienia Tydzień Roku],&#xD;
    NULL [Data Operacji Dzień], NULL [Data Operacji Rok], &#xD;
    NULL [Data Operacji Kwartał], NULL [Data Operacji Miesiąc], NULL [Data Operacji Miesiąc Poprzedni], NULL [Data Operacji Miesiąc Bieżący], &#xD;
    NULL [Data operacji Tydzień Roku],&#xD;
    GETDATE() [Data Analizy],&#xD;
    OOb_Symbol [Okres obrachunkowy], &#xD;
&#xD;
    NULL [Dokument Numer], &#xD;
    26006 [Dokument Numer __PROCID__KH__], Acc_AccId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__],&#xD;
&#xD;
    NULL [Dokument Element Numer], CASE WHEN Obr_ObrotyWn = 0.0 AND Obr_ObrotyMa = 0.0 THEN ''Bufor'' ELSE ''Zatwierdzone'' END [Dokument Bufor],&#xD;
    NULL [Dziennik], NULL [Dziennik Numer], NULL [Identyfikator Księgowy], poz.nazwa [Konto pełny numer], NULL [Konto Przeciwstawne],&#xD;
    NULL [Kategoria Szczegółowa z Elementu], NULL [Kategoria Szczegółowa z Nagłówka], &#xD;
    NULL [Kategoria Ogólna z Elementu], NULL [Kategoria Ogólna z Nagłówka],&#xD;
    NULL [Dokument Opis z Elementu], NULL [Dokument Opis z Nagłówka],&#xD;
    NULL [Podmiot Pierwotny Typ], &#xD;
    &#xD;
    NULL [Podmiot Pierwotny Kod], &#xD;
    26006 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Acc_AccId [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__],&#xD;
    &#xD;
    NULL [Podmiot Pierwotny Nazwa], &#xD;
    26006 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Acc_AccId [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__],&#xD;
    &#xD;
    NULL [Podmiot Pierwotny NIP],&#xD;
    NULL [Podmiot Pierwotny Kraj],&#xD;
    NULL [Podmiot Pierwotny Województwo], NULL [Podmiot Pierwotny Powiat],NULL [Podmiot Pierwotny Gmina],&#xD;
    NULL [Podmiot Pierwotny Miasto], NULL [Podmiot Pierwotny z Pozycji],    &#xD;
&#xD;
    NULL [Podmiot Typ], &#xD;
    NULL [Podmiot Kod], &#xD;
    26006 [Podmiot Kod __PROCID__Kontrahenci__], Acc_AccId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__],&#xD;
    NULL [Podmiot Nazwa], &#xD;
    26006 [Podmiot Nazwa __PROCID__Kontrahenci__], Acc_AccId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__],&#xD;
    NULL [Podmiot NIP],&#xD;
    NULL [Podmiot Kraj],&#xD;
    NULL [Podmiot Województwo], NULL [Podmiot Powiat],NULL [Podmiot Gmina],&#xD;
    NULL [Podmiot Miasto], NULL [Podmiot z Pozycji],&#xD;
&#xD;
    NULL [Operator Wprowadzający], NULL [Operator Modyfikujący],&#xD;
    CASE WHEN Obr_Typ = 0 THEN ''NIE'' WHEN Obr_Typ = 1 THEN ''TAK'' ELSE ''Korekta Bilansu Zamknięcia'' END AS [Rodzaj],&#xD;
    CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 THEN ''Koszty''&#xD;
         WHEN Acc_TypKonta = 4 THEN ''Przychody''&#xD;
         WHEN Acc_TypKonta = 3 THEN ''Aktywno pasywne''&#xD;
         WHEN Acc_TypKonta = 2 THEN ''Pasywa''&#xD;
         WHEN Acc_TypKonta = 1 THEN ''Aktywa''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typ],&#xD;
            CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 OR Acc_TypKonta = 4  THEN ''Wynikowe''&#xD;
         WHEN Acc_TypKonta = 3 OR Acc_TypKonta = 2 OR Acc_TypKonta = 1 THEN ''Bilansowe''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typy],&#xD;
    CASE WHEN Acc_KontrolaBudzetu = 0 THEN ''Brak''&#xD;
         WHEN Acc_KontrolaBudzetu = 1 THEN ''Obroty Wn'' &#xD;
         WHEN Acc_KontrolaBudzetu = 2 Then ''obroty Ma''&#xD;
    END [Kontrola budżetu],&#xD;
    CASE WHEN Acc_Rozrachunkowe = 1 THEN ''TAK'' ELSE ''NIE'' END AS [Konto Rozrachunkowe],&#xD;
    CASE WHEN Acc_Waluta = '''' THEN @Wal ELSE Acc_Waluta END [Waluta],&#xD;
    NULL [Obroty Winien], NULL [Obroty Ma], NULL [Obroty Winien Waluta], NULL [Obroty Ma Waluta],&#xD;
    CASE WHEN Obr_Typ = 1 THEN &#xD;
    CASE &#xD;
        WHEN Obr_ObrotyMa &gt; 0 THEN Obr_ObrotyMa&#xD;
        ELSE Obr_ObrotyMaBufor&#xD;
    END &#xD;
    ELSE 0 END AS [Bilans Otwarcia Ma],&#xD;
    CASE WHEN Obr_Typ = 1 THEN &#xD;
    CASE &#xD;
        WHEN Obr_ObrotyWn &gt; 0 THEN Obr_ObrotyWn &#xD;
        ELSE Obr_ObrotyWnBufor&#xD;
    END  &#xD;
    ELSE 0 END  AS [Bilans Otwarcia Winien],&#xD;
    CASE WHEN Obr_Typ = 1 THEN &#xD;
    CASE &#xD;
        WHEN Obr_ObrotyMaWal &gt; 0 THEN Obr_ObrotyMaWal &#xD;
        ELSE Obr_ObrotyMaBuforWal&#xD;
    END &#xD;
    ELSE 0 END AS [Bilans Otwarcia Ma Waluta],&#xD;
    CASE WHEN Obr_Typ = 1 THEN &#xD;
    CASE &#xD;
        WHEN Obr_ObrotyWnWal &gt; 0 THEN Obr_ObrotyWnWal &#xD;
        ELSE Obr_ObrotyWnBuforWal&#xD;
    END  &#xD;
    ELSE 0 END  AS [Bilans Otwarcia Winien Waluta],&#xD;
    NULL [Plan Wn], NULL [Plan Ma]&#xD;
    ,null as DENID, null as DeELP  &#xD;
    ' + @kolumny + &#xD;
' FROM [CDN].[Obroty]&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Obr_AccId = Poz.gid&#xD;
    LEFT JOIN CDN.Konta ON Obr_AccId = Acc_AccId&#xD;
    LEFT JOIN CDN.OkresyObrach ON Acc_OObId = OOb_OObID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    WHERE Oob_OobId IN ( '+@OKRESOBRACHUNKOWY1+')&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], NULL [Data Księgowania Dzień], ISNULL( SUBSTRING(convert(varchar,BuE_Miesiac), 1,4), 0) [Data Księgowania Rok], &#xD;
    NULL [Data Księgowania Kwartał], ISNULL( SUBSTRING(convert(varchar,BuE_Miesiac), 5,6), 0) [Data Księgowania Miesiąc], &#xD;
&#xD;
    CASE &#xD;
     WHEN (BuE_Miesiac%100 = MONTH(GETDATE())-1) AND ((BuE_Miesiac/100) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
     WHEN (((BuE_Miesiac%100) = 12) AND (MONTH(GETDATE()) = 1)) AND ((BuE_Miesiac/100) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Poprzedni],&#xD;
&#xD;
    CASE WHEN BuE_Miesiac = YEAR(GETDATE())*100 + MONTH(GETDATE()) THEN ''TAK'' &#xD;
     ELSE ''NIE'' &#xD;
    END [Data Księgowania Miesiąc Bieżący],&#xD;
&#xD;
    NULL [Data Księgowania Tydzień Roku],&#xD;
    NULL [Data Wystawienia Dzień],  NULL [Data Wystawienia Rok], &#xD;
    NULL [Data Wystawienia Kwartał], NULL [Data Wystawienia Miesiąc], NULL [Data Wystawienia Miesiąc Poprzedni], NULL [Data Wystawienia Miesiąc Bieżący],&#xD;
    NULL [Data Wystawienia Tydzień Roku],&#xD;
    NULL [Data Operacji Dzień], NULL [Data Operacji Rok], &#xD;
    NULL [Data Operacji Kwartał], NULL [Data Operacji Miesiąc], NULL [Data Operacji Miesiąc Poprzedni], NULL [Data Operacji Miesiąc Bieżący], &#xD;
    NULL [Data operacji Tydzień Roku],&#xD;
    GETDATE() [Data Analizy],&#xD;
    OOb_Symbol [Okres obrachunkowy], &#xD;
    &#xD;
    NULL [Dokument Numer], &#xD;
    26006 [Dokument Numer __PROCID__KH__], Acc_AccId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__],&#xD;
    &#xD;
    NULL [Dokument Element Numer], ''Zatwierdzone'' [Dokument Bufor],&#xD;
    NULL [Dziennik], NULL [Dziennik Numer], NULL [Identyfikator Księgowy], poz.nazwa [Konto pełny numer], NULL [Konto Przeciwstawne],&#xD;
    NULL [Kategoria Szczegółowa z Elementu], NULL [Kategoria Szczegółowa z Nagłówka], &#xD;
    NULL [Kategoria Ogólna z Elementu], NULL [Kategoria Ogólna z Nagłówka],&#xD;
    NULL [Dokument Opis z Elementu], NULL [Dokument Opis z Nagłówka],&#xD;
    NULL [Podmiot Pierwotny Typ], &#xD;
    &#xD;
    NULL [Podmiot Pierwotny Kod], &#xD;
    26006 [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Acc_AccId [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__],&#xD;
    &#xD;
    NULL [Podmiot Pierwotny Nazwa], &#xD;
    26006 [Podmiot Pierwotny Nazwa __PROCID__Kontrahenci__], Acc_AccId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__],&#xD;
    &#xD;
    NULL [Podmiot Pierwotny NIP],&#xD;
    NULL [Podmiot Pierwotny Kraj],&#xD;
    NULL [Podmiot Pierwotny Województwo], NULL [Podmiot Pierwotny Powiat],NULL [Podmiot Pierwotny Gmina],&#xD;
    NULL [Podmiot Pierwotny Miasto], NULL [Podmiot Pierwotny z Pozycji],&#xD;
    NULL [Podmiot Typ], &#xD;
    NULL [Podmiot Kod], &#xD;
    26006 [Podmiot Kod __PROCID__Kontrahenci__], Acc_AccId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__],&#xD;
    NULL [Podmiot Nazwa], &#xD;
    26006 [Podmiot Nazwa __PROCID__Kontrahenci__], Acc_AccId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__],&#xD;
    NULL [Podmiot NIP],&#xD;
    NULL [Podmiot Kraj],&#xD;
    NULL [Podmiot Województwo], NULL [Podmiot Powiat],NULL [Podmiot Gmina],&#xD;
    NULL [Podmiot Miasto], NULL [Podmiot z Pozycji],&#xD;
    NULL [Operator Wprowadzający], NULL [Operator Modyfikujący],&#xD;
    ''TAK'' AS [Rodzaj],&#xD;
    CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 THEN ''Koszty''&#xD;
         WHEN Acc_TypKonta = 4 THEN ''Przychody''&#xD;
         WHEN Acc_TypKonta = 3 THEN ''Aktywno pasywne''&#xD;
         WHEN Acc_TypKonta = 2 THEN ''Pasywa''&#xD;
         WHEN Acc_TypKonta = 1 THEN ''Aktywa''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typ],&#xD;
    CASE WHEN Acc_TypKonta = 6 THEN ''Pozabilansowe''&#xD;
         WHEN Acc_TypKonta = 5 OR Acc_TypKonta = 4  THEN ''Wynikowe''&#xD;
         WHEN Acc_TypKonta = 3 OR Acc_TypKonta = 2 OR Acc_TypKonta = 1 THEN ''Bilansowe''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END AS [Konto Typy],&#xD;
    CASE WHEN Acc_KontrolaBudzetu = 0 THEN ''Brak''&#xD;
         WHEN Acc_KontrolaBudzetu = 1 THEN ''Obroty Wn'' &#xD;
         WHEN Acc_KontrolaBudzetu = 2 Then ''obroty Ma''&#xD;
    END [Kontrola budżetu],&#xD;
    CASE WHEN Acc_Rozrachunkowe = 1 THEN ''TAK'' ELSE ''NIE'' END AS [Konto Rozrachunkowe],&#xD;
    CASE WHEN Acc_Waluta = '''' THEN @Wal ELSE Acc_Waluta END [Waluta],&#xD;
    NULL [Obroty Winien], NULL [Obroty Ma], NULL [Obroty Winien Waluta], NULL [Obroty Ma Waluta],&#xD;
    NULL AS [Bilans Otwarcia Ma], NULL  AS [Bilans Otwarcia Winien],&#xD;
    NULL [Bilans Otwarcia Ma Waluta], NULL [Bilans Otwarcia Winien Waluta],&#xD;
    CASE WHEN Acc_KontrolaBudzetu = 1 THEN BuE_Kwota ELSE NULL END [Plan Wn], &#xD;
    CASE WHEN Acc_KontrolaBudzetu = 2 THEN BuE_Kwota ELSE NULL END [Plan Ma]&#xD;
    ,null as DENID, null as DeELP  &#xD;
    ' + @kolumny + &#xD;
' FROM CDN.Konta&#xD;
    LEFT JOIN #tmpTwrGr Poz ON Acc_AccId = Poz.gid&#xD;
    LEFT JOIN CDN.OkresyObrach ON Acc_OObId = OOb_OObID&#xD;
    JOIN CDN.BudzetNag ON Acc_AccId = BuN_AccId&#xD;
    JOIN CDN.BudzetElem ON BuE_BuNId = BuN_BuNId &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    WHERE BuN_Finalny = 1 AND Oob_OobId IN ('+@OKRESOBRACHUNKOWY1+')&#xD;
&#xD;
) AS ks &#xD;
LEFT OUTER JOIN #tmpWymiary WymDE on WymDE.DENID = ks.DENID and (WymDE.DeELP = ks.DeELP OR WymDE.DeELP = 0)&#xD;
'&#xD;
exec(@select)&#xD;
&#xD;
drop Table #tmpTwrGr    &#xD;
drop table #tmpWymiary&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5vCxSmgondMfdtmo6sliIgTWPbj17BviVUXyPzdkotJkq7igEVPx67QBSiMcx5zyeTJgrs/t+z/BIjq9oHQl3dL1vDiIZ84Ys7b36fBxBgdA</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="AccIDWn" caption="AccIDWn" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="AccIDMa" caption="AccIDMa" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Księgowania Dzień" caption="Data Księgowania Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Księgowania Rok" caption="Data Księgowania Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Księgowania Kwartał" caption="Data Księgowania Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Księgowania Miesiąc" caption="Data Księgowania Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Księgowania Miesiąc Poprzedni" caption="Data Księgowania Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Księgowania Miesiąc Bieżący" caption="Data Księgowania Miesiąc Bieżący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Księgowania Tydzień Roku" caption="Data Księgowania Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc Poprzedni" caption="Data Wystawienia Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc Bieżący" caption="Data Wystawienia Miesiąc Bieżący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc Poprzedni" caption="Data Operacji Miesiąc Poprzedni" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc Bieżący" caption="Data Operacji Miesiąc Bieżący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Okres Obrachunkowy" caption="Okres Obrachunkowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Element Numer" caption="Dokument Element Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zatwierdzone/Bufor" caption="Zatwierdzone/Bufor" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dziennik" caption="Dziennik" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Identyfikator Księgowy" caption="Identyfikator Księgowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Pełny Numer" caption="Konto Pełny Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Przeciwstawne" caption="Konto Przeciwstawne" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Elementu" caption="Kategoria Szczegółowa z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Elementu" caption="Kategoria Ogólna z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis z Elementu" caption="Dokument Opis z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis z Nagłówka" caption="Dokument Opis z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Typ" caption="Podmiot Pierwotny Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kod" caption="Podmiot Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Nazwa" caption="Podmiot Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kraj" caption="Podmiot Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Województwo" caption="Podmiot Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Powiat" caption="Podmiot Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Gmina" caption="Podmiot Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Miasto" caption="Podmiot Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny z Pozycji" caption="Podmiot Pierwotny z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kraj" caption="Podmiot Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Województwo" caption="Podmiot Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Powiat" caption="Podmiot Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Gmina" caption="Podmiot Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Miasto" caption="Podmiot Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot z Pozycji" caption="Podmiot z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Bilans Otwarcia" caption="Bilans Otwarcia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Typ Konta" caption="Typ Konta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Typy Kont" caption="Typy Kont" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrola Budżetu" caption="Kontrola Budżetu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Rozrachunkowe" caption="Konto Rozrachunkowe" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Obroty Wn" caption="Obroty Wn" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obroty Ma" caption="Obroty Ma" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obroty Wn Waluta" caption="Obroty Wn Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Obroty Ma Waluta" caption="Obroty Ma Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Bilans Otwarcia Ma" caption="Bilans Otwarcia Ma" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Bilans Otwarcia Wn" caption="Bilans Otwarcia Wn" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Bilans Otwarcia Ma Waluta" caption="Bilans Otwarcia Ma Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Bilans Otwarcia Wn Waluta" caption="Bilans Otwarcia Wn Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Ma M" caption="Saldo Ma M" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Wn M" caption="Saldo Wn M" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Ma OO" caption="Saldo Ma OO" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Wn OO" caption="Saldo Wn OO" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Ma M Waluta" caption="Saldo Ma M Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Wn M Waluta" caption="Saldo Wn M Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Ma OO Waluta" caption="Saldo Ma OO Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Wn OO Waluta" caption="Saldo Wn OO Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Persaldo M" caption="Persaldo M" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Persaldo OO" caption="Persaldo OO" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Persaldo M Waluta" caption="Persaldo M Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Persaldo OO Waluta" caption="Persaldo OO Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Plan Wn" caption="Plan Wn" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Plan Ma" caption="Plan Ma" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Konto Grupa" caption="Konto Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 1" caption="Konto Struktura Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 1" caption="Konto Nazwa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 2" caption="Konto Struktura Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 2" caption="Konto Nazwa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 3" caption="Konto Struktura Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 3" caption="Konto Nazwa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 4" caption="Konto Struktura Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 4" caption="Konto Nazwa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 5" caption="Konto Struktura Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 5" caption="Konto Nazwa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wymiar KONTO_KK" caption="Wymiar KONTO_KK" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wymiar BANK" caption="Wymiar BANK" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wymiar KONTO" caption="Wymiar KONTO" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wymiar Wartość" caption="Wymiar Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wymiar Procent" caption="Wymiar Procent" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;OKRESOBRACHUNKOWY&lt;/Name&gt;&#xD;
    &lt;Label&gt;Okres Obrachunkowy:&lt;/Label&gt;&#xD;
    &lt;Expression&gt;select Cast(Oob_OobId as varchar)+';'+DB_Name(), Oob_Symbol + ' ' + DB_NAME() from cdn.okresyobrach&lt;/Expression&gt;&#xD;
    &lt;Type&gt;SQL&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Sql&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;true&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport  Księgowości (KK) z Opisami analitycznymi wersja 38.0 (OPTIMA 2025.3.0).&#xD;
&#xD;
Raport zawiera informacje księgowe z firmy, która prowadzi księgowość w formie Księgowości Kontowej. Prezentowane są wszystkie dekrety księgowe. Uwzględnione są opisy analityczne dokumentów. Wartości prezentowane są&#xD;
w walucie systemowej oraz walucie dokumentu.&#xD;
&#xD;
W celu wyświetlania poprawnych danych należy wybrać odpowiedni okres obrachunkowy, dla którego ma być przeprowadzona analiza.&#xD;
&#xD;
Dla parametru okresu obrachunkowego możliwy jest wielowybór, umożliwia to wykonywanie raportów z więcej niż jednej bazy danych. &#xD;
W przypadku wyboru wielu okresów z jednej bazy danych w celu poprawnego wykonania raportu pod uwagę wzięty zostanie jedynie najwcześniejszy z nich.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.DekretyNag - tabela zawiera nagłówki dekretów księgowych &#xD;
CDN.DekretyElem - tabela zawiera elementy dekretów księgowych&#xD;
CDN.Obroty - tabela zawiera zagregowane obroty na kontach księgowych&#xD;
WymiaryWartosci - Tabela z wartościami opisu analitycznego dokumentów</a:description><a:id>25</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>25. Raport Księgowości (KK) z Opisem Analitycznym</a:mainLinkName><a:modifiedOn>2025-06-04T10:26:32.657</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2017-10-19T15:47:43.943</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Rejestrów VAT z Opisami analitycznymi&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.1.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]'&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @sqlA nvarchar(max), @atrybutyDok varchar(max), @atrybut_format int;&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_VaNID IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_VaNID INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END        &#xD;
        END &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_VaNID = TM.DAt_VaNID&#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
 --Wyliczanie wymiarow&#xD;
&#xD;
declare @dokumentTypFZ int, @dokumentTypFS int&#xD;
set @dokumentTypFZ = 20 -- Rejestr vat zakupu&#xD;
set @dokumentTypFS = 21 -- Rejestr vat sprzedaży&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT Wyy_wyyid ID,isnull(wyy_nazwa,Wyy_Kod) Nazwa INTO #tmproots from cdn.Wymiary  where wyy_parentid = 0&#xD;
declare @wymiary varchar(max)&#xD;
SET @wymiary = ''&#xD;
&#xD;
;WITH g(nazwa, kod, ID,parent,RootID,Wyy_D020,Wyy_D021,aktywny,poziom, sciezka,typsl)&#xD;
AS&#xD;
(&#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,Wyy_D020,Wyy_D021,wyy_aktywny, 0 as poziom, convert(nvarchar(1024), '') as sciezka,Wyy_TypWymiaru&#xD;
      FROM cdn.Wymiary &#xD;
      WHERE Wyy_ParentID = 0&#xD;
      --and wyy_wyyid = @TableID&#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,p.Wyy_D020,p.Wyy_D021,wyy_aktywny, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.wyy_kod) as sciezka,Wyy_TypWymiaru&#xD;
      FROM g p&#xD;
      JOIN cdn.Wymiary c&#xD;
      ON c.Wyy_ParentID = p.ID &#xD;
      WHERE c.Wyy_ParentID &lt;&gt; 0 &#xD;
)     SELECT * INTO #tmpWymiary  FROM(&#xD;
SELECT  g.*,WyW_SlownikId,W.Wyw_wywID WYWID, VaN_VanID VaNID,0 VatLP, &#xD;
W.WyW_Kwota  Kwota, W.wyw_procent Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W2 where W2.WyW_DokumentId = W.WyW_DokumentId and W2.WyW_LpPozycji = W.WyW_LpPozycji and W2.WyW_WyyId = 0 ) IloscPozycji,&#xD;
WyW_SourceType TypS,&#xD;
CASE WyW_SourceType&#xD;
            WHEN 1 THen 'Pozycja/Kwota dodatkowa'&#xD;
            WHEN 2 THen 'Pozycja/Netto'&#xD;
            WHEN 3 THen 'Pozycja/Koszt'&#xD;
            WHEN 4 THen 'Pozycja/VAT_KOSZT'&#xD;
            WHEN 5 THen 'Dokument/Netto'&#xD;
            WHEN 6 THen 'Dokument/Koszt'&#xD;
            WHEN 7 THen 'Dokument/VAT_Koszt'&#xD;
       END [Typ ]&#xD;
FROM g LEFT JOIN cdn.WymiaryWartosci W ON ID = WyW_WyyId&#xD;
left JOIN CDN.VatNag ON VaN_VanID = W.WyW_DokumentId AND  W.WyW_LpPozycji = 0&#xD;
WHERE  (Wyy_D020 = 1 or Wyy_D021 = 1)&#xD;
UNION all&#xD;
&#xD;
SELECT  g.*,WyW_SlownikId,W.Wyw_wywID WYWID,&#xD;
Vat_VanID VaNID,VaT_Lp VatLP, &#xD;
W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where  W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji,&#xD;
WyW_SourceType TypS,&#xD;
CASE WyW_SourceType&#xD;
            WHEN 1 THen 'Pozycja/Kwota dodatkowa'&#xD;
            WHEN 2 THen 'Pozycja/Netto'&#xD;
            WHEN 3 THen 'Pozycja/Koszt'&#xD;
            WHEN 4 THen 'Pozycja/VAT_KOSZT'&#xD;
            WHEN 5 THen 'Dokument/Netto'&#xD;
            WHEN 6 THen 'Dokument/Koszt'&#xD;
            WHEN 7 THen 'Dokument/VAT_Koszt'&#xD;
       END [Typ ]&#xD;
FROM g LEFT JOIN cdn.WymiaryWartosci W ON ID = WyW_WyyId&#xD;
JOIN CDN.VatTab ON Vat_VanID = W.WyW_DokumentId and VaT_Lp = W.WyW_LpPozycji&#xD;
WHERE  (Wyy_D020 = 1 or Wyy_D021 = 1)&#xD;
)X &#xD;
&#xD;
&#xD;
insert into #tmpWymiary &#xD;
SELECT Coalesce(Knt_Nazwa1,Kat_KodSzczegol,Acc_Nazwa) nazwa ,Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) kod,ID-10000000,ID,RootID,Wyy_D020,Wyy_D021,aktywny,poziom + 1,sciezka +'\'+Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) sciezka,typsl,wyw_slownikid,wywid,vanid,vatlp,Kwota,Procent,GUID,IloscPozycji,TypS,Typ&#xD;
FROM #tmpWymiary &#xD;
LEFT JOIN cdn.Konta on typsl = 3 and WyW_SlownikId = acc_accid&#xD;
LEFT JOIN cdn.Kontrahenci on typsl = 4 and WyW_SlownikId = Knt_KntId&#xD;
Left join cdn.Kategorie on typsl = 2 and WyW_SlownikId = kat_katid&#xD;
WHERE typsl &lt;&gt; 1 and Wyw_SlownikId &lt;&gt;0&#xD;
&#xD;
&#xD;
while exists (select * from #tmproots)&#xD;
begin&#xD;
declare @TableID int&#xD;
declare @TableName Varchar(100)&#xD;
&#xD;
    select top 1 @TableID = ID&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
     Select top 1 @TableName = Nazwa&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpWymiary&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
&#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= Parent WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ ' = kod WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N' ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path Varchar(200)'&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path = sciezka WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + '= p.ID &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
                SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parent AS nvarchar)&#xD;
                    ELSE CAST(p.parent AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= p.id &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
                EXEC(@sql)&#xD;
&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
DECLARE @i int&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
&#xD;
    set @wymiary = CONCAT(@wymiary , ',"',@TableName,' Poziom ', LTRIM(@i), '" = CASE WHEN WymV.Poziom' ,LTRIM(@i) ,'_',@TableID , ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE WymV.Poziom' , LTRIM(@i) ,'_',@TableID, ' END')&#xD;
IF (@i=@poziom_max) &#xD;
	set @wymiary =CONCAT (@wymiary, ',"',@TableName,' Kompletny ', '" = CASE WHEN WymV.Poziom' ,LTRIM(@i) ,'_',@TableID ,'_path',' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE WymV.Poziom' , LTRIM(@i)  ,'_',@TableID ,'_path', ' END')&#xD;
 &#xD;
 set @i = @i + 1&#xD;
end&#xD;
    delete #tmproots&#xD;
    where ID = @TableID&#xD;
&#xD;
end&#xD;
DROP TABLE #tmproots&#xD;
&#xD;
delete from #tmpWymiary  where ID &gt; 0 and typsl &lt;&gt; 1 and WyW_SlownikId &lt;&gt; 0&#xD;
&#xD;
ALTER TABLE #tmpWymiary&#xD;
DROP COLUMN nazwa,aktywny,kod,id,parent,rootID,Wyy_D021,Wyy_D020,poziom,sciezka,WYWID,TypS,Typ,typsl,wyw_slownikid&#xD;
ALTER TABLE #tmpWymiary&#xD;
ADD  [Ver] INT&#xD;
UPDATE #tmpWymiary SET [Ver] = 1&#xD;
&#xD;
&#xD;
DECLARE @ColNames VARCHAR(MAX)&#xD;
DECLARE @SQLGrouper VARCHAR(MAX) &#xD;
SELECT @ColNames = COALESCE (@ColNames + ', ', '') + 'MAX(' + name +') AS ' +name&#xD;
FROM    tempdb.sys.columns &#xD;
WHERE  object_id = Object_id('tempdb..#tmpWymiary')&#xD;
AND column_id &gt;21&#xD;
and name &lt;&gt; 'Ver'&#xD;
&#xD;
&#xD;
SET @SQLGrouper = 'SELECT VaNID,VatLP,Cast(Procent as decimal(19,2)) procent,Cast(Kwota as decimal(19,2)) kwota,Guid,IloscPozYcji, '+ @ColNames+' , ver+1  FROM #tmpWymiary &#xD;
GROUP BY Guid,VaNID,VatLP,Cast(Procent as decimal(19,2)),Cast(Kwota as decimal(19,2)),IloscPozYcji,ver'&#xD;
INSERT  INTO #tmpWymiary exec (@SQLGrouper)&#xD;
&#xD;
DELETE FROM #tmpWymiary WHERE [Ver] = 1&#xD;
&#xD;
--Właściwe zapytanie&#xD;
DECLARE @select varchar(max);&#xD;
&#xD;
SET @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    VaT_Lp [Pozycja Lp],&#xD;
    VaN_Dokument AS [Dokument Numer],&#xD;
    CASE VaT_RodzajZakupu WHEN 1 THEN ''Towary'' WHEN 2 THEN ''Inne'' WHEN 3 THEN ''Środki Trwałe'' WHEN 4 THEN ''Usługi'' WHEN 5 THEN ''Środki Transportu'' WHEN 6 THEN ''Nieruchomości'' WHEN 7 THEN ''Paliwo'' END AS [Rodzaj],&#xD;
    CASE VaT_Flaga WHEN 1 THEN ''ZW'' WHEN 4 THEN ''NP'' ELSE convert(varchar,VaT_Stawka) + ''%'' END AS [Stawka VAT], VaN_Rejestr AS [Rejestr],&#xD;
    CASE Vat_Odliczenia WHEN 0 then ''Nie''  WHEN 1 then ''Tak'' WHEN 2 then ''Warunkowo''  END [Odliczenia],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Elementu], ISNULL(kat3.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria 2 Szczegółowa z Elementu],&#xD;
    ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka],&#xD;
    ISNULL(VaN_Kategoria, ''(PUSTA)'') [Kategoria Opis z Nagłówka], ISNULL(VaT_KatOpis, ''(PUSTA)'') [Kategoria Opis z Elementu], ISNULL(VaT_Kat2Opis, ''(PUSTA)'') [Kategoria 2 Opis z Elementu],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Elementu], ISNULL(kat3.Kat_KodOgolny, ''(PUSTA)'') [Kategoria 2 Ogólna z Elementu],&#xD;
    CASE WHEN VaN_RozliczacVat7 = 1 THEN ''TAK'' ELSE ''NIE'' END [Rozliczać do Deklaracji VAT], &#xD;
    ISNULL(SUBSTRING(convert(varchar,VaN_DeklRokMies), 1,4), ''(NIEPRZYPISANE)'') [Data Rozliczenia w Deklaracji Rok], &#xD;
    ISNULL(SUBSTRING(convert(varchar,VaN_DeklRokMies), 5,6), ''(NIEPRZYPISANE)'') [Data Rozliczenia w Deklaracji Miesiąc],&#xD;
        SUBSTRING(convert(varchar,&#xD;
    CASE VaN_DeklRokMiesKasa&#xD;
    WHEN 0 THEN NULL&#xD;
    ELSE VaN_DeklRokMiesKasa END&#xD;
    ), 1,4) [Data Rozliczenia wg Metody Kasowej Rok], &#xD;
 SUBSTRING(convert(varchar,&#xD;
    CASE VaN_DeklRokMiesKasa&#xD;
    WHEN 0 THEN NULL&#xD;
    ELSE VaN_DeklRokMiesKasa END&#xD;
    ), 5,6) [Data Rozliczenia wg Metody Kasowej Miesiąc], &#xD;
    CASE WHEN VaN_Waluta = '''' THEN @Wal ELSE VaN_Waluta END [Waluta],&#xD;
    CASE WHEN VaT_Flaga = 1 THEN ''Zwolniona''&#xD;
         WHEN VaT_Flaga = 2 THEN ''Opodatkowana''&#xD;
         WHEN VaT_Flaga = 3 THEN ''Zaniżona''&#xD;
         WHEN VaT_Flaga = 4 THEN ''Nie podlega''&#xD;
    ELSE ''(NIEPRZYPISANE)'' END AS [Typ Stawki],&#xD;
    CASE WHEN VaN_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN VaN_PodmiotTyp = 2 THEN ''Bank''&#xD;
         WHEN VaN_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN VaN_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN VaN_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END AS [Podmiot Pierwotny Typ], &#xD;
    Podmioty.Pod_Kod AS [Podmiot Pierwotny Kod], &#xD;
    Podmioty.Pod_Nazwa1 AS [Podmiot Pierwotny Nazwa], &#xD;
    Podmioty.Pod_NIP AS [Podmiot Pierwotny NIP],&#xD;
    Podmioty.Pod_Kraj AS [Podmiot Pierwotny Kraj],&#xD;
    Podmioty.Pod_Wojewodztwo AS [Podmiot Pierwotny Województwo], Podmioty.Pod_Powiat AS [Podmiot Pierwotny Powiat], Podmioty.Pod_Gmina AS [Podmiot Pierwotny Gmina],&#xD;
    Podmioty.Pod_Miasto AS [Podmiot Pierwotny Miasto],&#xD;
        CASE WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
        WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END AS [Podmiot Typ], &#xD;
    pod5.Pod_Nazwa1 [Podmiot Nazwa],    &#xD;
    pod5.Pod_Kod [Podmiot Kod], &#xD;
    pod5.Pod_NIP AS [Podmiot NIP],&#xD;
    pod5.Pod_Kraj AS [Podmiot Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo],&#xD;
    "Podmiot Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
    "Podmiot Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
    ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
    isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
    VaN_IdentKsieg AS [Id. Księgowy],&#xD;
    (CASE WHEN VaN_Typ = 1 THEN VaT_VATDoVAT ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Zakupy VAT], (CASE WHEN VaN_Typ = 2 THEN VaT_VATDoVAT ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Sprzedaż VAT],&#xD;
    (CASE WHEN VaN_Typ = 1 THEN VaT_NettoDoVAT + VaT_VATDoVAT ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Zakupy Brutto], (CASE WHEN VaN_Typ = 2 THEN VaT_VATDoVAT + VaT_NettoDoVAT ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Sprzedaż Brutto],&#xD;
    (CASE WHEN VaN_Typ = 1 THEN VaT_NettoDoVAT ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Zakupy Netto], (CASE WHEN VaN_Typ = 2 THEN VaT_NettoDoVAT ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Sprzedaż Netto],&#xD;
    (CASE WHEN VaN_Typ = 1 THEN VaT_VATWal ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Zakupy VAT Waluta], (CASE WHEN VaN_Typ = 2 THEN VaT_VATWal ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Sprzedaż VAT Waluta],&#xD;
    (CASE WHEN VaN_Typ = 1 THEN VaT_NettoWal + VaT_VATWal ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Zakupy Brutto Waluta], (CASE WHEN VaN_Typ = 2 THEN VaT_NettoWal + VaT_VATWal ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Sprzedaż Brutto Waluta],&#xD;
    (CASE WHEN VaN_Typ = 1 THEN VaT_NettoWal ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Zakupy Netto Waluta], (CASE WHEN VaN_Typ = 2 THEN VaT_NettoWal ELSE NULL END)*COALESCE(Kwota*0.01,1) AS [Kwota Sprzedaż Netto Waluta],&#xD;
    CASE WHEN VaN_Typ = 2 AND VaN_Detal = 1 THEN ''Tak'' Else ''Nie'' END AS [Sprzedaż detaliczna],&#xD;
    CASE VaN_Rozliczono WHEN 0 THEN ''Nie'' ELSE ''Tak'' END [Dokument Rozliczony],&#xD;
    VaN_OpeModKod [Operator Modyfikujący],&#xD;
    VaN_OpeZalKod [Operator Wprowadzający],&#xD;
	Procent [Wymiar Wartość],&#xD;
	Kwota [Wymiar Procent]&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataWys, 111), ''/'', ''-'') AS [Data Wystawienia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataZap, 111), ''/'', ''-'') AS [Data Zapisu]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataOpe, 111), ''/'', ''-'') AS [Data Operacji]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_TS_Zal, 111), ''/'', ''-'') AS [Data Wprowadzenia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_TS_Mod, 111), ''/'', ''-'') AS [Data Modyfikacji]&#xD;
    &#xD;
    */&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataWys, 111), ''/'', ''-'') AS [Data Wystawienia Dzień], YEAR(VaN_DataWys) AS [Data Wystawienia Rok]&#xD;
    ,DATEPART(quarter, VaN_DataWys) AS [Data Wystawienia Kwartał], MONTH(VaN_DataWys) AS [Data Wystawienia Miesiąc], (datepart(DY, datediff(d, 0, VaN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, VaN_DataWys)*/ [Data Wystawienia Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataZap, 111), ''/'', ''-'') AS [Data Zapisu Dzień], YEAR(VaN_DataZap) AS [Data Zapisu Rok]&#xD;
    ,DATEPART(quarter, VaN_DataZap) AS [Data Zapisu Kwartał], MONTH(VaN_DataZap) AS [Data Zapisu Miesiąc], (datepart(DY, datediff(d, 0, VaN_DataZap) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, VaN_DataZap)*/ [Data Zapisu Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_DataOpe, 111), ''/'', ''-'') AS [Data Operacji Dzień], YEAR(VaN_DataOpe) AS [Data Operacji Rok] &#xD;
    ,DATEPART(quarter, VaN_DataOpe) AS [Data Operacji Kwartał], MONTH(VaN_DataOpe) AS [Data Operacji Miesiąc], (datepart(DY, datediff(d, 0, VaN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, VaN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_TS_Zal, 111), ''/'', ''-'') AS [Data Wprowadzenia Dzień], YEAR(VaN_TS_Zal) AS [Data Wprowadzenia Rok] &#xD;
    ,DATEPART(quarter, VaN_TS_Zal) AS [Data Wprowadzenia Kwartał], MONTH(VaN_TS_Zal) AS [Data Wprowadzenia Miesiąc], (datepart(DY, datediff(d, 0, VaN_TS_Zal) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, VaN_TS_Zal)*/ [Data Wprowadzenia Tydzień Roku]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), VaN_TS_Mod, 111), ''/'', ''-'') AS [Data Modyfikacji Dzień], YEAR(VaN_TS_Mod) AS [Data Modyfikacji Rok] &#xD;
    ,DATEPART(quarter, VaN_TS_Mod) AS [Data Modyfikacji Kwartał], MONTH(VaN_TS_Mod) AS [Data Modyfikacji Miesiąc], (datepart(DY, datediff(d, 0, VaN_TS_Mod) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, VaN_TS_Mod)*/ [Data Modyfikacji Tydzień Roku]&#xD;
    ,GETDATE() [Data Analizy]&#xD;
    ----------KONTEKSTY&#xD;
    ,20101 [Dokument Numer __PROCID__VAT__], VaN_VaNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,CASE Podmioty.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], Podmioty.Pod_PodId [Podmiot Pierwotny Kod __ORGID__], '''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__]&#xD;
    ,CASE Podmioty.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Pierwotny Nazwa __PROCID__], Podmioty.Pod_PodId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__]&#xD;
    ,CASE pod5.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__]&#xD;
&#xD;
    '&#xD;
    &#xD;
    + @atrybutyDok + @wymiary +&#xD;
' FROM CDN.VatNag&#xD;
    JOIN CDN.VatTab ON VaN_VaNID = VaT_VaNID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat1 ON VaT_KatID=kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat2 ON VaN_KatID=kat2.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat3 ON VaT_Kat2ID=kat3.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.PodmiotyView Podmioty ON VaN_PodID = Podmioty.Pod_PodId AND VaN_PodmiotTyp = Podmioty.Pod_PodmiotTyp&#xD;
    LEFT JOIN #tmpDokAtr DokAtr ON VaT_VaNID  = DokAtr.DAt_VaNId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on Podmioty.Pod_GlID = pod5.Pod_PodId and Podmioty.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = VaN_ZakID&#xD;
    LEFT Outer JOIN #tmpWymiary WymV ON  VaN_VaNID = WymV.VaNID AND (WymV.VatLP=VaT_Lp or WymV.VatLP = 0)&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    '&#xD;
exec(@select)&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
drop table #tmpWymiary&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+Q9gXTX4eeGv2fSZXMlwqzoBe8qh5g1OTUWqhH+F8ftHNNzvcTVGInUSwOKmk2/uvb+oNdQvPvbBqT6DJEoAjKEikFtg+e1BgIEgmyQTlg71Bkz1A1JcbxoNcTmdMBemfD1cS/y0doyc7Q2hn9oET5HM4hvHiMaM9EB/jGEnZ+85g+GhXs4KKqM</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Pozycja Lp" caption="Pozycja Lp" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rodzaj" caption="Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Stawka VAT" caption="Stawka VAT" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rejestr" caption="Rejestr" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Odliczenia" caption="Odliczenia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Elementu" caption="Kategoria Szczegółowa z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria 2 Szczegółowa z Elementu" caption="Kategoria 2 Szczegółowa z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Opis z Nagłówka" caption="Kategoria Opis z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Opis z Elementu" caption="Kategoria Opis z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria 2 Opis z Elementu" caption="Kategoria 2 Opis z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Elementu" caption="Kategoria Ogólna z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria 2 Ogólna z Elementu" caption="Kategoria 2 Ogólna z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rozliczać do Deklaracji VAT" caption="Rozliczać do Deklaracji VAT" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia w Deklaracji Rok" caption="Data Rozliczenia w Deklaracji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia w Deklaracji Miesiąc" caption="Data Rozliczenia w Deklaracji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia wg Metody Kasowej Rok" caption="Data Rozliczenia wg Metody Kasowej Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia wg Metody Kasowej Miesiąc" caption="Data Rozliczenia wg Metody Kasowej Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Typ Stawki" caption="Typ Stawki" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Typ" caption="Podmiot Pierwotny Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kod" caption="Podmiot Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Nazwa" caption="Podmiot Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny NIP" caption="Podmiot Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kraj" caption="Podmiot Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Województwo" caption="Podmiot Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Powiat" caption="Podmiot Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Gmina" caption="Podmiot Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Miasto" caption="Podmiot Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot NIP" caption="Podmiot NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kraj" caption="Podmiot Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Województwo" caption="Podmiot Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Powiat" caption="Podmiot Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Gmina" caption="Podmiot Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Miasto" caption="Podmiot Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Id. Księgowy" caption="Id. Księgowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kwota Zakupy VAT" caption="Kwota Zakupy VAT" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż VAT" caption="Kwota Sprzedaż VAT" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Zakupy Brutto" caption="Kwota Zakupy Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż Brutto" caption="Kwota Sprzedaż Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Zakupy Netto" caption="Kwota Zakupy Netto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż Netto" caption="Kwota Sprzedaż Netto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Zakupy VAT Waluta" caption="Kwota Zakupy VAT Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż VAT Waluta" caption="Kwota Sprzedaż VAT Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Zakupy Brutto Waluta" caption="Kwota Zakupy Brutto Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż Brutto Waluta" caption="Kwota Sprzedaż Brutto Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Zakupy Netto Waluta" caption="Kwota Zakupy Netto Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Sprzedaż Netto Waluta" caption="Kwota Sprzedaż Netto Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż detaliczna" caption="Sprzedaż detaliczna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Rozliczony" caption="Dokument Rozliczony" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wymiar Aktywny" caption="Wymiar Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zapisu Dzień" caption="Data Zapisu Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zapisu Rok" caption="Data Zapisu Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zapisu Kwartał" caption="Data Zapisu Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zapisu Miesiąc" caption="Data Zapisu Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zapisu Tydzień Roku" caption="Data Zapisu Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wprowadzenia Dzień" caption="Data Wprowadzenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wprowadzenia Rok" caption="Data Wprowadzenia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wprowadzenia Kwartał" caption="Data Wprowadzenia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wprowadzenia Miesiąc" caption="Data Wprowadzenia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wprowadzenia Tydzień Roku" caption="Data Wprowadzenia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Modyfikacji Dzień" caption="Data Modyfikacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Modyfikacji Rok" caption="Data Modyfikacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Modyfikacji Kwartał" caption="Data Modyfikacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Modyfikacji Miesiąc" caption="Data Modyfikacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Modyfikacji Tydzień Roku" caption="Data Modyfikacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KODY PROJEKTÓW" caption="Dokument Atrybut KODY PROJEKTÓW" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PRACOWNICY" caption="Dokument Atrybut PRACOWNICY" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Rejestrów VAT z Opisami analitycznymi wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje z rejestrów VAT, zarówno zakupów jak i sprzedaży. Prezentowane są wszystkie dokumenty z rejestrów. Uwzględnione są opisy analityczne dokumentów. Wartości prezentowane są w walucie systemowej oraz walucie dokumentu.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.VatNag - tabela nagłówków dokumentów w rejestrze VAT. Tabela VatNag zawiera informacje o dacie dokumentu, kontrahencie itp.&#xD;
CDN.VatTab - tabela elementów (pozycji) dokumentu w rejestrze VAT. Tabela zawiera informacje o pozycjach dokumentu, zagregowanych do poszczególnych stawek VAT.&#xD;
WymiaryWartosci - Tabela z wartościami opisu analitycznego dokumentów.</a:description><a:id>26</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>26. Raport Rejestrów VAT z Opisem Analitycznym</a:mainLinkName><a:modifiedOn>2025-04-14T14:00:55.363</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2018-05-07T16:04:42.307</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Obiegu Dokumentów&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Etapy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max), @sql varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]'&#xD;
SET @Etapy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[SekEtapy]'&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
SET @sql =&#xD;
'&#xD;
----ETAPY&#xD;
&#xD;
SELECT &#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
[Dokument Obiegu Seria] =&#xD;
CASE when isnull(ser.seria,0) = 5 then &#xD;
substring(DoN_NumerPelny,0,CHARINDEX(''/'',DoN_NumerPelny,0))&#xD;
ELSE &#xD;
ISNULL(PARSENAME(REPLACE(substring(DoN_NumerPelny,CHARINDEX(''/'',DoN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
END,&#xD;
[Dokument Obiegu Numer] = DoN_NumerPelny,&#xD;
[Dokument Obiegu Data Wprowadzenia] = CONVERT(VARCHAR(10), DoN_DataDok, 20),&#xD;
[Dokument Obiegu Tytuł] = ISNULL(DoN_Tytul,''(BRAK)''),&#xD;
[Dokument Obiegu Opis] = ISNULL(DoN_Dotyczy,''(BRAK)''),&#xD;
[Dokument Obiegu Typ] = CASE DoN_Typ WHEN 1 THEN ''Firmowy'' ELSE ''Wspólny'' END,&#xD;
[Dokument Obiegu Proces Obiegu] = ISNULL(DoN_ProcesKod,''(BRAK)''),&#xD;
[Dokument Obiegu Numer Obcy] = ISNULL(DoN_NumerObcy,''(BRAK)''),&#xD;
[Operator Tworzący Zapis] = DoN_OpeModKod,&#xD;
[Operator Modyfikujący Zapis] = DoN_OpeZalKod,&#xD;
[Dokument Obiegu Ilość] = NULL,&#xD;
[Dokument Obiegu Ilość Dokumentów Powiązanych] = NULL,&#xD;
[Dokument Obiegu Ilość Kontrahentów] = NULL,&#xD;
[Kontrahent Kod] = NULL,&#xD;
[Kontrahent Nazwa] = NULL,&#xD;
[Dokument Powiązany Typ] = NULL,&#xD;
[Dokument Powiązany Numer] = NULL,&#xD;
[Dokument Powiązany Wartość] = NULL,&#xD;
---ETAP BIEŻĄCY&#xD;
[Etap Symbol] = eb2.SE_Symbol,&#xD;
[Etap Nazwa] = eb2.SE_Nazwa,&#xD;
[Etap Poziom] = CASE DnPr_Poziom WHEN 1 THEN ''Główny'' ELSE ''Powiązany'' END,&#xD;
[Etap Obowiązkowy] = CASE DnE_Obowiazkowy WHEN 0 THEN ''Nie'' ELSE ''Tak'' END,&#xD;
[Etap Wykonany] = CASE DnE_Wykonany WHEN 0 THEN ''Nie'' WHEN 1 THEN ''Tak'' WHEN 3 THEN ''Bieżący'' ELSE ''Pominięty'' END,&#xD;
[Etap Bieżący Symbol] = eb1.SE_Symbol,&#xD;
[Etap Bieżący Nazwa] = eb1.SE_Nazwa,&#xD;
[Etap Termin Wykonania] = CONVERT(VARCHAR(10), DnE_TerminWykonania, 20),&#xD;
[Etap Data Rozpoczęcia] = CONVERT(VARCHAR(10), Data1, 20),&#xD;
[Etap Data Zakończenia] = CONVERT(VARCHAR(10), Data2, 20),&#xD;
[Etap Czas Trwania] = CzasEtapu,&#xD;
[Etap Ilość] = EtapIlosc,&#xD;
---HISTORIA&#xD;
[Etap Data Zmiany] = NULL,&#xD;
[Operator Kod] = DoN_OpeModKod,&#xD;
[Operator Komentarz] = NULL,&#xD;
[Etap Przed Zmianą] = NULL,&#xD;
[Etap Po Zmianie] = NULL,&#xD;
[Operacja Typ] = NULL,&#xD;
[Operacja Ilość] = NULL,&#xD;
[Operator Wprowadzający] = zal.Ope_Kod,&#xD;
[Operator Modyfikujący] = mod.Ope_Kod,&#xD;
[Data Analizy] = GETDATE()&#xD;
----------KONTEKSTY&#xD;
,[Dokument Obiegu Numer __PROCID__] = 25106&#xD;
,[Dokument Obiegu Numer __ORGID__] = DoN_DoNID&#xD;
&#xD;
FROM CDN.DokNag&#xD;
LEFT JOIN #tmpSeria ser ON DoN_DDfId = DDf_DDfID&#xD;
left join CDN.DokNagProcesEtapy ON DnPr_DoNID = DoN_DoNID &#xD;
left join CDN.DokNagEtapy ON DnPr_DnPrID = DnE_DnPrID &#xD;
left join ' + @Etapy + ' eb1 ON eb1.SE_SEID = DoN_EtapBiezacyLp &#xD;
left join ' + @Etapy + ' eb2 ON eb2.SE_SEID = DnE_EtapID&#xD;
left join ' + @Operatorzy + ' ON DnE_OpeId = Ope_OpeID&#xD;
left join (SELECT&#xD;
[EtapIleID] = DnE_DnEId,&#xD;
[EtapIlosc] = COUNT(DnE_DnEId)&#xD;
FROM CDN.DokNag&#xD;
left join CDN.DokNagProcesEtapy ON DnPr_DoNID = DoN_DoNID &#xD;
left join CDN.DokNagEtapy ON DnPr_DnPrID = DnE_DnPrID&#xD;
GROUP BY DnE_DnEId) h ON EtapIleID = DnE_DnEId&#xD;
&#xD;
left join&#xD;
-----WYLICZENIE CZASU TRWANIA ETAPU&#xD;
(&#xD;
SELECT * FROM&#xD;
(&#xD;
SELECT &#xD;
[EtapID] = DnE_DnEId,&#xD;
[DokID] = DoN_DoNID,&#xD;
[Data1] = CASE WHEN DnE_EtapID=1 AND DnE_Wykonany=1 THEN DnE_TerminOd WHEN DnE_EtapID&lt;&gt;1 AND DnE_Wykonany=1 THEN Data1 ELSE NULL END,&#xD;
[Data2] = Data2,&#xD;
[CzasEtapu] = CASE&#xD;
WHEN eb2.SE_Symbol = DnEH_SymbolPrzed AND DnE_EtapID=1 THEN DATEDIFF(hh,DnE_TerminOd,Data2)&#xD;
WHEN eb2.SE_Symbol = DnEH_SymbolPrzed AND DnE_EtapID&lt;&gt;1 THEN DATEDIFF(hh,Data1,Data2)&#xD;
END&#xD;
FROM CDN.DokNag&#xD;
left join CDN.DokNagEtapyHistoria ON DnEH_DoNID = DoN_DoNID &#xD;
left join CDN.DokNagProcesEtapy ON DnPr_DoNID = DoN_DoNID &#xD;
left join CDN.DokNagEtapy ON DnPr_DnPrID = DnE_DnPrID&#xD;
left join ' + @Etapy + ' eb2 ON eb2.SE_SEID = DnE_EtapID&#xD;
left join&#xD;
(&#xD;
SELECT&#xD;
[D2ID] = DnE_DnEId,&#xD;
[D2DokID] = DoN_DoNID,&#xD;
[Data2] = MAX(DnEH_DataZmiany)&#xD;
FROM CDN.DokNag&#xD;
left join CDN.DokNagEtapyHistoria ON DnEH_DoNID = DoN_DoNID &#xD;
left join CDN.DokNagProcesEtapy ON DnPr_DoNID = DoN_DoNID &#xD;
left join CDN.DokNagEtapy ON DnPr_DnPrID = DnE_DnPrID&#xD;
left join ' + @Etapy + ' eb2 ON eb2.SE_SEID = DnE_EtapID&#xD;
left join CDN.DokNagEtapyKolejne ON DnEK_DnPrID = DnPr_DnPrID AND DnEK_DnPrID = DnE_DnPrID&#xD;
WHERE (DnEH_Typ IN(3,5) AND DnE_Wykonany = 1 AND eb2.SE_Symbol = DnEH_SymbolPrzed)&#xD;
GROUP BY DnE_DnEId, DoN_DoNID&#xD;
) f ON DnE_DnEId = D2ID AND D2DokID = DoN_DoNID&#xD;
left join &#xD;
( &#xD;
SELECT&#xD;
[D1ID] = DnE_DnEId,&#xD;
[D1DokID] = DoN_DoNID,&#xD;
[Data1] = MIN(DnEH_DataZmiany)&#xD;
FROM CDN.DokNag&#xD;
left join CDN.DokNagEtapyHistoria ON DnEH_DoNID = DoN_DoNID &#xD;
left join CDN.DokNagProcesEtapy ON DnPr_DoNID = DoN_DoNID &#xD;
left join CDN.DokNagEtapy ON DnPr_DnPrID = DnE_DnPrID&#xD;
left join ' + @Etapy + ' eb2 ON eb2.SE_SEID = DnE_EtapID&#xD;
WHERE DnEH_Typ IN(3,5) AND DnE_Wykonany = 1 AND eb2.SE_Symbol = DnEH_Symbolpo&#xD;
GROUP BY DnE_DnEId, DoN_DoNID&#xD;
) j ON DnE_DnEId = D1ID AND D1DokID = DoN_DoNID&#xD;
WHERE DnEH_Typ IN(3,5) AND DnE_Wykonany = 1 &#xD;
) &#xD;
g WHERE [CzasEtapu] IS NOT NULL)&#xD;
j ON EtapID = DnE_DnEId AND DokID = DoN_DoNID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON DoN_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON DoN_OpeModID = mod.Ope_OpeId&#xD;
&#xD;
UNION&#xD;
&#xD;
----ETAPY HIST&#xD;
&#xD;
SELECT &#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
[Dokument Obiegu Seria] =&#xD;
CASE when isnull(ser.seria,0) = 5 then &#xD;
substring(DoN_NumerPelny,0,CHARINDEX(''/'',DoN_NumerPelny,0))&#xD;
ELSE &#xD;
ISNULL(PARSENAME(REPLACE(substring(DoN_NumerPelny,CHARINDEX(''/'',DoN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
END,&#xD;
[Dokument Obiegu Numer] = DoN_NumerPelny,&#xD;
[Dokument Obiegu Data Wprowadzenia] = CONVERT(VARCHAR(10), DoN_DataDok, 20),&#xD;
[Dokument Obiegu Tytuł] = ISNULL(DoN_Tytul,''(BRAK)''),&#xD;
[Dokument Obiegu Opis] = ISNULL(DoN_Dotyczy,''(BRAK)''),&#xD;
[Dokument Obiegu Typ] = CASE DoN_Typ WHEN 1 THEN ''Firmowy'' ELSE ''Wspólny'' END,&#xD;
[Dokument Obiegu Proces Obiegu] = ISNULL(DoN_ProcesKod,''(BRAK)''),&#xD;
[Dokument Obiegu Numer Obcy] = ISNULL(DoN_NumerObcy,''(BRAK)''),&#xD;
[Operator Tworzący Zapis] = DoN_OpeModKod,&#xD;
[Operator Modyfikujący Zapis] = DoN_OpeZalKod,&#xD;
[Dokument Obiegu Ilość] = NULL,&#xD;
[Dokument Obiegu Ilość Dokumentów Powiązanych] = NULL,&#xD;
[Dokument Obiegu Ilość Kontrahentów] = NULL,&#xD;
[Kontrahent Kod] = NULL,&#xD;
[Kontrahent Nazwa] = NULL,&#xD;
[Dokument Powiązany Typ] = NULL,&#xD;
[Dokument Powiązany Numer] = NULL,&#xD;
[Dokument Powiązany Wartość] = NULL,&#xD;
---ETAP BIEŻĄCY&#xD;
[Etap Symbol] = NULL,&#xD;
[Etap Nazwa] = NULL,&#xD;
[Etap Poziom] = NULL,&#xD;
[Etap Obowiązkowy] = NULL,&#xD;
[Etap Wykonany] = NULL,&#xD;
[Etap Bieżący Symbol] = eb1.SE_Symbol,&#xD;
[Etap Bieżący Nazwa] = eb1.SE_Nazwa,&#xD;
[Etap Termin Wykonania] = NULL,&#xD;
[Etap Data Rozpoczęcia] = NULL,&#xD;
[Etap Data Zakończenia] = NULL,&#xD;
[Etap Czas Trwania] = NULL,&#xD;
[Etap Ilość] = NULL,&#xD;
---HISTORIA&#xD;
[Etap Data Zmiany] = CONVERT(VARCHAR(10), DnEH_DataZmiany, 20),&#xD;
[Operator Kod] = DnEH_OpeKod,&#xD;
[Operator Komentarz] = DnEH_Komentarz,&#xD;
[Etap Przed Zmianą] = DnEH_SymbolPrzed,&#xD;
[Etap Po Zmianie] = DnEH_SymbolPo,&#xD;
[Operacja Typ] = CASE DnEH_Typ&#xD;
WHEN 1 THEN ''Dodanie nowego etapu''&#xD;
WHEN 2 THEN ''Wycofanie do poprzedniego etapu''&#xD;
WHEN 3 THEN ''Przejście do kolejnego etapu''&#xD;
WHEN 4 THEN ''Powrót do poprzedniego etapu''&#xD;
WHEN 5 THEN ''Zakończenie procesu''&#xD;
END,&#xD;
[Operacja Ilość] = ZmianaIlosc,&#xD;
[Operator Wprowadzający] = zal.Ope_Kod,&#xD;
[Operator Modyfikujący] = mod.Ope_Kod,&#xD;
[Data Analizy] = GETDATE()&#xD;
&#xD;
----------KONTEKSTY&#xD;
,[Dokument Obiegu Numer __PROCID__] = 25106&#xD;
,[Dokument Obiegu Numer __ORGID__] = DoN_DoNID&#xD;
&#xD;
FROM CDN.DokNag&#xD;
LEFT JOIN #tmpSeria ser ON DoN_DDfId = DDf_DDfID&#xD;
left join CDN.DokNagEtapyHistoria ON DnEH_DoNID = DoN_DoNID &#xD;
left join CDN.DokNagProcesEtapy ON DnPr_DoNID = DoN_DoNID &#xD;
left join CDN.DokNagEtapy ON DnPr_DnPrID = DnE_DnPrID&#xD;
left join ' + @Etapy + ' eb1 ON eb1.SE_SEID = DoN_EtapBiezacyLp &#xD;
left join ' + @Etapy + ' eb2 ON eb2.SE_SEID = DnE_EtapID&#xD;
left join (SELECT&#xD;
[ZmianaIleID] = DnEH_DnEHID,&#xD;
[ZmianaIlosc] = COUNT(DnEH_DnEHID)&#xD;
FROM CDN.DokNag&#xD;
left join CDN.DokNagEtapyHistoria ON DnEH_DoNID = DoN_DoNID &#xD;
GROUP BY DnEH_DnEHID) h ON ZmianaIleID = DnEH_DnEHID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON DoN_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON DoN_OpeModID = mod.Ope_OpeId&#xD;
WHERE DnEH_DnEHID IS NOT NULL&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
----DOKUMENTY OBD&#xD;
&#xD;
SELECT&#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
[Dokument Obiegu Seria] =&#xD;
CASE when isnull(ser.seria,0) = 5 then &#xD;
substring(DoN_NumerPelny,0,CHARINDEX(''/'',DoN_NumerPelny,0))&#xD;
ELSE &#xD;
ISNULL(PARSENAME(REPLACE(substring(DoN_NumerPelny,CHARINDEX(''/'',DoN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
END,&#xD;
[Dokument Obiegu Numer] = DoN_NumerPelny,&#xD;
[Dokument Obiegu Data Wprowadzenia] = CONVERT(VARCHAR(10), DoN_DataDok, 20),&#xD;
[Dokument Obiegu Tytuł] = ISNULL(DoN_Tytul,''(BRAK)''),&#xD;
[Dokument Obiegu Opis] = ISNULL(DoN_Dotyczy,''(BRAK)''),&#xD;
[Dokument Obiegu Typ] = CASE DoN_Typ WHEN 1 THEN ''Firmowy'' ELSE ''Wspólny'' END,&#xD;
[Dokument Obiegu Proces Obiegu] = ISNULL(DoN_ProcesKod,''(BRAK)''),&#xD;
[Dokument Obiegu Numer Obcy] = ISNULL(DoN_NumerObcy,''(BRAK)''),&#xD;
[Operator Tworzący Zapis] = DoN_OpeModKod,&#xD;
[Operator Modyfikujący Zapis] = DoN_OpeZalKod,&#xD;
[Dokument Obiegu Ilość] = OBDIle,&#xD;
[Dokument Obiegu Ilość Dokumentów Powiązanych] = NULL,&#xD;
[Dokument Obiegu Ilość Kontrahentów] = NULL,&#xD;
[Kontrahent Kod] = NULL,&#xD;
[Kontrahent Nazwa] = NULL,&#xD;
[Dokument Powiązany Typ] = NULL,&#xD;
[Dokument Powiązany Numer] = NULL,&#xD;
[Dokument Powiązany Wartość] = NULL,&#xD;
---ETAP BIEŻĄCY&#xD;
[Etap Symbol] = NULL,&#xD;
[Etap Nazwa] = NULL,&#xD;
[Etap Poziom] = NULL,&#xD;
[Etap Obowiązkowy] = NULL,&#xD;
[Etap Wykonany] = NULL,&#xD;
[Etap Bieżący Symbol] = eb1.SE_Symbol,&#xD;
[Etap Bieżący Nazwa] = eb1.SE_Nazwa,&#xD;
[Etap Termin Wykonania] = NULL,&#xD;
[Etap Data Rozpoczęcia] = NULL,&#xD;
[Etap Data Zakończenia] = NULL,&#xD;
[Etap Czas Trwania] = NULL,&#xD;
[Etap Ilość] = NULL,&#xD;
---HISTORIA&#xD;
[Etap Data Zmiany] = NULL,&#xD;
[Operator Kod] = NULL,&#xD;
[Operator Komentarz] = NULL,&#xD;
[Etap Przed Zmianą] = NULL,&#xD;
[Etap Po Zmianie] = NULL,&#xD;
[Operacja Typ] = NULL,&#xD;
[Operacja Ilość] = NULL,&#xD;
[Operator Wprowadzający] = zal.Ope_Kod,&#xD;
[Operator Modyfikujący] = mod.Ope_Kod,&#xD;
[Data Analizy] = GETDATE()&#xD;
----------KONTEKSTY&#xD;
,[Dokument Obiegu Numer __PROCID__] = 25106&#xD;
,[Dokument Obiegu Numer __ORGID__] = DoN_DoNID&#xD;
&#xD;
FROM CDN.DokNag&#xD;
LEFT JOIN #tmpSeria ser ON DoN_DDfId = DDf_DDfID&#xD;
left join ' + @Etapy + ' eb1 ON eb1.SE_SEID = DoN_EtapBiezacyLp &#xD;
left join&#xD;
(SELECT [OBDIleID] = DoN_DoNID,[OBDIle] = COUNT(DoN_DoNID) FROM CDN.DokNag GROUP BY DoN_DoNID) a ON OBDIleID = DoN_DoNID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON DoN_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON DoN_OpeModID = mod.Ope_OpeId&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
----DOKUMENTY POWIĄZANE I ICH WARTOŚCI&#xD;
SELECT&#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
[Dokument Obiegu Seria] =&#xD;
CASE when isnull(ser.seria,0) = 5 then &#xD;
substring(DoN_NumerPelny,0,CHARINDEX(''/'',DoN_NumerPelny,0))&#xD;
ELSE &#xD;
ISNULL(PARSENAME(REPLACE(substring(DoN_NumerPelny,CHARINDEX(''/'',DoN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
END,&#xD;
[Dokument Obiegu Numer] = DoN_NumerPelny,&#xD;
[Dokument Obiegu Data Wprowadzenia] = CONVERT(VARCHAR(10), DoN_DataDok, 20),&#xD;
[Dokument Obiegu Tytuł] = ISNULL(DoN_Tytul,''(BRAK)''),&#xD;
[Dokument Obiegu Opis] = ISNULL(DoN_Dotyczy,''(BRAK)''),&#xD;
[Dokument Obiegu Typ] = CASE DoN_Typ WHEN 1 THEN ''Firmowy'' ELSE ''Wspólny'' END,&#xD;
[Dokument Obiegu Proces Obiegu] = ISNULL(DoN_ProcesKod,''(BRAK)''),&#xD;
[Dokument Obiegu Numer Obcy] = ISNULL(DoN_NumerObcy,''(BRAK)''),&#xD;
[Operator Tworzący Zapis] = DoN_OpeModKod,&#xD;
[Operator Modyfikujący Zapis] = DoN_OpeZalKod,&#xD;
[Dokument Obiegu Ilość] = NULL,&#xD;
[Dokument Obiegu Ilość Dokumentów Powiązanych] = DokIlosc,&#xD;
[Dokument Obiegu Ilość Kontrahentów] = NULL,&#xD;
[Kontrahent Kod] = NULL,&#xD;
[Kontrahent Nazwa] = NULL,&#xD;
[Dokument Powiązany Typ] = &#xD;
CASE DoR_DokumentTyp&#xD;
WHEN 302 THEN ''Fak. sprzedaży'' WHEN 301 THEN ''Fak. zakupu'' WHEN 305 THEN ''Paragon'' WHEN 320 THEN ''Faktura pro forma'' WHEN 308 THEN ''Rezerwacja obiorcy''&#xD;
WHEN 309 THEN ''Zamówienie dostawcy'' WHEN 322 THEN ''Faktura wewnętrzna sprzedaży'' WHEN 321 THEN ''Faktura wewnętrzna zakupu'' WHEN 350 THEN ''Faktura rolnik rycza?towy'' &#xD;
WHEN 345 THEN ''Tax Free'' WHEN 306 THEN ''Wydanie zewnętrzne'' WHEN 307 THEN ''Przyjęcie zewnętrzne'' WHEN 304 THEN ''Rozchód wewnętrzny'' WHEN 303 THEN ''Przyjęcie wewnętrzne''&#xD;
WHEN 312 THEN ''Przesunięcie między-magazynowe'' WHEN 310 THEN ''Bilnas otwarcia magazynu'' WHEN 311 THEN ''Arkusz inwentaryzacyjny'' WHEN 317 THEN ''Przyjęcie wewnętrzne produktu''&#xD;
WHEN 318 THEN ''Rozchód wewnętrzny produktu'' WHEN 314 THEN ''Wydanie kaucji'' WHEN 313 THEN ''Przyjęcie kaucji'' WHEN 380 THEN ''Awizo ECOD'' WHEN 700 THEN ''Kontakt CRM'' &#xD;
WHEN 999 THEN ''Rejestr VAT'' WHEN 900 THEN ''Zlecenie serwisowe''  &#xD;
WHEN 1003 THEN ''Ewidencja dodatkowa'' WHEN 1004 THEN ''Środek Trwały'' WHEN 1005 THEN ''Wyposażenie'' WHEN 1122 THEN ''Raport KB'' WHEN 1000 THEN ''Zapis kasowy'' WHEN 1001 THEN ''Zdarzenie w preliminarzu''&#xD;
WHEN 1145 THEN ''Kompensata'' WHEN 1002 THEN ''Ponaglenie zapłaty KB'' WHEN 223 THEN ''Potwierdzenie salda KB'' WHEN 111 THEN ''Nota odsetkowa KB'' WHEN 114 THEN ''Delegacja'' &#xD;
WHEN 112 THEN ''Ponaglenie zapłaty KH'' WHEN 113 THEN ''Nota odsetkowa KH'' WHEN 111 THEN ''Potwierdzenie salda KH'' ELSE ''(BRAK)'' END,&#xD;
[Dokument Powiązany Numer] = CASE DoR_DokumentTyp&#xD;
WHEN 900 THEN SrZ_NumerPelny &#xD;
WHEN 700 THEN CRK_NumerPelny &#xD;
WHEN 999 THEN VaN_Dokument &#xD;
WHEN 1003 THEN EDN_NumerPelny&#xD;
WHEN 1004 THEN SrT_NrInwent&#xD;
WHEN 1005 THEN Wyp_NrInwent&#xD;
WHEn 1122 THEN BRp_NumerPelny&#xD;
WHEN 1000 THEN BZp_NumerPelny&#xD;
WHEN 1001 THEN BZd_NumerPelny&#xD;
WHEN 1145 THEN KPN_NumerPelny&#xD;
WHEN 1002 THEN BDN_NumerPelny&#xD;
WHEN 223 THEN BDN_NumerPelny&#xD;
WHEN 221 THEN NON_NumerPelny&#xD;
WHEN 114 THEN DLN_NumerPelny&#xD;
WHEN 111 THEN KDN_NumerPelny&#xD;
WHEN 112 THEN KDN_NumerPelny&#xD;
WHEN 113 THEN KDN_NumerPelny&#xD;
ELSE TrN_NumerPelny END,&#xD;
[Dokument Powiązany Wartość] = CASE DoR_DokumentTyp&#xD;
WHEN 900 THEN SrZ_WartoscNetto&#xD;
WHEN 700 THEN 0 &#xD;
WHEN 999 THEN VaN_WartoscZak&#xD;
WHEN 1003 THEN EDN_KwotaRazem&#xD;
WHEN 1004 THEN SrT_WartoscBilan&#xD;
WHEN 1005 THEN Wyp_WartoscZakup&#xD;
WHEn 1122 THEN BRp_Przychody&#xD;
WHEN 1000 THEN BZp_Kwota&#xD;
WHEN 1001 THEN BZd_Kwota&#xD;
WHEN 1145 THEN KPN_RazemKwotaRoz&#xD;
WHEN 1002 THEN BDN_RazemKwota2&#xD;
WHEN 223 THEN BDN_RazemKwota2&#xD;
WHEN 221 THEN NON_RazemKwota&#xD;
WHEN 114 THEN DLN_KwotaWal&#xD;
WHEN 111 THEN KDN_RazemKwota2&#xD;
WHEN 112 THEN KDN_RazemKwota2&#xD;
WHEN 113 THEN KDN_RazemKwota2&#xD;
ELSE TrN_RazemNetto END,&#xD;
---ETAP BIEŻĄCY&#xD;
[Etap Symbol] = NULL,&#xD;
[Etap Nazwa] = NULL,&#xD;
[Etap Poziom] = NULL,&#xD;
[Etap Obowiązkowy] = NULL,&#xD;
[Etap Wykonany] = NULL,&#xD;
[Etap Bieżący Symbol] = eb1.SE_Symbol,&#xD;
[Etap Bieżący Nazwa] = eb1.SE_Nazwa,&#xD;
[Etap Termin Wykonania] = NULL,&#xD;
[Etap Data Rozpoczęcia] = NULL,&#xD;
[Etap Data Zakończenia] = NULL,&#xD;
[Etap Czas Trwania] = NULL,&#xD;
[Etap Ilość] = NULL,&#xD;
---HISTORIA&#xD;
[Etap Data Zmiany] = NULL,&#xD;
[Operator Kod] = NULL,&#xD;
[Operator Komentarz] = NULL,&#xD;
[Etap Przed Zmianą] = NULL,&#xD;
[Etap Po Zmianie] = NULL,&#xD;
[Operacja Typ] = NULL,&#xD;
[Operacja Ilość] = NULL,&#xD;
[Operator Wprowadzający] = zal.Ope_Kod,&#xD;
[Operator Modyfikujący] = mod.Ope_Kod,&#xD;
[Data Analizy] = GETDATE()&#xD;
----------KONTEKSTY&#xD;
,[Dokument Obiegu Numer __PROCID__] = 25106&#xD;
,[Dokument Obiegu Numer __ORGID__] = DoN_DoNID&#xD;
&#xD;
FROM CDN.DokNag&#xD;
LEFT JOIN #tmpSeria ser ON DoN_DDfId = DDf_DDfID&#xD;
left join CDN.DokRelacje ON DoR_ParentId = DoN_DoNID AND DoR_ParentTyp=750&#xD;
left join CDN.SrsZlecenia ON SrZ_SrZId=DoR_DokumentId&#xD;
left join CDN.CRMKontakty ON CRK_CRKId=DoR_DokumentId&#xD;
left join CDN.VatNag ON VaN_VaNID=DoR_DokumentId&#xD;
left join CDN.Tranag ON TrN_TrNID=DoR_DokumentId&#xD;
left join CDN.EwidDodNag ON EDN_EDNID=DoR_DokumentId&#xD;
left join CDN.Trwale ON SrT_SrTID=DoR_DokumentId&#xD;
left join CDN.Wyposazenie ON Wyp_WypID=DoR_DokumentId&#xD;
left join CDN.BnkRaporty ON BRp_BRpID=DoR_DokumentId&#xD;
left join CDN.BnkZapisy ON BZp_BZpID=DoR_DokumentId&#xD;
left join CDN.BnkZdarzenia ON BZd_BZdID=DoR_DokumentId&#xD;
left join CDN.KompensatyNag ON KPN_KPNID=DoR_DokumentId&#xD;
left join CDN.NotyOdsNag ON NON_NONId=DoR_DokumentId&#xD;
left join CDN.DlgNag ON DLN_DLNId=DoR_DokumentId&#xD;
left join CDN.BnkDokNag ON BDN_BDNId=DoR_DokumentId&#xD;
left join CDN.KsiDokNag ON KDN_KDNId=DoR_DokumentId&#xD;
left join&#xD;
(---ILOŚC DOKUMENTÓW POWIĄZANYCH Z OBD&#xD;
SELECT&#xD;
[DokIleID] = DoR_DoRId,&#xD;
[DokIlosc] = COUNT(DoR_DokumentId)&#xD;
FROM CDN.DokNag&#xD;
left join CDN.DokRelacje ON DoR_ParentId = DoN_DoNID AND DoR_ParentTyp=750&#xD;
GROUP BY DoR_DoRId) b ON DokIleID = DoR_DoRId&#xD;
left join ' + @Etapy + ' eb1 ON eb1.SE_SEID = DoN_EtapBiezacyLp &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON DoN_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON DoN_OpeModID = mod.Ope_OpeId&#xD;
WHERE DoR_DokumentId IS NOT NULL&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
----KONTRAHENCI&#xD;
SELECT&#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
[Dokument Obiegu Seria] =&#xD;
CASE when isnull(ser.seria,0) = 5 then &#xD;
substring(DoN_NumerPelny,0,CHARINDEX(''/'',DoN_NumerPelny,0))&#xD;
ELSE &#xD;
ISNULL(PARSENAME(REPLACE(substring(DoN_NumerPelny,CHARINDEX(''/'',DoN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
END,&#xD;
[Dokument Obiegu Numer] = DoN_NumerPelny,&#xD;
[Dokument Obiegu Data Wprowadzenia] = CONVERT(VARCHAR(10), DoN_DataDok, 20),&#xD;
[Dokument Obiegu Tytuł] = ISNULL(DoN_Tytul,''(BRAK)''),&#xD;
[Dokument Obiegu Opis] = ISNULL(DoN_Dotyczy,''(BRAK)''),&#xD;
[Dokument Obiegu Typ] = CASE DoN_Typ WHEN 1 THEN ''Firmowy'' ELSE ''Wspólny'' END,&#xD;
[Dokument Obiegu Proces Obiegu] = ISNULL(DoN_ProcesKod,''(BRAK)''),&#xD;
[Dokument Obiegu Numer Obcy] = ISNULL(DoN_NumerObcy,''(BRAK)''),&#xD;
[Operator Tworzący Zapis] = DoN_OpeModKod,&#xD;
[Operator Modyfikujący Zapis] = DoN_OpeZalKod,&#xD;
[Dokument Obiegu Ilość] = NULL,&#xD;
[Dokument Obiegu Ilość Dokumentów Powiązanych] = NULL,&#xD;
[Dokument Obiegu Ilość Kontrahentów] = KntIlosc,&#xD;
[Kontrahent Kod] = Pod_Kod,&#xD;
[Kontrahent Nazwa] = Pod_Nazwa1,&#xD;
[Dokument Powiązany Typ] = NULL,&#xD;
[Dokument Powiązany Numer] = NULL,&#xD;
[Dokument Powiązany Wartość] = NULL,&#xD;
---ETAP BIEŻĄCY&#xD;
[Etap Symbol] = NULL,&#xD;
[Etap Nazwa] = NULL,&#xD;
[Etap Poziom] = NULL,&#xD;
[Etap Obowiązkowy] = NULL,&#xD;
[Etap Wykonany] = NULL,&#xD;
[Etap Bieżący Symbol] = eb1.SE_Symbol,&#xD;
[Etap Bieżący Nazwa] = eb1.SE_Nazwa,&#xD;
[Etap Termin Wykonania] = NULL,&#xD;
[Etap Data Rozpoczęcia] = NULL,&#xD;
[Etap Data Zakończenia] = NULL,&#xD;
[Etap Czas Trwania] = NULL,&#xD;
[Etap Ilość] = NULL,&#xD;
---HISTORIA&#xD;
[Etap Data Zmiany] = NULL,&#xD;
[Operator Kod] = NULL,&#xD;
[Operator Komentarz] = NULL,&#xD;
[Etap Przed Zmianą] = NULL,&#xD;
[Etap Po Zmianie] = NULL,&#xD;
[Operacja Typ] = NULL,&#xD;
[Operacja Ilość] = NULL,&#xD;
[Operator Wprowadzający] = zal.Ope_Kod,&#xD;
[Operator Modyfikujący] = mod.Ope_Kod,&#xD;
[Data Analizy] = GETDATE()&#xD;
----------KONTEKSTY&#xD;
,[Dokument Obiegu Numer __PROCID__] = 25106&#xD;
,[Dokument Obiegu Numer __ORGID__] = DoN_DoNID&#xD;
&#xD;
FROM CDN.DokNag&#xD;
LEFT JOIN #tmpSeria ser ON DoN_DDfId = DDf_DDfID&#xD;
left join CDN.DokPodmioty ON DoP_DoNID = DoN_DoNID&#xD;
left join CDN.PodmiotyView ON DoP_PodmiotID = Pod_PodId and Pod_PodmiotTyp = DoP_PodmiotTyp&#xD;
left join &#xD;
(---ILOŚC KONTRAHENTÓW DLA OBD&#xD;
SELECT&#xD;
[KntIleID] = DoP_DoPId,&#xD;
[KntIlosc] = COUNT(Pod_Kod)&#xD;
FROM CDN.DokNag&#xD;
left join CDN.DokPodmioty ON DoP_DoNID = DoN_DoNID&#xD;
left join CDN.PodmiotyView ON DoP_PodmiotID = Pod_PodId and Pod_PodmiotTyp = DoP_PodmiotTyp&#xD;
GROUP BY DoP_DoPId) c ON KntIleID = DoP_DoPId&#xD;
left join ' + @Etapy + ' eb1 ON eb1.SE_SEID = DoN_EtapBiezacyLp &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON DoN_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON DoN_OpeModID = mod.Ope_OpeId&#xD;
WHERE DoP_DoPId IS NOT NULL&#xD;
&#xD;
'&#xD;
exec(@sql)&#xD;
drop table #tmpseria&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QLNy8SvsWvjndP4rYWmIrmw65/eZ7QPiim3cKUThrJOp91uo2s2QytZVCI0ahIBHPzdhq77ZDLGQ+f2RJLU3sFXEc1SuM3wqaHoo22M9HrCKhlnEsePvAv0U4SOg8UAOetpVeglsIy6u2qkyMYfCzfyGH01YAyNnHG1PfSTj0mo3mY9wQBK+juj2phtqOBAWy88IAkYae7OA==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Data Wprowadzenia " caption="Dokument Data Wprowadzenia " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Tytuł" caption="Dokument Tytuł" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Typ" caption="Dokument Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Proces Obiegu" caption="Dokument Proces Obiegu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer Obcy" caption="Dokument Numer Obcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Tworzący Zapis" caption="Operator Tworzący Zapis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący Zapis" caption="Operator Modyfikujący Zapis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Ilość" caption="Dokument Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Ilość Dokumentów Powiązanych" caption="Dokument Ilość Dokumentów Powiązanych" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Dokument Ilość Kontrahentów" caption="Dokument Ilość Kontrahentów" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Typ" caption="Dokument Powiązany Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Numer" caption="Dokument Powiązany Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Powiązany Wartość" caption="Dokument Powiązany Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Etap Symbol" caption="Etap Symbol" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Etap Nazwa" caption="Etap Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Etap Poziom" caption="Etap Poziom" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Etap Obowiązkowy" caption="Etap Obowiązkowy" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Etap Wykonany" caption="Etap Wykonany" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Etap Bieżący Symbol" caption="Etap Bieżący Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Etap Bieżący Nazwa" caption="Etap Bieżący Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Etap Termin Wykonania" caption="Etap Termin Wykonania" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Etap Data Rozpoczęcia" caption="Etap Data Rozpoczęcia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Etap Data Zakończenia" caption="Etap Data Zakończenia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Etap Czas Trwania" caption="Etap Czas Trwania" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Etap Ilość" caption="Etap Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Etap Data Zmiany" caption="Etap Data Zmiany" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Kod" caption="Operator Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Komentarz" caption="Operator Komentarz" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Etap Przed Zmianą" caption="Etap Przed Zmianą" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Etap Po Zmianie" caption="Etap Po Zmianie" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operacja Typ" caption="Operacja Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operacja Ilość" caption="Operacja Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Obiegu Dokumentów wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport umożliwia analizę dla modułu Obiegu Dokumentów na podstawie dokumentów powiązanych, kontrahentów, operacji oraz etapów. Oparty jest na tabelach DokNag oraz DokRelacje.</a:description><a:id>27</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>27. Raport Obiegu Dokumentów</a:mainLinkName><a:modifiedOn>2025-02-04T12:24:58.947</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2018-05-21T14:25:22.557</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Opisów Analitycznych&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SELECT Wyy_wyyid ID,isnull(wyy_nazwa,Wyy_Kod) Nazwa INTO #tmproots from cdn.Wymiary  where wyy_parentid = 0&#xD;
declare @kolumny varchar(max)&#xD;
SET @kolumny = ''&#xD;
&#xD;
;WITH g(nazwa, kod, ID,parent,RootID,aktywny, poziom, sciezka,typsl)&#xD;
AS&#xD;
(&#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,wyy_aktywny, 0 as poziom, convert(nvarchar(1024), '') as sciezka,Wyy_TypWymiaru&#xD;
      FROM cdn.Wymiary &#xD;
      WHERE Wyy_ParentID = 0&#xD;
      --and wyy_wyyid = @TableID&#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,wyy_aktywny, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.wyy_kod) as sciezka,Wyy_TypWymiaru&#xD;
      FROM g p&#xD;
      JOIN cdn.Wymiary c&#xD;
      ON c.Wyy_ParentID = p.ID &#xD;
      WHERE c.Wyy_ParentID &lt;&gt; 0 &#xD;
)     &#xD;
SELECT  g.*,WyW_SlownikId, WyW_DokumentId, WyW_LpPozycji, WYW_GUID, WyW_DokumentTyp INTO #tmpWymiary FROM g LEFT JOIN cdn.WymiaryWartosci ON ID = WyW_WyyId&#xD;
&#xD;
&#xD;
insert into #tmpWymiary &#xD;
SELECT Coalesce(Knt_Nazwa1,Kat_KodSzczegol,Acc_Nazwa) nazwa ,Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) kod,ID-10000000,ID,RootID,aktywny,poziom + 1,sciezka +'\'+Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) sciezka,typsl,wyw_slownikid,WyW_DokumentId,WyW_LpPozycji,WyW_GUID,WyW_DokumentTyp&#xD;
FROM #tmpWymiary &#xD;
LEFT JOIN cdn.Konta on Typsl = 3 and WyW_SlownikId = acc_accid&#xD;
LEFT JOIN cdn.Kontrahenci on Typsl = 4 and WyW_SlownikId = Knt_KntId&#xD;
Left join cdn.Kategorie on Typsl = 2 and WyW_SlownikId = kat_katid&#xD;
WHERE Typsl &lt;&gt; 1 and Wyw_SlownikId &lt;&gt;0&#xD;
&#xD;
while exists (select * from #tmproots)&#xD;
begin&#xD;
declare @TableID int&#xD;
declare @TableName Varchar(100)&#xD;
&#xD;
    select top 1 @TableID = ID&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
     Select top 1 @TableName = Nazwa&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpWymiary&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
&#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= Parent WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ ' = kod WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N' ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path Varchar(200)'&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path = sciezka WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + '= p.ID &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
                SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parent AS nvarchar)&#xD;
                    ELSE CAST(p.parent AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= p.id &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
                EXEC(@sql)&#xD;
&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @i int&#xD;
&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
&#xD;
    set @kolumny =CONCAT (@kolumny, ',"',@TableName,' Poziom ' , LTRIM(@i) , '" = CASE WHEN Poz.Poziom' ,LTRIM(@i) ,'_',@TableID ,' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' , LTRIM(@i)  ,'_',@TableID , ' END')&#xD;
   &#xD;
   IF (@i=@poziom_max) &#xD;
	set @kolumny =CONCAT (@kolumny, ',"',@TableName,' Kompletny ', '" = CASE WHEN Poz.Poziom' ,LTRIM(@i) ,'_',@TableID ,'_path',' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' , LTRIM(@i)  ,'_',@TableID ,'_path', ' END')&#xD;
   &#xD;
   set @i = @i + 1&#xD;
end&#xD;
    delete #tmproots&#xD;
    where ID = @TableID&#xD;
&#xD;
end&#xD;
&#xD;
DROP TABLE #tmproots&#xD;
delete from #tmpWymiary  where ID &gt; 0 and typsl &lt;&gt; 1 and WyW_SlownikId &lt;&gt; 0&#xD;
&#xD;
ALTER TABLE #tmpWymiary&#xD;
DROP COLUMN nazwa,kod,id,parent,rootID,aktywny,poziom,sciezka,Wyw_DokumentTyp,typsl,WyW_SlownikId&#xD;
ALTER TABLE #tmpWymiary&#xD;
ADD  [Ver] INT&#xD;
UPDATE #tmpWymiary SET [Ver] = 1&#xD;
&#xD;
DECLARE @ColNames VARCHAR(MAX)&#xD;
DECLARE @SQLGrouper VARCHAR(MAX) &#xD;
SELECT @ColNames = COALESCE (@ColNames + ', ', '') + 'MAX(' + name +') AS ' +name&#xD;
FROM    tempdb.sys.columns &#xD;
WHERE  object_id = Object_id('tempdb..#tmpWymiary')&#xD;
AND column_id &gt;14&#xD;
and name &lt;&gt; 'Ver'&#xD;
&#xD;
SET @SQLGrouper = 'SELECT WyW_DokumentId,WyW_LpPozycji,WYW_GUID, '+ @ColNames+' , ver+1  FROM #tmpWymiary &#xD;
GROUP BY  WYW_GUID,WyW_DokumentId,WyW_LpPozycji,ver'&#xD;
INSERT  INTO #tmpWymiary exec (@SQLGrouper)&#xD;
&#xD;
DELETE FROM #tmpWymiary WHERE [Ver] = 1&#xD;
&#xD;
declare @dokumentTypFZ int, @dokumentTypFS int&#xD;
declare @dokumentTyp int&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]'&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
set @dokumentTyp = 1 -- Faktury zakupu&#xD;
&#xD;
select 1 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
29047 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Faktura zakupu') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp PodmiotTyp, TrN_PodID PodmiotID&#xD;
,CAST (NULL AS VARCHAR(100)) AS Projekt&#xD;
,CAST (NULL AS VARCHAR(100)) AS Dzial&#xD;
INTO #tmpTrNWym&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 2 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
29047 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Faktura zakupu' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 2 -- Faktury sprzedazy&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 3 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Faktura sprzedaży' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,Tre_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID&#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 4 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__], W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota  Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ , 'Faktura sprzedaży' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 19 -- Polecenie księgowania&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 5 as Paczka, CAST(DeN_Dokument AS nvarchar(260)) [Dokument Numer],   &#xD;
26002 [Dokument Numer __PROCID__], DeN_DeNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,DeE_DeNId DENID ,DeE_Lp DeELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 &#xD;
and W.WyW_SlownikId = W1.WyW_SlownikId and W.WyW_SourceType = W1.WyW_SourceType&#xD;
) IloscPozycji&#xD;
--,isnull(W.WyW_SlownikId,0) kontoID ,  W.WyW_SourceType TypS, 'Pozycja/Wartość' Typ, 'Polecenie księgowania' TypDokumentu &#xD;
,W.WyW_SlownikId kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Polecenie księgowania' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
 ,YEAR(Den_DataDok) DokumentRok ,MONTH(Den_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Den_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Den_DataOpe) PlatnoscRok,MONTH(DeN_DataOpe) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), DeN_DataOpe, 111), '/', '-')  AS PlatnoscDzien&#xD;
,DeE_Kwota AS WartoscCalk&#xD;
,DeN_PodmiotTyp, DeN_PodmiotID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.DekretyElem ON DeE_DeNId = W.WyW_DokumentId and DeE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.DekretyNag ON DeE_DeNId = DeN_DeNId AND DeE_AccWnId IS NOT NULL&#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
set @dokumentTypFZ = 20 -- Rejestr vat zakupu&#xD;
set @dokumentTypFS = 21 -- Rejestr vat sprzedaży&#xD;
&#xD;
INSERT INTO #tmpTrNWym &#xD;
select 6 as Paczka, VaN_Dokument AS [Dokument Numer],&#xD;
20101 [Dokument Numer __PROCID__], VaN_VaNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
W.WyW_Wartosc WymiarWartosc,&#xD;
&#xD;
W.Wyw_wywID WYWID,Vat_VanID VaNID,VaT_Lp VatLP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp in (@dokumentTypFZ, @dokumentTypFS) and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji,&#xD;
0 KontoID,&#xD;
WyW_SourceType TypS,&#xD;
CASE WyW_SourceType&#xD;
            WHEN 1 THen 'Pozycja/Kwota dodtakowa'&#xD;
            WHEN 2 THen 'Pozycja/Netto'&#xD;
            WHEN 3 THen 'Pozycja/Koszt'&#xD;
            WHEN 4 THen 'Pozycja/VAT_KOSZT'&#xD;
            WHEN 5 THen 'Dokument/Netto'&#xD;
            WHEN 6 THen 'Dokument/Koszt'&#xD;
            WHEN 7 THen 'Dokument/VAT_Koszt'&#xD;
       END [Typ ]&#xD;
, CASE W.WyW_DokumentTyp&#xD;
           WHEN 20 THEN 'Rejestr vat zakupu'&#xD;
           WHEN 21 THEN 'Rejestr vat sprzedaży'&#xD;
    END TypDokumentu&#xD;
    , W.WyW_DokumentTyp DokumentTyp&#xD;
    ,YEAR(VaN_DataWys) DokumentRok ,MONTH(VaN_DataWys) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), VaN_DataWys, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(VaN_Termin) PlatnoscRok,MONTH(VaN_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), VaN_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,Vat_netto + Vat_vat AS WartoscCalk&#xD;
    ,Van_PodmiotTyp, VaN_PodID&#xD;
    ,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.VatTab ON Vat_VanID = W.WyW_DokumentId and VaT_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.VatNag ON VaN_VaNID = VaT_VaNID&#xD;
where W.WyW_DokumentTyp in (@dokumentTypFZ, @dokumentTypFS) and W.WyW_WyyId = 0 and WyW_SourceType in (2,3,4)&#xD;
&#xD;
union all&#xD;
&#xD;
select 6 as Paczka, CAST(VaN_Dokument AS nvarchar(260)) AS [Dokument Numer],&#xD;
20101 [Dokument Numer __PROCID__], VaN_VaNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
W.WyW_Wartosc WymiarWartosc,&#xD;
&#xD;
W.Wyw_wywID WYWID,&#xD;
VaN_VanID VaNID,0 VatLP, &#xD;
W.WyW_Kwota / ISNULL((select count(*) FROM cdn.VatTab W1 where VaT_VaNID = VaN_VaNID),1.0) Kwota, W.wyw_procent / ISNULL((select count(*) FROM cdn.VatTab W1 where VaT_VaNID = VaN_VaNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W2 where W2.WyW_DokumentTyp in (@dokumentTypFZ, @dokumentTypFS) and W2.WyW_DokumentId = W.WyW_DokumentId and W2.WyW_LpPozycji = W.WyW_LpPozycji and W2.WyW_WyyId = 0 ) IloscPozycji,&#xD;
0 KontoID,WyW_SourceType TypS,&#xD;
CASE WyW_SourceType&#xD;
            WHEN 1 THen 'Pozycja/Kwota dodatkowa'&#xD;
            WHEN 2 THen 'Pozycja/Netto'&#xD;
            WHEN 3 THen 'Pozycja/Koszt'&#xD;
            WHEN 4 THen 'Pozycja/VAT_KOSZT'&#xD;
            WHEN 5 THen 'Dokument/Netto'&#xD;
            WHEN 6 THen 'Dokument/Koszt'&#xD;
            WHEN 7 THen 'Dokument/VAT_Koszt'&#xD;
       END [Typ ]&#xD;
       , CASE W.WyW_DokumentTyp&#xD;
           WHEN 20 THEN 'Rejestr vat zakupu'&#xD;
           WHEN 21 THEN 'Rejestr vat sprzedaży'&#xD;
    END TypDokumentu&#xD;
    , W.WyW_DokumentTyp DokumentTyp&#xD;
    ,YEAR(VaN_DataWys) DokumentRok ,MONTH(VaN_DataWys) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), VaN_DataWys, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(VaN_Termin) PlatnoscRok,MONTH(VaN_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), VaN_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,VaN_RazemBrutto AS WartoscCalk&#xD;
    ,Van_PodmiotTyp, Van_PodID&#xD;
    ,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.VatNag ON VaN_VanID = W.WyW_DokumentId&#xD;
where W.WyW_DokumentTyp in (@dokumentTypFZ, @dokumentTypFS) and W.WyW_WyyId = 0 and WyW_SourceType in (5,6,7)&#xD;
and not exists (select * from cdn.WymiaryWartosci W2 where W2.WyW_DokumentTyp in (@dokumentTypFZ, @dokumentTypFS) and W2.WyW_DokumentId =  W.WyW_DokumentId and W2.WyW_WyyId = 0 and W2.WyW_LpPozycji&lt;&gt;0)&#xD;
&#xD;
--2019------------------------------------------------------------------------------------------------------------------------------&#xD;
&#xD;
set @dokumentTyp = 3 -- Dokumenty wewnętrzne zakupu --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 7 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
29121 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Dokument wewnętrzny zakupu') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 8 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
29121 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Dokument wewnętrzny zakupu' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 4 -- Dokumenty wewnętrzne sprzedaży --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 9 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
29120 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Dokument wewnętrzny sprzedaży') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 10 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
29120 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Dokument wewnętrzny sprzedaży' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 5 -- Dokumenty TaxFree --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 11 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
29159 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Dokument TaxFree') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 12 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
29159 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Dokument TaxFree' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 6 -- Paragony --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 13 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
29048 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Paragon') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 14 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
29048 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Paragon' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 9 -- Przesunięcia międzymagazynowe --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 15 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25034 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Przesunięcie międzymagazynowe') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 16 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25034 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Przesunięcie międzymagazynowe' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 11 -- Przyjęcie wewnętrzne --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 17 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25032 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Przyjęcie wewnętrzne') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 18 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25032 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Przyjęcie wewnętrzne' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 12 -- Przyjęcie zewnętrzne --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 19 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25024 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Przyjęcie zewnętrzne') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 20 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25024 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Przyjęcie zewnętrzne' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 13 -- Rozchód wewnętrzny --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 21 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25030 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Rozchód wewnętrzny') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 22 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25030 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Rozchód wewnętrzny' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 14 -- Wydanie kaucji --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 23 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25078 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Wydanie kaucji') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 24 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25078 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Wydanie kaucji' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 15 -- Wydanie zewnętrzne --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 25 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25022 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Wydanie zewnętrzne') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 26 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25022 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Wydanie zewnętrzne' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 10 -- Przyjęcie kaucji --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 28 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25079 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Przyjęcie kaucji') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 29 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25079 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Przyjęcie kaucji' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 7 -- Kompletacja przyjęcie składników --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 30 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25045 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Kompletacja przyjęcie składników') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 31 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25045 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Kompletacja przyjęcie składników' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 8 -- Kompletacja rozchód składników --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 32 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25046 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Kompletacja rozchód składników') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 33 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25046 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Kompletacja rozchód składników' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 16 -- Ewidencja przychodów --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 34 as Paczka, CAST(EDN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
20116 [Dokument Numer __PROCID__], EDN_EDNID [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,EDN_EDNID TRNID,0 EDELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.EwidDodElem W1 where EDE_EDNID = EDN_EDNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Ewidencja przychodów' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(EDN_DataDok) DokumentRok ,MONTH(EDN_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), EDN_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(EDN_Termin) PlatnoscRok,MONTH(EDN_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), EDN_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,EDN_KwotaRazemSys AS WartoscCalk&#xD;
,EDN_PodmiotTyp, EDN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.EwidDodNag ON EDN_EDNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
set @dokumentTyp = 17 -- Ewidencja kosztów --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 35 as Paczka, CAST(EDN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
20116 [Dokument Numer __PROCID__], EDN_EDNID [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,EDN_EDNID TRNID,0 EDELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.EwidDodElem W1 where EDE_EDNID = EDN_EDNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Ewidencja kosztów' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(EDN_DataDok) DokumentRok ,MONTH(EDN_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), EDN_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(EDN_Termin) PlatnoscRok,MONTH(EDN_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), EDN_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,EDN_KwotaRazemSys AS WartoscCalk&#xD;
,EDN_PodmiotTyp, EDN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.EwidDodNag ON EDN_EDNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
&#xD;
--Wypłaty&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 36 as Paczka, CAST(WPL_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
24020  [Dokument Numer __PROCID__], WPL_WplId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
WPE_Nazwa WymiarWartosc,&#xD;
0 WYWID,0 TRNID,0 EDELP, OPP_Brutto Kwota ,&#xD;
opp_procent Procent, 0 as [GUID]&#xD;
,1 Iloscpozycji&#xD;
,0 kontoID, NULL TypS, 'Dokument/Wartość'&#xD;
, 'Wypłata' TypDokumentu , NULL DokumentTyp&#xD;
,YEAR(WPL_DataDok) DokumentRok ,MONTH(WPL_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), WPL_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(WPL_DataDok) PlatnoscRok,MONTH(WPL_DataDok) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), WPL_DataDok, 111), '/', '-')  AS PlatnoscDzien&#xD;
,Wpe_Wartosc AS WartoscCalk&#xD;
,0, 0&#xD;
,Prj_Nazwa AS  Projekt&#xD;
,DZL_Nazwa AS  Dzial&#xD;
&#xD;
from cdn.OpisPlace JOIN cdn.WypElementy ON OPP_WpeId = WPE_WpeId&#xD;
join cdn.Wyplaty on WPL_WplId = WPE_WplId &#xD;
join cdn.DefProjekty  ON OPP_PrjId = PRJ_PrjId&#xD;
JOIN cdn.Dzialy ON OPP_DzlId = DZL_DzlId&#xD;
&#xD;
declare @sqlTxt nvarchar(max)&#xD;
&#xD;
set @sqlTxt = N'select BAZ.Baz_Nazwa [Baza Firmowa], [Dokument Numer], WymiarWartosc as [Pozycja],Dzial AS [Dział], Projekt AS [Projekt],&#xD;
Kwota as [Wartość],Procent as [Wymiar Procent], Typ as [Typ Pozycji], TypDokumentu as [Typ Dokumentu]&#xD;
, DokumentRok as [Data Dokumentu Rok],DokumentMiesiac as [Data Dokumentu Miesiąc],DokumentMiesiac as [Data Dokumentu Dzień]&#xD;
, PlatnoscRok as [Data Termin Płatności Rok],PlatnoscMiesiac as [Data Termin Płatności Miesiąc],PlatnoscDzien as [Data Termin Płatności Dzień], &#xD;
Knt_Kod [Kontrahent Kod], Knt_Nazwa1 [Kontrahent Nazwa],zal.Ope_Kod [Operator Wprowadzający],mod.Ope_Kod [Operator Modyfikujący],GETDATE() [Data Analizy]&#xD;
&#xD;
----------KONTEKSTY&#xD;
, [Dokument Numer __PROCID__], [Dokument Numer __ORGID__], [Dokument Numer __DATABASE__] &#xD;
&#xD;
'+@kolumny + '&#xD;
from #tmpTrNWym&#xD;
left join  #tmpWymiary Poz on WyW_DokumentId = TrNID  and WYW_GUID = GUID and WyW_LpPozycji =  TRELp &#xD;
left join CDN.Kontrahenci on Knt_KntId = PodmiotID and Knt_Podmiottyp = PodmiotTyp&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON Knt_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON Knt_OpeModID = mod.Ope_OpeId&#xD;
order by TRNID, TRELP'&#xD;
&#xD;
exec (@sqlTxt)&#xD;
--select * from #tmpWymiary&#xD;
DROP TABLE #tmpWymiary&#xD;
drop table #tmpTrNWym &#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8sJ7a+Ib5ljeiB+o1CVa8K09VmwT3LHj3ChZA6BezNBwrS1BzJzaTn10QuwI3PMujIBT6U16yWR6Gt6rBj6xMh0cN/xE38i+czy1N+qeZhEJwbJdTVWZo7RtrWNzjM6tZzQ9zLMJBf27+HoUEnugUTGHfv8cmn1LqYI8l10yxoVu/5+89jLa2Ai</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Pozycja" caption="Pozycja" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dział" caption="Dział" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Projekt" caption="Projekt" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wartość" caption="Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wymiar Procent" caption="Wymiar Procent" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Typ Pozycji" caption="Typ Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Typ Dokumentu" caption="Typ Dokumentu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Rok" caption="Data Dokumentu Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Miesiąc" caption="Data Dokumentu Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Dzień" caption="Data Dokumentu Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Rok" caption="Data Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Miesiąc" caption="Data Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Dzień" caption="Data Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy" caption="Data Analizy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria finansowa Poziom 0" caption="Kategoria finansowa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria finansowa Poziom 1" caption="Kategoria finansowa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria finansowa Poziom 2" caption="Kategoria finansowa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria finansowa Kompletny " caption="Kategoria finansowa Kompletny " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="test Poziom 0" caption="test Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="test Poziom 1" caption="test Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="test Poziom 2" caption="test Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="test Kompletny " caption="test Kompletny " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="KUP_NKUP Poziom 0" caption="KUP_NKUP Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="KUP_NKUP Poziom 1" caption="KUP_NKUP Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="KUP_NKUP Poziom 2" caption="KUP_NKUP Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="KUP_NKUP Kompletny " caption="KUP_NKUP Kompletny " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="MPK Poziom 0" caption="MPK Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="MPK Poziom 1" caption="MPK Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="MPK Poziom 2" caption="MPK Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="MPK Kompletny " caption="MPK Kompletny " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="TEST1 Poziom 0" caption="TEST1 Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="TEST1 Poziom 1" caption="TEST1 Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="TEST1 Poziom 2" caption="TEST1 Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="TEST1 Kompletny " caption="TEST1 Kompletny " type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions /&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields /&gt;&#xD;
  &lt;rowFields /&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields /&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Opisów Analitycznych wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport prezentuje zbiorczo wszystkie opisy analityczne ze wszystkich rodzajów dokumentów.</a:description><a:id>28</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>28. Raport Opisów Analitycznych</a:mainLinkName><a:modifiedOn>2025-04-14T14:01:31.567</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2018-10-10T16:23:53.513</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Kontrahentów&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.5.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g (&#xD;
    gid&#xD;
    ,gidTyp&#xD;
    ,kod&#xD;
    ,gidNumer&#xD;
    ,grONumer&#xD;
    ,poziom&#xD;
    ,sciezka&#xD;
    )&#xD;
AS (&#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,0 AS poziom&#xD;
        ,convert(NVARCHAR(1024), '') AS sciezka&#xD;
    FROM CDN.TwrGrupy&#xD;
    WHERE TwG_TwGID = 0&#xD;
    &#xD;
    UNION ALL&#xD;
    &#xD;
    SELECT TwG_TwGID&#xD;
        ,TwG_GIDTyp&#xD;
        ,TwG_Kod&#xD;
        ,TwG_GIDNumer&#xD;
        ,TwG_GrONumer&#xD;
        ,p.poziom + 1 AS poziom&#xD;
        ,convert(NVARCHAR(1024), p.sciezka + N'\' + c.TwG_Kod) AS sciezka&#xD;
    FROM g p&#xD;
    JOIN CDN.TwrGrupy c ON c.TwG_GrONumer = p.gidNumer&#xD;
    WHERE c.TwG_TwGID &lt;&gt; 0&#xD;
        AND c.TwG_GIDTyp = - 16&#xD;
    )&#xD;
SELECT *&#xD;
INTO #tmpTwrGr&#xD;
FROM g&#xD;
&#xD;
DECLARE @poziom INT&#xD;
DECLARE @poziom_max INT&#xD;
DECLARE @sql NVARCHAR(max)&#xD;
&#xD;
SELECT @poziom_max = MAX(poziom)&#xD;
FROM #tmpTwrGr&#xD;
&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0&#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50), ONr' + CAST(@poziom AS NVARCHAR) + N' nvarchar(50)'&#xD;
&#xD;
    EXEC (@sql)&#xD;
&#xD;
    IF @poziom = @poziom_max&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS NVARCHAR) + '= grONumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS NVARCHAR) + ' = kod'&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
    ELSE&#xD;
    BEGIN&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
&#xD;
        SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS NVARCHAR) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS NVARCHAR) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS NVARCHAR) + '= p.gidNumer '&#xD;
&#xD;
        EXEC (@sql)&#xD;
    END&#xD;
&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
DECLARE @select VARCHAR(max)&#xD;
DECLARE @select2 VARCHAR(max)&#xD;
DECLARE @select3 VARCHAR(max)&#xD;
DECLARE @kolumny VARCHAR(max)&#xD;
DECLARE @i INT&#xD;
&#xD;
SET @kolumny = ''&#xD;
SET @i = 0&#xD;
&#xD;
WHILE (@i &lt;= @poziom_max)&#xD;
BEGIN&#xD;
    SET @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' + LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    SET @i = @i + 1&#xD;
END&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id INT&#xD;
    ,@atrybut_kod NVARCHAR(50)&#xD;
    ,@atrybut_typ INT&#xD;
    ,@atrybut_format INT&#xD;
    ,@atrybuty VARCHAR(max)&#xD;
    ,@sqlA NVARCHAR(max);&#xD;
DECLARE @wersja FLOAT;&#xD;
&#xD;
SET @wersja = (&#xD;
        SELECT CONVERT(FLOAT, SYS_Wartosc)&#xD;
        FROM CDN.SystemCDN&#xD;
        WHERE SYS_ID = 3&#xD;
        )&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId&#xD;
    ,KnA_PodmiotTyp&#xD;
INTO #tmpKonAtr&#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (T)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr VARCHAR(max)&#xD;
    ,@atrybutyTwr2 VARCHAR(max);&#xD;
&#xD;
SET @sqlA = 'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
&#xD;
IF @wersja &gt;= 2013&#xD;
    SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
&#xD;
EXEC (@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT&#xD;
FROM atrybut_cursor&#xD;
INTO @atrybut_id&#xD;
    ,@atrybut_kod&#xD;
    ,@atrybut_typ&#xD;
    ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId&#xD;
INTO #tmpTwrAtr&#xD;
FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (K)'&#xD;
    END&#xD;
&#xD;
    IF @atrybut_typ = 4&#xD;
    BEGIN&#xD;
        SET @atrybut_kod = @atrybut_kod + ' (D)'&#xD;
    END&#xD;
&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS NVARCHAR(50)) + N'] nvarchar(max)'&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS NVARCHAR(50)) + '] = CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(VARCHAR, @atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS NVARCHAR)&#xD;
&#xD;
    EXEC (@sqlA)&#xD;
&#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' + CAST(@atrybut_kod AS NVARCHAR(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS NVARCHAR(50)) + ']'&#xD;
&#xD;
    FETCH NEXT&#xD;
    FROM atrybut_cursor&#xD;
    INTO @atrybut_id&#xD;
        ,@atrybut_kod&#xD;
        ,@atrybut_typ&#xD;
        ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj in (312000,312008) AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
                           INTO #KosztZakupu&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow AND TREREl.TrE_TwrID = TRE.TrE_TwrID&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308,301 )&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
&#xD;
--DECLARE @select VARCHAR(MAX);&#xD;
--DECLARE @select2 VARCHAR(MAX);&#xD;
&#xD;
--Wyliczenie miar sprzedaży dla kontrahentów&#xD;
SELECT&#xD;
dd.DDf_Symbol DDf_Symbol,&#xD;
knt.Knt_KntId [knt_id],&#xD;
trn.TrN_TrNID,&#xD;
sum(TR.TrE_WartoscNetto) [sprzedazWartosc],&#xD;
sum(TR.TrE_Ilosc ) [ilosc],&#xD;
sum(TR.TrE_WartoscBrutto) [sprzedazWartoscBrutto],&#xD;
sum(TR.TrE_WartoscNettoWal) [sprzedazWartoscWaluta],&#xD;
sum(TR.TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi))) marza&#xD;
,trn.TrN_DataOpe dataop&#xD;
,TrE_TwrId Towar&#xD;
INTO #tmpKntSprz&#xD;
&#xD;
FROM cdn.Kontrahenci knt&#xD;
left join cdn.tranag trn ON trn.TrN_PodID=Knt_KntId  AND TrN_PodmiotTyp = 1&#xD;
left join cdn.TraElem TR ON TR.TrE_TrNID=trn.TrN_TrNID &#xD;
LEFT JOIN #KosztZakupu KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID &#xD;
LEFT JOIN CDN.DokDefinicje dd ON trn.TrN_DDfId = dd.DDf_DDfID&#xD;
WHERE&#xD;
trn.TrN_TypDokumentu IN (-1,302,305)&#xD;
AND trn.TrN_Bufor&lt;&gt;-1&#xD;
 AND  TRN_Rodzaj NOT IN (302200,302202)&#xD;
--AND TrE_Aktywny&lt;&gt;0&#xD;
--AND TrE_UslugaZlozonaId = 0&#xD;
GROUP BY Knt_KntId,trn.TrN_DataOpe,TrE_TwrId,DDf_Symbol,trn.TrN_TrNID&#xD;
SELECT DDf_DDfID ddfid&#xD;
    ,CASE &#xD;
        WHEN DDf_Numeracja LIKE '@rejestr%'&#xD;
            THEN 5&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 1) = '@rejestr'&#xD;
            THEN 1&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 2) = '@rejestr'&#xD;
            THEN 2&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 3) = '@rejestr'&#xD;
            THEN 3&#xD;
        WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja, CHARINDEX('/', ddf_numeracja, 0) + 1, 50), '@brak/', ''), '/@brak', ''), '/', '.'), 4) = '@rejestr'&#xD;
            THEN 4&#xD;
        END [seria]&#xD;
INTO #tmpSeria&#xD;
FROM CDN.DokDefinicje&#xD;
&#xD;
set @select = &#xD;
' &#xD;
SELECT&#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
DDf_Symbol [Dokument Symbol],&#xD;
TrN_TrNID [Liczba dokumentów],&#xD;
KNT.knt_nazwa1 [Kontrahent Nazwa], &#xD;
KNT.knt_kod [Kontrahent Kod],&#xD;
reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE KNT.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
CASE WHEN g.id IS NULL THEN ''Nie'' ELSE ''Tak'' END [Kontrahent ze Sprzedażą/Zakupem],&#xD;
CASE KNT.Knt_Nieaktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Kontrahent Aktywny],&#xD;
DB_NAME()+''_''+convert(Varchar(10),KNT.knt_PodmiotTyp)+''_''+convert(Varchar(10),KNT.Knt_KntId)  [Liczba Kontrahentów],&#xD;
CASE WHEN g.id IS NULL THEN NULL ELSE sprzedazWartosc END [Sprzedaż Wartość Suma],&#xD;
CASE WHEN g.id IS NULL THEN NULL ELSE ilosc END [Sprzedaż Ilość Suma],&#xD;
CASE WHEN g.id IS NULL THEN NULL ELSE sprzedazWartoscBrutto END [Sprzedaż Wartość Brutto Suma],&#xD;
CASE WHEN g.id IS NULL THEN NULL ELSE sprzedazWartoscWaluta END [Sprzedaż Wartość Waluta Suma],&#xD;
CASE WHEN g.id IS NULL THEN NULL ELSE marza END [Sprzedaż Marża Suma],&#xD;
NULL [Pierwsza Sprzedaż Wartość],&#xD;
NULL [Pierwsza Sprzedaż Ilość],&#xD;
NULL [Pierwsza Sprzedaż Wartość Brutto],&#xD;
NULL [Pierwsza Sprzedaż Wartość Waluta],&#xD;
NULL [Pierwsza Sprzedaż Marża],&#xD;
ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
Twr_Kod [Produkt Kod],&#xD;
ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy],&#xD;
zal.Ope_Kod [Operator Wprowadzający], &#xD;
mod.Ope_Kod [Operator Modyfikujący]&#xD;
,ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'') [Kontrahent Opiekun]&#xD;
,CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat]&#xD;
,KNT.KNT_Kraj [Kontrahent Kraj]&#xD;
,KNT.KNT_Miasto [Kontrahent Miasto]&#xD;
,KNT.Knt_Wojewodztwo [Kontrahent Województwo]&#xD;
,KNT.KNT_pOWIAT [Kontrahent Powiat]&#xD;
,KNT.KNT_KodPocztowy [Kontrahent Kod Pocztowy]&#xD;
,KNT.Knt_Ulica [Kontrahent Ulica]&#xD;
,''(BRAK)'' [Dokument Seria]&#xD;
/*&#xD;
--------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Pierwszej Operacji] &#xD;
,REPLACE(CONVERT(VARCHAR(10), ostatnia, 111), ''/'', ''-'') [Data Ostatniej Operacji]&#xD;
,REPLACE(CONVERT(VARCHAR(10), dataop, 111), ''/'', ''-'') [Data Operacji] &#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Pierwszej Operacji Dzień] &#xD;
,(datepart(DY, datediff(d, 0, pierwsza) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, pierwsza)*/ [Data Pierwszej Operacji Tydzień Roku]&#xD;
,MONTH(pierwsza) [Data Pierwszej Operacji Miesiąc], DATEPART(quarter, pierwsza) [Data Pierwszej Operacji Kwartał], YEAR(pierwsza) [Data Pierwszej Operacji Rok] &#xD;
,REPLACE(CONVERT(VARCHAR(10), ostatnia, 111), ''/'', ''-'') [Data Ostatniej Operacji Dzień]&#xD;
,(datepart(DY, datediff(d, 0, ostatnia) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Ostatniej Operacji Tydzień Roku]&#xD;
,MONTH(ostatnia) [Data Ostatniej Operacji Miesiąc], DATEPART(quarter, ostatnia) [Data Ostatniej Operacji Kwartał], YEAR(ostatnia) [Data Ostatniej Operacji Rok]&#xD;
&#xD;
,REPLACE(CONVERT(VARCHAR(10), dataop, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
,(datepart(DY, datediff(d, 0, dataop) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Operacji Tydzień Roku]&#xD;
,MONTH(dataop) [Data Operacji Miesiąc], DATEPART(quarter, dataop) [Data Operacji Kwartał], YEAR(dataop) [Data Operacji Rok]&#xD;
&#xD;
,REPLACE(CONVERT(VARCHAR(10), knt.Knt_ts_zAL, 111), ''/'', ''-'') [Data Dodania Kontrahenta Dzień]&#xD;
,(datepart(DY, datediff(d, 0, knt.Knt_ts_zAL) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Dodania Kontrahenta Tydzień Roku]&#xD;
,MONTH(knt.Knt_ts_zAL) [Data Dodania Kontrahenta Miesiąc], DATEPART(quarter, knt.Knt_ts_zAL) [Data Dodania Kontrahenta Kwartał], YEAR(knt.Knt_ts_zAL) [Data Dodania Kontrahenta Rok]&#xD;
&#xD;
&#xD;
&#xD;
,GETDATE() [Data Analizy]&#xD;
----------KONTEKSTY&#xD;
,20201 [Kontrahent Nazwa __PROCID__], KNT.Knt_KntId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
,20201 [Kontrahent Kod __PROCID__Kontrahenci__], KNT.Knt_KntId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
&#xD;
' + @kolumny + @atrybuty  + @atrybutyTwr &#xD;
set @select2 = &#xD;
'&#xD;
&#xD;
from cdn.kontrahenci KNT&#xD;
&#xD;
Left join&#xD;
(&#xD;
Select distinct &#xD;
TrN_PodID [id],&#xD;
MIN(TrN_DataOpe) OVER(PARTITION BY TrN_PodID) AS pierwsza, &#xD;
MAX(TrN_DataOpe) OVER(PARTITION BY TrN_PodID) AS ostatnia  &#xD;
from&#xD;
cdn.tranag  WHERE TrN_TypDokumentu IN (302,305) AND TRN_Bufor = 0 AND  TRN_Rodzaj NOT IN (302200,302202)&#xD;
GROUP BY TrN_PodID,TrN_DataOpe) g ON g.id = KNT.Knt_KntID&#xD;
left join #tmpKntSprz a ON KNT.Knt_KntID = a.knt_id&#xD;
&#xD;
     LEFT JOIN CDN.Towary ON towar=Twr_TwrId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON KNT.knt_kntid = KonAtr.KnA_PodmiotId AND KNT.knt_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON towar  = TwrAtr.TwA_TwrId &#xD;
&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
&#xD;
&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON KNT.Knt_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON KNT.Knt_OpeModID = mod.Ope_OpeId&#xD;
LEFT JOIN CDN.Rabaty on rab_podmiotid = knt.knt_kntid and rab_typ = 2 AND dataop BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt.Knt_OpiekunId = opk3.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
&#xD;
&#xD;
UNION ALL &#xD;
&#xD;
SELECT  &#xD;
&#xD;
BAZ.Baz_Nazwa  [Baza Firmowa],&#xD;
DDf_Symbol [Dokument Symbol],&#xD;
TrN_TrNID [Liczba dokumentów],&#xD;
KNT.knt_nazwa1 [Kontrahent Nazwa], &#xD;
KNT.knt_kod [Kontrahent Kod],&#xD;
reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE KNT.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE KNT.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
''Tak''  [Kontrahent ze Sprzedażą/Zakupem],&#xD;
CASE KNT.Knt_Nieaktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Kontrahent Aktywny],&#xD;
DB_NAME()+''_''+convert(Varchar(10),KNT.knt_PodmiotTyp)+''_''+convert(Varchar(10),KNT.Knt_KntId)  [Liczba Kontrahentów],&#xD;
NULL [Sprzedaż Wartość Suma],&#xD;
NULL [Sprzedaż Ilość Suma],&#xD;
NULL [Sprzedaż Wartość Brutto Suma],&#xD;
NULL [Sprzedaż Wartość Waluta Suma],&#xD;
NULL [Sprzedaż Marża Suma],&#xD;
TrE_WartoscNetto [Pierwsza Sprzedaż Wartość],&#xD;
TrE_Ilosc [Pierwsza Sprzedaż Ilość],&#xD;
TrE_WartoscBrutto [Pierwsza Sprzedaż Wartość Brutto],&#xD;
TrE_WartoscNettoWal [Pierwsza Sprzedaż Wartość Waluta],&#xD;
TrE_WartoscNetto - (CASE WHEN TrN_Rodzaj IN (302101,302102,302103,305101) THEN -1 ELSE 1 END *(ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi)) [Pierwsza Sprzedaż Marża],&#xD;
ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
Twr_Kod [Produkt Kod],&#xD;
ISNULL(Twr_EAN,''(BRAK)'') [Produkt EAN],&#xD;
ISNULL(Twr_KodDostawcy,''(BRAK)'') [Produkt Kod Dostawcy],&#xD;
zal.Ope_Kod [Operator Wprowadzający], &#xD;
mod.Ope_Kod [Operator Modyfikujący]&#xD;
,ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'') [Kontrahent Opiekun]&#xD;
,CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat]&#xD;
,KNT.KNT_Kraj [Kontrahent Kraj]&#xD;
,KNT.KNT_Miasto [Kontrahent Miasto]&#xD;
,KNT.Knt_Wojewodztwo [Kontrahent Województwo]&#xD;
,KNT.KNT_pOWIAT [Kontrahent Powiat]&#xD;
,KNT.KNT_KodPocztowy [Kontrahent Kod Pocztowy]&#xD;
,KNT.Knt_Ulica [Kontrahent Ulica]&#xD;
&#xD;
    ,CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria]&#xD;
&#xD;
/*&#xD;
--------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Pierwszej Operacji] &#xD;
,REPLACE(CONVERT(VARCHAR(10), ostatnia, 111), ''/'', ''-'') [Data Ostatniej Operacji]&#xD;
,REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Operacji] &#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Pierwszej Operacji Dzień] &#xD;
,(datepart(DY, datediff(d, 0, pierwsza) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, pierwsza)*/ [Data Pierwszej Operacji Tydzień Roku]&#xD;
,MONTH(pierwsza) [Data Pierwszej Operacji Miesiąc], DATEPART(quarter, pierwsza) [Data Pierwszej Operacji Kwartał], YEAR(pierwsza) [Data Pierwszej Operacji Rok] &#xD;
,REPLACE(CONVERT(VARCHAR(10), ostatnia, 111), ''/'', ''-'') [Data Ostatniej Operacji Dzień]&#xD;
,(datepart(DY, datediff(d, 0, ostatnia) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Ostatniej Operacji Tydzień Roku]&#xD;
,MONTH(ostatnia) [Data Ostatniej Operacji Miesiąc], DATEPART(quarter, ostatnia) [Data Ostatniej Operacji Kwartał], YEAR(ostatnia) [Data Ostatniej Operacji Rok]&#xD;
&#xD;
,REPLACE(CONVERT(VARCHAR(10), pierwsza, 111), ''/'', ''-'') [Data Operacji Dzień]&#xD;
,(datepart(DY, datediff(d, 0, pierwsza) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Operacji Tydzień Roku]&#xD;
,MONTH(pierwsza) [Data Operacji Miesiąc], DATEPART(quarter, pierwsza) [Data Operacji Kwartał], YEAR(pierwsza) [Data Operacji Rok]&#xD;
&#xD;
,REPLACE(CONVERT(VARCHAR(10), knt.Knt_ts_zAL, 111), ''/'', ''-'') [Data Dodania Kontrahenta Dzień]&#xD;
,(datepart(DY, datediff(d, 0, knt.Knt_ts_zAL) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, ostatnia)*/ [Data Dodania Kontrahenta Tydzień Roku]&#xD;
,MONTH(knt.Knt_ts_zAL) [Data Dodania Kontrahenta Miesiąc], DATEPART(quarter, knt.Knt_ts_zAL) [Data Dodania Kontrahenta Kwartał], YEAR(knt.Knt_ts_zAL) [Data Dodania Kontrahenta Rok]&#xD;
&#xD;
,GETDATE() [Data Analizy]&#xD;
----------KONTEKSTY&#xD;
,20201 [Kontrahent Nazwa __PROCID__], KNT.Knt_KntId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
,20201 [Kontrahent Kod __PROCID__Kontrahenci__], KNT.Knt_KntId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
' + @kolumny + @atrybuty  + @atrybutyTwr +'&#xD;
FROM &#xD;
(&#xD;
SELECT Trn_trnid id, MIN(TrN_DataOpe) OVER(PARTITION BY TrN_PodID) AS pierwsza, MAX(TrN_DataOpe) OVER(PARTITION BY TrN_PodID) AS ostatnia  &#xD;
FROM CDN.Tranag WHERE TrN_TypDokumentu IN (302,305) AND TRN_Bufor = 0 AND  TRN_Rodzaj NOT IN (302200,302202))x &#xD;
JOIN cdn.tranag ON id = TrN_TrNID and pierwsza = TrN_DataOpe&#xD;
left join cdn.TraElem TR ON TR.TrE_TrNID=TrN_TrNID &#xD;
LEFT JOIN cdn.Kontrahenci KNT ON TrN_PodID=KNT.Knt_KntId  AND TrN_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON KNT.knt_kntid = KonAtr.KnA_PodmiotId AND KNT.knt_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
&#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT JOIN #KosztZakupu KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON knt4.Knt_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON knt4.Knt_OpeModID = mod.Ope_OpeId&#xD;
	 LEFT JOIN CDN.Rabaty on rab_podmiotid = knt.knt_kntid and rab_typ = 2 AND pierwsza BETWEEN Rab_DataOd AND Rab_DataDo&#xD;
	      LEFT JOIN ' + @Operatorzy + ' opk3 ON knt.Knt_OpiekunId = opk3.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.DokDefinicje  ON TrN_DDfId = DDf_DDfID&#xD;
	  LEFT JOIN #tmpSeria ser ON TrN_DDfId = ddfid&#xD;
'&#xD;
&#xD;
print (@select + @select2)&#xD;
exec (@select + @select2)&#xD;
&#xD;
drop table #tmpKntSprz&#xD;
Drop Table #KosztZakupu&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8sJ7a+Ib5ljeiB+o1CVa8K09VmwT3LHj3ChZA6BezNBwrS1BzJzaTn10QuwI3PMujIBT6U16yWR6Gt6rBj6xMh0cN/xE38i+czy1N+qeZhEJwbJdTVWZo7RtrWNzjM6tZzQ9zLMJBf27+HoUEnugUTGHfv8cmn1LqYI8l10yxoVu/5+89jLa2Ai</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Liczba dokumentów" caption="Liczba dokumentów" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent ze Sprzedażą/Zakupem" caption="Kontrahent ze Sprzedażą/Zakupem" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Aktywny" caption="Kontrahent Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Suma" caption="Sprzedaż Wartość Suma" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość Suma" caption="Sprzedaż Ilość Suma" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto Suma" caption="Sprzedaż Wartość Brutto Suma" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Waluta Suma" caption="Sprzedaż Wartość Waluta Suma" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Marża Suma" caption="Sprzedaż Marża Suma" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pierwsza Sprzedaż Wartość" caption="Pierwsza Sprzedaż Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pierwsza Sprzedaż Ilość" caption="Pierwsza Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pierwsza Sprzedaż Wartość Brutto" caption="Pierwsza Sprzedaż Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pierwsza Sprzedaż Wartość Waluta" caption="Pierwsza Sprzedaż Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pierwsza Sprzedaż Marża" caption="Pierwsza Sprzedaż Marża" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt EAN" caption="Produkt EAN" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod Dostawcy" caption="Produkt Kod Dostawcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod Pocztowy" caption="Kontrahent Kod Pocztowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Ulica" caption="Kontrahent Ulica" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Dzień" caption="Data Pierwszej Operacji Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Tydzień Roku" caption="Data Pierwszej Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Miesiąc" caption="Data Pierwszej Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Kwartał" caption="Data Pierwszej Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Pierwszej Operacji Rok" caption="Data Pierwszej Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Dzień" caption="Data Ostatniej Operacji Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Tydzień Roku" caption="Data Ostatniej Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Miesiąc" caption="Data Ostatniej Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Kwartał" caption="Data Ostatniej Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Ostatniej Operacji Rok" caption="Data Ostatniej Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dodania Kontrahenta Dzień" caption="Data Dodania Kontrahenta Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dodania Kontrahenta Tydzień Roku" caption="Data Dodania Kontrahenta Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dodania Kontrahenta Miesiąc" caption="Data Dodania Kontrahenta Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dodania Kontrahenta Kwartał" caption="Data Dodania Kontrahenta Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dodania Kontrahenta Rok" caption="Data Dodania Kontrahenta Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy" caption="Data Analizy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut EMAIL" caption="Kontrahent Atrybut EMAIL" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NUMER SERYJNY" caption="Produkt Atrybut NUMER SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut WAGA" caption="Produkt Atrybut WAGA" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions /&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields /&gt;&#xD;
  &lt;rowFields /&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields /&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Kontrahentów wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport prezentuje wszystkich kontrahentów w bazie firmowej oraz ich liczbę. Umożliwia zafiltrowanie danych tylko do kontrahentów, dla których nie odnotowano jeszcze operacji sprzedaży lub zakupu.&#xD;
&#xD;
Raport umożliwia również analizę pierwszej transakcji sprzedaży dla kontrahenta</a:description><a:id>29</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>29. Raport Kontrahentów</a:mainLinkName><a:modifiedOn>2025-05-30T14:15:05.503</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-07-19T16:47:10.833</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>&#xD;
/*&#xD;
* Raport Rozrachunków Księgowych na Dzień &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @String varchar(1024)&#xD;
DECLARE @Pos int&#xD;
CREATE TABLE #Keywords (string varchar(100)) &#xD;
DECLARE @Key varchar(100)&#xD;
SET @String = @OKRESOBRACHUNKOWY&#xD;
SET @Pos = 1&#xD;
WHILE (@Pos &gt; 0)&#xD;
BEGIN&#xD;
    SET @Pos = PATINDEX('%,%', @String)&#xD;
    SET @Key = SUBSTRING(@String, 0, @Pos)&#xD;
    IF (@Pos = 0)&#xD;
        BEGIN&#xD;
            INSERT INTO #Keywords (string) VALUES(@String)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN&#xD;
            INSERT INTO #Keywords (string) VALUES(@Key)&#xD;
        END&#xD;
    SET @String = SUBSTRING(@String, @Pos+1, (SELECT LEN(@String)))&#xD;
END &#xD;
&#xD;
SELECT *,OOb_OObID oobid INTO  #oob FROM(&#xD;
SELECT    SUBSTRING(string, 1, CHARINDEX(';', string) - 1) AS year,&#xD;
    SUBSTRING(string, CHARINDEX(';', string) + 1, LEN(string)) AS db  FROM #Keywords &#xD;
  )OB&#xD;
  JOIN CDN.OkresyObrach ON OOb_Symbol =  year &#xD;
  WHERE db = DB_NAME()&#xD;
&#xD;
  Drop table #Keywords&#xD;
&#xD;
--Wyliczanie poziomów kont&#xD;
;WITH g(gid, kod, naz, parId, poziom, nazwa)&#xD;
AS&#xD;
(&#xD;
      SELECT Acc_AccId, Acc_Segment, Acc_Nazwa, Acc_ParId, Acc_Poziom, convert(nvarchar(1024), Acc_Segment) as nazwa&#xD;
      FROM CDN.Konta&#xD;
      WHERE Acc_ParId IS NULL AND Acc_OObId IN (select oobid from #oob)&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT Acc_AccId, Acc_Segment, Acc_Nazwa, Acc_ParId, Acc_Poziom, convert(nvarchar(1024), p.nazwa + N'-' + c.Acc_Segment) as nazwa&#xD;
      FROM g p&#xD;
        JOIN CDN.Konta c ON c.Acc_ParId = p.gid &#xD;
      WHERE c.Acc_ParId IS NOT NULL AND c.Acc_OObId IN (select oobid from #oob)&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt; 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50), Nazwa' + CAST(@poziom AS nvarchar) + N' nvarchar(4000)'&#xD;
    EXEC(@sql)&#xD;
&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= parId '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + kod + '')'' ELSE kod END'&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Nazwa' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + naz + '')'' ELSE naz END'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                         WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(c.kod AS nvarchar) + '')''&#xD;
                         WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(p.kod AS nvarchar) + '')''&#xD;
                    ELSE p.kod END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Nazwa' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN c.naz&#xD;
                         WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + c.naz + '')''&#xD;
                         WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + p.naz + '')''&#xD;
                    ELSE p.naz END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parId AS nvarchar)&#xD;
                    ELSE CAST(p.parId AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
declare @select varchar(max);&#xD;
declare @select2 varchar(max);&#xD;
declare @kolumny varchar(max);&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
&#xD;
set @i=1&#xD;
if @i&lt;=@poziom_max  &#xD;
begin&#xD;
    set @kolumny = ', SUBSTRING(Poz.Poziom1, 1, 1) AS [Konto Grupa]'&#xD;
end&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ', CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END [Konto Struktura Poziom ' + LTRIM(@i) + '] ' +&#xD;
                              ', CASE WHEN Poz.Nazwa' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Nazwa' + LTRIM(@i) + ' END [Konto Nazwa Poziom ' + LTRIM(@i) + '] '&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
CREATE UNIQUE CLUSTERED INDEX in1 ON #tmpTwrGr(gid)&#xD;
&#xD;
DECLARE @DATAANALIZY VARCHAR(MAX);&#xD;
SET @DATAANALIZY = CONVERT(VARCHAR, @DATA);&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
SET @select = &#xD;
N'SELECT &#xD;
&#xD;
BAZ.Baz_Nazwa [Baza Firmowa],&#xD;
    KRo_Dokument [Dokument Numer], &#xD;
    NULL [Dokument Opis], KRo_IdentKsieg [Identyfikator Księgowy], CASE WHEN KRo_Bufor = 1 THEN ''TAK'' ELSE ''NIE'' END [Dokument Bufor],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Elementu], ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Elementu],&#xD;
    KRo_NrKsiegi [Dziennik Numer], KRo_NrDziennika [Dziennik Cząstkowy Numer], OOb_Symbol [Okres Obrachunkowy], KRo_Waluta [Waluta], &#xD;
    REPLACE(CONVERT(VARCHAR(10), KRo_DataDokumentu, 111), ''/'', ''-'') [Data Dokumentu Dzień], YEAR(KRo_DataDokumentu) [Data Dokumentu Rok], &#xD;
    DATEPART(quarter, KRo_DataDokumentu) [Data Dokumentu Kwartał], MONTH(KRo_DataDokumentu) [Data Dokumentu Miesiąc], &#xD;
    (datepart(DY, datediff(d, 0, KRo_DataDokumentu) / 7 * 7 + 3)+6) / 7 [Data Dokumentu Tydzień Roku],&#xD;
    REPLACE(CONVERT(VARCHAR(10), KRo_TerminPlatnosci, 111), ''/'', ''-'') [Data Termin Płatności Dzień], YEAR(KRo_TerminPlatnosci) [Data Termin Płatności Rok], &#xD;
    DATEPART(quarter, KRo_TerminPlatnosci) [Data Termin Płatności Kwartał], MONTH(KRo_TerminPlatnosci) [Data Termin Płatności Miesiąc], &#xD;
    (datepart(DY, datediff(d, 0, KRo_TerminPlatnosci) / 7 * 7 + 3)+6) / 7 [Data Termin Płatności Tydzień Roku],&#xD;
    REPLACE(CONVERT(VARCHAR(10), KRo_DataOperacji, 111), ''/'', ''-'') [Data Operacji Dzień],&#xD;
    REPLACE(CONVERT(VARCHAR(10), KRo_DataOperacji, 111), ''/'', ''-'') [Data Wystawienia Dzień],&#xD;
    CASE WHEN ''' + @TERMINDATA + ''' = ''Terminu Płatności''&#xD;
    THEN CASE&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) &lt; 1 THEN ''1. W terminie''&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 AND ' + CONVERT(varchar, @PRZEDZIAL1) + ' THEN ''2.  Do ' + CONVERT(varchar, @PRZEDZIAL1) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL1) + ' AND ' + CONVERT(varchar, @PRZEDZIAL2) + ' THEN ''3. Od ' + CONVERT(varchar, @PRZEDZIAL1 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL2) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL2) + ' AND ' + CONVERT(varchar, @PRZEDZIAL3) + ' THEN ''4. Od ' + CONVERT(varchar, @PRZEDZIAL2 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL3) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL3) + ' AND ' + CONVERT(varchar, @PRZEDZIAL4) + ' THEN ''5. Od ' + CONVERT(varchar, @PRZEDZIAL3 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL4) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL4) + ' AND ' + CONVERT(varchar, @PRZEDZIAL5) + ' THEN ''6. Od ' + CONVERT(varchar, @PRZEDZIAL4 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
            ELSE ''7. Powyżej ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
        END&#xD;
    ELSE CASE&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) &lt; 1 THEN ''1. W terminie''&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 AND ' + CONVERT(varchar, @PRZEDZIAL1) + ' THEN ''2.  Do ' + CONVERT(varchar, @PRZEDZIAL1) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL1) + ' AND ' + CONVERT(varchar, @PRZEDZIAL2) + ' THEN ''3. Od ' + CONVERT(varchar, @PRZEDZIAL1 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL2) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL2) + ' AND ' + CONVERT(varchar, @PRZEDZIAL3) + ' THEN ''4. Od ' + CONVERT(varchar, @PRZEDZIAL2 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL3) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL3) + ' AND ' + CONVERT(varchar, @PRZEDZIAL4) + ' THEN ''5. Od ' + CONVERT(varchar, @PRZEDZIAL3 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL4) + ' dni''&#xD;
            WHEN DATEDIFF(day, KRo_DataDokumentu, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) BETWEEN 1 + ' + CONVERT(varchar, @PRZEDZIAL4) + ' AND ' + CONVERT(varchar, @PRZEDZIAL5) + ' THEN ''6. Od ' + CONVERT(varchar, @PRZEDZIAL4 + 1) + ' do ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
            ELSE ''7. Powyżej ' + CONVERT(varchar, @PRZEDZIAL5) + ' dni''&#xD;
        END&#xD;
    END [Termin Zapadalności], &#xD;
    KRo_Konto [Konto Pełny Numer], k1.Acc_Nazwa [Konto Nazwa], KRo_KontoPrzeciw [Konto Przeciwstawne],&#xD;
    CASE WHEN pod.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN pod.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
         WHEN pod.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN pod.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN pod.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END [Podmiot Pierwotny Typ], &#xD;
    pod.Pod_NIP [Podmiot Pierwotny NIP],&#xD;
    pod.Pod_Kod [Podmiot Pierwotny Kod], &#xD;
        pod.Pod_Nazwa1[Podmiot Pierwotny Nazwa],&#xD;
    CASE WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
         WHEN pod5.Pod_PodmiotTyp= 2 THEN ''Bank''&#xD;
         WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik''&#xD;
         WHEN pod5.Pod_PodmiotTyp = 4 THEN ''Wspólnik''&#xD;
         WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END [Podmiot Typ], &#xD;
    pod5.Pod_NIP [Podmiot NIP],&#xD;
    pod5.Pod_Kod [Podmiot Kod], &#xD;
    pod5.Pod_Nazwa1 [Podmiot Nazwa],&#xD;
    KRo_KwotaDok [Kwota Dokumentu], --KRo_KwotaWal [Kwota Dokumentu Waluta],&#xD;
    CASE KRo_Strona WHEN 1 THEN NULLIF(KRo_KwotaDok-KRo_SumRozliczen,0) END [Kwota Pozostała Wn], --CASE KRo_Strona WHEN 1 THEN NULLIF(KRo_KwotaDokWal-KRo_SumRozliczenWal,0) END [Kwota Pozostała Wn Waluta], &#xD;
    CASE KRo_Strona WHEN 2 THEN NULLIF(KRo_KwotaDok-KRo_SumRozliczen,0) END [Kwota Pozostała Ma], --CASE KRo_Strona WHEN 2 THEN NULLIF(KRo_KwotaDokWal-KRo_SumRozliczenWal,0) END [Kwota Pozostała Ma Waluta],&#xD;
    CASE KRo_Strona WHEN 1 THEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) END [Liczba Dni Przeterminowania Wn], &#xD;
    CASE KRo_Strona WHEN 2 THEN DATEDIFF(day, KRo_TerminPlatnosci, CONVERT(DATETIME,''' + @DATAANALIZY + ''')) END [Liczba Dni Przeterminowania Ma],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], &#xD;
    mod.Ope_Kod [Operator Modyfikujący],&#xD;
    GETDATE() [Data Analizy]&#xD;
    &#xD;
    ----------KONTEKSTY&#xD;
    ,26002 [Dokument Numer __PROCID__Rozrachunki__], DeE_DeNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,CASE pod.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Pierwotny Kod __PROCID__Kontrahenci__], pod.Pod_PodId [Podmiot Pirwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__]&#xD;
    ,CASE pod.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Pierwotny Nazwa __PROCID__], pod.Pod_PodId [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    ,CASE pod5.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__]&#xD;
    ,CASE pod5.Pod_PodmiotTyp&#xD;
        WHEN 1 THEN 20201&#xD;
        WHEN 2 THEN 23002&#xD;
        WHEN 3 THEN 24001&#xD;
        WHEN 5 THEN 25005&#xD;
        ELSE 20201&#xD;
    END [Podmiot Nazwa __PROCID__], pod.Pod_PodId [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__]&#xD;
    &#xD;
    ' + @kolumny + &#xD;
' FROM CDN.KsiRozrachunki&#xD;
    LEFT JOIN CDN.OkresyObrach ON KRo_OObId = OOb_OObID&#xD;
    LEFT JOIN CDN.DekretyElem ON DeE_DeEId = KRo_DeEId&#xD;
    LEFT JOIN CDN.DekretyNag on DeE_DeNId = DeN_DeNId&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat1 ON DeE_KatId = kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Konta k1 ON KRo_KontoIdx = k1.Acc_NumerIdx AND KRo_OObId = k1.Acc_OObId&#xD;
    LEFT OUTER JOIN CDN.Konta k2 ON KRo_KontoIdx = k2.Acc_NumerIdx AND KRo_OObId + 1 = k2.Acc_OObId&#xD;
    LEFT JOIN #tmpTwrGr Poz ON ISNULL(k1.Acc_AccId, k2.Acc_AccId) = Poz.gid &#xD;
    LEFT JOIN CDN.PodmiotyView pod ON DeN_PodmiotId = pod.Pod_PodId AND DeN_PodmiotTyp = pod.Pod_PodmiotTyp&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod.Pod_GlID = pod5.Pod_PodId and pod.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON k1.Acc_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON k1.Acc_OpeModID = mod.Ope_OpeId&#xD;
WHERE Kro_DataRoz IS NULL AND KRo_DataDokumentu &lt;= CONVERT(DATETIME,''' + @DATAANALIZY + ''') and OOB_OOBID IN (select oobid from #oob)'&#xD;
&#xD;
&#xD;
EXEC(@select)&#xD;
--PRINT(@select)&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #OOB&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5vCxSmgondMfdtmo6sliIgTWPbj17BviVUXyPzdkotJkq7igEVPx67QBSiMcx5zyeTJgrs/t+z/BIjq9oHQl3dL1vDiIZ84Ys7b36fBxBgdA</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Identyfikator Księgowy" caption="Identyfikator Księgowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Bufor" caption="Dokument Bufor" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Elementu" caption="Kategoria Szczegółowa z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Elementu" caption="Kategoria Ogólna z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dziennik Numer" caption="Dziennik Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dziennik Cząstkowy Numer" caption="Dziennik Cząstkowy Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Okres Obrachunkowy" caption="Okres Obrachunkowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Dzień" caption="Data Dokumentu Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Rok" caption="Data Dokumentu Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Kwartał" caption="Data Dokumentu Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Miesiąc" caption="Data Dokumentu Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Tydzień Roku" caption="Data Dokumentu Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Dzień" caption="Data Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Rok" caption="Data Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Kwartał" caption="Data Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Miesiąc" caption="Data Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Tydzień Roku" caption="Data Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Zapadalności" caption="Termin Zapadalności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Pełny Numer" caption="Konto Pełny Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Nazwa" caption="Konto Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Przeciwstawne" caption="Konto Przeciwstawne" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kwota Dokumentu" caption="Kwota Dokumentu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Pozostała Wn" caption="Kwota Pozostała Wn" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Pozostała Ma" caption="Kwota Pozostała Ma" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania Wn" caption="Liczba Dni Przeterminowania Wn" type="measure" formatString="n0" aggregate="Max" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania Ma" caption="Liczba Dni Przeterminowania Ma" type="measure" formatString="n0" aggregate="Max" /&gt;&#xD;
    &lt;column name="Konto Grupa" caption="Konto Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 1" caption="Konto Struktura Poziom 1" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 1" caption="Konto Nazwa Poziom 1" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 2" caption="Konto Struktura Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 2" caption="Konto Nazwa Poziom 2" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 3" caption="Konto Struktura Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 3" caption="Konto Nazwa Poziom 3" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 4" caption="Konto Struktura Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 4" caption="Konto Nazwa Poziom 4" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Konto Struktura Poziom 5" caption="Konto Struktura Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Konto Nazwa Poziom 5" caption="Konto Nazwa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATA&lt;/Name&gt;&#xD;
    &lt;Label&gt;Analiza na dzień:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data, dla której wykonana zostanie analiza&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;select getdate()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2018-05-07&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL1&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 1 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;30&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL2&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 2 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;60&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL3&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 3 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;90&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL4&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 4 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;180&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;PRZEDZIAL5&lt;/Name&gt;&#xD;
    &lt;Label&gt;Przedział 5 (w dniach):&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Górna granica przedziału (ilość dni)&lt;/ToolTip&gt;&#xD;
    &lt;Type&gt;Liczba&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Number&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;10000&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;1&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;360&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;TERMINDATA&lt;/Name&gt;&#xD;
    &lt;Label&gt;Obliczenia według:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Parametr określający czy struktura wiekowa ma być liczona na podstawie terminu płatności czy daty księgowania&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;'Terminu Płatności';'Daty Księgowania'&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Lista&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;CustomList&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;'Terminu Płatności'&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;OKRESOBRACHUNKOWY&lt;/Name&gt;&#xD;
    &lt;Label&gt;Okres obrachunkowy:&lt;/Label&gt;&#xD;
    &lt;Expression&gt;select distinct Oob_Symbol +';' +DB_NAME(), Oob_Symbol + ' ' + DB_NAME() from cdn.okresyobrach
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;SQL&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Sql&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;true&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Rozrachunków Księgowych wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o stanie rozrachunków księgowych (należności i zobowiązania) firmy w danym dniu. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Raport zawiera następujące parametry:&#xD;
Data Analizy - Data, dla której wykonana zostanie analiza&#xD;
Przedział 1, 2, 3, 4, 5 - Górna granica (w dniach) przedziałów, do których zostaną przypisane dokumenty. &#xD;
Górna granica przedziału wcześniejszego jest dolną późniejszego.&#xD;
Obliczenia według: - Parametr określający czy struktura wiekowa ma być liczona na podstawie terminu płatności czy daty księgowania.&#xD;
&#xD;
W celu wyświetlania poprawnych danych należy wybrać odpowiedni okres obrachunkowy, dla którego ma być przeprowadzona analiza.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.DekretyNag - tabela zawiera nagłówki dekretów księgowych &#xD;
CDN.DekretyElem - tabela zawiera elementy dekretów księgowych&#xD;
CDN.KsiRozrachunki - tabela zawiera rozrachunki dokumentów księgowych</a:description><a:id>30</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>30. Raport Rozrachunków Księgowych Bieżących</a:mainLinkName><a:modifiedOn>2025-04-09T14:12:27.75</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-11-28T20:54:48.557</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Kadr i Płac &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.1.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
&#xD;
--Wyliczanie hierarchii wydziałów&#xD;
SELECT DZL_DzlId [gid], DZL_Kod [kod], DZL_ParentId [parId], DZL_Poziom [poziom] INTO #tmpTwrGr FROM CDN.Dzialy&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt; 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(100), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(100)'&#xD;
    EXEC(@sql)&#xD;
&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= parId '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = CASE WHEN ' + CAST(@poziom AS nvarchar) + ' &gt; poziom THEN ''('' + kod + '')'' ELSE kod END'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom =' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                         WHEN c.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(c.kod AS nvarchar) + '')''&#xD;
                         WHEN p.poziom &lt;' + CAST(@poziom AS nvarchar) + N' THEN ''('' + CAST(p.kod AS nvarchar) + '')''&#xD;
                    ELSE p.kod END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parId AS nvarchar)&#xD;
                    ELSE CAST(p.parId AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gid '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END&#xD;
&#xD;
declare @select varchar(max);&#xD;
declare @kolumny varchar(max);&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
&#xD;
set @i=1&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ', CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END [Wydział Poziom ' + LTRIM(@i) + '] '&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Pracowników&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(100), @atrybuty varchar(max), @sqlA nvarchar(max), @atrybut_Typ int, @atrybut_format nvarchar(21);&#xD;
&#xD;
DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DISTINCT OAT_AtkId, REPLACE(ATK_Nazwa, ']', '_'), ATK_Typ, ATK_Format&#xD;
FROM CDN.OAtrybuty&#xD;
JOIN CDN.OAtrybutyKlasy ON OAT_AtkId = ATK_AtkId&#xD;
WHERE OAT_PrcId IS NOT NULL;&#xD;
--AND OAT_AtkId IS NOT NULL;&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_Typ,@atrybut_format;&#xD;
&#xD;
SELECT DISTINCT OAT_PrcId INTO #tmpKonAtr FROM CDN.OAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = &#xD;
         CASE WHEN ' + convert(varchar,@atrybut_Typ) + ' = 3  THEN REPLACE(ATR.ATH_Wartosc,'','',''.'') ELSE ATR.ATH_Wartosc END          &#xD;
        FROM CDN.OAtrybutyHist ATR &#xD;
        JOIN CDN.OAtrybuty OA ON OA.OAT_OatId = ATR.ATH_OatId AND ATR.ATH_DataDo = (SELECT MAX(A1.ATH_DataDo) FROM CDN.OAtrybutyHist A1 WHERE A1.ATH_OatId = ATR.ATH_OatId)&#xD;
        JOIN #tmpKonAtr TM ON OA.OAT_PrcId = TM.OAT_PrcId&#xD;
        WHERE ATR.ATH_AtkId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
&#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = &#xD;
          CASE WHEN ' + convert(varchar,@atrybut_Typ) + ' = 3 AND ''' + convert(varchar,@atrybut_Format) + ''' &lt;&gt; ''Data'' THEN REPLACE(ATR.ATH_Wartosc,'','',''.'') ELSE &#xD;
           CASE WHEN ' + convert(varchar,@atrybut_Typ) + ' = 3 AND ''' + convert(varchar,@atrybut_Format) + ''' = ''Data'' THEN &#xD;
             REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.ATH_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'')&#xD;
             ELSE ATR.ATH_Wartosc  END&#xD;
          END       &#xD;
        FROM CDN.OAtrybutyHist ATR &#xD;
        JOIN CDN.OAtrybuty OA ON OA.OAT_OatId = ATR.ATH_OatId AND ATR.ATH_DataDo = (SELECT MAX(A1.ATH_DataDo) FROM CDN.OAtrybutyHist A1 WHERE A1.ATH_OatId = ATR.ATH_OatId)&#xD;
        JOIN #tmpKonAtr TM ON OA.OAT_PrcId = TM.OAT_PrcId&#xD;
        WHERE ATR.ATH_AtkId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Pracownik Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod,@atrybut_Typ,@atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie wypłat&#xD;
SELECT &#xD;
    WPL_WplId [wyplataID],&#xD;
    SUM(CASE WHEN TWP_WchodziDoWyplaty = 1 OR TWP_Rodzajzrodla = 35 THEN&#xD;
            CASE WHEN WPE_Wartosc &lt; 0&#xD;
                THEN 0 &#xD;
                ELSE WPE_Wartosc&#xD;
            END&#xD;
            ELSE 0&#xD;
        END) [brutto],&#xD;
    SUM(CASE WHEN WPE_Nazwa = 'Dni pobytu za granicą (liczba diet)' THEN WPE_Wartosc*WPL_OddelegowanyDieta*WPL_KursLNalDieta/WPL_KursMNalDieta ELSE 0 END) [dieta],&#xD;
    SUM(CASE WHEN WPE_Nazwa = 'Podstawa ZUS opodatk. zagr.' or WPE_Nazwa = 'Wyrównanie podstawy ZUS opodatk. zagr.' THEN WPE_Wartosc ELSE 0 END ) [podstawaOpodatkowania]&#xD;
INTO #Wyplaty&#xD;
FROM CDN.PracEtaty &#xD;
    JOIN CDN.Wyplaty ON WPL_PraId = PRE_PraId AND CAST(Pre_DataOd AS Date) &lt;= CAST(GetDate() AS Date) AND CAST(Pre_DataDo AS Date) &gt;= CAST(GetDate() AS Date)&#xD;
    JOIN CDN.WypElementy ON WPE_WplId = WPL_WplId&#xD;
    JOIN CDN.TypWyplata ON WPE_TwpId = TWP_TwpId&#xD;
group by WPL_WplId&#xD;
&#xD;
--Właściwe zapytanie&#xD;
SET @select =&#xD;
'SELECT &#xD;
    DB_NAME() [Baza Firmowa], &#xD;
    REPLACE(CONVERT(VARCHAR(10), WPL_DataOd, 111), ''/'', ''-'') [Data Od Wypłaty], REPLACE(CONVERT(VARCHAR(10), WPL_Datado, 111), ''/'', ''-'') [Data Do Wypłaty],&#xD;
    WPL_Rok [Data Rok Deklaracji], WPL_Miesiac [Data Miesiąc Deklaracji], &#xD;
    WPL_NumerPelny [Dokument Numer],&#xD;
    REPLACE(CONVERT(VARCHAR(10), PRE_ZatrudnionyOd, 111), ''/'', ''-'') [Data Zatrudnienia], &#xD;
    CASE WHEN PRE_ZatrudnionyDo = convert(datetime,''29991231'',112) THEN ''Czas nieokreślony'' ELSE REPLACE(CONVERT(VARCHAR(10), PRE_ZatrudnionyDo, 111), ''/'', ''-'') END [Data Zwolnienia],&#xD;
    CASE WHEN PRE_ZatrudnionyDo = convert(datetime,''29991231'',112) THEN DATEDIFF(d,PRE_ZatrudnionyOd, GETDATE())+1 ELSE DATEDIFF(d,PRE_ZatrudnionyOd, PRE_ZatrudnionyDo)+1 END [Okres Zatrudnienia],&#xD;
    PRE_Kod [Pracownik Kod],&#xD;
    PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa], &#xD;
    CASE WHEN PRE_ETARodzajUmowy = '''' THEN ''(NIEPRZYPISANE)'' ELSE PRE_ETARodzajUmowy END [Rodzaj Umowy], &#xD;
    CASE WHEN PRI_Archiwalny = 1 THEN ''Tak'' ELSE ''Nie'' END [Pracownik Archiwalny],&#xD;
    CASE WHEN pr1.PRI_Typ = 1 THEN ''Pracownik'' ELSE ''Własciciel/Współpracownik'' END [Pracownik Typ],&#xD;
    CASE &#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 10 THEN ''Etat'' &#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 20 THEN ''Umowa''&#xD;
        WHEN (SELECT SUM(PRI_Typ) FROM CDN.Pracidx WHERE PRE_PraId = PRI_PraId AND PRI_Typ &gt; 2) = 30 THEN ''Etat/Umowa''&#xD;
        ELSE ''Bez Zatrudnienia'' END [Typ Zatrudnienia], &#xD;
    CASE WHEN sta.DKM_Nazwa IS NULL THEN ''(NIEPRZYPISANE)'' ELSE sta.DKM_Nazwa END [Pracownik Stanowisko], &#xD;
    CASE WHEN zwo.DKM_Nazwa IS NULL THEN ''(NIEPRZYPISANE)'' ELSE zwo.DKM_Nazwa END [Pracownik Przyczyna Zwolnienia], &#xD;
    isnull(ZakPracownik.Zak_Symbol,''(NIEPRZYPISANY)'') as [Pracownik Zakład Symbol],&#xD;
    isnull(ZakPracownik.Zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Pracownik Zakład Nazwa Firmy],&#xD;
    isnull(ZakListPlac.Zak_Symbol,''(NIEPRZYPISANY)'') as [Wypłata Zakład Symbol],&#xD;
    isnull(ZakListPlac.Zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Wypłata Zakład Nazwa Firmy],&#xD;
    CNT_Kod [Centrum Kod],&#xD;
    CNT_Nazwa [Centrum Nazwa],&#xD;
    PRE_StNiepelnosp [Kod Stopnia Niepełnosprawności],&#xD;
    PRE_PrawoER [Kod Prawa Do Emerytury/Renty],&#xD;
    TYU_TyUb4 [Kod Tytułu Ubezpieczenia],&#xD;
    CASE PRE_KodWyksztal&#xD;
    WHEN ''11'' THEN ''Wykształcenie niepełne podstawowe''&#xD;
    WHEN ''12'' THEN ''Wykształcenie podstawowe ukończone''&#xD;
    WHEN ''20'' THEN ''Wykształcenie zasadnicze zawodowe''&#xD;
    WHEN ''31'' THEN ''Wykształcenie średnie zawodowe/techniczne''&#xD;
    WHEN ''32'' THEN ''Wykształcenie średnie ogólnokształcące''&#xD;
    WHEN ''40'' THEN ''Wykształcenie policealne''&#xD;
    WHEN ''50'' THEN ''Wykształcenie wyższe (w tym licencjat)''&#xD;
    ELSE ''Brak danych'' END  [Pracownik Wykształcenie],&#xD;
    CASE WHEN WPS_RodzajZrodla=4 THEN ''Tak'' ELSE ''Nie'' END [Element z Listy Dodatków],&#xD;
    CASE TWP_AlgPotracenie WHEN 1 THEN ''Tak'' ELSE ''Nie'' END [Element Wypłaty Potrącenie],&#xD;
    DATEDIFF(hour, ''18991230'',WPS_OkresCzas)  [Element Wypłaty Liczba Godzin],&#xD;
    WPS_OkresDni [Element Wypłaty Liczba Dni],&#xD;
    CASE &#xD;
        WHEN PRE_ETARodzajZatrudnienia = 0 THEN ''Pracownik''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 1 THEN ''Właściciel''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 2 THEN ''Osoba współpracująca''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 4 THEN ''Uczeń I klasa''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 5 THEN ''Uczeń II klasa''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 6 THEN ''Uczeń III klasa''&#xD;
        WHEN PRE_ETARodzajZatrudnienia = 7 THEN ''Młodociany''&#xD;
    ELSE ''(NIEPRZYPISANE)'' END [Rodzaj Zatrudnienia], PRE_Kod [Liczba Pracowników],       &#xD;
    LPL_NumerPelny [Lista Płac], DZL_Kod [Wydział z Wypłaty], Lok_Kod [Lokalizacja], DZL_AdresWezla [Wydział Adres Węzła], TWP_Nazwa [Element Wypłaty Typ], WPE_Nazwa [Element Wypłaty Nazwa],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') AS [Kategoria Szegółowa z Elementu], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') AS [Kategoria Szegółowa z Nagłówka], &#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') AS [Kategoria Ogólna z Elementu], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') AS [Kategoria Ogólna z Nagłówka], &#xD;
    CASE WHEN TWP_WchodziDoWyplaty = 0 AND TWP_OpisAnalitCzasPracy = 0&#xD;
        THEN ''NIE'' &#xD;
        ELSE ''TAK'' &#xD;
    END [Element Wypłaty Wpływ na Kwotę],&#xD;
    CASE WHEN TWP_RodzajFIS = 1&#xD;
        THEN ''NIE'' &#xD;
        ELSE ''TAK'' &#xD;
    END [Element Wypłaty Opodatkowany],&#xD;
    ISNULL(OPP_Procent/100,1)*     CASE WHEN TWP_WchodziDoWyplaty = 1 THEN&#xD;
        WPE_Wartosc - WPE_SklEmerPrac-WPE_SklRentPrac-WPE_SklChorPrac-WPE_SklWypadPrac-WPE_ZalFis-WPE_SklZdrowPrac-WPE_SklZdrowSuma-WPE_SklPPKPrac1-WPE_SklPPKPrac2 &#xD;
    ELSE - WPE_SklEmerPrac-WPE_SklRentPrac-WPE_SklChorPrac-WPE_SklWypadPrac-WPE_ZalFis-WPE_SklZdrowPrac-WPE_SklZdrowSuma-WPE_SklPPKPrac1-WPE_SklPPKPrac2&#xD;
    END &#xD;
    [Wypłata Wartość Netto],&#xD;
    ISNULL(OPP_Procent/100,1)* CASE WHEN TWP_WchodziDoWyplaty = 1 OR TWP_Rodzajzrodla = 35 THEN&#xD;
        CASE WHEN WPE_Wartosc &lt; 0&#xD;
            THEN 0 &#xD;
            ELSE WPE_Wartosc&#xD;
        END&#xD;
    ELSE 0 END [Suma Elementów Wypłaty],&#xD;
    ISNULL(OPP_Procent/100,1)* CASE WHEN TWP_RodzajZrodla &lt;&gt; 1 or TWP_WchodziDoWyplaty = 0 THEN 0 ELSE WPE_Wartosc END [Wypłata Wynagrodzenie Zasadnicze],&#xD;
    ISNULL(OPP_Procent/100,1)*(WPE_SklEmerPrac + WPE_SklRentPrac + WPE_SklChorPrac + WPE_SklWypadPrac) [Składka ZUS U], &#xD;
    ISNULL(OPP_Procent/100,1)*(WPE_SklEmerFirma + WPE_SklRentFirma + WPE_SklChorFirma + WPE_SklWypadFirma + WPE_SklFP + WPE_SklFGSP) [Składka ZUS P],&#xD;
    ISNULL(OPP_Procent/100,1)*CASE WHEN TWP_Nazwa LIKE ''Zasiłek wych%'' OR TWP_Nazwa LIKE ''Zasiłek mac%'' OR TWP_Nazwa LIKE ''Podwyższenie zasiłku mac%'' THEN NULL ELSE WPE_SklEmerFirma + WPE_SklRentFirma + WPE_SklChorFirma + WPE_SklWypadFirma + WPE_SklFP + WPE_SklFGSP END [Składka ZUS P bez Mac. i Wych.],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_Koszty [Koszty Uzyskania], &#xD;
    ISNULL(OPP_Procent/100,1)*(WPE_ZalFis + WPE_SklZdrowPrac + WPE_SklZdrowSuma) [Zal. Podatku z Ubezp. Zdrow.],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_Ulga [Ulga Podatkowa], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_ZalFis [Zaliczka Podatku do US], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_NalFis [Naliczona Zaliczka Podatku], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_PodstEmer [Podstawa Składki Emerytalnej], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklEmerPrac [Składka Emerytalna U],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklEmerFirma [Składka Emerytalna P],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_PodstRent [Podstawa Składki Rentowej],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklRentPrac [Składka Rentowa U],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklRentFirma [Składka Rentowa P],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_PodstChor [Podstawa Składki Chorobowej], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklChorPrac [Składka Chorobowa U], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklChorFirma [Składka Chorobowa P], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_PodstWypad [Podstawa Składki Wypadkowej],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklWypadPrac [Składka Wypadkowa U],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklWypadFirma [Składka Wypadkowa P], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_PodstFP [Podstawa Składki na FP], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklFP [Składka na FP], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_PodstFGSP [Podstawa Składki na FGŚP], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklFGSP [Składka na FGŚP], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_PodstFEP [Podstawa Składki na FEP],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklFEP [Składka na FEP],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_PodstZdrow [Podstawa Składki Zdrowotnej], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklZdrowPrac [Składka Zdrowotna (odl.)],&#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklZdrowSuma [Składka Zdrowotna (od netto)], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklZdrowPrac + WPE_SklZdrowSuma [Składka Zdrowotna (pob.) U], &#xD;
    ISNULL(OPP_Procent/100,1)*WPE_SklZdrowFirma [Składka Zdrowotna (pob.) P],&#xD;
    ISNULL(OPP_Procent/100,1)*CASE WHEN TWP_Nazwa LIKE ''Zasiłek wych%'' OR TWP_Nazwa LIKE ''Zasiłek mac%'' OR TWP_Nazwa LIKE ''Podwyższenie zasiłku mac%'' THEN NULL ELSE WPE_SklEmerPrac END [Składka Emerytalna U bez Mac. i Wych.], &#xD;
    ISNULL(OPP_Procent/100,1)*CASE WHEN TWP_Nazwa LIKE ''Zasiłek wych%'' OR TWP_Nazwa LIKE ''Zasiłek mac%'' OR TWP_Nazwa LIKE ''Podwyższenie zasiłku mac%'' THEN NULL ELSE WPE_SklEmerFirma END [Składka Emerytalna P bez Mac. i Wych.],&#xD;
    ISNULL(OPP_Procent/100,1)*CASE WHEN TWP_Nazwa LIKE ''Zasiłek wych%'' OR TWP_Nazwa LIKE ''Zasiłek mac%'' OR TWP_Nazwa LIKE ''Podwyższenie zasiłku mac%'' THEN NULL ELSE WPE_SklRentPrac END [Składka Rentowa U bez Mac. i Wych.],&#xD;
    ISNULL(OPP_Procent/100,1)*CASE WHEN TWP_Nazwa LIKE ''Zasiłek wych%'' OR TWP_Nazwa LIKE ''Zasiłek mac%'' OR TWP_Nazwa LIKE ''Podwyższenie zasiłku mac%'' THEN NULL ELSE WPE_SklRentFirma END [Składka Rentowa P bez Mac. i Wych.],&#xD;
    ISNULL(OPP_Procent/100,1)*WEP_KWOTa2 [Stawka Wyliczona ze Składników Zmiennych], -- dla elementu wypłaty "Wynagrodzenie za czas urlopu"&#xD;
    ISNULL(OPP_Procent/100,1)*   CASE WHEN SUBSTRING(CAST(WPE_TyUb as nvarchar), 1,4) = ''1211'' OR SUBSTRING(CAST(WPE_TyUb as nvarchar), 1,4) = ''1240''  THEN 0 &#xD;
	when 	TWP_PdzId IN (332,334,336,311,312,313,314,212,214,215,216,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329) THEN 0&#xD;
	ELSE  IIF(TWP_KosztFirma = 1, WPE_Wartosc, 0)  + WPE_SklEmerFirma + WPE_SklRentFirma +  WPE_SklWypadFirma + WPE_SklFP + WPE_SklFGSP + WPE_SklFEP  END  [Całkowity Koszt Zatrudnienia Pracownika],&#xD;
      ISNULL(OPP_Procent/100,1)*case when PZE_czasWolne is not null then  (DATEDIFF(hour, ''18991230'', PZE_czasWolne)) else null end  as [Zestawienia Czas Wolny godziny],&#xD;
      ISNULL(OPP_Procent/100,1)*case when PZE_Nadgodziny50 is not null then  (DATEDIFF(hour, ''18991230'', PZE_Nadgodziny50)) else null end  as [Zestawienia Nadgodziny 50 godziny],&#xD;
      ISNULL(OPP_Procent/100,1)*case when PZE_Nadgodziny100 is not null then  (DATEDIFF(hour, ''18991230'', PZE_Nadgodziny100)) else null end  as [Zestawienia Nadgodziny 100 godziny],&#xD;
      ISNULL(OPP_Procent/100,1)*case when PZE_NadgodzinySW is not null then  (DATEDIFF(hour, ''18991230'', PZE_NadgodzinySW)) else null end  as [Zestawienia Nadgodziny Święta godziny],&#xD;
      ISNULL(OPP_Procent/100,1)*case when PZE_CzasSW is not null then  (DATEDIFF(hour, ''18991230'', PZE_CzasSW)) else null end  as [Zestawienia Czas Święta godziny]&#xD;
      ,ISNULL(OPP_Procent/100,1)*WPE_PodstPPK [Podstawa Składki PPK]&#xD;
      ,ISNULL(OPP_Procent/100,1)*WPE_SklPPKPrac1 [Składka PPK Podstawowa U]&#xD;
      ,ISNULL(OPP_Procent/100,1)*WPE_SklPPKPrac2 [Składka PPK Dodatkowa U]&#xD;
      ,ISNULL(OPP_Procent/100,1)*WPE_SklPPKFirma1 [Składka PPK Podstawowa P]&#xD;
      ,ISNULL(OPP_Procent/100,1)*WPE_SklPPKFirma2 [Składka PPK Dodatkowa P]&#xD;
      ,CASE WHEN (LPL_DekID is null and LPL_KPRID is null and LPL_PreDekID is null) THEN ''NIE'' ELSE ''TAK'' END [Lista Płace Zaksięgowana]&#xD;
      ,case when opp_prjid is not null then PRJ_Kod else ''&lt;BRAK&gt;'' end [Opis Analityczny Projekt Kod]&#xD;
      ,case when opp_prjid is not null then PRJ_Nazwa else ''&lt;BRAK&gt;'' end [Opis Analityczny Projekt Nazwa]&#xD;
      ,case when opp_dzlid is not null then dzialy.Kod else ''&lt;BRAK&gt;'' end [Opis Analityczny Wydział Kod]&#xD;
      ,case when opp_dzlid is not null then dzialy.Nazwa else ''&lt;BRAK&gt;'' end [Opis Analityczny Wydział Nazwa]&#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), LPL_DataDok, 111), ''/'', ''-'') [Data Wypłaty]&#xD;
*/&#xD;
&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), LPL_DataDok, 111), ''/'', ''-'') [Data Wypłaty Dzień], MONTH(LPL_DataDok) [Data Wypłaty Miesiąc]&#xD;
,(datepart(DY, datediff(d, 0, LPL_DataDok) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, LPL_DataDok)*/ [Data Wypłaty Tydzień Roku]&#xD;
,DATEPART(quarter, LPL_DataDok) AS [Data Wypłaty Kwartał], YEAR(LPL_DataDok) [Data Wypłaty Rok]&#xD;
,GETDATE() [Data Analizy]&#xD;
      ----------KONTEKSTY&#xD;
    ,24020 [Dokument Numer __PROCID__], WPL_WplId [Dokument Numer __ORGID__], '''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,24001 [Pracownik Kod __PROCID__Pracownicy__], PRE_PraId [Pracownik Kod __ORGID__],'''+@bazaFirmowa+''' [Pracownik Kod __DATABASE__]&#xD;
    ,24001 [Pracownik Nazwa __PROCID__], PRE_PraId [Pracownik Nazwa __ORGID__],'''+@bazaFirmowa+''' [Pracownik Nazwa __DATABASE__]&#xD;
&#xD;
    ' + @kolumny + @atrybuty + '&#xD;
 FROM CDN.WypElementy&#xD;
 left join cdn.OpisPlace on OPP_WPEID = WPE_WPEID&#xD;
    JOIN CDN.Wyplaty ON WPE_WplId = WPL_WplId&#xD;
    JOIN #Wyplaty WPTM On WPE_WplId = wyplataID&#xD;
    JOIN CDN.ListyPlac ON WPL_LplId = LPL_LplId &#xD;
    JOIN CDN.PracEtaty ON WPL_PraId = PRE_PraId AND CAST(Pre_DataOd AS Date) &lt;= CAST(GetDate() AS Date) AND CAST(Pre_DataDo AS Date) &gt;= CAST(GetDate() AS Date)&#xD;
    JOIN CDN.Pracidx pr1 ON PRE_PraId = pr1.PRI_PraId AND pr1.PRI_Typ &lt; 10&#xD;
    JOIN CDN.Dzialy dz ON WPL_DzlId = dz.DZL_DzlId &#xD;
    JOIN CDN.Lokalizacje ON DZL_LokId = Lok_LokId&#xD;
    JOIN CDN.TypWyplata ON WPE_TwpId = TWP_TwpId&#xD;
    LEFT JOIN CDN.WypSkladniki ON WPE_WpeId = WPS_WpeId and PRE_PraId = WPS_PraId and TWP_TwpId = WPS_TwpId&#xD;
    LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko = sta.DKM_DkmId AND sta.DKM_Rodzaj = 1&#xD;
    LEFT JOIN CDN.DaneKadMod zwo ON PRE_ETADkmIdWypowPowod = zwo.DKM_DkmId AND zwo.DKM_Rodzaj = 3&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat1 ON WPE_KatId = kat1.Kat_KatID&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat2 ON WPL_KatId = kat2.Kat_KatID&#xD;
    left join cdn.PracZestaw zestaw on pze_praid = wpl_praid and wpl_dataod = pze_okresod and wpl_datado = pze_okresdo and wpe_twpid = 1&#xD;
    LEFT JOIN #tmpTwrGr Poz ON PRE_DzlId = Poz.gid&#xD;
    LEFT JOIN #tmpKonAtr KonAtr ON PRE_PraId = OAT_PrcId&#xD;
    LEFT OUTER JOIN CDN.Zaklady ZakListPlac on ZAkListPlac.ZAK_ZAkID = LPL_ZakId&#xD;
    LEFT OUTER JOIN CDN.Zaklady ZakPracownik on ZakPracownik.ZAK_ZAkID = PRE_ZakId&#xD;
    LEFT OUTER JOIN [CDN].[WypElementyPodstawa] ON WEP_WpeId = WPE_WpeId AND WPE_TwpID = 70&#xD;
    LEFT JOIN CDN.TyTUbezp ON TyU_TyUId = PRE_UBZTyuId&#xD;
    LEFT JOIN CDN.Centra ON CNT_CntId = PRE_CntId&#xD;
    left join cdn.DefProjekty on opp_prjid = prj_prjid&#xD;
    left join (select distinct dzl_dzlid as id, dzl_kod as kod,dzl_nazwa as nazwa from cdn.Dzialy) dzialy on opp_dzlid = dzialy.id&#xD;
WHERE&#xD;
    WPL_Tryb&lt;&gt;1 AND WPL_Tryb&lt;&gt;2 AND TWP_Wskaznik &lt;&gt; 1     '&#xD;
&#xD;
PRINT(@Select)&#xD;
EXEC(@select)   &#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #Wyplaty&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wypłaty Dzień" caption="Data Wypłaty Dzień" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wypłaty Miesiąc" caption="Data Wypłaty Miesiąc" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wypłaty Tydzień Roku" caption="Data Wypłaty Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wypłaty Kwartał" caption="Data Wypłaty Kwartał" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Wypłaty Rok" caption="Data Wypłaty Rok" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Od Wypłaty" caption="Data Od Wypłaty" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Do Wypłaty" caption="Data Do Wypłaty" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Rok Deklaracji" caption="Data Rok Deklaracji" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Miesiąc Deklaracji" caption="Data Miesiąc Deklaracji" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Zatrudnienia" caption="Data Zatrudnienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zwolnienia" caption="Data Zwolnienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Okres Zatrudnienia" caption="Okres Zatrudnienia" type="measure" formatString="n0" aggregate="Average" /&gt;&#xD;
    &lt;column name="Pracownik Kod" caption="Pracownik Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Pracownik Nazwa" caption="Pracownik Nazwa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Rodzaj Umowy" caption="Rodzaj Umowy" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Pracownik Archiwalny" caption="Pracownik Archiwalny" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Pracownik Typ" caption="Pracownik Typ" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Typ Zatrudnienia" caption="Typ Zatrudnienia" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Pracownik Stanowisko" caption="Pracownik Stanowisko" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Pracownik Przyczyna Zwolnienia" caption="Pracownik Przyczyna Zwolnienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Zakład Symbol" caption="Pracownik Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Zakład Nazwa Firmy" caption="Pracownik Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wypłata Zakład Symbol" caption="Wypłata Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wypłata Zakład Nazwa Firmy" caption="Wypłata Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Centrum Kod" caption="Centrum Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Centrum Nazwa" caption="Centrum Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kod Stopnia Niepełnosprawności" caption="Kod Stopnia Niepełnosprawności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kod Prawa Do Emerytury/Renty" caption="Kod Prawa Do Emerytury/Renty" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kod Tytułu Ubezpieczenia" caption="Kod Tytułu Ubezpieczenia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Wykształcenie" caption="Pracownik Wykształcenie" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Element Wypłaty Potrącenie" caption="Element Wypłaty Potrącenie" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rodzaj Zatrudnienia" caption="Rodzaj Zatrudnienia" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Liczba Pracowników" caption="Liczba Pracowników" type="measure" formatString="n0" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Lista Płac" caption="Lista Płac" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Wydział z Wypłaty" caption="Wydział z Wypłaty" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Lokalizacja" caption="Lokalizacja" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Element Wypłaty Typ" caption="Element Wypłaty Typ" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Element Wypłaty Nazwa" caption="Element Wypłaty Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kategoria Szegółowa z Elementu" caption="Kategoria Szegółowa z Elementu" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Szegółowa z Nagłówka" caption="Kategoria Szegółowa z Nagłówka" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Elementu" caption="Kategoria Ogólna z Elementu" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Element Wypłaty Wpływ na Kwotę" caption="Element Wypłaty Wpływ na Kwotę" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Element Wypłaty Opodatkowany" caption="Element Wypłaty Opodatkowany" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Suma Elementów Wypłaty" caption="Suma Elementów Wypłaty" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wypłaty Wartość Netto" caption="Wypłaty Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka ZUS U" caption="Składka ZUS U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka ZUS P" caption="Składka ZUS P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka ZUS P bez Mac. i Wych." caption="Składka ZUS P bez Mac. i Wych." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszty Uzyskania" caption="Koszty Uzyskania" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zal. Podatku z Ubezp. Zdrow." caption="Zal. Podatku z Ubezp. Zdrow." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ulga Podatkowa" caption="Ulga Podatkowa" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zaliczka Podatku do US" caption="Zaliczka Podatku do US" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Naliczona Zaliczka Podatku" caption="Naliczona Zaliczka Podatku" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki Emerytalnej" caption="Podstawa Składki Emerytalnej" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Emerytalna U" caption="Składka Emerytalna U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Emerytalna P" caption="Składka Emerytalna P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki Rentowej" caption="Podstawa Składki Rentowej" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Rentowa U" caption="Składka Rentowa U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Rentowa P" caption="Składka Rentowa P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki Chorobowej" caption="Podstawa Składki Chorobowej" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Chorobowa U" caption="Składka Chorobowa U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Chorobowa P" caption="Składka Chorobowa P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki Wypadkowej" caption="Podstawa Składki Wypadkowej" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Wypadkowa U" caption="Składka Wypadkowa U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Wypadkowa P" caption="Składka Wypadkowa P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki na FP" caption="Podstawa Składki na FP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka na FP" caption="Składka na FP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki na FGŚP" caption="Podstawa Składki na FGŚP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka na FGŚP" caption="Składka na FGŚP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki na FEP" caption="Podstawa Składki na FEP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka na FEP" caption="Składka na FEP" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki Zdrowotnej" caption="Podstawa Składki Zdrowotnej" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Zdrowotna (odl.)" caption="Składka Zdrowotna (odl.)" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Zdrowotna (od netto)" caption="Składka Zdrowotna (od netto)" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Zdrowotna (pob.) U" caption="Składka Zdrowotna (pob.) U" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Zdrowotna (pob.) P" caption="Składka Zdrowotna (pob.) P" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Emerytalna U bez Mac. i Wych." caption="Składka Emerytalna U bez Mac. i Wych." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Emerytalna P bez Mac. i Wych." caption="Składka Emerytalna P bez Mac. i Wych." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Rentowa U bez Mac. i Wych." caption="Składka Rentowa U bez Mac. i Wych." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka Rentowa P bez Mac. i Wych." caption="Składka Rentowa P bez Mac. i Wych." type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Stawka Wyliczona ze Składników Zmiennych" caption="Stawka Wyliczona ze Składników Zmiennych" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Całkowity Koszt Zatrudnienia Pracownika" caption="Całkowity Koszt Zatrudnienia Pracownika" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zestawienia Czas Wolny godziny" caption="Zestawienia Czas Wolny godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zestawienia Nadgodziny 50 godziny" caption="Zestawienia Nadgodziny 50 godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zestawienia Nadgodziny 100 godziny" caption="Zestawienia Nadgodziny 100 godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zestawienia Nadgodziny Święta godziny" caption="Zestawienia Nadgodziny Święta godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zestawienia Czas Święta godziny" caption="Zestawienia Czas Święta godziny" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podstawa Składki PPK" caption="Podstawa Składki PPK" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka PPK Podstawowa U" caption="Składka PPK Podstawowa U" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka PPK Dodatkowa U" caption="Składka PPK Dodatkowa U" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka PPK Podstawowa P" caption="Składka PPK Podstawowa P" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Składka PPK Dodatkowa P" caption="Składka PPK Dodatkowa P" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wydział Poziom 1" caption="Wydział Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Poziom 2" caption="Wydział Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Poziom 3" caption="Wydział Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Poziom 4" caption="Wydział Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut Ilość godzin świątecznych" caption="Pracownik Atrybut Ilość godzin świątecznych" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Atrybut Dieta za udział w posiedzeniu" caption="Pracownik Atrybut Dieta za udział w posiedzeniu" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="402" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Kadr i Płac wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje na temat wypłat pracowników. Prezentowane są informacje z dokumentów wypłat i list płac. Wartości prezentowane są w walucie systemowej oraz walucie dokumentu. Dodatkowo w raporcie istnieje możliwość analizy danych przy rozbiciu na opis analityczny elementów wypłaty. Rozbija to względem opisu każdą z miar użytych na raporcie.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.Wyplaty - tabela zawierająca wypłaty pracowników &#xD;
CDN.WypElementy - tabela zawierająca elementy wypłat pracowników&#xD;
CDN.PracEtaty - tabela zawierająca szczegółową ewidencję danych kadrowych pracowników</a:description><a:id>31</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>31. Raport Kadr i Płac z Opisem Analitycznym</a:mainLinkName><a:modifiedOn>2025-04-14T14:15:31.29</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-03-19T15:39:56.783</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Dokumentów Magazynowych &#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'     &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'      &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Zmiana typu operatora z nvarchar na varchar&#xD;
DECLARE @OPERATOR2 VARCHAR(MAX);&#xD;
SET @OPERATOR2 = @OPERATOR&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    TrN_NumerPelny [Dokument Numer],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(TrN_Opis,''''),''(BRAK)'') [Dokument Opis],&#xD;
ISNULL(NULLIF(TrN_Waluta, ''''), @Wal) [Waluta], &#xD;
    CASE                                &#xD;
        WHEN TrN_TypDokumentu = 312 THEN ''MM''&#xD;
        WHEN TrN_TypDokumentu = 303 THEN ''PW''&#xD;
        WHEN TrN_TypDokumentu = 317 THEN ''PWP''&#xD;
        WHEN TrN_TypDokumentu = 307 THEN ''PZ''&#xD;
        WHEN TrN_TypDokumentu = 304 THEN ''RW''&#xD;
        WHEN TrN_TypDokumentu = 318 THEN ''RWS''&#xD;
        WHEN TrN_TypDokumentu = 306 THEN ''WZ''&#xD;
        WHEN TrN_TypDokumentu = 313 THEN ''PKA''&#xD;
        WHEN TrN_TypDokumentu = 314 THEN ''WKA''&#xD;
    ELSE ''(NIEPRZYPISANY)'' END [Dokument Typ],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    pod1.Pod_Nazwa1 [Kontrahent Pierwotny Nazwa],   &#xD;
    pod1.Pod_Kod [Kontrahent Pierwotny Kod],&#xD;
     ISNULL(NULLIF(pod1.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo],&#xD;
     ISNULL(NULLIF(pod1.Pod_Powiat, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Powiat],&#xD;
    ISNULL(NULLIF(pod1.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto], &#xD;
    ISNULL(NULLIF(pod1.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], &#xD;
    ISNULL(NULLIF(pod1.Pod_NIP, ''''), ''(BRAK)'') [Kontrahent Pierwotny NIP], &#xD;
    ISNULL(NULLIF(pod1.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], &#xD;
    CASE &#xD;
        WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
    ELSE ''(NIEPRZYPISANE)'' END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt1.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt1.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
    ISNULL(NULLIF(pod5.Pod_Powiat, ''''),''(NIEPRZYPISANE)'') [Kontrahent Powiat], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    pod7.Pod_Nazwa1 [Odbiorca Nazwa],   &#xD;
    pod7.Pod_Kod [Odbiorca Kod], &#xD;
    ISNULL(NULLIF(pod7.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Odbiorca Województwo],&#xD;
    ISNULL(NULLIF(pod7.Pod_Powiat, ''''),''(NIEPRZYPISANE)'') [Odbiorca Powiat], ISNULL(NULLIF(pod7.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(pod7.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Odbiorca Kraj],&#xD;
    ISNULL(NULLIF(pod7.Pod_NIP, ''''),''(BRAK)'') [Odbiorca NIP],&#xD;
    ISNULL(NULLIF(pod7.Pod_Grupa, ''''),''Pozostali'') [Odbiorca Grupa],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Nagłówka], ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa z Elementu],&#xD;
    ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Nagłówka], ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna z Elementu], &#xD;
    Twr_Nazwa [Produkt Nazwa],&#xD;
    CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END [Produkt PKWiU],&#xD;
    ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca], &#xD;
    CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny], &#xD;
    Twr_Kod [Produkt Kod], &#xD;
    poz.sciezka [Produkt Pełna Nazwa Grupy], "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)), Twr_Jm [Jednostka Miary], &#xD;
    Isnull(convert(varchar(15),twr_wagakg), ''(NIEPRZYPISANE)'') [Produkt Waga KG],&#xD;
     ISNULL(Mag.Mag_Symbol, ''(NIEPRZYPISANE)'') [Magazyn Kod],&#xD;
     ISNULL(MagDoc.Mag_Symbol, ''(NIEPRZYPISANE)'') [Magazyn Docelowy Kod],&#xD;
ISNULL(Prd_Kod, ''(NIEPRZYPISANE)'') [Produkt Producent], ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)'') [Produkt Marka],&#xD;
        CASE&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa Prosta''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar Prosty''&#xD;
        WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa Złożona''&#xD;
        WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar Złożony''&#xD;
        ELSE ''(NIEOKREŚLONY)''&#xD;
    END [Produkt Typ], TwC_Wartosc [Cena Domyślna],&#xD;
    TR.TrE_WartoscNetto [Wartość Netto], TR.TrE_WartoscBrutto [Wartość Brutto], TR.TrE_WartoscNettoWal [Wartość Waluta], TR.TrE_Ilosc [Ilość], &#xD;
    TR.TrE_WartoscNetto - (ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi) [Marża], ISNULL(KosztWyliczony.Koszt ,0) + TR.TrE_KosztUslugi [Koszt Zakupu]&#xD;
,'''+@OPERATOR2+''' as [OPERATOR]&#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji]&#xD;
,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia]&#xD;
*/&#xD;
----------DATY ANALIZY&#xD;
,REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'') [Data Operacji Dzień], (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/ [Data Operacji Tydzień Roku]&#xD;
,MONTH(TrN_DataOpe) [Data Operacji Miesiąc], DATEPART(quarter, TrN_DataOpe) [Data Operacji Kwartał], YEAR(TrN_DataOpe) [Data Operacji Rok] &#xD;
,REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'') [Data Wystawienia Dzień], (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ [Data Wystawienia Tydzień Roku] &#xD;
,MONTH(TrN_DataWys) [Data Wystawienia Miesiąc], DATEPART(quarter, TrN_DataWys) [Data Wystawienia Kwartał], YEAR(TrN_DataWys) [Data Wystawienia Rok] &#xD;
,GETDATE() [Data Analizy]&#xD;
----------KONTEKSTY&#xD;
        ,CASE                               &#xD;
        WHEN TrN_TypDokumentu = 312 THEN 25034&#xD;
        WHEN TrN_TypDokumentu = 303 THEN 25032&#xD;
        WHEN TrN_TypDokumentu = 317 THEN 25045&#xD;
        WHEN TrN_TypDokumentu = 307 THEN 25024&#xD;
        WHEN TrN_TypDokumentu = 304 THEN 25030&#xD;
        WHEN TrN_TypDokumentu = 318 THEN 25046&#xD;
        WHEN TrN_TypDokumentu = 306 THEN 25022&#xD;
        WHEN TrN_TypDokumentu = 313 THEN 25079&#xD;
        WHEN TrN_TypDokumentu = 314 THEN 25078&#xD;
    END [Dokument Numer __PROCID__WZ__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny  Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
    ,29056 [Magazyn Kod __PROCID__Magazyny__], Mag.Mag_MagId [Magazyn Kod __ORGID__], '''+@bazaFirmowa+''' [Magazyn Kod __DATABASE__]     &#xD;
    ,29056 [Magazyn Docelowy Kod __PROCID__Magazyny__], MagDoc.Mag_MagId [Magazyn Docelowy Kod __ORGID__], '''+@bazaFirmowa+''' [Magazyn Docelowy Kod __DATABASE__]&#xD;
     &#xD;
&#xD;
'&#xD;
    + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
       &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem TR ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt1 ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     LEFT JOIN CDN.TwrCeny ON Twr_TwrId = TwC_TwrID AND Twr_TwCNumer = TwC_TwCNumer&#xD;
     LEFT OUTER JOIN CDN.Magazyny Mag ON (CASE WHEN TrN_TypDokumentu = 318 THEN TrN_MagZrdId ELSE ISNULL(TrE_MagId,TrN_MagZrdId) END) = Mag.Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Magazyny MagDoc ON MagDoc.Mag_MagId = TrN_MagDocId&#xD;
    left join (select distinct maz_magid from cdn.magazynzakazy left join ' +@Operatorzy +' on maz_opeid = ope_opeid and ope_kod = '''+@OPERATOR2+''') magzak on mag.mag_magid = magzak.maz_magid&#xD;
left join (select distinct maz_magid from cdn.magazynzakazy left join ' +@Operatorzy +' on maz_opeid = ope_opeid and ope_kod = '''+@OPERATOR2+''') magzak2 on MagDoc.mag_magid = magzak.maz_magid&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON pod1.Pod_PodId = KonAtr.KnA_PodmiotId AND pod1.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId  &#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
     LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod7 ON TrN_OdbID = pod7.Pod_PodId AND TrN_OdbiorcaTyp = pod7.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT OUTER JOIN ( &#xD;
            SELECT ISNULL(SUM(CASE WHEN TrS_Rodzaj = 312000 AND TrS_Ilosc &lt; 0 AND TrS_ZwrId IS NULL THEN 0&#xD;
                                   WHEN (TrS_Rodzaj = 308000 OR TrS_Rodzaj = 308011) AND TrS_Ilosc &lt; 0 THEN 0&#xD;
                                   ELSE TrS_Wartosc&#xD;
                              END),0) as Koszt,&#xD;
                           TRE.TrE_TrEID&#xD;
            FROM CDN.TraElem TRE&#xD;
            JOIN ( SELECT TrE_TrEId as IdElem, TrE_TrEId as IdZwiaz&#xD;
                   FROM CDN.TraElem&#xD;
                   UNION ALL&#xD;
                   SELECT TRE.TrE_TrEId, TRERel.TrE_TreId&#xD;
                     FROM cdn.TraElem TRE&#xD;
                       JOIN cdn.TraNag TRN ON TRE.TrE_TrNId = TrN_TrNId&#xD;
                       JOIN cdn.TraNagRelacje  ON TrN_TrNId = TrR_FaId AND TrR_Flaga &lt;&gt; 1&#xD;
                       JOIN cdn.TraElem TRERel ON TRERel.Tre_trnid = TrR_TrnId AND TREREl.Tre_lppow= tre.tre_lppow&#xD;
                     WHERE TrR_FaId = TRE.TrE_TrNId  AND TRERel.TrE_TypDokumentu NOT IN ( 318,309,308 ) and NOT (TrR_TrNtyp = 306 and TrR_FaTyp=307) and not (TrR_TrNtyp = 307 and TrR_FaTyp=306)&#xD;
                 ) AS Elem ON TRE.Tre_TrEId = Elem.IdElem&#xD;
            JOIN CDN.TraSElem TRS ON TRS.TrS_TrEId = Elem.IdZwiaz&#xD;
            GROUP BY TRE.TrE_TrEID&#xD;
    )KosztWyliczony  ON KosztWyliczony.TrE_TrEID = TR.TrE_TrEID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu IN ( 303, 304, 306, 307, 312, 313, 314, 317, 318)&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
and Magzak.maz_magid is null and magzak2.maz_magid is null'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Typ" caption="Dokument Typ" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod" caption="Odbiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Województwo" caption="Odbiorca Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Powiat" caption="Odbiorca Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kraj" caption="Odbiorca Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca NIP" caption="Odbiorca NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Grupa" caption="Odbiorca Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Elementu" caption="Kategoria Szczegółowa z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Elementu" caption="Kategoria Ogólna z Elementu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Waga KG" caption="Produkt Waga KG" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Kod" caption="Magazyn Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Magazyn Docelowy Kod" caption="Magazyn Docelowy Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Cena Domyślna" caption="Cena Domyślna" type="measure" formatString="c2" aggregate="Average" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wartość Netto" caption="Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Brutto" caption="Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wartość Waluta" caption="Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Ilość" caption="Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Marża" caption="Marża" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Koszt Zakupu" caption="Koszt Zakupu" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut WARUNKI DOSTAWY" caption="Kontrahent Pierwotny Atrybut WARUNKI DOSTAWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut WARUNKI DOSTAWY" caption="Kontrahent Atrybut WARUNKI DOSTAWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KONTRAHENT TYP" caption="Kontrahent Pierwotny Atrybut KONTRAHENT TYP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KONTRAHENT TYP" caption="Kontrahent Atrybut KONTRAHENT TYP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 2.WARUNKI DOSTAWY" caption="Dokument Atrybut 2.WARUNKI DOSTAWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut WARUNKI DOSTAWY (K)" caption="Dokument Atrybut WARUNKI DOSTAWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut RODZAJ KLIENTA" caption="Dokument Atrybut RODZAJ KLIENTA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DATA W" caption="Dokument Atrybut DATA W" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KONTRAHENT TYP (K)" caption="Dokument Atrybut KONTRAHENT TYP (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut TRANSPORT" caption="Dokument Atrybut TRANSPORT" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 1" caption="Dokument Atrybut 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 2" caption="Dokument Atrybut 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 3" caption="Dokument Atrybut 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 4" caption="Dokument Atrybut 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 5" caption="Dokument Atrybut 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 6" caption="Dokument Atrybut 6" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR FS" caption="Produkt Atrybut NR FS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut WILGOTNOSC" caption="Produkt Atrybut WILGOTNOSC" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ASDSADASDSADSADASD" caption="Produkt Atrybut ASDSADASDSADSADASD" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TEST ATR ZALEZ OD KO" caption="Produkt Atrybut TEST ATR ZALEZ OD KO" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut SBITEST" caption="Produkt Atrybut SBITEST" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR FS" caption="Pozycja Atrybut NR FS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut TEST ATR ZALEZ OD KO" caption="Pozycja Atrybut TEST ATR ZALEZ OD KO" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut SBITEST" caption="Pozycja Atrybut SBITEST" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;OPERATOR&lt;/Name&gt;&#xD;
    &lt;Label&gt;OPERATOR&lt;/Label&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Operator&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Operator&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;admin&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="False" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Dokumentów Magazynowych z zakazem magazynowym wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o sprzedaży i zakupach w firmie na podstawie dokumentów magazynowych. Wartości prezentowane są w walucie systemowej.&#xD;
Analizy oparte są o dokumenty PW, RW, PZ, WZ, MM, PKA, WKA, PWP, RWS. Niebrane pod uwagę są dokumenty anulowane. Do poprawnej analizy należy wybrać typ dokumentu, dla którego ma zostać wyświetlony raport.&#xD;
Raport zawiera parametr zalogowanego operatora według, którego uwzglęniane są zakazy dodane na liście magazynów. Jeśli operator ma zakaz na dany magazyn nie zostanie on wyświetlony jako element wymiaru oraz nie zostaną przedstawione powiązane z nim dokumenty.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (WZ, PZ itp.). &#xD;
TraElem - Tabela z elementami dokumentów (WZ, PZ itp.).</a:description><a:id>32</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>32. Raport Dokumentów Magazynowych z Zakazem Magazynowym</a:mainLinkName><a:modifiedOn>2025-02-04T12:25:54.46</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2020-05-07T13:50:56.367</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Płatności z Zakazami Dostępu&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @atrybuty2 varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
SET @atrybuty2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'')  &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Podmiot Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybuty2 = @atrybuty2 + N', [Podmiot Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Podmiot Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybuty2 = @atrybuty2 + N', [Podmiot Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'  &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max), @atrybutyDok2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
SET @atrybutyDok2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END        &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    SET @atrybutyDok2 = @atrybutyDok2 + N', [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
&#xD;
DECLARE @select VARCHAR(MAX);&#xD;
&#xD;
SET @select =' &#xD;
Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT &#xD;
"BO Rachunku Waluta" = borachunekwal,&#xD;
"Waluta BO" = bowaluta,&#xD;
    "Baza Firmowa" = bf, &#xD;
    "Zapisy/Zdarzenia" = zap,&#xD;
    &#xD;
    "Dokument Numer" = nr,&#xD;
    "Dokument Symbol" = sy,  &#xD;
    "Dokument Numer Pełny" = nrPelny, &#xD;
    "Dokument Opis" = op, &#xD;
    "Dokument MPP" = CASE mpp WHEN 1 THEN ''Tak'' ELSE ''Nie'' END,&#xD;
    ds [Dokument Seria],&#xD;
    Waluta = waluta, "Status" = sta, "Forma Płatności" = fp,&#xD;
    "Raport KB" = raport, "BO Raportu" = boraportu, "BO Rachunku" = borachunku, "Raport KB Stan" = stanraportu, &#xD;
    "Dokument Ponaglenia Numer" = nrpon,&#xD;
    "Dokument Ponaglenia Data Wystawienia" = datpon,    &#xD;
    "Podmiot Pierwotny Nazwa" = kon, &#xD;
    "Podmiot Pierwotny Kod" = konKod, &#xD;
    "Podmiot Pierwotny Typ" = konTyp, "Podmiot Pierwotny Rodzaj" = konRodz, "Podmiot Pierwotny Status" = konStatus,&#xD;
    "Podmiot Pierwotny Grupa" = konGrupa, "Podmiot Pierwotny Opiekun" = konOpie,&#xD;
    "Planowane/Zrealizowane" = zz, Rejestr = rachunek,"Rejestr Akronim" = rachAkronim, "Rejestr Symbol" = rachSymbol, "Kategoria Szczegółowa" = kat, "Kategoria Ogólna" = kat2, "Podmiot Pierwotny Województwo" = woj, &#xD;
    "Podmiot Pierwotny Miasto" = miasto,&#xD;
    "Podmiot Pierwotny Kraj" = kraj,&#xD;
    "Podmiot Pierwotny NIP" = nip,&#xD;
    [Podmiot Nazwa],&#xD;
    [Podmiot Kod],&#xD;
    [Podmiot Województwo], [Podmiot Miasto], [Podmiot Kraj], [Podmiot NIP],&#xD;
    [Podmiot Grupa],  [Podmiot Kategoria], [Podmiot Opiekun], [Podmiot Status],&#xD;
    [Podmiot Rodzaj], [Podmiot Typ],&#xD;
    zakladSymbol as [Zakład Symbol],&#xD;
    zakladNazwa as [Zakład Nazwa Firmy],&#xD;
    opewkod as [Operator Wystawiający Kod],&#xD;
    opewnazwa as [Operator Wystawiający Nazwa],&#xD;
    "Stan" = stan, "Data Operacji Dzień" = data, "Data Dokumentu Dzień" = dataD, "Data Rozliczenia Dzień" = dataRO, &#xD;
    "Data Realizacji Dzień" = dataRE, "Data Termin Płatności Dzień" = dataT, "Data Operacji Miesiąc" = miesiac, "Data Operacji Kwartał" = kwartal, &#xD;
    "Data Operacji Rok" = rok, "Data Operacji Tydzień Roku" = tr, "Termin Zapadalności" = termin, "Liczba Dni Przeterminowania" = liczbaDniP,&#xD;
    "Przychód" = przychod, "Rozchód" = rozchod, "Przychód Waluta" = przychodWal, "Rozchód Waluta" = rozchodWal, Saldo = ISNULL(przychod,0) - ISNULL(rozchod,0), "Saldo Waluta" = ISNULL(przychodWal,0) - ISNULL(rozchodWal,0),&#xD;
    "Przychód Nierozliczony" = przychodNRoz, "Rozchód Nierozliczony" = rozchodNRoz, "Saldo Nierozliczone" = ISNULL(przychodNRoz,0) - ISNULL(rozchodNroz,0),&#xD;
    "Przychód Nierozliczony Waluta" = przychodNRozWal, "Rozchód Nierozliczony Waluta" = rozchodNrozWal, "Saldo Nierozliczone Waluta" = ISNULL(przychodNRozWal,0) - ISNULL(rozchodNrozWal,0),&#xD;
    zalOpe as [Operator Wprowadzający], modOpe as [Operator Modyfikujący],&#xD;
    "Data Analizy" = GETDATE()&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,nr_procid [Dokument Numer __PROCID__Platnosci__], nr_orgid [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,kon_procid [Podmiot Pierwotny Nazwa __PROCID__], kon_orgid [Podmiot Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Nazwa __DATABASE__]&#xD;
    ,kon_procid [Podmiot Pierwotny Kod __PROCID__], kon_orgid [Podmiot Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Pierwotny Kod __DATABASE__]&#xD;
    ,[Podmiot Nazwa __PROCID__],  [Podmiot Nazwa __ORGID__],'''+@bazaFirmowa+''' [Podmiot Nazwa __DATABASE__]&#xD;
    ,[Podmiot Kod __PROCID__Kontrahenci__],  [Podmiot Kod __ORGID__],'''+@bazaFirmowa+''' [Podmiot Kod __DATABASE__]&#xD;
&#xD;
    ' + @atrybuty2 + @atrybutyDok2 + '&#xD;
FROM&#xD;
( SELECT&#xD;
bf = BAZ.Baz_Nazwa,&#xD;
nr = BZp_Numer,&#xD;
zap = ''Zapisy'',&#xD;
&#xD;
nrpon = ''(BRAK)'',&#xD;
datpon = ''(BRAK)'',&#xD;
&#xD;
sy = dd.DDf_Symbol,&#xD;
op = ISNULL(NULLIF(BZp_Opis,''''),''(BRAK)''),&#xD;
nrPelny =  BZp_NumerPelny ,&#xD;
nr_procid = 23008, nr_orgid = BZp_BZpID,&#xD;
    CASE &#xD;
    WHEN BZp_NumerPelny &lt;&gt; '''' THEN &#xD;
      CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(BZp_NumerPelny,0,CHARINDEX(''/'',BZp_NumerPelny,0))&#xD;
      ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(BZp_NumerPelny,CHARINDEX(''/'',BZp_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
      END&#xD;
    ELSE ''(BRAK)'' &#xD;
    END as [ds], &#xD;
    mpp = BZp_SplitPay,&#xD;
&#xD;
waluta = CASE WHEN BZp_Waluta = '''' THEN @Wal ELSE BZp_Waluta END, &#xD;
sta = CASE &#xD;
    WHEN BZp_Rozliczono2=2 AND BZp_Rozliczono=2 THEN ''Zapisy Rozliczone'' &#xD;
    WHEN BZp_Rozliczono=1 THEN ''Zapisy Nierozliczone'' &#xD;
    WHEN BZp_Rozliczono2=0 AND BZp_Rozliczono=0 THEN ''Zapisy Nie podlega rozliczeniu''&#xD;
    WHEN BZp_Rozliczono2=2 AND BZp_Rozliczono=1 THEN ''Zapisy Rozliczony częściowo'' END,&#xD;
fp = CASE&#xD;
    WHEN BZp_Typ = 1 THEN ''wpłata/wypłata gotówki'' &#xD;
    WHEN BZp_Typ = 2 THEN ''przelew na konto/z konta''&#xD;
    WHEN BZp_Typ = 3 THEN ''obciążenie/uznanie karty'' END, &#xD;
raport = BRp_NumerPelny, &#xD;
boraportu = CASE &#xD;
    WHEN BRp_Zamkniety = 1 THEN BRp_SaldoBOSys &#xD;
    ELSE ISNULL((&#xD;
        SELECT TOP 1 R2.BRp_SaldoBOSys + R2.BRp_PrzychodySys - R2.BRp_RozchodySys&#xD;
        FROM CDN.BnkRaporty R2 &#xD;
        WHERE R2.BRp_Zamkniety = 1 &#xD;
            AND R1.BRp_BRaID = R2.BRp_BRaID &#xD;
            AND R2.BRp_DataZam &lt;= R1.BRp_DataDok &#xD;
        ORDER BY R2.BRp_DataZam DESC&#xD;
        ), 0) &#xD;
        +&#xD;
        ISNULL((&#xD;
        SELECT SUM(R2.BRp_PrzychodySys - R2.BRp_RozchodySys)&#xD;
        FROM CDN.BnkRaporty R2 &#xD;
        WHERE R1.BRp_BRaID = R2.BRp_BRaID &#xD;
            AND R2.BRp_DataZam &lt;= R1.BRp_DataDok&#xD;
            AND R2.BRp_DataZam &gt; (SELECT TOP 1 R3.BRp_DataZam FROM CDN.BnkRaporty R3 WHERE R3.BRp_Zamkniety = 1 AND R1.BRp_BRaID = R3.BRp_BRaID AND R3.BRp_DataZam &lt;= R1.BRp_DataDok ORDER BY R3.BRp_DataZam DESC) &#xD;
        ),0) &#xD;
    END, &#xD;
borachunku = BRa_SaldoBOSys, stanraportu = CASE WHEN BRp_Zamkniety = 0 THEN ''Otwarty'' ELSE ''Zamknięty'' END,&#xD;
data = REPLACE(CONVERT(VARCHAR(10), BZp_DataDok, 111), ''/'', ''-''), &#xD;
dataD = REPLACE(CONVERT(VARCHAR(10), BZp_DataDok, 111), ''/'', ''-''), &#xD;
dataRO = REPLACE(CONVERT(VARCHAR(10), BZp_DataRoz, 111), ''/'', ''-''), &#xD;
dataRE = REPLACE(CONVERT(VARCHAR(10), BZp_DataRoz, 111), ''/'', ''-''), &#xD;
dataT = REPLACE(CONVERT(VARCHAR(10), BZp_DataRoz, 111), ''/'', ''-''), &#xD;
miesiac = MONTH(BZp_DataDok), kwartal = DATEPART(quarter, BZp_DataDok), rok = YEAR(BZp_DataDok), tr = (datepart(DY, datediff(d, 0, BZp_DataDok) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, BZp_DataDok)*/,&#xD;
kon = CASE &#xD;
    WHEN BZp_PodmiotTyp IN (1,2,3,5) THEN pod.Pod_Nazwa1 + '' '' + pod.Pod_Nazwa2&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
kon_procid = CASE BZp_PodmiotTyp&#xD;
    WHEN 1 THEN 20201&#xD;
    WHEN 2 THEN 23002&#xD;
    WHEN 3 THEN 24001&#xD;
    WHEN 5 THEN 25005&#xD;
    ELSE 20201&#xD;
END, kon_orgid = BZp_PodmiotID,&#xD;
konKod = CASE &#xD;
    WHEN BZp_PodmiotTyp IN (1,2,3,4,5) THEN pod.Pod_Kod&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konTyp = CASE &#xD;
    WHEN BZp_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
    WHEN BZp_PodmiotTyp = 2 THEN ''Bank''&#xD;
    WHEN BZp_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
    WHEN BZp_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konRodz = CASE&#xD;
    WHEN BZp_PodmiotTyp = 2 THEN ''Bank''&#xD;
    WHEN BZp_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
    WHEN BZp_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
    WHEN BZp_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konStatus = case knt1.knt_export&#xD;
    when 0 then ''krajowy''&#xD;
    when 1 then ''pozaunijny''&#xD;
    when 2 then ''pozaunijny (zwrot VAT)''&#xD;
    when 3 then ''wewnątrzunijny''&#xD;
    when 4 then ''wewnątrzunijny trójstronny''&#xD;
    when 5 then ''podatnikiem jest nabywca''&#xD;
    when 6 then ''poza terytorium kraju''&#xD;
    when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
    when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
    when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
    ELSE ''(NIEOKREŚLONY)'' end,&#xD;
konGrupa = CASE &#xD;
    WHEN BZp_PodmiotTyp = 1 THEN COALESCE(NULLIF(pod.Pod_Grupa, ''''), ''Pozostali'')   &#xD;
    WHEN BZp_PodmiotTyp = 2 THEN ''Banki''&#xD;
    WHEN BZp_PodmiotTyp = 3 THEN ''Pracownicy/Wspólnicy''&#xD;
    WHEN BZp_PodmiotTyp = 5 THEN ''Urzędy''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konOpie = CASE &#xD;
    WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
    WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
    ELSE ''(NIEPRZYPISANE)'' END,&#xD;
termin = ''1. Terminowe'', liczbaDniP = 0,&#xD;
woj = pod.Pod_Wojewodztwo, miasto = pod.Pod_Miasto, kraj = pod.Pod_Kraj, nip = pod.Pod_NIP,&#xD;
pod5.Pod_Nazwa1 [Podmiot Nazwa], &#xD;
    20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],&#xD;
    &#xD;
    pod5.Pod_Kod [Podmiot Kod], &#xD;
    20201 [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],&#xD;
&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Podmiot Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Podmiot NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Podmiot Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Podmiot Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Podmiot Opiekun],&#xD;
    case knt3.knt_export&#xD;
    when 0 then ''krajowy''&#xD;
    when 1 then ''pozaunijny''&#xD;
    when 2 then ''pozaunijny (zwrot VAT)''&#xD;
    when 3 then ''wewnątrzunijny''&#xD;
    when 4 then ''wewnątrzunijny trójstronny''&#xD;
    when 5 then ''podatnikiem jest nabywca''&#xD;
    when 6 then ''poza terytorium kraju''&#xD;
    when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
    when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
    when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
    ELSE ''(NIEOKREŚLONY)'' end [Podmiot Status],&#xD;
    CASE &#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [Podmiot Typ],&#xD;
    CASE&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [Podmiot Rodzaj],&#xD;
    &#xD;
stan = ''Nie dotyczy'',&#xD;
zz = ''Zrealizowane'', rachunek = BRa_Nazwa, rachAkronim = BRa_Akronim, rachSymbol= BRa_Symbol, kat = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), kat2 = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''),&#xD;
zakladSymbol = isnull(Zak_Symbol,''(NIEPRZYPISANY)''), &#xD;
zakladNazwa = isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)''), &#xD;
przychod = CASE WHEN BZp_Kierunek &gt; 0 THEN BZp_KwotaSys ELSE NULL END, rozchod = CASE WHEN BZp_Kierunek &lt; 0 THEN BZp_KwotaSys ELSE NULL END,&#xD;
przychodWal = CASE WHEN BZp_Kierunek &gt; 0 THEN BZp_Kwota ELSE NULL END, rozchodWal = CASE WHEN BZp_Kierunek &lt; 0 THEN BZp_Kwota ELSE NULL END,&#xD;
przychodNRoz = CASE WHEN BZp_Kierunek &gt; 0 THEN BZp_KwotaSys-BZp_KwotaRozSys ELSE NULL END, rozchodNroz = CASE WHEN BZp_Kierunek &lt; 0 THEN BZp_KwotaSys-BZp_KwotaRozSys ELSE NULL END,&#xD;
przychodNRozWal = CASE WHEN BZp_Kierunek &gt; 0 THEN BZp_Kwota-BZp_KwotaRoz ELSE NULL END, rozchodNrozWal = CASE WHEN BZp_Kierunek &lt; 0 THEN BZp_Kwota-BZp_KwotaRoz ELSE NULL END,&#xD;
borachunekwal = BRa_SaldoBO,&#xD;
bowaluta = CASE WHEN Bra_Waluta = '''' THEN @Wal ELSE Bra_Waluta END,&#xD;
opewkod = ISNULL(ow.Ope_Kod, ''ID:''+CAST(Bzp_OpeZalId as VARCHAR)),&#xD;
opewnazwa = ISNULL(ow.Ope_Nazwisko, ''ID:''+CAST(Bzp_OpeZalId as VARCHAR)),&#xD;
zalope = zal.Ope_Kod,&#xD;
modope = mod.Ope_Kod&#xD;
,'''+@OPERATOR+''' as [Operator] &#xD;
' + @atrybuty + @atrybutyDok + '&#xD;
FROM&#xD;
cdn.BnkZapisy&#xD;
LEFT JOIN #tmpSeria ser ON BZp_DDfId = DDf_DDfID&#xD;
LEFT JOIN CDN.DokDefinicje dd ON BZp_DDfId = dd.DDf_DDfID&#xD;
LEFT JOIN CDN.BnkRachunki ON BZp_BRaID = BRa_BRaID &#xD;
LEFT JOIN CDN.BnkRachZakazy ON BRZ_BRaID = BRa_BRaID and BRZ_OpeID = (select ope_opeid from ' +@Operatorzy +' where ope_kod = '''+@OPERATOR+''') &#xD;
LEFT JOIN CDN.BnkRaporty R1 ON BZp_BRpID = R1.BRp_BRpID AND ISNULL(BRZ_RapP,0) = 0&#xD;
LEFT JOIN CDN.PodmiotyView pod ON BZp_PodmiotID = pod.Pod_PodId AND BZp_PodmiotTyp = pod.Pod_PodmiotTyp&#xD;
LEFT JOIN CDN.Kategorie kat1 ON BZp_KatID = kat1.Kat_KatID&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON pod.Pod_PodId = KonAtr.KnA_PodmiotId AND pod.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpDokAtr DokAtr ON 0  = 1&#xD;
LEFT JOIN CDN.Kontrahenci knt1 ON BZp_PodmiotID=knt1.Knt_KntId AND BZp_PodmiotTyp = 1&#xD;
LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8&#xD;
LEFT JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod.Pod_GlID = pod5.Pod_PodId and pod.Pod_GlKod = pod5.Pod_Kod&#xD;
LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = BZp_ZakID&#xD;
LEFT JOIN ' + @Operatorzy + ' ow on ow.Ope_OpeId = BZp_OpeZalId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON knt1.Knt_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON knt1.Knt_OpeModID = mod.Ope_OpeId&#xD;
&#xD;
WHERE ISNULL(BRZ_RachL,0) = 0 AND ISNULL(BRZ_RachP,0) = 0 AND ISNULL(BRZ_RapP,0) = 0 AND ISNULL(BRZ_ZapP,0) = 0&#xD;
&#xD;
UNION ALL &#xD;
&#xD;
SELECT&#xD;
bf = BAZ.Baz_Nazwa,&#xD;
nr = BZd_Numer,  -- Zdarzenia&#xD;
zap = ''Zdarzenia'',&#xD;
&#xD;
nrpon = ISNULL(pnr,''(BRAK)''),&#xD;
datpon = ISNULL(REPLACE(CONVERT(VARCHAR(10), pdat, 111), ''/'', ''-''),''(BRAK)''),&#xD;
&#xD;
sy = dd.DDf_Symbol,&#xD;
op = ISNULL(NULLIF(BZd_Opis,''''),''(BRAK)''),&#xD;
nrPelny =  BZd_NumerPelny ,&#xD;
nr_procid = 23014, nr_orgid = BZd_BZdID,&#xD;
 &#xD;
        CASE &#xD;
        WHEN BZd_NumerPelny &lt;&gt; '''' THEN &#xD;
         CASE when isnull(ser.seria,0) = 5 then &#xD;
           substring(BZd_NumerPelny,0,CHARINDEX(''/'',BZd_NumerPelny,0))&#xD;
         ELSE &#xD;
           ISNULL(PARSENAME(REPLACE(substring(BZd_NumerPelny,CHARINDEX(''/'',BZd_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
         END&#xD;
         ELSE ''(BRAK)'' &#xD;
         END as [ds], &#xD;
&#xD;
mpp = BZd_SplitPay,&#xD;
waluta = CASE WHEN BZd_Waluta = '''' THEN @Wal ELSE BZd_Waluta END, &#xD;
sta = CASE&#xD;
    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=1 THEN ''Zdarzenia Nierozliczone''&#xD;
    WHEN BZd_Rozliczono=2 THEN ''Zdarzenia Rozliczone''&#xD;
    WHEN BZd_Rozliczono=1 AND BZd_Rozliczono2=2 THEN ''Zdarzenia Częściowo rozliczone''&#xD;
    WHEN BZd_Rozliczono=0 AND BZd_Rozliczono2=0 THEN ''Zdarzenia Nie podlega rozliczeniu'' &#xD;
    WHEN BZd_Rozliczono=2 AND BZd_Rozliczono2=2 THEN ''Zdarzenia w rozliczeniu całości'' END,&#xD;
fp = FPl_Nazwa, raport = ''Nie dotyczy'', boraportu = NULL, borachunku = BRa_SaldoBOSys, stanraportu = ''Nie dotyczy'',&#xD;
data = REPLACE(CONVERT(VARCHAR(10), BZd_DataReal, 111), ''/'', ''-''), &#xD;
dataD = REPLACE(CONVERT(VARCHAR(10), BZd_DataDok, 111), ''/'', ''-''), &#xD;
dataRO = REPLACE(CONVERT(VARCHAR(10), BZd_DataRoz, 111), ''/'', ''-''), &#xD;
dataRE = REPLACE(CONVERT(VARCHAR(10), BZd_DataReal, 111), ''/'', ''-''), &#xD;
dataT = REPLACE(CONVERT(VARCHAR(10), BZd_Termin, 111), ''/'', ''-''), &#xD;
miesiac = MONTH(BZd_DataReal), kwartal = DATEPART(quarter, BZd_DataReal), rok = YEAR(BZd_DataReal), tr = (datepart(DY, datediff(d, 0, BZd_DataReal) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, BZd_DataReal)*/,&#xD;
kon = CASE &#xD;
    WHEN BZd_PodmiotTyp  IN (1,2,3,5) THEN pod.Pod_Nazwa1 + '' '' + pod.Pod_Nazwa2&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
kon_procid = CASE BZd_PodmiotTyp&#xD;
    WHEN 1 THEN 20201&#xD;
    WHEN 2 THEN 23002&#xD;
    WHEN 3 THEN 24001&#xD;
    WHEN 5 THEN 25005&#xD;
    ELSE 20201&#xD;
END, kon_orgid = BZd_PodmiotID,&#xD;
konKod = CASE &#xD;
    WHEN BZd_PodmiotTyp IN (1,2,3,4,5) THEN pod.Pod_Kod&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konTyp = CASE &#xD;
    WHEN BZd_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
    WHEN BZd_PodmiotTyp = 2 THEN ''Bank''&#xD;
    WHEN BZd_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
    WHEN BZd_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konRodz = CASE&#xD;
    WHEN BZd_PodmiotTyp = 2 THEN ''Bank''&#xD;
    WHEN BZd_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
    WHEN BZd_PodmiotTyp = 5 THEN ''Urząd''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
    WHEN BZd_PodmiotTyp = 1 AND knt1.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konStatus = case knt1.knt_export&#xD;
    when 0 then ''krajowy''&#xD;
    when 1 then ''pozaunijny''&#xD;
    when 2 then ''pozaunijny (zwrot VAT)''&#xD;
    when 3 then ''wewnątrzunijny''&#xD;
    when 4 then ''wewnątrzunijny trójstronny''&#xD;
    when 5 then ''podatnikiem jest nabywca''&#xD;
    when 6 then ''poza terytorium kraju''&#xD;
    when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
    when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
    when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
    ELSE ''(NIEOKREŚLONY)'' end,&#xD;
konGrupa = CASE &#xD;
    WHEN BZd_PodmiotTyp = 1 THEN COALESCE(NULLIF(pod.Pod_Grupa, ''''), ''Pozostali'')   &#xD;
    WHEN BZd_PodmiotTyp = 2 THEN ''Banki''&#xD;
    WHEN BZd_PodmiotTyp = 3 THEN ''Pracownicy/Wspólnicy''&#xD;
    WHEN BZd_PodmiotTyp = 5 THEN ''Urzędy''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
konOpie = CASE &#xD;
    WHEN knt1.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
    WHEN knt1.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
    ELSE ''(NIEPRZYPISANE)'' END,&#xD;
termin = CASE&#xD;
WHEN BZd_Rozliczono=1 THEN (CASE&#xD;
    WHEN DATEDIFF(day, BZd_Termin, GETDATE()) &lt; 1 THEN ''1. Terminowe''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, GETDATE()) BETWEEN 1 AND 5 THEN ''2. Przeterminowane nie więcej niż 5 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, GETDATE()) BETWEEN 6 AND 30 THEN ''3. Przeterminowane od 6 do 30 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, GETDATE()) BETWEEN 31 AND 60 THEN ''4. Przeterminowane od 31 do 60 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, GETDATE()) BETWEEN 61 AND 120 THEN ''5. Przeterminowane od 60 do 120 dni''&#xD;
    ELSE ''6. Przeterminowane powyżej 120 dni'' END)&#xD;
WHEN BZd_Rozliczono=2 THEN (CASE &#xD;
    WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) &lt; 1 THEN ''1. Terminowe''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) BETWEEN 1 AND 5 THEN ''2. Przeterminowane nie więcej niż 5 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) BETWEEN 6 AND 30 THEN ''3. Przeterminowane od 6 do 30 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) BETWEEN 31 AND 60 THEN ''4. Przeterminowane od 31 do 60 dni''&#xD;
    WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) BETWEEN 61 AND 120 THEN ''5. Przeterminowane od 60 do 120 dni''&#xD;
    ELSE ''6. Przeterminowane powyżej 120 dni'' END)&#xD;
END,&#xD;
liczbaDniP = CASE&#xD;
    WHEN BZd_Rozliczono=1 THEN CASE WHEN DATEDIFF(day, BZd_Termin, GETDATE()) &lt; 0 THEN 0 ELSE DATEDIFF(day, BZd_Termin, GETDATE()) END&#xD;
    WHEN BZd_Rozliczono=2 THEN CASE WHEN DATEDIFF(day, BZd_Termin, BZd_DataRoz) &lt; 0 THEN 0 ELSE DATEDIFF(day, BZd_Termin, BZd_DataRoz) END&#xD;
    ELSE 0 END,&#xD;
woj = pod.Pod_Wojewodztwo, miasto = pod.Pod_Miasto, kraj = pod.Pod_Kraj, nip = pod.Pod_NIP,     &#xD;
pod5.Pod_Nazwa1 [Podmiot Nazwa], &#xD;
    20201 [Podmiot Nazwa __PROCID__], pod5.Pod_PodId [Podmiot Nazwa __ORGID__],&#xD;
    &#xD;
    pod5.Pod_Kod [Podmiot Kod], &#xD;
    20201 [Podmiot Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Podmiot Kod __ORGID__],&#xD;
&#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Podmiot Województwo], ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Podmiot Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Podmiot Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Podmiot NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Podmiot Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Podmiot Kategoria],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Podmiot Opiekun],&#xD;
    case knt3.knt_export&#xD;
    when 0 then ''krajowy''&#xD;
    when 1 then ''pozaunijny''&#xD;
    when 2 then ''pozaunijny (zwrot VAT)''&#xD;
    when 3 then ''wewnątrzunijny''&#xD;
    when 4 then ''wewnątrzunijny trójstronny''&#xD;
    when 5 then ''podatnikiem jest nabywca''&#xD;
    when 6 then ''poza terytorium kraju''&#xD;
    when 7 then ''poza terytorium kraju (stawka NP)''&#xD;
    when 8 then ''wewnątrzunijny - podatnikiem jest nabywca''&#xD;
    when 9 then ''pozaunijny- podatnikiem jest nabywca''&#xD;
    ELSE ''(NIEOKREŚLONY)'' end [Podmiot Status],&#xD;
&#xD;
    CASE &#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 THEN ''Kontrahent''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [Podmiot Typ],&#xD;
    CASE&#xD;
            WHEN pod5.Pod_PodmiotTyp = 2 THEN ''Bank''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 3 THEN ''Pracownik/Wspólnik''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 5 THEN ''Urząd''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca/Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Dostawca = 1 THEN ''Dostawca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Odbiorca = 1 THEN ''Odbiorca''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Konkurencja = 1 THEN ''Konkurencja''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Partner = 1 THEN ''Partner''&#xD;
            WHEN pod5.Pod_PodmiotTyp = 1 AND knt3.Knt_Rodzaj_Potencjalny = 1 THEN ''Klient Potencjalny''&#xD;
            ELSE ''(NIEOKREŚLONY)'' &#xD;
        END [Podmiot Rodzaj],&#xD;
stan = CASE&#xD;
    WHEN BZd_Stan = 0 THEN ''Bufor''&#xD;
    WHEN BZd_Stan = 1 THEN ''Do realizacji''&#xD;
    WHEN BZd_Stan = 2 THEN ''Wysłane''&#xD;
    WHEN BZd_Stan = 3 THEN ''Zrealizowane''&#xD;
    ELSE ''(NIEOKREŚLONY)'' END,&#xD;
zz = ''Planowane'', rachunek = BRa_Nazwa, rachAkronim = BRa_Akronim, rachSymbol= BRa_Symbol, kat = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), kat2 = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''),&#xD;
zakladSymbol = ''(NIEPRZYPISANY)'', &#xD;
zakladNazwa = ''(NIEPRZYPISANY)'', &#xD;
przychod = CASE WHEN BZd_Kierunek &gt; 0 THEN BZd_KwotaSys ELSE NULL END, rozchod = CASE WHEN BZd_Kierunek &lt; 0 THEN BZd_KwotaSys ELSE NULL END,&#xD;
przychodWal = CASE WHEN BZd_Kierunek &gt; 0 THEN BZd_Kwota ELSE NULL END, rozchodWal = CASE WHEN BZd_Kierunek &lt; 0 THEN BZd_Kwota ELSE NULL END,&#xD;
przychodNRoz = CASE WHEN BZd_Kierunek &gt; 0 &#xD;
                    THEN CASE WHEN (BZd_KwotaSys-BZd_KwotaRozSys) = 0 &#xD;
                              THEN NULL &#xD;
                              ELSE BZd_KwotaSys-BZd_KwotaRozSys END &#xD;
                    ELSE NULL END, &#xD;
rozchodNRoz = CASE WHEN BZd_Kierunek &lt; 0 &#xD;
                    THEN CASE WHEN (BZd_KwotaSys-BZd_KwotaRozSys) = 0 &#xD;
                              THEN NULL &#xD;
                              ELSE BZd_KwotaSys-BZd_KwotaRozSys END &#xD;
                    ELSE NULL END, &#xD;
przychodNRozWal = CASE WHEN BZd_Kierunek &gt; 0&#xD;
                    THEN CASE WHEN (BZd_Kwota-BZd_KwotaRoz) = 0 &#xD;
                              THEN NULL &#xD;
                              ELSE BZd_Kwota-BZd_KwotaRoz END &#xD;
                    ELSE NULL END, &#xD;
rozchodNRozWal = CASE WHEN BZd_Kierunek &lt; 0 &#xD;
                    THEN CASE WHEN (BZd_Kwota-BZd_KwotaRoz) = 0 &#xD;
                              THEN NULL &#xD;
                              ELSE BZd_Kwota-BZd_KwotaRoz END &#xD;
                    ELSE NULL END ,&#xD;
borachunekwal = BRa_SaldoBO,&#xD;
bowaluta = CASE WHEN Bra_Waluta = '''' THEN @Wal ELSE Bra_Waluta END,&#xD;
opewkod = ISNULL(ow.Ope_Kod, ''ID:''+CAST(Bzd_OpeZalId as VARCHAR)),&#xD;
opewnazwa = ISNULL(ow.Ope_Nazwisko, ''ID:''+CAST(Bzd_OpeZalId as VARCHAR)),&#xD;
zalope = zal.Ope_Kod,&#xD;
modope = mod.Ope_Kod&#xD;
,'''+@OPERATOR+''' as [Operator] &#xD;
' + @atrybuty + @atrybutyDok + '&#xD;
FROM&#xD;
cdn.BnkZdarzenia&#xD;
LEFT JOIN #tmpSeria ser ON BZd_DDfId = DDf_DDfID&#xD;
LEFT JOIN CDN.DokDefinicje dd ON BZd_DDfId = dd.DDf_DDfID&#xD;
LEFT JOIN CDN.BnkRachunki ON BZd_BRaID = BRa_BRaID&#xD;
LEFT JOIN CDN.BnkRachZakazy ON BRZ_BRaID = BRa_BRaID and BRZ_OpeID = (select ope_opeid from ' +@Operatorzy +' where ope_kod = '''+@OPERATOR+''') &#xD;
LEFT JOIN CDN.PodmiotyView pod ON BZd_PodmiotID = pod.Pod_PodId AND BZd_PodmiotTyp = pod.Pod_PodmiotTyp&#xD;
LEFT JOIN CDN.Kategorie kat1 ON BZd_KatID = kat1.Kat_KatID&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON pod.Pod_PodId = KonAtr.KnA_PodmiotId AND pod.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpDokAtr DokAtr ON BZd_DokumentID  = DokAtr.DAt_TrNId AND BZd_DokumentTyp = 1&#xD;
LEFT JOIN CDN.Kontrahenci knt1 ON BZd_PodmiotID=knt1.Knt_KntId AND BZd_PodmiotTyp = 1&#xD;
LEFT JOIN ' + @Operatorzy + ' opk ON knt1.Knt_OpiekunId = opk.Ope_OpeId AND knt1.Knt_OpiekunTyp = 8&#xD;
LEFT JOIN cdn.PodmiotyView pod2 ON knt1.Knt_OpiekunId = pod2.Pod_PodId AND knt1.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
LEFT JOIN CDN.FormyPlatnosci ON BZd_FPlId = FPl_FPlId&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod.Pod_GlID = pod5.Pod_PodId and pod.Pod_GlKod = pod5.Pod_Kod&#xD;
LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
LEFT JOIN ' + @Operatorzy + ' ow on ow.Ope_OpeId = BZd_OpeZalId&#xD;
LEFT JOIN&#xD;
(&#xD;
SELECT&#xD;
BDE_DokId pzr,&#xD;
MAX(BDN_NumerPelny) pnr,&#xD;
MAX(BDN_DataDok) pdat&#xD;
FROM&#xD;
CDN.BnkDokElem &#xD;
JOIN CDN.BnkDokNag ON BDE_BDNId = BDN_BDNId AND BDN_Typ = 222 &#xD;
GROUP BY BDE_DokId&#xD;
) pon on pzr = BZd_DokumentID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON knt1.Knt_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON knt1.Knt_OpeModID = mod.Ope_OpeId&#xD;
&#xD;
WHERE ISNULL(BRZ_RachL,0) = 0 AND ISNULL(BRZ_RachP,0) = 0  AND ISNULL(BRZ_ZdarzP,0) = 0&#xD;
&#xD;
) AS Kalendar'&#xD;
&#xD;
PRINT(@select)&#xD;
EXEC(@select)&#xD;
&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpSeria&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poZe0oxEwN0CSY7nRmMTrPV8Fnw8HT+vqK3eR3OvkTQcsJA1x2nrPoHsEnFqBFf/iUlibA8hv0Js0mW5SR93Dlte/ynCuAxJKYDTovoQSnld/</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="BO Rachunku Waluta" caption="BO Rachunku Waluta" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Waluta BO" caption="Waluta BO" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer Pełny" caption="Dokument Numer Pełny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Status" caption="Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Raport KB" caption="Raport KB" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="BO Raportu" caption="BO Raportu" type="measure" formatString="c2" aggregate="Max" /&gt;&#xD;
    &lt;column name="BO Rachunku" caption="BO Rachunku" type="measure" formatString="c2" aggregate="Max" /&gt;&#xD;
    &lt;column name="Raport KB Stan" caption="Raport KB Stan" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Ponaglenia Numer" caption="Dokument Ponaglenia Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Ponaglenia Data Wystawienia" caption="Dokument Ponaglenia Data Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Nazwa" caption="Podmiot Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kod" caption="Podmiot Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Typ" caption="Podmiot Pierwotny Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Rodzaj" caption="Podmiot Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Status" caption="Podmiot Pierwotny Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Grupa" caption="Podmiot Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Opiekun" caption="Podmiot Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Planowane/Zrealizowane" caption="Planowane/Zrealizowane" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rejestr" caption="Rejestr" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Rejestr Akronim" caption="Rejestr Akronim" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rejestr Symbol" caption="Rejestr Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa" caption="Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna" caption="Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Województwo" caption="Podmiot Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Miasto" caption="Podmiot Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kraj" caption="Podmiot Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny NIP" caption="Podmiot Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Województwo" caption="Podmiot Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Miasto" caption="Podmiot Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kraj" caption="Podmiot Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot NIP" caption="Podmiot NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Grupa" caption="Podmiot Grupa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Kategoria" caption="Podmiot Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Opiekun" caption="Podmiot Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Status" caption="Podmiot Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Rodzaj" caption="Podmiot Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Stan" caption="Stan" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Dzień" caption="Data Dokumentu Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Dzień" caption="Data Rozliczenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Dzień" caption="Data Realizacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Dzień" caption="Data Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Termin Zapadalności" caption="Termin Zapadalności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania" caption="Liczba Dni Przeterminowania" type="measure" formatString="n0" aggregate="Average" /&gt;&#xD;
    &lt;column name="Przychód" caption="Przychód" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód" caption="Rozchód" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód Waluta" caption="Przychód Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód Waluta" caption="Rozchód Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo" caption="Saldo" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Waluta" caption="Saldo Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód Nierozliczony" caption="Przychód Nierozliczony" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód Nierozliczony" caption="Rozchód Nierozliczony" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Nierozliczone" caption="Saldo Nierozliczone" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód Nierozliczony Waluta" caption="Przychód Nierozliczony Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód Nierozliczony Waluta" caption="Rozchód Nierozliczony Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Nierozliczone Waluta" caption="Saldo Nierozliczone Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Atrybut WARUNKI DOSTAWY" caption="Podmiot Pierwotny Atrybut WARUNKI DOSTAWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Atrybut WARUNKI DOSTAWY" caption="Podmiot Atrybut WARUNKI DOSTAWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Atrybut KONTRAHENT TYP" caption="Podmiot Pierwotny Atrybut KONTRAHENT TYP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Atrybut KONTRAHENT TYP" caption="Podmiot Atrybut KONTRAHENT TYP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 2.WARUNKI DOSTAWY" caption="Dokument Atrybut 2.WARUNKI DOSTAWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut WARUNKI DOSTAWY (K)" caption="Dokument Atrybut WARUNKI DOSTAWY (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut RODZAJ KLIENTA" caption="Dokument Atrybut RODZAJ KLIENTA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DATA W" caption="Dokument Atrybut DATA W" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut KONTRAHENT TYP (K)" caption="Dokument Atrybut KONTRAHENT TYP (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut TRANSPORT" caption="Dokument Atrybut TRANSPORT" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 1" caption="Dokument Atrybut 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 2" caption="Dokument Atrybut 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 3" caption="Dokument Atrybut 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 4" caption="Dokument Atrybut 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 5" caption="Dokument Atrybut 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut 6" caption="Dokument Atrybut 6" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;OPERATOR&lt;/Name&gt;&#xD;
    &lt;Label&gt;Operator&lt;/Label&gt;&#xD;
    &lt;Expression /&gt;&#xD;
    &lt;Type&gt;Operator&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Operator&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;admin&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Płatności z Zakazami Dostępu wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport zawiera informacje o wszystkich płatnościach zrealizowanych i planowanych w firmie. Wartości prezentowane są w walucie systemowej oraz walucie dokumentu.&#xD;
W raporcie uwzględnione zostały zakazy dostępu do rachunków kasowo/bankowych nadane operatorom w sytemie Comarch Optima.&#xD;
&#xD;
W analizach brane pod uwagę są wszystkie dokumenty płatności dla wszystkich rachunków. Dokumenty zrealizowane pobierane są z tabeli BnkZapisy natomiast planowane z BnkZdarzenia. Przychód, Rozchód i Saldo liczone są na podstawie wartości tabel BZp_KwotaSys i BZd_KwotaSys. Przychód Niezrealizowany, Rozchód Niezrealizowany i Saldo Niezrealizowane liczone są na podstawie wartości tabel BZp_KwotaSys i BZd_KwotaSys pomniejszonej o wartość tabeli BZd_KwotaRozSys dla zdarzeń.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
BnkZapisy - Tabela zawiera dokumenty w postaci wyciągów bankowych oraz innych dokumentów rejestrowanych w kasach gotówkowych. &#xD;
BnkZdarzenia - Tabela zawiera zdarzenia, które mają nastąpić w przyszłości (np. zapłata za fakturę).&#xD;
BnkBnkRachZakazy - Tabela zawiera informacje dotyczące zakazów dostępu do rachunków kasowo/bankowych.</a:description><a:id>33</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>33. Raport Płatności z Zakazami Dostępu</a:mainLinkName><a:modifiedOn>2025-02-04T12:02:30.757</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2020-09-21T14:55:46.407</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Opisów Analitycznych&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SELECT Wyy_wyyid ID,isnull(wyy_nazwa,Wyy_Kod) Nazwa INTO #tmproots from cdn.Wymiary  where wyy_parentid = 0&#xD;
declare @kolumny varchar(max)&#xD;
SET @kolumny = ''&#xD;
&#xD;
;WITH g(nazwa, kod, ID,parent,RootID,aktywny, poziom, sciezka,typsl)&#xD;
AS&#xD;
(&#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,wyy_aktywny, 0 as poziom, convert(nvarchar(1024), '') as sciezka,Wyy_TypWymiaru&#xD;
      FROM cdn.Wymiary &#xD;
      WHERE Wyy_ParentID = 0&#xD;
      --and wyy_wyyid = @TableID&#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT wyy_nazwa, wyy_kod, Wyy_WyyID,Wyy_ParentID,Wyy_RootID,wyy_aktywny, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.wyy_kod) as sciezka,Wyy_TypWymiaru&#xD;
      FROM g p&#xD;
      JOIN cdn.Wymiary c&#xD;
      ON c.Wyy_ParentID = p.ID &#xD;
      WHERE c.Wyy_ParentID &lt;&gt; 0 &#xD;
)     &#xD;
SELECT  g.*,WyW_SlownikId, WyW_DokumentId, WyW_LpPozycji, WYW_GUID, WyW_DokumentTyp INTO #tmpWymiary FROM g LEFT JOIN cdn.WymiaryWartosci ON ID = WyW_WyyId&#xD;
&#xD;
&#xD;
insert into #tmpWymiary &#xD;
SELECT Coalesce(Knt_Nazwa1,Kat_KodSzczegol,Acc_Nazwa) nazwa ,Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) kod,ID-10000000,ID,RootID,aktywny,poziom + 1,sciezka +'\'+Coalesce(Knt_Kod,Kat_KodOgolny,acc_numer) sciezka,typsl,wyw_slownikid,WyW_DokumentId,WyW_LpPozycji,WyW_GUID,WyW_DokumentTyp&#xD;
FROM #tmpWymiary &#xD;
LEFT JOIN cdn.Konta on Typsl = 3 and WyW_SlownikId = acc_accid&#xD;
LEFT JOIN cdn.Kontrahenci on Typsl = 4 and WyW_SlownikId = Knt_KntId&#xD;
Left join cdn.Kategorie on Typsl = 2 and WyW_SlownikId = kat_katid&#xD;
WHERE Typsl &lt;&gt; 1 and Wyw_SlownikId &lt;&gt;0&#xD;
&#xD;
while exists (select * from #tmproots)&#xD;
begin&#xD;
declare @TableID int&#xD;
declare @TableName Varchar(100)&#xD;
&#xD;
    select top 1 @TableID = ID&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
     Select top 1 @TableName = Nazwa&#xD;
    from #tmproots&#xD;
    order by ID asc&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpWymiary&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
&#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= Parent WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
            SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ ' = kod WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N' ALTER TABLE #tmpWymiary ADD Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path Varchar(200)'&#xD;
            EXEC(@sql)&#xD;
&#xD;
			SET @sql = N'UPDATE #tmpWymiary&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '_path = sciezka WHERE RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + '= p.ID &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
            EXEC(@sql)&#xD;
&#xD;
                SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar)+'_'+CAST(@TableID AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.parent AS nvarchar)&#xD;
                    ELSE CAST(p.parent AS nvarchar) END)  &#xD;
                FROM #tmpWymiary c&#xD;
                LEFT JOIN #tmpWymiary p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) +'_'+CAST(@TableID AS nvarchar)+ '= p.id &#xD;
                WHERE p.RootID='+CAST(@TableID AS nvarchar)+'AND c.RootID='+CAST(@TableID AS nvarchar)&#xD;
                EXEC(@sql)&#xD;
&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @i int&#xD;
&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
&#xD;
    set @kolumny =CONCAT (@kolumny, ',"',@TableName,' Poziom ' , LTRIM(@i) , '" = CASE WHEN Poz.Poziom' ,LTRIM(@i) ,'_',@TableID ,' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' , LTRIM(@i)  ,'_',@TableID , ' END')&#xD;
   &#xD;
      IF (@i=@poziom_max) &#xD;
	set @kolumny =CONCAT (@kolumny, ',"',@TableName,' Kompletny ', '" = CASE WHEN Poz.Poziom' ,LTRIM(@i) ,'_',@TableID ,'_path',' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' , LTRIM(@i)  ,'_',@TableID ,'_path', ' END')&#xD;
   &#xD;
   set @i = @i + 1&#xD;
end&#xD;
    delete #tmproots&#xD;
    where ID = @TableID&#xD;
&#xD;
end&#xD;
&#xD;
DROP TABLE #tmproots&#xD;
delete from #tmpWymiary  where ID &gt; 0 and typsl &lt;&gt; 1 and WyW_SlownikId &lt;&gt; 0&#xD;
&#xD;
ALTER TABLE #tmpWymiary&#xD;
DROP COLUMN nazwa,kod,id,parent,rootID,aktywny,poziom,sciezka,Wyw_DokumentTyp,typsl,WyW_SlownikId&#xD;
ALTER TABLE #tmpWymiary&#xD;
ADD  [Ver] INT&#xD;
UPDATE #tmpWymiary SET [Ver] = 1&#xD;
&#xD;
DECLARE @ColNames VARCHAR(MAX)&#xD;
DECLARE @SQLGrouper VARCHAR(MAX) &#xD;
SELECT @ColNames = COALESCE (@ColNames + ', ', '') + 'MAX(' + name +') AS ' +name&#xD;
FROM    tempdb.sys.columns &#xD;
WHERE  object_id = Object_id('tempdb..#tmpWymiary')&#xD;
AND column_id &gt;14&#xD;
and name &lt;&gt; 'Ver'&#xD;
&#xD;
SET @SQLGrouper = 'SELECT WyW_DokumentId,WyW_LpPozycji,WYW_GUID, '+ @ColNames+' , ver+1  FROM #tmpWymiary &#xD;
GROUP BY  WYW_GUID,WyW_DokumentId,WyW_LpPozycji,ver'&#xD;
INSERT  INTO #tmpWymiary exec (@SQLGrouper)&#xD;
&#xD;
DELETE FROM #tmpWymiary WHERE [Ver] = 1&#xD;
&#xD;
declare @dokumentTypFZ int, @dokumentTypFS int&#xD;
declare @dokumentTyp int&#xD;
&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]'&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
set @dokumentTyp = 1 -- Faktury zakupu&#xD;
&#xD;
select 1 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
29047 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Faktura zakupu') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp PodmiotTyp, TrN_PodID PodmiotID&#xD;
,CAST (NULL AS VARCHAR(100)) AS Projekt&#xD;
,CAST (NULL AS VARCHAR(100)) AS Dzial&#xD;
INTO #tmpTrNWym&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and TrN_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 2 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
29047 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Faktura zakupu' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and TrN_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 2 -- Faktury sprzedazy&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 3 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Faktura sprzedaży' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,Tre_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID&#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and TrN_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 4 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
CASE WHEN TrN_TypDokumentu = 305 THEN 29048 ELSE 25004 END [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__], W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota  Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ , 'Faktura sprzedaży' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and TrN_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 19 -- Polecenie księgowania&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 5 as Paczka, CAST(DeN_Dokument AS nvarchar(260)) [Dokument Numer],   &#xD;
26002 [Dokument Numer __PROCID__], DeN_DeNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,DeE_DeNId DENID ,DeE_Lp DeELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 &#xD;
and W.WyW_SlownikId = W1.WyW_SlownikId and W.WyW_SourceType = W1.WyW_SourceType&#xD;
) IloscPozycji&#xD;
--,isnull(W.WyW_SlownikId,0) kontoID ,  W.WyW_SourceType TypS, 'Pozycja/Wartość' Typ, 'Polecenie księgowania' TypDokumentu &#xD;
,W.WyW_SlownikId kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Polecenie księgowania' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
 ,YEAR(Den_DataDok) DokumentRok ,MONTH(Den_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Den_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Den_DataOpe) PlatnoscRok,MONTH(DeN_DataOpe) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), DeN_DataOpe, 111), '/', '-')  AS PlatnoscDzien&#xD;
,DeE_Kwota AS WartoscCalk&#xD;
,DeN_PodmiotTyp, DeN_PodmiotID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.DekretyElem ON DeE_DeNId = W.WyW_DokumentId and DeE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.DekretyNag ON DeE_DeNId = DeN_DeNId AND DeE_AccWnId IS NOT NULL&#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and DeN_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTypFZ = 20 -- Rejestr vat zakupu&#xD;
set @dokumentTypFS = 21 -- Rejestr vat sprzedaży&#xD;
&#xD;
INSERT INTO #tmpTrNWym &#xD;
select 6 as Paczka, VaN_Dokument AS [Dokument Numer],&#xD;
20101 [Dokument Numer __PROCID__], VaN_VaNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
W.WyW_Wartosc WymiarWartosc,&#xD;
&#xD;
W.Wyw_wywID WYWID,Vat_VanID VaNID,VaT_Lp VatLP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp in (@dokumentTypFZ, @dokumentTypFS) and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji,&#xD;
0 KontoID,&#xD;
WyW_SourceType TypS,&#xD;
CASE WyW_SourceType&#xD;
            WHEN 1 THen 'Pozycja/Kwota dodtakowa'&#xD;
            WHEN 2 THen 'Pozycja/Netto'&#xD;
            WHEN 3 THen 'Pozycja/Koszt'&#xD;
            WHEN 4 THen 'Pozycja/VAT_KOSZT'&#xD;
            WHEN 5 THen 'Dokument/Netto'&#xD;
            WHEN 6 THen 'Dokument/Koszt'&#xD;
            WHEN 7 THen 'Dokument/VAT_Koszt'&#xD;
       END [Typ ]&#xD;
, CASE W.WyW_DokumentTyp&#xD;
           WHEN 20 THEN 'Rejestr vat zakupu'&#xD;
           WHEN 21 THEN 'Rejestr vat sprzedaży'&#xD;
    END TypDokumentu&#xD;
    , W.WyW_DokumentTyp DokumentTyp&#xD;
    ,YEAR(VaN_DataWys) DokumentRok ,MONTH(VaN_DataWys) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), VaN_DataWys, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(VaN_Termin) PlatnoscRok,MONTH(VaN_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), VaN_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,Vat_netto + Vat_vat AS WartoscCalk&#xD;
    ,Van_PodmiotTyp, VaN_PodID&#xD;
    ,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.VatTab ON Vat_VanID = W.WyW_DokumentId and VaT_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.VatNag ON VaN_VaNID = VaT_VaNID&#xD;
where W.WyW_DokumentTyp in (@dokumentTypFZ, @dokumentTypFS) and W.WyW_WyyId = 0 and WyW_SourceType in (2,3,4)&#xD;
and VaN_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
union all&#xD;
&#xD;
select 6 as Paczka, CAST(VaN_Dokument AS nvarchar(260)) AS [Dokument Numer],&#xD;
20101 [Dokument Numer __PROCID__], VaN_VaNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
W.WyW_Wartosc WymiarWartosc,&#xD;
&#xD;
W.Wyw_wywID WYWID,&#xD;
VaN_VanID VaNID,0 VatLP, &#xD;
W.WyW_Kwota / ISNULL((select count(*) FROM cdn.VatTab W1 where VaT_VaNID = VaN_VaNID),1.0) Kwota, W.wyw_procent / ISNULL((select count(*) FROM cdn.VatTab W1 where VaT_VaNID = VaN_VaNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W2 where W2.WyW_DokumentTyp in (@dokumentTypFZ, @dokumentTypFS) and W2.WyW_DokumentId = W.WyW_DokumentId and W2.WyW_LpPozycji = W.WyW_LpPozycji and W2.WyW_WyyId = 0 ) IloscPozycji,&#xD;
0 KontoID,WyW_SourceType TypS,&#xD;
CASE WyW_SourceType&#xD;
            WHEN 1 THen 'Pozycja/Kwota dodatkowa'&#xD;
            WHEN 2 THen 'Pozycja/Netto'&#xD;
            WHEN 3 THen 'Pozycja/Koszt'&#xD;
            WHEN 4 THen 'Pozycja/VAT_KOSZT'&#xD;
            WHEN 5 THen 'Dokument/Netto'&#xD;
            WHEN 6 THen 'Dokument/Koszt'&#xD;
            WHEN 7 THen 'Dokument/VAT_Koszt'&#xD;
       END [Typ ]&#xD;
       , CASE W.WyW_DokumentTyp&#xD;
           WHEN 20 THEN 'Rejestr vat zakupu'&#xD;
           WHEN 21 THEN 'Rejestr vat sprzedaży'&#xD;
    END TypDokumentu&#xD;
    , W.WyW_DokumentTyp DokumentTyp&#xD;
    ,YEAR(VaN_DataWys) DokumentRok ,MONTH(VaN_DataWys) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), VaN_DataWys, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(VaN_Termin) PlatnoscRok,MONTH(VaN_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), VaN_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,VaN_RazemBrutto AS WartoscCalk&#xD;
    ,Van_PodmiotTyp, Van_PodID&#xD;
    ,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.VatNag ON VaN_VanID = W.WyW_DokumentId&#xD;
where W.WyW_DokumentTyp in (@dokumentTypFZ, @dokumentTypFS) and W.WyW_WyyId = 0 and WyW_SourceType in (5,6,7)&#xD;
and not exists (select * from cdn.WymiaryWartosci W2 where W2.WyW_DokumentTyp in (@dokumentTypFZ, @dokumentTypFS) and W2.WyW_DokumentId =  W.WyW_DokumentId and W2.WyW_WyyId = 0 and W2.WyW_LpPozycji&lt;&gt;0)&#xD;
and VaN_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
--2019------------------------------------------------------------------------------------------------------------------------------&#xD;
&#xD;
set @dokumentTyp = 3 -- Dokumenty wewnętrzne zakupu --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 7 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
29121 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Dokument wewnętrzny zakupu') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 8 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
29121 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Dokument wewnętrzny zakupu' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 4 -- Dokumenty wewnętrzne sprzedaży --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 9 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
29120 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Dokument wewnętrzny sprzedaży') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 10 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
29120 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Dokument wewnętrzny sprzedaży' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 5 -- Dokumenty TaxFree --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 11 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
29159 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Dokument TaxFree') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 12 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
29159 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Dokument TaxFree' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 6 -- Paragony --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 13 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
29048 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Paragon') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 14 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
29048 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Paragon' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 9 -- Przesunięcia międzymagazynowe --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 15 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25034 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Przesunięcie międzymagazynowe') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 16 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25034 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Przesunięcie międzymagazynowe' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 11 -- Przyjęcie wewnętrzne --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 17 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25032 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Przyjęcie wewnętrzne') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 18 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25032 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Przyjęcie wewnętrzne' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 12 -- Przyjęcie zewnętrzne --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 19 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25024 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Przyjęcie zewnętrzne') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 20 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25024 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Przyjęcie zewnętrzne' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 13 -- Rozchód wewnętrzny --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 21 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25030 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Rozchód wewnętrzny') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 22 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25030 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Rozchód wewnętrzny' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 14 -- Wydanie kaucji --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 23 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25078 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Wydanie kaucji') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 24 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25078 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Wydanie kaucji' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 15 -- Wydanie zewnętrzne --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 25 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25022 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Wydanie zewnętrzne') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 26 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25022 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Wydanie zewnętrzne' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 10 -- Przyjęcie kaucji --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 28 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25079 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Przyjęcie kaucji') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 29 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25079 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Przyjęcie kaucji' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 7 -- Kompletacja przyjęcie składników --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 30 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25045 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Kompletacja przyjęcie składników') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 31 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25045 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Kompletacja przyjęcie składników' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 8 -- Kompletacja rozchód składników --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 32 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer],&#xD;
25046 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrE_TrNID TRNID,TrE_Lp TRELP, W.WyW_Kwota Kwota, W.wyw_procent  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.WymiaryWartosci W1 where W1.WyW_DokumentTyp =  @dokumentTyp and W1.WyW_DokumentId = W.WyW_DokumentId and W1.WyW_LpPozycji = W.WyW_LpPozycji and W1.WyW_WyyId = 0 ) IloscPozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, &#xD;
CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, convert(varchar(100),'Kompletacja rozchód składników') TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrE_WartoscBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraElem ON TrE_TrNID = W.WyW_DokumentId and TrE_Lp = W.WyW_LpPozycji&#xD;
JOIN CDN.TRaNag on TRN_TrNID = TRE_TRNID &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 33 as Paczka, CAST(TrN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
25046 [Dokument Numer __PROCID__], TrN_TrNId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,TrN_TrNID TRNID,0 TRELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent / ISNULL((select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID),1.0)  Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.TraElem W1 where TrE_TrNId = TrN_TrNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 1 THEN convert(varchar(100),'Pozycja/Wartość')&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Kompletacja rozchód składników' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(Trn_DataDok) DokumentRok ,MONTH(Trn_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), Trn_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(Trn_Termin) PlatnoscRok,MONTH(Trn_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), Trn_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,TrN_RazemBrutto AS WartoscCalk&#xD;
,TrN_PodmiotTyp, TrN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.TraNag ON TrN_TrNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and Trn_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 16 -- Ewidencja przychodów --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 34 as Paczka, CAST(EDN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
20116 [Dokument Numer __PROCID__], EDN_EDNID [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,EDN_EDNID TRNID,0 EDELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.EwidDodElem W1 where EDE_EDNID = EDN_EDNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Ewidencja przychodów' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(EDN_DataDok) DokumentRok ,MONTH(EDN_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), EDN_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(EDN_Termin) PlatnoscRok,MONTH(EDN_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), EDN_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,EDN_KwotaRazemSys AS WartoscCalk&#xD;
,EDN_PodmiotTyp, EDN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.EwidDodNag ON EDN_EDNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and EDN_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
set @dokumentTyp = 17 -- Ewidencja kosztów --------------------------------------------------------------------------------&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 35 as Paczka, CAST(EDN_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
20116 [Dokument Numer __PROCID__], EDN_EDNID [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
 W.WyW_Wartosc WymiarWartosc,&#xD;
W.Wyw_wywID WYWID,EDN_EDNID TRNID,0 EDELP, W.WyW_Kwota Kwota ,&#xD;
W.wyw_procent Procent, W.Wyw_GUID as [GUID]&#xD;
,(select count(*) FROM cdn.EwidDodElem W1 where EDE_EDNID = EDN_EDNID) Iloscpozycji&#xD;
,0 kontoID, W.WyW_SourceType TypS, CASE W.WyW_SourceType&#xD;
 WHEN 2 THEN  convert(varchar(100),'Dokument/Wartość') &#xD;
END Typ, 'Ewidencja kosztów' TypDokumentu , W.WyW_DokumentTyp DokumentTyp&#xD;
,YEAR(EDN_DataDok) DokumentRok ,MONTH(EDN_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), EDN_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(EDN_Termin) PlatnoscRok,MONTH(EDN_Termin) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), EDN_Termin, 111), '/', '-')  AS PlatnoscDzien&#xD;
,EDN_KwotaRazemSys AS WartoscCalk&#xD;
,EDN_PodmiotTyp, EDN_PodID&#xD;
,NULL AS Projekt&#xD;
,NULL AS Dzial&#xD;
FROM cdn.WymiaryWartosci W&#xD;
JOIN CDN.EwidDodNag ON EDN_EDNID = W.WyW_DokumentId &#xD;
where W.WyW_DokumentTyp =  @dokumentTyp and W.WyW_WyyId = 0&#xD;
and W.WYW_SourceType = 2&#xD;
and EDN_DataOpe BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
--Wypłaty&#xD;
&#xD;
INSERT INTO #tmpTrNWym&#xD;
select 36 as Paczka, CAST(WPL_NumerPelny AS nvarchar(260)) [Dokument Numer], &#xD;
24020  [Dokument Numer __PROCID__], WPL_WplId [Dokument Numer __ORGID__],@bazaFirmowa [Dokument Numer __DATABASE__],&#xD;
WPE_Nazwa WymiarWartosc,&#xD;
0 WYWID,0 TRNID,0 EDELP, OPP_Brutto Kwota ,&#xD;
opp_procent Procent, 0 as [GUID]&#xD;
,1 Iloscpozycji&#xD;
,0 kontoID, NULL TypS, 'Dokument/Wartość'&#xD;
, 'Wypłata' TypDokumentu , NULL DokumentTyp&#xD;
,YEAR(WPL_DataDok) DokumentRok ,MONTH(WPL_DataDok) DokumentMiesiac,REPLACE(CONVERT(VARCHAR(10), WPL_DataDok, 111), '/', '-')  AS DokumentDzien&#xD;
,YEAR(WPL_DataDok) PlatnoscRok,MONTH(WPL_DataDok) PlatnoscMiesiac ,REPLACE(CONVERT(VARCHAR(10), WPL_DataDok, 111), '/', '-')  AS PlatnoscDzien&#xD;
,Wpe_Wartosc AS WartoscCalk&#xD;
,0, 0&#xD;
,Prj_Nazwa AS  Projekt&#xD;
,DZL_Nazwa AS  Dzial&#xD;
&#xD;
from cdn.OpisPlace JOIN cdn.WypElementy ON OPP_WpeId = WPE_WpeId&#xD;
join cdn.Wyplaty on WPL_WplId = WPE_WplId &#xD;
join cdn.DefProjekty  ON OPP_PrjId = PRJ_PrjId&#xD;
JOIN cdn.Dzialy ON OPP_DzlId = DZL_DzlId&#xD;
and WPL_DataDok BETWEEN convert(datetime,convert(varchar, @DATAOD, 120), 120)  AND convert(datetime,convert(varchar, @DATADO, 120), 120)&#xD;
&#xD;
declare @sqlTxt nvarchar(max)&#xD;
&#xD;
set @sqlTxt = N'select BAZ.Baz_Nazwa [Baza Firmowa], [Dokument Numer], WymiarWartosc as [Pozycja],Dzial AS [Dział], Projekt AS [Projekt],&#xD;
Kwota as [Wartość],Procent as [Wymiar Procent], Typ as [Typ Pozycji], TypDokumentu as [Typ Dokumentu]&#xD;
, DokumentRok as [Data Dokumentu Rok],DokumentMiesiac as [Data Dokumentu Miesiąc],DokumentMiesiac as [Data Dokumentu Dzień]&#xD;
, PlatnoscRok as [Data Termin Płatności Rok],PlatnoscMiesiac as [Data Termin Płatności Miesiąc],PlatnoscDzien as [Data Termin Płatności Dzień], &#xD;
Knt_Kod [Kontrahent Kod], Knt_Nazwa1 [Kontrahent Nazwa],zal.Ope_Kod [Operator Wprowadzający],mod.Ope_Kod [Operator Modyfikujący],GETDATE() [Data Analizy]&#xD;
 &#xD;
&#xD;
----------KONTEKSTY&#xD;
, [Dokument Numer __PROCID__], [Dokument Numer __ORGID__], [Dokument Numer __DATABASE__] &#xD;
&#xD;
'+@kolumny + '&#xD;
from #tmpTrNWym&#xD;
left join  #tmpWymiary Poz on WyW_DokumentId = TrNID  and WYW_GUID = GUID and WyW_LpPozycji =  TRELp &#xD;
left join CDN.Kontrahenci on Knt_KntId = PodmiotID and Knt_Podmiottyp = PodmiotTyp&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON Knt_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON Knt_OpeModID = mod.Ope_OpeId&#xD;
&#xD;
order by TRNID, TRELP'&#xD;
&#xD;
exec (@sqlTxt)&#xD;
&#xD;
DROP TABLE #tmpWymiary&#xD;
drop table #tmpTrNWym &#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+Q9gXTX4eeGv2fSZXMlwqzoBe8qh5g1OTUWqhH+F8ftHNNzvcTVGInUIihmuBxm2ox60CYKkktu9alGnKuoiAcqH+PHGZX5Zl2mTtE9FmxsmQLLR6Nk7qEs30OL8btwEbUFcjXT4laFhXDNEHbKMH8CsjMwLcfyZWL1YLJdrtcYzp9cdduCYiL/</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja" caption="Pozycja" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dział" caption="Dział" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Projekt" caption="Projekt" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wartość" caption="Wartość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wymiar Procent" caption="Wymiar Procent" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Typ Pozycji" caption="Typ Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Typ Dokumentu" caption="Typ Dokumentu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Rok" caption="Data Dokumentu Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Miesiąc" caption="Data Dokumentu Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Dzień" caption="Data Dokumentu Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Rok" caption="Data Termin Płatności Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Miesiąc" caption="Data Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Termin Płatności Dzień" caption="Data Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Analizy" caption="Data Analizy" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kategoria finansowa Poziom 0" caption="Kategoria finansowa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria finansowa Poziom 1" caption="Kategoria finansowa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data od:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początku analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GetDate()-30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data do:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data końca analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GetDate()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje standardową analizę opisów analitycznych dla określonego podczas uruchamiania zakresu dat dokumentów.</a:description><a:id>34</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>34. Raport Opisów Analitycznych w zakresie dat</a:mainLinkName><a:modifiedOn>2025-04-14T14:01:57.543</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2022-05-12T10:46:20</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Kurierów&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @select3 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr &#xD;
FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(OdbAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Odbiorca Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max), @atrybutyTwr2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
SET @atrybutyTwr2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyTwr2 = @atrybutyTwr2 + N', ''(NIEPRZYPISANE)'' [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, &#xD;
  CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
    END  [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'SELECT&#xD;
    BAZ.Baz_Nazwa AS [Baza Firmowa],&#xD;
    CASE SZL_TypKuriera&#xD;
        WHEN 2 THEN ''DPD''&#xD;
        WHEN 3 THEN ''DHL''&#xD;
        WHEN 4 THEN ''Poczta Polska''&#xD;
        WHEN 5 THEN ''InPost Paczkomaty''&#xD;
        WHEN 6 THEN ''InPost Allegro''&#xD;
        ELSE ''(NIEZNANY)''&#xD;
    END AS [Kurier Nazwa],&#xD;
    SZL_NumerPelny AS [Dokument ZNP Numer],&#xD;
    ISNULL(NULLIF(SZL_Uwagi, ''''), ''(BRAK)'') [Dokument ZNP Uwagi],&#xD;
    CASE&#xD;
        WHEN SZL_Bufor = 0 THEN ''Wysłane''&#xD;
        WHEN SZL_Bufor = 1 THEN ''Niewysłane''&#xD;
        ELSE ''(NIEZNANY)''&#xD;
    END AS [Dokument ZNP Status],&#xD;
    ISNULL(NULLIF(SZL_Status, ''''), ''(BRAK)'') AS [Dokument ZNP Status Przesyłki],&#xD;
    ISNULL(NULLIF(SZL_NumerProtokoluOdbioru, ''''), ''(BRAK)'') AS [Dokument ZNP Nr Protokołu],&#xD;
    ISNULL(NULLIF(SZL_NumerZleceniaOdbioru, ''''), ''(BRAK)'') AS [Dokument ZNP Nr Zlecenia Odbioru],&#xD;
    ISNULL(NULLIF(SZL_ReferencjeTekst, ''''), ''(BRAK)'') AS [Dokument ZNP Referencje],&#xD;
    CASE &#xD;
        WHEN SZL_DokumentyZwrotne = 1 THEN ISNULL(NULLIF(SZL_DokumentyZwrotneTekst, ''''), ''(BRAK)'')&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Dokument ZNP Dokumenty Zwrotne],&#xD;
    SZL_NumerPelny AS [Liczba Dokumentów ZNP],&#xD;
    SAN_Kod AS [Nadawca Kod],&#xD;
    SZL_SANNazwa AS [Nadawca Nazwa],&#xD;
    ''ul. '' + ISNULL(NULLIF(SZL_SANUlica, ''''), ''(BRAK)'') +  '' '' + ISNULL(NULLIF(SZL_SANNrDomu, ''''), ''(BRAK)'') + CASE SZL_SANNrLokalu WHEN '''' THEN '''' ELSE ''/'' + SZL_SANNrLokalu END AS [Nadawca Adres],&#xD;
    ISNULL(NULLIF(SZL_SANMiasto, ''''), ''(BRAK)'') AS [Nadawca Miasto],&#xD;
    ISNULL(NULLIF(SZL_SANKodPocztowy, ''''), ''(BRAK)'') AS [Nadawca Kod Pocztowy],&#xD;
    CASE SZL_OpiekunTyp&#xD;
        WHEN 3 THEN Opiekun.PRI_Kod&#xD;
        WHEN 8 THEN SZL_OpeModKod&#xD;
        ELSE ''(NIEZNANY)''&#xD;
    END AS [Nadawca Opiekun Kod],&#xD;
    ISNULL(NULLIF(SZL_OpiekunNazwa, ''''), ''(BRAK)'') AS [Nadawca Osoba Kontaktowa],&#xD;
    CASE &#xD;
        WHEN SZL_OdbiorcaTyp = 1 THEN ISNULL(NULLIF(Knt_Kod, ''''), ''(BRAK)'')&#xD;
        WHEN SZL_OdbiorcaTyp = 2 THEN ISNULL(NULLIF(BNa_Akronim, ''''), ''(BRAK)'')&#xD;
        WHEN SZL_OdbiorcaTyp = 3 THEN ISNULL(NULLIF(Odbiorca.PRI_Kod, ''''), ''(BRAK)'')&#xD;
        WHEN SZL_OdbiorcaTyp = 5 THEN ISNULL(NULLIF(Urz_Akronim, ''''), ''(BRAK)'')&#xD;
        WHEN SZL_OdbiorcaTyp IS NULL THEN ''(BRAK)''&#xD;
        ELSE ''(NIEZNANY)''&#xD;
    END AS [Obiorca Kod],&#xD;
    ISNULL(NULLIF(SZL_OdbNazwa, ''''), ''(BRAK)'') AS [Odbiorca Nazwa],&#xD;
    ''ul. '' + ISNULL(NULLIF(SZL_OdbUlica, ''''), ''(BRAK)'') +  '' '' + ISNULL(NULLIF(SZL_OdbNrDomu, ''''), ''(BRAK)'') + CASE SZL_OdbNrLokalu WHEN '''' THEN '''' ELSE ''/'' + SZL_OdbNrLokalu END AS [Odbiorca Adres],&#xD;
    ISNULL(NULLIF(SZL_OdbMiasto, ''''), ''(BRAK)'') AS [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(SZL_OdbKodPocztowy, ''''), ''(BRAK)'') AS [Odbiorca Kod Pocztowy],&#xD;
    ISNULL(NULLIF(SZL_Odebral, ''''), ''(BRAK)'') AS [Odbiorca Osoba Kontaktowa],&#xD;
    CASE &#xD;
        WHEN SPA_SPAID IS NULL THEN ''(BRAK)''&#xD;
        ELSE SZL_NumerPelny + ''-'' + CONVERT(VARCHAR, SPA_SPAID)&#xD;
    END AS [Paczka Numer],&#xD;
    CASE &#xD;
        WHEN SZL_TypKuriera = 2 THEN ISNULL(NULLIF(SPA_Zawartosc, ''''), ''(BRAK)'')&#xD;
        WHEN SZL_TypKuriera IN (3, 4) THEN ISNULL(NULLIF(SZL_ZawartoscTekst, ''''), ''(BRAK)'')&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Paczka Zawartość],&#xD;
    ISNULL(NULLIF(SPA_NumerListu, ''''), ''(BRAK)'') AS [Paczka Nr Listu Przewozowego],&#xD;
    CASE &#xD;
        WHEN SZL_TypKuriera IN (2, 3) THEN &#xD;
            CASE &#xD;
                WHEN SPA_SposobPakowaniaKey = 0 THEN ''Standardowa''&#xD;
                WHEN SPA_SposobPakowaniaKey = 1 THEN ''Kopertowa''&#xD;
                WHEN SPA_SposobPakowaniaKey = 2 THEN ''Paletowa''&#xD;
                WHEN SPA_SposobPakowaniaKey IS NULL THEN ''(BRAK)''&#xD;
                ELSE ''(NIEZNANY)''&#xD;
            END&#xD;
        WHEN SZL_TypKuriera = 6 THEN &#xD;
            CASE SPA_SposobPakowaniaKey&#xD;
                WHEN 0 THEN ''Paczkomaty 24/7''&#xD;
                WHEN 1 THEN ''miniKurier24''&#xD;
                WHEN 2 THEN ''Kurier24''&#xD;
                ELSE ''(NIEZNANY)''&#xD;
            END&#xD;
        WHEN SZL_TypKuriera = 4 THEN &#xD;
            CASE SPA_SposobPakowaniaKey&#xD;
                WHEN 0 THEN ''Pocztex''&#xD;
                WHEN 1 THEN ''Pocztex Kurier 48''&#xD;
                WHEN 2 THEN ''Usługa paczkowa''&#xD;
                WHEN 3 THEN ''Paczka pocztowa''&#xD;
                WHEN 4 THEN ''Przesyłka polecona''&#xD;
                WHEN 5 THEN ''Przesyłka firmowa polecona''&#xD;
                ELSE ''(NIEZNANY)''&#xD;
            END&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Paczka Rodzaj],&#xD;
    CASE &#xD;
        WHEN SZL_OpcjePobranie = 1 THEN SZL_OpcjeKwotaPobrania / COUNT(SZL_NumerPelny) OVER(PARTITION BY SZL_NumerPelny)&#xD;
        ELSE NULL&#xD;
    END AS [Paczka Kwota Pobrania],&#xD;
    CASE&#xD;
        WHEN SZL_TypKuriera IN (2, 3, 5, 6) THEN &#xD;
            CASE &#xD;
                WHEN SZL_OpcjeUbezpieczenie = 1 THEN SZL_OpcjeKwotaUbezpieczenia / COUNT(SZL_NumerPelny) OVER(PARTITION BY SZL_NumerPelny)&#xD;
                ELSE NULL&#xD;
            END&#xD;
        WHEN SZL_TypKuriera = 4 THEN NULLIF(SPA_DeklarowanaWartosc, 0)&#xD;
        ELSE NULL&#xD;
    END AS [Paczka Deklarowana Wartość],&#xD;
    CASE&#xD;
        WHEN SZL_TypKuriera IN (2, 3, 5, 6) THEN &#xD;
            CASE &#xD;
                WHEN SZL_OpcjeUbezpieczenie = 1 THEN SZL_OpcjeKwotaUbezpieczenia / COUNT(SZL_NumerPelny) OVER(PARTITION BY SZL_NumerPelny)&#xD;
                ELSE NULL&#xD;
            END&#xD;
        WHEN SZL_TypKuriera = 4 THEN NULLIF(SPA_KwotaUbezpieczenia, 0) &#xD;
        ELSE NULL&#xD;
    END AS [Paczka Kwota Ubezpieczenia],&#xD;
    NULLIF(SPA_Waga, 0) AS [Paczka Waga],&#xD;
    NULLIF(SPA_Wysokosc, 0) AS [Paczka Wysokość],&#xD;
    NULLIF(SPA_Dlugosc, 0) AS [Paczka Długość],&#xD;
    NULLIF(SPA_Szerokosc, 0) AS [Paczka Szerokość],&#xD;
    CASE &#xD;
        WHEN SZL_TypKuriera = 4 AND SPA_SposobPakowaniaKey = 1 THEN &#xD;
            CASE SPA_Gabaryt&#xD;
                WHEN 0 THEN ''XS''&#xD;
                WHEN 1 THEN ''S''&#xD;
                WHEN 2 THEN ''M''&#xD;
                WHEN 3 THEN ''L''&#xD;
                WHEN 4 THEN ''XL''&#xD;
                WHEN 5 THEN ''XXL''&#xD;
                ELSE ''(NIEZNANY)''&#xD;
            END&#xD;
        WHEN SZL_TypKuriera = 4 AND SPA_SposobPakowaniaKey = 3 THEN &#xD;
            CASE SPA_Gabaryt&#xD;
                WHEN 0 THEN ''A''&#xD;
                WHEN 1 THEN ''B''&#xD;
                ELSE ''(NIEZNANY)''&#xD;
            END&#xD;
        WHEN SZL_TypKuriera = 4 AND SPA_SposobPakowaniaKey = 4 THEN &#xD;
            CASE SPA_Gabaryt&#xD;
                WHEN 2 THEN ''S''&#xD;
                WHEN 3 THEN ''M''&#xD;
                WHEN 4 THEN ''L''&#xD;
                ELSE ''(NIEZNANY)''&#xD;
            END&#xD;
        WHEN SZL_TypKuriera IN (5, 6) THEN &#xD;
            CASE SPA_Gabaryt&#xD;
                WHEN 0 THEN ''A''&#xD;
                WHEN 1 THEN ''B''&#xD;
                WHEN 2 THEN ''C''&#xD;
                ELSE ''(NIEZNANY)''&#xD;
            END&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Paczka Gabaryt],&#xD;
    SPA_SPAID AS [Liczba Paczek],&#xD;
    ISNULL(NULLIF(SZL_UrzadNadaniaKod, ''''), ''(BRAK)'') AS [Punkt Nadania Kod],&#xD;
    ISNULL(NULLIF(SZL_UrzadNadaniaAdres, ''''), ''(BRAK)'') AS [Punkt Nadania Adres],&#xD;
    ISNULL(NULLIF(SZL_OdbiorWPunkcieId, ''''), ''(BRAK)'') AS [Punkt Odbioru Kod],&#xD;
    ISNULL(NULLIF(SZL_OdbiorWPunkcieAdres, ''''), ''(BRAK)'') AS [Punkt Odbioru Adres],&#xD;
    ''(NIEPRZYPISANY)'' AS [Dokument Numer],&#xD;
    ''(NIEPRZYPISANY)'' AS [Produkt Kod], &#xD;
    ''(NIEPRZYPISANY)'' AS [Produkt Nazwa],&#xD;
    ''(NIEPRZYPISANY)'' AS [Kontrahent Kod],&#xD;
    NULL AS [Sprzedaż Wartość Netto],&#xD;
    NULL AS [Sprzedaż Wartość Brutto],&#xD;
    NULL AS [Sprzedaż Ilość], &#xD;
        CASE WHEN DATEDIFF(day, SZL_DataKurierOD, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Nadania Dziś],&#xD;
    CASE WHEN DATEDIFF(day, SZL_DataKurierOD, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Nadania Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, SZL_DataKurierOD) / 7 * 7 + 3) + 6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3) + 6) / 7) AND (YEAR(SZL_DataKurierOD) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Nadania Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(SZL_DataKurierOD) = MONTH(GETDATE())) AND (YEAR(SZL_DataKurierOD) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Nadania Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(SZL_DataKurierOD) = MONTH(GETDATE())-1) AND (YEAR(SZL_DataKurierOD) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(SZL_DataKurierOD) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(SZL_DataKurierOD) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Nadania Poprzedni Miesiąc],&#xD;
    zal.Ope_Kod [Operator Wprowadzający],&#xD;
    mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    REPLACE(CONVERT(VARCHAR(10), SZL_DataDok, 111), ''/'', ''-'') [Data Wystawienia],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), SZL_DataWyslania, 111), ''/'', ''-''))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), SZL_DataKurierOD, 111), ''/'', ''-''))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania],&#xD;
    */&#xD;
&#xD;
    ----------DATY ANALIZY&#xD;
    REPLACE(CONVERT(VARCHAR(10), SZL_DataDok, 111), ''/'', ''-'') [Data Wystawienia Dzień],&#xD;
    (DATEPART(DY, DATEDIFF(d, 0, SZL_DataDok) / 7 * 7 + 3)+6) / 7 [Data Wystawienia Tydzień Roku],&#xD;
    MONTH(SZL_DataDok) [Data Wystawienia Miesiąc],&#xD;
    DATEPART(quarter, SZL_DataDok) [Data Wystawienia Kwartał],&#xD;
    YEAR(SZL_DataDok) [Data Wystawienia Rok],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), SZL_DataWyslania, 111), ''/'', ''-''))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia Dzień],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, (datepart(DY, datediff(d, 0, SZL_DataWyslania) / 7 * 7 + 3) + 6) / 7)&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia Tydzień Roku],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, MONTH(SZL_DataWyslania))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia Miesiąc],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, DATEPART(quarter, SZL_DataWyslania))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia Kwartał],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, YEAR(SZL_DataWyslania))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia Rok],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), SZL_DataKurierOD, 111), ''/'', ''-''))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania Dzień],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, (datepart(DY, datediff(d, 0, SZL_DataKurierOD) / 7 * 7 + 3) + 6) / 7)&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania Tydzień Roku],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, MONTH(SZL_DataKurierOD))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania Miesiąc],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, DATEPART(quarter, SZL_DataKurierOD))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania Kwartał],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, YEAR(SZL_DataKurierOD))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania Rok],&#xD;
    GETDATE() [Data Analizy]&#xD;
    &#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], NULL [Dokument Numer __ORGID__],''' + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], NULL [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], Odbiorca.PRI_PriId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], Odbiorca.PRI_PriId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], NULL [Produkt Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], NULL [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]'&#xD;
&#xD;
    + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
&#xD;
set @select2 = &#xD;
' FROM [CDN].[SenditZleceniePrzesylki] &#xD;
LEFT JOIN [CDN].[SenditPaczki] ON SZL_SZLID = SPA_SZLID &#xD;
LEFT JOIN [CDN].[SenditAdresyNadawcze] ON SZL_SANID = SAN_SANID&#xD;
LEFT JOIN ' + @Operatorzy + ' ON SZL_OpiekunId = Ope_OpeID&#xD;
LEFT JOIN [CDN].[PracIdx] Opiekun ON SZL_OpiekunId = Opiekun.PRI_PriId&#xD;
LEFT JOIN [CDN].[Kontrahenci] ON SZL_OdbID = Knt_KntId AND SZL_OdbiorcaTyp = 1&#xD;
LEFT JOIN [CDN].[BnkNazwy] ON SZL_OdbID = BNa_BNaId AND SZL_OdbiorcaTyp = 2&#xD;
LEFT JOIN [CDN].[PracIdx] Odbiorca ON SZL_OdbID = Odbiorca.PRI_PriId AND SZL_OdbiorcaTyp = 3&#xD;
LEFT JOIN [CDN].[Urzedy] ON SZL_OdbID = Urz_UrzId AND SZL_OdbiorcaTyp = 5&#xD;
LEFT JOIN #tmpTwrGr Poz ON 0 = 1&#xD;
LEFT JOIN #tmpTwrAtr TwrAtr ON 0 = 1&#xD;
LEFT JOIN #tmpPozAtr PozAtr ON 0 = 1&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON 0 = 1&#xD;
LEFT JOIN #tmpKonAtr OdbAtr ON 0 = 1&#xD;
LEFT JOIN #tmpDokAtr DokAtr ON 0 = 1&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON Knt_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON Knt_OpeModID = mod.Ope_OpeId&#xD;
&#xD;
UNION ALL&#xD;
&#xD;
SELECT&#xD;
    BAZ.Baz_Nazwa AS [Baza Firmowa],&#xD;
    CASE SZL_TypKuriera&#xD;
        WHEN 2 THEN ''DPD''&#xD;
        WHEN 3 THEN ''DHL''&#xD;
        WHEN 4 THEN ''Poczta Polska''&#xD;
        WHEN 5 THEN ''InPost Paczkomaty''&#xD;
        WHEN 6 THEN ''InPost Allegro''&#xD;
        ELSE ''(NIEZNANY)''&#xD;
    END AS [Kurier Nazwa],&#xD;
    SZL_NumerPelny AS [Dokument ZNP Numer],&#xD;
    ISNULL(NULLIF(SZL_Uwagi, ''''), ''(BRAK)'') [Dokument ZNP Uwagi],&#xD;
    CASE&#xD;
        WHEN SZL_Bufor = 0 THEN ''Wysłane''&#xD;
        WHEN SZL_Bufor = 1 THEN ''Niewysłane''&#xD;
        ELSE ''(NIEZNANY)''&#xD;
    END AS [Dokument ZNP Status],&#xD;
    ISNULL(NULLIF(SZL_Status, ''''), ''(BRAK)'') AS [Dokument ZNP Status Przesyłki],&#xD;
    ISNULL(NULLIF(SZL_NumerProtokoluOdbioru, ''''), ''(BRAK)'') AS [Dokument ZNP Nr Protokołu],&#xD;
    ISNULL(NULLIF(SZL_NumerZleceniaOdbioru, ''''), ''(BRAK)'') AS [Dokument ZNP Nr Zlecenia Odbioru],&#xD;
    ISNULL(NULLIF(SZL_ReferencjeTekst, ''''), ''(BRAK)'') AS [Dokument ZNP Referencje],&#xD;
    CASE &#xD;
        WHEN SZL_DokumentyZwrotne = 1 THEN ISNULL(NULLIF(SZL_DokumentyZwrotneTekst, ''''), ''(BRAK)'')&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Dokument ZNP Dokumenty Zwrotne],&#xD;
    SZL_NumerPelny AS [Liczba Dokumentów ZNP],&#xD;
    SAN_Kod AS [Nadawca Kod],&#xD;
    SZL_SANNazwa AS [Nadawca Nazwa],&#xD;
    ''ul. '' + ISNULL(NULLIF(SZL_SANUlica, ''''), ''(BRAK)'') +  '' '' + ISNULL(NULLIF(SZL_SANNrDomu, ''''), ''(BRAK)'') + CASE SZL_SANNrLokalu WHEN '''' THEN '''' ELSE ''/'' + SZL_SANNrLokalu END AS [Nadawca Adres],&#xD;
    ISNULL(NULLIF(SZL_SANMiasto, ''''), ''(BRAK)'') AS [Nadawca Miasto],&#xD;
    ISNULL(NULLIF(SZL_SANKodPocztowy, ''''), ''(BRAK)'') AS [Nadawca Kod Pocztowy],&#xD;
    CASE SZL_OpiekunTyp&#xD;
        WHEN 3 THEN Opiekun.PRI_Kod&#xD;
        WHEN 8 THEN SZL_OpeModKod&#xD;
        ELSE ''(NIEZNANY)''&#xD;
    END AS [Nadawca Opiekun Kod],&#xD;
    ISNULL(NULLIF(SZL_OpiekunNazwa, ''''), ''(BRAK)'') AS [Nadawca Osoba Kontaktowa],&#xD;
    CASE &#xD;
        WHEN SZL_OdbiorcaTyp = 1 THEN ISNULL(NULLIF(Knt1.Knt_Kod, ''''), ''(BRAK)'')&#xD;
        WHEN SZL_OdbiorcaTyp = 2 THEN ISNULL(NULLIF(BNa_Akronim, ''''), ''(BRAK)'')&#xD;
        WHEN SZL_OdbiorcaTyp = 3 THEN ISNULL(NULLIF(Odbiorca.PRI_Kod, ''''), ''(BRAK)'')&#xD;
        WHEN SZL_OdbiorcaTyp = 5 THEN ISNULL(NULLIF(Urz_Akronim, ''''), ''(BRAK)'')&#xD;
        WHEN SZL_OdbiorcaTyp IS NULL THEN ''(BRAK)''&#xD;
        ELSE ''(NIEZNANY)''&#xD;
    END AS [Obiorca Kod],&#xD;
    ISNULL(NULLIF(SZL_OdbNazwa, ''''), ''(BRAK)'') AS [Odbiorca Nazwa],&#xD;
    ''ul. '' + ISNULL(NULLIF(SZL_OdbUlica, ''''), ''(BRAK)'') +  '' '' + ISNULL(NULLIF(SZL_OdbNrDomu, ''''), ''(BRAK)'') + CASE SZL_OdbNrLokalu WHEN '''' THEN '''' ELSE ''/'' + SZL_OdbNrLokalu END AS [Odbiorca Adres],&#xD;
    ISNULL(NULLIF(SZL_OdbMiasto, ''''), ''(BRAK)'') AS [Odbiorca Miasto],&#xD;
    ISNULL(NULLIF(SZL_OdbKodPocztowy, ''''), ''(BRAK)'') AS [Odbiorca Kod Pocztowy],&#xD;
    ISNULL(NULLIF(SZL_Odebral, ''''), ''(BRAK)'') AS [Odbiorca Osoba Kontaktowa],&#xD;
    ''(NIEPRZYPISANY)'' AS [Paczka Numer],&#xD;
    ''(NIEPRZYPISANY)'' AS [Paczka Zawartość],&#xD;
    ''(NIEPRZYPISANY)'' AS [Paczka Nr Listu Przewozowego],&#xD;
    ''(NIEPRZYPISANY)'' AS [Paczka Rodzaj],&#xD;
    NULL AS [Paczka Kwota Pobrania],&#xD;
    NULL AS [Paczka Deklarowana Wartość],&#xD;
    NULL AS [Paczka Kwota Ubezpieczenia],&#xD;
    NULL AS [Paczka Waga],&#xD;
    NULL AS [Paczka Wysokość],&#xD;
    NULL AS [Paczka Długość],&#xD;
    NULL AS [Paczka Szerokość],&#xD;
    ''(NIEPRZYPISANY)'' AS [Paczka Gabaryt],&#xD;
    NULL AS [Liczba Paczek],&#xD;
    ISNULL(NULLIF(SZL_UrzadNadaniaKod, ''''), ''(BRAK)'') AS [Punkt Nadania Kod],&#xD;
    ISNULL(NULLIF(SZL_UrzadNadaniaAdres, ''''), ''(BRAK)'') AS [Punkt Nadania Adres],&#xD;
    ISNULL(NULLIF(SZL_OdbiorWPunkcieId, ''''), ''(BRAK)'') AS [Punkt Odbioru Kod],&#xD;
    ISNULL(NULLIF(SZL_OdbiorWPunkcieAdres, ''''), ''(BRAK)'') AS [Punkt Odbioru Adres],&#xD;
    ISNULL(NULLIF(TrN_NumerPelny, ''''), ''(BRAK)'') AS [Dokument Numer],&#xD;
    Twr_Kod AS [Produkt Kod], &#xD;
    Twr_Nazwa AS [Produkt Nazwa],&#xD;
    Knt2.Knt_Kod AS [Kontrahent Kod],&#xD;
    TrE_WartoscNetto AS [Sprzedaż Wartość Netto], &#xD;
    TrE_WartoscBrutto AS [Sprzedaż Wartość Brutto], &#xD;
    TrE_Ilosc AS [Sprzedaż Ilość], &#xD;
    CASE WHEN DATEDIFF(day, SZL_DataKurierOD, GETDATE()) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Nadania Dziś],&#xD;
    CASE WHEN DATEDIFF(day, SZL_DataKurierOD, GETDATE() - 1) = 0 THEN ''TAK'' ELSE ''NIE'' END [Czas Nadania Wczoraj],&#xD;
    CASE WHEN ((datepart(DY, datediff(d, 0, SZL_DataKurierOD) / 7 * 7 + 3) + 6) / 7 = (datepart(DY, datediff(d, 0, GETDATE()) / 7 * 7 + 3) + 6) / 7) AND (YEAR(SZL_DataKurierOD) = YEAR(GETDATE())) &#xD;
        THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Nadania Aktualny Tydzień],&#xD;
    CASE WHEN (MONTH(SZL_DataKurierOD) = MONTH(GETDATE())) AND (YEAR(SZL_DataKurierOD) = YEAR(GETDATE())) THEN ''TAK'' ELSE ''NIE'' END [Czas Nadania Aktualny Miesiąc],&#xD;
    CASE &#xD;
        WHEN (MONTH(SZL_DataKurierOD) = MONTH(GETDATE())-1) AND (YEAR(SZL_DataKurierOD) = YEAR(GETDATE())) THEN ''TAK'' &#xD;
        WHEN ((MONTH(SZL_DataKurierOD) = 12) AND (MONTH(GETDATE()) = 1)) AND (YEAR(SZL_DataKurierOD) = YEAR(GETDATE()) - 1) THEN ''TAK'' &#xD;
        ELSE ''NIE'' &#xD;
    END [Czas Nadania Poprzedni Miesiąc],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], &#xD;
    mod.Ope_Kod [Operator Modyfikujący],&#xD;
&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
    REPLACE(CONVERT(VARCHAR(10), SZL_DataDok, 111), ''/'', ''-'') [Data Wystawienia],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), SZL_DataWyslania, 111), ''/'', ''-''))&#xD;
    END AS [Data Zgłoszenia],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), SZL_DataKurierOD, 111), ''/'', ''-''))&#xD;
    END AS [Data Nadania],&#xD;
    */&#xD;
&#xD;
    ----------DATY ANALIZY&#xD;
    REPLACE(CONVERT(VARCHAR(10), SZL_DataDok, 111), ''/'', ''-'') [Data Wystawienia Dzień],&#xD;
    (DATEPART(DY, DATEDIFF(d, 0, SZL_DataDok) / 7 * 7 + 3)+6) / 7 [Data Wystawienia Tydzień Roku],&#xD;
    MONTH(SZL_DataDok) [Data Wystawienia Miesiąc],&#xD;
    DATEPART(quarter, SZL_DataDok) [Data Wystawienia Kwartał],&#xD;
    YEAR(SZL_DataDok) [Data Wystawienia Rok],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), SZL_DataWyslania, 111), ''/'', ''-''))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia Dzień],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, (datepart(DY, datediff(d, 0, SZL_DataWyslania) / 7 * 7 + 3) + 6) / 7)&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia Tydzień Roku],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, MONTH(SZL_DataWyslania))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia Miesiąc],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, DATEPART(quarter, SZL_DataWyslania))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia Kwartał],&#xD;
    CASE &#xD;
        WHEN SZL_DataWyslania &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, YEAR(SZL_DataWyslania))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Zgłoszenia Rok],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, REPLACE(CONVERT(VARCHAR(10), SZL_DataKurierOD, 111), ''/'', ''-''))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania Dzień],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, (datepart(DY, datediff(d, 0, SZL_DataKurierOD) / 7 * 7 + 3) + 6) / 7)&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania Tydzień Roku],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, MONTH(SZL_DataKurierOD))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania Miesiąc],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, DATEPART(quarter, SZL_DataKurierOD))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania Kwartał],&#xD;
    CASE &#xD;
        WHEN SZL_DataKurierOD &gt; ''1900-01-01'' THEN CONVERT(VARCHAR, YEAR(SZL_DataKurierOD))&#xD;
        ELSE ''(BRAK)''&#xD;
    END AS [Data Nadania Rok],&#xD;
    GETDATE() [Data Analizy]&#xD;
    &#xD;
    ----------KONTEKSTY&#xD;
    ,30392 [Dokument Numer __PROCID__Sprzedaz__], TrN_TrNId [Dokument Numer __ORGID__],''' + @bazaFirmowa + ''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], Knt2.Knt_KntId [Kontrahent Kod __ORGID__],''' + @bazaFirmowa + ''' [Kontrahent Kod __DATABASE__]&#xD;
    ,20201 [Odbiorca Nazwa __PROCID__], Odbiorca.PRI_PriId [Odbiorca Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Nazwa __DATABASE__]&#xD;
    ,20201 [Odbiorca Kod __PROCID__], Odbiorca.PRI_PriId [Odbiorca Kod __ORGID__],''' + @bazaFirmowa + ''' [Odbiorca Kod __DATABASE__]&#xD;
    ,30392 [Produkt Nazwa __PROCID__], Twr_TwrId [Produkt Nazwa __ORGID__],''' + @bazaFirmowa + ''' [Produkt Nazwa __DATABASE__]&#xD;
    ,30392 [Produkt Kod __PROCID__Towary__], Twr_TwrId [Produkt Kod __ORGID__],''' + @bazaFirmowa + ''' [Produkt Kod __DATABASE__]'&#xD;
&#xD;
    + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
&#xD;
set @select3 = &#xD;
' FROM [CDN].[SenditZleceniePrzesylki] &#xD;
LEFT JOIN [CDN].[SenditAdresyNadawcze] ON SZL_SANID = SAN_SANID&#xD;
LEFT JOIN ' + @Operatorzy + ' ON SZL_OpiekunId = Ope_OpeID&#xD;
LEFT JOIN [CDN].[PracIdx] Opiekun ON SZL_OpiekunId = Opiekun.PRI_PriId&#xD;
LEFT JOIN [CDN].[Kontrahenci] Knt1 ON SZL_OdbID = Knt1.Knt_KntId AND SZL_OdbiorcaTyp = 1&#xD;
LEFT JOIN [CDN].[BnkNazwy] ON SZL_OdbID = BNa_BNaId AND SZL_OdbiorcaTyp = 2&#xD;
LEFT JOIN [CDN].[PracIdx] Odbiorca ON SZL_OdbID = Odbiorca.PRI_PriId AND SZL_OdbiorcaTyp = 3&#xD;
LEFT JOIN [CDN].[Urzedy] ON SZL_OdbID = Urz_UrzId AND SZL_OdbiorcaTyp = 5&#xD;
JOIN [CDN].[TraNag] ON TrN_TypDokumentu = SZL_DokZrodloweTyp AND TrN_TrNID = SZL_DokZrodlowe&#xD;
LEFT JOIN [CDN].[TraElem] ON TrE_TrNID = TrN_TrNID&#xD;
LEFT JOIN [CDN].[Towary] ON TrE_TwrId = Twr_TwrId&#xD;
LEFT JOIN [CDN].[Kontrahenci] Knt2 ON TrN_PodID = Knt2.Knt_KntId AND TrN_PodmiotTyp = 1&#xD;
LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId = TwrAtr.TwA_TwrId &#xD;
LEFT JOIN #tmpPozatr PozAtr ON TrE_TrEId = PozAtr.TrA_TrEId&#xD;
LEFT JOIN #tmpKonAtr KonAtr ON TrN_PodID = KonAtr.KnA_PodmiotId AND TrN_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpKonAtr OdbAtr ON SZL_OdbID = OdbAtr.KnA_PodmiotId AND SZL_OdbiorcaTyp = OdbAtr.KnA_PodmiotTyp&#xD;
LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID = DokAtr.DAt_TrNId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
LEFT JOIN ' + @Operatorzy + ' zal ON SZL_OpeZalID = zal.Ope_OpeId&#xD;
LEFT JOIN ' + @Operatorzy + ' mod ON SZL_OpeModID = mod.Ope_OpeId&#xD;
'&#xD;
&#xD;
print (@select + @select2 + @select3)&#xD;
exec (@select + @select2 + @select3)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozAtr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+QsC2y3GHJhH55HeBqlCrHb9QG1qA3KejTfRyN5xUgW6wwWBUFA3ybCtag2Wjg/A4SVNXZiGvCdNgY8gDj9/YzbEmpfugheHyr0WkN3be986TiU3x/iEcK/0fhk3SWB3uMV1YNDUiYU194O0A4YlM2D9Qu0zW/tgvLTL40SHElAAzfMNH+MSMKZgTfuVMmTK/Izu4khx1Y1uQ==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kurier Nazwa" caption="Kurier Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument ZNP Numer" caption="Dokument ZNP Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument ZNP Uwagi" caption="Dokument ZNP Uwagi" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument ZNP Status" caption="Dokument ZNP Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument ZNP Status Przesyłki" caption="Dokument ZNP Status Przesyłki" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument ZNP Nr Protokołu" caption="Dokument ZNP Nr Protokołu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument ZNP Nr Zlecenia Odbioru" caption="Dokument ZNP Nr Zlecenia Odbioru" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument ZNP Referencje" caption="Dokument ZNP Referencje" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument ZNP Dokumenty Zwrotne" caption="Dokument ZNP Dokumenty Zwrotne" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów ZNP" caption="Liczba Dokumentów ZNP" type="measure" formatString="n0" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Nadawca Kod" caption="Nadawca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nadawca Nazwa" caption="Nadawca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nadawca Adres" caption="Nadawca Adres" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nadawca Miasto" caption="Nadawca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nadawca Kod Pocztowy" caption="Nadawca Kod Pocztowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nadawca Opiekun Kod" caption="Nadawca Opiekun Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Nadawca Osoba Kontaktowa" caption="Nadawca Osoba Kontaktowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Obiorca Kod" caption="Obiorca Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Nazwa" caption="Odbiorca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Adres" caption="Odbiorca Adres" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Miasto" caption="Odbiorca Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Kod Pocztowy" caption="Odbiorca Kod Pocztowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Osoba Kontaktowa" caption="Odbiorca Osoba Kontaktowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Paczka Numer" caption="Paczka Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Paczka Zawartość" caption="Paczka Zawartość" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Paczka Nr Listu Przewozowego" caption="Paczka Nr Listu Przewozowego" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Paczka Rodzaj" caption="Paczka Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Paczka Kwota Pobrania" caption="Paczka Kwota Pobrania" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Paczka Deklarowana Wartość" caption="Paczka Deklarowana Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Paczka Kwota Ubezpieczenia" caption="Paczka Kwota Ubezpieczenia" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Paczka Waga" caption="Paczka Waga" type="measure" formatString="0.00 kg" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Paczka Wysokość" caption="Paczka Wysokość" type="measure" formatString="0.00 cm" aggregate="Average" /&gt;&#xD;
    &lt;column name="Paczka Długość" caption="Paczka Długość" type="measure" formatString="0.00 cm" aggregate="Average" /&gt;&#xD;
    &lt;column name="Paczka Szerokość" caption="Paczka Szerokość" type="measure" formatString="0.00 cm" aggregate="Average" /&gt;&#xD;
    &lt;column name="Paczka Gabaryt" caption="Paczka Gabaryt" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Paczek" caption="Liczba Paczek" type="measure" formatString="n0" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Punkt Nadania Kod" caption="Punkt Nadania Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Punkt Nadania Adres" caption="Punkt Nadania Adres" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Punkt Odbioru Kod" caption="Punkt Odbioru Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Punkt Odbioru Adres" caption="Punkt Odbioru Adres" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Netto" caption="Sprzedaż Wartość Netto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Wartość Brutto" caption="Sprzedaż Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Sprzedaż Ilość" caption="Sprzedaż Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zgłoszenia Dzień" caption="Data Zgłoszenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zgłoszenia Tydzień Roku" caption="Data Zgłoszenia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zgłoszenia Miesiąc" caption="Data Zgłoszenia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zgłoszenia Kwartał" caption="Data Zgłoszenia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zgłoszenia Rok" caption="Data Zgłoszenia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Nadania Dzień" caption="Data Nadania Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Nadania Tydzień Roku" caption="Data Nadania Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Nadania Miesiąc" caption="Data Nadania Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Nadania Kwartał" caption="Data Nadania Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Nadania Rok" caption="Data Nadania Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut FAKTURA ZA USŁUGI BR" caption="Kontrahent Atrybut FAKTURA ZA USŁUGI BR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Odbiorca Atrybut FAKTURA ZA USŁUGI BR" caption="Odbiorca Atrybut FAKTURA ZA USŁUGI BR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut REGION" caption="Dokument Atrybut REGION" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport Kurierów wersja 38.0 (OPTIMA 2025.3.0)&#xD;
&#xD;
Raport przedstawia informacje na temat przesyłek zleconych kurierom na podstawie dokumentów zleceń nadania przesyłki. Wartości prezentowane są w walucie systemowej.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
CDN.SenditZleceniePrzesylki - tabela zawierająca listę zleceń nadania przesyłki&#xD;
CDN.SenditPaczki - tabela zawierająca paczki przypisane do zleceń</a:description><a:id>35</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>35. Raport Kurierów</a:mainLinkName><a:modifiedOn>2024-09-29T13:15:41.097</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2025-04-11T09:37:55.443</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Struktury Zatrudnienia&#xD;
* Wersja raportu: 38.0&#xD;
* Wersja baz OPTIMY: 2025.5000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
CREATE TABLE #daty&#xD;
(dzien DATE&#xD;
);&#xD;
DECLARE @dzien DATETIME;&#xD;
SET @dzien = @DataOd;&#xD;
WHILE @dzien &lt;= @DataDo&#xD;
    BEGIN&#xD;
        INSERT INTO #daty(dzien)&#xD;
               SELECT @dzien;&#xD;
        SET @dzien = @dzien + 1;&#xD;
    END;&#xD;
&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
DECLARE @bazaFirmowa VARCHAR(MAX);&#xD;
SET @bazaFirmowa =&#xD;
(&#xD;
    SELECT SYS_Wartosc&#xD;
    FROM CDN.SystemCDN&#xD;
    WHERE SYS_ID = 1&#xD;
);&#xD;
&#xD;
SELECT PID,MIN(DataOstatnia) AS DataOstatnia,SUM(iloscUmow) as iloscUmow    into #tempPrzedluzenia from(&#xD;
 SELECT &#xD;
 PRE_Praid AS PID,&#xD;
 count(pre_praid) AS iloscUmow,&#xD;
 CASE WHEN PRE_ZatrudnionyDo = '2999-12-31 00:00:00.000' THEN  MIN(PRE_ZatrudnionyDo)&#xD;
 ELSE &#xD;
 MAX(PRE_ZatrudnionyDo)end AS DataOstatnia&#xD;
&#xD;
 FROM cdn.pracetaty&#xD;
group by  PRE_Praid,PRE_ZatrudnionyDo&#xD;
)x GROUP BY PID&#xD;
&#xD;
SELECT ZatrudnionyOd,ZatrudnionyDo,Praid, Dzien data INTO #temp FROM (select PRE_ZatrudnionyOd ZatrudnionyOd,MAX(PRE_ZatrudnionyDo) ZatrudnionyDo ,PRE_PraId Praid  from CDN.pracetaty  &#xD;
WHERE PRE_ZatrudnionyOd IS NOT NULL &#xD;
AND PRE_ZatrudnionyOd &lt;&gt; '1899-12-30 00:00:00.000' &#xD;
and PRE_ZatrudnionyDo IS NOT NULL &#xD;
GROUP BY PRE_PraId,PRE_ZatrudnionyOd &#xD;
)X JOIN #daty ON ZatrudnionyOd = dzien OR ZatrudnionyDo = dzien&#xD;
&#xD;
&#xD;
DECLARE @select varchar(max)&#xD;
SET @select = &#xD;
'&#xD;
&#xD;
SELECT  &#xD;
--WYMIARY&#xD;
BAZ.Baz_Nazwa [Baza Firmowa] &#xD;
/*&#xD;
----------DATY POINT&#xD;
,REPLACE(CONVERT(VARCHAR(10), dzien, 111), ''/'', ''-'') [Data Dzień]&#xD;
*/&#xD;
---------DATY ANALIZY&#xD;
,YEAR(dzien) [Data Rok]&#xD;
,CASE when MONTH(dzien) &lt;7 THEN ''I'' else ''II'' END AS [Data Półrocze]&#xD;
,DATEPART(quarter, dzien) AS [Data Kwartał] &#xD;
,MONTH(dzien) [Data Miesiąc]&#xD;
,REPLACE(CONVERT(VARCHAR(10), dzien, 111), ''/'', ''-'') [Data Dzień]&#xD;
&#xD;
,CONVERT(NVARCHAR, dzien, 112) AS [Dzień Miara], &#xD;
CASE WHEN  dzien = Data AND dzien = Cast(ZatrudnionyOd as date)  THEN 1 ELSE 0 end AS [Pracownik Zatrudnienie],&#xD;
CASE WHEN  dzien = Data AND dzien = Cast(zatrudnionyDo as date) THEN 1 ELSE 0 end AS [Pracownik Zwolnienie],&#xD;
CASE WHEN iloscUmow &gt; 1 and PRE_ETARodzajUmowy = ''na okres próbny'' AND CAST(PRE_DataDo AS DATE) = dzien THEN 1 else 0 END AS [Pracownik Umowa Próbna Przedłużenie],&#xD;
BAZ.Baz_Nazwa+'':''+PRE_Kod [Liczba Pracowników],&#xD;
CASE&#xD;
    WHEN PRE_ETARodzajUmowy = ''''&#xD;
    THEN ''(NIEPRZYPISANE)''&#xD;
    ELSE PRE_ETARodzajUmowy&#xD;
END [Rodzaj Umowy],&#xD;
CASE&#xD;
    WHEN sta.DKM_Nazwa IS NULL&#xD;
    THEN ''(NIEPRZYPISANE)''&#xD;
    ELSE sta.DKM_Nazwa&#xD;
END [Pracownik Stanowisko], &#xD;
CNT_Kod [Centrum Kod], &#xD;
CNT_Nazwa [Centrum Nazwa],&#xD;
&#xD;
&#xD;
CASE&#xD;
    WHEN PRE_ZatrudnionyDo = CONVERT(DATETIME, ''29991231'', 112)&#xD;
    THEN DATEDIFF(d, PRE_ZatrudnionyOd, GETDATE()) + 1&#xD;
    ELSE DATEDIFF(d, PRE_ZatrudnionyOd, PRE_ZatrudnionyDo) + 1&#xD;
END [Okres Zatrudnienia], &#xD;
PRE_Kod [Pracownik Kod],&#xD;
CASE&#xD;
    WHEN&#xD;
(&#xD;
    SELECT SUM(PRI_Typ)&#xD;
    FROM CDN.Pracidx&#xD;
    WHERE PRE_PraId = PRI_PraId&#xD;
          AND PRI_Typ &gt; 2&#xD;
) = 10&#xD;
    THEN ''Etat''&#xD;
    WHEN&#xD;
(&#xD;
    SELECT SUM(PRI_Typ)&#xD;
    FROM CDN.Pracidx&#xD;
    WHERE PRE_PraId = PRI_PraId&#xD;
          AND PRI_Typ &gt; 2&#xD;
) = 20&#xD;
    THEN ''Umowa''&#xD;
    WHEN&#xD;
(&#xD;
    SELECT SUM(PRI_Typ)&#xD;
    FROM CDN.Pracidx&#xD;
    WHERE PRE_PraId = PRI_PraId&#xD;
          AND PRI_Typ &gt; 2&#xD;
) = 30&#xD;
    THEN ''Etat/Umowa''&#xD;
    ELSE ''Bez Zatrudnienia''&#xD;
END [Typ Zatrudnienia],&#xD;
CASE PRE_KodWyksztal&#xD;
    WHEN ''11''&#xD;
    THEN ''Wykształcenie niepełne podstawowe''&#xD;
    WHEN ''12''&#xD;
    THEN ''Wykształcenie podstawowe ukończone''&#xD;
    WHEN ''20''&#xD;
    THEN ''Wykształcenie zasadnicze zawodowe''&#xD;
    WHEN ''31''&#xD;
    THEN ''Wykształcenie średnie zawodowe/techniczne''&#xD;
    WHEN ''32''&#xD;
    THEN ''Wykształcenie średnie ogólnokształcące''&#xD;
    WHEN ''40''&#xD;
    THEN ''Wykształcenie policealne''&#xD;
    WHEN ''50''&#xD;
    THEN ''Wykształcenie wyższe (w tym licencjat)''&#xD;
    ELSE ''Brak danych''&#xD;
END [Pracownik Wykształcenie],&#xD;
CASE&#xD;
    WHEN pr1.PRI_Typ = 1&#xD;
    THEN ''Pracownik''&#xD;
    ELSE ''Własciciel/Współpracownik''&#xD;
END [Pracownik Typ], &#xD;
PRE_Nazwisko + '' '' + PRE_Imie1 [Pracownik Nazwa],&#xD;
--MIARY&#xD;
CASE&#xD;
    WHEN((pre_ubztyuid &gt;= 110&#xD;
          AND pre_ubztyuid &lt;= 200&#xD;
          AND (pre_ubztyuid &lt;&gt; 120&#xD;
               AND pre_ubztyuid &lt;&gt; 121&#xD;
               AND pre_ubztyuid &lt;&gt; 122&#xD;
               AND pre_ubztyuid &lt;&gt; 123))&#xD;
         OR pre_ubztyuid = 80000)&#xD;
    THEN CASE&#xD;
             WHEN ISNULL(pra_parentid, 0) = 0&#xD;
             THEN 1&#xD;
             ELSE 0&#xD;
         END&#xD;
    ELSE NULL&#xD;
END AS [Osoby Pracownicy],&#xD;
CASE&#xD;
    WHEN(pre_ubztyuid &gt;= 510&#xD;
         AND pre_ubztyuid &lt;= 600)&#xD;
    THEN CASE&#xD;
             WHEN ISNULL(pra_parentid, 0) = 0&#xD;
             THEN 1&#xD;
             ELSE 0&#xD;
         END&#xD;
    ELSE NULL&#xD;
END AS [Osoby Właściciele],&#xD;
CASE&#xD;
    WHEN(PRE_ETARODZAJZATRUDNIENIA IN(4, 7))&#xD;
    THEN CASE&#xD;
             WHEN ISNULL(pra_parentid, 0) = 0&#xD;
             THEN 1&#xD;
             ELSE 0&#xD;
         END&#xD;
    ELSE NULL&#xD;
END AS [Osoby Uczniowie 1 kl],&#xD;
CASE&#xD;
    WHEN(PRE_ETARODZAJZATRUDNIENIA IN(5))&#xD;
    THEN CASE&#xD;
             WHEN ISNULL(pra_parentid, 0) = 0&#xD;
             THEN 1&#xD;
             ELSE 0&#xD;
         END&#xD;
    ELSE NULL&#xD;
END AS [Osoby Uczniowie 2 kl],&#xD;
CASE&#xD;
    WHEN(PRE_ETARODZAJZATRUDNIENIA IN(6))&#xD;
    THEN CASE&#xD;
             WHEN ISNULL(pra_parentid, 0) = 0&#xD;
             THEN 1&#xD;
             ELSE 0&#xD;
         END&#xD;
    ELSE NULL&#xD;
END AS [Osoby Uczniowie 3 kl], &#xD;
SUM(CAST(CASE&#xD;
             WHEN pre_ubztyuid &gt;    = 510&#xD;
                  AND pre_ubztyuid &lt;= 600&#xD;
             THEN 1&#xD;
             ELSE 0&#xD;
         END AS DECIMAL) / CAST(CASE&#xD;
                                    WHEN pre_ubztyuid &gt;= 510&#xD;
                                         AND pre_ubztyuid &lt;= 600&#xD;
                                    THEN 1&#xD;
                                    ELSE 1&#xD;
                                END AS DECIMAL)) AS [Etaty Właściciele], &#xD;
SUM(CAST(CASE&#xD;
             WHEN((pre_ubztyuid &gt;    = 110&#xD;
                   AND pre_ubztyuid &lt;= 200)&#xD;
                  OR pre_ubztyuid = 80000)&#xD;
                 AND (PRE_ETARODZAJZATRUDNIENIA NOT IN(4, 5, 6, 7))&#xD;
             THEN pre_etaetatl&#xD;
             ELSE 0&#xD;
         END AS DECIMAL) / CAST(CASE&#xD;
                                    WHEN((pre_ubztyuid &gt;= 110&#xD;
                                          AND pre_ubztyuid &lt;= 200)&#xD;
                                         OR pre_ubztyuid = 80000)&#xD;
                                        AND (PRE_ETARODZAJZATRUDNIENIA NOT IN(4, 5, 6, 7))&#xD;
                                    THEN pre_etaetatm&#xD;
                                    ELSE 1&#xD;
                                END AS DECIMAL)) AS [Etaty Pracownicy], &#xD;
SUM(CAST(CASE&#xD;
             WHEN PRE_ETARODZAJZATRUDNIENIA IN(4, 5, 6, 7)&#xD;
             THEN pre_etaetatl&#xD;
             ELSE 0&#xD;
         END AS DECIMAL) / CAST(CASE&#xD;
                                    WHEN PRE_ETARODZAJZATRUDNIENIA IN(4, 5, 6, 7)&#xD;
                                    THEN pre_etaetatm&#xD;
                                    ELSE 1&#xD;
                                END AS DECIMAL)) AS [Etaty Uczniowie], &#xD;
Wyplata [Suma Elementów Wypłaty],&#xD;
  DZL_Nazwa AS [Wydział Nazwa],&#xD;
  DZL_Kod AS [Wydział Kod]&#xD;
FROM #daty&#xD;
     JOIN cdn.pracetaty ON dzien between PRE_DataOd and PRE_DataDo&#xD;
	 --AND dzien between PRE_ZatrudnionyOd and PRE_ZatrudnionyDo&#xD;
	 &#xD;
	 --PRE_DataOd &lt;= dzien&#xD;
  --                         AND (PRE_DataDo IS NULL&#xD;
  --                              OR PRE_DataDo &gt;= dzien)&#xD;
  --                         AND PRE_ZatrudnionyOd &lt;= dzien&#xD;
  --                         AND (PRE_ZatrudnionyDo IS NULL&#xD;
  --                              OR PRE_ZatrudnionyDo &gt;= dzien)&#xD;
     JOIN cdn.prackod ON pra_praid = pre_praid&#xD;
                         AND PRA_Archiwalny = 0&#xD;
     JOIN CDN.Pracidx pr1 ON PRE_PraId = pr1.PRI_PraId&#xD;
                             AND pr1.PRI_Typ &lt; 10&#xD;
     LEFT JOIN CDN.DaneKadMod sta ON PRE_ETADkmIdStanowisko = sta.DKM_DkmId&#xD;
                                     AND sta.DKM_Rodzaj = 1&#xD;
     LEFT OUTER JOIN CDN.Zaklady ZakPracownik ON ZakPracownik.ZAK_ZAkID = PRE_ZakId&#xD;
     LEFT JOIN CDN.Centra ON CNT_CntId = PRE_CntId&#xD;
     LEFT JOIN  CDN.Dzialy on PRE_DzlId = DZL_DzlId &#xD;
     LEFT JOIN #tempPrzedluzenia tp ON tp.PID=PRE_praid&#xD;
     LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
	 LEFT JOIN #temp tep on data = dzien and pre_praid = praid  and (dzien = zatrudnionyOd OR dzien = ZatrudnionyDo)&#xD;
&#xD;
	 LEFT JOIN (select SUM(WPE_Wartosc) Wyplata,WPL_DataDok,Wpl_Praid from cdn.Wyplaty JOIN  cdn.WypElementy ON WPE_WplId = WPL_WplId Group by Wpl_Praid,WPL_DataDok)WPL &#xD;
	 ON PRE_praid = WPL_Praid and dzien = WPL_DataDok&#xD;
&#xD;
GROUP BY BAZ.Baz_Nazwa,&#xD;
         pre_ubztyuid, &#xD;
         dzien, &#xD;
		 [data],&#xD;
         PRE_ETARodzajZatrudnienia, &#xD;
         PRE_ETARodzajUmowy, &#xD;
         DKM_Nazwa, &#xD;
         CNT_Kod, &#xD;
         CNT_Nazwa, &#xD;
         PRE_ZatrudnionyOd, &#xD;
         PRE_ZatrudnionyDo, &#xD;
         PRE_Kod, &#xD;
         PRE_PraId, &#xD;
         PRE_KodWyksztal, &#xD;
         PRI_Typ, &#xD;
         PRE_Nazwisko, &#xD;
         PRE_Imie1, &#xD;
         PRA_ParentId, &#xD;
         PRA_PraId, &#xD;
         PRA_Nadrzedny,&#xD;
         DZL_Kod,&#xD;
         DZL_Nazwa,&#xD;
         DataOstatnia,&#xD;
         iloscUmow,&#xD;
         PRE_DataDo,&#xD;
		 ZatrudnionyOd,&#xD;
		 Zatrudnionydo,&#xD;
		 PRAID,Wyplata&#xD;
		&#xD;
&#xD;
'&#xD;
&#xD;
EXEC (@select)&#xD;
DROP TABLE #daty&#xD;
DROP TABLE #tempPrzedluzenia&#xD;
DROP TABLE #temp&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jcJmwCoYl15WzHxaW87BnyNdP2x8/CGcO7bORHqKJvs6K4Rc6WGUrqsFTohQnCixfCEZm86P9XmLvgtux+17xfMNWq24hKQ21Y6FZpZ5l4QjOINa5rreB8sackG/fPbGY3HWAzkEZBu0Hsrno1J2YHw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rok" caption="Data Rok" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Półrocze" caption="Data Półrocze" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Kwartał" caption="Data Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Miesiąc" caption="Data Miesiąc" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Data Dzień" caption="Data Dzień" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dzień Miara" caption="Dzień Miara" type="measure" formatString="n2" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Pracownik Zatrudnienie" caption="Pracownik Zatrudnienie" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pracownik Zwolnienie" caption="Pracownik Zwolnienie" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pracownik Umowa Próbna Przedłużenie" caption="Pracownik Umowa Próbna Przedłużenie" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Liczba Pracowników" caption="Liczba Pracowników" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Rodzaj Umowy" caption="Rodzaj Umowy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Stanowisko" caption="Pracownik Stanowisko" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Centrum Kod" caption="Centrum Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Centrum Nazwa" caption="Centrum Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Okres Zatrudnienia" caption="Okres Zatrudnienia" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Pracownik Kod" caption="Pracownik Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Typ Zatrudnienia" caption="Typ Zatrudnienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Wykształcenie" caption="Pracownik Wykształcenie" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Typ" caption="Pracownik Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pracownik Nazwa" caption="Pracownik Nazwa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Osoby Pracownicy" caption="Osoby Pracownicy" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Osoby Właściciele" caption="Osoby Właściciele" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Osoby Uczniowie 1 kl" caption="Osoby Uczniowie 1 kl" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Osoby Uczniowie 2 kl" caption="Osoby Uczniowie 2 kl" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Osoby Uczniowie 3 kl" caption="Osoby Uczniowie 3 kl" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Etaty Właściciele" caption="Etaty Właściciele" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Etaty Pracownicy" caption="Etaty Pracownicy" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Etaty Uczniowie" caption="Etaty Uczniowie" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Suma Elementów Wypłaty" caption="Suma Elementów Wypłaty" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Wydział Nazwa" caption="Wydział Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Wydział Kod" caption="Wydział Kod" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data Początkowa&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początkowa analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30
&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data końcowa analizy&lt;/Label&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions /&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields /&gt;&#xD;
  &lt;rowFields /&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields /&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport służy do szczegółowej analizy struktury zatrudnienia w firmie (lub wielu firmach) na każdy dzień w wybranym przedziale dat. Pozwala on śledzić, ilu pracowników było zatrudnionych w różnych formach i strukturach organizacyjnych oraz jakie mieli cechy (stanowisko, forma zatrudnienia, wykształcenie, itd.).</a:description><a:id>36</a:id><a:isPredefinedReport>true</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>36. Raport Struktury Zatrudnienia</a:mainLinkName><a:modifiedOn>2025-06-11T17:13:56.357</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>I. Raporty Wzorcowe</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts/><a:connections/></a:Report></Reports><UsePasswordsEncryption>true</UsePasswordsEncryption></ReportsList>