<ReportsList xmlns="http://schemas.datacontract.org/2004/07/Comarch.Msp.ReportsBook.BusinessLogic" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"><Reports xmlns:a="http://schemas.datacontract.org/2004/07/Comarch.Msp.ReportsBook.BusinessInterface.Entities"><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-15T10:43:45.387</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), &#xD;
&#xD;
	"Dokument Numer" = TrN_NumerPelny, &#xD;
	29047 [Dokument Numer __PROCID__Zakupy__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, &#xD;
	&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, &#xD;
	20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	&#xD;
	"Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),	   &#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	   "Kontrahent Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Opiekun" = CASE &#xD;
								WHEN Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       &#xD;
	   "Produkt Nazwa" = Twr_Nazwa, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   &#xD;
	   "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],&#xD;
	   &#xD;
	   "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
WHERE&#xD;
TrN_TypDokumentu=301&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKDhSAWKi1n1vIC6aYs3D/90/mh8ToH17VguNlqUK5BA5GNn+AmEyuQ8h/4w64ELevu9NzW6YwRfqeSkr1leW+5RABV/t7MQzsJU7vawcEyKBXJVrmS8SVFBoXUGYfY3JUhka0xwvR182Utbo9GUVp7IJr6zTyE/D7</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut DOSTAWCA REAL" caption="Kontrahent Atrybut DOSTAWCA REAL" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut GWARANCJA" caption="Kontrahent Atrybut GWARANCJA" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut AP" caption="Produkt Atrybut AP" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TPN" caption="Produkt Atrybut TPN" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KL" caption="Produkt Atrybut KL" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut GEANT NR ART." caption="Produkt Atrybut GEANT NR ART." type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR ART. REAL" caption="Produkt Atrybut NR ART. REAL" type="attribute" formatString="### ##0.00" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Bar" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False" rotated="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="Top" zeroValues="False" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="2" spacingHorizontal="2" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Zakupy w czasie" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="45" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="1" rangeMax="12" zeroLevel="True" margins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="0" rangeMax="561096,766999999" zeroLevel="True" margins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="259" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True"&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Data Operacji Miesiąc"&gt;&lt;header fontName="Tahoma" fontSize="8" width="137" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Data Operacji Miesiąc" index="0" expanded="True" width="137" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje zestawienie zakupów w roku obecnym i poprzednim w rozbiciu na miesiące.</a:description><a:id>100</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>2.01 Trend zakupów miesięcznie</a:mainLinkName><a:modifiedOn>2014-06-02T13:48:51.457</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-18T17:47:59.273</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']' &#xD;
	SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
	WHEN PARSENAME(REPLACE(REPLACE(REPLACE(DDf_Numeracja, '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
	WHEN PARSENAME(REPLACE(REPLACE(REPLACE(DDf_Numeracja, '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
	WHEN PARSENAME(REPLACE(REPLACE(REPLACE(DDf_Numeracja, '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
	WHEN PARSENAME(REPLACE(REPLACE(REPLACE(DDf_Numeracja, '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), &#xD;
&#xD;
	"Dokument Numer" = TrN_NumerPelny, &#xD;
	29047 [Dokument Numer __PROCID__Zakupy__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	&#xD;
ISNULL(PARSENAME(REPLACE(TrN_NumerPelny, ''/'', ''.''), ser.seria),''(BRAK)'') [Dokument Seria],	&#xD;
Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, &#xD;
	&#xD;
	"Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1, &#xD;
	20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],&#xD;
	&#xD;
	"Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
	20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],&#xD;
&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),	   &#xD;
	   "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	   "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
								WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
&#xD;
		pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
		20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	&#xD;
		pod5.Pod_Kod [Kontrahent Kod], &#xD;
		20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
&#xD;
		ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
		"Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
		ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
		ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
		CASE knt3.Knt_OpiekunTyp&#xD;
			WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
			WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
			ELSE ''(NIEPRZYPISANE)'' &#xD;
		END [Kontrahent Opiekun],&#xD;
&#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       &#xD;
	   "Produkt Nazwa" = Twr_Nazwa, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   &#xD;
	   "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],&#xD;
	   &#xD;
	   "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TrN_TrNID &#xD;
LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
	 LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
	LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
	LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
	LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
	LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
	LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
WHERE&#xD;
TrN_TypDokumentu=301&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKDhSAWKi1n1vIC6aYs3D/93VOswBLIY5yAb1FeT+5tPge27T2l5Gw6b1I7Au69Xe6IDjFWkd42YlsjXwJ8zkyPYcVhwdBP9i/Tl3QD/M0+1hy3zIFE33eEL1Lc9nC58j2h5wH16mUY+V7vYlD0KFAvg==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut DOSTAWCA REAL" caption="Kontrahent Atrybut DOSTAWCA REAL" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut GWARANCJA" caption="Kontrahent Atrybut GWARANCJA" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut AP" caption="Produkt Atrybut AP" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TPN" caption="Produkt Atrybut TPN" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KL" caption="Produkt Atrybut KL" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut GEANT NR ART." caption="Produkt Atrybut GEANT NR ART." type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR ART. REAL" caption="Produkt Atrybut NR ART. REAL" type="attribute" formatString="### ##0.00" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Bar" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False" rotated="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="False" position="Top" zeroValues="False" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="0" spacingHorizontal="0" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Zakupy w czasie" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="[Data Operacji Kwartał].[1]" rangeMax="[Data Operacji Kwartał].[4]" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisX&gt;&#xD;
    &lt;axisY visible="True" beginText="" endText="" angle="0" staggered="False"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="10" fontColor="" antialiasing="True" /&gt;&#xD;
      &lt;customLabels /&gt;&#xD;
      &lt;general autoGridSpacing="True" logarithmic="False" logarithmicBase="10" autoRange="True" scrollingAutoRange="True" rangeMin="0" rangeMax="563372,227" zeroLevel="True" margins="True" scrollingMargins="True" format="General" precision="2" alignment="Near" reverse="False" visible="True" /&gt;&#xD;
    &lt;/axisY&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Data Operacji Kwartał"&gt;&lt;header fontName="Tahoma" fontSize="8" width="140" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Data Operacji Kwartał" index="0" expanded="True" width="140" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje zestawienie zakupów w roku obecnym i poprzednim w rozbiciu na kwartały.</a:description><a:id>101</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>2.02 Trend zakupów kwartalnie</a:mainLinkName><a:modifiedOn>2016-05-24T12:46:31.617</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-01T11:30:12.433</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')  &#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, DB_NAME()+convert(Varchar(10),TN.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    "Dokument Numer" = TN.TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TN.TrN_Opis,''''), ''(BRAK)''),&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TN.TrN_NumerPelny,0,CHARINDEX(''/'',TN.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TN.TrN_NumerPelny,CHARINDEX(''/'',TN.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TN.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    Waluta = CASE WHEN TN.TrN_Waluta = '''' THEN @Wal ELSE TN.TrN_Waluta END, &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1, &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa,&#xD;
       CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
       "Produkt Kod" = Twr_Kod, &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
        "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
      "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc, "Numer Obcy " = TN.Trn_NumerObcy &#xD;
       ,ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza]&#xD;
       ,CAST(TrE_Ilosc/ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza]&#xD;
       ,CAST(TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
       ,WartosciGran AS [Zakupy Koszty Graniczne]&#xD;
&#xD;
       /*&#xD;
       ----------DATY POINT&#xD;
       ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-'')&#xD;
       */&#xD;
       ----------DATY ANALIZY&#xD;
       ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TN.TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TN.TrN_DataOpe), "Data Operacji Rok" = YEAR(TN.TrN_DataOpe)&#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataWys)*/ &#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TN.TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TN.TrN_DataWys), "Data Wystawienia Rok" = YEAR(TN.TrN_DataWys)&#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TN.TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TN.TrN_Termin), "Termin Płatności Rok" = YEAR(TN.TrN_Termin) &#xD;
       ,"Data Analizy" = GETDATE()&#xD;
       ----------KONTEKSTY&#xD;
        ,29047 [Dokument Numer __PROCID__Zakupy__], TN.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
        ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
        ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
        ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag TN&#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TN.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TN.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TN.TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TN.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TN.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TN.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TN.TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN (Select SUM(TE.TrE_WartoscNetto) WartosciGran, TE2.TRE_TREID elemID&#xD;
         From cdn.Tranag &#xD;
        LEFT JOIN cdn.Traelem TE ON  TRN_trnid = TE.TrE_TrNId&#xD;
        join cdn.TraElem TE2 ON te2.tre_treid=te.TrE_ZwrId&#xD;
         where trn_rodzaj IN (301008,301009,301018)&#xD;
         GROUP BY  TE2.TRE_TREID)KwoGran ON Tre_TreId = elemID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TN.TrN_TypDokumentu=301&#xD;
AND TN.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0 '&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKDhSAWKi1n1vIC6aYs3D/90/mh8ToH17VguNlqUK5BA5GNn+AmEyuQ8h/4w64ELevu9NzW6YwRfqeSkr1leW+5RABV/t7MQzsJU7vawcEyKBXJVrmS8SVFBoXUGYfY3JUhka0xwvR182Utbo9GUVp7IJr6zTyE/D7</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Numer Obcy " caption="Numer Obcy " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DELIVERY_GLN (K)" caption="Dokument Atrybut DELIVERY_GLN (K)" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAATAAAABwIWW0tvbnRyYWhlbnQgS29kXS5bQURNXQcCGltLb250cmFoZW50IEtvZF0uW0FMX0tPTVBdBwIiW0tvbnRyYWhlbnQgS29kXS5bQUxfS09NUF9HTElXSUNFXQcCGFtLb250cmFoZW50IEtvZF0uW0FMT1pBXQcCGVtLb250cmFoZW50IEtvZF0uW0JJR0dVTl0HAhxbS29udHJhaGVudCBLb2RdLltCSVVST1dJRUNdBwIkW0tvbnRyYWhlbnQgS29kXS5bQklVUk9XSUVDX1NLQVdJTkFdBwIYW0tvbnRyYWhlbnQgS29kXS5bQkxFSU1dBwIWW0tvbnRyYWhlbnQgS29kXS5bQ1BOXQcCGVtLb250cmFoZW50IEtvZF0uW0tPTEFTQV0HAhtbS29udHJhaGVudCBLb2RdLltLT1dBTFNLSV0HAhZbS29udHJhaGVudCBLb2RdLltMQVNdBwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSS1VTXQcCHFtLb250cmFoZW50IEtvZF0uW01BUlNaQUxJS10HAhlbS29udHJhaGVudCBLb2RdLltQVUNVxZpdBwIbW0tvbnRyYWhlbnQgS29kXS5bU09GVExBTkRdBwIYW0tvbnRyYWhlbnQgS29kXS5bU1RJTExdBwIXW0tvbnRyYWhlbnQgS29kXS5bVFBTQV0HAh5bS29udHJhaGVudCBLb2RdLltUV8OTSk9HUsOTRF3/////AAAAAA==</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True"&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="121" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Grupa"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="124" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Ilość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Ilość" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" width="121" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" width="124" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent Grupa" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje kontrahentów wraz z listą produktów od nich kupionych.</a:description><a:id>102</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>2.03 Zakupy produktów od kontrahenta</a:mainLinkName><a:modifiedOn>2025-04-14T10:03:19.437</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-18T17:53:54.1</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')  &#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, DB_NAME()+convert(Varchar(10),TN.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    "Dokument Numer" = TN.TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TN.TrN_Opis,''''), ''(BRAK)''),&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TN.TrN_NumerPelny,0,CHARINDEX(''/'',TN.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TN.TrN_NumerPelny,CHARINDEX(''/'',TN.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TN.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    Waluta = CASE WHEN TN.TrN_Waluta = '''' THEN @Wal ELSE TN.TrN_Waluta END, &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1, &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa,&#xD;
       CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
       "Produkt Kod" = Twr_Kod, &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
        "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
      "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc, "Numer Obcy " = TN.Trn_NumerObcy &#xD;
       ,ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza]&#xD;
       ,CAST(TrE_Ilosc/ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza]&#xD;
       ,CAST(TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
       ,WartosciGran AS [Zakupy Koszty Graniczne]&#xD;
&#xD;
       /*&#xD;
       ----------DATY POINT&#xD;
       ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-'')&#xD;
       */&#xD;
       ----------DATY ANALIZY&#xD;
       ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TN.TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TN.TrN_DataOpe), "Data Operacji Rok" = YEAR(TN.TrN_DataOpe)&#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataWys)*/ &#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TN.TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TN.TrN_DataWys), "Data Wystawienia Rok" = YEAR(TN.TrN_DataWys)&#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TN.TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TN.TrN_Termin), "Termin Płatności Rok" = YEAR(TN.TrN_Termin) &#xD;
       ,"Data Analizy" = GETDATE()&#xD;
       ----------KONTEKSTY&#xD;
        ,29047 [Dokument Numer __PROCID__Zakupy__], TN.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
        ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
        ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
        ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag TN&#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TN.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TN.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TN.TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TN.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TN.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TN.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TN.TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN (Select SUM(TE.TrE_WartoscNetto) WartosciGran, TE2.TRE_TREID elemID&#xD;
         From cdn.Tranag &#xD;
        LEFT JOIN cdn.Traelem TE ON  TRN_trnid = TE.TrE_TrNId&#xD;
        join cdn.TraElem TE2 ON te2.tre_treid=te.TrE_ZwrId&#xD;
         where trn_rodzaj IN (301008,301009,301018)&#xD;
         GROUP BY  TE2.TRE_TREID)KwoGran ON Tre_TreId = elemID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TN.TrN_TypDokumentu=301&#xD;
AND TN.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0 '&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKDhSAWKi1n1vIC6aYs3D/90/mh8ToH17VguNlqUK5BA5GNn+AmEyuQ8h/4w64ELevu9NzW6YwRfqeSkr1leW+5RABV/t7MQzsJU7vawcEyKBXJVrmS8SVFBoXUGYfY3JUhka0xwvR182Utbo9GUVp7IJr6zTyE/D7</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Numer Obcy " caption="Numer Obcy " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DELIVERY_GLN (K)" caption="Dokument Atrybut DELIVERY_GLN (K)" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAaAAAABwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIaW1Byb2R1a3QgS29kXS5bR1JBQklFX09HUl0HAh1bUHJvZHVrdCBLb2RdLltJR0xBS0lfQ1lQUllTXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIZW1Byb2R1a3QgS29kXS5bSkFCxYFPTklFXQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCIltQcm9kdWt0IEtvZF0uW8WBQcWDQ1VDSCBETyBQScWBWV0HAhtbUHJvZHVrdCBLb2RdLltOT8W7WUNFX0VMLl0HAhpbUHJvZHVrdCBLb2RdLltPREtfTEnFmkNJXQcCFltQcm9kdWt0IEtvZF0uW1BBTEVUQV0HAhxbUHJvZHVrdCBLb2RdLltQSUVMxJhHTkFDSkFdBwIcW1Byb2R1a3QgS29kXS5bUEnFgUFfRUxFS1RSXQcCH1tQcm9kdWt0IEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0HAhpbUHJvZHVrdCBLb2RdLltQUk9KX0FSQ0hJXQcCHFtQcm9kdWt0IEtvZF0uW1BST0pfWklFTEVOSV0HAhxbUHJvZHVrdCBLb2RdLltST1pEUkFCTklBQ1pdBwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCGFtQcm9kdWt0IEtvZF0uW1NBRFpPTktJXQcCF1tQcm9kdWt0IEtvZF0uW1NFS0FUT1JdBwIYW1Byb2R1a3QgS29kXS5bU0tSWllOS0FdBwIWW1Byb2R1a3QgS29kXS5bU1RPSkFLXQcCF1tQcm9kdWt0IEtvZF0uW1NaUEFERUxdBwIXW1Byb2R1a3QgS29kXS5bVFVKRV8zTF0HAiFbUHJvZHVrdCBLb2RdLltVU8WBVUdBIFNFUldJU09XQV0HAhpbUHJvZHVrdCBLb2RdLltaRVNUQVdfT0dSXQcCGFtQcm9kdWt0IEtvZF0uW1pJRU1JQV81Xf////8AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True"&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="122" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Grupa"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="130" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c0" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Ilość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Ilość" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="1" expanded="True" width="122" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" width="130" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Kontrahent Grupa" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje produkty wraz z listą kontrahentów, od których zostały kupione.</a:description><a:id>103</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>2.04 Zakupy produktu od kontrahentów</a:mainLinkName><a:modifiedOn>2025-04-14T10:03:28.41</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-15T10:37:19.523</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')  &#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, DB_NAME()+convert(Varchar(10),TN.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    "Dokument Numer" = TN.TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TN.TrN_Opis,''''), ''(BRAK)''),&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TN.TrN_NumerPelny,0,CHARINDEX(''/'',TN.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TN.TrN_NumerPelny,CHARINDEX(''/'',TN.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TN.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    Waluta = CASE WHEN TN.TrN_Waluta = '''' THEN @Wal ELSE TN.TrN_Waluta END, &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1, &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa,&#xD;
       CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
       "Produkt Kod" = Twr_Kod, &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
        "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
      "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc, "Numer Obcy " = TN.Trn_NumerObcy &#xD;
       ,ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza]&#xD;
       ,CAST(TrE_Ilosc/ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza]&#xD;
       ,CAST(TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
       ,WartosciGran AS [Zakupy Koszty Graniczne]&#xD;
&#xD;
       /*&#xD;
       ----------DATY POINT&#xD;
       ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-'')&#xD;
       */&#xD;
       ----------DATY ANALIZY&#xD;
       ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TN.TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TN.TrN_DataOpe), "Data Operacji Rok" = YEAR(TN.TrN_DataOpe)&#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataWys)*/ &#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TN.TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TN.TrN_DataWys), "Data Wystawienia Rok" = YEAR(TN.TrN_DataWys)&#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TN.TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TN.TrN_Termin), "Termin Płatności Rok" = YEAR(TN.TrN_Termin) &#xD;
       ,"Data Analizy" = GETDATE()&#xD;
       ----------KONTEKSTY&#xD;
        ,29047 [Dokument Numer __PROCID__Zakupy__], TN.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
        ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
        ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
        ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag TN&#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TN.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TN.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TN.TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TN.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TN.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TN.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TN.TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN (Select SUM(TE.TrE_WartoscNetto) WartosciGran, TE2.TRE_TREID elemID&#xD;
         From cdn.Tranag &#xD;
        LEFT JOIN cdn.Traelem TE ON  TRN_trnid = TE.TrE_TrNId&#xD;
        join cdn.TraElem TE2 ON te2.tre_treid=te.TrE_ZwrId&#xD;
         where trn_rodzaj IN (301008,301009,301018)&#xD;
         GROUP BY  TE2.TRE_TREID)KwoGran ON Tre_TreId = elemID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TN.TrN_TypDokumentu=301&#xD;
AND TN.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0 '&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKDhSAWKi1n1vIC6aYs3D/90/mh8ToH17VguNlqUK5BA5GNn+AmEyuQ8h/4w64ELevu9NzW6YwRfqeSkr1leW+5RABV/t7MQzsJU7vawcEyKBXJVrmS8SVFBoXUGYfY3JUhka0xwvR182Utbo9GUVp7IJr6zTyE/D7</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Numer Obcy " caption="Numer Obcy " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DELIVERY_GLN (K)" caption="Dokument Atrybut DELIVERY_GLN (K)" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Pie3D" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="True" position="Outside" columnIndent="0" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="0" spacingHorizontal="0" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Zakupy dla grup kontrahentów" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;diagram3D perspective="20" angleX="-60" angleY="0" angleZ="0" zoom="100" /&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX /&gt;&#xD;
    &lt;axisY /&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wYAAAAHAh1bS29udHJhaGVudCBHcnVwYV0uW0RPU1RBV0NZXQcCKVtLb250cmFoZW50IEdydXBhXS5bS09TWlRZICAgICAgICAgICAgICBdBwIgW0tvbnRyYWhlbnQgR3J1cGFdLltPREJfRklOQUxOSV0HAilbS29udHJhaGVudCBHcnVwYV0uW09EQl9GSVJNWSAgICAgICAgICAgXQcCHFtLb250cmFoZW50IEdydXBhXS5bVUUgLSBHQl0HAh9bS29udHJhaGVudCBHcnVwYV0uW1VFLSBOSUVNQ1ld</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showMeasuresOnRows="False"&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="109" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Grupa"&gt;&lt;header fontName="Tahoma" fontSize="8" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="124" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="0" expanded="True" width="124" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="1" expanded="True" width="109" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Grupa" index="0" expanded="True" width="150" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" allowDisplayImages="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje wartość zakupów od poszczególnych grup kontrahentów.</a:description><a:id>104</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>2.05 Zakupy w podziale na grupy kontrahentów</a:mainLinkName><a:modifiedOn>2025-04-14T10:03:36.013</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-15T10:39:36.393</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')  &#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, DB_NAME()+convert(Varchar(10),TN.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    "Dokument Numer" = TN.TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TN.TrN_Opis,''''), ''(BRAK)''),&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TN.TrN_NumerPelny,0,CHARINDEX(''/'',TN.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TN.TrN_NumerPelny,CHARINDEX(''/'',TN.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TN.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    Waluta = CASE WHEN TN.TrN_Waluta = '''' THEN @Wal ELSE TN.TrN_Waluta END, &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1, &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa,&#xD;
       CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
       "Produkt Kod" = Twr_Kod, &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
        "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
      "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc, "Numer Obcy " = TN.Trn_NumerObcy &#xD;
       ,ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza]&#xD;
       ,CAST(TrE_Ilosc/ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza]&#xD;
       ,CAST(TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
       ,WartosciGran AS [Zakupy Koszty Graniczne]&#xD;
&#xD;
       /*&#xD;
       ----------DATY POINT&#xD;
       ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-'')&#xD;
       */&#xD;
       ----------DATY ANALIZY&#xD;
       ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TN.TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TN.TrN_DataOpe), "Data Operacji Rok" = YEAR(TN.TrN_DataOpe)&#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataWys)*/ &#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TN.TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TN.TrN_DataWys), "Data Wystawienia Rok" = YEAR(TN.TrN_DataWys)&#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TN.TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TN.TrN_Termin), "Termin Płatności Rok" = YEAR(TN.TrN_Termin) &#xD;
       ,"Data Analizy" = GETDATE()&#xD;
       ----------KONTEKSTY&#xD;
        ,29047 [Dokument Numer __PROCID__Zakupy__], TN.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
        ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
        ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
        ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag TN&#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TN.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TN.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TN.TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TN.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TN.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TN.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TN.TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN (Select SUM(TE.TrE_WartoscNetto) WartosciGran, TE2.TRE_TREID elemID&#xD;
         From cdn.Tranag &#xD;
        LEFT JOIN cdn.Traelem TE ON  TRN_trnid = TE.TrE_TrNId&#xD;
        join cdn.TraElem TE2 ON te2.tre_treid=te.TrE_ZwrId&#xD;
         where trn_rodzaj IN (301008,301009,301018)&#xD;
         GROUP BY  TE2.TRE_TREID)KwoGran ON Tre_TreId = elemID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TN.TrN_TypDokumentu=301&#xD;
AND TN.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0 '&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKDhSAWKi1n1vIC6aYs3D/90/mh8ToH17VguNlqUK5BA5GNn+AmEyuQ8h/4w64ELevu9NzW6YwRfqeSkr1leW+5RABV/t7MQzsJU7vawcEyKBXJVrmS8SVFBoXUGYfY3JUhka0xwvR182Utbo9GUVp7IJr6zTyE/D7</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Numer Obcy " caption="Numer Obcy " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DELIVERY_GLN (K)" caption="Dokument Atrybut DELIVERY_GLN (K)" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;chart visible="True" type="Pie3D" palette="In A Fog" paletteBaseColor="0" style="In A Fog" dataVertical="True" grandTotals="False" subTotals="False" onlySelected="False" showParametersValues="False"&gt;&#xD;
  &lt;appearance color="White" fillMode="Gradient" secondColor="#BDD3FF" gradientMode="TopToBottom" /&gt;&#xD;
  &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
  &lt;pointLabels visible="True" position="Outside" columnIndent="0" shadowVisible="False" shadowColor="#000000" shadowSize="2" lineVisible="True" lineLength="10" lineStyle="Solid" lineThickness="1" lineColor="" overlapping="None" indent="-1"&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="False" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="" borderSize="1" /&gt;&#xD;
    &lt;appearance color="" fillMode="Solid" /&gt;&#xD;
  &lt;/pointLabels&gt;&#xD;
  &lt;legend visible="True" direction="TopToBottom" alignmentVertical="Center" alignmentHorizontal="RightOutside" spacingVertical="2" spacingHorizontal="2" limitsVertical="100" limitsHorizontal="100"&gt;&#xD;
    &lt;appearance color="White" fillMode="Gradient" secondColor="LightGrey" gradientMode="TopToBottom" /&gt;&#xD;
    &lt;font fontName="Tahoma" fontSize="8" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;border borderVisible="True" borderColor="Gray" borderSize="1" /&gt;&#xD;
  &lt;/legend&gt;&#xD;
  &lt;titles&gt;&#xD;
    &lt;title text="Zakupy dla grup towarów" visible="True" dock="Top" alignment="Center" indent="0"&gt;&#xD;
      &lt;font fontName="Tahoma" fontSize="18" fontColor="" antialiasing="True" /&gt;&#xD;
    &lt;/title&gt;&#xD;
  &lt;/titles&gt;&#xD;
  &lt;diagram3D perspective="20" angleX="-60" angleY="0" angleZ="0" zoom="100" /&gt;&#xD;
  &lt;axis&gt;&#xD;
    &lt;axisX /&gt;&#xD;
    &lt;axisY /&gt;&#xD;
  &lt;/axis&gt;&#xD;
  &lt;axisRangeValues /&gt;&#xD;
  &lt;axisScrollingRangeValues /&gt;&#xD;
&lt;/chart&gt;</a:textData><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wgAAAAHAiNbUHJvZHVrdCBHcnVwYSBQb3ppb20gMV0uW1JPxZpMSU5ZXQcCJFtQcm9kdWt0IEdydXBhIFBvemlvbSAxXS5bQUtDRVNPUklBXQcCIltQcm9kdWt0IEdydXBhIFBvemlvbSAxXS5bU1BSWsSYVF0HAiJbUHJvZHVrdCBHcnVwYSBQb3ppb20gMV0uW0RPREFUS0ldBwIlW1Byb2R1a3QgR3J1cGEgUG96aW9tIDFdLltPUEFLT1dBTklBXQcCIltQcm9kdWt0IEdydXBhIFBvemlvbSAxXS5bWkVTVEFXWV0HAiJbUHJvZHVrdCBHcnVwYSBQb3ppb20gMV0uW1VTxYFVR0ldBwIpW1Byb2R1a3QgR3J1cGEgUG96aW9tIDFdLltHcnVwYSBHxYLDs3duYV0=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True"&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="117" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Ilość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8" width="169" top="10" topType="TopAbsolute" dataField="Zakupy Wartość" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Ilość" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" width="117" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Grupa Poziom 1" index="0" expanded="True" width="169" top="10" topType="TopAbsolute" dataField="Zakupy Wartość" detailCaptionVisible="False"&gt;&lt;sortBy dataFieldName="Zakupy Wartość" /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje wartość zakupów produktów w rozbiciu na grupy produktów.</a:description><a:id>105</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>2.06 Zakupy w podziale na grupy towarów</a:mainLinkName><a:modifiedOn>2025-04-14T10:03:44.743</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-07-21T14:19:35.403</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), &#xD;
&#xD;
	"Dokument Numer" = TrN_NumerPelny, &#xD;
	29047 [Dokument Numer __PROCID__Zakupy__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, &#xD;
	&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, &#xD;
	20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	&#xD;
	"Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),	   &#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	   "Kontrahent Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Opiekun" = CASE &#xD;
								WHEN Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       &#xD;
	   "Produkt Nazwa" = Twr_Nazwa, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   &#xD;
	   "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],&#xD;
	   &#xD;
	   "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
WHERE&#xD;
TrN_TypDokumentu=301&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM3AIWZU/6OpQkKyN+6B1FNMEH/FHa55V/ecPXpX/BUjHtJLSEPAoaOz0m4LtlIb+wpH5P043Oa+kgMAsaY0OKuST/EiWUayO8ZjAldU/1S0tOwWQAax0nx8tZHXMox//h5YSCOe+2kvO2hLcJRvXBfiUtToqa23oHf7grDsTti4f</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAKAAAABwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSS1VTXQcCFltLb250cmFoZW50IEtvZF0uW0xBU10HAhpbS29udHJhaGVudCBLb2RdLltBTF9LT01QXQcCFltLb250cmFoZW50IEtvZF0uW0NQTl0HAhhbS29udHJhaGVudCBLb2RdLltCTEVJTV0HAhhbS29udHJhaGVudCBLb2RdLltBTE9aQV0HAh5bS29udHJhaGVudCBLb2RdLltFTEVLVFJPV05JQV0HAhtbS29udHJhaGVudCBLb2RdLltLT1dBTFNLSV0HAhhbS29udHJhaGVudCBLb2RdLltTVElMTF0HAhlbS29udHJhaGVudCBLb2RdLltLT0xBU0Fd/////wAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions&gt;&#xD;
    &lt;format ref="Kontrahent Nazwa"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="254" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Kontrahent Kod"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="128" top="10" topType="TopAbsolute" dataField="Zakupy Wartość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Kontrahent Grupa"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Zakupy Wartość"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="123" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Grupa Poziom 1"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
  &lt;/formatOptions&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields&gt;&#xD;
    &lt;data fieldName="Zakupy Wartość" index="0" expanded="True" sortMode="default" order="ascending" width="123" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
  &lt;/dataFields&gt;&#xD;
  &lt;rowFields&gt;&#xD;
    &lt;row fieldName="Kontrahent Nazwa" index="1" expanded="True" sortMode="default" order="ascending" width="254" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
    &lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="displayText" order="descending" width="128" top="10" topType="TopAbsolute" dataField="Zakupy Wartość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy dataFieldName="Zakupy Wartość" /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
  &lt;/rowFields&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields&gt;&#xD;
    &lt;filter fieldName="Kontrahent Grupa" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
    &lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
  &lt;/filterFields&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę 10 kontrahentów, od których zrobiono zakupy o największej wartości.</a:description><a:id>106</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>2.07 Kontrahenci z największą sumą zakupów wartościowo</a:mainLinkName><a:modifiedOn>2014-06-02T13:50:09.503</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-04T11:02:24.897</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), &#xD;
&#xD;
	"Dokument Numer" = TrN_NumerPelny, &#xD;
	29047 [Dokument Numer __PROCID__Zakupy__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, &#xD;
	&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, &#xD;
	20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	&#xD;
	"Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),	   &#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	   "Kontrahent Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Opiekun" = CASE &#xD;
								WHEN Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       &#xD;
	   "Produkt Nazwa" = Twr_Nazwa, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   &#xD;
	   "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],&#xD;
	   &#xD;
	   "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
WHERE&#xD;
TrN_TypDokumentu=301&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM3AIWZU/6OpQkKyN+6B1FNMEH/FHa55V/ecPXpX/BUjHtJLSEPAoaOz0m4LtlIb+wpH5P043Oa+kgMAsaY0OKuST/EiWUayO8ZjAldU/1S0tOwWQAax0nx8tZHXMox//h5YSCOe+2kvO2hLcJRvXBfiUtToqa23oHf7grDsTti4f</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAKAAAABwIZW0tvbnRyYWhlbnQgS29kXS5bTUFSS1VTXQcCFltLb250cmFoZW50IEtvZF0uW0xBU10HAhpbS29udHJhaGVudCBLb2RdLltBTF9LT01QXQcCGFtLb250cmFoZW50IEtvZF0uW0JMRUlNXQcCGFtLb250cmFoZW50IEtvZF0uW0FMT1pBXQcCHFtLb250cmFoZW50IEtvZF0uW0JJVVJPV0lFQ10HAhhbS29udHJhaGVudCBLb2RdLltTVElMTF0HAhZbS29udHJhaGVudCBLb2RdLltDUE5dBwIbW0tvbnRyYWhlbnQgS29kXS5bS09XQUxTS0ldBwIZW0tvbnRyYWhlbnQgS29kXS5bS09MQVNBXf////8AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&#xD;
  &lt;sparklines /&gt;&#xD;
  &lt;customMeasures /&gt;&#xD;
  &lt;formatOptions&gt;&#xD;
    &lt;format ref="Kontrahent Nazwa"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="254" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Kontrahent Kod"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="128" top="10" topType="TopAbsolute" dataField="Zakupy Ilość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Kontrahent Grupa"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Zakupy Ilość"&gt;&#xD;
      &lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="n2" /&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="112" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
    &lt;format ref="Produkt Grupa Poziom 1"&gt;&#xD;
      &lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&#xD;
      &lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
      &lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&#xD;
    &lt;/format&gt;&#xD;
  &lt;/formatOptions&gt;&#xD;
  &lt;formatRules /&gt;&#xD;
  &lt;dataFields&gt;&#xD;
    &lt;data fieldName="Zakupy Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="112" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/data&gt;&#xD;
  &lt;/dataFields&gt;&#xD;
  &lt;rowFields&gt;&#xD;
    &lt;row fieldName="Kontrahent Nazwa" index="1" expanded="True" sortMode="default" order="ascending" width="254" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
    &lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="displayText" order="descending" width="128" top="10" topType="TopAbsolute" dataField="Zakupy Ilość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&#xD;
      &lt;sortBy dataFieldName="Zakupy Ilość" /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/row&gt;&#xD;
  &lt;/rowFields&gt;&#xD;
  &lt;columnFields /&gt;&#xD;
  &lt;filterFields&gt;&#xD;
    &lt;filter fieldName="Kontrahent Grupa" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
    &lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&#xD;
      &lt;sortBy /&gt;&#xD;
      &lt;orderedMembers /&gt;&#xD;
      &lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&#xD;
        &lt;excluded /&gt;&#xD;
      &lt;/filters&gt;&#xD;
      &lt;measuresFilter /&gt;&#xD;
    &lt;/filter&gt;&#xD;
  &lt;/filterFields&gt;&#xD;
&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę 10 kontrahentów, od których kupiono największą ilość towarów.</a:description><a:id>107</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>2.08 Kontrahenci z największą sumą zakupów ilościowo</a:mainLinkName><a:modifiedOn>2014-06-02T13:50:17.487</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-04T10:51:59.6</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
	SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
		BEGIN&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
			EXEC(@sql)&#xD;
			&#xD;
			SET @sql = N'UPDATE #tmpTwrGr&#xD;
				SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
			EXEC(@sql)&#xD;
		END&#xD;
    ELSE&#xD;
		BEGIN &#xD;
    		SET @sql = N'UPDATE c&#xD;
				SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
					ELSE CAST(p.kod AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
			EXEC(@sql)&#xD;
	&#xD;
			SET @sql = N'UPDATE c&#xD;
				SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
					CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
					ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
				FROM #tmpTwrGr c&#xD;
				LEFT JOIN #tmpTwrGr p&#xD;
				ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
				EXEC(@sql)&#xD;
		END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
	set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
	set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.KnA_WartoscTxt END  &#xD;
		FROM CDN.KntAtrybuty ATR &#xD;
		JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
		WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.DAt_WartoscTxt END  &#xD;
		FROM CDN.DokAtrybuty ATR &#xD;
		JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
		WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'         &#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
	IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
	IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
	SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
	SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
		SET [' + CAST(@atrybut_kod AS nvarchar) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE ATR.TwA_WartoscTxt END &#xD;
		FROM CDN.TwrAtrybuty ATR &#xD;
		JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
		WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
	EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_Typ = 1&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', &#xD;
	CASE &#xD;
		WHEN TrE_Atr1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr1_Wartosc END &#xD;
		WHEN TrE_Atr2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr2_Wartosc END &#xD;
		WHEN TrE_Atr3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr3_Wartosc END  &#xD;
		WHEN TrE_Atr4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr4_Wartosc END  &#xD;
		WHEN TrE_Atr5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,TrE_Atr5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') ELSE TrE_Atr5_Wartosc END  &#xD;
		ELSE ''(NIEPRZYPISANE)''&#xD;
	END AS [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar) + ']'&#xD;
	FETCH NEXT FROM atrybut_cursor&#xD;
	INTO @atrybut_id, @atrybut_kod, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = DB_NAME(), &#xD;
&#xD;
	"Dokument Numer" = TrN_NumerPelny, &#xD;
	29047 [Dokument Numer __PROCID__Zakupy__], TrN_TrNId [Dokument Numer __ORGID__],&#xD;
	&#xD;
	Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, &#xD;
	&#xD;
	"Kontrahent Nazwa" = pod1.Pod_Nazwa1, &#xD;
	20201 [Kontrahent Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Nazwa __ORGID__],&#xD;
	&#xD;
	"Kontrahent Kod" = pod1.Pod_Kod, &#xD;
	20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Kod __ORGID__],&#xD;
&#xD;
	"Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
	"Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),	   &#xD;
	   "Kontrahent Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
	   "Kontrahent Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Opiekun" = CASE &#xD;
								WHEN Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
								WHEN Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
								ELSE ''(NIEPRZYPISANE)'' END,&#xD;
	   "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       &#xD;
	   "Produkt Nazwa" = Twr_Nazwa, &#xD;
	   25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],&#xD;
	   &#xD;
	   "Produkt Kod" = Twr_Kod, &#xD;
	   25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],&#xD;
	   &#xD;
	   "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
	   "Produkt Typ" = CASE &#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
			WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
			WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
	   END,&#xD;
       "Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/, &#xD;
       "Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe), &#xD;
       "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc'&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
	 LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
	 LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
	 LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND Knt_OpiekunTyp = 8 &#xD;
	 LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
	 LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId &#xD;
WHERE&#xD;
TrN_TypDokumentu=301&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RbVWbtiiR5a1y8r/v6+U6FL5ZTTF5waQY6SdZe8UjQFTtGtxZN/1iKDhSAWKi1n1vIC6aYs3D/90/mh8ToH17VguNlqUK5BA5GNn+AmEyuQ8h/4w64ELevu9NzW6YwRfqeSkr1leW+5RABV/t7MQzsJU7vawcEyKBXJVrmS8SVFBoXUGYfY3JUhka0xwvR182Utbo9GUVp7IJr6zTyE/D7</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut DOSTAWCA REAL" caption="Kontrahent Atrybut DOSTAWCA REAL" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut GWARANCJA" caption="Kontrahent Atrybut GWARANCJA" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut AP" caption="Produkt Atrybut AP" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut TPN" caption="Produkt Atrybut TPN" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KL" caption="Produkt Atrybut KL" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut GEANT NR ART." caption="Produkt Atrybut GEANT NR ART." type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR ART. REAL" caption="Produkt Atrybut NR ART. REAL" type="attribute" formatString="### ##0.00" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAaAAAABwIeW1Byb2R1a3QgS29kXS5bR1JBQklFX0xJxZpDSUVdBwIaW1Byb2R1a3QgS29kXS5bR1JBQklFX09HUl0HAh1bUHJvZHVrdCBLb2RdLltJR0xBS0lfQ1lQUllTXQcCIFtQcm9kdWt0IEtvZF0uW0lHTEFLSV9KQcWBT1dJRUNdBwIZW1Byb2R1a3QgS29kXS5bSkFCxYFPTklFXQcCGFtQcm9kdWt0IEtvZF0uW0tPUkFfUzgwXQcCIltQcm9kdWt0IEtvZF0uW8WBQcWDQ1VDSCBETyBQScWBWV0HAhtbUHJvZHVrdCBLb2RdLltOT8W7WUNFX0VMLl0HAhpbUHJvZHVrdCBLb2RdLltPREtfTEnFmkNJXQcCFltQcm9kdWt0IEtvZF0uW1BBTEVUQV0HAhxbUHJvZHVrdCBLb2RdLltQSUVMxJhHTkFDSkFdBwIcW1Byb2R1a3QgS29kXS5bUEnFgUFfRUxFS1RSXQcCH1tQcm9kdWt0IEtvZF0uW1BJxYFBX1NQQUxJTk9XQV0HAhpbUHJvZHVrdCBLb2RdLltQUk9KX0FSQ0hJXQcCHFtQcm9kdWt0IEtvZF0uW1BST0pfWklFTEVOSV0HAhxbUHJvZHVrdCBLb2RdLltST1pEUkFCTklBQ1pdBwIZW1Byb2R1a3QgS29kXS5bUsOTxbtBX1BOXQcCGFtQcm9kdWt0IEtvZF0uW1NBRFpPTktJXQcCF1tQcm9kdWt0IEtvZF0uW1NFS0FUT1JdBwIYW1Byb2R1a3QgS29kXS5bU0tSWllOS0FdBwIWW1Byb2R1a3QgS29kXS5bU1RPSkFLXQcCF1tQcm9kdWt0IEtvZF0uW1NaUEFERUxdBwIXW1Byb2R1a3QgS29kXS5bVFVKRV8zTF0HAiFbUHJvZHVrdCBLb2RdLltVU8WBVUdBIFNFUldJU09XQV0HAhpbUHJvZHVrdCBLb2RdLltaRVNUQVdfT0dSXQcCGFtQcm9kdWt0IEtvZF0uW1pJRU1JQV81Xf////8AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True"&gt;&lt;whatifMeasures&gt;&lt;whatifMeasure uniqueName="[Measures].[f8a8d82a-4a07-4dfb-841f-9681c7793ff4]" caption="Średnia Cena Zakupu" formula="(Zakupy Ilość = 0 ? 0 : Zakupy Wartość/Zakupy Ilość)" description="" summaryType="Sum" /&gt;&lt;/whatifMeasures&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Nazwa"&gt;&lt;header fontName="Tahoma" fontSize="8" width="188" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="180" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Ilość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 0"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="Produkt Grupa Poziom 1"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;format ref="[Measures].[f8a8d82a-4a07-4dfb-841f-9681c7793ff4]"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="117" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Ilość" index="2" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;data fieldName="[Measures].[f8a8d82a-4a07-4dfb-841f-9681c7793ff4]" index="0" expanded="True" width="117" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.Object"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Nazwa" index="1" expanded="True" width="188" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="0" expanded="True" width="180" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Produkt Grupa Poziom 0" index="0" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;filter fieldName="Produkt Grupa Poziom 1" index="1" expanded="True" width="100" top="0" topType="TopAbsolute" dataField="" detailCaptionVisible="False"&gt;&lt;sortBy /&gt;&lt;filters showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę produktów wraz ze średnią ceną, po której zostały kupione.</a:description><a:id>108</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>2.09 Średnia cena zakupu produktu</a:mainLinkName><a:modifiedOn>2014-06-02T13:50:28.01</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>false</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-04T10:58:28.59</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')  &#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, DB_NAME()+convert(Varchar(10),TN.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    "Dokument Numer" = TN.TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TN.TrN_Opis,''''), ''(BRAK)''),&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TN.TrN_NumerPelny,0,CHARINDEX(''/'',TN.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TN.TrN_NumerPelny,CHARINDEX(''/'',TN.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TN.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    Waluta = CASE WHEN TN.TrN_Waluta = '''' THEN @Wal ELSE TN.TrN_Waluta END, &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1, &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa,&#xD;
       CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
       "Produkt Kod" = Twr_Kod, &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
        "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
      "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc, "Numer Obcy " = TN.Trn_NumerObcy &#xD;
       ,ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza]&#xD;
       ,CAST(TrE_Ilosc/ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza]&#xD;
       ,CAST(TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
       ,WartosciGran AS [Zakupy Koszty Graniczne]&#xD;
&#xD;
       /*&#xD;
       ----------DATY POINT&#xD;
       ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-'')&#xD;
       */&#xD;
       ----------DATY ANALIZY&#xD;
       ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TN.TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TN.TrN_DataOpe), "Data Operacji Rok" = YEAR(TN.TrN_DataOpe)&#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataWys)*/ &#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TN.TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TN.TrN_DataWys), "Data Wystawienia Rok" = YEAR(TN.TrN_DataWys)&#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TN.TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TN.TrN_Termin), "Termin Płatności Rok" = YEAR(TN.TrN_Termin) &#xD;
       ,"Data Analizy" = GETDATE()&#xD;
       ----------KONTEKSTY&#xD;
        ,29047 [Dokument Numer __PROCID__Zakupy__], TN.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
        ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
        ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
        ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag TN&#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TN.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TN.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TN.TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TN.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TN.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TN.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TN.TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN (Select SUM(TE.TrE_WartoscNetto) WartosciGran, TE2.TRE_TREID elemID&#xD;
         From cdn.Tranag &#xD;
        LEFT JOIN cdn.Traelem TE ON  TRN_trnid = TE.TrE_TrNId&#xD;
        join cdn.TraElem TE2 ON te2.tre_treid=te.TrE_ZwrId&#xD;
         where trn_rodzaj IN (301008,301009,301018)&#xD;
         GROUP BY  TE2.TRE_TREID)KwoGran ON Tre_TreId = elemID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TN.TrN_TypDokumentu=301&#xD;
AND TN.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0 '&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM3AIWZU/6OpQkKyN+6B1FNMEH/FHa55V/ecPXpX/BUjHtJLSEPAoaOz0m4LtlIb+wpH5P043Oa+kgMAsaY0OKuST/EiWUayO8ZjAldU/1S0tOwWQAax0nx8tZHXMox//h5YSCOe+2kvO2hLcJRvXBfiUtToqa23oHf7grDsTti4f</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Numer Obcy " caption="Numer Obcy " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DELIVERY_GLN (K)" caption="Dokument Atrybut DELIVERY_GLN (K)" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAMAAAABwIcW0RhdGEgT3BlcmFjamkgTWllc2nEhWNdLlsxXQcCHFtEYXRhIE9wZXJhY2ppIE1pZXNpxIVjXS5bMl0HAhxbRGF0YSBPcGVyYWNqaSBNaWVzacSFY10uWzNdBwIcW0RhdGEgT3BlcmFjamkgTWllc2nEhWNdLls0XQcCHFtEYXRhIE9wZXJhY2ppIE1pZXNpxIVjXS5bNV0HAhxbRGF0YSBPcGVyYWNqaSBNaWVzacSFY10uWzZdBwIcW0RhdGEgT3BlcmFjamkgTWllc2nEhWNdLls3XQcCHFtEYXRhIE9wZXJhY2ppIE1pZXNpxIVjXS5bOF0HAhxbRGF0YSBPcGVyYWNqaSBNaWVzacSFY10uWzldBwIdW0RhdGEgT3BlcmFjamkgTWllc2nEhWNdLlsxMF0HAh1bRGF0YSBPcGVyYWNqaSBNaWVzacSFY10uWzExXQcCHVtEYXRhIE9wZXJhY2ppIE1pZXNpxIVjXS5bMTJd/////wAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="180" top="25" topType="TopAbsolute" dataField="Zakupy Ilość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Miesiąc"&gt;&lt;header fontName="Tahoma" fontSize="8" width="137" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Ilość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;cellTotals fontName="Segoe UI" fontSize="8" bold="True" /&gt;&lt;grandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;cellGrandTotal fontName="Segoe UI" fontSize="8" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="displayText" order="descending" width="180" top="25" topType="TopAbsolute" dataField="Zakupy Ilość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy dataFieldName="Zakupy Ilość" /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Data Operacji Miesiąc" index="0" expanded="True" sortMode="default" order="ascending" width="137" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę najczęściej kupowanych produktów w danym miesiącu.</a:description><a:id>109</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>2.10 Najczęściej kupowane produkty miesięcznie</a:mainLinkName><a:modifiedOn>2025-04-14T10:04:42.69</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2011-08-04T11:00:55.247</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów &#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')  &#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, DB_NAME()+convert(Varchar(10),TN.TrN_TrNID) [Liczba Dokumentów],&#xD;
&#xD;
    "Dokument Numer" = TN.TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TN.TrN_Opis,''''), ''(BRAK)''),&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TN.TrN_NumerPelny,0,CHARINDEX(''/'',TN.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TN.TrN_NumerPelny,CHARINDEX(''/'',TN.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TN.TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    Waluta = CASE WHEN TN.TrN_Waluta = '''' THEN @Wal ELSE TN.TrN_Waluta END, &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1, &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa,&#xD;
       CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
       "Produkt Kod" = Twr_Kod, &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
        "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
      "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc, "Numer Obcy " = TN.Trn_NumerObcy &#xD;
       ,ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza]&#xD;
       ,CAST(TrE_Ilosc/ISNULL(NULLIF((Twr_JMPrzelicznikL/ISNULL(NULLIF(Twr_JMPrzelicznikM,0),1)),0),1) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza]&#xD;
       ,CAST(TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
       ,WartosciGran AS [Zakupy Koszty Graniczne]&#xD;
&#xD;
       /*&#xD;
       ----------DATY POINT&#xD;
       ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-'')&#xD;
       */&#xD;
       ----------DATY ANALIZY&#xD;
       ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TN.TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TN.TrN_DataOpe), "Data Operacji Rok" = YEAR(TN.TrN_DataOpe)&#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_DataWys)*/ &#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TN.TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TN.TrN_DataWys), "Data Wystawienia Rok" = YEAR(TN.TrN_DataWys)&#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TN.TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TN.TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TN.TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TN.TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TN.TrN_Termin), "Termin Płatności Rok" = YEAR(TN.TrN_Termin) &#xD;
       ,"Data Analizy" = GETDATE()&#xD;
       ----------KONTEKSTY&#xD;
        ,29047 [Dokument Numer __PROCID__Zakupy__], TN.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
        ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
        ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
        ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
&#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag TN&#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TN.TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TN.TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TN.TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TN.TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TN.TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TN.TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TN.TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN (Select SUM(TE.TrE_WartoscNetto) WartosciGran, TE2.TRE_TREID elemID&#xD;
         From cdn.Tranag &#xD;
        LEFT JOIN cdn.Traelem TE ON  TRN_trnid = TE.TrE_TrNId&#xD;
        join cdn.TraElem TE2 ON te2.tre_treid=te.TrE_ZwrId&#xD;
         where trn_rodzaj IN (301008,301009,301018)&#xD;
         GROUP BY  TE2.TRE_TREID)KwoGran ON Tre_TreId = elemID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TN.TrN_TypDokumentu=301&#xD;
AND TN.TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0 '&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM3AIWZU/6OpQkKyN+6B1FNMEH/FHa55V/ecPXpX/BUjHtJLSEPAoaOz0m4LtlIb+wpH5P043Oa+kgMAsaY0OKuST/EiWUayO8ZjAldU/1S0tOwWQAax0nx8tZHXMox//h5YSCOe+2kvO2hLcJRvXBfiUtToqa23oHf7grDsTti4f</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Numer Obcy " caption="Numer Obcy " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut DELIVERY_GLN (K)" caption="Dokument Atrybut DELIVERY_GLN (K)" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAEAAAABwIcW0RhdGEgT3BlcmFjamkgS3dhcnRhxYJdLlsxXQcCHFtEYXRhIE9wZXJhY2ppIEt3YXJ0YcWCXS5bMl0HAhxbRGF0YSBPcGVyYWNqaSBLd2FydGHFgl0uWzNdBwIcW0RhdGEgT3BlcmFjamkgS3dhcnRhxYJdLls0Xf////8AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="260" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8" width="180" top="25" topType="TopAbsolute" dataField="Zakupy Ilość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Kwartał"&gt;&lt;header fontName="Tahoma" fontSize="8" width="140" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Data Operacji Rok"&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Ilość"&gt;&lt;cells fontName="Microsoft Sans Serif" fontSize="8" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="1" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="displayText" order="descending" width="180" top="25" topType="TopAbsolute" dataField="Zakupy Ilość" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy dataFieldName="Zakupy Ilość" /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Data Operacji Kwartał" index="0" expanded="True" sortMode="default" order="ascending" width="140" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields&gt;&lt;column fieldName="Data Operacji Rok" index="0" expanded="True" sortMode="default" order="ascending" width="100" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Int32"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/column&gt;&lt;/columnFields&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę najczęściej kupowanych produktów w danym kwartale.</a:description><a:id>110</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>2.11 Najczęściej kupowane produkty kwartalnie</a:mainLinkName><a:modifiedOn>2025-04-14T10:04:50.22</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport>4</a:predefinedReport><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-05-17T15:40:30.753</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Analiza ZD według kontrahentów&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'          &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, &#xD;
    "Dokument Numer" = TrN_NumerPelny, &#xD;
    "Dokument Symbol" = dd.DDf_Symbol,&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
       "Dokument Status" = CASE &#xD;
            WHEN TrN_ZwroconoCalaIlosc IS NULL THEN ''Bufor''&#xD;
            WHEN TrN_ZwroconoCalaIlosc = 1 THEN ''(PUSTY)''&#xD;
            WHEN TrN_ZwroconoCalaIlosc = 2 THEN ''W realizacji'' &#xD;
            WHEN TrN_ZwroconoCalaIlosc = 3 THEN ''Zrealizowano'' &#xD;
            WHEN TrN_ZwroconoCalaIlosc = 4 THEN ''Zamknięto'' &#xD;
       END,&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),    &#xD;
       Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END,     &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1,     &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_NIP END,&#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
&#xD;
                                reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
        ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], &#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,    &#xD;
       "Produkt Nazwa" = Twr_Nazwa, &#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],     &#xD;
       "Produkt Kod" = Twr_Kod,        &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)), "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
       "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc,&#xD;
       "Zakupy Ilość Zrealizowana" = CASE WHEN TrN_ZwroconoCalaIlosc = 3 THEN TrE_Ilosc ELSE ISNULL(-IP.Ilosc,0) END&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Termin Dostawy" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'')&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
     ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/&#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TrN_DataOpe), "Data Wystawienia Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Wystawienia Rok" = YEAR(TrN_DataOpe) &#xD;
       ,"Termin Dostawy Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-''), "Termin Dostawy Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ &#xD;
       ,"Termin Dostawy Miesiąc" = MONTH(TrN_DataWys), "Termin Dostawy Kwartał" = DATEPART(quarter, TrN_DataWys), "Termin Dostawy Rok" = YEAR(TrN_DataWys) &#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TrN_Termin), "Termin Płatności Rok" = YEAR(TrN_Termin)&#xD;
&#xD;
       ----------KONTEKSTY&#xD;
    ,25042 [Dokument Numer __PROCID__ZD__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
       &#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TrN_TrNID&#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID &#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID  &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT OUTER JOIN (&#xD;
           SELECT TE1.TrE_TrEID [TREID], SUM(TrS_Ilosc) [Ilosc]&#xD;
           FROM CDN.TraElem TE1&#xD;
           JOIN CDN.TraSElem ON TrS_TrEID = TE1.TrE_TrEID&#xD;
           WHERE TrS_TrEIdWydania &lt;&gt; 0&#xD;
           GROUP BY TE1.TrE_TrEID&#xD;
     ) AS IP ON TrE_TrEId = IP.TREID     &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0 &#xD;
WHERE&#xD;
TrN_TypDokumentu=309&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Status" caption="Dokument Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka1" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji1" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka1" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji1" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość Zrealizowana" caption="Zakupy Ilość Zrealizowana" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wQAAAAHAhpbS29udHJhaGVudCBLb2RdLltBTF9LT01QXQcCG1tLb250cmFoZW50IEtvZF0uW0tPV0FMU0tJXQcCFltLb250cmFoZW50IEtvZF0uW0xBU10HAhlbS29udHJhaGVudCBLb2RdLltNQVJLVVNd</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Ilość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Ilość" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje kontrahentów wraz z listą produktów od nich kupionych na podstawie dokumentów zamówień dostawcy.</a:description><a:id>111</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>2.12 Analiza ZD według kontrahentów</a:mainLinkName><a:modifiedOn>2025-04-14T10:04:58.167</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>6</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2012-08-22T10:21:02.48</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Analiza ZD według kontrahentów&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'          &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END  &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, &#xD;
    "Dokument Numer" = TrN_NumerPelny, &#xD;
    "Dokument Symbol" = dd.DDf_Symbol,&#xD;
    ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)'') [Dokument Opis],&#xD;
       "Dokument Status" = CASE &#xD;
            WHEN TrN_ZwroconoCalaIlosc IS NULL THEN ''Bufor''&#xD;
            WHEN TrN_ZwroconoCalaIlosc = 1 THEN ''(PUSTY)''&#xD;
            WHEN TrN_ZwroconoCalaIlosc = 2 THEN ''W realizacji'' &#xD;
            WHEN TrN_ZwroconoCalaIlosc = 3 THEN ''Zrealizowano'' &#xD;
            WHEN TrN_ZwroconoCalaIlosc = 4 THEN ''Zamknięto'' &#xD;
       END,&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),    &#xD;
       Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END,     &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1,     &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_NIP END,&#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
&#xD;
                                reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
&#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
        ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], &#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,    &#xD;
       "Produkt Nazwa" = Twr_Nazwa, &#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],     &#xD;
       "Produkt Kod" = Twr_Kod,        &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)), "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
       "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc,&#xD;
       "Zakupy Ilość Zrealizowana" = CASE WHEN TrN_ZwroconoCalaIlosc = 3 THEN TrE_Ilosc ELSE ISNULL(-IP.Ilosc,0) END&#xD;
    /*&#xD;
    ----------DATY POINT&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Termin Dostawy" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'')&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
     ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/&#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TrN_DataOpe), "Data Wystawienia Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Wystawienia Rok" = YEAR(TrN_DataOpe) &#xD;
       ,"Termin Dostawy Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-''), "Termin Dostawy Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ &#xD;
       ,"Termin Dostawy Miesiąc" = MONTH(TrN_DataWys), "Termin Dostawy Kwartał" = DATEPART(quarter, TrN_DataWys), "Termin Dostawy Rok" = YEAR(TrN_DataWys) &#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TrN_Termin), "Termin Płatności Rok" = YEAR(TrN_Termin)&#xD;
&#xD;
       ----------KONTEKSTY&#xD;
    ,25042 [Dokument Numer __PROCID__ZD__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
       &#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TrN_TrNID&#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID &#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID  &#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
     LEFT OUTER JOIN (&#xD;
           SELECT TE1.TrE_TrEID [TREID], SUM(TrS_Ilosc) [Ilosc]&#xD;
           FROM CDN.TraElem TE1&#xD;
           JOIN CDN.TraSElem ON TrS_TrEID = TE1.TrE_TrEID&#xD;
           WHERE TrS_TrEIdWydania &lt;&gt; 0&#xD;
           GROUP BY TE1.TrE_TrEID&#xD;
     ) AS IP ON TrE_TrEId = IP.TREID     &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0 &#xD;
WHERE&#xD;
TrN_TypDokumentu=309&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Status" caption="Dokument Status" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka1" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji1" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka1" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji1" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość Zrealizowana" caption="Zakupy Ilość Zrealizowana" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut PIELĘGNACJA" caption="Produkt Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut KOLOR" caption="Produkt Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut DATA WAŻNOŚCI" caption="Produkt Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut NR SERYJNY" caption="Produkt Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ATRYBUTZASOBU" caption="Produkt Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut ROZMIAR" caption="Produkt Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut PIELĘGNACJA" caption="Pozycja Atrybut PIELĘGNACJA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut KOLOR" caption="Pozycja Atrybut KOLOR" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut DATA WAŻNOŚCI" caption="Pozycja Atrybut DATA WAŻNOŚCI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut NR SERYJNY" caption="Pozycja Atrybut NR SERYJNY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUTZASOBU" caption="Pozycja Atrybut ATRYBUTZASOBU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ROZMIAR" caption="Pozycja Atrybut ROZMIAR" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAAAAAAA/////wEAAAAHAhxbRG9rdW1lbnQgTnVtZXJdLltaRC83LzIwMDhd</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Dokument Status"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Produkt Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Ilość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Ilość Zrealizowana"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" format="n2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Ilość" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Ilość Zrealizowana" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Produkt Kod" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Dokument Status" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;included&gt;&lt;value uniqueName="W realizacji" /&gt;&lt;/included&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje listę dokumentów ZD w realizacji razem z ilością towaru, która została już zrealizowana.</a:description><a:id>112</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>2.13 Analiza ZD zrealizowanych</a:mainLinkName><a:modifiedOn>2025-04-14T10:05:05.227</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>6</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2013-02-12T12:04:27.163</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Faktur nierozliczonych&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
        END    &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'           &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
        END&#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Wyliczanie statusu rozliczenia&#xD;
--SELECT TrN_TrNId [NagID], &#xD;
--CASE &#xD;
--  WHEN Z.BZd_Rozliczono=1 AND Z.BZd_Rozliczono2=1 THEN 'Nierozliczony' &#xD;
--  WHEN Z.BZd_Rozliczono=2 THEN 'Rozliczony' &#xD;
--  WHEN Z.BZd_Rozliczono=1 AND Z.BZd_Rozliczono2=2 THEN 'Częściowo Rozliczony' &#xD;
--  WHEN (Z.BZd_Rozliczono=0 AND Z.BZd_Rozliczono2=0) OR TrN_BlokadaPlatnosci = 1 THEN 'Nie podlega'&#xD;
--  WHEN Z.BZd_Rozliczono=2 AND Z.BZd_Rozliczono2=2 THEN 'Rozliczany w całości'&#xD;
--ELSE '(BRAK)' END [StatusRoz]&#xD;
--INTO #tmpRozliczenia&#xD;
--FROM CDN.TraNag&#xD;
--JOIN(&#xD;
--  SELECT BZd_DokumentID, MIN(BZd_Rozliczono) [BZd_Rozliczono], MAX(BZd_Rozliczono2) [BZd_Rozliczono2]&#xD;
--  FROM CDN.BnkZdarzenia&#xD;
--  WHERE BZd_DokumentTyp = 1&#xD;
--  GROUP BY BZd_DokumentID&#xD;
--)Z ON Z.BZd_DokumentID = TrN_TrNID&#xD;
SELECT TrN_TrNId [NagID], &#xD;
CASE&#xD;
    WHEN Z.Rozliczono &lt; 10 OR TrN_BlokadaPlatnosci = 1 THEN 'Nie podlega'  &#xD;
    WHEN Z.Rozliczono &lt; 100 THEN 'Rozliczony' &#xD;
    WHEN Z.Rozliczono &lt; 1000 THEN 'Częściowo Rozliczony' &#xD;
    WHEN Z.Rozliczono % 1000 &lt;&gt; 0 THEN 'Częściowo Rozliczony' &#xD;
    WHEN Z.Rozliczono &lt; 10000 THEN 'Nierozliczony' &#xD;
ELSE '(BRAK)' END [StatusRoz]&#xD;
INTO #tmpRozliczenia&#xD;
FROM CDN.TraNag&#xD;
JOIN(&#xD;
    SELECT BZd_DokumentID, &#xD;
    SUM(CASE&#xD;
        WHEN BZd_Rozliczono = 0 THEN 1   &#xD;
        WHEN BZd_Rozliczono = 2 THEN 10&#xD;
        WHEN BZd_Rozliczono = 1 AND BZd_Rozliczono2 = 2 THEN 100&#xD;
        WHEN BZd_Rozliczono = 1 AND BZd_Rozliczono2 = 1 THEN 1000&#xD;
    END) [Rozliczono]&#xD;
    FROM CDN.BnkZdarzenia&#xD;
    WHERE BZd_DokumentTyp = 1&#xD;
    GROUP BY BZd_DokumentID&#xD;
)Z ON Z.BZd_DokumentID = TrN_TrNID&#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
DECLARE @select VARCHAR(MAX), @select2 VARCHAR(MAX);&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3) &#xD;
Set @Wal = cdn.Waluta('''')&#xD;
&#xD;
SELECT &#xD;
    --Wymiary&#xD;
    BAZ.Baz_Nazwa [Baza Firmowa], &#xD;
    F.TrN_NumerPelny [Dokument Numer],      &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    ISNULL(NULLIF(F.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(NULLIF(F.TrN_Waluta, ''''), @Wal) [Dokument Waluta],&#xD;
    ISNULL(kat.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna], ISNULL(kat.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa],    &#xD;
    knt.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    knt.Pod_Nazwa1 + knt.Pod_Nazwa2 [Kontrahent Pierwotny Nazwa], &#xD;
    ISNULL(NULLIF(knt.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto], &#xD;
    ISNULL(NULLIF(knt.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], &#xD;
    ISNULL(NULLIF(knt.Pod_NIP, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP], &#xD;
    ISNULL(NULLIF(knt.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(knt.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
    ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    CASE &#xD;
        WHEN opk.Knt_OpiekunTyp = 3 THEN ISNULL(opp.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN opk.Knt_OpiekunTyp = 8 THEN ISNULL(op.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE opk.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
            CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN Z2.DokRoz&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Dokument Rozliczający Numer],&#xD;
    ISNULL(StatusRoz, ''Nie dotyczy'') [Status Rozliczenia],     &#xD;
    ''(NIEPRZYPISANY)'' as [Zakład Symbol],&#xD;
    ''(NIEPRZYPISANY)'' as [Zakład Nazwa Firmy],&#xD;
    --Miary&#xD;
    F.TrN_RazemNetto [Zakupy Wartość], F.TrN_RazemBrutto [Zakupy Wartość Brutto], &#xD;
    F.TrN_RazemNettoWal [Zakupy Wartość Waluta], F.TrN_RazemBruttoWal [Zakupy Wartość Brutto Waluta],&#xD;
    NULLIF(ISNULL(Z.BZd_KwotaSys - Z.BZd_KwotaRozSys - Z.BZd_KwotaNPSys, F.TrN_RazemBrutto),0) [Kwota Nierozliczona], &#xD;
    NULLIF(ISNULL(Z.BZd_Kwota - Z.BZd_KwotaRoz - Z.BZd_KwotaNP, F.TrN_RazemBruttoWal),0) [Kwota Nierozliczona Waluta],&#xD;
    NULL [Kwota Rozliczona], NULL [Kwota Rozliczona Waluta], Z.BZd_KwotaNPSys [Kwota Nie Podlega], Z.BZd_KwotaNP [Kwota Nie Podlega Waluta],&#xD;
    CASE &#xD;
        WHEN StatusRoz = ''Nie podlega'' THEN NULL&#xD;
        WHEN StatusRoz &lt;&gt; ''Rozliczony'' THEN CASE WHEN DATEDIFF(DAY,F.TrN_Termin,GETDATE()) &lt; 0 THEN 0 ELSE DATEDIFF(DAY,F.TrN_Termin,GETDATE()) END&#xD;
        ELSE NULL&#xD;
    END [Liczba Dni Przeterminowania] &#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN REPLACE(CONVERT(VARCHAR(10), Z2.BZd_DataRoz, 111), ''/'', ''-'')&#xD;
            END [Data Rozliczenia]&#xD;
        ,REPLACE(CONVERT(VARCHAR(10), F.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Zakupu] &#xD;
*/  &#xD;
    ----------DATY ANALIZY&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN REPLACE(CONVERT(VARCHAR(10), Z2.BZd_DataRoz, 111), ''/'', ''-'')&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Dzień]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN CONVERT(VARCHAR(10), MONTH(Z2.BZd_DataRoz))&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Miesiąc]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN CONVERT(VARCHAR(10), DATEPART(quarter, Z2.BZd_DataRoz))&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Kwartał]&#xD;
    ,CASE &#xD;
        WHEN Z2.LZD = 1 AND StatusRoz = ''Rozliczony'' THEN CONVERT(VARCHAR(10), YEAR(Z2.BZd_DataRoz))&#xD;
        WHEN Z2.LZD &gt; 1 THEN ''(Wiele)''&#xD;
        ELSE''(Nierozliczony)'' &#xD;
    END [Data Rozliczenia Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, F.TrN_Termin) / 7 * 7 + 3)+6) / 7 [Termin Płatności Tydzień Roku], MONTH(F.TrN_Termin) [Termin Płatności Miesiąc]&#xD;
    ,DATEPART(quarter, F.TrN_Termin) [Termin Płatności Kwartał], YEAR(F.TrN_Termin) [Termin Płatności Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Zakupu Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, F.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Zakupu Tydzień Roku], MONTH(F.TrN_DataOpe) [Data Zakupu Miesiąc] &#xD;
    ,DATEPART(quarter, F.TrN_DataOpe) [Data Zakupu Kwartał], YEAR(F.TrN_DataOpe) [Data Zakupu Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,29047 [Dokument Numer __PROCID__Zakupy__], F.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], knt.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__], '''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], knt.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    &#xD;
    &#xD;
    ' + @atrybuty + @atrybutyDok&#xD;
     &#xD;
SET @select2 = ' &#xD;
FROM &#xD;
    CDN.TraNag F&#xD;
    LEFT JOIN #tmpSeria ser ON F.TrN_DDfId = DDf_DDfID&#xD;
    LEFT JOIN CDN.DokDefinicje dd ON F.TrN_DDfId = dd.DDf_DDfID &#xD;
    JOIN CDN.PodmiotyView knt ON F.TrN_PodID = knt.Pod_PodId AND F.TrN_PodmiotTyp = knt.Pod_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci opk ON F.TrN_PodID = opk.Knt_KntId AND F.TrN_PodmiotTyp = 1&#xD;
    LEFT JOIN cdn.PodmiotyView opp ON opk.Knt_OpiekunId = opp.Pod_PodId AND opk.Knt_OpiekunTyp = opp.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op ON opk.Knt_OpiekunId = op.Ope_OpeId AND opk.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON F.TrN_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON F.TrN_OpeModID = mod.Ope_OpeId&#xD;
    LEFT JOIN CDN.Kategorie kat ON F.TrN_KatID = Kat_KatID&#xD;
    LEFT JOIN CDN.FormyPlatnosci ON F.TrN_FPlId = FPl_FPlId&#xD;
    LEFT JOIN (&#xD;
        SELECT BZd_DokumentID, SUM(BZd_KwotaSys) [BZd_KwotaSys], SUM(BZd_KwotaRozSys) [BZd_KwotaRozSys], SUM(BZd_Kwota) [BZd_Kwota], SUM(BZd_KwotaRoz) [BZd_KwotaRoz],&#xD;
        SUM(CASE WHEN BzD_Rozliczono = 0 THEN BZd_KwotaSys ELSE 0 END) [BZd_KwotaNPSys], SUM(CASE WHEN BzD_Rozliczono = 0 THEN BZd_Kwota ELSE 0 END) [BZd_KwotaNP]&#xD;
        FROM CDN.BnkZdarzenia&#xD;
        WHERE BZd_DokumentTyp = 1&#xD;
        GROUP BY BZd_DokumentID &#xD;
    )Z ON Z.BZd_DokumentID = F.TrN_TrNID&#xD;
    LEFT JOIN (&#xD;
        SELECT BZd_DokumentID, MAX(BZd_DataRoz) [BZd_DataRoz], COUNT(L.BRK_BRKID) + COUNT(P.BRK_BRKID) [LZD], &#xD;
        MAX(CASE WHEN BZd_BZdID = L.BRK_LDokID THEN L.BRK_PNumer ELSE P.BRK_LNumer END) [DokRoz]&#xD;
        FROM CDN.BnkZdarzenia&#xD;
        LEFT JOIN CDN.BnkRozKwoty L ON BZd_BZdID = L.BRK_LDokID AND L.BRK_LDokTyp = 1&#xD;
        LEFT JOIN CDN.BnkRozKwoty P ON BZd_BZdID = P.BRK_PDokID AND P.BRK_PDokTyp = 1&#xD;
        WHERE BZd_DokumentTyp = 1&#xD;
        GROUP BY BZd_DokumentID&#xD;
    )Z2 ON Z2.BZd_DokumentID = F.TrN_TrNID&#xD;
    LEFT JOIN #tmpRozliczenia ON NagId = F.TrN_trNID&#xD;
    LEFT JOIN #tmpKonAtr KonAtr ON knt.Pod_PodId = KonAtr.KnA_PodmiotId AND knt.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
    LEFT JOIN #tmpDokAtr DokAtr ON F.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on knt.Pod_GlID = pod5.Pod_PodId and knt.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE &#xD;
    F.TrN_TypDokumentu=301&#xD;
    AND F.TrN_Bufor&lt;&gt;-1&#xD;
    &#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
    --Wymiary&#xD;
    BAZ.Baz_Nazwa [Baza Firmowa],   &#xD;
    F.TrN_NumerPelny [Dokument Numer], &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(F.TrN_NumerPelny,0,CHARINDEX(''/'',F.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(F.TrN_NumerPelny,CHARINDEX(''/'',F.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
SUBSTRING(convert(varchar,F.TrN_NumerPelny), 0, CHARINDEX(''/'', F.TrN_NumerPelny)) [Dokument Symbol],&#xD;
ISNULL(NULLIF(F.TrN_Opis,''''),''(BRAK)'') [Dokument Opis], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(NULLIF(F.TrN_Waluta, ''''), @Wal) [Dokument Waluta],&#xD;
    ISNULL(kat.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna], ISNULL(kat.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa],    &#xD;
    knt.Pod_Kod [Kontrahent Pierwotny Kod], &#xD;
    knt.Pod_Nazwa1 + knt.Pod_Nazwa2 [Kontrahent Pierwotny Nazwa],   &#xD;
    ISNULL(NULLIF(knt.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto], &#xD;
    ISNULL(NULLIF(knt.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], &#xD;
    ISNULL(NULLIF(knt.Pod_NIP, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(knt.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(knt.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
    ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    CASE &#xD;
        WHEN opk.Knt_OpiekunTyp = 3 THEN ISNULL(opp.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN opk.Knt_OpiekunTyp = 8 THEN ISNULL(op.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun], &#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE opk.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    BRK_PNumer [Dokument Rozliczający Numer], &#xD;
    StatusRoz [Status Rozliczenia],&#xD;
    isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
    isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
    --Miary&#xD;
    NULL [Zakupy Wartość], NULL [Zakupy Wartość Brutto], NULL [Zakupy Wartość Waluta], &#xD;
    NULL [Zakupy Wartość Brutto Waluta], NULL [Kwota Nierozliczona],    NULL [Kwota Nierozliczona Waluta], &#xD;
    BRK_KwotaSysL [Kwota Rozliczona], BRK_Kwota [Kwota Rozliczona Waluta], NULL [Kwota Nie Podlega], NULL [Kwota Nie Podlega Waluta],&#xD;
    CASE WHEN DATEDIFF(DAY,BZd_Termin,BRK_DataDok) &lt; 0 THEN 0 ELSE DATEDIFF(DAY,BZd_Termin,BRK_DataDok) END [Liczba Dni Przeterminowania]&#xD;
/*&#xD;
    ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BRK_DataDok, 111), ''/'', ''-'') [Data Rozliczenia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BZd_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Zakupu] &#xD;
*/      &#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BRK_DataDok, 111), ''/'', ''-'') [Data Rozliczenia Dzień]&#xD;
    ,CONVERT(VARCHAR(10),MONTH(BRK_DataDok)) [Data Rozliczenia Miesiąc], CONVERT(VARCHAR(10),DATEPART(quarter, BRK_DataDok)) [Data Rozliczenia Kwartał] &#xD;
    ,CONVERT(VARCHAR(10),YEAR(BRK_DataDok)) [Data Rozliczenia Rok]   &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BZd_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, BZd_Termin) / 7 * 7 + 3)+6) / 7 [Termin Płatności Tydzień Roku], MONTH(BZd_Termin) [Termin Płatności Miesiąc] &#xD;
    ,DATEPART(quarter, BZd_Termin) [Termin Płatności Kwartał], YEAR(BZd_Termin) [Termin Płatności Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Zakupu Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, F.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Zakupu Tydzień Roku], MONTH(F.TrN_DataOpe) [Data Zakupu Miesiąc]&#xD;
    ,DATEPART(quarter, F.TrN_DataOpe) [Data Zakupu Kwartał], YEAR(F.TrN_DataOpe) [Data Zakupu Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,29047 [Dokument Numer __PROCID__Zakupy__], F.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], knt.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__], '''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], knt.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    &#xD;
    ' &#xD;
    + @atrybuty + @atrybutyDok + ' &#xD;
FROM &#xD;
    CDN.TraNag F&#xD;
LEFT JOIN #tmpSeria ser ON F.TrN_DDfId = DDf_DDfID&#xD;
    JOIN CDN.BnkZdarzenia ON BZd_DokumentID = F.TrN_TrNID AND BZd_DokumentTyp = 1&#xD;
    JOIN CDN.BnkRozKwoty ON BRK_LDokID = BZd_BZdID AND BRK_LDokTyp = 1&#xD;
    JOIN CDN.PodmiotyView knt ON F.TrN_PodID = knt.Pod_PodId AND F.TrN_PodmiotTyp = knt.Pod_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci opk ON F.TrN_PodID = opk.Knt_KntId AND F.TrN_PodmiotTyp = 1&#xD;
    LEFT JOIN cdn.PodmiotyView opp ON opk.Knt_OpiekunId = opp.Pod_PodId AND opk.Knt_OpiekunTyp = opp.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op ON opk.Knt_OpiekunId = op.Ope_OpeId AND opk.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON F.TrN_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON F.TrN_OpeModID = mod.Ope_OpeId&#xD;
    LEFT JOIN CDN.Kategorie kat ON F.TrN_KatID = Kat_KatID&#xD;
    LEFT JOIN CDN.FormyPlatnosci ON F.TrN_FPlId = FPl_FPlId&#xD;
    LEFT JOIN #tmpRozliczenia ON NagId = F.TrN_trNID&#xD;
    LEFT JOIN #tmpKonAtr KonAtr ON knt.Pod_PodId = KonAtr.KnA_PodmiotId AND knt.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
    LEFT JOIN #tmpDokAtr DokAtr ON F.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on knt.Pod_GlID = pod5.Pod_PodId and knt.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp\&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = BRK_ZakID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE &#xD;
    F.TrN_TypDokumentu=301&#xD;
    AND F.TrN_Bufor&lt;&gt;-1&#xD;
    &#xD;
UNION ALL&#xD;
&#xD;
SELECT &#xD;
    --Wymiary&#xD;
    BAZ.Baz_Nazwa [Baza Firmowa],   &#xD;
    F.TrN_NumerPelny [Dokument Numer],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(F.TrN_NumerPelny,0,CHARINDEX(''/'',F.TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(F.TrN_NumerPelny,CHARINDEX(''/'',F.TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
SUBSTRING(convert(varchar,F.TrN_NumerPelny), 0, CHARINDEX(''/'', F.TrN_NumerPelny)) [Dokument Symbol],&#xD;
ISNULL(NULLIF(F.TrN_Opis,''''), ''(BRAK)'') [Dokument Opis], FPl_Nazwa [Forma Płatności],&#xD;
    ISNULL(NULLIF(F.TrN_Waluta, ''''), @Wal) [Dokument Waluta], &#xD;
    ISNULL(kat.Kat_KodOgolny, ''(PUSTA)'') [Kategoria Ogólna], ISNULL(kat.Kat_KodSzczegol, ''(PUSTA)'') [Kategoria Szczegółowa],    &#xD;
    knt.Pod_Kod [Kontrahent Pierwotny Kod],&#xD;
    knt.Pod_Nazwa1 + knt.Pod_Nazwa2 [Kontrahent Pierwotny Nazwa],   &#xD;
    ISNULL(NULLIF(knt.Pod_Miasto, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Miasto], &#xD;
    ISNULL(NULLIF(knt.Pod_Kraj, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Kraj], &#xD;
    ISNULL(NULLIF(knt.Pod_NIP, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny NIP],&#xD;
    ISNULL(NULLIF(knt.Pod_Wojewodztwo, ''''), ''(NIEPRZYPISANE)'') [Kontrahent Pierwotny Województwo], ISNULL(NULLIF(knt.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Pierwotny Grupa], &#xD;
    pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
    pod5.Pod_Kod [Kontrahent Kod], &#xD;
    ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
    ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
    ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj],&#xD;
    ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(NIEPRZYPISANE)'') [Kontrahent NIP],&#xD;
    ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa],&#xD;
    zal.Ope_Kod [Operator Wprowadzający], mod.Ope_Kod [Operator Modyfikujący],&#xD;
    CASE &#xD;
        WHEN opk.Knt_OpiekunTyp = 3 THEN ISNULL(opp.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN opk.Knt_OpiekunTyp = 8 THEN ISNULL(op.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Pierwotny Opiekun],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE opk.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE opk.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
    CASE knt3.Knt_OpiekunTyp&#xD;
        WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
        WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
        ELSE ''(NIEPRZYPISANE)'' &#xD;
    END [Kontrahent Opiekun],&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
    BRK_LNumer [Dokument Rozliczający Numer], &#xD;
    StatusRoz [Status Rozliczenia],&#xD;
    isnull(Zak_Symbol,''(NIEPRZYPISANY)'') as [Zakład Symbol],&#xD;
    isnull(zak_NazwaFirmy,''(NIEPRZYPISANY)'') as [Zakład Nazwa Firmy],&#xD;
    --Miary&#xD;
    NULL [Zakupy Wartość], NULL [Zakupy Wartość Brutto], NULL [Zakupy Wartość Waluta], &#xD;
    NULL [Zakupy Wartość Brutto Waluta], NULL [Kwota Nierozliczona], NULL [Kwota Nierozliczona Waluta],&#xD;
    BRK_KwotaSysP [Kwota Rozliczona], BRK_Kwota [Kwota Rozliczona Waluta], NULL [Kwota Nie Podlega], NULL [Kwota Nie Podlega Waluta],&#xD;
    CASE WHEN DATEDIFF(DAY,BZd_Termin,BRK_DataDok) &lt; 0 THEN 0 ELSE DATEDIFF(DAY,BZd_Termin,BRK_DataDok) END [Liczba Dni Przeterminowania]&#xD;
/*&#xD;
        ----------DATY POINT&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BRK_DataDok, 111), ''/'', ''-'') [Data Rozliczenia]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BZd_Termin, 111), ''/'', ''-'') [Termin Płatności] &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Zakupu] &#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BRK_DataDok, 111), ''/'', ''-'') [Data Rozliczenia Dzień] &#xD;
    ,CONVERT(VARCHAR(10),MONTH(BRK_DataDok)) [Data Rozliczenia Miesiąc], CONVERT(VARCHAR(10),DATEPART(quarter, BRK_DataDok)) [Data Rozliczenia Kwartał] &#xD;
    ,CONVERT(VARCHAR(10),YEAR(BRK_DataDok)) [Data Rozliczenia Rok]   &#xD;
    ,REPLACE(CONVERT(VARCHAR(10), BZd_Termin, 111), ''/'', ''-'') [Termin Płatności Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, BZd_Termin) / 7 * 7 + 3)+6) / 7 [Termin Płatności Tydzień Roku], MONTH(BZd_Termin) [Termin Płatności Miesiąc] &#xD;
    ,DATEPART(quarter, BZd_Termin) [Termin Płatności Kwartał], YEAR(BZd_Termin) [Termin Płatności Rok]&#xD;
    ,REPLACE(CONVERT(VARCHAR(10), F.TrN_DataOpe, 111), ''/'', ''-'') [Data Zakupu Dzień] &#xD;
    ,(datepart(DY, datediff(d, 0, F.TrN_DataOpe) / 7 * 7 + 3)+6) / 7 [Data Zakupu Tydzień Roku], MONTH(F.TrN_DataOpe) [Data Zakupu Miesiąc] &#xD;
    ,DATEPART(quarter, F.TrN_DataOpe) [Data Zakupu Kwartał], YEAR(F.TrN_DataOpe) [Data Zakupu Rok]&#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,29047 [Dokument Numer __PROCID__Zakupy__], F.TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__Kontrahenci__], knt.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], knt.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    &#xD;
    ' &#xD;
    + @atrybuty + @atrybutyDok + ' &#xD;
FROM &#xD;
    CDN.TraNag F&#xD;
LEFT JOIN #tmpSeria ser ON F.TrN_DDfId = DDf_DDfID&#xD;
    JOIN CDN.BnkZdarzenia ON BZd_DokumentID = F.TrN_TrNID AND BZd_DokumentTyp = 1&#xD;
    JOIN CDN.BnkRozKwoty ON BRK_PDokID = BZd_BZdID AND BRK_PDokTyp = 1&#xD;
    JOIN CDN.PodmiotyView knt ON F.TrN_PodID = knt.Pod_PodId AND F.TrN_PodmiotTyp = knt.Pod_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci opk ON F.TrN_PodID = opk.Knt_KntId AND F.TrN_PodmiotTyp = 1&#xD;
    LEFT JOIN cdn.PodmiotyView opp ON opk.Knt_OpiekunId = opp.Pod_PodId AND opk.Knt_OpiekunTyp = opp.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' op ON opk.Knt_OpiekunId = op.Ope_OpeId AND opk.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN ' + @Operatorzy + ' zal ON F.TrN_OpeZalID = zal.Ope_OpeId&#xD;
    LEFT JOIN ' + @Operatorzy + ' mod ON F.TrN_OpeModID = mod.Ope_OpeId&#xD;
    LEFT JOIN CDN.Kategorie kat ON F.TrN_KatID = Kat_KatID&#xD;
    LEFT JOIN CDN.FormyPlatnosci ON F.TrN_FPlId = FPl_FPlId&#xD;
    LEFT JOIN #tmpRozliczenia ON NagId = F.TrN_trNID&#xD;
    LEFT JOIN #tmpKonAtr KonAtr ON knt.Pod_PodId = KonAtr.KnA_PodmiotId AND knt.Pod_PodmiotTyp = KonAtr.KnA_PodmiotTyp&#xD;
    LEFT JOIN #tmpDokAtr DokAtr ON F.TrN_TrNID  = DokAtr.DAt_TrNId&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod5 on knt.Pod_GlID = pod5.Pod_PodId and knt.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT OUTER JOIN CDN.Zaklady on ZAK_ZAkID = BRK_ZakID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE &#xD;
    F.TrN_TypDokumentu=301&#xD;
    AND F.TrN_Bufor&lt;&gt;-1&#xD;
'&#xD;
PRINT(@select + @select2)&#xD;
EXEC(@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpRozliczenia&#xD;
DROP TABLE #tmpSeria&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96gzfYuMpQO2yJQQEhkyxmOvslOn8ASdlUU7ZjrS0O0poY/4wXQcWRsf4yJiGWVcYKrWRlBBo3XI7Sm0kOWyo1NDptWs6RP5gkjHVPFIggnp+/ecm6EknzxBylZSRfP3Pc7XA/HmkgjShWnsgGlkO/SChYbzyIMVge9Mygss1/pBTw==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Waluta" caption="Dokument Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zakupu Dzień" caption="Data Zakupu Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zakupu Tydzień Roku" caption="Data Zakupu Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zakupu Miesiąc" caption="Data Zakupu Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zakupu Kwartał" caption="Data Zakupu Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Zakupu Rok" caption="Data Zakupu Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna" caption="Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa" caption="Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Rozliczający Numer" caption="Dokument Rozliczający Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Dzień" caption="Data Rozliczenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Miesiąc" caption="Data Rozliczenia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Kwartał" caption="Data Rozliczenia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Rok" caption="Data Rozliczenia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Status Rozliczenia" caption="Status Rozliczenia" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto Waluta" caption="Zakupy Wartość Brutto Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nierozliczona" caption="Kwota Nierozliczona" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nierozliczona Waluta" caption="Kwota Nierozliczona Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Rozliczona" caption="Kwota Rozliczona" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Rozliczona Waluta" caption="Kwota Rozliczona Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nie Podlega" caption="Kwota Nie Podlega" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Kwota Nie Podlega Waluta" caption="Kwota Nie Podlega Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania" caption="Liczba Dni Przeterminowania" type="measure" formatString="n0" aggregate="Max" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" caption="Kontrahent Pierwotny Atrybut PROJEKTY PARKI" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut PROJEKTY PARKI" caption="Kontrahent Atrybut PROJEKTY PARKI" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut STATUS" caption="Kontrahent Pierwotny Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut STATUS" caption="Kontrahent Atrybut STATUS" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut PROJEKTY PARKI (K)" caption="Dokument Atrybut PROJEKTY PARKI (K)" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Atrybut STATUS (K)" caption="Dokument Atrybut STATUS (K)" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAMAAAATAAAABwIWW0tvbnRyYWhlbnQgS29kXS5bQURNXQcCGltLb250cmFoZW50IEtvZF0uW0FMX0tPTVBdBwIYW0tvbnRyYWhlbnQgS29kXS5bQUxPWkFdBwIZW0tvbnRyYWhlbnQgS29kXS5bQklHR1VOXQcCHFtLb250cmFoZW50IEtvZF0uW0JJVVJPV0lFQ10HAiRbS29udHJhaGVudCBLb2RdLltCSVVST1dJRUNfU0tBV0lOQV0HAhhbS29udHJhaGVudCBLb2RdLltCTEVJTV0HAhZbS29udHJhaGVudCBLb2RdLltDUE5dBwIeW0tvbnRyYWhlbnQgS29kXS5bRUxFS1RST1dOSUFdBwIZW0tvbnRyYWhlbnQgS29kXS5bS09MQVNBXQcCG1tLb250cmFoZW50IEtvZF0uW0tPV0FMU0tJXQcCFltLb250cmFoZW50IEtvZF0uW0xBU10HAhlbS29udHJhaGVudCBLb2RdLltNQVJLVVNdBwIcW0tvbnRyYWhlbnQgS29kXS5bTUFSU1pBTElLXQcCGVtLb250cmFoZW50IEtvZF0uW1BVQ1XFml0HAhtbS29udHJhaGVudCBLb2RdLltTT0ZUTEFORF0HAhhbS29udHJhaGVudCBLb2RdLltTVElMTF0HAhdbS29udHJhaGVudCBLb2RdLltUUFNBXQcCHltLb250cmFoZW50IEtvZF0uW1RXw5NKT0dSw5NEXf////8AAAAA</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="False" showGrandTotalsForSingleValues="False" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions&gt;&lt;format ref="Dokument Numer"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Kontrahent Kod"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Status Rozliczenia"&gt;&lt;header fontName="Tahoma" fontSize="8.25" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="7.8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Zakupy Wartość Brutto"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="7.8" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;format ref="Kwota Nierozliczona"&gt;&lt;cells fontName="Tahoma" fontSize="8.25" horzAlignment="Far" format="c2" /&gt;&lt;header fontName="Tahoma" fontSize="8.25" horzAlignment="Near" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" /&gt;&lt;totals fontName="Tahoma" fontSize="8.25" horzAlignment="Near" /&gt;&lt;cellTotals fontName="Tahoma" fontSize="8.25" bold="True" /&gt;&lt;grandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;cellGrandTotal fontName="Tahoma" fontSize="8.25" horzAlignment="Far" /&gt;&lt;/format&gt;&lt;/formatOptions&gt;&lt;formatRules /&gt;&lt;dataFields&gt;&lt;data fieldName="Zakupy Wartość" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Zakupy Wartość Brutto" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;data fieldName="Kwota Nierozliczona" index="2" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.Decimal"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/data&gt;&lt;/dataFields&gt;&lt;rowFields&gt;&lt;row fieldName="Dokument Numer" index="1" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;row fieldName="Kontrahent Kod" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True" isLocked="False"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded /&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/row&gt;&lt;/rowFields&gt;&lt;columnFields /&gt;&lt;filterFields&gt;&lt;filter fieldName="Status Rozliczenia" index="0" expanded="True" sortMode="default" order="ascending" width="150" top="0" topType="TopAbsolute" dataField="" topShowOthers="False" detailCaptionVisible="False" allowDisplayImages="False" summaryDisplayType="Default" filterMultipleChoice="True"&gt;&lt;sortBy /&gt;&lt;orderedMembers /&gt;&lt;filters isAllChecked="False" showBlanks="True" type="System.String"&gt;&lt;excluded&gt;&lt;value uniqueName="Rozliczony" /&gt;&lt;/excluded&gt;&lt;/filters&gt;&lt;measuresFilter /&gt;&lt;/filter&gt;&lt;/filterFields&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport prezentuje faktury zakupów oraz dokumenty, które je rozliczają. Znajduje się w nim również status i poziom rozliczenia dokumentu zakupu.</a:description><a:id>113</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>2.14 Faktury nierozliczone</a:mainLinkName><a:modifiedOn>2024-09-06T13:31:25.937</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2020-09-21T11:37:15.25</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów w zakresie dat&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
	JOIN CDN.TraElem ON TrA_TrEId = TrE_TrEID&#xD;
	JOIN CDN.TraNag ON TrE_TrNId = TrN_TrNID&#xD;
WHERE&#xD;
	TrN_TypDokumentu IN (-1,301)&#xD;
	AND TrN_Bufor&lt;&gt;-1&#xD;
	AND TrE_Aktywny&lt;&gt;0&#xD;
	AND TrN_DataOpe BETWEEN @DATAOD AND @DATADO&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    "Dokument Numer" = TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)''),&#xD;
    dd.DDf_Symbol [Dokument Symbol],    &#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END,     &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1,     &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa, &#xD;
       CASE WHEN ISNULL(Twr_ESklep,0)=1 THEN ''Tak'' ELSE ''Nie'' END [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],     &#xD;
       "Produkt Kod" = Twr_Kod,        &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
      "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc, "Numer Obcy " = Trn_NumerObcy&#xD;
      ,CAST(TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
/*     &#xD;
      ----------DATY POINT&#xD;
       ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'')&#xD;
*/&#xD;
      ----------DATY ANALIZY&#xD;
       ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe) &#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/&#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TrN_DataWys), "Data Wystawienia Rok" = YEAR(TrN_DataWys) &#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/ &#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TrN_Termin), "Termin Płatności Rok" = YEAR(TrN_Termin)&#xD;
      &#xD;
      ----------KONTEKSTY&#xD;
       &#xD;
    ,29047 [Dokument Numer __PROCID__Zakupy__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
       &#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu=301&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND TrN_DataOpe BETWEEN convert(datetime,''' + convert(varchar, @DATAOD, 120) + ''', 120)  AND convert(datetime,''' + convert(varchar, @DATADO, 120) + ''', 120)'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJ94McTCLWrfkkhybIpA9E6eh7GvxyEO0vyiXd2c05BdgsDvTt+1BOi77xy696Ik8keic6sAB6IZYYhVA744HGhFqrlwKk4GJbk/bNYA/BADJ2BB1Wh75sVmewQzZgwS8SpDz5STLChzopdYV0ArDoUQ==</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="measure" formatString="" aggregate="DistinctCount" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Numer Obcy " caption="Numer Obcy " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut ATRYBUT POZYCJA" caption="Pozycja Atrybut ATRYBUT POZYCJA" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data od:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początku analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GetData()-30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;Data do:&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data końca analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GetDate()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport umożliwia standardową analizę zakupów dla określonego podczas uruchamiania zakresu dat dokumentów zakupowych.</a:description><a:id>114</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>2.15 Zakupy w zakresie dat</a:mainLinkName><a:modifiedOn>2025-04-14T16:11:25.743</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>1</a:id></a:Context><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2021-05-14T15:53:58.943</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>/*&#xD;
* Raport Zakupów z jednostkami pomocniczymi&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    "Dokument Numer" = TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)''),&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1,     &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa],     &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa,&#xD;
       CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],     &#xD;
       "Produkt Kod" = Twr_Kod,        &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
"Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
         "Zakupy Wartość" = TrE_WartoscNetto, "Zakupy Wartość Brutto" = TrE_WartoscBrutto, "Zakupy Wartość Waluta" = TrE_WartoscNettoWal, "Zakupy Ilość" = TrE_Ilosc, "Numer Obcy " = Trn_NumerObcy    &#xD;
        ,ISNULL(NULLIF(jpom1.TwJZ_JM,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza 1]   &#xD;
    ,ISNULL(NULLIF(jpom2.TwJZ_JM,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza 2]&#xD;
    ,ISNULL(NULLIF(jpom3.TwJZ_JM,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza 3]&#xD;
    ,ISNULL(NULLIF(jpom4.TwJZ_JM,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza 4]&#xD;
    ,ISNULL(NULLIF(jpom5.TwJZ_JM,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza 5]&#xD;
    ,CAST(TrE_Ilosc/(jpom1.TwJZ_JMPrzelicznikL/jpom1.TwJZ_JMPrzelicznikM) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza 1]&#xD;
    ,CAST(TrE_Ilosc/(jpom2.TwJZ_JMPrzelicznikL/jpom2.TwJZ_JMPrzelicznikM) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza 2]&#xD;
    ,CAST(TrE_Ilosc/(jpom3.TwJZ_JMPrzelicznikL/jpom3.TwJZ_JMPrzelicznikM) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza 3]&#xD;
    ,CAST(TrE_Ilosc/(jpom4.TwJZ_JMPrzelicznikL/jpom4.TwJZ_JMPrzelicznikM) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza 4]&#xD;
    ,CAST(TrE_Ilosc/(jpom5.TwJZ_JMPrzelicznikL/jpom5.TwJZ_JMPrzelicznikM) AS Decimal(26,10)) [Zakupy Ilość Jednostka Pomocnicza 5]&#xD;
    ,CAST(TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
/*&#xD;
        ----------DATY POINT&#xD;
      ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'')&#xD;
*/&#xD;
    ----------DATY ANALIZY&#xD;
      ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe) &#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/&#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TrN_DataWys), "Data Wystawienia Rok" = YEAR(TrN_DataWys) &#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TrN_Termin), "Termin Płatności Rok" = YEAR(TrN_Termin) &#xD;
&#xD;
    ----------KONTEKSTY&#xD;
    ,29047 [Dokument Numer __PROCID__Zakupy__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
    ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
    ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
    ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
    ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem ON TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON TrE_PodID=Knt_KntId AND TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON TrE_PodID= pod1.Pod_PodId AND TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN CDN.TwrJmz jpom1 on jpom1.TwJZ_TwrID = Twr_TwrId and jpom1.TwJZ_Lp = 1&#xD;
    LEFT JOIN CDN.TwrJmz jpom2 on jpom2.TwJZ_TwrID = Twr_TwrId and jpom2.TwJZ_Lp = 2&#xD;
    LEFT JOIN CDN.TwrJmz jpom3 on jpom3.TwJZ_TwrID = Twr_TwrId and jpom3.TwJZ_Lp = 3&#xD;
    LEFT JOIN CDN.TwrJmz jpom4 on jpom4.TwJZ_TwrID = Twr_TwrId and jpom4.TwJZ_Lp = 4&#xD;
    LEFT JOIN CDN.TwrJmz jpom5 on jpom5.TwJZ_TwrID = Twr_TwrId and jpom5.TwJZ_Lp = 5&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu=301&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+SoK7znksbZM0zwJratE7ZrmpGGBehZ96iG/ZwwXfP7ZFIn0qVz+tUJztzEE4yYMSoYI5d0tQ3L5vCxSmgondMfdtmo6sliIgTWPbj17BviVUXyPzdkotJkq7igEVPx67QBSiMcx5zyeTJgrs/t+z/BIjq9oHQl3dL1vDiIZ84Ys7b36fBxBgdA</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="BO Rachunku Waluta" caption="BO Rachunku Waluta" type="measure" formatString="" aggregate="Average" /&gt;&#xD;
    &lt;column name="Waluta BO" caption="Waluta BO" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zapisy/Zdarzenia" caption="Zapisy/Zdarzenia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer Pełny" caption="Dokument Numer Pełny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument MPP" caption="Dokument MPP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Status" caption="Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Forma Płatności" caption="Forma Płatności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Raport KB" caption="Raport KB" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="BO Raportu" caption="BO Raportu" type="measure" formatString="c2" aggregate="Max" /&gt;&#xD;
    &lt;column name="BO Rachunku" caption="BO Rachunku" type="measure" formatString="c2" aggregate="Max" /&gt;&#xD;
    &lt;column name="Raport KB Stan" caption="Raport KB Stan" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Ponaglenia Numer" caption="Dokument Ponaglenia Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Ponaglenia Data Wystawienia" caption="Dokument Ponaglenia Data Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Nazwa" caption="Podmiot Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kod" caption="Podmiot Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Typ" caption="Podmiot Pierwotny Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Rodzaj" caption="Podmiot Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Status" caption="Podmiot Pierwotny Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Grupa" caption="Podmiot Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Opiekun" caption="Podmiot Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Planowane/Zrealizowane" caption="Planowane/Zrealizowane" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rejestr" caption="Rejestr" type="attribute" formatString="n2" /&gt;&#xD;
    &lt;column name="Rejestr Akronim" caption="Rejestr Akronim" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Rejestr Symbol" caption="Rejestr Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa" caption="Kategoria Szczegółowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna" caption="Kategoria Ogólna" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Województwo" caption="Podmiot Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Miasto" caption="Podmiot Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny Kraj" caption="Podmiot Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Pierwotny NIP" caption="Podmiot Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Nazwa" caption="Podmiot Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kod" caption="Podmiot Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Województwo" caption="Podmiot Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Miasto" caption="Podmiot Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Kraj" caption="Podmiot Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot NIP" caption="Podmiot NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Grupa" caption="Podmiot Grupa" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Podmiot Kategoria" caption="Podmiot Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Opiekun" caption="Podmiot Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Status" caption="Podmiot Status" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Rodzaj" caption="Podmiot Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Podmiot Typ" caption="Podmiot Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Symbol" caption="Zakład Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakład Nazwa Firmy" caption="Zakład Nazwa Firmy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wystawiający Kod" caption="Operator Wystawiający Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wystawiający Nazwa" caption="Operator Wystawiający Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący Kod" caption="Operator Modyfikujący Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący Nazwa" caption="Operator Modyfikujący Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Stan" caption="Stan" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Dokumentu Dzień" caption="Data Dokumentu Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Rozliczenia Dzień" caption="Data Rozliczenia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Realizacji Dzień" caption="Data Realizacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Termin Zapadalności" caption="Termin Zapadalności" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dni Przeterminowania" caption="Liczba Dni Przeterminowania" type="measure" formatString="n0" aggregate="Average" /&gt;&#xD;
    &lt;column name="Przychód" caption="Przychód" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód" caption="Rozchód" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód Waluta" caption="Przychód Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód Waluta" caption="Rozchód Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo" caption="Saldo" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Waluta" caption="Saldo Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód Nierozliczony" caption="Przychód Nierozliczony" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód Nierozliczony" caption="Rozchód Nierozliczony" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Nierozliczone" caption="Saldo Nierozliczone" type="measure" formatString="c2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Przychód Nierozliczony Waluta" caption="Przychód Nierozliczony Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Rozchód Nierozliczony Waluta" caption="Rozchód Nierozliczony Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Saldo Nierozliczone Waluta" caption="Saldo Nierozliczone Waluta" type="measure" formatString="n2" aggregate="Sum" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" /&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport zawiera informacje o zakupach w firmie. Wartości prezentowane są w walucie systemowej. Ilości prezentowane ją w jednostce podstawowej oraz w pięciu jednostkach pomocniczych.&#xD;
&#xD;
Analizy oparte są o faktury zakupu i dokumenty skojarzone.&#xD;
Niebrane pod uwagę są dokumenty anulowane.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (faktur, paragonów itp.). &#xD;
TraElem - Tabela z elementami dokumentów (faktur, paragonów itp.).</a:description><a:id>115</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language i:nil="true"/><a:mainLinkName>2.16 Zakupy z jednostkami pomocniczymi</a:mainLinkName><a:modifiedOn>2025-04-14T10:05:41.57</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context><a:Context><a:id>4</a:id></a:Context></a:contexts><a:connections/></a:Report><a:Report i:type="a:MdxSqlDevXpressReport"><a:catalogName>katalog</a:catalogName><a:createdOn>2023-06-05T14:43:31.383</a:createdOn><a:cubeName/><a:definitions xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxQuery</b:Key><b:Value><a:binaryData/><a:textData>--ZMIANY&#xD;
--03.07.2023    Monika Płóciennik   Poprawa miar - podział na zasoby&#xD;
--04.07.2023    Monika Płóciennik   Poprawa dzielenia przez 0 przy korektach wartościowych&#xD;
--05.07.2023    Monika Płóciennik   Uwzględnienie podziału na zasoby pozycji dokumentów w buforze&#xD;
&#xD;
/*&#xD;
* Raport Zakupów z atrybutami zasobów&#xD;
* Wersja raportu: 37.0&#xD;
* Wersja baz OPTIMY: 2025.3000&#xD;
* Wersja aplikacji OPTIMA: 2025.3.0&#xD;
*/&#xD;
&#xD;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&#xD;
&#xD;
--Wyliczanie poziomów grup produktów&#xD;
WITH g(gid, gidTyp, kod, gidNumer, grONumer, poziom, sciezka)&#xD;
AS&#xD;
(&#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, 0 as poziom, convert(nvarchar(1024), '') as sciezka&#xD;
      FROM CDN.TwrGrupy&#xD;
      WHERE TwG_TwGID = 0&#xD;
      &#xD;
      UNION ALL&#xD;
      &#xD;
      SELECT TwG_TwGID, TwG_GIDTyp, TwG_Kod, TwG_GIDNumer, TwG_GrONumer, p.poziom + 1 as poziom, convert(nvarchar(1024), p.sciezka + N'\' + c.TwG_Kod) as sciezka&#xD;
      FROM g p&#xD;
      JOIN CDN.TwrGrupy c&#xD;
      ON c.TwG_GrONumer = p.gidNumer &#xD;
      WHERE c.TwG_TwGID &lt;&gt; 0 AND c.TwG_GIDTyp = -16&#xD;
)     &#xD;
&#xD;
SELECT * INTO #tmpTwrGr FROM g&#xD;
&#xD;
DECLARE @poziom int&#xD;
DECLARE @poziom_max int&#xD;
DECLARE @sql nvarchar(max)&#xD;
SELECT @poziom_max = MAX(poziom) FROM #tmpTwrGr&#xD;
SET @poziom = @poziom_max&#xD;
SET @sql = N''&#xD;
&#xD;
WHILE @poziom &gt;= 0  &#xD;
BEGIN&#xD;
    SET @sql = N'ALTER TABLE #tmpTwrGr ADD Poziom' + CAST(@poziom AS nvarchar) + N' nvarchar(50), ONr' + CAST(@poziom AS nvarchar) + N' nvarchar(50)'&#xD;
    EXEC(@sql)&#xD;
    &#xD;
    IF @poziom = @poziom_max &#xD;
        BEGIN&#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET ONr' + CAST(@poziom AS nvarchar) +  '= grONumer '&#xD;
            EXEC(@sql)&#xD;
            &#xD;
            SET @sql = N'UPDATE #tmpTwrGr&#xD;
                SET Poziom' + CAST(@poziom AS nvarchar) + ' = kod'&#xD;
            EXEC(@sql)&#xD;
        END&#xD;
    ELSE&#xD;
        BEGIN &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.Poziom' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.kod AS nvarchar)&#xD;
                    ELSE CAST(p.kod AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
            EXEC(@sql)&#xD;
    &#xD;
            SET @sql = N'UPDATE c&#xD;
                SET c.ONr' + CAST(@poziom AS nvarchar) + N' = (&#xD;
                    CASE WHEN c.poziom &lt;=' + CAST(@poziom AS nvarchar) + N' THEN CAST(c.grONumer AS nvarchar)&#xD;
                    ELSE CAST(p.grONumer AS nvarchar) END)  &#xD;
                FROM #tmpTwrGr c&#xD;
                LEFT JOIN #tmpTwrGr p&#xD;
                ON c.ONr' + CAST(@poziom + 1 AS nvarchar) + '= p.gidNumer '&#xD;
                EXEC(@sql)&#xD;
        END&#xD;
    SET @poziom = @poziom - 1&#xD;
END     &#xD;
&#xD;
declare @select varchar(max)&#xD;
declare @select2 varchar(max)&#xD;
declare @kolumny varchar(max)&#xD;
declare @i int&#xD;
&#xD;
set @kolumny = ''&#xD;
set @i=0&#xD;
while (@i&lt;=@poziom_max)&#xD;
begin&#xD;
    set @kolumny = @kolumny + ',"Produkt Grupa Poziom ' + LTRIM(@i) + '" = CASE WHEN Poz.Poziom' +LTRIM(@i) + ' IS NULL THEN ''(NIEPRZYPISANE)'' ELSE Poz.Poziom' + LTRIM(@i) + ' END'&#xD;
    set @i = @i + 1&#xD;
end&#xD;
&#xD;
--Wyliczanie Atrybutów Kontrahentów&#xD;
DECLARE @atrybut_id int, @atrybut_kod nvarchar(50), @atrybut_typ int, @atrybut_format int, @atrybuty varchar(max), @sqlA nvarchar(max);&#xD;
&#xD;
DECLARE @wersja float;&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT KnA_DeAid FROM CDN.KntAtrybuty)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT KnA_PodmiotId, KnA_PodmiotTyp INTO #tmpKonAtr FROM CDN.KntAtrybuty&#xD;
&#xD;
SET @atrybuty = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpKonAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpKonAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.KnA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.KnA_WartoscTxt,'','',''.'') ELSE ATR.KnA_WartoscTxt END &#xD;
         END  &#xD;
        FROM CDN.KntAtrybuty ATR &#xD;
        JOIN #tmpKonAtr TM ON ATR.KnA_PodmiotId = TM.KnA_PodmiotId AND ATR.KnA_PodmiotTyp = TM.KnA_PodmiotTyp&#xD;
        WHERE ATR.KnA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Pierwotny Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']' &#xD;
    SET @atrybuty = @atrybuty + N', ISNULL(KonAtr1.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Kontrahent Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Dokumentów&#xD;
DECLARE @atrybutyDok varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT DAt_DeAid FROM CDN.DokAtrybuty WHERE DAt_TrNId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT DAt_TrNId INTO #tmpDokAtr FROM CDN.DokAtrybuty&#xD;
&#xD;
SET @atrybutyDok = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 1 BEGIN SET @atrybut_kod = @atrybut_kod + ' (T)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpDokAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpDokAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.DAt_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.DAt_WartoscTxt,'','',''.'') ELSE ATR.DAt_WartoscTxt END &#xD;
          END  &#xD;
        FROM CDN.DokAtrybuty ATR &#xD;
        JOIN #tmpDokAtr TM ON ATR.DAt_TrNId = TM.DAt_TrNId &#xD;
        WHERE ATR.DAt_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyDok = @atrybutyDok + N', ISNULL(DokAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') AS [Dokument Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'         &#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Towarów&#xD;
DECLARE @atrybutyTwr varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TwA_DeAid FROM CDN.TwrAtrybuty WHERE TwA_TwrId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TwA_TwrId INTO #tmpTwrAtr FROM CDN.TwrAtrybuty&#xD;
&#xD;
SET @atrybutyTwr = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpTwrAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpTwrAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TwA_WartoscTxt),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
          ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TwA_WartoscTxt,'','',''.'') ELSE ATR.TwA_WartoscTxt END &#xD;
        END &#xD;
        FROM CDN.TwrAtrybuty ATR &#xD;
        JOIN #tmpTwrAtr TM ON ATR.TwA_TwrId = TM.TwA_TwrId &#xD;
        WHERE ATR.TwA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyTwr = @atrybutyTwr + N', ISNULL(TwrAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Wyliczanie Atrybutów Pozycji&#xD;
DECLARE @atrybutyPoz varchar(max), @atrybutyPoz2 varchar(max);&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in (SELECT DISTINCT TrA_DeAId FROM CDN.TraElemAtr WHERE TrA_TrEId IS NOT NULL)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
&#xD;
OPEN atrybut_cursor;&#xD;
&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
&#xD;
SELECT DISTINCT TrA_TrEId INTO #tmpPozAtr FROM CDN.TraElemAtr&#xD;
&#xD;
SET @atrybutyPoz = ''&#xD;
SET @atrybutyPoz2 = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
    IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
    IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
    SET @sqlA = N'ALTER TABLE #tmpPozAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
    SET @sqlA = N'UPDATE #tmpPozAtr&#xD;
        SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TrA_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
         ELSE CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TrA_Wartosc,'','',''.'') ELSE ATR.TrA_Wartosc END &#xD;
        END  &#xD;
        FROM CDN.TraElemAtr ATR &#xD;
        JOIN #tmpPozAtr TM ON ATR.TrA_TrEId = TM.TrA_TrEId&#xD;
        WHERE ATR.TrA_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
    EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyPoz = @atrybutyPoz + N', ISNULL(PozAtr.[' +  CAST(@atrybut_kod AS nvarchar(50)) + '], ''(NIEPRZYPISANE)'') [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    SET @atrybutyPoz2 = @atrybutyPoz2 + N', ''(NIEPRZYPISANE)'' [Pozycja Atrybut ' + CAST(@atrybut_kod AS nvarchar(50)) + ']'&#xD;
    FETCH NEXT FROM atrybut_cursor&#xD;
    INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Połączenie do tabeli operatorów&#xD;
DECLARE @serwerKonf varchar(max);&#xD;
DECLARE @bazaKonf varchar(max);&#xD;
DECLARE @bazaFirmowa varchar(max);&#xD;
DECLARE @Operatorzy varchar(max);&#xD;
DECLARE @Bazy varchar(max);&#xD;
SET @serwerKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1001)&#xD;
SET @bazaKonf = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1002)&#xD;
SET @bazaFirmowa = (SELECT SYS_Wartosc FROM CDN.SystemCDN WHERE SYS_ID = 1)&#xD;
SET @Operatorzy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Operatorzy]' &#xD;
SET @Bazy = '[' + @serwerKonf + '].[' + @bazaKonf + '].[CDN].[Bazy]' &#xD;
&#xD;
--Tworzenie tabeli z serią dokumentów&#xD;
SELECT DDf_DDfID, CASE &#xD;
     WHEN DDf_Numeracja like '@rejestr%' THEN 5&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 1) = '@rejestr' THEN 1&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 2) = '@rejestr' THEN 2&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 3) = '@rejestr' THEN 3&#xD;
     WHEN PARSENAME(REPLACE(REPLACE(REPLACE(substring(ddf_numeracja,CHARINDEX('/',ddf_numeracja,0)+1,50), '@brak/',''), '/@brak',''), '/', '.'), 4) = '@rejestr' THEN 4&#xD;
END [seria]  INTO #tmpSeria FROM CDN.DokDefinicje&#xD;
&#xD;
    --Wyliczanie Atrybutów Zasobów&#xD;
DECLARE @atrybutyZas varchar(max);&#xD;
&#xD;
SET @wersja = (SELECT CONVERT(float, SYS_Wartosc) FROM CDN.SystemCDN WHERE SYS_ID = 3)&#xD;
&#xD;
SET @sqlA = &#xD;
'DECLARE atrybut_cursor CURSOR FOR&#xD;
SELECT DeA_DeAId, REPLACE(DeA_Kod, '']'', ''_''), DeA_Typ, DeA_Format&#xD;
FROM CDN.DefAtrybuty&#xD;
WHERE DeA_DeAId in &#xD;
(&#xD;
SELECT DISTINCT TsC_Cecha1_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha2_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha3_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha4_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha5_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha6_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha7_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha8_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha9_DeAId FROM CDN.TraSElemCechy&#xD;
UNION ALL&#xD;
SELECT DISTINCT TsC_Cecha10_DeAId FROM CDN.TraSElemCechy&#xD;
)&#xD;
AND DeA_Format &lt;&gt; 5'&#xD;
IF @wersja &gt;= 2013 SET @sqlA = @sqlA + ' AND DeA_AnalizyBI = 1;'&#xD;
EXEC(@sqlA)&#xD;
OPEN atrybut_cursor;&#xD;
FETCH NEXT FROM atrybut_cursor&#xD;
INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
SELECT DISTINCT TsC_TrSID INTO #tmpZasAtr FROM CDN.TraSElemCechy&#xD;
join CDN.TraSElem Trs1 on Trs1.TrS_TrSID = TsC_TrSID&#xD;
join CDN.TraElem on TrE_TrEID = Trs1.TrS_TrEId&#xD;
WHERE &#xD;
Trs1.TrS_DataOpe between convert(datetime,convert(varchar, @DATAOD, 120) , 120) and convert(datetime, convert(varchar, @DATADO, 120) , 120)&#xD;
SET @atrybutyZas = ''&#xD;
&#xD;
WHILE @@FETCH_STATUS = 0&#xD;
BEGIN&#xD;
       IF @atrybut_typ = 2 BEGIN SET @atrybut_kod = @atrybut_kod + ' (K)' END&#xD;
       IF @atrybut_typ = 4 BEGIN SET @atrybut_kod = @atrybut_kod + ' (D)' END&#xD;
       SET @sqlA = N'ALTER TABLE #tmpZasAtr ADD [' + CAST(@atrybut_kod AS nvarchar(50)) + N'] nvarchar(max)'&#xD;
    EXEC(@sqlA)    &#xD;
       SET @sqlA = N'UPDATE #tmpZasAtr&#xD;
             SET [' + CAST(@atrybut_kod AS nvarchar(50)) +  '] = &#xD;
             CASE&#xD;
                WHEN ATR.TsC_Cecha1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha1_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha1_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha1_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha2_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha2_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha2_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha3_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha3_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha3_Wartosc END END &#xD;
                WHEN ATR.TsC_Cecha4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha4_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha4_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha4_Wartosc END END &#xD;
                WHEN ATR.TsC_Cecha5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha5_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha5_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha5_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha6_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha6_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha6_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha6_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha7_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha7_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha7_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha7_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha8_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha8_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha8_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha8_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha9_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha9_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha9_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha9_Wartosc END END&#xD;
                WHEN ATR.TsC_Cecha10_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' THEN  case WHEN ' + convert(varchar,@atrybut_format) + ' = 4 THEN REPLACE(CONVERT(VARCHAR(10), DateAdd(day,convert(int,ATR.TsC_Cecha10_Wartosc),convert(datetime,''28-12-1800'',105)), 111), ''/'', ''-'') &#xD;
                    ELSE  CASE WHEN ' + convert(varchar,@atrybut_format) + ' = 2  THEN REPLACE(ATR.TsC_Cecha10_Wartosc,'','',''.'') ELSE ATR.TsC_Cecha10_Wartosc END END&#xD;
             ELSE ''(NIEPRZYPISANE)'' END&#xD;
             FROM CDN.TraSElemCechy ATR &#xD;
             JOIN #tmpZasAtr TM ON ATR.TsC_TrSID = TM.TsC_TrSID&#xD;
             WHERE ATR.TsC_Cecha1_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha2_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha3_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha4_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha5_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha6_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha7_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha8_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha9_DeAId = ' + CAST(@atrybut_id AS nvarchar) + ' OR &#xD;
             ATR.TsC_Cecha10_DeAId = ' + CAST(@atrybut_id AS nvarchar)&#xD;
       EXEC(@sqlA)    &#xD;
    &#xD;
    SET @atrybutyZas = @atrybutyZas + N', COALESCE(ZasAtr.['+CAST(@atrybut_kod AS nvarchar(50))+'], ZasAtr2.['+CAST(@atrybut_kod AS nvarchar(50))+'], ''(NIEPRZYPISANE)'') AS [Zasoby Produkt Atrybut ' + CAST(@atrybut_kod AS nvarchar(50))+']'&#xD;
    &#xD;
       FETCH NEXT FROM atrybut_cursor&#xD;
       INTO @atrybut_id, @atrybut_kod, @atrybut_typ, @atrybut_format;&#xD;
END&#xD;
CLOSE atrybut_cursor;&#xD;
DEALLOCATE atrybut_cursor;&#xD;
&#xD;
--Właściwe zapytanie&#xD;
set @select = &#xD;
'Declare @Wal VarChar(3); Set @Wal = cdn.Waluta('''')&#xD;
SELECT "Baza Firmowa" = BAZ.Baz_Nazwa, DB_NAME()+convert(Varchar(10),TrN_TrNID) [Liczba Dokumentów],&#xD;
    "Dokument Numer Obcy" = TrN_NumerObcy,&#xD;
    "Dokument Numer" = TrN_NumerPelny, &#xD;
    "Dokument Opis" = ISNULL(NULLIF(TrN_Opis,''''), ''(BRAK)''),&#xD;
    dd.DDf_Symbol [Dokument Symbol],&#xD;
    CASE when isnull(ser.seria,0) = 5 then &#xD;
        substring(TrN_NumerPelny,0,CHARINDEX(''/'',TrN_NumerPelny,0))&#xD;
    ELSE &#xD;
        ISNULL(PARSENAME(REPLACE(substring(TrN_NumerPelny,CHARINDEX(''/'',TrN_NumerPelny,0)+1,50), ''/'', ''.''), ser.seria),''(BRAK)'') &#xD;
    END [Dokument Seria],&#xD;
    CONVERT(VARCHAR(2),DATEPART(HOUR,TrN_TS_Zal))+'':''+''00'' [Dokument Godzina Wystawienia],&#xD;
    Waluta = CASE WHEN TrN_Waluta = '''' THEN @Wal ELSE TrN_Waluta END, &#xD;
    "Kontrahent Pierwotny Nazwa" = pod1.Pod_Nazwa1, &#xD;
    "Kontrahent Pierwotny Kod" = pod1.Pod_Kod, &#xD;
    "Kategoria Szczegółowa z Nagłówka" = ISNULL(kat1.Kat_KodSzczegol, ''(PUSTA)''), "Kategoria Szczegółowa z Pozycji" = ISNULL(kat2.Kat_KodSzczegol, ''(PUSTA)''),&#xD;
    "Kategoria Ogólna z Nagłówka" = ISNULL(kat1.Kat_KodOgolny, ''(PUSTA)''), "Kategoria Ogólna z Pozycji" = ISNULL(kat2.Kat_KodOgolny, ''(PUSTA)''),       &#xD;
       "Kontrahent Pierwotny Województwo" = CASE WHEN pod1.Pod_Wojewodztwo = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Wojewodztwo END, &#xD;
       "Kontrahent Pierwotny Powiat" = CASE WHEN pod1.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Powiat END,&#xD;
       "Kontrahent Pierwotny Gmina" = CASE WHEN pod1.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Gmina END, &#xD;
       "Kontrahent Pierwotny Miasto" = CASE WHEN pod1.Pod_Miasto = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Miasto END, &#xD;
       "Kontrahent Pierwotny Kraj" = CASE WHEN pod1.Pod_Kraj = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod1.Pod_Kraj END, &#xD;
       "Kontrahent Pierwotny NIP" = CASE WHEN pod1.Pod_NIP = '''' THEN ''(BRAK)'' ELSE pod1.Pod_NIP END, &#xD;
       "Kontrahent Pierwotny Grupa" = COALESCE(NULLIF(pod1.Pod_Grupa, ''''), ''Pozostali''),&#xD;
              "Kontrahent Pierwotny Opiekun" = CASE &#xD;
                                WHEN knt.Knt_OpiekunTyp = 3 THEN ISNULL(pod2.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                WHEN knt.Knt_OpiekunTyp = 8 THEN ISNULL(opk.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
                                ELSE ''(NIEPRZYPISANE)'' END,&#xD;
    reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Pierwotny Rodzaj],&#xD;
        DB_NAME()+''_''+convert(Varchar(10),pod5.pod_PodmiotTyp)+''_''+convert(Varchar(10),pod5.Pod_PodId)  [Liczba Kontrahentów], &#xD;
        pod5.Pod_Nazwa1 [Kontrahent Nazwa], &#xD;
        pod5.Pod_Kod [Kontrahent Kod], &#xD;
        ISNULL(NULLIF(pod5.Pod_Wojewodztwo, ''''),''(NIEPRZYPISANE)'') [Kontrahent Województwo],&#xD;
        "Kontrahent Powiat" = CASE WHEN pod5.Pod_Powiat = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Powiat END,&#xD;
        "Kontrahent Gmina" = CASE WHEN pod5.Pod_Gmina = '''' THEN ''(NIEPRZYPISANE)'' ELSE pod5.Pod_Gmina END, &#xD;
        ISNULL(NULLIF(pod5.Pod_Miasto, ''''),''(NIEPRZYPISANE)'') [Kontrahent Miasto],&#xD;
        ISNULL(NULLIF(pod5.Pod_Kraj, ''''),''(NIEPRZYPISANE)'') [Kontrahent Kraj], ISNULL(NULLIF(pod5.Pod_NIP, ''''),''(BRAK)'') [Kontrahent NIP],&#xD;
        ISNULL(NULLIF(pod5.Pod_Grupa, ''''),''Pozostali'') [Kontrahent Grupa], ISNULL(kat5.Kat_KodSzczegol, ''(PUSTA)'') [Kontrahent Kategoria],&#xD;
        CASE knt3.Knt_OpiekunTyp&#xD;
            WHEN 3 THEN ISNULL(pod6.Pod_Kod, ''(NIEPRZYPISANE)'')&#xD;
            WHEN 8 THEN ISNULL(opk3.Ope_Kod, ''(NIEPRZYPISANE)'')&#xD;
            ELSE ''(NIEPRZYPISANE)'' &#xD;
        END [Kontrahent Opiekun],&#xD;
        CONVERT(VARCHAR,ISNULL(Rab_Rabat,0))+''%'' [Kontrahent Rabat],&#xD;
        reverse(stuff(reverse(CONVERT(varchar(100),RTRIM(&#xD;
    (CASE knt3.Knt_Rodzaj_Dostawca WHEN 1 THEN ''Dostawca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Odbiorca WHEN 1 THEN ''Odbiorca, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Konkurencja WHEN 1 THEN ''Konkurencja, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Partner WHEN 1 THEN ''Partner, '' else '''' END) +&#xD;
    (CASE knt3.Knt_Rodzaj_Potencjalny WHEN 1 THEN ''Klient potencjalny,'' else '''' END)))), 1, 1, '''')) AS [Kontrahent Rodzaj],&#xD;
       "Operator Wprowadzający" = zal.Ope_Kod, "Operator Modyfikujący" = mod.Ope_Kod,&#xD;
       "Kontrahent Pierwotny Kategoria" = CASE WHEN kat3.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat3.Kat_KodSzczegol END, "Produkt Kategoria" = CASE WHEN kat4.Kat_KodSzczegol IS NULL THEN ''(PUSTA)'' ELSE kat4.Kat_KodSzczegol END,&#xD;
       DB_NAME()+''_''+convert(Varchar(10),Twr_twrId)  [Liczba Produktów], &#xD;
       "Produkt Nazwa" = Twr_Nazwa,&#xD;
       CASE ISNULL(esk.Udostepnij,0) WHEN 0 THEN ''Nie'' ELSE ''Tak'' END as [Produkt e-Sklep],&#xD;
       "Produkt Nazwa z Faktury" = Tre_TwrNazwa,&#xD;
       "Produkt PKWiU" = CASE TWR_SWW WHEN '' '' THEN ''(NIEPRZYPISANE)'' ELSE ISNULL(TWR_SWW,''(NIEPRZYPISANE)'') END,&#xD;
       ISNULL(knt5.Knt_Nazwa1, ''(NIEPRZYPISANE)'')  [Produkt Dostawca Nazwa],&#xD;
       ISNULL(Prd_Nazwa, ''(NIEPRZYPISANE)'')  [Produkt Producent Nazwa],&#xD;
       ISNULL(knt4.Knt_Kod, ''(NIEPRZYPISANE)'')  [Produkt Dostawca],&#xD;
       CASE Twr_NieAktywny WHEN 0 THEN ''Tak'' ELSE ''Nie'' END [Produkt Aktywny],&#xD;
       "Produkt Kod" = Twr_Kod, &#xD;
       "Produkt Pełna Nazwa Grupy" = poz.sciezka, "Produkt Opis" = CAST(Twr_Opis as VARCHAR(1024)),  "Jednostka Miary" = Twr_Jm, "Magazyn Nazwa" = Mag_Symbol,&#xD;
        "Produkt Producent" = ISNULL(Prd_Kod, ''(NIEPRZYPISANE)''), "Produkt Marka" = ISNULL(Mrk_Nazwa, ''(NIEPRZYPISANE)''),&#xD;
       "Produkt Typ" = CASE &#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 0 THEN ''Usługa prosta''&#xD;
            WHEN Twr_Typ = 0 AND Twr_Produkt = 1 THEN ''Usługa złożona''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 0 THEN ''Towar prosty''&#xD;
            WHEN Twr_Typ = 1 AND Twr_Produkt = 1 THEN ''Towar złożony''&#xD;
       END,&#xD;
      "Zakupy Wartość" = CASE WHEN COALESCE(trs.TrS_Ilosc, sub.TrS_Ilosc) IS NULL THEN TRE.TrE_WartoscNetto ELSE TRE.TrE_WartoscNetto * (COALESCE(trs.TrS_Ilosc, sub.TrS_Ilosc) / ISNULL(TRE.TrE_Ilosc, 1.0)) END,&#xD;
      "Zakupy Wartość Brutto" = CASE WHEN COALESCE(trs.TrS_Ilosc, sub.TrS_Ilosc) IS NULL THEN TRE.TrE_WartoscBrutto ELSE TRE.TrE_WartoscBrutto * (COALESCE(trs.TrS_Ilosc, sub.TrS_Ilosc) / ISNULL(TRE.TrE_Ilosc,1.0)) END, &#xD;
      "Zakupy Wartość Waluta" = CASE WHEN COALESCE(trs.TrS_Ilosc, sub.TrS_Ilosc) IS NULL THEN TRE.TrE_WartoscNettoWal ELSE TRE.TrE_WartoscNettoWal * (COALESCE(trs.TrS_Ilosc, sub.TrS_Ilosc) / ISNULL(TRE.TrE_Ilosc, 1.0)) END, &#xD;
      "Zakupy Ilość" = CASE WHEN COALESCE(trs.TrS_Ilosc, sub.TrS_Ilosc) IS NULL THEN TRE.TrE_Ilosc ELSE COALESCE(trs.TrS_Ilosc, sub.TrS_Ilosc) END, &#xD;
      "Numer Obcy " = Trn_NumerObcy &#xD;
       ,ISNULL(NULLIF(Twr_JMZ,''''), ''(BRAK)'') [Jednostka Miary Pomocnicza]&#xD;
       ,(CASE WHEN COALESCE(trs.TrS_Ilosc, sub.TrS_Ilosc) IS NULL THEN 1 ELSE (COALESCE(trs.TrS_Ilosc, sub.TrS_Ilosc) / ISNULL(TRE.TrE_Ilosc, 1.0)) END) * &#xD;
        (CAST(TRE.TrE_Ilosc/(Twr_JMPrzelicznikL/Twr_JMPrzelicznikM) AS Decimal(26,10))) [Zakupy Ilość Jednostka Pomocnicza]&#xD;
       ,CAST(tre.TrE_Lp AS VARCHAR(5)) [Produkt Pozycja Dokumentu]&#xD;
       &#xD;
       /*&#xD;
       ----------DATY POINT&#xD;
       ,"Data Operacji" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-'')&#xD;
       ,"Data Wystawienia" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-'')&#xD;
       ,"Termin Płatności" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-'')&#xD;
       */&#xD;
       ----------DATY ANALIZY&#xD;
       ,"Data Operacji Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataOpe, 111), ''/'', ''-''), "Data Operacji Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataOpe) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataOpe)*/&#xD;
       ,"Data Operacji Miesiąc" = MONTH(TrN_DataOpe), "Data Operacji Kwartał" = DATEPART(quarter, TrN_DataOpe), "Data Operacji Rok" = YEAR(TrN_DataOpe)&#xD;
       ,"Data Wystawienia Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_DataWys, 111), ''/'', ''-''), "Data Wystawienia Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_DataWys) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_DataWys)*/ &#xD;
       ,"Data Wystawienia Miesiąc" = MONTH(TrN_DataWys), "Data Wystawienia Kwartał" = DATEPART(quarter, TrN_DataWys), "Data Wystawienia Rok" = YEAR(TrN_DataWys)&#xD;
       ,"Termin Płatności Dzień" = REPLACE(CONVERT(VARCHAR(10), TrN_Termin, 111), ''/'', ''-''), "Termin Płatności Tydzień Roku" = (datepart(DY, datediff(d, 0, TrN_Termin) / 7 * 7 + 3)+6) / 7 /*DATEPART(isowk, TrN_Termin)*/&#xD;
       ,"Termin Płatności Miesiąc" = MONTH(TrN_Termin), "Termin Płatności Kwartał" = DATEPART(quarter, TrN_Termin), "Termin Płatności Rok" = YEAR(TrN_Termin) &#xD;
       &#xD;
       ----------KONTEKSTY&#xD;
        ,29047 [Dokument Numer __PROCID__Zakupy__], TrN_TrNId [Dokument Numer __ORGID__],'''+@bazaFirmowa+''' [Dokument Numer __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Nazwa __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Pierwotny Kod __PROCID__], pod1.Pod_PodId [Kontrahent Pierwotny Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Pierwotny Kod __DATABASE__]&#xD;
        ,20201 [Kontrahent Nazwa __PROCID__], pod5.Pod_PodId [Kontrahent Nazwa __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Nazwa __DATABASE__]&#xD;
        ,20201 [Kontrahent Kod __PROCID__Kontrahenci__], pod5.Pod_PodId [Kontrahent Kod __ORGID__],'''+@bazaFirmowa+''' [Kontrahent Kod __DATABASE__]&#xD;
        ,25003 [Produkt Nazwa __PROCID__], Twr_twrId [Produkt Nazwa __ORGID__],'''+@bazaFirmowa+''' [Produkt Nazwa __DATABASE__]&#xD;
        ,25003 [Produkt Kod __PROCID__Towary__], Twr_twrId [Produkt Kod __ORGID__],'''+@bazaFirmowa+''' [Produkt Kod __DATABASE__]&#xD;
       '&#xD;
       + @kolumny + @atrybuty + @atrybutyDok + @atrybutyTwr + @atrybutyPoz+ @atrybutyZas&#xD;
     &#xD;
set @select2 = &#xD;
' FROM cdn.TraNag &#xD;
     JOIN cdn.TraElem tre ON tre.TrE_TrNID=TrN_TrNID &#xD;
     LEFT JOIN #tmpSeria ser ON TrN_DDfId = DDf_DDfID&#xD;
     LEFT JOIN CDN.DokDefinicje dd ON TrN_DDfId = dd.DDf_DDfID&#xD;
     LEFT OUTER JOIN CDN.Kontrahenci knt ON tre.TrE_PodID=Knt_KntId AND tre.TrE_PodmiotTyp = 1&#xD;
     JOIN CDN.Towary ON tre.TrE_TwrId=Twr_TwrId&#xD;
     LEFT JOIN CDN.Producenci ON Prd_PrdId = Twr_PrdId&#xD;
     LEFT JOIN CDN.Marki ON Mrk_MrkId = Twr_MrkId&#xD;
     JOIN CDN.Magazyny ON tre.TrE_MagId=Mag_MagId &#xD;
     LEFT OUTER JOIN CDN.Kategorie kat1 ON TrN_KatID=kat1.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat2 ON tre.TrE_KatID=kat2.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat3 ON Knt_KatID=kat3.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.Kategorie kat4 ON Twr_KatID=kat4.Kat_KatID&#xD;
     LEFT OUTER JOIN CDN.PodmiotyView pod1 ON tre.TrE_PodID= pod1.Pod_PodId AND tre.TrE_PodmiotTyp = pod1.Pod_PodmiotTyp&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod2 ON Knt_OpiekunId = pod2.Pod_PodId AND knt.Knt_OpiekunTyp = pod2.Pod_PodmiotTyp&#xD;
     LEFT JOIN ' + @Operatorzy + ' opk ON Knt_OpiekunId = opk.Ope_OpeId AND knt.Knt_OpiekunTyp = 8 &#xD;
     LEFT JOIN ' + @Operatorzy + ' zal ON TrN_OpeZalID = zal.Ope_OpeId&#xD;
     LEFT JOIN ' + @Operatorzy + ' mod ON TrN_OpeModID = mod.Ope_OpeId&#xD;
     LEFT JOIN #tmpTwrGr Poz ON Twr_TwGGIDNumer = Poz.gidNumer&#xD;
     LEFT JOIN #tmpKonAtr KonAtr ON Knt_KntId = KonAtr.KnA_PodmiotId&#xD;
     LEFT JOIN #tmpDokAtr DokAtr ON TrN_TrNID  = DokAtr.DAt_TrNId &#xD;
     LEFT JOIN #tmpTwrAtr TwrAtr ON tre.TrE_TwrId  = TwrAtr.TwA_TwrId&#xD;
     LEFT JOIN #tmpPozatr PozAtr on PozAtr.TrA_TrEId = tre.TrE_TrEId&#xD;
     LEFT OUTER JOIN cdn.PodmiotyView pod5 on pod1.Pod_GlID = pod5.Pod_PodId and pod1.Pod_GlKod = pod5.Pod_Kod&#xD;
    LEFT OUTER JOIN CDN.Kontrahenci knt3 ON pod5.Pod_PodID=knt3.Knt_KntId AND pod5.Pod_PodmiotTyp = 1&#xD;
    LEFT JOIN CDN.Rabaty on rab_podmiotid = knt3.knt_kntid and rab_typ = 2&#xD;
    LEFT OUTER JOIN CDN.Kategorie kat5 ON knt3.Knt_KatID=kat5.Kat_KatID&#xD;
    LEFT OUTER JOIN cdn.PodmiotyView pod6 ON knt3.Knt_OpiekunId = pod6.Pod_PodId AND knt3.Knt_OpiekunTyp = pod6.Pod_PodmiotTyp&#xD;
    LEFT JOIN ' + @Operatorzy + ' opk3 ON knt3.Knt_OpiekunId = opk3.Ope_OpeId AND knt3.Knt_OpiekunTyp = 8 &#xD;
    LEFT JOIN #tmpKonAtr KonAtr1 ON pod5.Pod_PodId = KonAtr1.KnA_PodmiotId AND pod5.Pod_PodmiotTyp = KonAtr1.KnA_PodmiotTyp&#xD;
    LEFT JOIN CDN.Kontrahenci knt4 ON Twr_KntId = knt4.Knt_KntId&#xD;
    LEFT JOIN CDN.Kontrahenci knt5 ON Twr_KntId = knt5.Knt_KntId&#xD;
    LEFT JOIN CDN.Kontrahenci knt6 ON Twr_PrdId = knt6.Knt_KntId&#xD;
    LEFT JOIN (select distinct Twes_TwrId, MAX(Twes_Udostepnij) Udostepnij from cdn.TwrESklep group by Twes_TwrId) esk on esk.Twes_TwrId = Twr_TwrId&#xD;
    LEFT JOIN (&#xD;
        SELECT TrS_Ilosc, PZE.TrE_Lp, PZE.TrE_LpPow, TrR_FaId, trs_trsid&#xD;
            FROM CDN.TraSElem &#xD;
            JOIN cdn.TraElem PZE ON TrS_TrEId = PZE.TrE_TrEID&#xD;
            JOIN cdn.Tranag PZ ON PZ.trn_trnid = PZE.TrE_TrnId &#xD;
            JOIN cdn.TraNagRelacje on trr_trnid = PZ.trn_trnid AND trr_fatyp IN (301, 302,305) AND trr_trntyp IN (306,307,312)&#xD;
     )sub on sub.TrR_FaId = TrN_TrNID AND sub.TrE_LpPow = tre.tre_lppow and trs_ilosc &lt;&gt; 0 --korekta wartosciowa&#xD;
    LEFT JOIN #tmpZasAtr ZasAtr ON sub.Trs_TrSId = ZasAtr.TsC_TrSID&#xD;
    LEFT JOIN CDN.TraSElem trs ON trs.TrS_TrEId = tre.TrE_TrEID&#xD;
    LEFT JOIN #tmpZasAtr ZasAtr2 ON trs.Trs_TrSId = ZasAtr2.TsC_TrSID&#xD;
    LEFT JOIN '+ @Bazy +' BAZ ON DB_NAME() = BAZ.Baz_NazwaBazy AND BAZ.Baz_NazwaSerwera = SERVERPROPERTY(''ServerName'') and baz.baz_nieaktywna = 0&#xD;
WHERE&#xD;
TrN_TypDokumentu=301&#xD;
AND TrN_Bufor&lt;&gt;-1&#xD;
AND TrE_Aktywny&lt;&gt;0&#xD;
AND (TrN_DataOpe BETWEEN CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATAOD,120) + ''',120) AND CONVERT(DATETIME,''' + CONVERT(VARCHAR,@DATADO,120) + ''',120) OR TrE_TrEID IS NULL) &#xD;
'&#xD;
&#xD;
exec (@select + @select2)&#xD;
&#xD;
DROP TABLE #tmpTwrGr&#xD;
DROP TABLE #tmpKonAtr&#xD;
DROP TABLE #tmpDokAtr&#xD;
DROP TABLE #tmpTwrAtr&#xD;
DROP TABLE #tmpSeria&#xD;
DROP TABLE #tmpPozatr&#xD;
DROP TABLE #tmpZasAtr&#xD;
&#xD;
</a:textData><a:timestamp/><a:type>MdxQuery</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>SubCube</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>SubCube</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxCs</b:Key><b:Value><a:binaryData/><a:textData>b5P4wbiC0+RG5e/t8t+X7zv805Ew+SD4q4tb3pMGF8tO7UTyhwSUC/Gd6+iwZB2jsd7hyuUyC8Sdgsl2n/BMjJgiNky53VdN6s+A30dZyDERDxjVxsQnjHChMl6Nve0YtI0skB0usVvB/MqySffaOuuZqCzq0pKnvsjpaKhxxPwZ/2+ghwDXEmC4OPJDAAQ9iKNBEB706qqf90ELy4akSOPWmjMA2j25</a:textData><a:timestamp/><a:type>MdxCs</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxMetadata</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&#xD;
&lt;metadata&gt;&#xD;
  &lt;columns&gt;&#xD;
    &lt;column name="Baza Firmowa" caption="Baza Firmowa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Dokumentów" caption="Liczba Dokumentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer Obcy" caption="Dokument Numer Obcy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Numer" caption="Dokument Numer" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Opis" caption="Dokument Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Symbol" caption="Dokument Symbol" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Seria" caption="Dokument Seria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Dokument Godzina Wystawienia" caption="Dokument Godzina Wystawienia" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Waluta" caption="Waluta" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Nazwa" caption="Kontrahent Pierwotny Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kod" caption="Kontrahent Pierwotny Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Nagłówka" caption="Kategoria Szczegółowa z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Szczegółowa z Pozycji" caption="Kategoria Szczegółowa z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Nagłówka" caption="Kategoria Ogólna z Nagłówka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kategoria Ogólna z Pozycji" caption="Kategoria Ogólna z Pozycji" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Województwo" caption="Kontrahent Pierwotny Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Powiat" caption="Kontrahent Pierwotny Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Gmina" caption="Kontrahent Pierwotny Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Miasto" caption="Kontrahent Pierwotny Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kraj" caption="Kontrahent Pierwotny Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny NIP" caption="Kontrahent Pierwotny NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Grupa" caption="Kontrahent Pierwotny Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Opiekun" caption="Kontrahent Pierwotny Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Rodzaj" caption="Kontrahent Pierwotny Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Kontrahentów" caption="Liczba Kontrahentów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Nazwa" caption="Kontrahent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kod" caption="Kontrahent Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Województwo" caption="Kontrahent Województwo" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Powiat" caption="Kontrahent Powiat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Gmina" caption="Kontrahent Gmina" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Miasto" caption="Kontrahent Miasto" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kraj" caption="Kontrahent Kraj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent NIP" caption="Kontrahent NIP" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Grupa" caption="Kontrahent Grupa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Kategoria" caption="Kontrahent Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Opiekun" caption="Kontrahent Opiekun" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rabat" caption="Kontrahent Rabat" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Rodzaj" caption="Kontrahent Rodzaj" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Wprowadzający" caption="Operator Wprowadzający" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Operator Modyfikujący" caption="Operator Modyfikujący" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Kategoria" caption="Kontrahent Pierwotny Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kategoria" caption="Produkt Kategoria" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Liczba Produktów" caption="Liczba Produktów" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa" caption="Produkt Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt e-Sklep" caption="Produkt e-Sklep" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Nazwa z Faktury" caption="Produkt Nazwa z Faktury" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt PKWiU" caption="Produkt PKWiU" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca Nazwa" caption="Produkt Dostawca Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent Nazwa" caption="Produkt Producent Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Dostawca" caption="Produkt Dostawca" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Aktywny" caption="Produkt Aktywny" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Kod" caption="Produkt Kod" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Pełna Nazwa Grupy" caption="Produkt Pełna Nazwa Grupy" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Opis" caption="Produkt Opis" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary" caption="Jednostka Miary" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Magazyn Nazwa" caption="Magazyn Nazwa" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Producent" caption="Produkt Producent" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Marka" caption="Produkt Marka" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Typ" caption="Produkt Typ" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Wartość" caption="Zakupy Wartość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Brutto" caption="Zakupy Wartość Brutto" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Wartość Waluta" caption="Zakupy Wartość Waluta" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Zakupy Ilość" caption="Zakupy Ilość" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Numer Obcy " caption="Numer Obcy " type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Jednostka Miary Pomocnicza" caption="Jednostka Miary Pomocnicza" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Zakupy Ilość Jednostka Pomocnicza" caption="Zakupy Ilość Jednostka Pomocnicza" type="measure" formatString="" aggregate="Sum" /&gt;&#xD;
    &lt;column name="Produkt Pozycja Dokumentu" caption="Produkt Pozycja Dokumentu" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Dzień" caption="Data Operacji Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Tydzień Roku" caption="Data Operacji Tydzień Roku" type="attribute" formatString="### ##0.00" /&gt;&#xD;
    &lt;column name="Data Operacji Miesiąc" caption="Data Operacji Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Kwartał" caption="Data Operacji Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Operacji Rok" caption="Data Operacji Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Dzień" caption="Data Wystawienia Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Tydzień Roku" caption="Data Wystawienia Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Miesiąc" caption="Data Wystawienia Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Kwartał" caption="Data Wystawienia Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Data Wystawienia Rok" caption="Data Wystawienia Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Dzień" caption="Termin Płatności Dzień" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Tydzień Roku" caption="Termin Płatności Tydzień Roku" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Miesiąc" caption="Termin Płatności Miesiąc" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Kwartał" caption="Termin Płatności Kwartał" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Termin Płatności Rok" caption="Termin Płatności Rok" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 0" caption="Produkt Grupa Poziom 0" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 1" caption="Produkt Grupa Poziom 1" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 2" caption="Produkt Grupa Poziom 2" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 3" caption="Produkt Grupa Poziom 3" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 4" caption="Produkt Grupa Poziom 4" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Grupa Poziom 5" caption="Produkt Grupa Poziom 5" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Pierwotny Atrybut KLUCZOWY" caption="Kontrahent Pierwotny Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Kontrahent Atrybut KLUCZOWY" caption="Kontrahent Atrybut KLUCZOWY" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Produkt Atrybut USŁUGA SERWISOWA" caption="Produkt Atrybut USŁUGA SERWISOWA" type="attribute" formatString="" /&gt;&#xD;
    &lt;column name="Pozycja Atrybut USŁUGA SERWISOWA" caption="Pozycja Atrybut USŁUGA SERWISOWA" type="attribute" formatString="" /&gt;&#xD;
  &lt;/columns&gt;&#xD;
&lt;/metadata&gt;</a:textData><a:timestamp/><a:type>MdxMetadata</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>MdxParams</b:Key><b:Value><a:binaryData/><a:textData>&lt;?xml version="1.0" encoding="utf-16"?&gt;&#xD;
&lt;ArrayOfMdxQueryParameter xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATAOD&lt;/Name&gt;&#xD;
    &lt;Label&gt;DATAOD&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data początkowa analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE() - 30&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
  &lt;MdxQueryParameter&gt;&#xD;
    &lt;Name&gt;DATADO&lt;/Name&gt;&#xD;
    &lt;Label&gt;DATADO&lt;/Label&gt;&#xD;
    &lt;ToolTip&gt;Data końcowa analizy&lt;/ToolTip&gt;&#xD;
    &lt;Expression&gt;SELECT GETDATE()&lt;/Expression&gt;&#xD;
    &lt;Type&gt;Data&lt;/Type&gt;&#xD;
    &lt;ParamType&gt;Data&lt;/ParamType&gt;&#xD;
    &lt;DateFormat&gt;SQL&lt;/DateFormat&gt;&#xD;
    &lt;MinimumValue&gt;0&lt;/MinimumValue&gt;&#xD;
    &lt;MaximumValue&gt;0&lt;/MaximumValue&gt;&#xD;
    &lt;Precision&gt;0&lt;/Precision&gt;&#xD;
    &lt;Step&gt;0&lt;/Step&gt;&#xD;
    &lt;Multiselect&gt;false&lt;/Multiselect&gt;&#xD;
    &lt;Uppercase&gt;false&lt;/Uppercase&gt;&#xD;
    &lt;DefaultValue&gt;2016-10-12&lt;/DefaultValue&gt;&#xD;
    &lt;Redefined&gt;false&lt;/Redefined&gt;&#xD;
  &lt;/MdxQueryParameter&gt;&#xD;
&lt;/ArrayOfMdxQueryParameter&gt;</a:textData><a:timestamp/><a:type>MdxParams</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Chart</b:Key><b:Value><a:binaryData/><a:textData/><a:timestamp/><a:type>Chart</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:KeyValueOfReportDataTypeReportDataBrNSYbaE><b:Key>Layout</b:Key><b:Value><a:binaryData>AAAAAAAAAAA=</a:binaryData><a:textData>&lt;?xml version="1.0" encoding="utf-16" standalone="yes"?&gt;&lt;layout version="201107" visible="True" fieldListWidth="280" fieldListVisible="True" fieldListExpanded="True" lazyLoading="False" rowGrandTotal="True" calculationsPanelVisible="True" showEmptyCells="False" showTotalsForSingleValues="True" showGrandTotalsForSingleValues="True" showMeasuresOnRows="False"&gt;&lt;sparklines /&gt;&lt;customMeasures /&gt;&lt;formatOptions /&gt;&lt;formatRules /&gt;&lt;dataFields /&gt;&lt;rowFields /&gt;&lt;columnFields /&gt;&lt;filterFields /&gt;&lt;/layout&gt;</a:textData><a:timestamp/><a:type>Layout</a:type></b:Value></b:KeyValueOfReportDataTypeReportDataBrNSYbaE></a:definitions><a:description>Raport zawiera informacje o zakupach w firmie. Wartości prezentowane są w walucie systemowej. Raport zawiera atrybuty zasobów.&#xD;
&#xD;
Analizy oparte są o faktury zakupu i dokumenty skojarzone.&#xD;
Niebrane pod uwagę są dokumenty anulowane.&#xD;
&#xD;
Raport oparty na tabelach:&#xD;
TraNag - Tabela z nagłówkami dokumentów (faktur, paragonów itp.). &#xD;
TraElem - Tabela z elementami dokumentów (faktur, paragonów itp.).</a:description><a:id>116</a:id><a:isPredefinedReport>false</a:isPredefinedReport><a:language>pl-PL</a:language><a:mainLinkName>2.17 Raport zakupów z atrybutami zasobów</a:mainLinkName><a:modifiedOn>2025-04-14T10:05:50.023</a:modifiedOn><a:path xmlns:b="http://schemas.microsoft.com/2003/10/Serialization/Arrays"><b:string>II. Raporty Standardowe</b:string><b:string>02. Zakupy</b:string></a:path><a:predefinedReport i:nil="true"/><a:serverName>serwer</a:serverName><a:sourceDbType>Main</a:sourceDbType><a:standardReportHash i:nil="true"/><a:standardReportId i:nil="true"/><a:standardReportVersion i:nil="true"/><a:type>DevXpressMdxSql</a:type><a:useDefaultConnection>true</a:useDefaultConnection><a:useInMemory>true</a:useInMemory><a:viewType i:nil="true"/><a:webServicePort>80</a:webServicePort><a:contexts><a:Context><a:id>2</a:id></a:Context></a:contexts><a:connections/></a:Report></Reports><UsePasswordsEncryption>true</UsePasswordsEncryption></ReportsList>